<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>The Three Burials of Magister Corvan</title>
<style title="Twine CSS">@keyframes appear{0%{opacity:0}to{opacity:1}}@keyframes fade-in-out{0%,to{opacity:0}50%{opacity:1}}@keyframes rumble{25%{top:-0.1em}75%{top:.1em}0%,to{top:0px}}@keyframes shudder{25%{left:.1em}75%{left:-0.1em}0%,to{left:0px}}@keyframes buoy{25%{top:.25em}75%{top:-0.25em}0%,to{top:0px}}@keyframes sway{25%{left:.25em}75%{left:-0.25em}0%,to{left:0px}}@keyframes pulse{0%{transform:scale(0, 0)}20%{transform:scale(1.2, 1.2)}40%{transform:scale(0.9, 0.9)}60%{transform:scale(1.05, 1.05)}80%{transform:scale(0.925, 0.925)}to{transform:scale(1, 1)}}@keyframes zoom-in{0%{transform:scale(0, 0)}to{transform:scale(1, 1)}}@keyframes shudder-in{0%,to{transform:translateX(0em)}5%,25%,45%{transform:translateX(-1em)}15%,35%,55%{transform:translateX(1em)}65%{transform:translateX(-0.6em)}75%{transform:translateX(0.6em)}85%{transform:translateX(-0.2em)}95%{transform:translateX(0.2em)}}@keyframes rumble-in{0%,to{transform:translateY(0em)}5%,25%,45%{transform:translateY(-1em)}15%,35%,55%{transform:translateY(1em)}65%{transform:translateY(-0.6em)}75%{transform:translateY(0.6em)}85%{transform:translateY(-0.2em)}95%{transform:translateY(0.2em)}}@keyframes fidget{0%,8.1%,82.1%,31.1%,38.1%,44.1%,40.1%,47.1%,74.1%,16.1%,27.1%,72.1%,24.1%,95.1%,6.1%,36.1%,20.1%,4.1%,91.1%,14.1%,87.1%,to{left:0px;top:0px}8%,82%,31%,38%,44%{left:-1px}40%,47%,74%,16%,27%{left:1px}72%,24%,95%,6%,36%{top:-1px}20%,4%,91%,14%,87%{top:1px}}@keyframes slide-right{0%{transform:translateX(-100vw)}}@keyframes slide-left{0%{transform:translateX(100vw)}}@keyframes slide-up{0%{transform:translateY(100vh)}}@keyframes slide-down{0%{transform:translateY(-100vh)}}@keyframes fade-right{0%{opacity:0;transform:translateX(-1em)}to{opacity:1}}@keyframes fade-left{0%{opacity:0;transform:translateX(1em)}to{opacity:1}}@keyframes fade-up{0%{opacity:0;transform:translateY(1em)}to{opacity:1}}@keyframes fade-down{0%{opacity:0;transform:translateY(-1em)}to{opacity:1}}@keyframes flicker{0%,29%,31%,63%,65%,77%,79%,86%,88%,91%,93%{opacity:0}30%{opacity:.2}64%{opacity:.4}78%{opacity:.6}87%{opacity:.8}92%,to{opacity:1}}@keyframes blur{0%{filter:blur(2rem);opacity:0}25%{opacity:1}to{filter:blur(0rem);opacity:1}}.dom-debug-mode tw-story,.dom-debug-mode tw-passage,.dom-debug-mode tw-sidebar,.dom-debug-mode tw-include,.dom-debug-mode tw-hook,.dom-debug-mode tw-expression,.dom-debug-mode tw-link,.dom-debug-mode tw-dialog,.dom-debug-mode tw-columns,.dom-debug-mode tw-column,.dom-debug-mode tw-align{outline:1px solid #f5a3da;min-height:32px;display:block !important}.dom-debug-mode tw-story::before,.dom-debug-mode tw-passage::before,.dom-debug-mode tw-sidebar::before,.dom-debug-mode tw-include::before,.dom-debug-mode tw-hook::before,.dom-debug-mode tw-expression::before,.dom-debug-mode tw-link::before,.dom-debug-mode tw-dialog::before,.dom-debug-mode tw-columns::before,.dom-debug-mode tw-column::before,.dom-debug-mode tw-align::before{position:absolute;top:0;left:0;height:16px;background-color:#f5a3da;color:#000;font-size:16px;font-weight:normal;font-style:normal;font-family:monospace;display:inline-block;line-height:100%;white-space:pre;z-index:999997}.dom-debug-mode tw-story:hover,.dom-debug-mode tw-passage:hover,.dom-debug-mode tw-sidebar:hover,.dom-debug-mode tw-include:hover,.dom-debug-mode tw-hook:hover,.dom-debug-mode tw-expression:hover,.dom-debug-mode tw-link:hover,.dom-debug-mode tw-dialog:hover,.dom-debug-mode tw-columns:hover,.dom-debug-mode tw-column:hover,.dom-debug-mode tw-align:hover{outline:1px solid #fc9}.dom-debug-mode tw-story:hover::before,.dom-debug-mode tw-passage:hover::before,.dom-debug-mode tw-sidebar:hover::before,.dom-debug-mode tw-include:hover::before,.dom-debug-mode tw-hook:hover::before,.dom-debug-mode tw-expression:hover::before,.dom-debug-mode tw-link:hover::before,.dom-debug-mode tw-dialog:hover::before,.dom-debug-mode tw-columns:hover::before,.dom-debug-mode tw-column:hover::before,.dom-debug-mode tw-align:hover::before{background-color:#fc9;transition:background-color 1s}.dom-debug-mode tw-passage,.dom-debug-mode tw-include,.dom-debug-mode tw-hook,.dom-debug-mode tw-expression,.dom-debug-mode tw-link,.dom-debug-mode tw-dialog,.dom-debug-mode tw-columns,.dom-debug-mode tw-column,.dom-debug-mode tw-align{padding:1em;margin:0}.dom-debug-mode tw-story::before{content:'<tw-story tags="' attr(tags) '">'}.dom-debug-mode tw-passage::before{top:-16px;content:'<tw-passage tags="' attr(tags) '">'}.dom-debug-mode tw-sidebar::before{top:-16px;content:"<tw-sidebar>"}.dom-debug-mode tw-hook::before{content:'<tw-hook name="' attr(name) '">'}.dom-debug-mode tw-expression::before{content:'<tw-expression name="' attr(name) '">'}.dom-debug-mode tw-link::before{content:'<tw-link name="' attr(name) '">'}.dom-debug-mode tw-dialog::before{content:"<tw-dialog>"}.dom-debug-mode tw-columns::before{content:"<tw-columns>"}.dom-debug-mode tw-column::before{content:"<tw-column>"}.dom-debug-mode tw-align::before{content:"<tw-align>"}.dom-debug-mode tw-include::before{content:'<tw-include type="' attr(type) '" name="' attr(name) '">'}tw-open-button[goto]{display:none}.debug-mode tw-open-button[replay],.debug-mode tw-open-button[goto]{display:inline}.debug-mode tw-expression{display:inline-block !important}.debug-mode tw-expression[type=variable]::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"$" attr(name)}.debug-mode tw-expression[type=tempVariable]::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"_" attr(name)}.debug-mode tw-expression[return=boolean]{background-color:rgba(179,179,179,.2)}.debug-mode tw-expression[return=array]{background-color:rgba(255,102,102,.2)}.debug-mode tw-expression[return=dataset]{background-color:rgba(255,128,0,.2)}.debug-mode tw-expression[return=number]{background-color:rgba(255,179,102,.2)}.debug-mode tw-expression[return=datamap]{background-color:rgba(255,255,102,.2)}.debug-mode tw-expression[return=changer]{background-color:rgba(179,255,102,.2)}.debug-mode tw-expression[return=lambda]{background-color:rgba(102,255,102,.2)}.debug-mode tw-expression[return=hookname]{background-color:rgba(102,255,204,.2)}.debug-mode tw-expression[return=string]{background-color:rgba(102,255,255,.2)}.debug-mode tw-expression[return=datatype]{background-color:rgba(102,153,255,.2)}.debug-mode tw-expression[return=gradient],.debug-mode tw-expression[return=colour]{background-color:rgba(204,102,255,.2)}.debug-mode tw-expression[return=instant],.debug-mode tw-expression[return=macro]{background-color:rgba(240,117,199,.2)}.debug-mode tw-expression[return=command]{background-color:rgba(153,153,255,.2)}.debug-mode tw-expression.false{background-color:rgba(255,0,0,.2) !important}.debug-mode tw-expression[type=macro]::before{content:"(" attr(name) ":)";padding:0 .5rem;font-size:1rem;vertical-align:middle;line-height:normal;background-color:inherit;border:1px solid rgba(255,255,255,.5)}.debug-mode tw-expression[title]:not([title=""]){cursor:help}.debug-mode tw-hook{background-color:rgba(0,85,255,.1) !important}.debug-mode tw-hook::before{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"["}.debug-mode tw-hook::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"]"}.debug-mode tw-hook[name]::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"]<" attr(name) "|"}.debug-mode tw-pseudo-hook{background-color:rgba(255,170,0,.1) !important}.debug-mode tw-collapsed::before{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"{"}.debug-mode tw-collapsed::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"}"}.debug-mode tw-verbatim::before,.debug-mode tw-verbatim::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"`"}.debug-mode tw-align[style*="text-align: center"]{background:linear-gradient(to right, hsla(14, 100%, 87%, 0) 0%, hsla(14, 100%, 87%, 0.25) 50%, hsla(14, 100%, 87%, 0) 100%)}.debug-mode tw-align[style*="text-align: left"]{background:linear-gradient(to right, hsla(14, 100%, 87%, 0.25) 0%, hsla(14, 100%, 87%, 0) 100%)}.debug-mode tw-align[style*="text-align: right"]{background:linear-gradient(to right, hsla(14, 100%, 87%, 0) 0%, hsla(14, 100%, 87%, 0.25) 100%)}.debug-mode tw-column{background-color:rgba(189,228,255,.2)}.debug-mode tw-enchantment{animation:enchantment .5s infinite;border:1px solid}.debug-mode tw-link::after,.debug-mode tw-broken-link::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:attr(passage-name)}.debug-mode tw-include{background-color:rgba(204,128,51,.1)}.debug-mode tw-include::before{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:attr(type) ' "' attr(name) '"'}.debug-dialogs tw-backdrop:not(.eval-replay):not(.harlowe-crash){pointer-events:none;opacity:.1}tw-eval-replay tw-eval-code,tw-eval-replay tw-eval-explanation{max-height:20vh;overflow:auto;margin:10px auto}tw-eval-replay tw-eval-code{display:block;font-family:monospace;padding-bottom:1ex;border-bottom:2px solid gray}tw-eval-replay tw-eval-explanation{display:block;text-align:center}tw-eval-replay tw-eval-explanation>code{white-space:pre-wrap}tw-eval-replay tw-eval-explanation>code.from-block{width:40%;display:inline-block;text-align:left;max-height:4em;overflow-wrap:anywhere;overflow-y:scroll}tw-eval-replay tw-eval-explanation>code.from-block~.to-desc{width:calc(40% - 2em);margin-left:2em;display:inline-block}tw-eval-replay tw-eval-explanation>code.from-block+span::after{content:"..."}tw-eval-replay tw-eval-explanation>code.from-inline{text-align:right}tw-eval-replay tw-eval-explanation>:nth-child(2){white-space:pre}tw-eval-replay tw-eval-explanation>.to-desc{text-align:left}tw-eval-replay tw-eval-explanation>table{width:100%;margin-top:1em}tw-eval-replay tw-eval-explanation>table td{white-space:pre-wrap !important;word-wrap:anywhere}tw-eval-replay tw-eval-reason{text-align:center;font-size:80%;font-style:italic;display:block}tw-eval-replay tw-eval-it{text-align:center;font-size:80%;display:block}tw-eval-replay tw-dialog-links{display:-ms-flexbox;display:flex;-ms-flex-pack:distribute;justify-content:space-around}@keyframes enchantment{0%,to{border-color:#ffb366}50%{border-color:#6fc}}tw-debugger{position:fixed;box-sizing:border-box;bottom:0;right:0;z-index:999999;min-width:14em;min-height:1em;padding:0em .5em .5em 1em;font-size:1.25em;font-family:sans-serif;color:#262626;background-color:#fff;border-left:solid #262626 2px;border-top:solid #262626 2px;border-top-left-radius:.5em;opacity:1}tw-debugger.fade-panel:not(:hover){opacity:.33}tw-debugger.theme-dark{color:#d9d9d9;background-color:#000}tw-debugger.theme-dark{border-color:#d9d9d9 rgba(0,0,0,0) rgba(0,0,0,0) #d9d9d9}tw-debugger select{margin-right:1em;width:12em}tw-debugger button,tw-debugger tw-link{border-radius:3px;border:solid #999 1px;margin:auto 4px;color:#262626;background-color:#fff;cursor:pointer}tw-debugger button.enabled,tw-debugger tw-link.enabled{color:#000;background-color:#d9d9d9;box-shadow:inset #999 3px 5px .5em}tw-debugger.theme-dark button,tw-debugger.theme-dark tw-link{color:#d9d9d9;background-color:#000;border-color:#666}tw-debugger.theme-dark button.enabled,tw-debugger.theme-dark tw-link.enabled{color:#e6e6e6;background-color:#424242;box-shadow:inset #666 3px 5px .5em}tw-debugger button{font-size:1em;overflow-x:hidden;text-overflow:ellipsis;white-space:pre}tw-debugger tw-link{font-size:1.25em;border-radius:16px;border-style:solid;border-width:2px;text-align:center;padding:0px 8px;display:block}tw-debugger tw-link:hover{border-color:#262626;color:#262626}tw-debugger.theme-dark tw-link:hover{border-color:#d9d9d9;color:#d9d9d9}tw-debugger tw-dialog{background-color:#fff;color:#000;font-size:1.25em}tw-debugger.theme-dark tw-dialog{background-color:#000;color:#e6e6e6}tw-debugger .panel{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;position:absolute;bottom:100%;left:-2px;right:0;padding:1em;overflow-y:scroll;overflow-x:hidden;border:inherit;box-sizing:content-box;background-color:#fff;border-bottom:solid #999 2px;border-top-left-radius:.5em;border-bottom-left-radius:.5em;font-size:.8em}tw-debugger .panel:empty,tw-debugger .panel[hidden]{display:none}tw-debugger.theme-dark .panel{background-color:#000;border-bottom-color:#666}tw-debugger .panel-source .panel-row-buttons{width:2rem}tw-debugger .panel-source .source-tags{width:20%;font-style:italic}tw-debugger .panel-row-source td{font-family:monospace;font-size:1rem;white-space:pre-wrap;overflow-wrap:anywhere;max-height:8rem;padding:1rem}tw-debugger .panel-rows{width:100%;overflow-x:scroll}tw-debugger .panel-rows>*{display:table-row}tw-debugger .panel-rows>div:nth-of-type(2n){background-color:#e6e6e6}tw-debugger .panel-tools .panel-rows>*,tw-debugger .panel-options .panel-rows>*{margin-top:.4rem;display:block}tw-debugger.theme-dark .panel-rows>div:nth-of-type(2n){background-color:#212121}tw-debugger .panel-row-buttons{text-align:right}tw-debugger .panel-variables .panel-rows:empty::before{content:"~ No variables ~";font-style:italic;color:#575757;text-align:center}tw-debugger .panel-enchantments .panel-rows:empty::before{content:"~ No enchantments ~";font-style:italic;color:#575757;text-align:center}tw-debugger .panel-errors .panel-rows:empty::before{content:"~ No errors... for now. ~";font-style:italic;color:#575757;text-align:center}tw-debugger .panel-errors .panel-rows:empty+.panel-errors-bottom{display:none}tw-debugger.theme-dark .panel-variables .panel-rows:empty::before,tw-debugger.theme-dark .panel-enchantments .panel-rows:empty::before,tw-debugger.theme-dark .panel-errors .panel-rows:empty::before{color:#a8a8a8}tw-debugger .panel-rows:empty+.panel-variables-bottom{display:none}tw-debugger th[data-col]{text-decoration:underline;cursor:pointer}tw-debugger th[data-col][data-order=asc]::after{content:"↓"}tw-debugger th[data-col][data-order=desc]::after{content:"↑"}tw-debugger .panel-storylets:not(.panel-exclusive) .storylet-exclusive,tw-debugger .panel-storylets:not(.panel-urgent) .storylet-urgent{display:none}tw-debugger .storylet-exclusive,tw-debugger .storylet-urgent,tw-debugger .storylet-open{text-align:center}tw-debugger .panel-variables-bottom{padding-top:5px}tw-debugger .enchantment-row{min-height:1.5em}tw-debugger .variable-path{opacity:.4}tw-debugger .temporary-variable-scope,tw-debugger .enchantment-local{font-family:sans-serif;font-weight:normal;opacity:.8;font-size:.75em}tw-debugger .temporary-variable-scope:not(:empty)::before,tw-debugger .enchantment-local:not(:empty)::before{content:" in "}tw-debugger .variable-name,tw-debugger .enchantment-name{font-family:monospace;font-weight:bold}tw-debugger .variable-type{color:#575757;font-weight:normal;text-overflow:ellipsis;overflow:hidden;max-width:10em}tw-debugger.theme-dark .variable-type{color:#a8a8a8}tw-debugger .error-row{display:table-row;background-color:rgba(230,101,204,.3)}tw-debugger .error-row:nth-of-type(2n){background-color:rgba(237,145,219,.3)}tw-debugger .error-row>*{display:table-cell;padding:.25em .5em}tw-debugger .error-row .error-message[title]:not([title=""]){cursor:help}tw-debugger .error-row .error-passage{color:#575757}tw-debugger.theme-dark .error-row .error-passage{color:#a8a8a8}tw-debugger .storylet-row{background-color:rgba(193,240,225,.3)}tw-debugger .storylet-row:nth-child(2n){background-color:rgba(152,231,204,.3)}tw-debugger .storylet-row.storylet-closed{font-style:italic;background-color:#fff}tw-debugger .storylet-row.storylet-closed:nth-child(2n){background-color:#e6e6e6}tw-debugger .storylet-row.storylet-closed>:not(.storylet-lambda){opacity:.6}.storylet-error tw-debugger .storylet-row{background-color:rgba(230,101,204,.3)}.storylet-error tw-debugger .storylet-row:nth-child(2n){background-color:rgba(237,145,219,.3)}tw-debugger .storylet-row .storylet-name,tw-debugger .storylet-row .storylet-value{display:inline-block;width:50%}tw-debugger .storylet-row .storylet-lambda{font-family:monospace;font-size:1rem;white-space:pre-wrap;overflow-wrap:anywhere}tw-debugger.theme-dark .storylet-row.storylet-closed{background-color:#000}tw-debugger.theme-dark .storylet-row.storylet-closed:nth-child(2n){background-color:#212121}tw-debugger .tabs{padding-bottom:.5em}tw-debugger .tab{border-radius:0px 0px .5em .5em;border-top:none;top:-2px}tw-debugger .resizer-h{position:absolute;height:14em;border-left:2px solid #999;border-right:2px solid #999;top:10px;left:4px;width:8px;cursor:ew-resize}tw-debugger.theme-dark .resizer-h{border-color:rgba(0,0,0,0) #666}tw-debugger .resizer-v{position:absolute;height:8px;border-top:2px solid #999;border-bottom:2px solid #999;margin-bottom:4px;top:4px;left:10px;width:95%;cursor:ns-resize;box-sizing:border-box}tw-debugger.theme-dark .resizer-v{border-color:#666 rgba(0,0,0,0)}tw-debugger mark{color:inherit;background-color:rgba(101,230,230,.3) !important}tw-dialog{z-index:999997;border:#fff solid 2px;padding:2em;color:#fff;background-color:#000;display:block}@media(min-width: 576px){tw-dialog{max-width:50vw}}tw-dialog input[type=text]{font-size:inherit;width:100%;border:solid #fff !important}tw-dialog-links{text-align:right;display:-ms-flexbox;display:flex;-ms-flex-pack:end;justify-content:flex-end}tw-backdrop{z-index:999996;position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.8);display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center}tw-backdrop~tw-backdrop{display:none}tw-link,.enchantment-link{cursor:pointer;color:#4169e1;font-weight:bold;text-decoration:none;transition:color .2s ease-in-out}tw-passage [style^=color] tw-link:not(:hover),tw-passage [style*=" color"] tw-link:not(:hover),tw-passage [style^=color][hover=true] tw-link:hover,tw-passage [style*=" color"][hover=true] tw-link:hover,tw-passage [style^=color] .enchantment-link:not(:hover),tw-passage [style*=" color"] .enchantment-link:not(:hover),tw-passage [style^=color][hover=true] .enchantment-link:hover,tw-passage [style*=" color"][hover=true] .enchantment-link:hover{color:inherit}tw-link:hover,.enchantment-link:hover{color:#00bfff}tw-link:active,.enchantment-link:active{color:#dd4b39}.visited{color:#6941e1}tw-passage [style^=color] .visited:not(:hover),tw-passage [style*=" color"] .visited:not(:hover),tw-passage [style^=color][hover=true] .visited:hover,tw-passage [style*=" color"][hover=true] .visited:hover{color:inherit}.visited:hover{color:#e3e}tw-broken-link{color:#933;border-bottom:2px solid #933;cursor:not-allowed}tw-passage [style^=color] tw-broken-link:not(:hover),tw-passage [style*=" color"] tw-broken-link:not(:hover),tw-passage [style^=color][hover=true] tw-broken-link:hover,tw-passage [style*=" color"][hover=true] tw-broken-link:hover{color:inherit}tw-link.enchantment-mouseover,.link.enchantment-mouseover,tw-expression.enchantment-mouseover>tw-link{color:inherit;font-weight:inherit;transition:none;cursor:inherit;border-bottom:2px dashed #999}tw-link.enchantment-mouseover:hover,tw-link.enchantment-mouseover:active,.link.enchantment-mouseover:hover,.link.enchantment-mouseover:active,tw-expression.enchantment-mouseover>tw-link:hover,tw-expression.enchantment-mouseover>tw-link:active{color:inherit}tw-link.enchantment-mouseover.enchantment-button,.link.enchantment-mouseover.enchantment-button,tw-expression.enchantment-mouseover>tw-link.enchantment-button{border-style:dashed}tw-link.enchantment-mouseout,.link.enchantment-mouseout,tw-expression.enchantment-mouseout>tw-link{color:inherit;font-weight:inherit;transition:none;cursor:inherit;border:rgba(64,149,191,.6) 1px solid;border-radius:.2em}tw-link.enchantment-mouseout:hover,tw-link.enchantment-mouseout:active,.link.enchantment-mouseout:hover,.link.enchantment-mouseout:active,tw-expression.enchantment-mouseout>tw-link:hover,tw-expression.enchantment-mouseout>tw-link:active{color:inherit}tw-link.enchantment-mouseout:hover,.link.enchantment-mouseout:hover,tw-expression.enchantment-mouseout>tw-link:hover{background-color:rgba(175,197,207,.75);border:rgba(0,0,0,0) 1px solid}tw-link.enchantment-dblclick,.link.enchantment-dblclick,tw-expression.enchantment-dblclick>tw-link{color:inherit;font-weight:inherit;transition:none;cursor:inherit;cursor:pointer;border:2px solid #999;border-radius:0}tw-link.enchantment-dblclick:hover,tw-link.enchantment-dblclick:active,.link.enchantment-dblclick:hover,.link.enchantment-dblclick:active,tw-expression.enchantment-dblclick>tw-link:hover,tw-expression.enchantment-dblclick>tw-link:active{color:inherit}tw-link.enchantment-dblclick:active,.link.enchantment-dblclick:active,tw-expression.enchantment-dblclick>tw-link:active{background-color:#999}tw-link.enchantment-button,.link.enchantment-button,.enchantment-button:not(.link) tw-link,.enchantment-button:not(.link) .link{border-radius:16px;border-style:solid;border-width:2px;text-align:center;padding:0px 8px;display:block}.enchantment-button{display:block}.enchantment-clickblock{cursor:pointer;width:100%;height:100%;display:block}.enchantment-clickblock>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;color:rgba(65,105,225,.5);transition:color .2s ease-in-out}.enchantment-clickblock>:not(tw-enchantment):hover::after{color:rgba(0,191,255,.5)}.enchantment-clickblock>:not(tw-enchantment):active::after{color:rgba(222,78,59,.5)}.enchantment-clickblock>:not(tw-enchantment)::after{box-shadow:inset 0 0 0 .5vmax}.enchantment-clickblock>tw-passage::after,.enchantment-clickblock>tw-sidebar::after{box-shadow:0 0 0 .5vmax}.enchantment-mouseoverblock>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;border:2px dashed #999}.enchantment-mouseoutblock>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;border:rgba(64,149,191,.6) 2px solid}.enchantment-mouseoutblock:hover>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;background-color:rgba(175,197,207,.75);border:rgba(0,0,0,0) 2px solid;border-radius:.2em}.enchantment-dblclickblock>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;cursor:pointer;border:2px solid #999}tw-dialog-links{padding-top:1.5em}tw-dialog-links tw-link{border-radius:16px;border-style:solid;border-width:2px;text-align:center;padding:0px 8px;display:block;display:inline-block}html{margin:0;height:100%;overflow-x:hidden}*,:before,:after{position:relative;box-sizing:inherit}body{margin:0;height:100%}tw-storydata{display:none}tw-story{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;font:100% Georgia,serif;box-sizing:border-box;width:100%;min-height:100%;font-size:1.5em;line-height:1.5em;padding:5% 5%;overflow:hidden;background-color:#000;color:#fff}tw-story [style*=content-box] *{box-sizing:border-box}@media(min-width: 576px){tw-story{padding:5% 20%}}tw-story tw-consecutive-br{display:block;height:1.6ex;visibility:hidden}tw-story select{background-color:rgba(0,0,0,0);font:inherit;border-style:solid;padding:2px}tw-story select:not([disabled]){color:inherit}tw-story textarea{resize:none;background-color:rgba(0,0,0,0);font:inherit;color:inherit;border-style:none;padding:2px}tw-story input[type=text]{background-color:rgba(0,0,0,0);font:inherit;color:inherit;border-style:none}tw-story input[type=checkbox]{transform:scale(1.5);margin:0 .5em .5em .5em;vertical-align:middle}tw-story tw-noscript{animation:appear .8s}tw-passage{display:block}tw-sidebar{text-align:center;display:-ms-flexbox;display:flex;-ms-flex-pack:justify;justify-content:space-between}@media(min-width: 576px){tw-sidebar{left:-5em;width:3em;position:absolute;-ms-flex-direction:column;flex-direction:column}tw-enchantment[style*=width]>tw-sidebar{width:inherit}}tw-icon{display:inline-block;margin:.5em 0;font-size:66px;font-family:"Verdana",sans-serif}tw-icon[alt]{opacity:.2;cursor:pointer}tw-icon[alt]:hover{opacity:.4}tw-icon[data-label]::after{font-weight:bold;content:attr(data-label);font-size:20px;bottom:-20px;left:-50%;white-space:nowrap}tw-meter{display:block}tw-hook:empty,tw-expression:empty{display:none}tw-error{display:inline-block;border-radius:.2em;padding:.2em;font-size:1rem;cursor:help;white-space:pre-wrap}tw-error.error{background-color:rgba(223,58,190,.6);color:#fff}tw-error.warning{background-color:rgba(223,140,58,.6);color:#fff;display:none}.debug-mode tw-error.warning{display:inline}tw-error-explanation{display:block;font-size:.8rem;line-height:1rem}tw-open-button,tw-folddown{cursor:pointer;line-height:0em;border-radius:4px;border:1px solid rgba(255,255,255,.5);font-size:.8rem;margin:0 .2rem;padding:3px;white-space:pre}tw-folddown::after{content:"▶"}tw-folddown.open::after{content:"▼"}tw-open-button[replay]{display:none}tw-error tw-open-button,tw-eval-replay tw-open-button{display:inline !important}tw-open-button::after{content:attr(label)}tw-notifier{border-radius:.2em;padding:.2em;font-size:1rem;background-color:rgba(223,182,58,.4);display:none}.debug-mode tw-notifier{display:inline}tw-notifier::before{content:attr(message)}tw-colour{border:1px solid #000;display:inline-block;width:1em;height:1em}tw-enchantment:empty{display:none}h1{font-size:3em}h2{font-size:2.25em}h3{font-size:1.75em}h1,h2,h3,h4,h5,h6{line-height:1em;margin:.3em 0 .6em 0}pre{font-size:1rem;line-height:initial}small{font-size:70%}big{font-size:120%}mark{color:rgba(0,0,0,.6);background-color:#ff9}ins{color:rgba(0,0,0,.6);background-color:rgba(255,242,204,.5);border-radius:.5em;box-shadow:0em 0em .2em #ffe699;text-decoration:none}center{text-align:center;margin:0 auto;width:60%}blink{text-decoration:none;animation:fade-in-out 1s steps(1, end) infinite alternate}tw-align{display:block}tw-columns{display:-ms-flexbox;display:flex;-ms-flex-direction:row;flex-direction:row;-ms-flex-pack:justify;justify-content:space-between}.transition-in{animation:appear 0ms step-start}.transition-out{animation:appear 0ms step-end}[data-t8n^=dissolve].transition-in,[data-t8n=fade].transition-in{animation:appear .8s}[data-t8n^=dissolve].transition-out,[data-t8n=fade].transition-out{animation:appear .8s reverse}[data-t8n^=shudder].transition-in{display:inline-block !important;animation:shudder-in .8s}[data-t8n^=shudder].transition-out{display:inline-block !important;animation:shudder-in .8s reverse}[data-t8n^=rumble].transition-in{display:inline-block !important;animation:rumble-in .8s}[data-t8n^=rumble].transition-out{display:inline-block !important;animation:rumble-in .8s reverse}[data-t8n^=pulse].transition-in{animation:pulse .8s;display:inline-block !important}[data-t8n^=pulse].transition-out{animation:pulse .8s reverse;display:inline-block !important}[data-t8n^=zoom].transition-in{animation:zoom-in .8s;display:inline-block !important}[data-t8n^=zoom].transition-out{animation:zoom-in .8s reverse;display:inline-block !important}[data-t8n^=blur].transition-in{animation:blur .8s;display:inline-block !important}[data-t8n^=blur].transition-out{animation:blur .8s reverse;display:inline-block !important}[data-t8n^=slideleft].transition-in{animation:slide-left .8s;display:inline-block !important}[data-t8n^=slideleft].transition-out{animation:slide-right .8s reverse;display:inline-block !important}[data-t8n^=slideright].transition-in{animation:slide-right .8s;display:inline-block !important}[data-t8n^=slideright].transition-out{animation:slide-left .8s reverse;display:inline-block !important}[data-t8n^=slideup].transition-in{animation:slide-up .8s;display:inline-block !important}[data-t8n^=slideup].transition-out{animation:slide-down .8s reverse;display:inline-block !important}[data-t8n^=slidedown].transition-in{animation:slide-down .8s;display:inline-block !important}[data-t8n^=slidedown].transition-out{animation:slide-up .8s reverse;display:inline-block !important}[data-t8n^=fadeleft].transition-in{animation:fade-left .8s;display:inline-block !important}[data-t8n^=fadeleft].transition-out{animation:fade-right .8s reverse;display:inline-block !important}[data-t8n^=faderight].transition-in{animation:fade-right .8s;display:inline-block !important}[data-t8n^=faderight].transition-out{animation:fade-left .8s reverse;display:inline-block !important}[data-t8n^=fadeup].transition-in{animation:fade-up .8s;display:inline-block !important}[data-t8n^=fadeup].transition-out{animation:fade-down .8s reverse;display:inline-block !important}[data-t8n^=fadedown].transition-in{animation:fade-down .8s;display:inline-block !important}[data-t8n^=fadedown].transition-out{animation:fade-up .8s reverse;display:inline-block !important}[data-t8n^=flicker].transition-in{animation:flicker .8s}[data-t8n^=flicker].transition-out{animation:flicker .8s reverse}
</style>
</head>
<body>
<tw-story><noscript><tw-noscript>JavaScript needs to be enabled to play The Three Burials of Magister Corvan.</tw-noscript></noscript></tw-story>
<tw-storydata name="The Three Burials of Magister Corvan" startnode="2" creator="Twine" creator-version="2.10.0" format="Harlowe" format-version="3.3.9" ifid="f6982699-df01-49fe-a72b-3db976ff8d0a" options="" tags="" zoom="0.6" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">/* Style Global */

.image-container {
  position: relative !important;
  display: flex;
  width: 100%; 
  justify-content: center;
  border-radius: 10px;
  overflow: hidden;
  cursor: pointer;
}

.image-container img {
  top: 0;
  left: 0;
  width: 75%;
  object-fit: cover;
  border-radius: 10px;
  border: 1px solid #ffd700;
  transition: opacity 1.5s ease-in-out;
}

@media (max-width: 768px) {
  .image-container img {
    width: 85%;
  }
}

body {
  margin: 0;
  padding: 0;
  color: #FFF5EE;
}
button{
	background-color: rgba(58, 56, 38, 0.9);
    border: 1px solid #FFD700;
    color: #FFD700;
    border-radius: 8px;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.3s ease;
    width: 100%;
  	height:35px;
}

.cssde{filter: invert(50%) sepia(100%) saturate(300%) hue-rotate(357deg) brightness(110%) contrast(95%);
width:100%;
}

@media (max-width: 768px) {
 .cssde{width:50px;height:50px;}     
}

/*Affiche info objet au mouseover souris*/
.tooltip {
    position: absolute !important;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px;
    border-radius: 5px;
    font-size: 12px;
    z-index: 999;
    pointer-events: none; 
  	font-family: 'DM Sans', sans-serif;
}

tw-link, .enchantment-link { 
  color: #ffd700 !important;

}
/*FIN Affiche info objet au mouseover souris*/
h1{font-size:25px;}
/* Fin Style Global*/

tw-sidebar {height: 0px; display:none;}
tw-story tw-consecutive-br {height: 0px;}
br{height: 0px !important;}

tw-story {
  background-image: url("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/background/ASpaceIncidentBackground.jpg");
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  display: flex;
  flex-direction: column;
}

tw-passage {
  padding: 10px;
  font-family: 'DM Sans', sans-serif;
  font-size: 1.2rem;
  margin-bottom: 2rem;
  background: rgba(0, 0, 0, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 15px;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
  color: #FFF;
  margin: 1rem auto;
  width: calc(100% - 2rem);
}

@media (max-width: 768px) {
  tw-passage {
  font-size: 0.8rem;
  width: calc(100%);  
  margin-bottom: 200px;

}

  tw-story{
    font-size:1rem;
  }
}

/*!Header */

	/*?Bouton map/invent/character*/
    .game-interface {
          height: 100px;
    }
    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-buttons {
      width: 30%;
      display: flex;
      gap: 0.1rem;
    }

    .nav-btn {
      height:25px;
      background-color: rgba(58, 56, 38, 0.9);
      border: 1px solid #FFD700;
      color: #FFD700;
    font-size: 10px;
      border-radius: 20px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.3s ease;
      font-size: 0.6rem;
    }

    .disabled-btn {
        background-color: #950000 !important; 
        border-color: darkred !important;
      	color: #ffffff;
        cursor: not-allowed;
        opacity: 0.7;
    }



/* Animation gain de points d'expérience */
@keyframes pulse {
  0% {
    transform: scale(1);
    background-color: #8b2727;
  }
  50% {
    transform: scale(1.2);
    background-color: #FFD700;
  }
  100% {
    transform: scale(1);
    background-color: #8b2727;
  }
}

.nav-btn.character-animation {
  animation: pulse 0.5s ease-in-out infinite;
}

/* Fin Animation gain de points d'expérience */

    .nav-btn.active {
      background-color: #FFD700;
      color: #000;
    }

    @media (max-width: 768px) {
      .game-interface {
        grid-template-rows: auto auto 1fr;
        gap: 1rem;
      }

      .top-nav{
        flex-direction: column;
      }


      .nav-buttons {
        width: 100%;
        justify-content: space-between;
      }

      .nav-btn {
        width: auto;
        flex: 1;
      }
    }
	  /*?FIN Bouton map/invent/character*/
    /*?Barre points de vie*/
   .progress-bar {
    display: flex;
    align-items: center;
    width: 100%;
    background-color: rgba(58, 56, 38, 0.9);
    padding: 10px;
    border-radius: 20px;
  }
  .health-bar { 
    flex-grow: 1;
    height: 20px;
    background-color: #2a2a2a;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
  }
  .bar-fill {
    width: 100%; 
    height: 100%; 
    background: linear-gradient(90deg, #44ff44 0%, #44ff8f 100%);
    transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
  }
  .bar-text {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    text-align: center;
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
    line-height: 20px;
  }
    .money {
      color: #FFD700;
      font-weight: bold;
      min-width: 50px;
      text-align: right;
    }

  @media (max-width: 768px) {
      .progress-bar {
      width: 100%;
    }
	} 
  /*?Fin Barre points de vie*/
  /*?Block Contenue Menu*/
.content-panel {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 800px;
  max-height: calc(100vh - 20px);
  
  background-color: #2F2F2F;
  border: 2px solid #FFD700;
  border-radius: 8px;
  padding: 8px;
  
  display: none;
  z-index: 99999;

  /* ajout scroll*/
  overflow-y: auto;
}

  .content-panel.active {
    display: block;
  }
  @media (max-width: 768px) {
  .content-panel{
    width: 100%;
  }
}

  .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    border: 2px solid #FFD700;
    border-radius: 4px;
    background-color: transparent;
    color: #FFD700;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .close-btn:hover {
    background-color: #FFD700;
    color: #000;
  }    
}
  /*?Fin Block Contenue Menu*/
/*! Fin Header */

/*!---MenuInventaire---*/
.close-btn {
  float: right;
  background: none;
  border: none;
  color: #FFD700;
  font-size: 24px;
  cursor: pointer;
}

.inventaireHaut {
  display: flex;
  width: 100%;
  gap: 1rem;
  justify-content: center;
  margin-bottom: 20px;
}


.inventaireIngame, .slot, .iconArmors, .zonesoin, .zonesuppression{
  width: 65px;
  height: 65px;
  border: 1px solid rgb(202 138 4 / 0.5);
  border-radius: 8px;
  background-color: rgb(0 0 0 / 72%);
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

.paramBlock{
  display: flex;
  align-content: center;
  justify-content: center;
  gap:15px;
}

.zonesoin{
  background-color: rgb(127 74 29 / 80%);;    
  font-weight: 700;
}
.zonesuppression{
  background-color: rgb(127 29 29 / 0.8);    
  font-weight: 700;
}


.inventaireIngame:hover, .slot:hover, .iconArmors:hover,.zonesoin:hover, .zonesuppression:hover{
  transform: scale(1.2); 
  transition: transform 0.3s ease; 
}

.iconArmors{
  width:70px;
  height:70px;
}

.iconArmors::after {
  content: attr(data-default-icon);
  position: absolute;
  opacity: 0.5;
}

.argentequipements{
  font-size: 0.8rem;
  gap:0.1px;
}
.inventaireBas {
  width: 100%;
  display: flex;
  flex-direction: row;
}

.details-armors{
  display:flex;
  width:100%;
  flex-direction: row;
}

.blockStatsArmures{
    width: 100%;
    height: 40px;
  	padding:1rem;
    border: 1px solid #FFD700;
    border-radius: 8px;
    background-color: rgba(58, 56, 38, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

.statDegats, .statArmures{
  width:50%;
  text-align: center;
  font-size: 0.75rem;
  color: #ffd700;
  font-weight: bold;
}

.blockEquipements{
  display:flex;
  width:100%;
  gap: 5px;
  justify-content: center;
  flex-direction: row;
}

  .special-armors {
    margin-top: 50px;
    width: 30%;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    gap: 0.2rem;
  }

  .igauche, .icentre, .idroite {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
  }

.rangementcotedroit{ 
    display: flex;
    width: 70%;
    flex-direction: column;
  	align-items: center;
}
.inventory-grid {
  margin-top: 20px;
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 1rem;
}

.item-img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  cursor: move;
  border-radius: 8px;
  transition: transform 0.3s ease;
}

/* Animation au survol */
.item-img:hover {
  transform: rotate(5deg);
}

.dragging {
  opacity: 0.5;
}

.RAInventaire{
  display: flex;
  justify-content: center;
  align-items: center;
  gap:15px;
}  

/*Affichage Automatic Storage*/
.RAInventaire {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  margin-top: 15px;
  background-color: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 10px;
  width: fit-content;
  color: #fff;
  font-family: 'DM Sans', sans-serif;
}

.label-text-modern {
  font-size: 16px;
  font-weight: 500;
}

.toggle-modern {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 28px;
}

.toggle-modern input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider-modern {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #999;
  transition: 0.4s;
  border-radius: 34px;
}

.slider-modern::before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 4px;
  bottom: 3px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

.toggle-modern input:checked + .slider-modern {
  background-color: #4caf50;
}

.toggle-modern input:checked + .slider-modern::before {
  transform: translateX(22px);
}


/*FIN Affichage Automatic Storage*/


  @media (max-width: 768px) {
    .inventaireHaut{
      gap:0.3rem;
      margin-bottom:0px;
    }

      .special-armors {
          margin-top: 20px;
      }
    .statDegats, .statArmures{
        font-size: 0.40rem;
      }
    
    .inventory-grid{
      gap:0.4rem; 
    }
        .iconArmors{
          width:60px;
        height:60px;
      }

      .inventaireIngame, .slot, .iconArmors, .zonesoin, .zonesuppression{
          width: 35px;
          height: 35px;
      }
    .argentequipements{
      font-size: 0.4rem;
    }
  }
/*!---Fin MenuInventaire---*/
/*!Menu carapter*/
  #skills-panel {
      background-color: #16332f;
      border: 2px solid #FFD700;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 800px;
      margin: auto;
      color: white;
  }

  .character-title {
      color: #FFD700;
      font-weight: bold;
      text-align: center;
      font-size: 1.5rem;
  }

  .blockcarapter {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
  }

  .character-details {
      width: 100%;
      text-align: center;
  }

  .tableinfoscaracter {
      width: 100%;
      border-collapse: collapse;
      background-color: #1f3a3a;
      padding: 10px;
  }

  .bold-yellow {
      font-weight: bold;
      color: #FFD700;
  }

  .bold-white {
      font-weight: bold;
  }

  .blockinfoPerso {
      display: flex;
      align-items: center;
      gap: 20px;
      width: 100%;
      justify-content: center;
  }

  .portrait {
      width: 200px;
      height:auto;
  }

  .CharacterImg{
    width:100%; 
      border: 2px solid #FFD700;
      background-color: #1f3a3a;
      border-radius: 10px;
  }

  .portrait-description {
      border: 2px solid #FFD700;
      background-color: rgba(26, 46, 42, 0.9);
      padding: 10px;
      color: white;
      width: 80%;
  }

  .stats-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
  }

  .stat-group {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      gap: 1rem;
  }

  .stat-controls {
      display: flex;
      align-items: center;
      gap: 10px;
  }

  .stat-btn {
      width: 30px;
      height: 30px;
      border: 2px solid #FFD700;
      background: transparent;
      color: #FFD700;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .stat-btn:hover {
      background: #FFD700;
      color: #1f3a3a;
  }

  .stat-value {
      width: 40px;
      height: 40px;
      border: 2px solid #FFD700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.2);
      color: white;
  }

  .stat-name {
      color: #FFD700;
      font-size: 1rem;
      font-weight: bold;
      text-transform: uppercase;
  }

  .points-remaining {
      text-align: center;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      border: 2px solid #FFD700;
      font-weight: bold;
      margin-top: 10px;
  }

  .points-value {
      color: #FFD700;
      font-size: 1.5rem;
      font-weight: bold;
  }

.character-stats {
  margin-top: 1em;
}
.character-stats ul {
  list-style: none;
  padding: 0;
}
.character-stats li {
  margin: 0.3em 0;
}

.presCompetences{
  display: flex;
  gap: 50px;
  justify-content: center;
  flex-wrap: wrap;
}

  @media (max-width: 700px) {
      #skills-panel {
          width: 95%;
          padding: 15px;
      }
      .blockcarapter{
        gap:0px;
       }
      .blockinfoPerso {
          gap: 2px;
      }
      .portrait {
          width: 150px;
          height: auto;
      }
      .portrait-description{
        line-height: 1.4;
        font-size: 0.7rem;
       }
      .stat-group {
          flex-direction: column;
          gap: 5px;
      }
      .stat-controls {
          width: 100%;
          justify-content: space-around;
      }
      .character-title {
          font-size: 1.3rem;
      }
      .tableinfoscaracter td {
          padding: 8px;
          font-size: 0.9rem;
      }
  }
/*!Fin menu carapter*/
/*!--- Option ---*/
.conteneur-options{
      display: flex;
    justify-content: center;
}
.options-audio, .options-jeu {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  width: 100%;
}

.option-item {
    display: flex;
  	justify-content: center;
    width: 100%;
    gap: 20px;
    margin-bottom: 15px;
    align-items: center;
}

.option-item-son{
   width: 100%;
  margin-bottom: 15px;
  display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}
.separateur {
  width: 2px;
  background-color: #FFD700;
  height: 150px;
  margin: 0 10px;
  opacity: 0.7;
}
.boutonResetLocalSt{
  background: #ff4444;
  color: white; 
  padding: 8px; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer;
}
label {
  display: block;
  color: #FFD700;
  font-weight: bold;
}

input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: #FFD700;
  margin-bottom: 5px;
}

/* Curseurs de volume */
input[type="range"] {
  width: 100%;
  height: 6px;
  -webkit-appearance: none;
  background: linear-gradient(to right, #FFD700, #FF4500);
  border-radius: 10px;
  margin-bottom: 5px;
  cursor: pointer;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  background: #3498db;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid white;
}

input[type="range"]::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: #3498db;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid white;
}

.lienSite {
	width:50%;
      font-weight: bold;
    color: #ffd700 !important;
      text-decoration: none;
}

/* Bouton de réinitialisation */

.panel-footer {
    margin-top: 20px;
    width: 100%;
    display: flex;
    border-top: 1px solid rgba(255, 215, 0, 0.3);
    flex-wrap: wrap;
    justify-content: center;
    flex-direction: column;
}


.icon-symbol {
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #333;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-bottom: 5px;
  font-size: 18px;
}

.icon-label {
  font-size: 12px;
}

.autreParametre{
    display: flex;
    width: 100%;
	flex-wrap: wrap;
  	text-align:center;
    justify-content: center;
     align-content: center;
}

.blockParametre{
	width: 50%;
    display: flex;
    justify-content: center;
}
.titre-options {
  color: #FFD700;
  text-align: center;
  margin-bottom: 20px;
}

.conteneur-options {
  display: flex;
  justify-content: space-around;
  gap: 40px;
  flex-wrap: wrap;
  padding: 10px 0;
}

.options-colonne {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-width: 280px;
}

.option-item,
.option-item-son {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 15px;
  margin-bottom: 15px;
}

.option-item-son {
    flex-direction: row;
    display: flex;
    align-items: center;
}

.panel-footer {
  margin-top: 20px;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.blockParametreBas{
	width: 50%;
    display: flex;
    justify-content: center;
}


/*! --- FIN Option --- */
/*!---Choix Perso---*/
  .character-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    max-width: 800px;
    margin: auto;
    padding: 1rem;
  }

  .character-info {
    border: 1px solid #FFD700;
    background-color: rgba(26, 46, 42, 0.9);
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    padding: 1rem;
  }

  .character-title {
    text-align: center;
    font-size: 1.5rem;
    color: #FFD700;
    margin-bottom: 0.5rem;
  }

  .character-rangement {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
  }

  .character-portrait {
    flex: 1;
    max-width: 200px;
    border-radius: 10px;
    overflow: hidden;
  }

  .ImgCharacter {
    width: 100%;
    display: block;
    border-radius: 10px;
  }

  .character-description {
    flex: 2;
    padding: 0.8rem;
    border-radius: 10px;
    font-size: 1rem;
    color: white;
    line-height: 1.5;
  }

  .twine-link {
    display: inline-block;
    margin-top: 0.5rem;
    color: #FFD700;
    font-weight: bold;
    cursor: pointer;
  }

  @media (max-width: 600px) {
    .character-rangement {
      flex-direction: column;
      text-align: center;
    }

    .character-description {
      width: 100%;
    }
  }

/*!---FIN Choix Perso---*/

  .value-change {
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.8rem;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }

  .value-change.visible {
    opacity: 1;
  }

  .value-change.increase {
    color: #00ff00;
  }

  .value-change.decrease {
    color: #ff0000;
  }
/*!Zone Footer*/
  .xp-container {
    position: fixed;
    right: 1rem;
    top: 25%;
    transform: translateY(-60%);
    background-color: rgba(58, 56, 38, 0.9);
    border-radius: 15px;
    padding: 1rem;
    width: 200px;
    transition: transform 0.3s ease-in-out;
  }
  .lvl-xp {
    display: block;
    text-align: center;
    color: white;
    font-size: 1rem; 
    margin-bottom: 0.5rem;
  }

  .xp-bar {
    width: 100%;
    height: 20px;
    background-color: #2a2a2a;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
  }

  .xp-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0; 
    background: linear-gradient(90deg, #98a496 0%, #bdb2c1 100%);
    transition: width 0.3s ease-in-out;
    z-index: 1;
  }

  .bar-text-xp {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.8rem;
    pointer-events: none; 
  }

  .inventory-sidebar {
    position: fixed;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(58, 56, 38, 0.9);
    border-radius: 15px;
    padding: 1rem;
    width: 200px;
    transition: transform 0.3s ease-in-out;
  }

  .classinventory {
	display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    flex-direction: column;
    align-content: center;
  }

    .RangementdivFooter{
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    justify-content: space-evenly
    }

  .inventory-slot {
    width: 40px;
    height:40px;
    border: 1px solid #FFD700;
    border-radius: 8px;
    background-color: rgba(0, 0, 0, 0.3);
  }

  .option-btn {
    background-color: rgba(58, 56, 38, 0.9);
    border: 1px solid #FFD700;
    color: #FFD700;
    padding: 0.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 0.5rem;
  }

  .option-btn:hover {
    background-color: rgba(78, 76, 58, 0.9);
  } 

	.option-btn.active {
      background-color: #FFD700;
      color: #000;
    }

@media (max-width: 768px) {
  .xp-container {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px; 
    padding: 1rem;
    z-index: 1000;
    top: auto; 
    right: auto; 
    margin-bottom: 100px;

  }


    .bar-text-xp {
      margin-bottom:0px;
    }
    
      .inventory-sidebar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      top: auto;
      transform: none;
      width: 100%;
      border-radius: 15px 15px 0 0;
      padding: 1rem;
      z-index: 1000;
      max-height: 40vh;
      overflow-y: auto;
      padding:0px;
    }
    
      .classinventory {
      justify-content: center;
    }
    
  }

  @media (max-width: 425px) {
    .inventory-slot{
      width:25px;
      height:25px;
    }
  }
/*!Fin Zone Footer*/

/*!CSS CHEST*/
        .chest {
            width: 95%;
            position: relative;
            margin: 30px 10px;
        }

        .toggle-view-btn {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom, #2d2d2d, #1a1a1a);
            border: none;
            border-radius: 20px;
            width: 80px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

          .toggle-view-btn.active .toggle-slider {
              background: linear-gradient(to bottom, #ffd700, #e6c200); 
              transform: translateX(35px); 
          }
      .toggle-slider {
          transition: transform 0.3s ease, background 0.3s ease; 
      }

        .inventory-icon, .equipment-icon {
            font-size: 14px;
            z-index: 2;
        }

        .toggle-slider {
            position: absolute;
            left: 5px;
            width: 35px;
            height: 20px;
            background: linear-gradient(to bottom, #ffb142, #e69500);
            border-radius: 15px;
            transition: transform 0.3s ease;
        }

        .chest-content {
            display: flex;
          	flex-wrap: wrap;
            gap: 20px;
            margin-top: 10px;
        }

        .chest-view {
            display: none;
            flex-direction: column;
            gap: 20px;
        }

        .chest-view.active {
          display: flex;
          flex-direction: row;
          justify-content: center;
        }

        /* Style pour le coffre (gauche) */
        .inventoryChest {
            flex: 1;
            background: linear-gradient(135deg, rgba(87, 55, 10, 0.7), 			   rgba(51, 31, 5, 0.7));
            border: 4px solid #8B4513;
            border-radius: 8px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .inventoryChest::before {
            content: "CHEST";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom, #8B4513, #6B3100);
            color: #FFD700;
            padding: 3px 15px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            border: 2px solid #704214;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        /* Style pour l'inventaire du joueur (droite) */
        .inventoryPlayerChest {
            flex: 1;
            background: linear-gradient(135deg, rgba(23, 43, 77, 0.7), rgba(13, 25, 45, 0.7));
            border: 4px solid #2c4a7c;
            border-radius: 8px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .inventoryPlayerChest::before {
            content: "INVENTORY";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom, #2c4a7c, #1a2c4c);
            color: #90c7ff;
            padding: 3px 15px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            border: 2px solid #3a5d96;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .slotChest {
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 5px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        /* Différenciation des slots par conteneur */
        .inventoryChest .slotChest {
            border: 2px solid #b36b00;
            box-shadow: 0 0 5px rgba(179, 107, 0, 0.3);
        }

        .inventoryChest .slotChest:hover {
            border-color: #ffa94d;
            box-shadow: 0 0 8px rgba(255, 169, 77, 0.5);
            transform: scale(1.05);
        }

        .inventoryPlayerChest .slotChest {
            border: 2px solid #3a5d96;
            box-shadow: 0 0 5px rgba(58, 93, 150, 0.3);
        }

        .inventoryPlayerChest .slotChest:hover {
            border-color: #6d9eeb;
            box-shadow: 0 0 8px rgba(109, 158, 235, 0.5);
            transform: scale(1.05);
        }

        /* Style pour la vue équipement */
        .special-armorsCoffre {
            background: linear-gradient(135deg, rgba(42, 21, 58, 0.7), rgba(25, 12, 35, 0.7));
            border: 4px solid #5d3d7d;
            border-radius: 8px;
            padding: 20px;
          	margin:10px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* Animation d'item */
        .slotChest img {
            max-width: 90%;
            max-height: 90%;
            transition: all 0.3s ease;
        }

        .slotChest:hover img {
            transform: scale(1.1) rotate(5deg);
		}

        /* Effet de glow pour indiquer les emplacements actifs */
        .slotChest.active {
            animation: glow 1.5s infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 5px -5px #ffcc00;
            }
            to {
                box-shadow: 0 0 15px 4px #ffcc00;
            }
		}
        /* Tablettes en mode portrait et grands téléphones */
        @media (max-width: 768px) {
            .chest-content {
                flex-direction: column;
                gap: 40px;
            }
            
            .chest-view.active {
                flex-direction: column;
                gap: 40px;
            }
            .toggle-view-btn.active .toggle-slider {
                transform: translateX(25px); 
            }
            .inventoryChest::before, .inventoryPlayerChest::before {
                top: -12px;
                font-size: 12px;
                padding: 2px 12px;
            }
            
            .toggle-view-btn {
                width: 70px;
                height: 26px;
            }
            
            .toggle-slider {
                width: 30px;
                height: 18px;
            }
            
            .inventory-icon, .equipment-icon {
                font-size: 12px;
            }
        }
        
        /* Téléphones mobiles */
        @media (max-width: 576px) {
            .chest {
                padding: 10px;
                margin: 20px 5px;
            }
            
            .inventoryChest, .inventoryPlayerChest {
                padding: 10px;
                gap: 6px;
            }
            
            .slotChest {
                width: 35px;
                height: 35px;
                border-width: 1px;
            }
            
            .inventoryChest::before, .inventoryPlayerChest::before {
                font-size: 10px;
                padding: 2px 8px;
                top: -10px;
            }
            
            .toggle-view-btn {
                width: 60px;
                height: 24px;
            }
            
            .toggle-slider {
                width: 25px;
                height: 16px;
            }
            
            .inventory-icon, .equipment-icon {
                font-size: 10px;
            }
            
            .item-count {
                font-size: 8px;
                padding: 0px 2px;
            }
           
        }
        
     	   /* Très petits téléphones */
        @media (max-width: 375px) {
            .chest {
                padding: 8px;
            }
            
            .inventoryChest, .inventoryPlayerChest {
                padding: 8px;
                gap: 5px;
            }
            
            .slotChest {
                width: 32px;
                height: 32px;
            }
        }
        
/*!Fin Zone Chest*/

/*!Style Combats*/
   #turn-indicator, #combat-log {
    text-align: center;
    padding: 10px;
    border-radius: 22px;
    border: 1px solid gold;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 10px;
    }

    .blockCombats {
        display: flex;
        width: 100%;
        height: 69%;
        align-items: center;
     }

    .Combatscharacter {
        position: absolute;
        width: 20%;
        text-align: center;
        transition: transform 0.3s;
    }

        .damage-popup {
            pointer-events: none;
            user-select: none;
            z-index: 1000;
        }

        @keyframes damageFloat {
            0% { 
                opacity: 1;
                transform: translateY(0);
            }
            100% { 
                opacity: 0;
                transform: translateY(-50px);
            }
        }


    #player { left: 5%; }
    #enemy { right: 5%; }

    .tailleImgCombats{
        width: 100%;
    }

    .character img {
        width: 100%;
        height: auto;
    }

    .hp-bar {
        width: 100%;
        height: 15px;
        background: #444;
        border-radius: 10px;
        margin: 5px 0;
    }

    .hp-fill {
        height: 100%;
        background: #4CAF50;
        border-radius: 10px;
        transition: width 0.3s;
    }

    #actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .action-button {
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        width: 20%;
    }

    .dice-container{
        display: flex;
        flex-direction: row;
        justify-content: center;
        gap: 5px;
    }

    .dice-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

  .affichagePremierPlan{
      position: absolute; 	
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
      align-items: center; 
      z-index: 2000;
  }

    @media (max-width: 768px) {
       .dice-container{
          display: flex;
          justify-content: flex-start;
          width: 90%;
          flex-direction: column;
          align-items: center;
          flex-wrap: nowrap;
      }
        .character {
            width: 25%;
        }
      #combat-container {
    	height: 450px !important;
		}
      
        .action-button {
            font-size: 14px;
            padding: 8px 12px;
            width: 100%;
        }
      
      .blockCombats {
        margin-top: 0px;
      }
    }

    @media (max-width: 480px) {
        #turn-indicator, #combat-log {
            font-size: 18px;
            padding: 8px;
        }
      .hp-text{
        font-size: 0.6rem;
      }
      
      	 .Combatscharacter {
          padding-bottom: 40px;
    	}
        .character {
            width: 30%;
            bottom: 5%;
        }
        .action-button {
            font-size: 12px;
            padding: 6px 10px;
        }
    }

    /* Animations d'attaque */
    .attack-move {
        animation: attackAnimation 0.3s forwards;
    }
    @keyframes attackAnimation {
        0% { transform: translateX(0); }
        50% { transform: translateX(20px); }
        100% { transform: translateX(0); }
    }

    .enemy-attack-move {
        animation: enemyAttackAnimation 0.3s forwards;
    }
    @keyframes enemyAttackAnimation {
        0% { transform: translateX(0); }
        50% { transform: translateX(-20px); }
        100% { transform: translateX(0); }
    }
/*!FIN Style combats*/

/*!Zone Marchand*/
  .MarchandHaut {
      text-align: center;
      margin-bottom: 20px;
  }

  .MarchandHaut h1 {
      font-size: 28px;
      color: #fcd34d;
      margin-bottom: 10px;
      letter-spacing: 1px;
  }

  .gold-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 18px;
      font-weight: 600;
      color: #fbbf24;
  }

  i {
      color: #fcd34d;
  }

  /* Contenu principal */
  .main-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
  }

  @media (min-width: 768px) {
      .main-content {
          flex-direction: row;
      }
  }

  /* Cartes */
  .inventory-card, .merchant-card, .buy-item-details {
      background-color: #2a2a15;
      border: 2px solid #b45309;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      flex: 1;
  }

  .card-header {
      background-color: #b45309;
      padding: 12px;
      text-align: center;
  }

  .card-header h2 {
      font-size: 20px;
      font-weight: bold;
  }

  .card-content {
      padding: 16px;
  }

  /* Inventaire */
  .inventoryPlayerMarchand {
      display: flex;
      position: relative;
      flex-wrap: wrap;
      border-radius: 6px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      gap:10px;
  }

  /* Section marchand */
  .merchant-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex: 1;
  }

  /* Onglets */
  .merchant-tabs {
      display: flex;
      justify-content: center;
      border-bottom: 2px solid #b45309;
      background-color: #2a2a15;
      padding: 20px 16px 0px 20px;
  }

  .tab-button {
      flex: 1;
      gap:10px;
      background-color: #3a3a20;
      color: #fff8e1;
      border: 1px solid #92400e;
      border-bottom: none;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 4px;
      border-radius: 6px 6px 0 0;
  }

  .tab-button:hover {
      background-color: #78350f;
  }

  .tab-button.active {
      background-color: #b45309;
      color: #fff8e1;
      border-color: #b45309;
  }

  .tab-button i {
      font-size: 14px;
  }

  /* Contenu des onglets */
  .tab-content {
      padding: 16px;
  }

  .tab-pane {
      display: none;
  }

  .tab-pane.active {
      display: block;
  }

  .tab-pane h3 {
      font-size: 18px;
      color: #fcd34d;
      margin-bottom: 12px;
  }

  /* Articles du marchand */
  .merchant-items {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
  }

  @media (min-width: 768px) {
      .merchant-items {
          grid-template-columns: repeat(4, 1fr);
      }
  }

  .merchant-item {
      width: 45%;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-wrap: wrap;
      background-color: #3a3a20;
      border: 2px solid #92400e;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.2s;
  }

  .merchant-item:hover {
      border-color: #d97706;
  }

  .merchant-item img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      margin-bottom: 8px;
  }

  .merchant-item h4 {
      font-size: 14px;
      text-align: center;
      color: #fde68a;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
  }

  .merchant-item .price {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
      color: #fcd34d;
      font-size: 12px;
  }

  .merchant-item .price i {
      font-size: 10px;
  }

  /* --- Détails des objets --- */
@media (pointer: coarse) {
  .item-img {
    touch-action: none; 
    user-select: none; 
  }
}
  .item-details, .buy-item-details, .sell-item-details {
      padding: 16px;
      border-top: 2px solid #b45309;
      display: none;
  }

  .item-details.active, .buy-item-details.active, .sell-item-details.active {
      display: block;
  }

  .item-content {
      display: flex;
      align-items: flex-start;
      gap: 16px;
  }

  .item-image {
      background-color: #3a3a20;
      border: 2px solid #92400e;
      border-radius: 6px;
      padding: 4px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .item-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
  }

  .item-info {
      flex: 1;
  }

  .item-info h3 {
      font-size: 18px;
      color: #fcd34d;
      margin-bottom: 4px;
  }

  .item-info p {
      font-size: 14px;
      color: rgba(253, 230, 138, 0.8);
      margin-bottom: 8px;
  }

  .item-price {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #fcd34d;
      font-size: 16px;
      margin-bottom: 12px;
  }

  .item-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
  }

  .btn {
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
  }

  .btn-primary {
      background-color: #b45309;
      color: #fff8e1;
  }

  .btn-primary:hover {
      background-color: #d97706;
  }

  .btn-primary:disabled {
      background-color: #92400e;
      opacity: 0.7;
      cursor: not-allowed;
  }

  .btn-outline {
      background-color: #3a3a20;
      color: #fff8e1;
      border-color: #92400e;
  }

  .btn-outline:hover {
      background-color: #78350f;
  }

  .btn-green {
      background-color: #166534;
      color: #dcfce7;
  }

  .btn-green:hover {
      background-color: #15803d;
  }

  .btn-red {
      background-color: #7f1d1d;
      color: #fee2e2;
  }

  .btn-red:hover {
      background-color: #991b1b;
  }

  /* --- Vente --- */
  .sell-container {
      background-color: #3a3a20;
      border: 2px solid #92400e;
      border-radius: 8px;
      padding: 16px;
  }

  .sell-container p {
      color: #fde68a;
      margin-bottom: 16px;
  }

  .sell-item-content {
    display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-direction: column;
      justify-content: center;
  }

  .sell-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-top: 1px solid rgba(180, 83, 9, 0.5);
      padding-top: 12px;
  }

  .no-selection {
      font-style: italic;
      color: rgba(253, 230, 138, 0.7);
  }

  /* --- Anecdotes --- */
  .anecdote-container {
      background-color: #3a3a20;
      border: 2px solid #92400e;
      border-radius: 8px;
      padding: 24px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
  }

  .anecdote-icon {
      width: 64px;
      height: 64px;
      background-color: #b45309;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .anecdote-icon i {
      font-size: 32px;
      color: #fde68a;
  }

  .anecdote-content {
      flex: 1;
  }

  .anecdote-text {
      font-style: italic;
      color: #fde68a;
      margin-bottom: 16px;
      min-height: 60px;
  }

  .anecdote-button {
      background-color: #b45309;
      color: #fff8e1;
      border: none;
      border-radius: 4px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
  }

  .anecdote-button:hover {
      background-color: #d97706;
  }

  /* --- Détails d'achat --- */
  .buy-item-details {
      margin-top: 16px;
  }

  .buy-item-content {
      display: flex;
      align-items: flex-start;
      gap: 16px;
  }

  .buy-image {
      background-color: #3a3a20;
      border: 2px solid #92400e;
      border-radius: 6px;
      padding: 8px;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .buy-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
  }

  .buy-info {
      flex: 1;
  }

  .buy-info h3 {
      font-size: 20px;
      color: #fcd34d;
      margin-bottom: 8px;
  }

  .buy-info p {
      font-size: 14px;
      color: rgba(253, 230, 138, 0.8);
      margin-bottom: 12px;
  }

  .buy-price {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #fcd34d;
      font-size: 18px;
      margin-bottom: 16px;
  }

  .buy-actions {
      display: flex;
      gap: 8px;
  }


  .slotChest.selected {
      border-color: #ffd700 !important;
      background-color: rgba(255, 215, 0, 0.1);
  }

  .sell-item-img {
      max-width: 100px;
      max-height: 100px;
      object-fit: contain;
      margin: 10px 0;
  }

  .sell-item-stats {
      width:100%;
      background: #3a3a20;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #b45309;
  }

  .sell-price {
      color: #fcd34d;
      font-weight: bold;
      margin: 10px 0;
  }
/*!FIN Zone Marchand*/
/*Particularité dans le jeux*/
.boutonXp{
    background: #222;
    color: #FFD700;
    font-weight: bold;
    border: 2px solid #FFD700;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease-in-out;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 4px 10px rgba(255, 215, 0, 0.2);
    text-shadow: 2px 2px 4px rgba(255, 215, 0, 0.3);
    position: relative;
    overflow: hidden;
}
/*FIN Particularité dans le jeux*/

/*Crédit*/
  
    /* Conteneur pour le défilement */
    .credits-container {
      position: relative;
      height: 800px;
      overflow: hidden;
    }
    
    /* Le bloc des crédits qui va défiler */
    .credits {
      position: absolute;
      width: 100%;
      bottom: -100%;
      text-align: center;
      animation: scrollCredits 25s linear infinite;
    }
    
    /* Animation du défilement (ajuste la durée pour modifier la vitesse) */
    @keyframes scrollCredits {
      0% {
        bottom: -100%;
      }
      100% {
        bottom: 100%;
      }
    }

    /* Style des titres et paragraphes */
/* Style par défaut (desktop) */
.credits h1 {
  font-size: 2.5em;
  margin: 0.5em 0;
}

.credits h2 {
  font-size: 1.8em;
  margin: 0.3em 0;
}

.credits p {
  font-size: 1.2em;
  margin: 0.2em 0;
}


@media (max-width: 768px) {
  .credits h1 {
    font-size: 2em;
  }

  .credits h2 {
    font-size: 1.5em;
  }

  .credits p {
    font-size: 1em;
  }
}


@media (max-width: 480px) {
  .credits h1 {
    font-size: 1.6em;
  }

  .credits h2 {
    font-size: 1.3em;
  }

  .credits p {
    font-size: 0.95em;
  }
}

    
    /*Affichage bouton retour*/
          .back-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #444;
      color: #fff;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 5px;
      z-index: 1000;
      transition: background-color 0.3s;
    }

    .back-button:hover {
      background-color: #666;
    }
/*FIN Crédit*/

/*Page DON Pour passer*/

    .donation-box {
      border-radius: 20px;
      padding: 30px;
      margin: 30px auto;
      width: 300px;
      text-align: center;
      background: linear-gradient(to bottom right, #111, #333);
      color: #ffd700;
      font-family: 'Trebuchet MS', sans-serif;
      transition: all 0.3s ease;
      cursor: grab;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
    }

    .donation-box.hover {
      background: #222;
      transform: scale(1.03);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
    }

    .subtext {
      font-size: 0.9em;
      color: #ccc;
      margin-top: 5px;
      display: block;
    }

    .donation-message {
      text-align: center;
      font-weight: bold;
      margin-top: 15px;
    }

    #recompenseDonPassage {
      display: none;
      text-align: center;
      margin-top: 20px;
      padding: 20px;
      background: #262626;
      border: 2px solid #888;
      border-radius: 10px;
    }

    #recompenseDonPassage a {
      color: #00ffcc;
      font-size: 1.2em;
      text-decoration: none;
    }

    #recompenseDonPassage a:hover {
      text-decoration: underline;
    }
/*FIN PAGE DON Pour passer*/</style><script role="script" id="twine-user-script" type="text/twine-javascript">
// Prevent scrolling to the top on passage transition
$(document).on('shown.sm.passage', function (event, passage) {
  window.scrollTo(0, 0);
});

// Keep the scroll position
$(document).on('sm.passage.hidden', function (event, passage) {
  const scrollPos = window.scrollY;
  sessionStorage.setItem('scrollPos', scrollPos);
});

$(document).on('shown.sm.passage', function (event, passage) {
  const scrollPos = sessionStorage.getItem('scrollPos');
  if (scrollPos !== null) {
    window.scrollTo(0, scrollPos);
  }
});
</script><tw-tag name="INTERFACE" color="green"></tw-tag><tw-tag name="ENDING" color="red"></tw-tag><tw-tag name="NEXUS" color="purple"></tw-tag><tw-tag name="TEMP" color="yellow"></tw-tag><tw-tag name="Admin" color="red"></tw-tag><tw-tag name="ZoneNotes" color="green"></tw-tag><tw-tag name="CodeJeux" color="purple"></tw-tag><tw-tag name="test" color="orange"></tw-tag><tw-passagedata pid="1" name="Deroule" tags="" position="3700,5075" size="100,100">START
Buried in cemetery

Dialog
Who are you ?

CHARACTER

You are not him ? (Starts to leave)

I can give you (weapon or Silver)

Choose backstory

Enter Velthorn Hollow

- Merchant 1
- Merchant 2
- Big House
- 
-


Find the heart &gt; Put it on the heart speaks.
 
Leave the village : 
Crypt &gt; First Guardian &gt; Fight &gt; Death

Descent into the Necropolis – Second Burial
Silver coffin

Find the brain &gt; Put it on

Leave the village : 
Crypt &gt; second Guardian &gt; Fight &gt; Death

Third Place : 
A bone coffin, you are inside the skeleton of a ...
It is not a coffin so much as a corpse. Flesh still attached at some places. You are in the rip cage of the beast. The air is the worst. The smell. You cough, the irritation cloating your air ways. You mange to scream, but there is no one to help you. After a while of moving, hitting desperatly, the carcasse collapses on you
DAMAGE
But the grave is shallow, so you start to see a light.
You gather what remains of your strength and start crawling toward the surface.
The sky is black, no stars, nothing to welcome you.

If you are killed my Magister Corvan, you go back to the wooden coffin

Discovery
Corvan split his soul into three vessels: body(heart), mind(brain), and name. The final choice is whether to bind his essence, replace him as the new Magister, or destroy his remnants entirely.

Depending on the final choices, the Veil is either mended, torn apart, or replaced by a new order under the player’s rule.</tw-passagedata><tw-passagedata pid="2" name="Start1" tags="" position="2200,1000" size="200,200">{(display:&quot;stats&quot;)


&lt;div id=&quot;soundPrompt&quot; style=&quot;position: fixed; top: 20px; right: 20px; background: #fcd34d; padding: 10px; border-radius: 5px; z-index: 1000;&quot;&gt;
  &lt;button id=&quot;activateSound&quot; style=&quot;background: transparent; border: none; color: black; font-size: 16px; cursor: pointer;&quot;&gt;Activate music&lt;/button&gt;
&lt;/div&gt;

&lt;center&gt;&lt;h2&gt;The Three Burials of Magister Corvan&lt;/h2&gt;&lt;/center&gt;

&lt;div class=&quot;image-container&quot;&gt;
  &lt;img class=&quot;image-base&quot; src=&quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Illustrations/Cover.jpg&quot; /&gt;
&lt;/div&gt;

}

&lt;center&gt;[[Click here to start playing|Start2]]&lt;/center&gt;


&lt;script&gt;
//Bouton Activer musique de partie
document.getElementById(&#39;activateSound&#39;).addEventListener(&#39;click&#39;, function() {
    // Vérifier si la musique de fond existe déjà
    if (!window.musiqueDeFond) {
        window.musiqueDeFond = new Audio(&quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/music/ThreeBurialsIntro.mp3&quot;);
        window.musiqueDeFond.loop = true;
        window.musiqueDeFond.volume = 0.5;
    }
    // Tente de jouer la musique
    window.musiqueDeFond.play().then(() =&gt; {
        console.log(&quot;Musique activée !&quot;);
        // Masquer le prompt une fois la musique lancée
        document.getElementById(&#39;soundPrompt&#39;).style.display = &#39;none&#39;;
    }).catch((error) =&gt; {
        console.log(&quot;Erreur lors de l&#39;activation du son :&quot;, error);
    });
});

(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem(&quot;characterUnlocked&quot;) === &quot;true&quot;;
        const characterButton = document.querySelector(&#39;.nav-btn[data-panel=&quot;skills&quot;]&#39;);
        const elementsToHide = document.querySelectorAll(&#39;.top-nav, .xp-container, .inventory-sidebar&#39;);

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove(&quot;disabled-btn&quot;);
                characterButton.disabled = false;
            } else {
                characterButton.classList.add(&quot;disabled-btn&quot;);
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el =&gt; {
            el.style.display = characterUnlocked ? &quot;&quot; : &quot;none&quot;;
        });
    }

    // Met à jour l&#39;état de l&#39;UI à chaque changement de passage
    $(document).on(&#39;:passagerender&#39;, function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();

&lt;/script&gt;
&lt;script&gt;
(function() {
  // ensure this only runs once
  if (window._postHeadersDone) return;
  window._postHeadersDone = true;

  // queue your “run last” logic
  setTimeout(function() {
  
    localStorage.clear();
  sessionStorage.clear();
 
  }, 0);
})();
&lt;/script&gt;</tw-passagedata><tw-passagedata pid="3" name="Start2" tags="" position="2500,1000" size="100,100">(text-style:&quot;blur&quot;)[On the darkest night...] your imagination sees the moon, a tree, the long rock you used to climb as a child...
&lt;div class=&quot;image-container&quot;&gt;
  &lt;img class=&quot;image-base&quot; src=&quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Illustrations/001.jpg&quot; /&gt;
&lt;/div&gt;


&lt;!--if visited once...--&gt;
&lt;!-- So you are back ! --&gt;

 &lt;script&gt;
  const newItems = [
    {
        id: &quot;ShockStick&quot;,
        nom: &quot;ShockStickX98&quot;,
        type: &quot;sword&quot;,
        strength: 5,
        durability: 35,
        class: &quot;item-img&quot;,
        draggable: true,
        inventory: &quot;1&quot;,
        src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/BatonElectrique.png&quot;,
        &quot;prix&quot;: 120,
        &quot;rare&quot;: &quot;Common&quot;
    },
    {
        id: &quot;soin1&quot;,
        nom: &quot;Health Pills&quot;,
        type: &quot;soin&quot;,
        life: 10,
        class: &quot;item-img&quot;,
        draggable: true,
        inventory: &quot;2&quot;,
        src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Pills.png&quot;,
        &quot;prix&quot;: 45,
        &quot;rare&quot;: &quot;Common&quot;
    },
    {
        id: &quot;soin2&quot;,
        nom: &quot;Health Pills&quot;,
        type: &quot;soin&quot;,
        life: -5,
        class: &quot;item-img&quot;,
        draggable: true,
        inventory: &quot;7&quot;,
        src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Pills.png&quot;,
        &quot;prix&quot;: 25,
        &quot;rare&quot;: &quot;Common&quot;
    },
    {
        id: &quot;casque1&quot;,
        nom: &quot;astronaut&#39;s helmet&quot;,
        type: &quot;helmet&quot;,
        armor: 3,
        class: &quot;item-img&quot;,
        draggable: true,
        inventory: &quot;3&quot;,
        src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Casque.png&quot;,
        &quot;prix&quot;: 90,
        &quot;rare&quot;: &quot;Common&quot;
    },
    {
        id: &quot;gloves1&quot;,
        nom: &quot;Gloves&quot;,
        type: &quot;gloves&quot;,
        armor: 1,
        class: &quot;item-img&quot;,
        draggable: true,
        inventory: &quot;4&quot;,
        src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Gloves.png&quot;,
        &quot;prix&quot;: 60,
        &quot;rare&quot;: &quot;Common&quot;
    }
  ];

  newItems.forEach((itemData) =&gt; {
    const itemElement = createItem(
      itemData.type,
      itemData.src,
      itemData.id,
      itemData.nom,
      itemData.strength,
      itemData.durability,
      itemData.life,
      itemData.armor,
      itemData.prix,
      itemData.rare,
      itemData.money
    );

    itemElement.setAttribute(&#39;data-id&#39;, itemData.id);
    itemElement.setAttribute(&#39;draggable&#39;, &#39;true&#39;);

    const targetSlot = document.getElementById(`slot-${itemData.inventory}`);
    if (targetSlot &amp;&amp; targetSlot.childNodes.length === 0) {
      targetSlot.appendChild(itemElement);

      let inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;)) || Array(24).fill(null);
      inventoryGridData[itemData.inventory - 1] = {
        id: itemData.id,
        type: itemData.type,
        src: itemData.src,
        nom: itemData.nom,
        strength: itemData.strength,
        durability: itemData.durability,
        life: itemData.life,
        armor: itemData.armor,
        prix: itemData.prix,
        rare: itemData.rare,
        money: itemData.money,
      };
      localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));

      itemElement.addEventListener(&#39;mouseenter&#39;, (e) =&gt; showTooltip(e, itemElement));
      itemElement.addEventListener(&#39;touchstart&#39;, (e) =&gt; showTooltip(e, itemElement), { passive: false });
    }
  });
&lt;/script&gt;

&lt;script&gt;
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem(&quot;characterUnlocked&quot;) === &quot;true&quot;;
        const characterButton = document.querySelector(&#39;.nav-btn[data-panel=&quot;skills&quot;]&#39;);
        const elementsToHide = document.querySelectorAll(&#39;.top-nav, .xp-container, .classinventory&#39;);

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove(&quot;disabled-btn&quot;);
                characterButton.disabled = false;
            } else {
                characterButton.classList.add(&quot;disabled-btn&quot;);
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el =&gt; {
            el.style.display = characterUnlocked ? &quot;&quot; : &quot;none&quot;;
        });
    }

    // Met à jour l&#39;état de l&#39;UI à chaque changement de passage
    $(document).on(&#39;:passagerender&#39;, function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
&lt;/script&gt;

...But your blurry eyes see (text-style:&quot;blur&quot;)[NOTHING].
You awaken from what seems to be a very long nap. Everything is still pitch black and you realise that you are not in your bed. You are lying on a wooden floor.
When you try to get up, you bump your head against an other plank of wood. 
Your hands move quickly, and you realize the attrocity of your situation.
You are.. buried. A bad way to start a new adventure, right ?
You scream, you hit the coffin that may become your world for the rest of eternity. The horrific scene lasts maybe a few seconds, maybe a minute or and hour, but then, when you hear something.

The earth above you shifts, and a gruff voice calls down through the lid’s cracks:  
**Groundskeeper:**&quot;Oi, you in there! Groundskeeper Brannon ‘ere. I am here for your first unburial. So glad I finally found you! Hav&#39; been looking for your bones for a century now! Everywhere I looked! With all those stupid dead people rising, never though I would find you! The guys at the stupid Necropolis will finally shut up! Hang in there, Magister Corvan, I&#39;m coming to get you out! You are Corvan, right?&quot;
&lt;p&gt;
- Wait a minute... I am not Magister Corvan! (say the truth)
- Of course I am! You took your sweet old time, you better hurry before I loose my patience! (Lie)

(click:&quot;say the truth&quot;)[
What? But who [[the hell|Classes]] are you, then?
(replace:&quot;Lie&quot;)[never mind]
]
(click:&quot;Lie&quot;)[

(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
  His grunt echoes. “Corvan, you say? Well… Right… I’ll get you out, m’lord.”  
  He hums in satisfaction and begins prying the lid free: **for free of course, for you, Magister...**  
  With a grunt, he heaves at the coffin lid.  
  *The wood splinters… and he recoils with a yelp.*  
  **Brannon:** “But… you’re bloody not him!”  

  * [[Stammer an excuse|CorvanDeceptionExplain]]  
  * [[Stay silent and hope he forgets|CorvanDeceptionSilent]]
  (set:$fakeCorvan to true)
      ]
  (else:)
      [
  **Brannon (from above):** “Corvan? Don’t make me laugh. I can’t even see your face: just a pair of boots poking out of the dirt!”  
  He pauses, shovel in hand, and the earth rumbles as he shifts his weight.  
  **Brannon:** “If you’re truly the great Magister, speak plain: where’s your bone-white cloak? I’d know his gait from a mile off.”  
  * [[Apologize and tell who you really are|Classes]]  
  * [[Remain silent and face his wrath|GameOverStarve]]
      ]
  ]
]
</tw-passagedata><tw-passagedata pid="4" name="stats" tags="startup" position="1825,525" size="100,100">{
(set: $currentEnding to 0)
(set:$endingNumbers to 35)

(set: $heroName to &quot;Frederick Anderson&quot;)
(set: $heroNameGravebinder to &quot;Master Lorcan Vale&quot;)
(set: $heroNameLanternBearer to &quot;Sister Ailith Mara&quot;)
(set: $heroNameOssuaryKnight to &quot;Rourke Belgrave&quot;)
(set: $heroNameWhispered to &quot;Marek Slayne&quot;)
(set: $heroNamePaleScholar to &quot;Lady Thyrenia Arkwright&quot;)
(set: $heroNameExhumed to &quot;Garron Fletch&quot;)

(set: $strength to 10)
(set: $intelligence to 10)
(set: $luck to 10)
(set: $charisma to 10)
(set: $basestrength to 10)
(set: $baseintelligence to 10)
(set: $baseluck to 10)
(set: $basecharisma to 10)

(set:$fakeCorvan to false)
(set: $MagisterHeart to false)
(set: $journal to (a: &quot;Diary of&quot;))
&lt;!--(set: $journal to it + (a: $heroName+ &quot;\n\n&quot;))  --&gt;
&lt;!--
(set: $journal to it + (a: &quot;Decoded weeping pattern: Beware Bonepickers&quot;+ &quot;\n\n&quot;))  
--&gt;
&lt;!--(set: $journal to it &quot;Diary of:&quot;+$heroName)--&gt;

(set: $job to 0)
(set: $backStory to 0)
(set: $health to 100)
(set: $maxHealth to 100)

(set: $hasBroom to false)
(set: $broom to 0)
(set: $medKit to 0)
(set: $health to 100)
(set: $maxHealth to 100)
(set: $atkBonus to 5) &lt;!--change depending on class--&gt;

(set: $CorvanQuest to false)

(set: $xp to 0)
(set: $pointExp to 5)
(set: $LvlXp to 1)
(set: $levelThreshold to 10)
(set: $xpLevelIndex to 0)


(set: $money to 1500)
(set:$skillCheckEnable to true)

(set: $abandonCrewMate to false)

(set: $hasClaws to false)
(set: $hasAmulet to false)
(set: $galaxyMap to false)
(set:$comFixed to false)
(set:$findANearbyPlanet to false)
(set:$creatureQuest to false)

(set: $alienSarah to false)
(set: $forestBeast to false)
(set: $spiderFight to false)
(set: $pirateFight to false)
(set: $caveCreature to false)

(set:$hasBeenPlanet1 to false)

(set:$endingNumbers to 54)

(set: $currentLoop to 1)


&lt;script&gt;

&lt;!--   window.initializeGameInterface();--&gt;

&lt;/script&gt;


&lt;!--
$money
$maxHealth
$description
$basestrength
$baseluck
$baseintelligence
$basecharisma

--&gt;

}
</tw-passagedata><tw-passagedata pid="5" name="diceRollMacro" tags="" position="1700,400" size="100,100">{
(if: $skillCheckEnable is true)
[
    (set: $counter to 10)
    (live: 0.2s)[
        (set: $diceRoll1 to (random: 1,6))
        (set: $diceRoll2 to (random: 1,6))
        (set: $diceRoll3 to (random: 1,6))

        (set: $diceRoll1Link to &quot;&lt;img class=&#39;cssde&#39; src=&#39;https://pickyouruniverse.com/DataProjects/General/Dé/&quot; + (str: $diceRoll1) + &quot;.png&#39;&gt;&quot;)
        (set: $diceRoll2Link to &quot;&lt;img class=&#39;cssde&#39; src=&#39;https://pickyouruniverse.com/DataProjects/General/Dé/&quot; + (str: $diceRoll2) + &quot;.png&#39;&gt;&quot;)
        (set: $diceRoll3Link to &quot;&lt;img class=&#39;cssde&#39; src=&#39;https://pickyouruniverse.com/DataProjects/General/Dé/&quot; + (str: $diceRoll3) + &quot;.png&#39;&gt;&quot;)

        &lt;table style=&quot;display: flex; width: 100%; justify-content: center;&quot;&gt;
            &lt;tr&gt;
                &lt;td&gt;$diceRoll1Link&lt;/td&gt;
                &lt;td&gt;$diceRoll2Link&lt;/td&gt;
                &lt;td&gt;$diceRoll3Link&lt;/td&gt;
            &lt;/tr&gt;
        &lt;/table&gt;

        (set: $counter to it - 1)
        (if: $counter is 0)[
            (stop:)
            (set: $diceRoll to $diceRoll1 + $diceRoll2 + $diceRoll3)
            The result is $diceRoll
        ]
    ]
]
(else:)[
(set:$diceRoll to (random: 3,18))
]
}</tw-passagedata><tw-passagedata pid="6" name="objets" tags="startup" position="2500,275" size="100,100">&lt;script&gt;
const items = [
    {
        id: &quot;ShockStick&quot;,
        nom: &quot;ShockStickX98&quot;,
        type: &quot;sword&quot;,
        strength: 5,
        durability: 35,
        class: &quot;item-img&quot;,
        draggable: true,
        inventory: &quot;1&quot;,
        src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/BatonElectrique.png&quot;,
        &quot;prix&quot;: 120,
        &quot;rare&quot;: &quot;Common&quot;
    },
    {
        id: &quot;soin1&quot;,
        nom: &quot;Health Pills&quot;,
        type: &quot;soin&quot;,
        life: 10,
        class: &quot;item-img&quot;,
        draggable: true,
        inventory: &quot;2&quot;,
        src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Pills.png&quot;,
        &quot;prix&quot;: 45,
        &quot;rare&quot;: &quot;Common&quot;
    },
    {
        id: &quot;soin1&quot;,
        nom: &quot;Health Pills&quot;,
        type: &quot;soin&quot;,
        life: -5,
        class: &quot;item-img&quot;,
        draggable: true,
        inventory: &quot;7&quot;,
        src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Pills.png&quot;,
        &quot;prix&quot;: 25,
        &quot;rare&quot;: &quot;Common&quot;
    },
    {
        id: &quot;casque1&quot;,
        nom: &quot;astronaut&#39;s helmet&quot;,
        type: &quot;helmet&quot;,
        armor: 3,
        class: &quot;item-img&quot;,
        draggable: true,
        inventory: &quot;3&quot;,
        src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Casque.png&quot;,
        &quot;prix&quot;: 90,
        &quot;rare&quot;: &quot;Common&quot;
    },
    {
        id: &quot;gloves1&quot;,
        nom: &quot;Gloves&quot;,
        type: &quot;gloves&quot;,
        armor: 1,
        class: &quot;item-img&quot;,
        draggable: true,
        inventory: &quot;4&quot;,
        src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Gloves.png&quot;,
        &quot;prix&quot;: 60,
        &quot;rare&quot;: &quot;Common&quot;
    }
];
/* Fonction pour afficher une infobulle avec les infos de l&#39;item */
function showTooltip(event, img) {
    // Créer ou récupérer l&#39;infobulle existante
    let tooltip = document.querySelector(&#39;.tooltip&#39;);
    if (!tooltip) {
        tooltip = document.createElement(&#39;div&#39;);
        tooltip.className = &#39;tooltip&#39;;
        document.body.appendChild(tooltip);
    }
    
    // Préparer le texte à afficher en fonction des attributs disponibles
    let info = &#39;&#39;;
    const nom = img.dataset.nom;
    const strength = img.dataset.strength;
    const durability = img.dataset.durability;
    const life = img.dataset.life;
    const armor = img.dataset.armor;
    const prix = img.dataset.prix;
    const rare = img.dataset.rare;
    const money = img.dataset.money;
    
    if (nom !== undefined) info += &quot;Name: &quot; + nom + &quot;&lt;br&gt;&quot;;
    if (strength !== undefined) info += &quot;Strength: &quot; + strength + &quot;&lt;br&gt;&quot;;
    if (durability !== undefined) info += &quot;Durability: &quot; + durability + &quot;&lt;br&gt;&quot;;
    if (life !== undefined) info += &quot;Life: &quot; + life + &quot;&lt;br&gt;&quot;;
    if (armor !== undefined) info += &quot;Armor: &quot; + armor + &quot;&lt;br&gt;&quot;;
    if (prix !== undefined) info += &quot;Price: &quot; + prix + &quot;&lt;br&gt;&quot;;
    if (rare !== undefined) info += &quot;Rare: &quot; + rare + &quot;&lt;br&gt;&quot;;
    if (money !== undefined) info += &quot;Credits: &quot; + money + &quot;&lt;br&gt;&quot;;
    
    
    tooltip.innerHTML = info;
    tooltip.style.position = &#39;absolute&#39;;
    tooltip.style.top = (event.pageY + 10) + &#39;px&#39;;
    tooltip.style.left = (event.pageX + 10) + &#39;px&#39;;
    tooltip.style.backgroundColor = &#39;#fff&#39;;
    tooltip.style.border = &#39;1px solid #000&#39;;
    tooltip.style.padding = &#39;5px&#39;;
}

/* Fonction pour supprimer l&#39;infobulle */
function hideTooltip() {
    const tooltip = document.querySelector(&#39;.tooltip&#39;);
    if (tooltip) {
        tooltip.remove();
    }
}

/* Fonction pour afficher l&#39;inventaire */
function renderInventory(items) {
    const slots = document.querySelectorAll(&quot;.slot&quot;);

    // Réinitialisation des slots
    slots.forEach(slot =&gt; {
        slot.innerHTML = &quot;&quot;;
    });

    items.forEach(item =&gt; {
        if (item.inventory) {
            const slotIndex = parseInt(item.inventory) - 1;
            const slot = slots[slotIndex];

            if (slot) {
                const img = document.createElement(&quot;img&quot;);
                img.setAttribute(&quot;data-type&quot;, item.type);
                img.setAttribute(&quot;data-nom&quot;, item.nom); 
               
                if (item.strength !== undefined) {
                    img.setAttribute(&quot;data-strength&quot;, item.strength);
                }
                if (item.durability !== undefined) {
                    img.setAttribute(&quot;data-durability&quot;, item.durability);
                }
                if (item.life !== undefined) {
                    img.setAttribute(&quot;data-life&quot;, item.life);
                }
                 if (item.armor !== undefined) {
                    img.setAttribute(&quot;data-armor&quot;, item.armor);
                }
                  if (item.prix !== undefined) {
                    img.setAttribute(&quot;data-prix&quot;, item.prix);
                }
                  if (item.rare !== undefined) {
                    img.setAttribute(&quot;data-rare&quot;, item.rare);
                }
                   if (item.money !== undefined) {
                    img.setAttribute(&quot;data-money&quot;, item.money);
                }
                img.src = item.src;
                img.className = item.class;
                img.draggable = item.draggable;

                // Ajout des écouteurs d&#39;événements pour afficher/masquer l&#39;infobulle
                img.addEventListener(&#39;mouseover&#39;, (event) =&gt; showTooltip(event, img));
                img.addEventListener(&#39;mouseout&#39;, hideTooltip);

                slot.appendChild(img);
            }
        }
    });
}

/* Appel de la fonction pour afficher l&#39;inventaire */

&lt;/script&gt;</tw-passagedata><tw-passagedata pid="7" name="headerMACRO" tags="header" position="1575,525" size="100,100">{
&lt;head&gt;
&lt;link rel=&quot;icon&quot; type=&quot;image/x-icon&quot; href=&quot;https://pickyouruniverse.com/img/favicon.png&quot;&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no&quot;&gt;
&lt;link href=&quot;https://fonts.googleapis.com/css2?family=DM+Sans&amp;display=swap&quot; rel=&quot;stylesheet&quot;&gt;
&lt;meta charset=&quot;UTF-8&quot;&gt;
 &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css&quot;&gt;
&lt;/head&gt;
&lt;div class=&quot;game-interface&quot;&gt;
  &lt;nav class=&quot;top-nav&quot;&gt;
    &lt;div class=&quot;nav-buttons&quot;&gt;
          &lt;!--&lt;button class=&quot;nav-btn&quot; data-panel=&quot;maps&quot;&gt;Maps&lt;/button&gt;--&gt;
           &lt;button class=&quot;nav-btn&quot; data-panel=&quot;journal&quot;&gt;Journal&lt;/button&gt;
           &lt;button class=&quot;nav-btn&quot; data-panel=&quot;inventory&quot;&gt;Inventory&lt;/button&gt;
           &lt;button class=&quot;nav-btn&quot; data-panel=&quot;skills&quot;&gt;Character&lt;/button&gt;
    &lt;/div&gt;
  &lt;div class=&quot;progress-bar&quot;&gt;
  &lt;div class=&quot;health-bar&quot;&gt;
    &lt;div class=&quot;bar-fill&quot; id=&quot;bar-fill&quot;&gt;&lt;/div&gt;
    &lt;span class=&quot;bar-text&quot; id=&quot;bar-text&quot; data-max=&quot;$maxHealth&quot;&gt;$health/$maxHealth&lt;/span&gt;
  &lt;/div&gt;
  &lt;span class=&quot;money&quot;&gt;$money  &lt;i class=&quot;fas fa-coins&quot;&gt;&lt;/i&gt;&lt;/span&gt;
&lt;/div&gt;}
  &lt;/nav&gt;



{&lt;div id=&quot;maps-panel&quot; class=&quot;content-panel&quot;&gt;
  &lt;button class=&quot;close-btn&quot;&gt;×&lt;/button&gt;
  &lt;h2 style=&quot;color: #FFD700;  width: 50%;&quot;&gt;Maps&lt;/h2&gt;
  &lt;!-- Contenu de la carte --&gt;
          &lt;div class=&quot;blockinfoPerso&quot;&gt;
        &lt;div class=&quot;portrait&quot;&gt; &lt;img class=&quot;CharacterImg&quot; id=&quot;character-image&quot; src=&quot;&quot; alt=&quot;Character Image&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;portrait-description&quot;&gt;$journal&lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;}

{&lt;div id=&quot;journal-panel&quot; class=&quot;content-panel&quot;&gt;
  &lt;button class=&quot;close-btn&quot;&gt;×&lt;/button&gt;
  &lt;h2 style=&quot;color: #FFD700;  width: 50%;&quot;&gt;Journal&lt;/h2&gt;
  $journal
  &lt;!-- Contenu de la carte --&gt;
&lt;/div&gt;}




 {&lt;div id=&quot;inventory-panel&quot; class=&quot;content-panel&quot;&gt;
    &lt;button class=&quot;close-btn&quot;&gt;×&lt;/button&gt;
    &lt;h2 style=&quot;color: #FFD700;  width: 50%;&quot;&gt;Inventory&lt;/h2&gt;
    &lt;!-- Contenu Inentaire --&gt;
    
    &lt;div class=&quot;inventaireHaut&quot;&gt;
        &lt;div class=&quot;inventaireIngame&quot; data-type=&quot;any&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;inventaireIngame&quot; data-type=&quot;any&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;inventaireIngame&quot; data-type=&quot;any&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;inventaireIngame&quot; data-type=&quot;any&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;inventaireIngame&quot; data-type=&quot;any&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;inventaireIngame&quot; data-type=&quot;any&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;inventaireIngame&quot; data-type=&quot;any&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;inventaireIngame&quot; data-type=&quot;any&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;inventaireIngame&quot; data-type=&quot;any&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
            &lt;div class=&quot;paramBlock&quot;&gt;
                &lt;div class=&quot;zonesoin&quot; data-type=&quot;soin&quot; title=&quot;Put your potion&quot;&gt;💊&lt;/div&gt;
                &lt;div class=&quot;zonesuppression&quot; data-type=&quot;suppression&quot; title=&quot;Drag here to delete item&quot;&gt;🗑️&lt;/div&gt;
    &lt;/div&gt;

  &lt;div class=&quot;inventaireBas&quot;&gt;
        &lt;div class=&quot;special-armors&quot;&gt;
    	&lt;div class=&quot;details-armors&quot;&gt;
          &lt;div class=&quot;blockStatsArmures&quot;&gt;
            &lt;div class=&quot;statDegats&quot;&gt;
              &lt;span class=&quot;statDegatsInfo&quot;&gt;&lt;/span&gt;&lt;!--infos dammage--&gt;
            &lt;/div&gt;
            &lt;div class=&quot;statArmures&quot;&gt;
              &lt;span class=&quot;statArmuresInfo&quot;&gt;&lt;/span&gt;&lt;!--info armors--&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
       &lt;div class=&quot;blockEquipements&quot; id=&quot;equipements-section&quot;&gt;
        &lt;div class=&quot;igauche&quot;&gt;
          &lt;div class=&quot;iconArmors&quot; data-type=&quot;gloves&quot;&gt;
            &lt;img style=&quot;width: 60%;&quot; class=&quot;decorative-image&quot; src=&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/maininventaire.svg&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;iconArmors&quot; data-type=&quot;sword&quot;&gt;
            &lt;img style=&quot;width: 60%;&quot; class=&quot;decorative-image&quot; src=&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/epeeinventaire.svg&quot;&gt;
          &lt;/div&gt;
          &lt;button id=&quot;toggle-equipement&quot;&gt;&gt;&lt;/button&gt;
        &lt;/div&gt;
        &lt;div class=&quot;icentre&quot;&gt;
          &lt;div class=&quot;iconArmors&quot; data-type=&quot;helmet&quot;&gt;
            &lt;img style=&quot;width: 60%;&quot; class=&quot;decorative-image&quot; src=&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/helmetinventaire.svg&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;iconArmors&quot; data-type=&quot;armor&quot;&gt;
            &lt;img style=&quot;width: 60%;&quot; class=&quot;decorative-image&quot; src=&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/armorinventaire.svg&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;iconArmors&quot; data-type=&quot;boots&quot;&gt;
            &lt;img style=&quot;width: 60%;&quot; class=&quot;decorative-image&quot; src=&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/bootsinventaire.svg&quot;&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;idroite&quot;&gt;
          &lt;div class=&quot;iconArmors&quot; data-type=&quot;object&quot;&gt;
            &lt;img style=&quot;width: 60%;&quot; class=&quot;decorative-image&quot; src=&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/objetinventaire.svg&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;iconArmors&quot; data-type=&quot;object&quot;&gt;
            &lt;img style=&quot;width: 60%;&quot; class=&quot;decorative-image&quot; src=&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/objetinventaire.svg&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;iconArmors&quot;&gt;
            &lt;i class=&quot;fas fa-coins argentequipements&quot; data-raw=&quot;&quot;&gt;$money&lt;/i&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;!-- Section alternative avec l&#39;image d’armure complète --&gt;
      &lt;div id=&quot;equipement-image&quot; style=&quot;display: none; text-align: center;&quot;&gt;
        &lt;img style=&quot;width: 60%;&quot; class=&quot;decorative-image&quot; src=&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Combats/PersoCombat.png&quot;&gt;
                  &lt;button id=&quot;retour-equipement&quot;&gt;&gt;&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
		
        &lt;div class=&quot;rangementcotedroit&quot;&gt;
          &lt;div class=&quot;inventory-grid&quot;&gt;
              &lt;!-- 24 emplacements d&#39;inventaire --&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-1&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-2&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-3&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-4&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-5&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-6&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-7&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-8&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-9&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-10&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-11&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-12&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-13&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-14&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-15&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-16&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-17&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-18&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-19&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-20&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-21&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-22&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-23&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;slot&quot; data-type=&quot;any&quot; id=&quot;slot-24&quot;&gt;&lt;/div&gt;

		&lt;/div&gt;

		&lt;div class=&quot;RAInventaire&quot;&gt;
              &lt;label class=&quot;toggle&quot;&gt;
              &lt;input type=&quot;checkbox&quot;&gt;
              &lt;span class=&quot;slider&quot;&gt;&lt;/span&gt;
              &lt;/label&gt;
              &lt;span class=&quot;label-text&quot;&gt;Automatic storage&lt;/span&gt;
              &lt;/div&gt;
          &lt;/div&gt;
    &lt;/div&gt;}
&lt;/div&gt;
 
 
 
 

{&lt;div id=&quot;skills-panel&quot; class=&quot;content-panel&quot;&gt;
    &lt;button class=&quot;close-btn&quot;&gt;×&lt;/button&gt;
    &lt;h2 style=&quot;color: #FFD700&quot;&gt;Character&lt;/h2&gt;
    &lt;!-- Contenu Character --&gt;
    &lt;div class=&quot;blockcarapter&quot;&gt;
        &lt;div class=&quot;character-details&quot;&gt;
        &lt;table class=&quot;tableinfoscaracter&quot;&gt;
            &lt;tr&gt;
            &lt;td class=&quot;bold-yellow&quot;&gt;$heroName&lt;/td&gt;
            &lt;td class=&quot;bold-white&quot;  id=&quot;verificationjob&quot;&gt;$jobname&lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr&gt;
            &lt;td class=&quot;bold-white&quot;&gt;Male&lt;/td&gt;
            &lt;td class=&quot;bold-white&quot;&gt;32 Year Old&lt;/td&gt;
            &lt;/tr&gt;
        &lt;/table&gt;
        &lt;/div&gt;
        &lt;div class=&quot;blockinfoPerso&quot;&gt;
        &lt;div class=&quot;portrait&quot;&gt; &lt;img class=&quot;CharacterImg&quot; id=&quot;character-image&quot; src=&quot;&quot; alt=&quot;Character Image&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;portrait-description&quot;&gt;$description&lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;stats-container&quot;&gt;
        &lt;div class=&quot;stat-group&quot;&gt;
        &lt;div class=&quot;stat-controls&quot;&gt;
            &lt;button class=&quot;stat-btn&quot; onclick=&quot;adjustStat(&#39;strength&#39;, -1)&quot;&gt;-&lt;/button&gt;
            &lt;div class=&quot;stat-value&quot; id=&quot;strength-value&quot;&gt;$basestrength&lt;/div&gt;
            &lt;span class=&quot;bonus-text&quot; id=&quot;bonus-strength&quot;&gt;&lt;/span&gt;
            &lt;button class=&quot;stat-btn&quot; onclick=&quot;adjustStat(&#39;strength&#39;, 1)&quot;&gt;+&lt;/button&gt;
        &lt;/div&gt;
        &lt;span class=&quot;stat-name&quot;&gt;Strength&lt;/span&gt;
        &lt;/div&gt;

        &lt;div class=&quot;stat-group&quot;&gt;
        &lt;div class=&quot;stat-controls&quot;&gt;
            &lt;button class=&quot;stat-btn&quot; onclick=&quot;adjustStat(&#39;luck&#39;, -1)&quot;&gt;-&lt;/button&gt;
            &lt;div class=&quot;stat-value&quot; id=&quot;luck-value&quot;&gt;$baseluck&lt;/div&gt;
            &lt;span class=&quot;bonus-text&quot; id=&quot;bonus-luck&quot;&gt;&lt;/span&gt;
            &lt;button class=&quot;stat-btn&quot; onclick=&quot;adjustStat(&#39;luck&#39;, 1)&quot;&gt;+&lt;/button&gt;
        &lt;/div&gt;
        &lt;span class=&quot;stat-name&quot;&gt;luck&lt;/span&gt;
        &lt;/div&gt;

        &lt;div class=&quot;stat-group&quot;&gt;
        &lt;div class=&quot;stat-controls&quot;&gt;
            &lt;button class=&quot;stat-btn&quot; onclick=&quot;adjustStat(&#39;intelligence&#39;, -1)&quot;&gt;-&lt;/button&gt;
            &lt;div class=&quot;stat-value&quot; id=&quot;intelligence-value&quot;&gt;$baseintelligence&lt;/div&gt;
            &lt;span class=&quot;bonus-text&quot; id=&quot;bonus-intelligence&quot;&gt;&lt;/span&gt;
            &lt;button class=&quot;stat-btn&quot; onclick=&quot;adjustStat(&#39;intelligence&#39;, 1)&quot;&gt;+&lt;/button&gt;
        &lt;/div&gt;
        &lt;span class=&quot;stat-name&quot;&gt;Intelligence&lt;/span&gt;
        &lt;/div&gt;

        &lt;div class=&quot;stat-group&quot;&gt;
        &lt;div class=&quot;stat-controls&quot;&gt;
            &lt;button class=&quot;stat-btn&quot; onclick=&quot;adjustStat(&#39;charisma&#39;, -1)&quot;&gt;-&lt;/button&gt;
            &lt;div class=&quot;stat-value&quot; id=&quot;charisma-value&quot;&gt;$basecharisma&lt;/div&gt;
            &lt;span class=&quot;bonus-text&quot; id=&quot;bonus-charisma&quot;&gt;&lt;/span&gt;
            &lt;button class=&quot;stat-btn&quot; onclick=&quot;adjustStat(&#39;charisma&#39;, 1)&quot;&gt;+&lt;/button&gt;
        &lt;/div&gt;
        &lt;span class=&quot;stat-name&quot;&gt;Charisma&lt;/span&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;points-remaining&quot;&gt;
        
Remaining points : &lt;span class=&quot;points-value&quot; id=&quot;points-remaining&quot;&gt;$pointExp&lt;/span&gt;
    &lt;/div&gt;
&lt;/div&gt;}

{&lt;div id=&quot;options-panel&quot; class=&quot;content-panel&quot;&gt;
    &lt;button class=&quot;close-btn&quot;&gt;×&lt;/button&gt;
    &lt;h2 style=&quot;color: #FFD700;  width: 50%;&quot;&gt;Settings&lt;/h2&gt;
    &lt;!-- Contenu des options --&gt;
&lt;div class=&quot;conteneur-options&quot;&gt;
    &lt;!-- Section Gauche : Audio --&gt;
    &lt;section class=&quot;options-audio&quot;&gt;
      &lt;div class=&quot;option-item&quot;&gt;
        &lt;label for=&quot;activer-musique&quot;&gt;Music&lt;/label&gt;
        &lt;input type=&quot;checkbox&quot; id=&quot;activer-musique&quot; checked&gt;
      &lt;/div&gt;

      &lt;div class=&quot;option-item-son&quot;&gt;
        &lt;input type=&quot;range&quot; id=&quot;volume-son&quot; min=&quot;0&quot; max=&quot;100&quot; value=&quot;50&quot;&gt;
      &lt;/div&gt;
      
&lt;div class=&quot;option-item&quot;&gt;
  &lt;label for=&quot;activateMarchandMusic&quot;&gt;Marchand Music&lt;/label&gt;
  &lt;input type=&quot;checkbox&quot; id=&quot;activateMarchandMusic&quot; checked&gt;
&lt;/div&gt;


&lt;div class=&quot;option-item-son&quot;&gt;
  &lt;input type=&quot;range&quot; id=&quot;volume-marchand-music&quot; min=&quot;0&quot; max=&quot;100&quot; value=&quot;70&quot;&gt;
&lt;/div&gt;
      
&lt;div class=&quot;option-item&quot;&gt;
  &lt;label for=&quot;dr-toggle&quot;&gt;Dice Role&lt;/label&gt;
  &lt;input type=&quot;checkbox&quot; id=&quot;activateDice&quot; checked&gt;
&lt;/div&gt;

    &lt;/section&gt;

        &lt;!-- Séparateur --&gt;
        &lt;div class=&quot;separateur&quot;&gt;&lt;/div&gt;

        &lt;!-- Section Droite : Langue et Sauvegarde --&gt;
&lt;section class=&quot;options-jeu&quot;&gt;
      &lt;div class=&quot;option-item&quot;&gt;
        &lt;label for=&quot;sfx-toggle&quot;&gt;SFX&lt;/label&gt;
        &lt;input type=&quot;checkbox&quot; id=&quot;sfx-toggle&quot; checked&gt;
      &lt;/div&gt;

      &lt;div class=&quot;option-item-son&quot;&gt;
        &lt;input type=&quot;range&quot; id=&quot;volume-sfx&quot; min=&quot;0&quot; max=&quot;100&quot; value=&quot;50&quot;&gt;
      &lt;/div&gt;
      
       &lt;div class=&quot;option-item&quot;&gt;
        &lt;label for=&quot;combat-music-toggle&quot;&gt;Combat Music&lt;/label&gt;
        &lt;input type=&quot;checkbox&quot; id=&quot;combat-music-toggle&quot; checked&gt;
      &lt;/div&gt;

      &lt;div class=&quot;option-item-son&quot;&gt;
        &lt;input type=&quot;range&quot; id=&quot;volume-combat-music&quot; min=&quot;0&quot; max=&quot;100&quot; value=&quot;70&quot;&gt;
      &lt;/div&gt;

      
      &lt;div class=&quot;option-item&quot;&gt;
      &lt;label for=&quot;rf-toggle&quot;&gt;Dice Role Fight&lt;/label&gt;
      &lt;input type=&quot;checkbox&quot; id=&quot;activateDiceFight&quot; checked&gt;
    &lt;/div&gt;
      &lt;!-- Interface utilisateur --&gt;
    &lt;/section&gt;
  &lt;/div&gt;
      
    &lt;div class=&quot;panel-footer&quot;&gt;       
          &lt;div class=&quot;option-item&quot;&gt;
          &lt;button id=&quot;reset-progress&quot; onclick=&quot;resetLocalStorage()&quot; class=&quot;boutonResetLocalSt&quot;&gt;
            Reset All Progress
          &lt;/button&gt;
      &lt;/div&gt;

          &lt;div class=&quot;autreParametre&quot;&gt;
          
                         &lt;div class=&quot;blockParametre&quot; style=&quot;gap: 70px;&quot;&gt;    
                   (link: &quot;Save game&quot;)[
                      (if: (save-game: &quot;Slot A&quot;))[
                        Game saved!
                        ](else: )[
                        Sorry, I couldn&#39;t save your game.
                        ]
                      ]
                      (if: (saved-games:) contains &quot;Slot A&quot;)[
                      (link: &quot;Load game&quot;)[
                        (load-game: &quot;Slot A&quot;)
                        ]
                      ]                     
                      &lt;/div&gt;
                      &lt;div class=&quot;blockParametreBas&quot;&gt;   
                         &lt;a class=&quot;lienSite&quot; href=&quot;https://pickyouruniverse.com/index.php&quot; class=&quot;btn&quot;&gt;Website&lt;/a&gt;
                      &lt;div class=&quot;blockParametre&quot;&gt;[[credits]]&lt;/div&gt;
                      &lt;/div&gt;
                &lt;/div&gt;
      &lt;/div&gt;
&lt;/div&gt;}

&lt;/div&gt;
&lt;script&gt;
//!Barre de vie
(function () {
  const barText = document.getElementById(&quot;bar-text&quot;);

  const observer = new MutationObserver(() =&gt; {
    observer.disconnect(); 
    refreshHealth();      
    observer.observe(barText, config); 
  });

  const config = {
    childList: true,
    characterData: true,
    subtree: true
  };

  observer.observe(barText, config);

  function refreshHealth() {
    updateHealthBar();
  }

  function updateHealthBar() {
    const barFill = document.getElementById(&quot;bar-fill&quot;);

    const [currentHealth, maxHealth] = barText.textContent.split(&#39;/&#39;).map(Number);
    if (isNaN(currentHealth) || isNaN(maxHealth)) return;

    const percentage = (currentHealth / maxHealth) * 100;
    barFill.style.width = percentage + &quot;%&quot;;
    barText.textContent = `${currentHealth}/${maxHealth}`; // &lt;- ici, sans ça on évite la boucle

    // Mise à jour du style différée
    setTimeout(() =&gt; {
      if (percentage &gt;= 80) {
        barFill.style.background = &quot;linear-gradient(90deg, #44ff44 0%, #44ff8f 100%)&quot;;
      } else if (percentage &gt;= 40) {
        barFill.style.background = &quot;linear-gradient(90deg, #ffaa44 0%, #ffdd44 100%)&quot;;
      } else {
        barFill.style.background = &quot;linear-gradient(90deg, #ff4444 0%, #ff8f44 100%)&quot;;
      }
    }, 10);
  }

  // Fonction publique si besoin de mise à jour manuelle
  window.updateHealth = function(newHealth, newMax) {
    if (newMax !== undefined) {
      barText.textContent = `${newHealth}/${newMax}`;
    } else {
      const [, max] = barText.textContent.split(&#39;/&#39;).map(Number);
      barText.textContent = `${newHealth}/${max}`;
    }
  };
})();


//!FIN Barre de vie
//!--------------------------------------------------------------------------------------------
//!!Menu Option 
window.$skillCheckEnable = true;
window.$skillCheckEnableFight = true;
window.sfxEnabled = true;
window.combatMusicEnabled = true;
window.marchandMusicEnabled = true;
window.backgroundMusicEnabled = true;
window.sfxVolume = 0.5;
window.combatMusicVolume = 0.7;
window.marchandMusicVolume = 0.7; 

function applyOptionById(id, value) {
    switch(id) {
        case &#39;activateDice&#39;:
            window.$skillCheckEnable = value;
            break;
        case &#39;activateDiceFight&#39;:
            window.$skillCheckEnableFight = value;
            break;
        case &#39;sfx-toggle&#39;:
            window.sfxEnabled = value;
            break;
        case &#39;combat-music-toggle&#39;:
            window.combatMusicEnabled = value;
            if (!value &amp;&amp; window.musiqueCombats) window.musiqueCombats.pause();
            break;
        case &#39;activer-musique&#39;:
            window.backgroundMusicEnabled = value;
            if (value) {
                window.musiqueDeFond?.play().catch(err =&gt; console.warn(&quot;Lecture musique bloquée&quot;, err));
            } else {
                window.musiqueDeFond?.pause();
            }
            break;
              case &#39;activateMarchandMusic&#39;:
            window.marchandMusicEnabled = value;
              if (!value &amp;&amp; window.marchandMusicEnabled) window.musiqueMarchand.pause();
    }
}

// 🔧 Gestion sliders (volume)
function applyVolumeById(id, value) {
    const volume = value / 100;
    switch(id) {
        case &#39;volume-son&#39;:
            if (window.musiqueDeFond) window.musiqueDeFond.volume = volume;
            break;
        case &#39;volume-sfx&#39;:
            window.sfxVolume = volume;
            break;
        case &#39;volume-combat-music&#39;:
            window.combatMusicVolume = volume;
            if (window.musiqueCombats) window.musiqueCombats.volume = volume;
            break;
         case &#39;volume-marchand-music&#39;:
            window.marchandMusicVolume = volume;
            if (window.musiqueMarchand) window.musiqueMarchand.volume = volume;
            break;
    }
}

// ✅ Initialisation options
function setupOptionPersistence() {
    // 🟢 Checkboxes
    document.querySelectorAll(&#39;input[type=&quot;checkbox&quot;]&#39;).forEach(input =&gt; {
        const id = input.id;
        if (!id) return;

        const saved = localStorage.getItem(`option-${id}`);
        if (saved !== null) input.checked = saved === &#39;true&#39;;

        applyOptionById(id, input.checked); // Applique au chargement

        input.addEventListener(&#39;change&#39;, () =&gt; {
            localStorage.setItem(`option-${id}`, input.checked);
            console.log(`💾 [Option] ${id} = ${input.checked}`);
            applyOptionById(id, input.checked);
        });
    });

    // 🎚️ Sliders
    document.querySelectorAll(&#39;input[type=&quot;range&quot;]&#39;).forEach(input =&gt; {
        const id = input.id;
        if (!id) return;

        const saved = localStorage.getItem(`option-${id}`);
        if (saved !== null) {
            input.value = saved;
            applyVolumeById(id, input.value);
        }

        input.addEventListener(&#39;input&#39;, () =&gt; {
            localStorage.setItem(`option-${id}`, input.value);
            console.log(`💾 [Slider] ${id} = ${input.value}`);
            applyVolumeById(id, input.value);
        });
    });
}

// 🚀 Lancer l’init au chargement de la page
window.addEventListener(&quot;load&quot;, () =&gt; {
    setupOptionPersistence();
});
//fin save localstorage

// Fonction de réinitialisation
window.resetLocalStorage = function() {
    const confirmation = confirm(&quot;WARNING: This will permanently reset ALL your progress!\n\n- All items will be deleted\n- Experience points will reset to 0\n- Current health will be reset\n\nAre you absolutely sure?&quot;);
    
    if (confirmation) {
        localStorage.clear();
        location.reload(); 
        alert(&quot;All data has been reset. The game will now reload.&quot;);
    }
};
    //!?Menu InGames
  (function() {
  
  window.sfxEnabled = true;
 window.sfxVolume = 0.5;

	// Gestion du toggle SFX
  document.querySelector(&#39;#sfx-toggle&#39;).addEventListener(&#39;change&#39;, function(e) {
    window.sfxEnabled = e.target.checked;
  });
  
  document.getElementById(&quot;volume-sfx&quot;).addEventListener(&quot;input&quot;, function() {
    window.sfxVolume = this.value / 100;
    console.log(&quot;Volume des SFX : &quot; + this.value);
});
    var draggables;
    var containers;
    var autoStorageCheckbox;

    // Fonction d&#39;initialisation à appeler après le chargement du passage
    window.initializeGameInterface = function() {
        setupSkillButtons();
        setupInGameMenu();
        setupInventory();
        synchronizeInventories(); 
        setupOptionPersistence();
    };
    
    function setupSkillButtons() {
        document.querySelectorAll(&#39;.circle-btn&#39;).forEach(function(btn) {
            var skillName = btn.getAttribute(&#39;data-skill&#39;);
            var initialText = btn.textContent;

            btn.addEventListener(&#39;mouseover&#39;, function() {
                btn.textContent = skillName;
            });

            btn.addEventListener(&#39;mouseout&#39;, function() {
                btn.textContent = initialText;
            });
        });
    }

    function setupInGameMenu() {
        var navButtons = document.querySelectorAll(&#39;.nav-btn, .option-btn&#39;);
        var panels = document.querySelectorAll(&#39;.content-panel&#39;);
        var closeButtons = document.querySelectorAll(&#39;.close-btn&#39;);

        function closeAllPanels() {
            panels.forEach(function(panel) {
                panel.classList.remove(&#39;active&#39;);
            });
            navButtons.forEach(function(btn) {
                btn.classList.remove(&#39;active&#39;);
            });
        }

        navButtons.forEach(function(btn) {
            btn.addEventListener(&#39;click&#39;, function() {
                var panelName = btn.getAttribute(&#39;data-panel&#39;);
                var panel = document.getElementById(panelName + &#39;-panel&#39;);
                
                if (panel.classList.contains(&#39;active&#39;)) {
                    closeAllPanels();
                } else {
                    closeAllPanels();
                    panel.classList.add(&#39;active&#39;);
                    btn.classList.add(&#39;active&#39;);
                }
            });
        });

        closeButtons.forEach(function(btn) {
            btn.addEventListener(&#39;click&#39;, closeAllPanels);
        });
    }
    //!?FIN Menu InGames
    
   // Vérifier si l&#39;audio existe déjà pour éviter de le recréer
     const musiques = [
    &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/musique/General.wav&quot;,
    &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/musique/SpaceshipAccident(1).mp3&quot;
  ];
  
function choisirMusiqueSuivante(actuelle) {
  let suivante;
  do {
    suivante = musiques[Math.floor(Math.random() * musiques.length)];
  } while (suivante === actuelle);
  return suivante;
}
    
if (!window.musiqueDeFond) {
  let musiqueActuelle = musiques[Math.floor(Math.random() * musiques.length)];
  window.musiqueDeFond = new Audio(musiqueActuelle);
  window.musiqueDeFond.volume = 0.5;

  // Quand la musique se termine, on en joue une autre aléatoire
  window.musiqueDeFond.addEventListener(&quot;ended&quot;, function () {
    musiqueActuelle = choisirMusiqueSuivante(musiqueActuelle);
    window.musiqueDeFond.src = musiqueActuelle;
    window.musiqueDeFond.play().catch(err =&gt; console.log(&quot;Lecture auto bloquée&quot;, err));
  });

  window.musiqueDeFond.play().catch(err =&gt; console.log(&quot;Lecture auto bloquée&quot;, err));
}

// Gérer l&#39;activation de la musique
document.getElementById(&quot;activer-musique&quot;).addEventListener(&quot;change&quot;, function() {
    if (this.checked) {
        window.musiqueDeFond.play().catch(error =&gt; console.log(&quot;Lecture auto bloquée, interaction requise&quot;));
        console.log(&quot;Musique activée 🎵&quot;);
    } else {
        window.musiqueDeFond.pause();
        console.log(&quot;Musique désactivée 🔇&quot;);
    }
});

// Gérer le changement de volume
document.getElementById(&quot;volume-son&quot;).addEventListener(&quot;input&quot;, function() {
    window.musiqueDeFond.volume = this.value / 100; // Le volume doit être compris entre 0 et 1
    console.log(&quot;Volume des sons : &quot; + this.value);
});

// Ajout d&#39;une fonction pour changer la musique si besoin
window.changerMusique = function(nouvelleMusique) {
    if (window.musiqueDeFond.src !== nouvelleMusique) {
        window.musiqueDeFond.pause();
        window.musiqueDeFond.src = nouvelleMusique;
        window.musiqueDeFond.play().catch(error =&gt; console.log(&quot;Lecture auto bloquée, interaction requise&quot;));
    }
};

//!!Fin Menu Option 
//!--------------------------------------------------------------------------------------------
//!!Menu Caractère
    // Récupération du texte affiché dans le &lt;td id=&quot;verificationjob&quot;&gt;
    let jobname = document.getElementById(&quot;verificationjob&quot;).textContent.trim();

    // Associe les métiers à leurs images
let jobImages = {
    &quot;Gravebinder&quot;: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/GraveBinder.png&quot;,
    &quot;Lantern Bearer&quot;: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Lantern.png&quot;,
    &quot;Ossuary Knight&quot;: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Knight.png&quot;,
    &quot;Whispered&quot;: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Whispered.png&quot;,
    &quot;Pale Scholar&quot;: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Scholar.png&quot;,
    &quot;Exhumed&quot;: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Exhumed.png&quot;,
    &quot;God&quot;: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/God.png&quot;
};


    // Vérifie si le métier correspond à une image et met à jour
    if (jobImages[jobname]) {
        document.getElementById(&quot;character-image&quot;).src = jobImages[jobname];
    }


(function () {
    // Initialisation sécurisée des variables Harlowe dans JS
    if (typeof $strength !== &quot;number&quot;) $strength = 10;
    if (typeof $intelligence !== &quot;number&quot;) $intelligence = 10;
    if (typeof $luck !== &quot;number&quot;) $luck = 10;
    if (typeof $charisma !== &quot;number&quot;) $charisma = 10;
    if (typeof $pointExp !== &quot;number&quot;) $pointExp = 5;

    let baseStats = {
        strength: typeof $basestrength === &quot;number&quot; ? $basestrength : $strength,
        intelligence: typeof $baseintelligence === &quot;number&quot; ? $baseintelligence : $intelligence,
        luck: typeof $baseluck === &quot;number&quot; ? $baseluck : $luck,
        charisma: typeof $basecharisma === &quot;number&quot; ? $basecharisma : $charisma
    };

    let stats = {
        strength: $strength,
        intelligence: $intelligence,
        luck: $luck,
        charisma: $charisma
    };

    let pointsRemaining = $pointExp;
    const maxStatValue = 30;

    function updateStatDisplay(stat) {
        const el = document.getElementById(`${stat}-value`);
        if (el) el.textContent = stats[stat];
    }

    function updateAllStatDisplays() {
        Object.keys(stats).forEach(updateStatDisplay);
    }

    function updatePointsRemainingDisplay() {
        const el = document.getElementById(&#39;points-remaining&#39;);
        if (el) el.textContent = pointsRemaining;
    }

    function updateButtons() {
        Object.keys(stats).forEach(stat =&gt; {
            const btnDecrease = document.querySelector(`button[onclick=&quot;adjustStat(&#39;${stat}&#39;, -1)&quot;]`);
            const btnIncrease = document.querySelector(`button[onclick=&quot;adjustStat(&#39;${stat}&#39;, 1)&quot;]`);

            if (btnDecrease) btnDecrease.disabled = stats[stat] &lt;= baseStats[stat];
            if (btnIncrease) btnIncrease.disabled = stats[stat] &gt;= maxStatValue || pointsRemaining &lt;= 0;
        });
    }

    window.adjustStat = function (stat, change) {
        let newValue = stats[stat] + change;

        if (change &gt; 0 &amp;&amp; pointsRemaining &gt; 0 &amp;&amp; newValue &lt;= maxStatValue) {
            stats[stat] = newValue;
            pointsRemaining -= change;
        } else if (change &lt; 0 &amp;&amp; newValue &gt;= baseStats[stat]) {
            stats[stat] = newValue;
            pointsRemaining -= change;
        } else {
            return; // invalide : ne rien faire
        }

        updateStatDisplay(stat);
        updatePointsRemainingDisplay();
        updateButtons();

        // Mise à jour DES variables Harlowe directement (clé de la synchro)
        $strength = stats.strength;
        $intelligence = stats.intelligence;
        $luck = stats.luck;
        $charisma = stats.charisma;
        $pointExp = pointsRemaining;

        // Ta fonction custom si elle existe
        if (typeof mettreAJourStatsDepuisObjetsEquipes === &quot;function&quot;) {
            mettreAJourStatsDepuisObjetsEquipes();
        }
    };

    // Fonction pour charger les variables Harlowe dans JS (à appeler après load-game)
    window.loadCharacterStateFromHarlowe = function() {
        stats.strength = $strength;
        stats.intelligence = $intelligence;
        stats.luck = $luck;
        stats.charisma = $charisma;
        pointsRemaining = $pointExp;

        updateAllStatDisplays();
        updatePointsRemainingDisplay();
        updateButtons();
    };

    // Initialisation à la création (chargement des valeurs depuis Harlowe)
    window.loadCharacterStateFromHarlowe();

    // Fonctions publiques utiles
    window.getPointsRemaining = () =&gt; pointsRemaining;
    window.setPointsRemaining = function (points) {
        pointsRemaining = points;
        $pointExp = pointsRemaining;
        updatePointsRemainingDisplay();
        updateButtons();
    };
})();

//!!Fin Menu Carapter
//!--------------------------------------------------------------------------------------------
//!!Menu Inventaire 

//!Affichage Armure complet / equipements 
  document.getElementById(&quot;toggle-equipement&quot;).addEventListener(&quot;click&quot;, function () {
    document.getElementById(&quot;equipements-section&quot;).style.display = &quot;none&quot;;
    document.getElementById(&quot;equipement-image&quot;).style.display = &quot;block&quot;;
  });

  document.getElementById(&quot;retour-equipement&quot;).addEventListener(&quot;click&quot;, function () {
    document.getElementById(&quot;equipements-section&quot;).style.display = &quot;flex&quot;; 
    document.getElementById(&quot;equipement-image&quot;).style.display = &quot;none&quot;;
  });
 //!FIN Affichage Armure complet / equipements 
//! Initialisation de l&#39;inventaire 
function setupInventory() {
    draggables = document.querySelectorAll(&#39;.item-img&#39;);
    containers = document.querySelectorAll(&#39;.slot, .inventaireIngame, .iconArmors&#39;);
    autoStorageCheckbox = document.querySelector(&#39;.toggle input[type=&quot;checkbox&quot;]&#39;);

    if (autoStorageCheckbox) {
        autoStorageCheckbox.addEventListener(&#39;change&#39;, autoArrangeItems);
    }
setupDragAndDrop();
loadInventories();
}
//! Fin Initialisation de l&#39;inventaire 

//!génération des inventaires
  function generateSlots() {
    const chest1 = document.getElementById(&#39;chest1&#39;);
    const chestInventory = document.getElementById(&#39;chestInventory&#39;);
 
    if (chest1) {
        for (let i = 1; i &lt;= 24; i++) {
            const slot = document.createElement(&#39;div&#39;);
            slot.className = &#39;slotChest&#39;;
            slot.dataset.slot = i.toString();
            chest1.appendChild(slot);
        }
    }
    
          if (chestInventory) {
        for (let i = 1; i &lt;= 24; i++) {
            const slot = document.createElement(&#39;div&#39;);
            slot.className = &#39;slotChest&#39;;
            slot.dataset.slot = i.toString();
            chestInventory.appendChild(slot);
        }
    }
    
    }
    generateSlots();
//!Fin génération des inventaires

//! FIN Masquer l&#39;image décorative quand objet équipé


//Affichage total bonus Equipements
function updateStatsFromEquipment() {
    let totalStrength = 0;
    let totalArmor = 0;

    // Parcourt tous les équipements pour accumuler les stats
    document.querySelectorAll(&#39;.special-armors .iconArmors&#39;).forEach(slot =&gt; {
        const item = slot.querySelector(&#39;.item-img&#39;);
        if (item) {
            totalStrength += parseInt(item.getAttribute(&#39;data-strength&#39;)) || 0;
            totalArmor += parseInt(item.getAttribute(&#39;data-armor&#39;)) || 0;
        }
    });

    // Appliquer la force aux dégâts (exemple : 1 Strength = +2 Dégâts)
    let totalDegats = totalStrength; 

    // Mise à jour de l&#39;affichage des stats
    document.querySelector(&#39;.statDegatsInfo&#39;).textContent = `Strength : ${totalStrength}`;
    document.querySelector(&#39;.statArmuresInfo&#39;).textContent = `Armor : ${totalArmor}`;
}

// Observer les changements dans les équipements
document.querySelectorAll(&#39;.special-armors .iconArmors&#39;).forEach(slot =&gt; {
    const observer = new MutationObserver(mutations =&gt; {
        mutations.forEach(mutation =&gt; {
            if (mutation.type === &quot;childList&quot;) {
                const hasItem = slot.querySelector(&#39;.item-img&#39;);
                const decorativeImage = slot.querySelector(&#39;.decorative-image&#39;);
                
                if (!hasItem &amp;&amp; decorativeImage) {
                    decorativeImage.style.display = &#39;block&#39;; // Réafficher l&#39;image déco
                }
            }
        });
        mettreAJourStatsDepuisObjetsEquipes()
        updateStatsFromEquipment();
    });
    observer.observe(slot, { childList: true });
});
// Met à jour les stats au chargement
mettreAJourStatsDepuisObjetsEquipes()
updateStatsFromEquipment();
//FIN Affichage total bonus Equipements


//! Chargement des sauvegarde local des inventaires 
    function loadInventories() {
        var sidebarData = JSON.parse(localStorage.getItem(&#39;sidebarInventory&#39;));
        var ingameData = JSON.parse(localStorage.getItem(&#39;ingameInventory&#39;));
        var specialArmorData = JSON.parse(localStorage.getItem(&#39;specialArmorInventory&#39;));
        var inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;));

        if (sidebarData &amp;&amp; ingameData &amp;&amp; specialArmorData &amp;&amp; inventoryGridData) {
            var sidebarSlots = document.querySelectorAll(&#39;.inventory-slot&#39;);
            var ingameSlots = document.querySelectorAll(&#39;.inventaireIngame&#39;);
            var specialArmorSlots = document.querySelectorAll(&#39;.special-armors .iconArmors&#39;);
            var inventoryGridSlots = document.querySelectorAll(&#39;.inventory-grid .slot&#39;);

            sidebarData.forEach(function(item, index) {
                if (item &amp;&amp; sidebarSlots[index]) {
                    sidebarSlots[index].appendChild(createItem(
                        item.type,
                        item.src,
                        item.id,
                        item.nom,
                        item.strength,
                        item.intelligence,
                        item.luck,
                    	item.charisma,
                        item.durability,
                        item.life,
                        item.armor,
                        item.prix,
                        item.rare,
                        item.money,
                    ));
                }
            });

            ingameData.forEach(function(item, index) {
                if (item &amp;&amp; ingameSlots[index]) {
                    ingameSlots[index].appendChild(createItem(
                        item.type,
                        item.src,
                        item.id,
                        item.nom,
                        item.strength,
                        item.intelligence,
                        item.luck,
                    	item.charisma,
                        item.durability,
                        item.life,
                        item.armor,
                        item.prix,
                        item.rare,
                        item.money,
                    ));
                }
            });

            if (specialArmorData) {
                specialArmorSlots.forEach((slot, index) =&gt; {
                    if (specialArmorData[index]) {
                        slot.appendChild(createItem(
                            specialArmorData[index].type,
                            specialArmorData[index].src,
                            specialArmorData[index].id,
                            specialArmorData[index].nom,
                            specialArmorData[index].strength,
                            specialArmorData[index].intelligence,
                       		specialArmorData[index].luck,
                    		specialArmorData[index].charisma,
                            specialArmorData[index].durability,
                            specialArmorData[index].life,
                            specialArmorData[index].armor,
                            specialArmorData[index].prix,
                            specialArmorData[index].rare,
                            specialArmorData[index].money,
                        ));
                    }
                });
            }

            if (inventoryGridData) {
                inventoryGridSlots.forEach((slot, index) =&gt; {
                    if (inventoryGridData[index]) {
                        slot.appendChild(createItem(
                            inventoryGridData[index].type,
                            inventoryGridData[index].src,
                            inventoryGridData[index].id,
                            inventoryGridData[index].nom,
                            inventoryGridData[index].strength,
                            inventoryGridData[index].intelligence,
                       		inventoryGridData[index].luck,
                    		inventoryGridData[index].charisma,
                            inventoryGridData[index].durability,
                            inventoryGridData[index].life,
                            inventoryGridData[index].armor,
                            inventoryGridData[index].prix,
                            inventoryGridData[index].rare,
                            inventoryGridData[index].money,
                        ));
                    }
                });
            }
            
        }
    }
//! Fin Chargement des sauvegarde local de inventaires 

//! Rangement automatique 
    function autoArrangeItems() {
        if (!autoStorageCheckbox || !autoStorageCheckbox.checked) return;

        var items = document.querySelectorAll(&#39;.slot .item-img&#39;);
        var slots = document.querySelectorAll(&#39;.slot&#39;);
        var itemsByType = {};

        items.forEach(function(item) {
            var type = item.getAttribute(&#39;data-type&#39;);
            if (!itemsByType[type]) {
                itemsByType[type] = [];
            }
            itemsByType[type].push(item);
        });

        slots.forEach(function(slot) {
            if (slot.children.length &gt; 0) {
                slot.innerHTML = &#39;&#39;;
            }
            synchronizeInventories();
        });

        var currentSlotIndex = 0;
        Object.keys(itemsByType).forEach(function(type) {
            itemsByType[type].forEach(function(item) {
                while (currentSlotIndex &lt; slots.length) {
                    var slot = slots[currentSlotIndex];
                    if (slot.children.length === 0) {
                        slot.appendChild(item);
                        currentSlotIndex++;
                        break;
                    }
                    currentSlotIndex++;
                }
            });
        });
         if (window.sfxEnabled) {
    let sfxAudio = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/rangement.wav&quot;);
    sfxAudio.volume = window.sfxVolume;
    sfxAudio.play();
}
        synchronizeInventories();
    }
//! Fin Rangement automatique 
  
//! Gestion du glisser-déposer 
    function setupDragAndDrop() {
        draggables.forEach(function(draggable) {
            draggable.addEventListener(&#39;mousedown&#39;, startDragging);
            draggable.addEventListener(&#39;touchstart&#39;, startDragging, {passive: false});
        });
    }
//! Fin Gestion du glisser-déposer 
  
//! Début du glissement d&#39;un objet 
function startDragging(e) {
  e.preventDefault();

  // Détermine les coordonnées selon le type d&#39;événement (souris ou tactile)
  let clientX, clientY;
  if (e.type.startsWith(&#39;touch&#39;)) {
    clientX = e.touches[0].clientX;
    clientY = e.touches[0].clientY;
  } else {
    clientX = e.clientX;
    clientY = e.clientY;
  }

  var draggable = this;
  var rect = draggable.getBoundingClientRect();
  var startX = clientX - rect.left;
  var startY = clientY - rect.top;
  var originalParent = draggable.parentElement || null;

  // Créer une copie de l&#39;élément pour le déplacement
  var draggedCopy = draggable.cloneNode(true);
  draggedCopy.style.position = &#39;fixed&#39;;
  draggedCopy.style.zIndex = &#39;999999&#39;;
  draggedCopy.style.pointerEvents = &#39;none&#39;;
  draggedCopy.style.width = rect.width + &#39;px&#39;;
  draggedCopy.style.height = rect.height + &#39;px&#39;;
  document.body.appendChild(draggedCopy);

  // Cacher l&#39;élément original pendant le glissement
  draggable.style.visibility = &#39;hidden&#39;;

  function moveItem(moveEvent) {
    let moveClientX, moveClientY;
    if (moveEvent.type.startsWith(&#39;touch&#39;)) {
      moveClientX = moveEvent.touches[0].clientX;
      moveClientY = moveEvent.touches[0].clientY;
    } else {
      moveClientX = moveEvent.clientX;
      moveClientY = moveEvent.clientY;
    }
    var x = moveClientX - startX;
    var y = moveClientY - startY;
    draggedCopy.style.left = x + &#39;px&#39;;
    draggedCopy.style.top = y + &#39;px&#39;;
  }

  function stopDragging(endEvent) {
    // Supprimer les écouteurs d&#39;événements
    document.removeEventListener(&#39;mousemove&#39;, moveItem);
    document.removeEventListener(&#39;mouseup&#39;, stopDragging);
    document.removeEventListener(&#39;touchmove&#39;, moveItem);
    document.removeEventListener(&#39;touchend&#39;, stopDragging);

    // Déplacer l&#39;objet au lieu de le copier
    if (container &amp;&amp; container !== originalParent) {
        // Supprimer l&#39;élément original de son parent
        if (originalParent &amp;&amp; originalParent.contains(draggable)) {
            originalParent.removeChild(draggable);
        }

        // Vérifier si le conteneur cible est vide avant d&#39;ajouter
        if (container.children.length === 0 || container.classList.contains(&#39;zonesuppression&#39;)) {
            container.appendChild(draggable);
        } else {
            // Échanger les items si le slot cible est occupé
            const existingItem = container.querySelector(&#39;:scope &gt; .item-img&#39;);
            if (existingItem) {
                originalParent.appendChild(existingItem);
            }
            container.appendChild(draggable);
        }

        // Forcer une synchronisation immédiate
        mettreAJourStatsDepuisObjetsEquipes();
        synchronizeInventories();
    }
    
      if (originalParent &amp;&amp; originalParent.classList.contains(&#39;inventory-slot&#39;)) {
        const index = Array.from(originalParent.parentNode.children).indexOf(originalParent);
        const ingameSlot = document.querySelectorAll(&#39;.inventaireIngame&#39;)[index];
        if (ingameSlot) ingameSlot.innerHTML = &#39;&#39;;
    }
    
    // Supprimer la copie de l&#39;élément
    if (draggedCopy &amp;&amp; draggedCopy.parentElement) {
      document.body.removeChild(draggedCopy);
    }

    // Rendre l&#39;élément original à nouveau visible
    draggable.style.visibility = &#39;visible&#39;;

    let endClientX, endClientY;
    if (endEvent.type.startsWith(&#39;touch&#39;)) {
      endClientX = endEvent.changedTouches[0].clientX;
      endClientY = endEvent.changedTouches[0].clientY;
    } else {
      endClientX = endEvent.clientX;
      endClientY = endEvent.clientY;
    }

    // Trouver la cible de dépôt
    var dropTarget = document.elementFromPoint(endClientX, endClientY);
     var container = dropTarget ? dropTarget.closest(&#39;.slot, .inventaireIngame, .iconArmors, .zonesoin, .zonesuppression, .inventory-slot&#39;) : null;

  if (!container) {
    if (originalParent) {
      originalParent.appendChild(draggable);
    }
    return;
  }
  
//Affichage texte a la souris
var zonesoinElements = document.querySelectorAll(&#39;.zonesoin&#39;);
// Pour chaque élément, ajoute un écouteur d&#39;événement &quot;mouseenter&quot;
zonesoinElements.forEach(function(zone) {
  zone.addEventListener(&#39;mouseenter&#39;, function() {
    zone.setAttribute(&#39;title&#39;, &#39;Put your potion&#39;);
  });
});

document.querySelectorAll(&#39;.zonesuppression&#39;).forEach(zone =&gt; {
    zone.addEventListener(&#39;mouseenter&#39;, function() {
        this.setAttribute(&#39;title&#39;, &#39;Drag here to delete item&#39;);
    });
});



 // ✅ Gestion spécifique pour la zone de suppression
    if (container.classList.contains(&#39;zonesuppression&#39;)) {
    if (confirm(&quot;Delete this item permanently?&quot;)) {
        draggable.remove();
        
      if (originalParent.classList.contains(&#39;inventory-slot&#39;)) {
        const sidebarSlots = Array.from(document.querySelectorAll(&#39;.inventory-slot&#39;));
        const idx = sidebarSlots.indexOf(originalParent);
        const ingameSlots = document.querySelectorAll(&#39;.inventaireIngame&#39;);
        if (ingameSlots[idx]) ingameSlots[idx].innerHTML = &#39;&#39;;
      }
       if (window.sfxEnabled) {
            let sfxAudio = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/suppression.mp3&quot;);
            sfxAudio.volume = window.sfxVolume; 
            sfxAudio.play();
        }
         synchronizeInventories();
    } else if (originalParent) {
        originalParent.appendChild(draggable);
    }
    return;
}

// ❌ Si l&#39;objet est lâché en dehors d&#39;un conteneur valide
if (!container || container === originalParent) {
if (window.sfxEnabled) {
    let refusalSound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/refus.mp3&quot;);
    refusalSound.volume = window.sfxVolume;
    refusalSound.play();
}
  if (originalParent) {
    originalParent.appendChild(draggable);
  }
  return;
}


if (container &amp;&amp; container !== originalParent) {
    var allowedType = container.getAttribute(&#39;data-type&#39;);
    var itemType = draggable.getAttribute(&#39;data-type&#39;);

    // Vérifier si le conteneur a déjà un objet
    var existingItem = container.querySelector(&#39;.item-img:not(.decorative-image)&#39;);

    // ❌ Type non autorisé
    if (allowedType !== &#39;any&#39; &amp;&amp; allowedType !== itemType) {
      if (window.sfxEnabled) {
            let refusalSound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/refus.mp3&quot;);
            refusalSound.volume = window.sfxVolume;
            refusalSound.play();
        }
        originalParent.appendChild(draggable);
        return;
    }
    
      if (existingItem) {
        // Déplacer l&#39;objet existant vers l&#39;emplacement d&#39;origine
        originalParent.appendChild(existingItem);
    }

    // Déplacer le nouvel objet dans le conteneur
    container.appendChild(draggable);
    if (window.sfxEnabled) {
      let possessionSound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/possageobjet.wav&quot;);
      possessionSound.volume = window.sfxVolume;
      possessionSound.play();
    }
    // Gestion du rangement automatique
    if (autoStorageCheckbox?.checked &amp;&amp; container.classList.contains(&#39;slot&#39;)) {
        setTimeout(autoArrangeItems, 100);
    }
    
if (container.classList.contains(&#39;iconArmors&#39;)) {
  // Vérification du type et potentielle gestion de l’équipement existant...
  container.appendChild(draggable);
  let decorative = container.querySelector(&#39;.decorative-image&#39;);
  if (decorative) {
    decorative.style.display = &#39;none&#39;;
    console.log(&quot;Masquage forcé de l&#39;image déco lors du premier drop.&quot;);
  }
}


   if (allowedType === &#39;any&#39; || allowedType === itemType) {
    // Vérifier que l&#39;élément est encore enfant de son parent original avant de le supprimer
    if (originalParent &amp;&amp; typeof originalParent.contains === &#39;function&#39; &amp;&amp; draggable) {
    
      if (originalParent.contains(draggable)) {
        try {
          originalParent.removeChild(draggable);
        } catch (error) {
          console.error(&quot;Erreur lors de la suppression de l&#39;élément :&quot;, error);
        }
      } else {
        console.log(&quot;L&#39;élément n&#39;est plus un enfant du parent original.&quot;);
      }
    } else {
      console.warn(&quot;originalParent est null ou ne contient pas l&#39;élément.&quot;);
    }

    // ✅ Gestion spécifique pour la zone de soin (potions)
    if (container.classList.contains(&#39;zonesoin&#39;)) {
      let lifeValue = parseInt(draggable.getAttribute(&#39;data-life&#39;)) || 0;
      let updatedHealth = applyHealing(lifeValue);
      if (updatedHealth === false) {
    	if (window.sfxEnabled) {
              let refusalSound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/refus.mp3&quot;);
              refusalSound.volume = window.sfxVolume;
              refusalSound.play();
          }

        // Redonne la potion à l&#39;inventaire si la guérison échoue
        if (originalParent) {
          originalParent.appendChild(draggable);
        }
      } else {
        // Supprime l&#39;élément après utilisation
        draggable.remove();
          if (originalParent.classList.contains(&#39;inventory-slot&#39;)) {
        const sidebarSlots = Array.from(document.querySelectorAll(&#39;.inventory-slot&#39;));
        const idx = sidebarSlots.indexOf(originalParent);
        const ingameSlots = document.querySelectorAll(&#39;.inventaireIngame&#39;);
        if (ingameSlots[idx]) ingameSlots[idx].innerHTML = &#39;&#39;;
      }
      }
    } 


// ✅ Gestion des équipements (iconArmors) AVEC ÉCHANGE AUTOMATIQUE
else if (container.classList.contains(&#39;iconArmors&#39;)) {
  var armorType = container.getAttribute(&#39;data-type&#39;);

  if (armorType !== itemType) {
    // ❌ L&#39;objet n&#39;est pas du bon type → Refus + retour à l&#39;inventaire
  if (window.sfxEnabled) {
    let refusalSound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/refus.mp3&quot;);
    refusalSound.volume = window.sfxVolume;
    refusalSound.play();
}

    if (originalParent) {
      originalParent.appendChild(draggable);
    }
    return;
  }

  // ✅ Vérifie si un objet est déjà équipé dans le slot
  let existingItem = container.querySelector(&#39;.item-img:not(.decorative-image)&#39;);
  if (existingItem) {
    if (originalParent) {
      originalParent.appendChild(existingItem); // Remet l&#39;ancien objet dans l&#39;inventaire
    }
  }

  // ✅ Équipe le nouvel objet
  container.appendChild(draggable);
  
if (window.sfxEnabled) {
    let equipSound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/equiper.wav&quot;);
    equipSound.volume = window.sfxVolume;
    equipSound.play();
}


  // 🔥 Met à jour l&#39;affichage des images décoratives
  observeEquipmentChanges();
}

// ✅ Autres conteneurs normaux (inventaire, équipements…)
else {
  container.appendChild(draggable);
}

function observeEquipmentChanges() {
    document.querySelectorAll(&#39;.iconArmors&#39;).forEach(slot =&gt; {
        const observer = new MutationObserver(mutations =&gt; {
            mutations.forEach(mutation =&gt; {
                if (mutation.type === &quot;childList&quot;) {
                    const hasItem = slot.querySelector(&#39;.item-img:not(.decorative-image)&#39;);
                    const decorativeImage = slot.querySelector(&#39;.decorative-image&#39;);

                    if (decorativeImage) {
                        decorativeImage.style.display = hasItem ? &#39;none&#39; : &#39;block&#39;;
                    }
                }
            });
        });
        observer.observe(slot, { childList: true });
    });
}

// Appelle l&#39;observateur au chargement et après chaque mise à jour
observeEquipmentChanges();


        // Gestion du rangement automatique
        if (typeof autoStorageCheckbox !== &#39;undefined&#39; &amp;&amp; autoStorageCheckbox.checked &amp;&amp; container.classList.contains(&#39;slot&#39;)) {
          setTimeout(autoArrangeItems, 100);
        }
      }
    }

    // Synchroniser les inventaires et mettre à jour les statistiques
    synchronizeInventories();
    updateStatsFromEquipment();
  }

  // Ajouter les écouteurs d&#39;événements pour souris et tactile
  document.addEventListener(&#39;mousemove&#39;, moveItem);
  document.addEventListener(&#39;mouseup&#39;, stopDragging);
  document.addEventListener(&#39;touchmove&#39;, moveItem, { passive: false });
  document.addEventListener(&#39;touchend&#39;, stopDragging);
}

//! FIN Début du glissement d&#39;un objet 
//! Applique la guérison et retourne la nouvelle santé 
function applyHealing(amount) {
    console.log(`Healing for ${amount} points`);

    const barFill = document.getElementById(&quot;bar-fill&quot;);
    const barText = document.getElementById(&quot;bar-text&quot;);

    let currentHealth = parseInt(localStorage.getItem(&#39;playerHealth&#39;)) || parseInt(barText.textContent) || 0;
    let maxHealth = parseInt(localStorage.getItem(&#39;playerMaxHealth&#39;)) || $maxHealth || 100; // Utilisation de $maxHealth

    let newHealth = Math.min(currentHealth + amount, maxHealth);

    // Mise à jour de la santé et sauvegarde dans localStorage
    localStorage.setItem(&#39;playerHealth&#39;, newHealth);
    barFill.style.width = (newHealth / maxHealth) * 100 + &quot;%&quot;; // Adaptation à maxHealth
    barText.textContent = `${newHealth} / ${maxHealth}`;

    // Mise à jour de la barre de vie avec des couleurs spécifiques
    barFill.style.background = &quot;&quot;;
    setTimeout(() =&gt; {
        if (newHealth &gt;= maxHealth * 0.8) {
            barFill.style.background = &quot;linear-gradient(90deg, #44ff44 0%, #44ff8f 100%)&quot;;
        } else if (newHealth &gt;= maxHealth * 0.4) {
            barFill.style.background = &quot;linear-gradient(90deg, #ffaa44 0%, #ffdd44 100%)&quot;;
        } else {
            barFill.style.background = &quot;linear-gradient(90deg, #ff4444 0%, #ff8f44 100%)&quot;;
        }
    }, 10);

    return newHealth; 
}
//! FIN Applique la guérison et retourne la nouvelle santé 




//! Création d&#39;un nouvel objet 
window.createItem = function(type, imgSrc, id, nom, strength, intelligence, luck, charisma, durability, life, armor, prix, rare, money) {
    var img = document.createElement(&#39;img&#39;);
    img.src = imgSrc;
    img.className = &#39;item-img&#39;;
        img.setAttribute(&#39;data-id&#39;, id);
    img.setAttribute(&#39;draggable&#39;, &#39;true&#39;);
    img.setAttribute(&#39;data-type&#39;, type);
    img.setAttribute(&#39;data-nom&#39;, nom);

    // Attributs optionnels
    if (strength !== undefined) {img.setAttribute(&#39;data-strength&#39;, strength);}
    if (intelligence !== undefined) {img.setAttribute(&#39;data-intelligence&#39;, intelligence);}
    if (luck !== undefined) {img.setAttribute(&#39;data-luck&#39;, luck);}
    if (charisma !== undefined) {img.setAttribute(&#39;data-charisma&#39;, charisma);}
    if (durability !== undefined) {img.setAttribute(&#39;data-durability&#39;, durability);}
    if (life !== undefined) {img.setAttribute(&#39;data-life&#39;, life);}
    if (armor !== undefined) {img.setAttribute(&#39;data-armor&#39;, armor);}
    if (prix !== undefined) {img.setAttribute(&#39;data-prix&#39;, prix);}
    if (rare !== undefined) {img.setAttribute(&#39;data-rare&#39;, rare);}
    if (money !== undefined) {img.setAttribute(&#39;data-money&#39;, money);}
    

    // Ajouter l&#39;événement mouseenter pour afficher l&#39;infobulle
    img.addEventListener(&#39;mouseenter&#39;, function(event) {
        showTooltip(event, img);
    });

      img.addEventListener(&#39;mousedown&#39;, startDragging);
      img.addEventListener(&#39;touchstart&#39;, startDragging, { passive: false });

    
    return img;
};
//! Fin Création d&#39;un nouvel objet 

//! Affichage infobulle 
window.showTooltip = function(event, itemElement) {
  // Vérifie si l&#39;élément ciblé est bien une image
  if (!itemElement.classList.contains(&#39;item-img&#39;)) return;

  // Empêche le comportement par défaut
  if (event.cancelable) event.preventDefault();

  // Supprime toute tooltip existante
  document.querySelectorAll(&#39;.tooltip&#39;).forEach(el =&gt; el.remove());

  // Crée et configure l&#39;élément tooltip
  const tooltip = document.createElement(&#39;div&#39;);
  tooltip.className = &#39;tooltip&#39;;
  tooltip.style.position = &#39;absolute&#39;;
  tooltip.style.color = &#39;#fff&#39;;
  tooltip.style.padding = &#39;8px&#39;;
  tooltip.style.borderRadius = &#39;5px&#39;;
  tooltip.style.fontSize = &#39;12px&#39;;
  tooltip.style.zIndex = &#39;999991&#39;;
  tooltip.style.border = &#39;1px solid rgba(255, 255, 255, 0.5)&#39;;
  tooltip.style.boxShadow = &#39;0px 4px 6px rgba(0, 0, 0, 0.1)&#39;;
  tooltip.style.display = &#39;block&#39;;

  // Construit le contenu de la tooltip à partir des attributs de l&#39;image
  let content = &#39;&#39;;

  function addAttribute(label, attribute) {
    const value = itemElement.getAttribute(attribute);
    if (value === null || value === undefined) return;

    const isNumeric = !isNaN(parseFloat(value));
    const numericValue = parseFloat(value);

    const shouldShow =
      (isNumeric &amp;&amp; numericValue !== 0) ||               // Nombres ≠ 0
      (!isNumeric &amp;&amp; value.trim() !== &#39;&#39; &amp;&amp; value.toLowerCase() !== &#39;null&#39;); // Texte non vide

    if (shouldShow) {
      content += `&lt;strong&gt;${label}:&lt;/strong&gt; ${value}&lt;br&gt;`;
    }
  }
  addAttribute(&#39;Nom&#39;, &#39;data-nom&#39;);
  addAttribute(&#39;Type&#39;, &#39;data-type&#39;);
  addAttribute(&#39;Strength&#39;, &#39;data-strength&#39;);
  addAttribute(&#39;Durability&#39;, &#39;data-durability&#39;);
  addAttribute(&#39;Life&#39;, &#39;data-life&#39;);
  addAttribute(&#39;Armor&#39;, &#39;data-armor&#39;);
  addAttribute(&#39;Intelligence&#39;, &#39;data-intelligence&#39;);
  addAttribute(&#39;Luck&#39;, &#39;data-luck&#39;);
  addAttribute(&#39;Charisma&#39;, &#39;data-charisma&#39;);
  addAttribute(&#39;Prix&#39;, &#39;data-prix&#39;);
  addAttribute(&#39;Rare&#39;, &#39;data-rare&#39;);
  addAttribute(&#39;Money&#39;, &#39;data-money&#39;);

  if (!content) return;
  tooltip.innerHTML = content;

  // Récupère les coordonnées de l&#39;événement
  let clientX, clientY;
  if (event.touches &amp;&amp; event.touches.length &gt; 0) {
    clientX = event.touches[0].clientX;
    clientY = event.touches[0].clientY;
  } else {
    clientX = event.clientX;
    clientY = event.clientY;
  }
  tooltip.style.left = (clientX + 10) + &#39;px&#39;;
  tooltip.style.top = (clientY + 10) + &#39;px&#39;;

  // Définit la couleur de fond selon la rareté
  const rarityMap = {
    &#39;Common&#39;: &#39;rgb(137 134 134)&#39;,
    &#39;Uncommon&#39;: &#39;#00bfff&#39;,
    &#39;Rare&#39;: &#39;#008000&#39;,
    &#39;Epic&#39;: &#39;#ffa500&#39;,
    &#39;Legendary&#39;: &#39;#ff0000&#39;,
    &#39;Mythic&#39;: &#39;#9400d3&#39;
  };
  const rareValue = itemElement.getAttribute(&#39;data-rare&#39;) || &#39;Common&#39;;
  tooltip.style.backgroundColor = rarityMap[rareValue] || &#39;#ccc&#39;;

  // Ajoute la tooltip au document
  document.body.appendChild(tooltip);

  // Si c&#39;est un appareil desktop (pas tactile)
  if (!(&quot;ontouchstart&quot; in window || navigator.maxTouchPoints &gt; 0)) {
    // Met à jour la position de la tooltip au déplacement de la souris
    function onMove(e) {
      tooltip.style.left = (e.clientX + 10) + &#39;px&#39;;
      tooltip.style.top = (e.clientY + 10) + &#39;px&#39;;
    }
    document.addEventListener(&#39;mousemove&#39;, onMove);
    itemElement.addEventListener(&#39;mouseleave&#39;, function removeTooltip() {
      tooltip.remove();
      document.removeEventListener(&#39;mousemove&#39;, onMove);
    }, { once: true });
  }

  if (&quot;ontouchstart&quot; in window || navigator.maxTouchPoints &gt; 0) {
    setTimeout(function() {
      if (tooltip.parentNode) {
        tooltip.remove();
      }
    });
  }
};

// Appliquer l&#39;événement sur les images uniquement
document.addEventListener(&#39;mouseover&#39;, function(event) {
  if (event.target.classList.contains(&#39;item-img&#39;)) {
    showTooltip(event, event.target);
  }
});

document.addEventListener(&#39;touchstart&#39;, function(event) {
  if (event.target.classList.contains(&#39;item-img&#39;)) {
    showTooltip(event, event.target);
  }
}, { passive: false });

//! Fin Affichage infobulle

//!Actualisation des deux barre inventaire  
function synchronizeInventories() {
    const sidebarSlots = document.querySelectorAll(&#39;.inventory-slot&#39;);
    const ingameSlots = document.querySelectorAll(&#39;.inventaireIngame&#39;);
    const specialArmorSlots = document.querySelectorAll(&#39;.special-armors .iconArmors&#39;);
    const inventoryGridSlots = document.querySelectorAll(&#39;.inventory-grid .slot&#39;);

    const sidebarData = [];
    const ingameData = [];
    const specialArmorData = [];
    const inventoryGridData = [];

    // Nettoyer d&#39;abord tous les emplacements du sidebar
    sidebarSlots.forEach(slot =&gt; {
        while (slot.firstChild) {
            slot.removeChild(slot.firstChild);
        }
    });
//!Fin Actualisation des deux barre inventaire 

//! Synchronisation inventaire jeu → sidebar 
ingameSlots.forEach((ingameSlot, index) =&gt; {
    const sidebarSlot = sidebarSlots[index];
    const ingameItem = ingameSlot.querySelector(&#39;.item-img&#39;);

  if (ingameItem) {
            // Copier de l&#39;inventaire en jeu vers le sidebar
            const newItem = createItem(
                ingameItem.getAttribute(&#39;data-type&#39;),
                ingameItem.src,
                ingameItem.getAttribute(&#39;data-id&#39;),
                ingameItem.getAttribute(&#39;data-nom&#39;),
                ingameItem.getAttribute(&#39;data-strength&#39;),
                ingameItem.getAttribute(&#39;data-intelligence&#39;),
                ingameItem.getAttribute(&#39;data-luck&#39;),
                ingameItem.getAttribute(&#39;data-charisma&#39;),
                ingameItem.getAttribute(&#39;data-durability&#39;),
                ingameItem.getAttribute(&#39;data-life&#39;),
                ingameItem.getAttribute(&#39;data-armor&#39;),
                ingameItem.getAttribute(&#39;data-prix&#39;),
                ingameItem.getAttribute(&#39;data-rare&#39;),
                ingameItem.getAttribute(&#39;data-money&#39;),
            );
            sidebarSlot.appendChild(newItem);

        // Collecter les données pour LocalStorage
        const itemData = {
                type: ingameItem.getAttribute(&#39;data-type&#39;),
                src: ingameItem.src,
                id: ingameItem.getAttribute(&#39;data-id&#39;),
                nom: ingameItem.getAttribute(&#39;data-nom&#39;),
                strength: ingameItem.getAttribute(&#39;data-strength&#39;),
                intelligence: ingameItem.getAttribute(&#39;data-intelligence&#39;),
                luck : ingameItem.getAttribute(&#39;data-luck&#39;),
                charisma : ingameItem.getAttribute(&#39;data-charisma&#39;),
                durability: ingameItem.getAttribute(&#39;data-durability&#39;),
                life: ingameItem.getAttribute(&#39;data-life&#39;),
                armor: ingameItem.getAttribute(&#39;data-armor&#39;),
                prix:ingameItem.getAttribute(&#39;data-prix&#39;),
                rare:ingameItem.getAttribute(&#39;data-rare&#39;),
                money:ingameItem.getAttribute(&#39;data-money&#39;),
            };
        ingameData[index] = itemData;
        sidebarData[index] = itemData;
    } else {
        // Aucun objet dans cet emplacement
        ingameData[index] = null;
        sidebarData[index] = null;
    }
});
//! Fin Synchronisation inventaire jeu → sidebar 
    
     //! Collecte des données pour special-armors 
    specialArmorSlots.forEach((slot, index) =&gt; {
            const item = slot.querySelector(&#39;.item-img&#39;);
            if (item) {
                specialArmorData[index] = {
                    type: item.getAttribute(&#39;data-type&#39;),
                    src: item.src,
                    id: item.getAttribute(&#39;data-id&#39;),
                    nom: item.getAttribute(&#39;data-nom&#39;),
                    strength: item.getAttribute(&#39;data-strength&#39;),
                    intelligence: item.getAttribute(&#39;data-intelligence&#39;),
                	luck : item.getAttribute(&#39;data-luck&#39;),
                	charisma: item.getAttribute(&#39;data-charisma&#39;),
                    durability: item.getAttribute(&#39;data-durability&#39;),
                    life: item.getAttribute(&#39;data-life&#39;),
                    armor: item.getAttribute(&#39;data-armor&#39;),
                    prix: item.getAttribute(&#39;data-prix&#39;),
                    rare: item.getAttribute(&#39;data-rare&#39;),
                    money: item.getAttribute(&#39;data-money&#39;),
                };
            } else {
                specialArmorData[index] = null;
            }
        });
    //! Fin collecte special-armors 

  //! Collecte des données pour inventory-grid 
    inventoryGridSlots.forEach((slot, index) =&gt; {
            const item = slot.querySelector(&#39;.item-img&#39;);
            if (item) {
                inventoryGridData[index] = {
                    type: item.getAttribute(&#39;data-type&#39;),
                    src: item.src,
                    id: item.getAttribute(&#39;data-id&#39;),
                    nom: item.getAttribute(&#39;data-nom&#39;),
                    strength: item.getAttribute(&#39;data-strength&#39;),
                    intelligence: item.getAttribute(&#39;data-intelligence&#39;),
                	luck : item.getAttribute(&#39;data-luck&#39;),
                	charisma: item.getAttribute(&#39;data-charisma&#39;),
                    durability: item.getAttribute(&#39;data-durability&#39;),
                    life: item.getAttribute(&#39;data-life&#39;),
                    armor: item.getAttribute(&#39;data-armor&#39;),
                    prix: item.getAttribute(&#39;data-prix&#39;),
                    rare: item.getAttribute(&#39;data-rare&#39;),
                    money: item.getAttribute(&#39;data-money&#39;),
                };
            } else {
                inventoryGridData[index] = null;
            }
        });
    //! Fin collecte inventory-grid 
    
    //! Sauvegarde des données dans LocalStorage 
        localStorage.setItem(&#39;sidebarInventory&#39;, JSON.stringify(sidebarData));
        localStorage.setItem(&#39;ingameInventory&#39;, JSON.stringify(ingameData));
        localStorage.setItem(&#39;specialArmorInventory&#39;, JSON.stringify(specialArmorData));
        localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));
    //! Fin Sauvegarde 
    setupDragAndDrop();
}
//!FIN Actualisation des deux barre inventaire 


   window.initializeGameInterface();
      //!!FIN Menu Inventaire 

//!Fonction pour synchroniser les deux inventaires (coffre / inventaire)
let inventoryObserver = null;
let chestObserver = null;
let isSyncing = false;

//? Fonction pour synchroniser l&#39;Inventaire → Coffre
function SynchroInventaireCoffre() {
    if (isSyncing) return;
    isSyncing = true;

    const inventoryGrid = document.querySelector(&#39;.inventory-grid&#39;);
    const inventoryPlayerChest = document.getElementById(&#39;chestInventory&#39;);

    if (!inventoryGrid || !inventoryPlayerChest) return;

    if (chestObserver) chestObserver.disconnect();

    inventoryPlayerChest.innerHTML = &#39;&#39;;

    inventoryGrid.querySelectorAll(&#39;.slot&#39;).forEach(slot =&gt; {
        const item = slot.querySelector(&#39;.item-img&#39;);

        const newSlot = document.createElement(&#39;div&#39;);
        newSlot.className = &#39;slotChest&#39;;
        newSlot.dataset.slot = slot.dataset.slot;

        if (item) {
            const newItem = item.cloneNode(true);
            newItem.classList.remove(&#39;dragging&#39;); // Empêcher l&#39;effet visuel restant
            newSlot.appendChild(newItem);
        }

        inventoryPlayerChest.appendChild(newSlot);
    });

    setupDragAndDropForChest();

    setTimeout(() =&gt; {
        if (chestObserver) chestObserver.observe(inventoryPlayerChest, { childList: true, subtree: true });
        isSyncing = false;
    }, 100);
}
//? FIN Fonction pour synchroniser l&#39;Inventaire → Coffre

//? Fonction pour synchroniser le Coffre → Inventaire
function SynchroCoffreInventaire() {
    if (isSyncing) return;
    isSyncing = true;

    const inventoryGrid = document.querySelector(&#39;.inventory-grid&#39;);
    const inventoryPlayerChest = document.getElementById(&#39;chestInventory&#39;);

    if (!inventoryGrid || !inventoryPlayerChest) return;

    if (inventoryObserver) inventoryObserver.disconnect();

    inventoryGrid.innerHTML = &#39;&#39;;

    inventoryPlayerChest.querySelectorAll(&#39;.slotChest&#39;).forEach(slot =&gt; {
        const item = slot.querySelector(&#39;.item-img&#39;);

        const newSlot = document.createElement(&#39;div&#39;);
        newSlot.className = &#39;slot&#39;;
        newSlot.dataset.slot = slot.dataset.slot;

        if (item) {
            const newItem = item.cloneNode(true);
            newItem.classList.remove(&#39;dragging&#39;);
            newSlot.appendChild(newItem);
        }

        inventoryGrid.appendChild(newSlot);
    });

    setupDragAndDropForInventory();

    setTimeout(() =&gt; {
        if (inventoryObserver) inventoryObserver.observe(inventoryGrid, { childList: true, subtree: true });
        isSyncing = false;
        synchronizeInventories();
    }, 100);
}
//? FIN Fonction pour synchroniser le Coffre → Inventaire

//? Initialisation de la synchronisation de l&#39;inventaire du joueur
function initializeInventorySync() {
    const inventoryGrid = document.querySelector(&#39;.inventory-grid&#39;);
    if (!inventoryGrid) return;

    inventoryObserver = new MutationObserver(SynchroInventaireCoffre);
    inventoryObserver.observe(inventoryGrid, { childList: true, subtree: true });

    SynchroInventaireCoffre();
}
//? FIN Initialisation de la synchronisation de l&#39;inventaire du joueur

//? Initialisation de la synchronisation du coffre
function initializeChestSync() {
    const inventoryPlayerChest = document.getElementById(&#39;chestInventory&#39;);
    if (!inventoryPlayerChest) return;

    chestObserver = new MutationObserver(SynchroCoffreInventaire);
    chestObserver.observe(inventoryPlayerChest, { childList: true, subtree: true });
synchronizeInventories();
    SynchroCoffreInventaire();
}
//?FIN Initialisation de la synchronisation du coffre

//? Fonction pour configurer le glisser-déposer pour l&#39;inventaire du coffre
function setupDragAndDropForChest() {
    const inventoryPlayerChest = document.getElementById(&#39;chestInventory&#39;);
    if (!inventoryPlayerChest) return;

    const draggables = inventoryPlayerChest.querySelectorAll(&#39;.item-img&#39;);
    const slots = inventoryPlayerChest.querySelectorAll(&#39;.slotChest&#39;);

    draggables.forEach(draggable =&gt; {
        draggable.addEventListener(&#39;dragstart&#39;, e =&gt; {
            draggable.classList.add(&#39;dragging&#39;);
            e.dataTransfer.setData(&quot;text/plain&quot;, draggable.dataset.itemId || &quot;&quot;); 
        });

        draggable.addEventListener(&#39;dragend&#39;, () =&gt; {
            draggable.classList.remove(&#39;dragging&#39;);
            setTimeout(SynchroInventaireCoffre, 100); 
        });
    });

    slots.forEach(slot =&gt; {
        slot.addEventListener(&#39;dragover&#39;, e =&gt; {
            e.preventDefault();
            const draggable = document.querySelector(&#39;.dragging&#39;);
            if (draggable &amp;&amp; !slot.querySelector(&#39;.item-img&#39;)) {
                slot.appendChild(draggable);
            }
        });
    });
}
//?FIN Fonction pour configurer le glisser-déposer pour l&#39;inventaire du coffre

//? Fonction pour configurer le glisser-déposer pour l&#39;inventaire principal
function setupDragAndDropForInventory() {
    const inventoryGrid = document.querySelector(&#39;.inventory-grid&#39;);
    if (!inventoryGrid) return;

    const draggables = inventoryGrid.querySelectorAll(&#39;.item-img&#39;);
    const slots = inventoryGrid.querySelectorAll(&#39;.slot&#39;);

    draggables.forEach(draggable =&gt; {
        draggable.addEventListener(&#39;dragstart&#39;, e =&gt; {
            draggable.classList.add(&#39;dragging&#39;);
            e.dataTransfer.setData(&quot;text/plain&quot;, draggable.dataset.itemId || &quot;&quot;); 
        });

        draggable.addEventListener(&#39;dragend&#39;, () =&gt; {
            draggable.classList.remove(&#39;dragging&#39;);
            setTimeout(SynchroCoffreInventaire, 100);
        });
    });

    slots.forEach(slot =&gt; {
        slot.addEventListener(&#39;dragover&#39;, e =&gt; {
            e.preventDefault();
            const draggable = document.querySelector(&#39;.dragging&#39;);
            if (draggable &amp;&amp; !slot.querySelector(&#39;.item-img&#39;)) {
                slot.appendChild(draggable);
            }
        });
    });
}
//?FIN Fonction pour configurer le glisser-déposer pour l&#39;inventaire principal
initializeInventorySync();
initializeChestSync();
//!Fin  Fonction pour synchroniser les deux inventaires (coffre / inventaire)

//! Fonction Equipements pour statistiques du personnage
function mettreAJourStatsDepuisObjetsEquipes() {
    console.log(&quot;🔄 Mise à jour des statistiques depuis les objets équipés...&quot;);

    // Initialiser les bonus d&#39;équipement
    let bonusEquipements = {
        strength: 0,
        intelligence: 0,
        luck: 0,
        charisma: 0,
        armor: 0
    };

    // Lire les objets équipés
    document.querySelectorAll(&#39;.special-armors .iconArmors&#39;).forEach(emplacement =&gt; {
        const objet = emplacement.querySelector(&#39;.item-img&#39;);
        if (objet) {
            bonusEquipements.strength     += parseInt(objet.getAttribute(&#39;data-strength&#39;))     || 0;
            bonusEquipements.intelligence += parseInt(objet.getAttribute(&#39;data-intelligence&#39;)) || 0;
            bonusEquipements.luck         += parseInt(objet.getAttribute(&#39;data-luck&#39;))         || 0;
            bonusEquipements.charisma     += parseInt(objet.getAttribute(&#39;data-charisma&#39;))     || 0;
            bonusEquipements.armor        += parseInt(objet.getAttribute(&#39;data-armor&#39;))        || 0;
        }
    });

    // Ne PAS modifier le contenu texte visible : on le lit !
   document.querySelectorAll(&#39;.stat-value&#39;).forEach(elementStat =&gt; {
    const nomStat = elementStat.id.replace(&#39;-value&#39;, &#39;&#39;);
    const base = parseInt(elementStat.getAttribute(&#39;data-valeur-de-base&#39;)) || 0;
    const bonus = bonusEquipements[nomStat] || 0;

    // Ajoute le bonus visuel à côté de la valeur
    const bonusSpan = document.getElementById(`bonus-${nomStat}`);
    if (bonusSpan) {
        bonusSpan.textContent = bonus &gt; 0 ? ` (+${bonus})` : &quot;&quot;;
    }

    // Met à jour les valeurs JS globales
    window[`$${nomStat}`] = base + bonus;
});

       window.$totalArmor = bonusEquipements.armor;

    // Met à jour une éventuelle zone dédiée à l&#39;affichage de l’armure (visuel uniquement)
    const armorEl = document.querySelector(&#39;.statArmuresInfo&#39;);
    if (armorEl) {
        armorEl.textContent = `Armor : ${window.$totalArmor}`;
    }

    console.log(&quot;✅ Stats totales avec équipements :&quot;, {
        strength:     window.$strength,
        intelligence: window.$intelligence,
        luck:         window.$luck,
        charisma:     window.$charisma,
        armor:        window.$totalArmor
    });
}
// Fonctions pour équiper/déséquiper
function gererEquipementObjet(event) {
    if (event.target.classList.contains(&#39;item-img&#39;)) {
        console.log(`Objet équipé : ${event.target.getAttribute(&#39;data-nom&#39;)}`);
        mettreAJourStatsDepuisObjetsEquipes();
    }
}
function gererDesequipementObjet(event) {
    if (event.target.classList.contains(&#39;item-img&#39;)) {
        console.log(`Objet déséquipé : ${event.target.getAttribute(&#39;data-nom&#39;)}`);
        mettreAJourStatsDepuisObjetsEquipes();
    }
}

document.querySelectorAll(&#39;.special-armors .iconArmors&#39;).forEach(emplacement =&gt; {
    emplacement.addEventListener(&#39;MutationEvent&#39;, gererEquipementObjet);
    emplacement.addEventListener(&#39;MutationEvent&#39;, gererDesequipementObjet);
});

// Initialiser les statistiques de base et variables globales
document.querySelectorAll(&#39;.stat-value&#39;).forEach(elementStat =&gt; {
    const valeurDeBase = parseInt(elementStat.textContent) || 0;
    elementStat.setAttribute(&#39;data-valeur-de-base&#39;, valeurDeBase);
    const nomStat = elementStat.id.replace(&#39;-value&#39;, &#39;&#39;);
    if (nomStat === &#39;armor&#39;) {
        window.$totalArmor     = window.$totalArmor     || valeurDeBase;
    } else {
        window[`$${nomStat}`] = window[`$${nomStat}`] || valeurDeBase;
    }
    console.log(`Statistique de base initialisée pour ${elementStat.id} : ${valeurDeBase}`);
});

// Premier appel
mettreAJourStatsDepuisObjetsEquipes();

console.log(&quot;Statistiques initiales globales :&quot;, {
    strength:     window.$strength,
    intelligence: window.$intelligence,
    luck:         window.$luck,
    charisma:     window.$charisma,
    totalArmor:   window.$totalArmor
});

//! FIN Fonction Equipements pour statistiques du personnage


//! Masquer l&#39;image décorative quand objet équipé
(function hideDecorativeImagesOnLoad() {
  document.querySelectorAll(&#39;.iconArmors&#39;).forEach(slot =&gt; {
    // Vérifier s&#39;il y a un objet non décoratif dans le slot
    const item = slot.querySelector(&#39;.item-img:not(.decorative-image)&#39;);
    if (item) {
      const decorative = slot.querySelector(&#39;.decorative-image&#39;);
      if (decorative) {
        decorative.style.display = &#39;none&#39;;
      }
    }
  });
})();



  })();
  
  
//Ajoute Money a partir de window
window.updateMoney = function(addAmount) {
    const moneyEl = document.querySelector(&#39;.money&#39;);
    if (!moneyEl) return;

    // Extraire le texte actuel et convertir en nombre
    const currentText = moneyEl.textContent.trim().replace(/[^\d]/g, &#39;&#39;);
    const currentMoney = parseInt(currentText, 10) || 0;
    const newMoney = currentMoney + addAmount;

    // Mettre à jour l&#39;affichage
    const coinIcon = moneyEl.querySelector(&#39;i&#39;);
    moneyEl.textContent = newMoney + &quot; &quot;;
    if (coinIcon) {
        moneyEl.appendChild(coinIcon);
    }

    // Sauvegarder la nouvelle valeur
    localStorage.setItem(&#39;playerMoney&#39;, newMoney);
     if (window.State &amp;&amp; window.State.variables) {
        window.State.variables.money = newMoney;
    }
};
//FIN Ajoute Money a partir de window
function initHarloweVariables() {
    if (window.State &amp;&amp; window.State.variables) {
        // Synchronise l&#39;argent
        const moneyEl = document.querySelector(&#39;.money&#39;);
        if (moneyEl) {
            const currentText = moneyEl.textContent.trim().replace(/[^\d]/g, &#39;&#39;);
            window.State.variables.money = parseInt(currentText) || 0;
        }
        
        // Synchronise les points d&#39;expérience
        const pointsEl = document.getElementById(&#39;points-remaining&#39;);
        if (pointsEl) {
            window.State.variables.pointExp = parseInt(pointsEl.textContent) || 0;
        }
    }
}
initHarloweVariables();
&lt;/script&gt;</tw-passagedata><tw-passagedata pid="8" name="credits" tags="" position="2300,700" size="100,100">{&lt;style&gt;
.game-interface {
     height: 0px; 
}
  &lt;/style&gt;

&lt;body&gt;

&lt;a class=&quot;back-button&quot;&gt;[[Back-&gt;Start2]]&lt;/a&gt;
&lt;div class=&quot;credits-container&quot;&gt;
  &lt;div class=&quot;credits&quot;&gt;
    &lt;h1&gt;A Spaceship Accident&lt;/h1&gt;
    &lt;p&gt;Developed by Olivier Mavré (Artist &amp; Writer) and Quentin BOISSET (Developer &amp; Sound Designer)&lt;/p&gt;
    &lt;br /&gt;
    &lt;h2&gt;Story &amp; Illustrations&lt;/h2&gt;
    &lt;p&gt;All illustrations and the story were conceived and drawn by Olivier Mavré.&lt;/p&gt;
    &lt;br /&gt;
    &lt;h2&gt;Game System &amp; Animations&lt;/h2&gt;
    &lt;p&gt;Menus, animations, and the complete game system were developed by Quentin BOISSET.&lt;/p&gt;
    &lt;br /&gt;
 &lt;h2&gt;Music&lt;/h2&gt;
    &lt;p&gt;The music was composed by Quentin BOISSET, while the main ambient tracks were created by Olivier Mavré.&lt;/p&gt;
    &lt;br /&gt;
    &lt;h2&gt;Sound Effects&lt;/h2&gt;
    &lt;p&gt;All sound effects were created by Quentin BOISSET.&lt;/p&gt;
    &lt;br /&gt;
    &lt;h2&gt;Special Thanks&lt;/h2&gt;
    &lt;p&gt;A huge thank you to all our players! This is our very first game on this site, built with Twine. More enhancements are coming in future adventures!&lt;/p&gt;
    &lt;br /&gt;
    &lt;h2&gt;Stay Connected&lt;/h2&gt;
&lt;p&gt;
  Visit our website to follow our upcoming games:
  &lt;a style=&quot;color: gold;&quot; href=&quot;https://pickyouruniverse.com/index.php&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;&gt;
    PickYourUniverse.com
  &lt;/a&gt;
&lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt;


if (window.musiqueDeFond) {
    window.musiqueDeFond.pause();
    window.musiqueDeFond.currentTime = 0;
}


    // Lancer la musique des crédits
    const musiqueCredits = new Audio(&quot;https://pickyouruniverse.com/DataProjects/General/SonEvenements/credit.mp3&quot;);
    musiqueCredits.loop = true;
    musiqueCredits.volume = 0.5;
    musiqueCredits.play().catch(err =&gt; console.log(&quot;Lecture bloquée par le navigateur&quot;, err));

    // Rendre la musique accessible globalement si besoin
    window.musiqueCredits = musiqueCredits;

  document.querySelector(&#39;.back-button&#39;)?.addEventListener(&#39;click&#39;, function () {
    if (window.musiqueCredits) {
      window.musiqueCredits.pause();
      window.musiqueCredits.currentTime = 0;
      window.musiqueDeFond.play();
    }
  });
  
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem(&quot;characterUnlocked&quot;) === &quot;true&quot;;
        const characterButton = document.querySelector(&#39;.nav-btn[data-panel=&quot;skills&quot;]&#39;);
        const elementsToHide = document.querySelectorAll(&#39;.top-nav, .xp-container, .inventory-sidebar&#39;);

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove(&quot;disabled-btn&quot;);
                characterButton.disabled = false;
            } else {
                characterButton.classList.add(&quot;disabled-btn&quot;);
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el =&gt; {
            el.style.display = characterUnlocked ? &quot;&quot; : &quot;none&quot;;
        });
    }

    // Met à jour l&#39;état de l&#39;UI à chaque changement de passage
    $(document).on(&#39;:passagerender&#39;, function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
&lt;/script&gt;}
</tw-passagedata><tw-passagedata pid="9" name="footer" tags="footer" position="1950,525" size="100,100">{
&lt;div class=&quot;xp-container&quot;&gt;
  &lt;span class=&quot;lvl-xp&quot; id=&quot;lvl-text&quot;&gt;Lvl 1&lt;/span&gt;
  &lt;div class=&quot;xp-bar&quot;&gt;
    &lt;span class=&quot;bar-text-xp&quot; id=&quot;bar-text-xp&quot;&gt;0 XP / 10&lt;/span&gt;
    &lt;div class=&quot;xp-fill&quot; id=&quot;xp-fill&quot;&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;aside class=&quot;inventory-sidebar&quot;&gt;
  &lt;div class=&quot;classinventory&quot;&gt;
    &lt;div class=&quot;paramBlock&quot;&gt;
      &lt;div class=&quot;zonesoin&quot; data-type=&quot;soin&quot; title=&quot;Put your potion&quot;&gt;💊&lt;/div&gt;
      &lt;div class=&quot;zonesuppression&quot; data-type=&quot;suppression&quot; title=&quot;Drag here to delete item&quot;&gt;🗑️&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;RangementdivFooter&quot;&gt;
      &lt;div class=&quot;inventory-slot&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;inventory-slot&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;inventory-slot&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;inventory-slot&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;inventory-slot&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;inventory-slot&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;inventory-slot&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;inventory-slot&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;inventory-slot&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;button class=&quot;option-btn&quot; data-panel=&quot;options&quot;&gt;Settings&lt;/button&gt;
&lt;/aside&gt;

&lt;script&gt;
(function () {
  // Initialisation robuste des variables
  if (typeof $xp !== &quot;number&quot; || isNaN($xp)) $xp = 0;
  if (typeof $pointExp !== &quot;number&quot; || isNaN($pointExp)) $pointExp = 0;
  if (typeof $LvlXp !== &quot;number&quot; || isNaN($LvlXp)) $LvlXp = 1;
  if (typeof $xpLevelIndex !== &quot;number&quot; || isNaN($xpLevelIndex)) $xpLevelIndex = 0;
  if (typeof $levelThreshold !== &quot;number&quot; || isNaN($levelThreshold)) $levelThreshold = 10;
  if (typeof $baseLevelsEarned !== &quot;number&quot; || isNaN($baseLevelsEarned)) $baseLevelsEarned = 0;

  class ExperienceSystem {
    constructor() {
      this.levelThresholds = [10, 50, 100, 200, 300, 500, 1000];
      this.maxBaseLevel = this.levelThresholds.length; // Niveau 7 (index 6)

      // Conversion numérique garantie
      this.xp = Number($xp);
      this.level = Number($LvlXp);
      this.levelIndex = Number($xpLevelIndex);
      this.currentThreshold = Number($levelThreshold);
      this.baseLevelsEarned = Number($baseLevelsEarned);
      this.skillPoints = Number($pointExp);

      this.updateUI();
    }

    getTotalXp() {
      let total = 0;
      
      // Calcul de l&#39;XP pour les niveaux de base
      for (let i = 0; i &lt; Math.min(this.levelIndex, this.maxBaseLevel); i++) {
        total += this.levelThresholds[i];
      }
      
      // Ajout de l&#39;XP pour les niveaux supplémentaires
      if (this.levelIndex &gt; this.maxBaseLevel) {
        const extraLevels = this.levelIndex - this.maxBaseLevel;
        total += extraLevels * this.levelThresholds[this.maxBaseLevel - 1];
      }
      
      return total + this.xp;
    }

    recalculateLevel(totalXp) {
      // Validation du total XP
      totalXp = Number(totalXp);
      if (isNaN(totalXp)) totalXp = 0;
      
      const thresholds = this.levelThresholds;
      const lastThreshold = thresholds[thresholds.length - 1]; // 1000 XP
      let xpLeft = totalXp;
      let newLevel = 1;
      let newLevelIndex = 0;
      let newBaseLevels = 0;

      // Parcourir les 7 premiers niveaux
      while (newLevelIndex &lt; this.maxBaseLevel &amp;&amp; xpLeft &gt;= thresholds[newLevelIndex]) {
        xpLeft -= thresholds[newLevelIndex];
        newLevel++;
        newLevelIndex++;
        newBaseLevels++;
      }

      // Gestion des niveaux infinis au-delà du niveau 7
      if (newLevelIndex &gt;= this.maxBaseLevel) {
        // Calcul des niveaux supplémentaires
        const extraLevels = Math.floor(xpLeft / lastThreshold);
        newLevel += extraLevels;
        newLevelIndex += extraLevels;
        xpLeft = xpLeft % lastThreshold;
        newBaseLevels += extraLevels; 
      }

      // Calcul des points de compétence uniquement pour les niveaux de base
      const gainedPoints = Math.max(0, newBaseLevels - this.baseLevelsEarned);
      
      // Mise à jour des variables d&#39;état
      this.level = newLevel;
      this.levelIndex = newLevelIndex;
      this.xp = xpLeft;
      this.currentThreshold = (newLevelIndex &lt; this.maxBaseLevel) 
        ? thresholds[newLevelIndex] 
        : lastThreshold;
      
      // Mise à jour des points de base gagnés
      if (gainedPoints &gt; 0) {
        this.skillPoints += gainedPoints;
      }

      // Sauvegarde dans les variables Twine
      $xp = this.xp;
      $LvlXp = this.level;
      $xpLevelIndex = this.levelIndex;
      $levelThreshold = this.currentThreshold;
      $baseLevelsEarned = this.baseLevelsEarned;
      $pointExp = this.skillPoints;

      // Attribution des points de compétence
      if (gainedPoints &gt; 0 &amp;&amp; 
          typeof window.getPointsRemaining === &quot;function&quot; &amp;&amp;
          typeof window.setPointsRemaining === &quot;function&quot;) {
        const current = window.getPointsRemaining();
        window.setPointsRemaining(current + gainedPoints);
      }
    }

    addXp(amount) {
      // Validation de l&#39;amount
      amount = Number(amount);
      if (isNaN(amount) || amount &lt;= 0) return;

      const newTotalXp = this.getTotalXp() + amount;
      this.recalculateLevel(newTotalXp);
      this.updateUI();

      // Animation
      const characterBtn = document.querySelector(&#39;button.nav-btn[data-panel=&quot;skills&quot;]&#39;);
      if (characterBtn) {
        characterBtn.classList.add(&#39;character-animation&#39;);
        characterBtn.addEventListener(&#39;animationend&#39;, () =&gt; {
          characterBtn.classList.remove(&#39;character-animation&#39;);
        }, { once: true });
      }

      // Son
      if (window.sfxEnabled) {
        const xpSound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/xp.mp3&quot;);
        xpSound.play().catch(e =&gt; console.error(&quot;XP sound error:&quot;, e));
      }
    }

    updateUI() {
      const xpFill = document.getElementById(&quot;xp-fill&quot;);
      const lvlText = document.getElementById(&quot;lvl-text&quot;);
      const barText = document.getElementById(&quot;bar-text-xp&quot;);

      const percentage = (this.xp / this.currentThreshold) * 100;
      xpFill.style.width = percentage + &quot;%&quot;;
      
      lvlText.innerText = `Lvl ${this.level}`;
      
      // Affichage spécial pour les niveaux supérieurs à 7
      if (this.level &gt; this.maxBaseLevel) {
        barText.innerText = `${this.xp} XP / ${this.currentThreshold}`;
      } else {
        barText.innerText = `${this.xp} XP / ${this.currentThreshold}`;
      }
    }
  }

  window.gainXp = function (amount) {
    if (window.player) {
      window.player.addXp(amount);
    }
  };

  // Initialisation
  window.player = new ExperienceSystem();
})();
&lt;/script&gt;

}</tw-passagedata><tw-passagedata pid="10" name="CharacterClass" tags="" position="2300,1300" size="100,100">This world is full of wonders. But the most distrubing thing, by far, is the job diversity. You could say it is a calling, a sacred duty more than a mere ... Fortunatly, because you don&#39;t even get paid for all your hard labor).

Let&#39;s see :

⚰️ 1. Gravebinder
Role: Necromantic Warden / Controller

Description: You are one of the Gravebinders: those who enforce the bindings upon the dead. You wield chains and runes that tether souls to their tombs… or drag them back.

Stats:

STR: 12

DEX: 10

CON: 14

INT: 14

WIS: 16

CHA: 8

Special Abilities:

Soul Chain: Bind a nearby undead to stop its movement.

Seal of Rest: Prevents corpses from rising again.

Armor/Weapons: Heavy iron chains, rune-etched manacles.

Playstyle: Control enemies, prevent resurrection, strong defense against undead.

🔥 2. Lantern Bearer
Role: Guide / Light-Bringer / Support

Description: Bearers of the sacred Lanterns, they guide souls to the Veil: or away from it. Some say the lanterns themselves whisper truths from beyond.

Stats:

STR: 10

DEX: 12

CON: 12

INT: 14

WIS: 16

CHA: 14

Special Abilities:

Lantern Light: Illuminates hidden ghosts and weakens wraiths.

Soul Passage: Speak to spirits; gain clues or boons.

Armor/Weapons: Light chainmail, relic lantern, staff.

Playstyle: Support, illumination of hidden threats, spirit diplomacy.

⚔️ 3. Ossuary Knight
Role: Tank / Frontline Fighter

Description: Sworn to the Orders that guard the bone-pits and necropolises. Clad in armor crafted from sanctified bones, they are bastions against the tide of the restless dead.

Stats:

STR: 16

DEX: 10

CON: 16

INT: 8

WIS: 12

CHA: 10

Special Abilities:

Boneguard Stance: Increases defense when stationary.

Hammer of Sanctity: Deals extra damage to undead.

Armor/Weapons: Bone-forged plate armor, sanctified warhammer or maul.

Playstyle: Frontline tank, area control, anti-undead damage dealer.

🕯️ 4. Whispered
Role: Stealth / Assassin / Scout

Description: Silent killers who learned to walk the gravepaths and shadow-ways. They steal secrets from the dead… and lives from the living.

Stats:

STR: 10

DEX: 16

CON: 12

INT: 14

WIS: 12

CHA: 12

Special Abilities:

Ghost Step: Temporary invisibility against undead.

Silent Knife: Backstab bonuses; critical strikes cause silence.

Armor/Weapons: Light leathers, bone daggers, silence dust.

Playstyle: High mobility, stealth kills, infiltration.

📜 5. Pale Scholar
Role: Caster / Lore Master

Description: Archivists of death, readers of forgotten rites. They inscribe spells on flesh and wield bone wands to command death and life alike.

Stats:

STR: 8

DEX: 12

CON: 10

INT: 18

WIS: 16

CHA: 10

Special Abilities:

Runes of Severance: Weakens undead defenses.

Bone Scribe: Craft magical wards, traps, and talismans.

Armor/Weapons: Scholar’s robes, bone wand, rune-etched scrolls.

Playstyle: Spells, summoning, wards, knowledge-based solutions.

🩸 6. Exhumed
Role: Hybrid Fighter / Cursed Berserker

Description: You were dead. You clawed your way back. Part corpse, part human, the Exhumed burn their second lives for strength… but the grave always calls.

Stats:

STR: 16

DEX: 14

CON: 14

INT: 8

WIS: 10

CHA: 8

Special Abilities:

Death Surge: Sacrifice health for massive damage.

Grave Hunger: Regenerate by feasting on enemies.

Armor/Weapons: Rotten flesh armor, grave iron weapons.

Playstyle: High-risk melee DPS, self-sustain, terrifying presence.</tw-passagedata><tw-passagedata pid="11" name="Classes" tags="" position="2725,825" size="100,100">&lt;h1&gt; &lt;center&gt;Choose your class... &lt;/center&gt;&lt;/h1&gt;&lt;br&gt;


&lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Gravebinder&lt;/h2&gt;
  &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;
    &lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/GraveBinder.png&quot;&gt;&lt;/div&gt;

    &lt;div class=&quot;character-description&quot;&gt;
&lt;p&gt;You are $heroNameGravebinder, once the chief ritualist at the Silent Orders. In life, you oversaw the binding of restless spirits, but hesitation during your final rite cost you everything. Betrayed by the very chains you commanded, your heart gave out. They sealed you inside an rotten coffin, thinking to contain your cursed soul. But something stirred beneath the lid. When your eyes flutter open, the world smells of dust and sorrow: and the chains now answer only to you.&lt;/p&gt;
(click:&quot;Master Lorcan Vale&quot;)[
(set: $heroNameGravebinder to (prompt: &quot;Do you want to change the name ?&quot;,&quot;Master Lorcan Vale&quot;, ))
(set: $heroName to $heroNameGravebinder)
(goto:&quot;Classes&quot;)]
    &lt;span class=&quot;twine-link&quot;&gt;[[Play as a Gravebinder]]&lt;/span&gt;
    &lt;/div&gt;
    &lt;/div&gt;

  &lt;!-- Présentation des SKILLS --&gt;
  &lt;div class=&quot;character-stats&quot;&gt;
    &lt;ul class=&quot;presCompetences&quot;&gt;
      &lt;li&gt;Strength : &lt;span id=&quot;stat-strength&quot;&gt;15&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Intelligence : &lt;span id=&quot;stat-intelligence&quot;&gt;6&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Luck : &lt;span id=&quot;stat-luck&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Charisma : &lt;span id=&quot;stat-charisma&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;A Lantern Bearer&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;
    &lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Lantern.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
&lt;p&gt;You were $heroNameLanternBearer, keeper of the Lantern of True Dawn. When the Red Fog descended, you stayed behind to comfort the dying: and joined their number. They entombed you in, hoping your spirit would find peace. But as the centuries passed, the light within your lantern refused to extinguish. Now, as you push open the heavy lid, the pale flame sputters to life once more, guiding your first uncertain steps back into a ruined world.&lt;/p&gt;
(click:&quot;Sister Ailith Mara&quot;)[
(set: $heroNameLanternBearer to (prompt: &quot;Do you want to change the name ?&quot;,&quot;Sister Ailith Mara&quot;, ))
(set: $heroName to $heroNameLanternBearer)
(goto:&quot;Classes&quot;)]

    &lt;span class=&quot;twine-link&quot;&gt;[[Play as a Lantern Bearer]]&lt;/span&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;!-- Présentation des SKILLS --&gt;
  &lt;div class=&quot;character-stats&quot;&gt;
    &lt;ul class=&quot;presCompetences&quot;&gt;
      &lt;li&gt;Strength : &lt;span id=&quot;stat-strength&quot;&gt;15&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Intelligence : &lt;span id=&quot;stat-intelligence&quot;&gt;6&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Luck : &lt;span id=&quot;stat-luck&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Charisma : &lt;span id=&quot;stat-charisma&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
  &lt;/div&gt;

    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;An Ossuary Knight&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;
    &lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Knight.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
&lt;p&gt;$heroNameOssuaryKnight, fallen hero of the Ash Wars. Cut down by a cursed blade, your final honors were grim: a tomb of rotten pelts of some dead creatures, your armor rusted shut around you. Yet no grave could hold your iron will forever. Now, with a groan of rusted hinges and crumbling stone, you push, trying to shove aside your coffin&#39;s heavy lid. The world needs its knight once more: even if the sun will never rise again on your battered shield.&lt;/p&gt;
(click:&quot;Rourke Belgrave&quot;)[
(set: $heroNameOssuaryKnight to (prompt: &quot;Do you want to change the name ?&quot;,&quot;Rourke Belgrave&quot;, ))
(set: $heroName to $heroNameOssuaryKnight)
(goto:&quot;Classes&quot;)]
    &lt;span class=&quot;twine-link&quot;&gt;[[Play as an Ossuary Knight]]&lt;/span&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;!-- Présentation des SKILLS --&gt;
  &lt;div class=&quot;character-stats&quot;&gt;
    &lt;ul class=&quot;presCompetences&quot;&gt;
      &lt;li&gt;Strength : &lt;span id=&quot;stat-strength&quot;&gt;15&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Intelligence : &lt;span id=&quot;stat-intelligence&quot;&gt;6&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Luck : &lt;span id=&quot;stat-luck&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Charisma : &lt;span id=&quot;stat-charisma&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
  &lt;/div&gt;

    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;A Whispered&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;
    &lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Whispered.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
&lt;p&gt;You were $heroNameWhispered, once a silent blade for the Pale Court. When your masters turned against you, your betrayal was swift and merciless. They disposed of your body in a shallow grave... but the secrets you carried rooted deep into your restless soul. Now, blinking against the faint, rotten light, you push your way free from a cracked, hastily-nailed coffin. Your fingers find your dagger even before your mind remembers your name. There is still work to do in this broken world.&lt;/p&gt;
(click:&quot;Marek Slayne&quot;)[
(set: $heroNameWhispered to (prompt: &quot;Do you want to change the name ?&quot;,&quot;Marek Slayne&quot;, ))
(set: $heroName to $heroNameWhispered)
(goto:&quot;Classes&quot;)]
    &lt;span class=&quot;twine-link&quot;&gt;[[Play as a Whispered]]&lt;/span&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;!-- Présentation des SKILLS --&gt;
  &lt;div class=&quot;character-stats&quot;&gt;
    &lt;ul class=&quot;presCompetences&quot;&gt;
      &lt;li&gt;Strength : &lt;span id=&quot;stat-strength&quot;&gt;15&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Intelligence : &lt;span id=&quot;stat-intelligence&quot;&gt;6&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Luck : &lt;span id=&quot;stat-luck&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Charisma : &lt;span id=&quot;stat-charisma&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
  &lt;/div&gt;

    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;A Pale Scholar&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;
    &lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Scholar.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
&lt;p&gt;$heroNamePaleScholar, last of the Archivists of Erelith. You sought forbidden knowledge and found something deeper: death beyond death. They buried you with your grim tomes clutched to your chest, a precaution against the curses sewn into your bones. Yet when your eyes flicker open in your cramped coffin, the runes carved into the wood begin to weep ink, as if welcoming you home. You are now awake, scholar no longer: a living relic, desperate to rewrite your fate.&lt;/p&gt;
(click:&quot;Lady Thyrenia Arkwright&quot;)[
(set: $heroNamePaleScholar to (prompt: &quot;Do you want to change the name ?&quot;,&quot;Lady Thyrenia Arkwright&quot;, ))
(set: $heroName to $heroNamePaleScholar)
(goto:&quot;Classes&quot;)]
    &lt;span class=&quot;twine-link&quot;&gt;[[Play as a Pale Scholar]]&lt;/span&gt;
    &lt;/div&gt;
    &lt;/div&gt;
   
    &lt;!-- Présentation des SKILLS --&gt;
  &lt;div class=&quot;character-stats&quot;&gt;
    &lt;ul class=&quot;presCompetences&quot;&gt;
      &lt;li&gt;Strength : &lt;span id=&quot;stat-strength&quot;&gt;15&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Intelligence : &lt;span id=&quot;stat-intelligence&quot;&gt;6&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Luck : &lt;span id=&quot;stat-luck&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Charisma : &lt;span id=&quot;stat-charisma&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
  &lt;/div&gt;


    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;An Exhumed&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;
    &lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Exhumed.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
&lt;p&gt;You were $heroNameExhumed, condemned criminal, test subject of a forgotten experiment. Death came slowly, but not completely. The wardens buried you in a nameless grave, bound with iron nails and cursed chains. Yet the experiment refused to end. Now, you are awake, and this world, whatever it is, will snap apart under your fists. Your muscles ache with unnatural hunger as somewhere deep in your fractured mind, you know this is just the beginning of your true sentence.&lt;/p&gt;
(click:&quot;Garron Fletch&quot;)[
(set: $heroNameExhumed to (prompt: &quot;Do you want to change the name ?&quot;,&quot;Garron Fletch&quot;, ))
(set: $heroName to $heroNameExhumed)
(goto:&quot;Classes&quot;)]
    &lt;span class=&quot;twine-link&quot;&gt;[[Play as an Exhumed]]&lt;/span&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;!-- Présentation des SKILLS --&gt;
  &lt;div class=&quot;character-stats&quot;&gt;
    &lt;ul class=&quot;presCompetences&quot;&gt;
      &lt;li&gt;Strength : &lt;span id=&quot;stat-strength&quot;&gt;15&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Intelligence : &lt;span id=&quot;stat-intelligence&quot;&gt;6&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Luck : &lt;span id=&quot;stat-luck&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Charisma : &lt;span id=&quot;stat-charisma&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
  &lt;/div&gt;



    &lt;p class=&quot;note&quot;&gt;This decision is yours, remember you can always restart the game with another character at anytime. To restart or save the game, click on the &#39;options&#39; button. If you made an account, you will be able to save the game on your profile and be in our leaderboard.&lt;/p&gt;

(if: $heroName is &quot;Flavius&quot;)[
 &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;A God amongst men&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
&lt;p&gt;But your name could lead you to a better destiny, should you choose it :&lt;p&gt;
    &lt;span class=&quot;twine-link&quot;&gt;[[Play a god]]&lt;/span&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;!-- Présentation des SKILLS --&gt;
  &lt;div class=&quot;character-stats&quot;&gt;
    &lt;ul class=&quot;presCompetences&quot;&gt;
      &lt;li&gt;Strength : &lt;span id=&quot;stat-strength&quot;&gt;15&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Intelligence : &lt;span id=&quot;stat-intelligence&quot;&gt;6&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Luck : &lt;span id=&quot;stat-luck&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
      &lt;li&gt;Charisma : &lt;span id=&quot;stat-charisma&quot;&gt;10&lt;/span&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
  &lt;/div&gt;
]

&lt;script&gt;
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem(&quot;characterUnlocked&quot;) === &quot;true&quot;;
        const characterButton = document.querySelector(&#39;.nav-btn[data-panel=&quot;skills&quot;]&#39;);
        const elementsToHide = document.querySelectorAll(&#39;.top-nav, .xp-container, .inventory-sidebar&#39;);

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove(&quot;disabled-btn&quot;);
                characterButton.disabled = false;
            } else {
                characterButton.classList.add(&quot;disabled-btn&quot;);
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el =&gt; {
            el.style.display = characterUnlocked ? &quot;&quot; : &quot;none&quot;;
        });
    }

    // Met à jour l&#39;état de l&#39;UI à chaque changement de passage
    $(document).on(&#39;:passagerender&#39;, function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
&lt;/script&gt;</tw-passagedata><tw-passagedata pid="12" name="Notes" tags="" position="3675,4875" size="100,100">
If you want to know more about the Magister, you should talk to the old ... he knew Corvan...
Village Orientation to add


Another way to enter the place through a fight ?

LastPlace

Orientation visited

Citadel of Tales

Tired of getting your bony ass kicked by just about anybody ?
Our ... is top of the line. Only ... silver.

Do evil stuff

Exhumed
You recognize thise eyes : one of the guards, one of your torturer. 


Hello, stranger. Let me guess, you just arrived here ?

You are at the Velthorn Hollow&#39;s cemetery. 

Just don&#39;t apprach the ...big circle and you will be fine !

I am here for the first burial of ... But... You are not ..., are you ?

He turned himself into the most terrifying thing ever.
What ?
I know not... i don&#39;t have enough imagination

(a living child?)</tw-passagedata><tw-passagedata pid="13" name="TheGroundsKeeper" tags="" position="1600,125" size="100,100">groundskeeper, gravedigger, caretaker, and sexton. These individuals are responsible for tasks such as grave preparation, grounds maintenance, and providing support during burials and memorial services.

A sexton is an officer responsible for the maintenance of a church, congregation, or synagogue and its associated graveyard. In the context of cemeteries, a sexton manages the care and upkeep of the grounds, including the cutting and watering of grass, pruning trees and shrubs, and removing debris.
 They are also responsible for ensuring that burials are conducted smoothly and efficiently, managing burial records, and overseeing the legal and public record aspects of burials.</tw-passagedata><tw-passagedata pid="14" name="Play as a Gravebinder" tags="" position="3000,300" size="100,100">{
(set: $strength to 8)
(set: $basestrength to 8)

(set: $intelligence to 8)
(set: $baseintelligence to 8)

(set: $luck to 15)
(set: $baseluck to 15)

(set: $charisma to 10)
(set: $basecharisma to 10)

(set: $health to 50)
(set: $maxHealth to 50)
(set: $job to 1)
(set: $jobname to &#39;Gravebinder&#39;)
(set: $description to &quot;Some people are born with a plan. You never had one. A gambler, a drifter, a survivor—you’ve always relied on luck more than skill. Space wasn’t a dream, just the latest roll of the dice. Maybe out here, you’ll strike it big. Maybe you’ll crash and burn. Either way, it’s one hell of a ride&quot;)
}

  &lt;h2 class=&quot;character-title&quot;&gt;Gravebinder&lt;/h2&gt;
Some people are born with a plan. You never had one. A gambler, a drifter, a survivor—you’ve always relied on luck more than skill. Space wasn’t a dream, just the latest roll of the dice. Maybe out here, you’ll strike it big. Maybe you’ll crash and burn. Either way, it’s one hell of a ride

&lt;button class=&quot;boutonXp&quot; &gt;[[Click here to start your adventure !-&gt;StartGravebinder]]&lt;/button&gt;

&lt;button&gt;[[Back →-&gt;Classes]]&lt;/button&gt;

&lt;script&gt;
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem(&quot;characterUnlocked&quot;) === &quot;true&quot;;
        const characterButton = document.querySelector(&#39;.nav-btn[data-panel=&quot;skills&quot;]&#39;);
        const elementsToHide = document.querySelectorAll(&#39;.top-nav, .xp-container, .inventory-sidebar&#39;);

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove(&quot;disabled-btn&quot;);
                characterButton.disabled = false;
            } else {
                characterButton.classList.add(&quot;disabled-btn&quot;);
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el =&gt; {
            el.style.display = characterUnlocked ? &quot;&quot; : &quot;none&quot;;
        });
    }

    // Met à jour l&#39;état de l&#39;UI à chaque changement de passage
    $(document).on(&#39;:passagerender&#39;, function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
&lt;/script&gt;
</tw-passagedata><tw-passagedata pid="15" name="Play as a Lantern Bearer" tags="" position="2950,575" size="100,100">{
(set: $strength to 8)
(set: $basestrength to 8)

(set: $intelligence to 8)
(set: $baseintelligence to 8)

(set: $luck to 15)
(set: $baseluck to 15)

(set: $charisma to 10)
(set: $basecharisma to 10)
(set: $health to 50)
(set: $maxHealth to 50)
(set: $job to 2)
(set: $jobname to &#39;Lantern Bearer&#39;)
(set: $description to &quot;keeper of the Lantern of True Dawn. When the Red Fog descended, you stayed behind to comfort the dying: and joined their number. They entombed you in, hoping your spirit would find peace. But as the centuries passed, the light within your lantern refused to extinguish. Now, as you push open the heavy lid, the pale flame sputters to life once more, guiding your first uncertain steps back into a ruined world&quot;)
}

  &lt;h2 class=&quot;character-title&quot;&gt;Lantern Bearer&lt;/h2&gt;
keeper of the Lantern of True Dawn. When the Red Fog descended, you stayed behind to comfort the dying: and joined their number. They entombed you in, hoping your spirit would find peace. But as the centuries passed, the light within your lantern refused to extinguish. Now, as you push open the heavy lid, the pale flame sputters to life once more, guiding your first uncertain steps back into a ruined world.

&lt;button class=&quot;boutonXp&quot; &gt;[[Click here to start your adventure !-&gt;Start Lantern Bearer]]&lt;/button&gt;

&lt;button&gt;[[Back →-&gt;Classes]]&lt;/button&gt;

&lt;script&gt;
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem(&quot;characterUnlocked&quot;) === &quot;true&quot;;
        const characterButton = document.querySelector(&#39;.nav-btn[data-panel=&quot;skills&quot;]&#39;);
        const elementsToHide = document.querySelectorAll(&#39;.top-nav, .xp-container, .inventory-sidebar&#39;);

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove(&quot;disabled-btn&quot;);
                characterButton.disabled = false;
            } else {
                characterButton.classList.add(&quot;disabled-btn&quot;);
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el =&gt; {
            el.style.display = characterUnlocked ? &quot;&quot; : &quot;none&quot;;
        });
    }

    // Met à jour l&#39;état de l&#39;UI à chaque changement de passage
    $(document).on(&#39;:passagerender&#39;, function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
&lt;/script&gt;
</tw-passagedata><tw-passagedata pid="16" name="Play as an Ossuary Knight" tags="" position="2950,725" size="100,100">{
(set: $strength to 8)
(set: $basestrength to 8)

(set: $intelligence to 8)
(set: $baseintelligence to 8)

(set: $luck to 15)
(set: $baseluck to 15)

(set: $charisma to 10)
(set: $basecharisma to 10)

(set: $health to 50)
(set: $maxHealth to 50)
(set: $job to 3)
(set: $jobname to &#39;Ossuary Knight&#39;)
(set: $description to &quot;fallen hero of the Ash Wars. Cut down by a cursed blade, your final honors were grim: a tomb of rotten pelts of some dead creatures, your armor rusted shut around you. Yet no grave could hold your iron will forever. Now, with a groan of rusted hinges and crumbling stone, you push, trying to shove aside your coffin&#39;s heavy lid. The world needs its knight once more: even if the sun will never rise again on your battered shield&quot;)
}

  &lt;h2 class=&quot;character-title&quot;&gt;Ossuary Knight&lt;/h2&gt;
fallen hero of the Ash Wars. Cut down by a cursed blade, your final honors were grim: a tomb of rotten pelts of some dead creatures, your armor rusted shut around you. Yet no grave could hold your iron will forever. Now, with a groan of rusted hinges and crumbling stone, you push, trying to shove aside your coffin&#39;s heavy lid. The world needs its knight once more: even if the sun will never rise again on your battered shield.

&lt;button class=&quot;boutonXp&quot; &gt;[[Click here to start your adventure !-&gt;Play Ossuary Knight]]&lt;/button&gt;

&lt;button&gt;[[Back →-&gt;Classes]]&lt;/button&gt;

&lt;script&gt;
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem(&quot;characterUnlocked&quot;) === &quot;true&quot;;
        const characterButton = document.querySelector(&#39;.nav-btn[data-panel=&quot;skills&quot;]&#39;);
        const elementsToHide = document.querySelectorAll(&#39;.top-nav, .xp-container, .inventory-sidebar&#39;);

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove(&quot;disabled-btn&quot;);
                characterButton.disabled = false;
            } else {
                characterButton.classList.add(&quot;disabled-btn&quot;);
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el =&gt; {
            el.style.display = characterUnlocked ? &quot;&quot; : &quot;none&quot;;
        });
    }

    // Met à jour l&#39;état de l&#39;UI à chaque changement de passage
    $(document).on(&#39;:passagerender&#39;, function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
&lt;/script&gt;
</tw-passagedata><tw-passagedata pid="17" name="Play as a Whispered" tags="" position="2950,875" size="100,100">{
(set: $strength to 8)
(set: $basestrength to 8)

(set: $intelligence to 8)
(set: $baseintelligence to 8)

(set: $luck to 15)
(set: $baseluck to 15)

(set: $charisma to 10)
(set: $basecharisma to 10)

(set: $health to 50)
(set: $maxHealth to 50)
(set: $job to 4)
(set: $jobname to &#39;Whispered&#39;)
(set: $description to &quot;once a silent blade for the Pale Court. When your masters turned against you, your betrayal was swift and merciless. They disposed of your body in a shallow grave... but the secrets you carried rooted deep into your restless soul. Now, blinking against the faint, rotten light, you push your way free from a cracked, hastily-nailed coffin. Your fingers find your dagger even before your mind remembers your name. There is still work to do in this broken world&quot;)
}

  &lt;h2 class=&quot;character-title&quot;&gt;Whispered&lt;/h2&gt;
once a silent blade for the Pale Court. When your masters turned against you, your betrayal was swift and merciless. They disposed of your body in a shallow grave... but the secrets you carried rooted deep into your restless soul. Now, blinking against the faint, rotten light, you push your way free from a cracked, hastily-nailed coffin. Your fingers find your dagger even before your mind remembers your name. There is still work to do in this broken world

&lt;button class=&quot;boutonXp&quot; &gt;[[Click here to start your adventure !-&gt;Start Whispered]]&lt;/button&gt;

&lt;button&gt;[[Back →-&gt;Classes]]&lt;/button&gt;

&lt;script&gt;
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem(&quot;characterUnlocked&quot;) === &quot;true&quot;;
        const characterButton = document.querySelector(&#39;.nav-btn[data-panel=&quot;skills&quot;]&#39;);
        const elementsToHide = document.querySelectorAll(&#39;.top-nav, .xp-container, .inventory-sidebar&#39;);

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove(&quot;disabled-btn&quot;);
                characterButton.disabled = false;
            } else {
                characterButton.classList.add(&quot;disabled-btn&quot;);
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el =&gt; {
            el.style.display = characterUnlocked ? &quot;&quot; : &quot;none&quot;;
        });
    }

    // Met à jour l&#39;état de l&#39;UI à chaque changement de passage
    $(document).on(&#39;:passagerender&#39;, function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
&lt;/script&gt;
</tw-passagedata><tw-passagedata pid="18" name="Play as a Pale Scholar" tags="" position="2900,1125" size="100,100">{
(set: $strength to 8)
(set: $basestrength to 8)

(set: $intelligence to 8)
(set: $baseintelligence to 8)

(set: $luck to 15)
(set: $baseluck to 15)

(set: $charisma to 10)
(set: $basecharisma to 10)

(set: $health to 50)
(set: $maxHealth to 50)
(set: $job to 5)
(set: $jobname to &#39;Pale Scholar&#39;)
(set: $description to &quot;last of the Archivists of Erelith. You sought forbidden knowledge and found something deeper: death beyond death. They buried you with your grim tomes clutched to your chest, a precaution against the curses sewn into your bones. Yet when your eyes flicker open in your cramped coffin, the runes carved into the wood begin to weep ink, as if welcoming you home. You are now awake, scholar no longer: a living relic, desperate to rewrite your fate&quot;)
}

  &lt;h2 class=&quot;character-title&quot;&gt;Pale Scholar&lt;/h2&gt;
last of the Archivists of Erelith. You sought forbidden knowledge and found something deeper: death beyond death. They buried you with your grim tomes clutched to your chest, a precaution against the curses sewn into your bones. Yet when your eyes flicker open in your cramped coffin, the runes carved into the wood begin to weep ink, as if welcoming you home. You are now awake, scholar no longer: a living relic, desperate to rewrite your fate

&lt;button class=&quot;boutonXp&quot; &gt;[[Click here to start your adventure !-&gt;Start Pale Scholar]]&lt;/button&gt;

&lt;button&gt;[[Back →-&gt;Classes]]&lt;/button&gt;

&lt;script&gt;
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem(&quot;characterUnlocked&quot;) === &quot;true&quot;;
        const characterButton = document.querySelector(&#39;.nav-btn[data-panel=&quot;skills&quot;]&#39;);
        const elementsToHide = document.querySelectorAll(&#39;.top-nav, .xp-container, .inventory-sidebar&#39;);

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove(&quot;disabled-btn&quot;);
                characterButton.disabled = false;
            } else {
                characterButton.classList.add(&quot;disabled-btn&quot;);
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el =&gt; {
            el.style.display = characterUnlocked ? &quot;&quot; : &quot;none&quot;;
        });
    }

    // Met à jour l&#39;état de l&#39;UI à chaque changement de passage
    $(document).on(&#39;:passagerender&#39;, function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
&lt;/script&gt;
















</tw-passagedata><tw-passagedata pid="19" name="Play as an Exhumed" tags="" position="2800,1300" size="100,100">{
(set: $strength to 8)
(set: $basestrength to 8)

(set: $intelligence to 8)
(set: $baseintelligence to 8)

(set: $luck to 15)
(set: $baseluck to 15)

(set: $charisma to 10)
(set: $basecharisma to 10)

(set: $health to 50)
(set: $maxHealth to 50)
(set: $job to 6)
(set: $jobname to &#39;Exhumed&#39;)
(set: $description to &quot; condemned criminal, test subject of a forgotten experiment. Death came slowly, but not completely. The wardens buried you in a nameless grave, bound with iron nails and cursed chains. Yet the experiment refused to end. Now, you are awake, and this world, whatever it is, will snap apart under your fists. Your muscles ache with unnatural hunger as somewhere deep in your fractured mind, you know this is just the beginning of your true sentence&quot;)
}

  &lt;h2 class=&quot;character-title&quot;&gt;Exhumed&lt;/h2&gt;
 condemned criminal, test subject of a forgotten experiment. Death came slowly, but not completely. The wardens buried you in a nameless grave, bound with iron nails and cursed chains. Yet the experiment refused to end. Now, you are awake, and this world, whatever it is, will snap apart under your fists. Your muscles ache with unnatural hunger as somewhere deep in your fractured mind, you know this is just the beginning of your true sentence

&lt;button class=&quot;boutonXp&quot; &gt;[[Click here to start your adventure !-&gt;Start Exhumed]]&lt;/button&gt;

&lt;button&gt;[[Back →-&gt;Classes]]&lt;/button&gt;

&lt;script&gt;
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem(&quot;characterUnlocked&quot;) === &quot;true&quot;;
        const characterButton = document.querySelector(&#39;.nav-btn[data-panel=&quot;skills&quot;]&#39;);
        const elementsToHide = document.querySelectorAll(&#39;.top-nav, .xp-container, .inventory-sidebar&#39;);

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove(&quot;disabled-btn&quot;);
                characterButton.disabled = false;
            } else {
                characterButton.classList.add(&quot;disabled-btn&quot;);
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el =&gt; {
            el.style.display = characterUnlocked ? &quot;&quot; : &quot;none&quot;;
        });
    }

    // Met à jour l&#39;état de l&#39;UI à chaque changement de passage
    $(document).on(&#39;:passagerender&#39;, function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
&lt;/script&gt;
















</tw-passagedata><tw-passagedata pid="20" name="Play a god" tags="" position="2625,1525" size="100,100">{
(set: $strength to 8)
(set: $basestrength to 8)

(set: $intelligence to 8)
(set: $baseintelligence to 8)

(set: $luck to 15)
(set: $baseluck to 15)

(set: $charisma to 10)
(set: $basecharisma to 10)

(set: $health to 50)
(set: $maxHealth to 50)
(set: $job to 0)
(set: $jobname to &#39;God Flavius&#39;)
(set: $description to &quot;But your name could lead you to a better destiny, should you choose it :&quot;)
}

  &lt;h2 class=&quot;character-title&quot;&gt;God Flavius&lt;/h2&gt;
 But your name could lead you to a better destiny, should you choose it :

&lt;button class=&quot;boutonXp&quot; &gt;[[Click here to start your adventure !-&gt;Start God]]&lt;/button&gt;

&lt;button&gt;[[Back →-&gt;Classes]]&lt;/button&gt;

&lt;script&gt;
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem(&quot;characterUnlocked&quot;) === &quot;true&quot;;
        const characterButton = document.querySelector(&#39;.nav-btn[data-panel=&quot;skills&quot;]&#39;);
        const elementsToHide = document.querySelectorAll(&#39;.top-nav, .xp-container, .inventory-sidebar&#39;);

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove(&quot;disabled-btn&quot;);
                characterButton.disabled = false;
            } else {
                characterButton.classList.add(&quot;disabled-btn&quot;);
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el =&gt; {
            el.style.display = characterUnlocked ? &quot;&quot; : &quot;none&quot;;
        });
    }

    // Met à jour l&#39;état de l&#39;UI à chaque changement de passage
    $(document).on(&#39;:passagerender&#39;, function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
&lt;/script&gt;
















</tw-passagedata><tw-passagedata pid="21" name="MainQuest" tags="" position="4050,775" size="100,200">{&lt;div class=&quot;image-container&quot;&gt;
  &lt;img class=&quot;image-base&quot; src=&quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Illustrations/GettingOut.jpg&quot; /&gt;
&lt;/div&gt;
(set: $journal to it + (a: $heroName+ &quot;\n\n&quot;))  
(set: $journal to it + (a: &quot;I woke up in the Velthorn Hollow&#39;s cemetery.&quot;+ &quot;\n\n&quot;))}
Your body feels stiff from its time in confinement. After a few seconds, you straighten yourself, glance at the surrounding tombs, and steel yourself for the task ahead.

**You:** “How hard can it be? Magister Corvan&#39;s body must be somewhere in this cemetery, right?”  
**Groundskeeper:** “Well… actually… it’s a bit more complicated.”  
**You:** “Complicated? What do you mean?”  
**Groundskeeper:** “Last I heard, he’s in shambles.”  
**You:** “In shambles?”  
**Groundskeeper:** “His body, I mean: all scattered in different places, you see?”  
*(The groundskeeper pauses, picking at the hem of his coat.)*  
**Groundskeeper:** “Yes. When I heard someone screaming and thrashing about like a devil, I was relieved it might be him: intact, mouth and feet included. But alas…”  
**You:** “It was just me... but who did this to him?”  
**Groundskeeper:** “Oh no, no! He wasn’t tortured, I swear: it was his own doing.”  
**You:** “He did this... to himself?”  
**Groundskeeper:** “Yes… I don’t know why, really, but he did it. Folks talk about a rituel of some kind, they call it &#39;severance&#39;... But I don&#39;t know much more. Ask around. Anyway, the village hasn’t been the same since that went down. I reckon we need to put him back together… somehow, at least.”
 
* Ok, I’ll see what I can do!
* No way: this is too weird! Put me back in the box!

(click:&quot; I’ll see what I can do!&quot;)[
**You:** “Very well. I’ll gather his parts and reassemble him.”  
*(The groundskeeper nods grimly and steps aside.)*  
* [[Proceed to the village|Background]]
(replace:&quot;back in the box!&quot;)[back in the box.]
]

(click:&quot;back in the box!&quot;)[
**You:** “Well… thank you for digging me out, but I’m no detective: or grave-digger!”  
**Groundskeeper:** “I knew you’d say that. All right, back you go!”  
*(He shoves you back under the coffin lid.)*  
* [[Fall unconscious|GameOverStarve]]
(replace:&quot;I’ll see what I can do!&quot;)[I&#39;ll see what I can do.]
]
</tw-passagedata><tw-passagedata pid="22" name="VelthornHollowEntry" tags="" position="3725,2075" size="100,100">{&lt;div class=&quot;image-container&quot;&gt;
  &lt;img class=&quot;image-base&quot; src=&quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Illustrations/VelthornHollowEntry.png&quot; /&gt;
&lt;/div&gt;}
You stand in front of Velthorn Hollow.
The place seems empty.
The village main entrance is... well, it exists, at least. The kind of village you can imagine had a golden age, but very long ago, and forgotten, and that will never happen ago, not in anybody&#39;s life time. Or their children.

On a crumbling wall beside the entrance, you spot a **faded mural**: three interlocking loops of bones and runes, half-worn away by time: but still unmistakable in its pattern.
Must be a real tourist trap!

After some reflection on how you got here - all the mistakes and regrets that form your shell of a personality - you finally step inside for some [[sight seeing...|VelthornHollowOrientation]]

</tw-passagedata><tw-passagedata pid="23" name="VelthornHollowOrientation" tags="NEXUS" position="3200,2725" size="200,200">Here we are ! And here are a list of all the wonderful things to discover in this wonderful village of Velthorn Hollow :

* [[The Shrouded Well|ShroudedWellArrival]]  
  A moss-covered stone rim stands at the center of the square, from which pale fog drifts like cold breath. Somewhere deep below, unseen whispers stir: dare you draw near its edge and listen?  

* [[The Rotted Market Stalls|RottedMarketStallsArrival]]  
  Half-collapsed wooden stalls sag beneath tattered tarps. Dried herbs, cracked pottery, and bleached bone trinkets lie scattered across rotting tables, while ghostly vendors haggle in hushed tones.  

* [[Widow Marrow’s Tea House|WidowMarrowTeaHouseArrival]]  
  A crooked hut with smoke-wreathed rafters and tinkling wind bells. Warm steam curls through the door, carrying the scent of strange herbs: and something faintly spectral hidden within each cup.  

* [[The Weeping Lantern Arch|WeepingLanternArchArrival]]  
  Two rusted lanterns frame the main road’s gate, their ironwork stained by slow, crimson tears. Under their glow, the cobblestones gleam wet, and the lanterns themselves seem to watch you pass.  

* [[The Bone-Stacked Shrine|BoneStackedShrineArrival]]  
  A small stone altar piled high with skulls, femurs, and knucklebones. Dry wind rattles the bones like chimes, and distant chanting seems to pulse from the very earth beneath your feet.  

* [[The Bone &amp; Lantern Emporium|EmporiumArrival]]  
  A narrow shop hung with polished bone charms and glowing spectral lanterns, where a silver‑tongued merchant hawks curiosities both practical and arcane.

* [[The Cracked Reflection Pool|CrackedReflectionPoolArrival]]  
  A stagnant pool of black water mirrors a fractured obsidian slab beneath the surface. Ghostly sobs echo across the glassy mirror, where torn reflections shift at the edge of your vision.  

* [[The Half-Buried Bell Tower|HalfBuriedBellTowerArrival]]  
  An ancient spire leans precariously, its bell lodged deep in a tangle of roots. When the wind stirs, a low bronze hum vibrates through the tower: and through your bones.  

* [[Wheelwright’s Workshop|WheelwrightWorkshopArrival]]  
  Sawdust drifts in lantern light, and half-finished wagon wheels carved from bone rest on crooked racks. The one-armed craftsman inside hammers bone spokes with rhythmic precision.  

* [[Mourning Oak Inn|MourningOakInnArrival]]  
  Built around a great dead oak whose skeletal branches pierce the ceiling, the inn’s common room is lit by lanterns dripping luminous sap. Patrons drink somber ale beneath the oak’s hollow gaze.  

* [[The Forgotten Graveyard Gate|ForgottenGraveyardGateArrival]]  
  An iron archway entombs a rusted gate locked by a massive bone key. Overgrown tombstones lean in silent rows, and moonlight filters through gnarled branches to guide: or warn: every traveler.  
  
Or… [[Wait until night falls and see another side of Velthorn Hollow|NightVelthornHollowOrientation]]

&lt;p&gt;Where will you venture first?  &lt;/p&gt;


</tw-passagedata><tw-passagedata pid="24" name="RestartDonnee" tags="" position="2300,575" size="100,100">&lt;!--
The End...
of this adventure. Go back to the beginning
and choose again.

--&gt;

This is the end of this journey, but the beginning of another one
(click:&quot;another one&quot;)[(goto:&quot;Start2&quot;)]
&lt;b&gt;&lt;center&gt;You have reached ending $currentEnding/$endingNumbers&lt;/center&gt;&lt;/b&gt;

&lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;&#39;&#39;Enjoyed Your Adventure? Help Us Create More!&#39;&#39;&lt;/h2&gt;
  &lt;div class=&quot;character-rangement&quot;&gt;
   
    &lt;div class=&quot;character-description&quot;&gt;

Thank you for embarking on this journey with us. Crafting immersive, interactive stories like A Spaceship Accident and The Three Burials of Magister Corvan is a labor of love that involves countless hours of writing, designing, and coding.&lt;br&gt;

&#39;&#39;Your support enables us to:&#39;&#39;&lt;br&gt;
- Develop New Stories: Bring more diverse and engaging narratives to life.
- Enhance Game Features: Improve gameplay mechanics and user experience.
- Maintain Independence: Operate without relying on intrusive ads or external sponsorships.
- Reward Our Supporters: More of the lore (text, images and audio) I produce around the games. Exclusif Poll to choose the pitch of our next game, High resolution and Layered art files.&lt;br&gt;

By contributing via Patreon or Buy Me a Coffee, you become a vital part of our creative process. Every contribution, big or small, propels us forward.&lt;br&gt;

Join us in shaping the future of interactive storytelling.

(Click:&quot;Patreon&quot;)[(gotoURL:&quot;https://www.patreon.com/c/PickYourUniverse&quot;)]
(Click:&quot;Buy Me a Coffee&quot;)[(gotoURL:&quot;https://buymeacoffee.com/pickyouruniverse&quot;)]
&lt;/div&gt;

{
&lt;!-- EndingReset --&gt;
&lt;script&gt;
  localStorage.clear();
  sessionStorage.clear();
&lt;/script&gt;
}

&lt;!--

(set:$currentEnding to 1)
(display:&quot;RestartDonnee&quot;)
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(600);
}, &quot;1000&quot;);
&lt;/script&gt;
}
--&gt;</tw-passagedata><tw-passagedata pid="25" name="CORVAN" tags="" position="1850,125" size="100,100">Moral ambiguity: The “villain” might be the only one trying to fix a dying world.

Corvan was a member of the Hermetic Order of the Sable Rose when he lived in Paris, around 1920.</tw-passagedata><tw-passagedata pid="26" name="BackStoriesDetailsStats" tags="" position="1725,125" size="100,100">1. Plagueborn Refugee
Stats: +1 CON

Item: Ragged plague mask (advantage against disease).

Advantage: Immune to rot/plague-based damage.

Disadvantage: Town guards treat you with suspicion.

Flavor: You survived Mourntide’s Red Fog and fled with scars… and knowledge.

2. Graverobber’s Bastard
Stats: +1 DEX

Item: Rusted lockpick set.

Advantage: Gain bonus loot from tombs and crypts.

Disadvantage: Hated by the Ossuary Knights (attack on sight in some areas).

Flavor: Born among bonepickers, you learned early how to steal from the dead.

3. Apprentice Necromancer
Stats: +1 INT

Item: Blackened bone wand.

Advantage: Know one minor necromantic spell.

Disadvantage: Hunted by Lantern Bearers as a heretic.

Flavor: You studied the art of death until your master vanished into their own spell.

4. Exiled Lantern Tender
Stats: +1 WIS

Item: Dim Lantern of Mourning (detect nearby undead).

Advantage: Undead are slower to attack you.

Disadvantage: Cannot enter holy sites without conflict.

Flavor: You failed in your duty to guide souls and now bear the burden of guilt.

5. Noble Scion of the Pale Court
Stats: +1 CHA

Item: Ancestral ring of authority.

Advantage: Influence nobles and merchants more easily.

Disadvantage: Targeted by revolutionary factions (Bonepickers).

Flavor: Your bloodline traces back to those who rule from the crypts.

6. Last of the Severed
Stats: +1 STR

Item: Severed arm (can be wielded as a brutal weapon).

Advantage: Immune to fear.

Disadvantage: Constantly haunted by visions of Corvan’s ritual.

Flavor: You alone survived the Severance Ritual that broke the Veil.

7. Cultist of the Worm
Stats: +1 INT

Item: Worm-tongue fetish (grants a minor healing ability).

Advantage: Resistant to corruption effects.

Disadvantage: Occasional loss of speech (tongue paralysis).

Flavor: You served the Worm Priests… now you flee their appetite.

8. Grave Singer
Stats: +1 CHA

Item: Bone flute (soothes restless spirits).

Advantage: Gain bonuses when calming/negotiating with the dead.

Disadvantage: Vulnerable to silence spells/effects.

Flavor: Your songs were once sung at every burial. Now they are forgotten.

9. Ashen War Veteran
Stats: +1 CON

Item: Scarred tower shield (resistant to ghost attacks).

Advantage: Bonus defense against spectral enemies.

Disadvantage: Terrible nightmares reduce morale in safe areas.

Flavor: You fought in the Ash Wars, where armies of revenants marched.

10. Street Orphan of Greyglass
Stats: +1 DEX

Item: Shard of Greyglass Mirror (shows hidden doors).

Advantage: Bonus stealth and trap evasion.

Disadvantage: Easily swayed by ghost voices (weak to possession).

Flavor: Raised on the broken streets where even reflections can kill.

11. Pilgrim of the Bleeding Monastery
Stats: +1 WIS

Item: Blood-soaked prayer beads (increase healing).

Advantage: Bonus to healing received.

Disadvantage: Cannot harm priests or monks without penalty.

Flavor: You sought absolution, but the Monastery gave you more questions than answers.

12. Returned from the Veil
Stats: +1 STR

Item: Pale Shroud (once covered your corpse, increases fear resistance).

Advantage: Bonus damage against undead.

Disadvantage: Life drains faster (lower healing efficiency).

Flavor: You died once. Something sent you back… unfinished.</tw-passagedata><tw-passagedata pid="27" name="VELTHORN HOLLOW PLACES" tags="" position="4150,475" size="100,100">1. The Shrouded Well
A moss-clad stone well at the village’s center. A perpetual gray mist seeps from its depths.

Atmosphere: Whispering echoes, damp stones, rolling fog that chills to the bone.

Key Interaction:

Gravebinder hears the names of lost souls drifting up: can bind one spirit to gain a temporary “Shade Chain.”

Plagueborn Refugee backstory: your mask filters noxious vapors and you can wade deeper safely, uncovering a hidden silver talisman.

Stupid choice: peer over the edge without a rope and risk tumbling in (−1 CON, but maybe find a glow-worm guide).

2. The Rotted Market Stalls
Once a bustling bazaar; now half-collapsed stalls draped in ragged tarps.

Atmosphere: Cracked pottery, dried herbs, the faint clink of bones traded like coins.

Key Interaction:

Lantern Bearer: your lantern’s glow coaxers out an invisible vendor: an inhuman figure who trades “bottled sighs” for gossip.

Graverobber’s Bastard: recognized on sight by the local Bonepickers; can bribe a fence for stolen relics (if you pass a DEX check).

Stupid choice: taste a suspicious dried meat jerky (“It’s… moving?”).

3. Widow Marrow’s Tea House
A crooked hut where an ageless crone brews teas that soothe: or provoke: spirits.

Atmosphere: Sweet steam, tinkling bells, low humming as tea infusions swirl with spectral shapes.

Key Interaction:

Pale Scholar: can trade arcane runes to Widow Marrow for a “Memory Draught” that reveals a buried clue.

Returned from the Veil: the tea resonates with your near-death state, granting a vision of Corvan’s first burial.

Stupid choice: add a pinch of “Ghost Pepper” spice and hallucinate for a passage or two.

4. The Weeping Lantern Arch
A pair of rusted lanterns frame the main road’s entrance; one weeps bloody tears.

Atmosphere: Flickering iron, trickles of sanguine liquid pooling on the cobbles.

Key Interaction:

Lantern Bearer: your own lantern speaks to the weeper, offering a bargain: exchange flame for phial of ectoplasm.

Exiled Lantern Tender backstory: you recognize the weeping pattern as your old order’s warning signal: decipher it to avoid a patrol.

Stupid choice: lick the lantern’s tears (“Spicy, but… enlightening?”).

5. The Bone-Stacked Shrine
A small stone altar piled high with skulls and femurs, half-sunken into reeds.

Atmosphere: Dry wind rattling bones, distant chanting that may: or may not: exist.

Key Interaction:

Ossuary Knight: can offer a prayer and gain a “Boneguard Blessing” (+1 to DEF vs. undead).

Ashen War Veteran: you recall fighting on this very ground and find a rusted helmet bearing your old unit’s insignia.

Stupid choice: attempt to balance a skull on your head for “intimidation practice” (CHA check or the skull falls off).

6. The Cracked Reflection Pool
A stagnant pool with a fractured obsidian mirror sunk beneath the surface.

Atmosphere: Glassy water, shards glinting below, half-heard sobs of trapped ghosts.

Key Interaction:

Whispered: use Ghost Step to slip behind the mirror and uncover a hidden alcove.

Street Orphan of Greyglass: the shard’s reflection shows your childhood home’s last moments: gain +1 to local lore checks.

Stupid choice: reach in barefoot and risk spectral frostbite.

7. The Half-Buried Bell Tower
A leaning stone spire whose bell lies submerged in root-tangled earth.

Atmosphere: Deep bronze hum when wind blows, birds nesting in broken windows.

Key Interaction:

Pale Scholar: decipher runes on the bell to silence it: calming a nearby wraith for an ally.

Pilgrim of the Bleeding Monastery: recite a prayer you learned in the Monastery; gain the Bell’s Echo (a 1-time ward).

Stupid choice: tug on the rope recklessly and risk the entire tower shaking loose.

8. Wheelwright’s Workshop
An old wheel shop now run by a one-armed craftsman who carves bone spokes.

Atmosphere: Sawdust, the metallic scent of smithing, half-finished wagon wheels resting on racks.

Key Interaction:

Gravebinder: trade your Chained Relic for a custom “Soulwheel” that grants one free re-bind in combat.

Cultist of the Worm: you spot worm-etched motifs: if you confess your past, he’ll reciprocate with a healing salve.

Stupid choice: spin a half-carved wheel and chase it down the street.

9. Mourning Oak Inn
A creaky tavern built around a massive dead oak; patrons drink under its skeletal branches.

Atmosphere: Low lantern light, mournful lute music, the oak’s branches dripping sap that glows faintly.

Key Interaction:

Exhumed: your uncanny presence earns free ale: but every sip inches you closer to frenzy (WIS save to avoid berserk).

Noble Scion: show your ring of authority to get a private room and overhear conspiratorial nobles.

Stupid choice: try to climb the oak’s branch to “get a better view”: fall risk.

10. The Forgotten Graveyard Gate
An iron arch marking an overgrown cemetery, its gate sealed by a massive bone key.

Atmosphere: Crumbling tombstones, moonlight filtering through knotted branches, crypt doors ajar.

Key Interaction:

Exhumed: your Grave Hunger flares: if you consume a fallen ghoul’s remains, you gain regeneration (but lose 1 CHA).

Grave Singer: sing the Grave Lullaby here to lull restless spirits, revealing hidden crypt entrances.

Stupid choice: knock on every tomb door as if expecting a guest.</tw-passagedata><tw-passagedata pid="28" name="ShroudedWellArrival" tags="NEXUS" position="300,1525" size="100,100">
You step into the village square and find yourself before the **Shrouded Well**: a moss-clad stone rim wreathed in pale mist that seeps from its depths. Cold air drifts upward, carrying distant whispers you can’t quite make out.  
At the very rim, you spot a chipped bone fragment wedged in a crack: its surface etched with miniature tomb‑house silhouettes. This same design appears in the mortuary halls beyond the Graveyard Gate.
What do you do?  
* [[Peer over the edge|WellStupidChoice]]  
* [[Call out into the well|WellDefaultInteraction]]  
* (if: $job is 1)[[Listen for names in the mist|WellJobGravebinder]]  
* (if: $backStory is 1)[[Breathe through your plague mask and wade closer|WellBS1Plagueborn]]  
Return to the [[village&#39;s entry|VelthornHollowOrientation]].</tw-passagedata><tw-passagedata pid="29" name="WellDefaultInteraction" tags="" position="175,1725" size="100,100">(if: visits is 1)[
You call into the well. Your voice echoes, then is swallowed by a faint sigh. Moments later, a single droplet falls: *plink*: onto the rim. You sense that something down there is listening.  

* [[Drop a stone to see how deep it is|WellDepth]]  
* [[Shout a name to see if it responds|WellNameCall]]  
]
(else:)[
Once again, you call into the well. Your voice echoes as before, then is swallowed by a faint sigh. Moments later, a single droplet falls: *plink*: onto the rim. You still can&#39;t shake the feeling that something down there is listening.  

* [[Drop another stone to see how deep it is|WellDepth]]  
* [[Shout a name to see if it responds|WellNameCall]]  
]


</tw-passagedata><tw-passagedata pid="30" name="WellJobGravebinder" tags="" position="300,1725" size="100,100">:: JobGravebinder
As a **Gravebinder**, you feel the tug of forgotten souls. The mist whispers half-formed names. You bind one shade: its form solidifies just long enough to slip you a **Shade Chain**.  
(set: $inventory to it + “Shade Chain”)  
* [[Thank the spirit and step back|ShroudedWellArrival]]  

But the spirit seems to have something else to say...
(click:&quot;something else to say&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
    While binding a mist-shade, the spirit murmurs of a sealed doorway “beneath the stones,” and the fog parts to show a carved bone handle set into the well wall.
* [[Gather your courage and enter|CryptEntry]]  
    ]
(else:)
    [
    Nope... the words don&#39;t seem to mean anything...
    ]

 ]

]</tw-passagedata><tw-passagedata pid="31" name="WellBS1Plagueborn" tags="" position="425,1725" size="100,100">:: BS1Plagueborn
Your cracked plague mask filters away the worst of the vile mist. You wade in ankle-deep, spotting a silver talisman half-buried in mud.  
(set: $inventory to it + “Silver Talisman”)  
* [[Retrieve the talisman and ascend|ShroudedWellArrival]]  </tw-passagedata><tw-passagedata pid="32" name="WellDepth" tags="" position="100,1850" size="100,100">(if: visits is 1)[
You drop a pebble; it falls for several seconds before *plunk*: and yet, you swear you hear a second splash, higher up.  
* [[Try again|WellDepth]]  
* [[Step back: this is unsettling|ShroudedWellArrival]]  
]
(else:)[
You drop another pebble; Once more, it falls for several seconds before *plunk*: but this time, the echo comes back as a hollow click, and a small panel at water level slides open: revealing a damp stair descending into darkness.
* [[Gather your courage and enter|CryptEntry]]  
* [[Step back: this is unsettling|ShroudedWellArrival]]  
]

</tw-passagedata><tw-passagedata pid="33" name="WellNameCall" tags="" position="225,1850" size="100,100">:: WellNameCall
You murmur a random name. A hollow voice returns your own name: no one else knows it.  
* [[Ask “Who are you?”|WellWhoAreYou]]  
* [[Step back nervously|ShroudedWellArrival]]  </tw-passagedata><tw-passagedata pid="34" name="WellWhoAreYou" tags="" position="375,1850" size="100,100">{(set:$string to $heroName)
(set:$len to $string&#39;s length)
(set:$nameExtract1 to (substring: $heroName, 1, 3))
(set:$nameExtract2 to (substring: $heroName, 6, 10))}
&quot;$nameExtract1...$nameExtract2&quot;a whisper drifts up. The mist thickens, and you realize it’s speaking *your* name.  
* [[Demand to know how it knows you|WellDefaultInteraction]]  
* [[Retreat in alarm|ShroudedWellArrival]]  </tw-passagedata><tw-passagedata pid="35" name="WellStupidChoice" tags="ENDING" position="175,1600" size="100,100">{
(set:$introText to &quot;You lean too far: arms flailing: and nearly topple into the well! You catch yourself, heart pounding, as a gout of chilly mist splashes your face. &quot;)
(set:$clickTest to &quot;splashes your face&quot;)
(set:$AttributeTest to $luck)
(set:$SuccessText to &quot;You take a moment to compose yourself...&quot;)
(set:$FailureText to &quot;  You hurt your hand while catching yourself...&quot;)
(set:$clickDamage to &quot;catching yourself&quot;)
(set:$damageType to 1)
(set:$DeathText to &quot;The mist smells faintly of damp earth: and something bitter beneath it. Almost at once your throat constricts, burning as the cold fumes lace your lungs with toxin. You choke and stagger back, vision narrowing to a pinpoint as the poison steals your breath. In a final rasp, the world goes black around you.&quot;)
(set:$currentEnding to 22)
(set:$LinkText to &quot;Steady yourself and step back&quot;)
(set:$FailureLinkText to &quot;You bandage your hand, steady yourself and step back...&quot;)
(set:$Link to &quot;ShroudedWellArrival&quot;)

(set:$xpSuccess to 30)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
You turn around the old well, looking for a good place to lean.
(click:&quot;lean&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [On the ground, you find 50 shards of silver! After pocketing the money, you find the right spot.
    (set:$money to it + 50)
    (display:&quot;MacroPassage&quot;)
    ]
(else:)
    [After some time, you find the right spot.
        (display:&quot;MacroPassage&quot;)
    ]

 ]
 ]
</tw-passagedata><tw-passagedata pid="36" name="RottedMarketStallsArrival" tags="NEXUS" position="1300,1250" size="100,100">:: RottedMarketStallsArrival
You slip into the once-bustling bazaar, now half-collapsed stalls draped in tattered tarps. Dried herbs hang limp, cracked pottery lies overturned, and bleached bone trinkets clatter in the breeze. Somewhere among the shadows, ghostly vendors haggle in hushed tones.
An anxious vendor whispers of ‘the blue lanterns down below’: how their glow has been seen pulsing through the cracks in the old crypt gate, as if beckoning new arrivals to the Necropolis.
What do you do?  
* [[Taste the suspicious jerky|RMSStupidChoice]]  
* [[Browse the wares|RMSDefaultInteraction]]  
* (if: $job is 2)[[Hold your lantern aloft to reveal hidden wares|RMSLanternBearer]]  
* (if: $backStory is 2)[[Blend in with the Bonepickers and seek a fence|RMSBS2Graverobber]]
Return to the [[village&#39;s entry|VelthornHollowOrientation]].
</tw-passagedata><tw-passagedata pid="37" name="WidowMarrowTeaHouseArrival" tags="NEXUS" position="250,2050" size="100,100">:: WidowMarrowTeaHouseArrival
You push open the crooked door of **Widow Marrow’s Tea House** and step into a haze of warm steam and spectral whispers. One curl of steam forms the outline of a vaulted archway draped in phosphorescent moss: the unmistakable gateway to the Ossuary of Echoes. Faint tinkling bells echo around low tables draped in moth-eaten cloths, and the scent of strange herbs mingles with something… otherworldly.  
What do you do?  
* [[Add a pinch of “Ghost Pepper” spice|WMTHStupidChoice]]  
* [[Order a cup of Widow Marrow’s special brew|WMTHDefaultInteraction]]  
* (if: $job is 2)[[Hold your lantern beside the cauldron to read its hidden runes|WMTHLanternBearer]]  
* (if: $backStory is 8)[[Play a note on your bone flute for Widow Marrow|WMTHBS8GraveSinger]]  
* [[Return to the square|VelthornHollowOrientation]]








</tw-passagedata><tw-passagedata pid="38" name="WeepingLanternArchArrival" tags="NEXUS" position="225,1225" size="100,100">:: WeepingLanternArchArrival
You approach the **Weeping Lantern Arch**, where two rusted lanterns frame the gate and drip slow, crimson tears onto the cobblestones below. Through that grate, some say, you can follow the dripping tears all the way to the Mortuary Hall: if you dare tread the silent mortuary corridors beneath the village. The air is thick with the scent of iron and damp stone, and the lanterns’ glow seems to pulse like a heartbeat.  
What do you do?  
* [[Lick a tear to taste its bitterness|WLAStupidChoice]]  
* [[Pass beneath quietly|WLADefaultInteraction]]  
* (if: $job is 2)[[Offer your own lantern’s flame to the weeper|WLALanternBearer]]  
* (if: $backStory is 4)[[Recall your exile as a Lantern Tender and study the pattern of tears|WLABS4ExiledLantern]]  
* [[Return to the square|VelthornHollowOrientation]]







</tw-passagedata><tw-passagedata pid="39" name="BoneStackedShrineArrival" tags="NEXUS" position="550,650" size="100,100">You enter the **Bone-Stacked Shrine**, where piles of skulls and femurs form a jagged altar. A dry wind rattles the bones like sad chimes, and distant, half-heard chanting stirs the air. From time to time, the skull‑chimes ring of their own accord: resonating like the distant echoes heard in the Gallery of Weeping Effigies. A sort of sad and beautiful song if you care for that sort of thing.

What do you do?  
* [[Balance a skull on your head for “intimidation practice”|BSSStupidChoice]]  
* [[Offer a prayer at the altar|BSSDefaultInteraction]]  
* (if: $job is 3)[[Invoke your Boneguard Stance to fortify the shrine’s wards|BSSOssuaryKnight]]  
* (if: $backStory is 9)[[Recognize the war sigil on a femur and claim your old helmet|BSSBS9Veteran]]  
* [[Return to the square|VelthornHollowOrientation]]
(if:$shrineTreasure is true)[
* [[look for the treasure the whispers talked about...|BSSTrap]]
]</tw-passagedata><tw-passagedata pid="40" name="CrackedReflectionPoolArrival" tags="NEXUS" position="1700,1800" size="100,100">
:: CrackedReflectionPoolArrival
You stand before the **Cracked Reflection Pool**, its glassy surface fractured by an obsidian mirror sunken beneath the water. Ghostly sobs echo as reflections twist at the edge of your vision. 
What do you do?  
* [[Reach in barefoot to touch the shards|CRPStupidChoice]]  
* [[Gaze into the fractured mirror|CRPDefaultInteraction]]  
* (if: $job is 4)[[Use Ghost Step to slip behind the mirror’s surface|CRPWhispered]]  
* (if: $backStory is 10)[[Recognize scenes of your childhood in the reflections|CRPBS10Orphan]]  
* [[Return to the square|VelthornHollowOrientation]]










</tw-passagedata><tw-passagedata pid="41" name="HalfBuriedBellTowerArrival" tags="NEXUS" position="1000,3075" size="100,100">You find the **Half-Buried Bell Tower** leaning among twisted roots, its bronze bell lodged deep in the earth. When the wind stirs, a low hum vibrates through both tower and bone.  
What do you do?  
* [[Yank the bell rope recklessly|HBBTStupidChoice]]  
* [[Place a hand on the bell to still its hum|HBBTDefaultInteraction]]  
* (if: $job is 5)[[Decipher the runes etched inside the bell’s rim|HBBTPaleScholar]]  
* (if: $backStory is 11)[[Recite a prayer from your monastic vows|HBBTBS11Pilgrim]]  
* [[Return to the square|VelthornHollowOrientation]]

</tw-passagedata><tw-passagedata pid="42" name="WheelwrightWorkshopArrival" tags="NEXUS" position="1050,1900" size="100,100">
:: WheelwrightWorkshopArrival
You push open the door to the **Wheelwright’s Workshop**, where bone-carved spokes hang from racks and sawdust drifts in lantern light. A one-armed craftsman hammers bone wheels with rhythmic precision.  
What do you do?  
* [[Spin a half-carved wheel and chase it down the street|WWStupidChoice]]  
* [[Inspect the bone spokes closely|WWDefaultInteraction]]  
* (if: $job is 1)[[Offer your Chained Relic for a custom Soulwheel|WWGravebinder]]  
* (if: $backStory is 7)[[Show your Worm Priest fetish to trade for a healing salve|WWBS7Cultist]]  
* [[Return to the square|VelthornHollowOrientation]]

</tw-passagedata><tw-passagedata pid="43" name="MourningOakInnArrival" tags="NEXUS" position="975,2250" size="100,100">
:: MourningOakInnArrival
You step beneath the hollowed branches of the **Mourning Oak Inn**, its common room lit by lanterns dripping luminous sap. Patrons sit in hushed circles, nursing somber ale as the dead wood creaks overhead.  
What do you do?  
* [[Try to climb the oak’s branch for a better view|MOIStupidChoice]]  
* [[Order a drink at the bar|MOIDefaultInteraction]]  
* (if: $job is 6)[[Let your Exhumed presence earn you a free ale: at a cost|MOIExhumed]]  
* (if: $backStory is 6)[[Show your Severed Ritual scar to gain the barkeep’s respect|MOIBS6Severed]]  
* [[Return to the square|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="44" name="ForgottenGraveyardGateArrival" tags="NEXUS" position="1750,2175" size="100,100">You stand before the **Forgotten Graveyard Gate**, an iron arch locked by a massive bone key. Overgrown tombstones lean in silent rows as moonlight filters through knotted branches.  
What do you do?  
* [[Knock on every tomb door as if expecting a guest|FGGStupidChoice]]  
* [[Examine the keyhole for clues|FGGDefaultInteraction]]  
* (if: $job is 4)[[Use Ghost Step to slip past the gate’s wards|FGGWhispered]]  
* (if: $backStory is 12)[[Sense the pull of the Veil on your borrowed life|FGGBS12Returned]]  
* [[Return to the square|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="45" name="RMSStupidChoice" tags="ENDING" position="900,1250" size="100,100">{
(set:$introText to &quot;You bite into the dried meat. It wriggles unexpectedly: then stops.&quot;)
(set:$clickTest to &quot;unexpectedly&quot;)
(set:$AttributeTest to $luck)
(set:$SuccessText to &quot;You take a moment to compose yourself...&quot;)
(set:$FailureText to &quot;  Your stomach churns and you stagger, nauseated. &quot;)
(set:$clickDamage to &quot;nauseated&quot;)
(set:$damageType to 1)
(set:$DeathText to &quot;The moment the twisted fibers of the meat touch your tongue, a rancid heat blossoms in your gut. Your vision blurs as bile rises; a cold sweat coats your skin and your legs give out beneath you. Agony flares in every breath, and with a final heave, your world dissolves into darkness.&quot;)
(set:$currentEnding to 23)
(set:$LinkText to &quot;Steady yourself and return to the stalls&quot;)
(set:$FailureLinkText to &quot;Steady yourself and return to the stalls&quot;)
(set:$Link to &quot;RottedMarketStallsArrival&quot;)

(set:$xpSuccess to 30)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:&quot;MacroPassage&quot;)</tw-passagedata><tw-passagedata pid="46" name="RMSDefaultInteraction" tags="" position="1325,1625" size="100,100">:: RMSDefaultInteraction
You inspect the tables: a spider-eyed goblet here, a knucklebone dice set there. A faint voice whispers prices in your ear, though no one stands nearby. Browsing wares, you also notice something strange... 
* [[Examine the goblet more closely|RMSExamineGoblet]]  
* [[Pick up the bone dice|RMSPickUpDice]]  
* [[Move on: this place gives you the creeps|VelthornHollowOrientation]]

(click:&quot;something strange...&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
    A rotting floorboard under a tarp: pried aside, it uncovers a rusted ring of iron that lifts to reveal a ladder down.
* [[Gather your courage and climb down|CryptEntry]]  
{
    &lt;script&gt;{
	setTimeout(() =&gt; {
 	 gainXp(50);
	}, &quot;1000&quot;);
	&lt;/script&gt;
	}
    ]
(else:)
    [
    Nope. There is nothing here so see... Probably just your imagination.
    ]

 ]



]</tw-passagedata><tw-passagedata pid="47" name="RMSLanternBearer" tags="" position="1450,1500" size="100,100">:: RMSLanternBearer
Holding your lantern high, its glow pushes back shadow. Hidden shelves creak free, revealing a vial of “bottled sighs” and flickering ghost-light candles.  
(set: $inventory to it + “Bottled Sigh”)  
* [[Thank the silent vendor and lower your lantern|RottedMarketStallsArrival]]</tw-passagedata><tw-passagedata pid="48" name="RMSBS2Graverobber" tags="" position="1550,1475" size="100,100">:: RMSBS2Graverobber
You slip into the Bonepickers’ ranks, your reputation as a fellow graverobber granting you safe passage. A fence offers you a deal: trade a spare relic for an obscure map of the Silent Orders’ catacombs.  
(set: $inventory to it + “Crypt Map”)  
* [[Blend back into the crowd|RottedMarketStallsArrival]]</tw-passagedata><tw-passagedata pid="49" name="RMSExamineGoblet" tags="" position="1050,1650" size="100,100">:: RMSExamineGoblet
The goblet’s eye stares back at you, cold and unblinking. Etched runes swirl on its surface: rumor says it can catch a spirit’s last breath.  
* [[Buy the goblet for 3 shards|RMSBuyGoblet]]  
* [[Put it down and step away|RottedMarketStallsArrival]]</tw-passagedata><tw-passagedata pid="50" name="RMSPickUpDice" tags="" position="1200,1475" size="100,100">:: RMSPickUpDice
You pocket the knucklebone dice. They feel unnaturally warm… as if someone: or something: just rolled them.  
(set: $inventory to it + “Knucklebone Dice”)  
* [[Return to the stalls|RottedMarketStallsArrival]]</tw-passagedata><tw-passagedata pid="51" name="RMSBuyGoblet" tags="" position="925,1450" size="100,100">:: RMSBuyGoblet
(if: $gold &gt;= 3)[
  (set: $gold to it - 3)
  You hand over three silver shards. The vendor’s voice hisses approval as the goblet joins your pack.
  (set: $inventory to it + “Spirit-Catcher Goblet”)
][else:[
  You don’t have enough shards. The goblet’s eye seems to mock your empty purse.
]]
* [[Step back from the stall|RottedMarketStallsArrival]]</tw-passagedata><tw-passagedata pid="52" name="WMTHStupidChoice" tags="ENDING" position="0,2225" size="100,100">{
(set:$introText to &quot;You sprinkle an extra shard of “Ghost Pepper” into the brew.&quot;)
(set:$clickTest to &quot;the brew&quot;)
(set:$AttributeTest to $strength)
(set:$SuccessText to &quot;... but you don&#39;t feel much disconfort... must be the kid&#39;s version...&quot;)
(set:$FailureText to &quot;Seconds later, you’re sweating profusely and seeing dancing lights: quite literal, as tiny will-o’-wisps swirl in the steam. &quot;)
(set:$clickDamage to &quot;in the steam&quot;)
(set:$damageType to 2)
(set:$DeathText to &quot;Suddenly, your throat constricts, and a searing pain radiates through your chest. You gasp for air, but each breath feels like fire. The world spins, and darkness creeps in at the edges of your vision. Your knees buckle, and you collapse, the last thing you see is the flickering of the will-o’-wisps dancing above you.&quot;)
(set:$currentEnding to 25)
(set:$LinkText to &quot;Time to stand up and go.&quot;)
(set:$FailureLinkText to &quot;Gasp for breath and steady yourself&quot;)
(set:$Link to &quot;WidowMarrowTeaHouseArrival&quot;)

(set:$xpSuccess to 24)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:&quot;MacroPassage&quot;)</tw-passagedata><tw-passagedata pid="53" name="WMTHDefaultInteraction" tags="" position="100,2225" size="100,100">:: WMTHDefaultInteraction
You request the Widow’s special tea. She nods, sliding you a steaming cup etched with faint sigils. You give her a few silver shards. The first sip brings a soothing warmth: and faint whispers telling of hidden graves nearby.  
(set:$money to it -2)
* [[Sip more and listen to the whispers|WMTHListenWhispers]]  
* [[Thank her and set the cup down|WidowMarrowTeaHouseArrival]]

</tw-passagedata><tw-passagedata pid="54" name="WMTHLanternBearer" tags="" position="275,2250" size="100,100">:: WMTHLanternBearer
You raise your lantern near the bubbling cauldron. Its glow reveals arcane runes carved into the kettle’s base. Widow Marrow hushes. “Ah, you see the true recipe,” she murmurs, and gifts you a vial of **Spirit Infusion**.  
(set: $inventory to it + “Spirit Infusion”)  
* [[Thank her and lower your lantern|WidowMarrowTeaHouseArrival]]</tw-passagedata><tw-passagedata pid="55" name="WMTHBS8GraveSinger" tags="" position="450,2200" size="100,100">:: WMTHBS8GraveSinger
You lift your broken bone flute and play a single, mournful note. The teapot’s steam coalesces into a shimmering apparition: a grateful spirit who hums back a fragment of an old burial hymn.  
(set: $inventory to it + “Fragment of Burial Hymn”)  

But can you play well enough to amaze her ?

(click:&quot;well enough&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
    When you play your bone flute, Widow Marrow leans close and whispers, “The notes awakеn more than ghosts: listen for the crypt’s heartbeat beneath your feet.” Tremors shift a loose floor tile.
    * [[Gather your courage and enter|CryptEntry]] 
    ]
(else:)
    [
    The ghost slowly dissapears. You understand that it is time to go.
    ]

 ]

]

* [[Finish your melody and restoke the hearth|WidowMarrowTeaHouseArrival]]</tw-passagedata><tw-passagedata pid="56" name="WMTHListenWhispers" tags="" position="125,2400" size="100,100">The whispers evolve, they dance around your ears, wanting to say something...
(click:&quot;something&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $charisma &gt;= $diceRoll)
    [
    The whispers grow clearer: “Near the Shrine…A treasure…” The steam swirls letters in the air before fading.  
(set: $journal to it + (a: &quot;Heard clue from Widow’s tea: ‘Beneath the Shrine…A treasure’&quot;+ &quot;\n\n&quot;))
(set:$shrineTreasure to true)
* [[Lower your cup and ponder what you learned...|WidowMarrowTeaHouseArrival]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
    ]
(else:)
    [
    You try to ear but the murmur dissipates...
    * [[Lower your cup and ponder what went wrong...|WidowMarrowTeaHouseArrival]]
    
    ]

 ]
 ]
</tw-passagedata><tw-passagedata pid="57" name="WLAStupidChoice" tags="ENDING" position="25,1400" size="100,100">{
(set:$introText to &quot;You lean forward and let a drop slide onto your tongue. It tastes like rust and grief.&quot;)
(set:$clickTest to &quot;rust and grief&quot;)
(set:$AttributeTest to $luck)
(set:$SuccessText to &quot;You manage to escape unarmed...&quot;)
(set:$FailureText to &quot;You cough, blood-tinged, as the lantern’s lament echoes in your chest&quot;)
(set:$clickDamage to &quot;chest&quot;)
(set:$damageType to 1)
(set:$DeathText to &quot;A burning numbness sears through your veins, spreading from your tongue to your gut in a wave of agony. Your vision blurs; your knees buckle as a poisonous toxin courses through your body. The world tilts and darkens, and the lantern’s final lament fades on your lips as life seeps away.&quot;)
(set:$currentEnding to 21)
(set:$LinkText to &quot;Step back and wipe your mouth&quot;)
(set:$FailureLinkText to &quot;Pick yourself up, step back and wipe your mouth&quot;)
(set:$Link to &quot;WeepingLanternArchArrival&quot;)

(set:$xpSuccess to 30)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:&quot;MacroPassage&quot;)
</tw-passagedata><tw-passagedata pid="58" name="WLADefaultInteraction" tags="" position="150,1400" size="100,100">:: WLADefaultInteraction
You slip under the arch without fanfare. The lanterns weep in mourning as you pass, and you sense they have marked your passage: something in the mist shifts to let you through.  
* [[Move on down the road|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="59" name="WLALanternBearer" tags="" position="275,1400" size="100,100">:: WLALanternBearer
Raising your lantern beside the arch, you merge its flame with the weeper’s glow. The dripping stops, and a vial materializes at the lantern’s base: a **Phial of Ectoplasm**.  
(set: $inventory to it + “Phial of Ectoplasm”)  

Offering your flame (WLALanternBearer), your lantern’s glow not only stops the tears but seems to reveal something else...

(click:&quot;something else...&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
    There! It is faint but, the more you look at it... You get closer and.... there they are! Your sharp eyes didn&#39;t betray you : there are runes on the arch that point down a side-alley drain grate.
* [[Gather your courage and follow the path going down|CryptEntry]]  
* [[Return to the square|VelthornHollowOrientation]]
    ]
(else:)
    [
    No... that must have been a dream.
* [[Pocket the vial and step back|WeepingLanternArchArrival]]
* [[Return to the square|VelthornHollowOrientation]]
    ]
]
 ]



</tw-passagedata><tw-passagedata pid="60" name="WLABS4ExiledLantern" tags="" position="400,1400" size="100,100">:: WLABS4ExiledLantern
The pattern of tears matches the old warning signal of your forgotten order. You decipher it: “Beware the Bonepickers at dusk.” Armed with this knowledge, you avoid a hidden patrol.  
(set: $journal to it + (a: &quot;Decoded weeping pattern: Beware Bonepickers&quot;+ &quot;\n\n&quot;))  
* [[Proceed safely onward|WeepingLanternArchArrival]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="61" name="BSSStupidChoice" tags="ENDING" position="350,825" size="100,100">{
(set:$introText to &quot;You perch a skull atop your head and strike a pose. It wobbles… then crashes to the ground with a hollow *clang*. A nearby rat scurries off, unimpressed. &quot;)
(set:$clickTest to &quot;unimpressed&quot;)
(set:$AttributeTest to $luck)
(set:$SuccessText to &quot;You look at the rat for a moment...&quot;)
(set:$FailureText to &quot;    The moment you lean in, the most ancient skull topples from its perch, as a revengful god. Its hollow cranium connects with your temple in a sickening crack: your vision shatters, blood blooms across your cheek, and a cold void swallows you as your knees buckle beneath the weight of sudden oblivion.&quot;)
(set:$clickDamage to &quot;sudden oblivion&quot;)
(set:$damageType to 2)
(set:$DeathText to &quot;A burning numbness sears through your veins, spreading from your tongue to your gut in a wave of agony. Your vision blurs; your knees buckle as a poisonous toxin courses through your body. The world tilts and darkens, and the lantern’s final lament fades on your lips as life seeps away.&quot;)
(set:$currentEnding to 20)
(set:$LinkText to &quot;Sheepishly retrieve the skull&quot;)
(set:$FailureLinkText to &quot;You wake up a few minutes later, with you head severly bleeding. Sheepishly retrieve the skull and stop messing around...&quot;)
(set:$Link to &quot;BoneStackedShrineArrival&quot;)

(set:$xpSuccess to 30)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:&quot;MacroPassage&quot;)</tw-passagedata><tw-passagedata pid="62" name="BSSDefaultInteraction" tags="" position="475,825" size="100,100">You kneel before the altar and whisper a prayer. 
(if: visits is 1)[
The wind stills, and a single skull rolls forward: its jaw opening to reveal a small cache with some silver shards.
(set:$money to it+35)
]
(else:)[
This time, the bones don&#39;t seem impressed, or they have nothing left to give...
&lt;!-- DON --&gt;
]

* [[Rise and continue|BoneStackedShrineArrival]]</tw-passagedata><tw-passagedata pid="63" name="BSSOssuaryKnight" tags="" position="625,825" size="100,100">You plant your feet and assume Boneguard Stance. 
(if: visits is 1)[
The chanting grows louder, and spectral warding glyphs flare around the altar. You feel your defense hardened against undead assault.  
(set: $strength to it +1)  
But that&#39;s not all: Fortifying the shrine brings spectral warding glyphs to life: but can you decypher them?

&lt;!--start--&gt;

(click:&quot;decypher&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
    If not all the glyphs, you recognize the general meaning, it is a series of directions to follow. After a short stroll, you get to another series of glyphs.
    they trace out a shape on the ground that, when brushed aside, uncovers a spiral staircase of rib bones.
    * [[Gather your courage and take the staircase|CryptEntry]]  
    * [[Return to the square|VelthornHollowOrientation]]
    ]
(else:)
    [
    No. The glyphs meaning remain a mystery to you.
    * [[Rise and continue|BoneStackedShrineArrival]]
    * [[Return to the square|VelthornHollowOrientation]]
    ]

 ]
]

&lt;!--END--&gt;


]
(else:)[
You chant all you can, but the warding glyphs stay silent. Until...
(click:&quot;Until&quot;)[
(display:&quot;diceRollMacro&quot;)
 (live: 3s)[
    (stop:)
(if: $charisma &gt;= $diceRoll)
    [ Some spectral warding glyphs appear in front of you. They move and trace out a shape on the ground that, when brushed aside, uncovers a spiral staircase of rib bones.
    * [[Gather your courage and take the staircase|CryptEntry]]  
    * [[Return to the square|VelthornHollowOrientation]]
    ]
(else:)
    [... no, nothing happens.
    ]

 ]
 ]
]
</tw-passagedata><tw-passagedata pid="64" name="BSSBS9Veteran" tags="" position="750,825" size="100,100">:: BSSBS9Veteran
You spot your old unit’s ash-stained helmet resting among the bones. Donning it, you feel memories of battle surge through you: and nightmares of revenant foes.  
(set: $inventory to it + “Ashen Veteran’s Helmet”)  
* [[Adjust the fit and stand tall|BoneStackedShrineArrival]]</tw-passagedata><tw-passagedata pid="65" name="CRPStupidChoice" tags="ENDING" position="1550,1950" size="100,100">{
(set:$introText to &quot;You step forward and plunge your foot into the cold water… and immediately regret it as spectral frostbite numbs your toes.  &quot;)
(set:$clickTest to &quot;numbs your toes&quot;)
(set:$AttributeTest to $strength)
(set:$SuccessText to &quot;You yank your foot free in an instant: your boot’s leather scorched but your toes unharmed. The spectral chill recedes as mist curls away into the darkness.&quot;)
(set:$FailureText to &quot;You jerk your foot back, but not before icy shards bite into your flesh: pain blossoms across your toes as you stagger, hobbling away with frostbitten agony.&quot;)
(set:$clickDamage to &quot;agony&quot;)
(set:$damageType to 2)
(set:$DeathText to &quot;The icy current sears through your boot and up your leg in an instant. Pain blossoms like frozen daggers along every nerve, and before you can yank your foot free, the spectral frost spreads into your body: cracking bone and freezing your blood. You gasp as the cold steals your breath, and in a final shudder, your vision flickers out like a lantern snuffed by an unseen wind.&quot;)
(set:$currentEnding to 26)
(set:$LinkText to &quot;Put your shoes back and stand up&quot;)
(set:$FailureLinkText to &quot;Withdraw and shake your foot&quot;)
(set:$Link to &quot;CrackedReflectionPoolArrival&quot;)

(set:$xpSuccess to 35)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:&quot;MacroPassage&quot;)</tw-passagedata><tw-passagedata pid="66" name="CRPDefaultInteraction" tags="" position="1675,1950" size="100,100">Leaning over the water, your reflection shatters into dozens of versions of yourself: some dead, some living. A soft sob escapes your lips as you glimpse your fears and hopes entwined. 
(click:&quot;fears and hopes entwined&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $charisma &gt;= $diceRoll)
    [The water seems to understand you... and react. A small ripple brings a health potion to the shore, right between your feet.
    &lt;!-- ADD HEALTH POTION --&gt;
    ]
(else:)
    [The scene is beautiful, but silent, dead. You are not welcomed here.
    ]

 ]
 ]
As the ripples settle, you glimpse distant marble steps beyond the pool: scenes that match the description of the lower levels of the legendary Mirror‑Vault far beneath the Ossuary’s main rotunda of the Necropolis.
* [[Step back, unsettled|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="67" name="CRPWhispered" tags="" position="1800,1950" size="100,100">:: CRPWhispered
You vanish in a swirl of mist and step onto the other side of the mirror. There, a hidden alcove holds a **Silvered Dagger**, perfect for cutting through spiritual bonds.  
(set: $inventory to it + “Silvered Dagger”)  

After close inspection, the alcove has an old and partially rusted door that was conceled. The opening seems to be protected from your abilities. But you can try to pry it open if you have the strengh to do so...

(click:&quot;strengh to do so...&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strengh &gt;= $diceRoll)
    [
After alot of trial and error, you manage to find how to place your body to best push the opening. After the deed is done, you find a narrow tunnel carved into the stone’s underside: leading directly toward vaulted crypt doors.
* [[Gather your courage and open the doors|CryptEntry]]  
* [[Return to the square|VelthornHollowOrientation]]
    ]
(else:)
    [
    No... you just can&#39;t move the door..
* [[Return to the pool’s edge|CrackedReflectionPoolArrival]]
* [[Return to the square|VelthornHollowOrientation]]
    ]
]
 ]


</tw-passagedata><tw-passagedata pid="68" name="CRPBS10Orphan" tags="" position="1925,1950" size="100,100">:: CRPBS10Orphan
In the fractured reflections, you see the alleys of Greyglass and your younger self darting through shadows. For a moment, your heart lifts: and you gain +1 to your charisma.  
(set: $charisma to it + 1)  
* [[Let the memory fade and step back|CrackedReflectionPoolArrival]]</tw-passagedata><tw-passagedata pid="69" name="HBBTStupidChoice" tags="" position="775,3200" size="100,100">:: HBBTStupidChoice
You tug the rope with all your might. The tower shudders, stones crack, and you scamper back just before a cascade of rubble falls where you stood.  

(click:&quot;rubble falls where you stood&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $luck &gt;= $diceRoll)
    [
(set: $health to it - 1)  
* [[Dust yourself off|HalfBuriedBellTowerArrival]]
    ]
(else:)
    [
The tower groans as you yank the rope. Stones crack overhead in warning: too late. A volley of jagged masonry crashes down, smashing your legs and pinning you in an avalanche of rubble. Pain explodes through you as the weight crushes your chest, and the world fades beneath the deafening roar of collapsing stone.
    (set:$currentEnding to 29)
(display:&quot;RestartDonnee&quot;)
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(600);
}, &quot;1000&quot;);
&lt;/script&gt;
}
    ]

 ]
 ]</tw-passagedata><tw-passagedata pid="70" name="HBBTDefaultInteraction" tags="" position="850,3350" size="100,100">:: HBBTDefaultInteraction
You lean your palm against the bell’s cool bronze. The humming stills, and a faint echo remains in your mind: granting you a one-time ward against fear.  
(set: $buff to it + “Bell’s Echo”)  
* [[Step away from the tower|HalfBuriedBellTowerArrival]]</tw-passagedata><tw-passagedata pid="71" name="HBBTPaleScholar" tags="" position="1000,3275" size="100,100">:: HBBTPaleScholar
You trace the runes around the bell’s rim, translating them: The first part of the text is a binding spell to calm restless spirits. With a whisper, you activate the rune: quieting the tower and earning a **Silent Toll** scroll.  
(set: $inventory to it + “Scroll of Silent Toll”)  

You now try to decypher the second part of the text...


(click:&quot;decypher the second part&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
After alot of trial and error, you manage to translate the inscription: “Ring once to summon the dead… twice to open the dead’s door.” When you touch the bell, it trembles, and a root-bound hatch cracks free.
* [[Gather your courage and open the doors|CryptEntry]]  
* [[Return to the square|VelthornHollowOrientation]]
    ]
(else:)
    [
    No... the language here is too complex, impossible to crack..
* [[Tuck the scroll away|HalfBuriedBellTowerArrival]]
* [[Return to the square|VelthornHollowOrientation]]
    ]
]
 ]






</tw-passagedata><tw-passagedata pid="72" name="HBBTBS11Pilgrim" tags="" position="1175,3225" size="100,100">:: HBBTBS11Pilgrim
You kneel and chant a prayer learned in the Bleeding Monastery. The roots retreat slightly, freeing the bell’s arc: and in gratitude, you receive a vial of **Blood of Repentance**.  
(set: $inventory to it + “Blood of Repentance”)  
* [[Rise and continue|HalfBuriedBellTowerArrival]]</tw-passagedata><tw-passagedata pid="73" name="WWStupidChoice" tags="ENDING" position="850,2025" size="100,100">{
(set:$introText to &quot;You grab a wheel and shove off. It careens wildly, knocking over barrels and nearly flattening a cat.&quot;)
(set:$clickTest to &quot;knocking over barrels&quot;)
(set:$AttributeTest to $luck)
(set:$SuccessText to &quot;You take a moment to compose yourself...&quot;)
(set:$FailureText to &quot;  You skitter after it, breathless, broozed and embarrassed.&quot;)
(set:$clickDamage to &quot;broozed&quot;)
(set:$damageType to 1)
(set:$DeathText to &quot;The wheel barrels forward, gathering speed as it slams into a stacked pile of crates. Splinters fly: and before you can shout, the wheel veers back down the aisle and crushes you beneath its iron rim. Your vision tunnels to black as the sharp crack of your spine echoes in the empty workshop.&quot;)
(set:$currentEnding to 25)
(set:$LinkText to &quot;Retrieve the wheel and apologize&quot;)
(set:$FailureLinkText to &quot;Retrieve the wheel and apologize&quot;)
(set:$Link to &quot;WheelwrightWorkshopArrival&quot;)

(set:$xpSuccess to 30)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:&quot;MacroPassage&quot;)</tw-passagedata><tw-passagedata pid="74" name="WWDefaultInteraction" tags="" position="975,2025" size="100,100">:: WWDefaultInteraction
You study the craftsmanship: each bone spoke is etched with warding glyphs. The craftsman nods and offers you a small **Bone Spoke Charm** for safe passage.  
(set: $inventory to it + “Bone Spoke Charm”)  
* [[Thank him and step back|WheelwrightWorkshopArrival]]</tw-passagedata><tw-passagedata pid="75" name="WWGravebinder" tags="" position="1100,2025" size="100,100">:: WWGravebinder
You present your Chained Relic. The craftsman’s eye gleams as he forges it into a **Soulwheel**: a device that grants one free rebinding of an undead in combat.  
(set: $inventory to it + “Soulwheel”)  
* [[Inspect the new contraption|WheelwrightWorkshopArrival]]</tw-passagedata><tw-passagedata pid="76" name="WWBS7Cultist" tags="" position="1225,2025" size="100,100">:: WWBS7Cultist
You reveal the Worm Priest fetish, and the craftsman recoils: then smiles. He offers a pungent **Worm Salve** that heals wounds but tastes faintly of decay.  
You both share a smile.
(set: $inventory to it + “Worm Salve”)  
* [[Tuck it away|WheelwrightWorkshopArrival]]</tw-passagedata><tw-passagedata pid="77" name="MOIStupidChoice" tags="ENDING" position="700,2400" size="100,100">{
(set:$introText to &quot;You attempt to scramble up the oak’s skeletal branch. It starts to make the wrong kind of noise... &quot;)
(set:$clickTest to &quot;kind of noise&quot;)
(set:$AttributeTest to $luck)
(set:$SuccessText to &quot;But you manage to jump back on the ground unarmed...&quot;)
(set:$FailureText to &quot;The branch snaps with a hollow crack, sending you hurtling into the crowded table. &quot;)
(set:$clickDamage to &quot;hurtling&quot;)
(set:$damageType to 1)
(set:$DeathText to &quot;A cascade of wooden boards and heavy tankards crushes you beneath their weight: your ribs shatter, breath leaves you in a single, bone-splintering moment, and the tavern’s startled shouts fade into silence.&quot;)
(set:$currentEnding to 25)
(set:$LinkText to &quot;Pick yourself up.&quot;)
(set:$FailureLinkText to &quot;Pick yourself up and apologize&quot;)
(set:$Link to &quot;MourningOakInnArrival&quot;)

(set:$xpSuccess to 28)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:&quot;MacroPassage&quot;)</tw-passagedata><tw-passagedata pid="78" name="MOIDefaultInteraction" tags="" position="825,2400" size="100,100">:: MOIDefaultInteraction
You order a somber ale. The barkeep slides a frosty mug across: its foam tinted red by sap. With each sip, you feel a fleeting calm wash over you.  
(set: $inventory to it + “Mourning Ale”)  
* [[Nod thanks and look around|MourningOakInnArrival]]</tw-passagedata><tw-passagedata pid="79" name="MOIExhumed" tags="" position="1075,2475" size="100,100">:: MOIExhumed
Your uncanny aura grants you a free pour: but the ale they give you - from under the bar - burns as if alive, and you must succeed on a intelligence test or enter a berserk haze.  
(click:&quot;intelligence test&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
    You manage to steel your mind and sip carefully. You draw a deep breath, clench your teeth, and will the ale’s living flame to calm. The first sip scorches your throat: but you hold fast, locking the berserker hunger in its cage.  
(set: $health to it + 2)  
Your vision clears and your pulse steadies. The barkeep nods in wary respect.  
* [[Press him for rumor-mongering: controlled fury has its perks|MOIRumors]]
Once you are done, you can leave this [[fine establishment|VelthornHollowOrientation]].
    ]
(else:)
    [
    You tilt the mug to your lips and surrender to the savage thirst. The ale’s living fire surges through your veins: muscles bulge, eyes glow with frenzy, and you let out a feral roar.  
    (set: $charisma to it-1)
    Patrons leap to their feet and scramble away as you slam the mug down, smashing it on the table. The barkeep ducks behind the counter, hand on the hilt of his knife.  
* [[You rampage through the common room, but the barkeep tries to stop you|MOICOMBAT]]
    ]

 ]
 ]
* [[Brace yourself and drink|MourningOakInnArrival]]</tw-passagedata><tw-passagedata pid="80" name="MOIBS6Severed" tags="" position="1200,2425" size="100,100">:: MOIBS6Severed
You bare your ritual scar. The barkeep’s eyes widen in reverence; he slides you a secret menu of **Undercity Tidbits**: dishes that restore both body and bone.  
(set: $inventory to it + “Undercity Tidbits”)  
* [[Pocket the menu and savor the moment|MourningOakInnArrival]]</tw-passagedata><tw-passagedata pid="81" name="FGGStupidChoice" tags="ENDING" position="1375,2350" size="100,100">{
(set:$introText to &quot;You rap on each tomb door. Silence answers: until a loose panel slams shut behind you, making you jump.&quot;)
(set:$clickTest to &quot;making you jump&quot;)
(set:$AttributeTest to $charisma)
(set:$SuccessText to &quot;You stand up, picking yourself up, and whatever tried to intimidate you crawls back to where it came from.&quot;)
(set:$FailureText to &quot;The loose panel snaps over your shoulder, slamming you forward into a narrow corridor.&quot;)
(set:$clickDamage to &quot;narrow corridor&quot;)
(set:$damageType to 2)
(set:$DeathText to &quot;Before you can recover, the chamber door behind you swings shut with bone-crushing force, trapping your chest between stone and wood. Your ribs fracture, lungs collapse, and the world goes black as your last breath is squeezed from you in a final, rattling gasp.&quot;)
(set:$currentEnding to 27)
(set:$LinkText to &quot;Step back, heart still racing&quot;)
(set:$FailureLinkText to &quot;Step back, heart racing&quot;)
(set:$Link to &quot;ForgottenGraveyardGateArrival&quot;)

(set:$xpSuccess to 35)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:&quot;MacroPassage&quot;)</tw-passagedata><tw-passagedata pid="82" name="FGGDefaultInteraction" tags="" position="1500,2350" size="100,100">:: FGGDefaultInteraction
You kneel and peer into the keyhole. Inside, you glimpse shifting shapes: an invitation or a warning.  
* [[Try to pick the lock|FGGPickLock]]  
* [[Rise and reconsider|ForgottenGraveyardGateArrival]]</tw-passagedata><tw-passagedata pid="83" name="FGGWhispered" tags="" position="1625,2400" size="100,100">:: FGGWhispered
You blur and pass unseen through the gate’s wards, leaving no trace of your passage: ready to explore the silent graves beyond.  

* [[Proceed into the graveyard|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="84" name="FGGBS12Returned" tags="" position="1775,2400" size="100,100">:: FGGBS12Returned
You feel reality thin, the Veil tugging at your senses: an echo of your return from death. A faint path of shimmering mist outlines a secret crypt entrance.  
(set: $journal to it + (a: &quot;I found a Veil path to a secret crypt’&quot;+ &quot;\n\n&quot;))
* [[Follow the misty path|ForgottenGraveyardGateArrival]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="85" name="CryptEntry" tags="NEXUS" position="2550,3200" size="200,200">:: CryptTunnelEntrance
The hatch closes with a hollow *clang*, and you slip into a claustrophobic tunnel. Your lantern’s form the sole circle of light. It dances over slick stone walls, betraying you sometimes, loosing its form, trying to escape? Somewhere ahead, you hear three distinct things:  
1. A soft *drip… drip… drip* echoing in the dark.  
2. A distant, ragged *breath* that doesn’t match your own.  
3. Faint carvings glowing with pale phosphorescence: runes half-eroded by time.  
Which do you follow?  
* [[Trace the dripping water to its source|TunnelFollowDrips]]  
* [[Move toward the ragged breath|TunnelFollowBreath]]  
* [[Study the glowing runes on the wall|TunnelFollowRunes]]  
* [[Step back: this place already unsettles you|VelthornHollowOrientation]]





















</tw-passagedata><tw-passagedata pid="86" name="MOIRumors" tags="" position="900,2625" size="100,100">:: MOIRumors
The barkeep peeks over the counter, his eyes wary but respectful. “If you’re looking for whispers in this cursed hollow,” he mutters, lowering his voice, “you might heed this:

‘They say the Bell Tower tolls at midnight: though its bell hasn’t rung in decades.  
Foolish souls who climb its broken stairs vanish without a trace.  
Some claim the tower’s roots twist into a hidden crypt, where the first burial lies sealed.  
Bring a light that won’t die, and maybe you’ll find more than bones up there.’  

He glances at your steady stance and offers a crooked smile. “Word is, the lantern flame you carry might just be the key.”  
* [[Thank the barkeep and return to the hearth|MourningOakInnArrival]]  
* [[Tell him you’ll investigate the Bell Tower at midnight|NightHalfBuriedBellTowerArrival]] </tw-passagedata><tw-passagedata pid="87" name="MOICombatVictory" tags="" position="1175,2900" size="100,100">:: MOIRampageVictory
The last patron scrambles from the inn as you bring your fist down with finality. The barkeep slumps to the floor, unconscious but breathing.  
Your bloodlust ebbs, and the world comes back into focus: the sap-dripping lanterns, the scattered tables, the stunned silence.  
&lt;!--(set: $status to it - “Berserk”)  --&gt;
You scoop up your empty mug and nod once to yourself, then stride for the door.  
* [[Leave the Mourning Oak Inn, the echoes of your rage fading behind you|VelthornHollowOrientation]]
</tw-passagedata><tw-passagedata pid="88" name="MOICombatDefeat" tags="ENDING" position="1325,2900" size="100,100">:: 
The barkeep’s knife flicks free and catches you off guard. A sharp pain blooms in your side as you collapse onto the floor, dazed and defeated.  
Patrons rush back in to drag you away, murmuring that some debts can’t be paid with ale.   


{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(600);
}, &quot;1000&quot;);
&lt;/script&gt;
}
(set:$currentEnding to 6)
(display:&quot;RestartDonnee&quot;)</tw-passagedata><tw-passagedata pid="89" name="MOICombatFlee" tags="" position="1450,2900" size="100,100">Your senses snap back for a moment: fear, regret, a sliver of sanity: and you turn on your heel.  
Crashing through tables and startled onlookers, you burst out of the inn into the cold night air.  

Breathing hard, you vanish into the mist, leaving the inn’s doors swinging on broken hinges.  
* [[Regroup in the village square|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="90" name="FGGPickLock" tags="" position="1500,2500" size="100,100">:: FGGPickLock
(if: $inventory contains “Rusted Lockpick Set”)[
  You insert your lockpick. With a satisfying *click*, the gate swings open, revealing moonlit graves.  
  * [[Step through the gate|VelthornHollowOrientation]]
][else:[
  Your tools are missing. The lock remains stubborn as ever.  
]]
* [[Pull back from the gate|ForgottenGraveyardGateArrival]]</tw-passagedata><tw-passagedata pid="91" name="TunnelFollowDrips" tags="" position="2350,3575" size="100,100">:: TunnelFollowDrips
You edge along the damp wall, counting each *drip* as it falls. The sound grows louder, and you round a bend into a vaulted alcove where a thin waterfall trickles from a crack above. Behind the waterfall, you glimpse a mossy stairway spiraling down.  
* [[Step through the water curtain and descend|InnerCryptEntrance]]  
* [[Test the ledge’s grip before you go further|TunnelTestLedge]]</tw-passagedata><tw-passagedata pid="92" name="TunnelFollowBreath" tags="" position="2625,3675" size="100,100">:: TunnelFollowBreath
Your heart hammers as you track the ragged exhale. The corridor rises, and pale mist swirls at the end. There, a collapsed sarcophagus vents cold air: and a cavern beyond.  
* [[Climb onto the lid and peer inside|TunnelPeerSarcophagus]]  
* [[Creep around the sarcophagus toward the cavern|TunnelQuietCreep]]</tw-passagedata><tw-passagedata pid="93" name="TunnelFollowRunes" tags="" position="2875,3525" size="100,100">:: TunnelFollowRunes
You trace the glowing runes along the wall. Under your fingertip, they pulse in sequence: three interlocking loops that tingle with recognition.  
Somewhere in your memory flickers the same pattern: a triple-looped knot of bones and runes are identical to the ones you glimpsed at in the faded mural in the village square: the mark of Magister Corvan’s three burials.  
At the end of the rune-lit corridor, a panel slides open to reveal a narrow passage lit by a single, still-glowing torch.  
* [[Step into the torchlit passage|InnerCryptEntrance]]  
* [[Hesitate: magic this old can be dangerous|CryptEntry]]
</tw-passagedata><tw-passagedata pid="94" name="InnerCryptEntrance" tags="" position="3150,3875" size="100,100">:: InnerCryptEntrance
You emerge into a vast antechamber: vaulted ceilings dripping with moisture, bone reliefs staring down, and the stale echo of your breath. 
Tread carefully: traps could be lurking around every corner!

(click:&quot;traps could be lurking around every corner&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $luck &gt;= $diceRoll)
    [
You manage to cross the chamber unarmed.
Flickering torchlight reveals the **Corvan’s tri-burial sigil** etched high on the far wall: a triple‐looped knot of bones and runes that seems to pulse faintly, as if alive.  
Below it stands a heavy stone door inscribed with that very sigil, its surface worn but unmistakeable. Behind this door lies the Inner Crypt: and what looks like the first of Magister Corvan’s tombs.  
* [[Push the door open and enter|CryptAntechamber]]  
* [[Pause to catch your breath and ready your weapon|CryptPrepare]]
    ]
(else:)
    [
You try to be careful, but at some point, you step on a mosaic tile depicting a skull: only it gives way beneath your foot. 
Can you catch up to something before it is too late?
(click:&quot;catch up&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    You manage to recover before falling completly and cross the chamber unarmed.
Flickering torchlight reveals the **Corvan’s tri-burial sigil** etched high on the far wall: a triple‐looped knot of bones and runes that seems to pulse faintly, as if alive.  
Below it stands a heavy stone door inscribed with that very sigil, its surface worn but unmistakeable. Behind this door lies the Inner Crypt: and what looks like the first of Magister Corvan’s tombs.  
* [[Push the door open and enter|CryptAntechamber]]  
* [[Pause to catch your breath and ready your weapon|CryptPrepare]]
    ]
(else:)
    [
    The floor collapses into a spike-filled pit. You scream once before impaling your spine on jagged bone.
    (set:$currentEnding to 30)
(display:&quot;RestartDonnee&quot;)
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(600);
}, &quot;1000&quot;);
&lt;/script&gt;
}
    ]

 ]
 ]


    ]
]
 ]




</tw-passagedata><tw-passagedata pid="95" name="TunnelTestLedge" tags="" position="2375,3875" size="100,100">:: TunnelTestLedge
You press your palm to the slick stone beside the falls: moss gives under your weight, and the rock shifts. A hidden sinkhole yawns at your feet!

&lt;!--test: (DEX check, DC 12)--&gt;

(click:&quot;A hidden sinkhole yawns at your feet&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
You plant your feet firmly, slow your breath, and the stone holds your weight. The ledge steadies, letting you inch forward along the slick wall.  
* [[Brace yourself and try to steady the ledge|TunnelFollowBreath]]
    ]
(else:)
    [
Your foot slips as you brace; the ledge crumbles. You tumble into darkness, forgotten by light and life. 
    (set:$currentEnding to 30)
(display:&quot;RestartDonnee&quot;)
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(600);
}, &quot;1000&quot;);
&lt;/script&gt;
}
    ]

 ]
 ]

</tw-passagedata><tw-passagedata pid="96" name="TunnelPeerSarcophagus" tags="" position="2575,3900" size="100,100">:: TunnelPeerSarcophagus
You climb up and pry the heavy lid. Inside lies a skeletal form wearing Corvan’s ritual garb: and a sealed trapdoor under its ribcage.  
* [[Open the trapdoor and climb down|InnerCryptEntrance]]  
* [[Jump back in horror|CryptEntry]]</tw-passagedata><tw-passagedata pid="97" name="TunnelQuietCreep" tags="" position="2775,3900" size="100,100">:: TunnelQuietCreep
Silently, you skirt the sarcophagus. Ahead, the cavern’s stone floor is dotted with fresh footprints: and at its far end, a stone door carved with three burial urns beckons.  
* [[Approach the stone door|InnerCryptEntrance]]  
* [[Retreat: those footprints look too fresh|CryptEntry]]</tw-passagedata><tw-passagedata pid="98" name="CryptAntechamber" tags="" position="3300,4175" size="100,100">:: CryptAntechamber
You step into the Inner Crypt’s vaulted chamber. Torches gutter in iron sconces, casting long shadows over an obsidian altar. Embedded in its center rests a pulsating, crimson heart: Corvan’s heart: still beating with necrotic life. The air hums with whispered power.  
What do you do?  
* [[Approach the heart and touch it|CryptHeartDiscovery]]  
* [[Circle the chamber, looking for traps|CryptSearchAround]]  
* [[Flee back to the village|VelthornHollowOrientation]]






















</tw-passagedata><tw-passagedata pid="99" name="CryptPrepare" tags="" position="3775,3900" size="100,100">:: CryptPrepare
You take a moment in the dim torchlight to steady your breathing. Moist air clings to your skin as you strap your weapon to your side and check your gear: your lantern’s flame, your journal of clues, and whatever wards or charms you’ve gathered. The heavy stone door looms before you, its surface etched with Corvan’s tri‑burial sigil.  
* [[Push the door open and confront whatever waits inside|CryptAntechamber]]  
* [[Steal a last glance at the runes and murmur the ward formula|CryptAntechamber]]
</tw-passagedata><tw-passagedata pid="100" name="CryptHeartDiscovery" tags="" position="2775,4125" size="100,100">:: CryptHeartDiscovery
You lay a trembling hand on the heart. It pulses once… twice… then stills. With a crack, it lifts from the altar and hovers before you, veins of shadow trailing in the torchlight.  
The heart speaks in a rasped whisper: “Who dares command my blood?”  
* [[Demand its name|HeartDialogueName]]  
* [[Order it to speak of Corvan’s fate|HeartDialogueFate]]  
* [[Threaten to crush it|HeartDialogueThreat]]  
* [[Flee back to the village|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="101" name="CryptSearchAround" tags="" position="2950,4150" size="100,100">:: CryptSearchAround
You circle the chamber, inspecting broken bones and faded runes. It seems clear: no traps, just the altar and the heart. The pulse of necrotic magic grows stronger the closer you get.  
* [[Approach the heart and touch it|CryptHeartDiscovery]]  
* [[Flee back to the village|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="102" name="HeartConfrontation" tags="TEMP" position="2825,4575" size="100,100">:: HeartConfrontation
**Combat begins!**  
(set: $inCombat to true)  
*After the turn-based battle resolves, jump to either `HeartVictory` or `HeartDefeat`.*  

[[HeartVictory]]</tw-passagedata><tw-passagedata pid="103" name="HeartDialogueName" tags="" position="2700,4275" size="100,100">:: HeartDialogueName
**You:** “Name yourself!”  
**Heart:** “I am the beating core of Magister Corvan… the wellspring of his mortal sins.”  
The heart’s pulse quickens, veins of shadow snapping like whips: ready to defend itself.  
* [[Stand and fight|HeartConfrontation]]  
* [[Flee in terror|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="104" name="HeartDialogueFate" tags="" position="2825,4275" size="100,100">:: HeartDialogueFate
**You:** “Tell me why you live still.”  
**Heart:** “Corvan’s will binds me here: until a second burial frees me.”  
The chest before you thrums with angry life as the heart’s voice echoes off stone walls.  
* [[Prepare to battle the living heart|HeartConfrontation]]  
* [[Step back and reconsider|CryptAntechamber]]</tw-passagedata><tw-passagedata pid="105" name="HeartDialogueThreat" tags="" position="2950,4275" size="100,100">:: HeartDialogueThreat
**You:** “Speak… or I will crush you now.”  
**Heart:** “Foolish mortal: my death would unleash horrors upon your soul.”  
It pulses violently, shards of bone jittering within its chambers.  
* [[Attack the heart|HeartConfrontation]]  
* [[Flee before it can strike|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="106" name="HeartVictory" tags="" position="2800,4750" size="100,100">:: 
You deal the final blow: shattering the heart in a burst of black ichor and bone shards. The chamber goes silent. A final echo: “Remember me…”  
Your strength fails you. You stagger, clutching your chest, and everything goes black.  
* [[…|NecroWake]]</tw-passagedata><tw-passagedata pid="107" name="WakeInNecropolis" tags="" position="3500,4850" size="100,100">:: WakeInNecropolis
You awaken in silver-darkness, confined within a coffin of burnished silver. Damp earth presses at the lid. Faint torchlight flickers from a narrow slit above.  
Somewhere beyond, a distant echoing drip reminds you: your quest is not over.  
* [[Struggle free and emerge into the necropolis|NecropolisEntrance]]</tw-passagedata><tw-passagedata pid="108" name="HeartDefeat" tags="ENDING" position="2975,4725" size="100,100">:: 
The heart’s necrotic pulse overwhelms you. Your vision blurs as shadows coil around your heart, crushing it.  
(set:$currentEnding to 5)
(display:&quot;RestartDonnee&quot;)</tw-passagedata><tw-passagedata pid="109" name="NecropolisEntrance" tags="" position="3500,4975" size="100,100">:: NecropolisEntrance
The coffin lid slides open. You push it aside and step into the silent vaults of the Necropolis, heart still aching: but alive.  
(set: $inCrypt to false)  
The second burial awaits in these depths...  
* [[Press onward into the tombs|NecropolisTunnelEntry]]


Wait a minute... You are not actually dead?
What a pitty. Would you mind pretend while i work on you
Work on me ?
You see... I am a Diener so... I need to embaume you
No, thank you but no. I prefer to stay alive.
But... it is my duty. You wouldn&#39;t want your corpse to rot, would you?
Just get me out of here and we will talk it out</tw-passagedata><tw-passagedata pid="110" name="NecropolisTunnelEntry" tags="" position="3500,5150" size="100,100"></tw-passagedata><tw-passagedata pid="111" name="HeartFlee" tags="" position="3175,4700" size="100,100">
You turn and sprint from the crypt, retracing your steps through winding tunnels until you burst into the night air of Velthorn Hollow.  
Your heart races with both relief and regret.  
* [[Gather your wits in the village square|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="112" name="PayForLight" tags="" position="3300,525" size="100,100">(if: $money &gt;= 1)[
  (set: $money to it - 1)
  **You:** “Anything you want, the silver, the body... just get me out of here!”
  **Brannon:** “Much obliged. Now hold still.”  
  He digs swiftly, lantern glowing, and you emerge.  
  * [[Step out, lantern-lit|MainQuest]]
]
(else:)
[
  **Brannon:** “No coin, ... no gigging for you, friend. I&#39;ll find somebody else to help me...” 
  * [[GameOverStarve]]
]</tw-passagedata><tw-passagedata pid="113" name="RefuseToPay2" tags="" position="3400,400" size="100,100">:: RefuseToPay2
**Brannon:** “Fine, fine… that’ll be two shards then. Can’t work for free.”  
* [[Pay begrudgingly (2 silver)|PayForLight]]  </tw-passagedata><tw-passagedata pid="114" name="PayKnightFee" tags="" position="3500,625" size="100,100">(if: $money &gt;= 5)[
  (set: $money to it - 5)
  **Brannon:** “Ye’ve got coin. Let’s get on with it.”  
  He grunts and frees you.  
  * [[Rise amongst the dead|MainQuest]]
]
(else:)
[
  **Brannon:** “Not enough coin, pal. Back to your grave then. I will find somebody else to help me dig out ol&#39;Corvan&#39;s body.”  
  * [[End: no rescue|GameOverStarve]]
]</tw-passagedata><tw-passagedata pid="115" name="GameOverStarve" tags="ENDING" position="3800,375" size="100,100">The shovel clinks as Brannon pulls back.  
**Brannon (muttering):** “No name, no cloak, no coin: no resurrection for the likes of you.”  
The dirt settles over your chest, and the world goes silent.  
Your lantern’s flame flickers out. 

(set:$currentEnding to 7)
(display:&quot;RestartDonnee&quot;)

</tw-passagedata><tw-passagedata pid="116" name="CorvanDeceptionExplain" tags="" position="2700,1000" size="100,100">
**You:** “I… I needed your help. I thought claiming Corvan’s name would: ”  
**Brannon:** “: get me to shovel you free for free. A clever trick, but it’s on you now.”  
He shakes his head and stands. “Listen up: Corvan vanished ages ago after one of his dark Ritual he was known for. 
Folks say he hid himself in a secret tomb beneath the Ossuary Fields. You owe me for the digging: and for the lie.”  
(set: $CorvanQuest to true)
**Brannon:** “Go on, then! Find that old necromancer: or don’t come cryin’ back to me.”  
Before you can ask him anything else... you still have to figure out [[who you are|Classes]]?</tw-passagedata><tw-passagedata pid="117" name="CorvanDeceptionSilent" tags="" position="2600,1175" size="100,100">
Brannon narrows his eyes. “Silence won’t save you, mage. I want answers :  and I want my coin’s worth.”  
* [[Stammer an excuse|CorvanDeceptionExplain]]
* Remain silent

(cl}ick:&quot;Remain silent&quot;)[
You face Brannon, silent. He muters some words, smiles, and then you fell weak. You fall to the ground and he puts you back [[where you belong|GameOverStarve]]
]</tw-passagedata><tw-passagedata pid="118" name="HaggleKnight" tags="" position="3350,725" size="100,100">:: HaggleKnight
**You:** “Surely an Ossuary Knight’s service is worth less?”  
**Brannon:** “Worth more! I’ll do it for eight, plus your help: take it or leave it.”  
* [[Pay eight silver|PayKnightFeeHigh]]  
* [[Give up and stay buried|GameOverStarve]]</tw-passagedata><tw-passagedata pid="119" name="PayKnightFeeHigh" tags="" position="3525,775" size="100,100">(if: $money &gt;= 8)[
  (set: $money to it - 8)
  **Brannon:** “Here’s your freedom. Next time, be nicer to folk.”  
  * [[Stand and salute|MainQuest]]
][
  **Brannon:** “You really don’t have eight? Then I’m done.”  
  * [[Left to your fate|GameOverStarve]]
]
</tw-passagedata><tw-passagedata pid="120" name="ScholarLore1" tags="" position="3100,1375" size="100,100">:: ScholarLore1
**Brannon:** “First: Corvan himself claimed he sought to separate soul from flesh: to remove the rot of mortality. Said he would study the pure soul.”  
* [[Ask for the other version|ScholarLore2]]  
* [[Offer your opinion now|ScholarOpinion1]]</tw-passagedata><tw-passagedata pid="121" name="ScholarOpinion1" tags="" position="3575,1400" size="100,100">:: ScholarOpinion1
Brannon folds his arms. “So, scholar, you’ve heard Corvan’s own words, the whispers of ambition, and the tales of a broken heart. Tell me: why did he truly perform the Severance Ritual?”  
* [[“He sought pure knowledge, no more.”|ScholarAnswerKnowledge]]  
* [[“He craved godlike power for himself.”|ScholarAnswerPower]]  
* [[“He did it for love, to bring one back.”|ScholarAnswerLove]]  
* [[“Some other reason.”|ScholarAnswerOther]]</tw-passagedata><tw-passagedata pid="122" name="ScholarLore2" tags="" position="3250,1375" size="100,100">:: ScholarLore2
**Brannon:** “Others whispered he wanted to cheat death: build himself a god’s body. They said the Severance was vanity, not science.”  
* [[Ask for more nuance|ScholarLore3]]  
* [[Offer your opinion now|ScholarOpinion1]]</tw-passagedata><tw-passagedata pid="123" name="ScholarLore3" tags="" position="3425,1400" size="100,100">:: ScholarLore3
**Brannon:** “And some say he did it out of love: wanted to save his wife from the grave, so he split his soul to tether her spirit back.”  
* [[Offer your opinion now|ScholarOpinion1]]</tw-passagedata><tw-passagedata pid="124" name="ScholarAnswerKnowledge" tags="" position="3875,1200" size="100,100">:: ScholarAnswerKnowledge
**You:** “His aim was to understand the soul, to advance mortal science.”  
**Brannon:** He scratches his chin. “A noble goal: but dangerous when pride fills the gap.”  
&lt;!--(set: $quest to it + “Consider Corvan’s pride and the cost of knowledge.”)  --&gt;
(set: $journal to it + (a: &quot;Consider Corvan’s pride and the cost of knowledge.&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Brannon digs you out, thoughtful|MainQuest]]
**Brannon:** &quot;Smart as they come. Out you go.&quot;</tw-passagedata><tw-passagedata pid="125" name="ScholarAnswerPower" tags="" position="3725,1300" size="100,100">:: ScholarAnswerPower
**You:** “It was vanity: he wanted to shape his own fate as a god.”  
**Brannon:** He laughs bitterly. “That ambition doom’d him all the same. Watch your own hubris, scholar.”  
(set: $quest to it + “Beware the lure of power.”)  
* [[Brannon frees you solemnly|MainQuest]]</tw-passagedata><tw-passagedata pid="126" name="ScholarAnswerLove" tags="" position="3725,1425" size="100,100">:: ScholarAnswerLove
**You:** “He loved someone too much: bent death itself to bring them back.”  
**Brannon:** His eyes soften. “A tragic motive… but loss makes liars of us all. Keep your heart guarded.”  
&lt;!--(set: $quest to it + “Remember love’s price.”)  --&gt;
(set: $journal to it + (a: &quot;Remember love’s price.&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Brannon lifts you free gently|MainQuest]]</tw-passagedata><tw-passagedata pid="127" name="ScholarAnswerOther" tags="" position="3625,1575" size="100,100">:: ScholarAnswerOther
**You:** “I honestly cannot say, not knowing more about him. Maybe he did it to unite life and death: end the cycle of sorrow for all. Maybe for love or power, or knowledge... or a bit of all of that... yes, probably.”  
**Brannon:** He frowns thoughtfully. “Uncertainty. I wasn&#39;t excepecting that from your kind. You seem more humble than I though. Good for you. A grand dream Magister Corvan had… or a fool’s salvation. Mind you don’t drown in your own hopes.”  
&lt;!--(set: $quest to it + “Contemplate death’s cycle.”) --&gt; 
(set: $journal to it + (a: &quot;Contemplate death’s cycle.&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Brannon finishes the grave and you emerge|MainQuest]]</tw-passagedata><tw-passagedata pid="128" name="ExhumedOfferAll" tags="" position="3175,1575" size="100,100">Begrudgingly, Brannon digs you out.
  **Brannon:** “Now you are free, fullfill your promise! The silver and the body! But the silver first of course!&quot;

  * Respect your word
  * Renage on your promise

(click:&quot;Respect your word&quot;)[
(if: $money &gt; 0)[
  (set: $money to 0)
  **You:** “Yes, I will help and give you my silver shards.” 
  **Brannon:** “Aha, they’re all yours. Get out before I think twice.”  
  * [[Claw your way free|MainQuest]]
]
(else:)
[
  **Brannon:** “Empty pockets? Then you’re staying six feet under.”  
  * [[Accept your fate|GameOverStarve]]
]
]
(click:&quot;Renage on your promise&quot;)[
You face Brannon, defiant. 
**You:** “Now, what are you doing to do, old man?&quot;
He muters some words, smiles, and then you fell weak. You fall to the ground and he puts you back [[where you belong|GameOverStarve]]
]</tw-passagedata><tw-passagedata pid="129" name="ExhumedThreaten" tags="" position="3175,1700" size="100,100">**You:** You glare with a corpse’s hunger.  
He shudders. “All right: Your word that you will help me dig out ol&#39;Corvan and five shards, or I run!”  
* [[Pay the five shards and agree to help|PayKnightFee]]  
* [[Leave him be: no coin and no dig|GameOverStarve]]</tw-passagedata><tw-passagedata pid="130" name="NightVelthornHollowOrientation" tags="NEXUS" position="4200,2375" size="200,200">:: NightVelthornHollowOrientation
Night drapes Velthorn Hollow in obsidian velvet. Lanterns bleed golden pools of light; every shadow trembles with unseen movement. The worn mural’s loops glow faintly in the moonlight, a silent invitation to those who remember.  

* [[NightShroudedWellArrival|NightShroudedWellArrival]]  
* [[NightRottedMarketStallsArrival|NightRottedMarketStallsArrival]]  
* [[NightWidowMarrowTeaHouseArrival|NightWidowMarrowTeaHouseArrival]]  
* [[NightWeepingLanternArchArrival|NightWeepingLanternArchArrival]]  
* [[NightBoneStackedShrineArrival|NightBoneStackedShrineArrival]]  
* [[NightCrackedReflectionPoolArrival|NightCrackedReflectionPoolArrival]]  
* [[NightHalfBuriedBellTowerArrival|NightHalfBuriedBellTowerArrival]]  
* [[NightWheelwrightWorkshopArrival|NightWheelwrightWorkshopArrival]]  
* [[NightMourningOakInnArrival|NightMourningOakInnArrival]]  
* [[NightForgottenGraveyardGateArrival|NightForgottenGraveyardGateArrival]]  

Choose your path: and remember, by night you may see things you cannot unsee.

</tw-passagedata><tw-passagedata pid="131" name="NightShroudedWellArrival" tags="NEXUS" position="8650,700" size="100,100">:: NightShroudedWellArrival
Under the pale moon, the Shrouuded Well exhales silvery mist. Moss‑clad stones glimmer, and tiny runes catch the lantern light.  
What do you do?  
* [[Peer over the edge|NightWellStupidChoice]]  
* [[Call out into the depths|NightWellDefaultInteraction]]  
* (if: $job is 2)[[Hold your lantern aloft to reveal hidden shapes in the fog|NightWellLanternBearer]]  
* (if: $job is 3)[[Strike the rim with your hammer to test its resonance|NightWellOssuaryKnight]]  
* (if: $job is 4)[[Blend into shadows and circle the well silently|NightWellWhispered]]  
* (if: $job is 5)[[Study the runes with scholarly precision|NightWellPaleScholar]]  
* (if: $job is 6)[[Lean close and feel its necrotic pulse|NightWellExhumed]]  
* (if: $backStory is 7)[[Listen for the Worm’s whisper in the damp air|NightWellBS7Cultist]]  
* (if: $backStory is 8)[[Hum a burial hymn and see if the well responds|NightWellBS8Singer]]  
* [[Return to the square|NightVelthornHollowOrientation]]


</tw-passagedata><tw-passagedata pid="132" name="NightRottedMarketStallsArrival" tags="NEXUS" position="4725,850" size="100,100">:: NightRottedMarketStallsArrival
Lanterns glow sickly at the half‑collapsed stalls under the midnight sky. Tattered tarps flap in the breeze, and the scent of damp herbs mingles with old magic. A sealed wooden box stamped with the Pale Court’s crest lies forgotten beneath a tarp, and a lone rat with a bone earring scuttles near your boots.  
What do you do?  
* [[Open the Pale Court box|NightRMSOpenBox]]  
* [[Follow the bone‑eared rat|NightRMSFollowRat]]  
* (if: $job is 2)[[Hold your lantern high to reveal ghostly runes on the tarpaulin|NightRMSLanternBearerEcho]]  
* [[Return to square|NightVelthornHollowOrientation]]






</tw-passagedata><tw-passagedata pid="133" name="NightWidowMarrowTeaHouseArrival" tags="NEXUS" position="6450,825" size="100,100">:: NightWidowMarrowTeaHouseArrival
Moonlight filters through warped rafters as you slip into Widow Marrow’s Tea House at midnight. Steam curls in ghostly tendrils around low tables, and the cuckoo clock on the wall chirps at odd intervals: each time calling out a name, some familiar, some utterly foreign. Behind the counter, a broken hourglass drips black sand upward: each grain a memory slipping back into the world.  
What do you do?  
* [[Touch the black sand in the hourglass|NightWMTHHourglassFlash]]  
* [[Order a cup of her spectral brew|NightWMTHOrderTea]]  
* [[Listen to the cuckoo clock’s next name|NightWMTHListenClock]]  
* (if: $job is 2)[[Raise your lantern’s glow to reveal scratch marks on the floor|NightWMTHLanternTenderEcho]]  
* (if: $backStory is 4)[[Slip behind the counter to search for hidden texts|NightWMTHBS4ExiledLantern]]  
* [[Step back into the square|NightVelthornHollowOrientation]]












</tw-passagedata><tw-passagedata pid="134" name="NightWeepingLanternArchArrival" tags="NEXUS" position="7775,50" size="100,100">:: NightWeepingLanternArchArrival
Moonlight silver‑washes the Weeping Lantern Arch. Two rusted lanterns drip slow, crimson tears onto the cobblestones. Across the street, a hooded watcher counts each drop into a silver bowl with a solemn care. On the base of one lantern, you notice a faint carving: “Only the heart can still the tears.”  
What do you do?  
* [[Speak softly to the hooded watcher|NightWLATalkWatcher]]  
* [[Trace the faint carving on the lantern base|NightWLATraceInscription]]  
* (if: $job is 5)[[Decipher the ward formula hidden in the motto|NightWLAPaleScholarEcho]]  
* [[Return to the square|NightVelthornHollowOrientation]]








</tw-passagedata><tw-passagedata pid="135" name="NightBoneStackedShrineArrival" tags="NEXUS" position="7525,825" size="100,100">:: NightBoneStackedShrineArrival
Under a canopy of stars, the Bone‑Stacked Shrine creaks as if alive. Every so often, a single skull or femur slides off the pile, as though beckoning you to add: or remove: a piece. Beneath one femur you spot a scrap of parchment: a soldier’s letter home, its ink smeared but readable.  
What do you do?  
* [[Read the soldier’s letter|NightBSSReadLetter]]  
* [[Add or remove a bone from the altar|NightBSSTinkerBones]]  
* (if: $job is 9)[[Inspect the handwriting: does it match your own scarred script?|NightBSSAshWarVeteranEcho]]  
* [[Return to the square|NightVelthornHollowOrientation]]




</tw-passagedata><tw-passagedata pid="136" name="NightCrackedReflectionPoolArrival" tags="NEXUS" position="7625,1650" size="100,100">:: NightCrackedReflectionPoolArrival
The moonlight casts fractured patterns across the Cracked Reflection Pool. Its obsidian mirror lies just beneath the water’s surface, rippling with every breath of wind. You notice smooth pebbles at the edge and faint muddy handprints half‑submerged.  
What do you do?  
* [[Toss a pebble into the pool|NightCRPTossPebble]]  
* [[Stand perfectly still and watch your reflection|NightCRPWatchReflection]]  
* [[Listen for hidden giggles in the dark|NightCRPListenGiggle]]  
* [[Return to the square|NightVelthornHollowOrientation]]

</tw-passagedata><tw-passagedata pid="137" name="NightHalfBuriedBellTowerArrival" tags="NEXUS" position="8575,1975" size="100,100">:: NightHalfBuriedBellTowerArrival
Moonlight glints on the half‑buried door of the Bell Tower, its roots twisting like veins. You notice an old monk kneeling at the base, drizzling honey over the roots and murmuring prayers.  
What do you do?  
* [[Rap thrice on the door|NightHBBTRapThrice]]  
* [[Watch the monk and listen to his prayers|NightHBBTWatchMonk]]  
* [[Gently push on the door to test for weakness|NightHBBTDefaultInteraction]]  
* [[Return to the square|NightVelthornHollowOrientation]]
* (if: $backStory is 6)[[Your severance scar starts to react|NightHBBTLastOfSeveredEcho]]

* [[Try to push the door open with force|NightHBBTPushDoor]]  
* [[Speak the chant the monk was whispering|NightHBBTChant]]  
</tw-passagedata><tw-passagedata pid="138" name="NightWheelwrightWorkshopArrival" tags="NEXUS" position="9225,3100" size="100,100">:: NightWheelwrightWorkshopArrival
The Wheelwright’s Workshop stands silent under the moonlight, its walls lined with bone‑rimmed wheels and half‑finished carvings. Among them, a half‑carved statuette catches your eye: its face unmistakably Corvan’s, but its body that of a child. The aged craftsman leans on his workbench, watching you with tired eyes.  
What do you do?  
* [[Examine the half‑carved statuette|NightWWWExamineStatuette]]  
* [[Ask about the “soul chariot” he once built|NightWWWInquireSoulChariot]]  
* [[Search the workshop for hidden compartments|NightWWWSearchWorkshop]]  
* (if: $job is 7)[[Touch the statuette’s worm‑etched veins|NightWWWCultistEcho]]  
* [[Return to the square|NightVelthornHollowOrientation]]










</tw-passagedata><tw-passagedata pid="139" name="NightMourningOakInnArrival" tags="NEXUS" position="7075,3425" size="100,100">:: NightMourningOakInnArrival
The Mourning Oak Inn’s great dead tree looms overhead, its sap‑dripped branches casting dancing shadows in the lantern light. Patrons sit in hushed clusters, mugs catching the amber sap which grants fleeting visions of the departed. High above, rafters creak as the oak’s sap drips into a half‑empty mug, and you spot a blood‑soaked scrap of parchment tucked into a crook in the wood.  
What do you do?  
* [[Climb up to retrieve the parchment|NightMOIClimbParchment]]  
* [[Order a sap‑laced ale from the barkeep|NightMOIDefaultInteraction]]  
* (if: $job is 5)[[Examine the parchment’s seal: does it bear your family crest?|NightMOINobleScionEcho]]  
* [[Step back into the square|NightVelthornHollowOrientation]]
</tw-passagedata><tw-passagedata pid="140" name="NightForgottenGraveyardGateArrival" tags="NEXUS" position="5600,2375" size="100,100">:: NightForgottenGraveyardGateArrival
The iron arch of the Forgotten Graveyard Gate looms under moonlight, its bars entwined with gnarled roots. Nearby, an overturned tombstone bears the name “Corvan” with dates long before his famed Severance. A single key dangles from a root above, glinting with dew.  
What do you do?  
* [[Examine the overturned tombstone|NightFGGTombstoneExamine]]  
* [[Press the stone and listen|NightFGGPressStone]]  
* [[Retrieve the key from the root|NightFGGRetrieveKey]]  
* [[Return to the square|NightVelthornHollowOrientation]]
</tw-passagedata><tw-passagedata pid="141" name="NightWellStupidChoice" tags="" position="8950,575" size="100,100">:: NightWellStupidChoice
You lean too far: arms flailing: and nearly topple in! You catch yourself on a slick stone, heart pounding.  

(click:&quot;heart pounding&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $luck &gt;= $diceRoll)
    [
(set: $health to it - 1)  
* [[Regain balance and step back|NightShroudedWellArrival]]
    ]
(else:)
    [
The slick stone shifts beneath your grip and your fingers lose purchase. You plummet into the well’s depths, tumbling through frigid darkness. Each impact jars your bones until at last the cold water claims you: and the world goes silent.
    (set:$currentEnding to 30)
(display:&quot;RestartDonnee&quot;)
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(600);
}, &quot;1000&quot;);
&lt;/script&gt;
}
    ]

 ]
 ]</tw-passagedata><tw-passagedata pid="142" name="NightWellDefaultInteraction" tags="" position="9200,600" size="100,100">:: NightWellDefaultInteraction
You call into the well. Your voice echoes, then is swallowed. Moments later, a faint splash returns: too rhythmic to be random.  
* [[Drop a stone to gauge depth|NightWellWellDepth]]  
* [[Whisper a name and wait for an answer|NightWellWellNameCall]]</tw-passagedata><tw-passagedata pid="143" name="NightWellLanternBearer" tags="" position="8550,1000" size="100,100">:: NightWellLanternBearer
Your lantern’s flame pushes back the mist, revealing ghostly shapes swirling at the rim. One solidifies into a pale fisherman pointing downward: then vanishes.  
(set: $journal to it + (a: &quot;A Fisherman’s spirit pointed down.” &quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Follow the silent hint|NightWellJournalHintFollow]]  
* [[Lower your lantern|NightShroudedWellArrival]]</tw-passagedata><tw-passagedata pid="144" name="NightWellOssuaryKnight" tags="" position="8825,1075" size="100,100">:: NightWellOssuaryKnight
You strike the rim with your sanctified hammer. The impact vibrates through the runes and dislodges a small **Bone Shard** from the stone.  
(set: $inventory to it + “Bone Shard”)  
* [[Pocket the shard|NightShroudedWellArrival]]</tw-passagedata><tw-passagedata pid="145" name="NightWellWhispered" tags="" position="9025,1075" size="100,100">:: NightWellWhispered
You melt into the fog, circling the well’s edge. Soft footsteps lead you to a loose flagstone.  
* [[Prise up the slab|NightTunnelEntrance]]  
* [[Return to view|NightShroudedWellArrival]]</tw-passagedata><tw-passagedata pid="146" name="NightWellPaleScholar" tags="" position="9050,1325" size="100,100">:: NightWellPaleScholar
You trace the runes: “He who seeks the heart must look below.” Beneath the inscription, a hidden latch waits.  
* [[Pull the latch|NightWellHiddenLatch]]  
* [[Note the phrase and step back|NightShroudedWellArrival]]</tw-passagedata><tw-passagedata pid="147" name="NightWellExhumed" tags="" position="9200,1275" size="100,100">:: NightWellExhumed
The well’s necrotic pulse matches your own. You feel a surge of **Grave Hunger** stirring within.  
&lt;!--(set: $status to it + “GraveHunger”)  --&gt;
(click:&quot;Grave Hunger&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
    * [[Rein in the hunger|NightShroudedWellArrival]]  
    ]
(else:)
    [
    * [[Succumb and reach in|NightWellExhumedReach]]
    ]

 ]
 ]

</tw-passagedata><tw-passagedata pid="148" name="NightWellBS7Cultist" tags="" position="9325,1175" size="100,100">:: NightWellBS7Cultist
You whisper the Worm’s invocation. In the damp hush you hear: “Blood of the fallen grants passage.”  
(set: $journal to it + (a: &quot;The Blood of the fallen grants passage.” &quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Draw your own blood on the rim|NightWellDrawBlood]]  
* [[Ignore the voice|NightShroudedWellArrival]]

</tw-passagedata><tw-passagedata pid="149" name="NightWellBS8Singer" tags="" position="9425,1050" size="100,100">:: NightWellBS8Singer
You hum your burial hymn. The mist vibrates in harmony, and a submerged step surfaces at the well’s base.  
* [[Descend the step|NightTunnelEntrance]]  
* [[Stop humming|NightShroudedWellArrival]]</tw-passagedata><tw-passagedata pid="150" name="NightTunnelEntrance" tags="NEXUS" position="4925,2475" size="200,200">You descend the hidden stair from the well into a narrow, damp tunnel. The lantern light shudders over slick stone walls, and you hear distant drips and distant echoes. Somewhere ahead, three paths beckon in the dark: each promising secrets or peril.  
* [[Follow the dripping water sound|TunnelFollowDrips]]  
* [[Track the faint ragged breathing|TunnelFollowBreath]]  
* [[Trace the glowing rune fragments on the walls|TunnelFollowRunes]]  
* [[Climb back up to the well|NightShroudedWellArrival]]
</tw-passagedata><tw-passagedata pid="151" name="NightWellWellDepth" tags="" position="9250,800" size="100,100">:: NightWellWellDepth
You drop a pebble: drip… drip… then a second splash, higher up. Something moves below.  
* [[Try again|NightWellDefaultInteraction]]  
* [[Step back: the well feels alive|NightShroudedWellArrival]]</tw-passagedata><tw-passagedata pid="152" name="NightWellWellNameCall" tags="" position="9375,650" size="100,100">:: NightWellWellNameCall
You whisper a name. A hollow voice returns it: one no living soul should know.  
* [[Demand “Who are you?”|NightWellWellWhoAreYou]]  
* [[Retreat in alarm|NightShroudedWellArrival]]</tw-passagedata><tw-passagedata pid="153" name="NightWellWellWhoAreYou" tags="" position="9425,825" size="100,100">:: NightWellWellWhoAreYou
“…Vale…” the well breathes your name. The runes flare faintly, as if inviting you closer.  
* [[Press your ear to the stone|NightWellDefaultInteraction]]  
* [[Step back to safety|NightShroudedWellArrival]]</tw-passagedata><tw-passagedata pid="154" name="NightWellJournalHintFollow" tags="" position="8675,1150" size="100,100">:: NightWellJournalHintFollow
You notice a sunken flagstone at water level: a hidden stair leads down.  
* [[Prise up the stone and descend|NightTunnelEntrance]]  
* [[Step back|NightShroudedWellArrival]]</tw-passagedata><tw-passagedata pid="155" name="NightWellHiddenLatch" tags="" position="8975,1475" size="100,100">:: NightWellHiddenLatch
A secret panel swings open, revealing a coiled rope descending into darkness.  
* [[Climb down the rope|NightTunnelEntrance]]  
* [[Close it again|NightShroudedWellArrival]]</tw-passagedata><tw-passagedata pid="156" name="NightWellExhumedReach" tags="" position="9300,1425" size="100,100">:: NightWellExhumedReach
Driven by ravenous need, you plunge your hand into the mist. You grasp something cold and pulsing: then recoil as it snaps back.  
(set: $health to it - 2)  
* [[Stagger back|NightShroudedWellArrival]]</tw-passagedata><tw-passagedata pid="157" name="NightWellDrawBlood" tags="" position="9450,1350" size="100,100">:: NightWellDrawBlood
A drop of your blood falls onto the runes. The mist parts to reveal a narrow arch at the base.  
* [[Step into the arch|NightTunnelEntrance]]  
* [[Bandage your finger|NightShroudedWellArrival]]</tw-passagedata><tw-passagedata pid="158" name="NightRMSOpenBox" tags="" position="4525,1050" size="100,100">:: NightRMSOpenBox
You slide aside the wax seal and lift the lid. Inside rests a single quill and a smudge of red wax on folded parchment: evidence of a noble’s secret correspondence with Corvan.  
(set: $inventory to it + “Corvan Dispatch”)  
* [[Stow the dispatch|NightRottedMarketStallsArrival]]</tw-passagedata><tw-passagedata pid="159" name="NightRMSFollowRat" tags="" position="4700,1225" size="100,100">:: NightRMSFollowRat
The rat darts beneath a broken stall and pauses at a loose floorboard. It chitters, urging you forward.  
* [[Prise up the board and follow|NightArchiveEntrance]]  
* [[Step back: this feels too odd|NightRottedMarketStallsArrival]]



:: NightOfferTruth2
   (Alternative truth exchange for more lore)

:: NightOfferLie2
   (Alternative lie exchange)





:: NightLibrarianFarewell
(If you return to the librarian with knowledge)
**Librarian:** “You’ve learned much. Now go, lest the Archive devour your mind.”  
* [[Bow and depart|NightTunnelEntrance]]
</tw-passagedata><tw-passagedata pid="160" name="NightRMSLanternBearerEcho" tags="" position="5025,975" size="100,100">:: NightRMSLanternBearerEcho
Your lantern’s flame flares, and ghostly words glow on the tarpaulin: “Light the way, and I will follow.” A chill wind stirs, as if someone: or something: wants you to lead onward.  
(set: $flags to it + “RMSGuidedByGhost”)  
* [[Lower your lantern and consider your next move|NightRottedMarketStallsArrival]]</tw-passagedata><tw-passagedata pid="161" name="NightWMTHHourglassFlash" tags="" position="6100,1150" size="100,100">:: NightWMTHHourglassFlash
You let a grain of black sand slip through your fingers. In that moment, your vision blurs and you witness Corvan’s final moments in his library: candlelight flickering across leather‑bound tomes, his fingers stained with ink as he scrawls a final mad incantation. Then the memory shatters, leaving only silence.  
(set: $journal to it + (a: &quot;I had a vision of Corvan’s last library moments&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Gasp and step back|NightWidowMarrowTeaHouseArrival]]
</tw-passagedata><tw-passagedata pid="162" name="NightWMTHOrderTea" tags="" position="6350,1100" size="100,100">:: NightWMTHOrderTea
You request Widow Marrow’s midnight blend. She pours steaming dark liquid into a cracked porcelain cup. The first sip brings a whisper of “Below the hearth,” as steam shapes the words in the air.  
(set: $journal to it + “Heard clue: below the hearth”)  
* [[Thank her and ponder the hint|NightWidowMarrowTeaHouseArrival]]</tw-passagedata><tw-passagedata pid="163" name="NightWMTHListenClock" tags="" position="6425,1250" size="100,100">:: NightWMTHListenClock
You focus on the cuckoo clock. At the next chime it cries out “Eloin”: a name you recognize from whispered lore as Corvan’s first apprentice. The clock’s hands spin once backward in eerie unison.  
(set: $journal to it + (a: &quot;The name of Corvan&#39;s first apprentice was Eloin&quot;+ &quot;\n\n&quot;))
* [[Step away, unsettled|NightWidowMarrowTeaHouseArrival]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="164" name="NightWMTHLanternTenderEcho" tags="" position="6550,1250" size="100,100">:: NightWMTHLanternTenderEcho
You raise your lantern; its warm glow reveals faint scratch marks on the floorboards behind the counter: exactly where forbidden texts were once smuggled out. A loose plank creaks underfoot.  
(set: $journal to it + “Discovered secret tunnel route”)  
* [[Pry up the plank and reveal a trapdoor|NightWMTHRevealTrapdoor]]  
* [[Lower your lantern and step back|NightWidowMarrowTeaHouseArrival]]</tw-passagedata><tw-passagedata pid="165" name="NightWMTHBS4ExiledLantern" tags="" position="6825,1000" size="100,100">:: NightWMTHBS4ExiledLantern
Flashing your Lantern Tender’s badge, you slip behind the counter. You discover a hidden ledger of smuggled scriptures: each entry signed in Corvan’s own hand.  
(set: $inventory to it + “Corvan’s Smuggled Grimoire Page”)  
* [[Pocket the page and exit|NightWidowMarrowTeaHouseArrival]]</tw-passagedata><tw-passagedata pid="166" name="NightWLATalkWatcher" tags="" position="7550,300" size="100,100">:: NightWLATalkWatcher
You cross the street and kneel beside the hooded figure. In a voice like rustling silk, he murmurs, “When the tears cease, the shrine awakens.” He bows, then fades into the mist, leaving the silver bowl to clatter quietly on the stones.  
(set: $journal to it + (a: &quot;A hooded figure told me: “When the tears cease, the shrine awakens.” &quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Return to the arch|NightWeepingLanternArchArrival]]</tw-passagedata><tw-passagedata pid="167" name="NightWLATraceInscription" tags="" position="7850,300" size="100,100">:: NightWLATraceInscription
You kneel beneath the weeping lantern and trace the words “Only the heart can still the tears.” The carving shudders under your fingertip: and for a heartbeat the lantern’s tears stop falling, then resume in a heavy, measured rhythm. A hidden grate at the arch’s foot shifts as though inviting you in.  
* [[Prise up the grate|NightWLAGratePassage]]  
* [[Step back|NightWeepingLanternArchArrival]]</tw-passagedata><tw-passagedata pid="168" name="NightWLAPaleScholarEcho" tags="" position="8025,275" size="100,100">:: NightWLAPaleScholarEcho
You study the phrasing as a Pale Scholar. In the interlocking letters you discern half of a quenching–ward formula: “Blood bind flame, heart hush tears.” Memorizing it, you realize this spell could calm a guardian’s rage.  
(set: $inventory to it + “Half‑Formula Scroll”)  
* [[Tuck the formula away|NightWeepingLanternArchArrival]]</tw-passagedata><tw-passagedata pid="169" name="NightBSSReadLetter" tags="" position="8000,1125" size="100,100">:: NightBSSReadLetter
You unfold the ash‑smudged parchment and read:  
&gt; “I watched him there: Magister Corvan: split soul and flesh beneath these stones. I trembled, knowing I could not stop him.”  
(set: $journal to it + (a: &quot;I found a soldier’s confession of Corvan’s ritual&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Fold the letter and step back|NightBoneStackedShrineArrival]]
</tw-passagedata><tw-passagedata pid="170" name="NightBSSTinkerBones" tags="" position="7475,1125" size="100,100">:: NightBSSTinkerBones
You lift a femur and replace it with a rib. The chimes rattle out three slow notes: then one. A hidden cavity opens in the altar’s base, revealing a **Bone key**.  
(set: $inventory to it + “Bonekey”)  
* [[Pocket the Bonekey|NightBoneStackedShrineArrival]]
</tw-passagedata><tw-passagedata pid="171" name="NightBSSAshWarVeteranEcho" tags="" position="7700,1150" size="100,100">:: NightBSSAshWarVeteranEcho
You study the soldier’s scrawl: it matches the handwriting of your own war‑torn letters, written long ago under a different name. A wave of memories crashes over you.  
(set: $journal to it + (a: &quot;I realized I witnessed Corvan’s ritual, long ago&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Gather yourself and step back|NightBoneStackedShrineArrival]]</tw-passagedata><tw-passagedata pid="172" name="NightCRPTossPebble" tags="" position="7550,1925" size="100,100">:: NightCRPTossPebble
You fling a pebble; the water’s surface holds the ripple mid‑air. In that frozen moment, you glimpse Corvan’s silhouette descending an impossibly long stone stair beneath the pool. Then time snaps back and the water settles.  
(set: $journal to it + “Vision: Corvan’s hidden stair”+ &quot;\n\n&quot; )  
* [[Step back and ponder|NightCrackedReflectionPoolArrival]]</tw-passagedata><tw-passagedata pid="173" name="NightCRPWatchReflection" tags="" position="7675,1925" size="100,100">:: NightCRPWatchReflection
You stand motionless. Your mirrored image shifts: your features blur and reform, and you see yourself draped in Corvan’s robes. The vision fades, leaving you breathless and unsettled.  
(set: $journal to it + “Reflection: past life in Corvan’s robes” )  
* [[Step away from the pool|NightCrackedReflectionPoolArrival]]</tw-passagedata><tw-passagedata pid="174" name="NightCRPListenGiggle" tags="" position="7800,1925" size="100,100">:: NightCRPListenGiggle
A child’s soft giggle echoes from the water’s edge. You crouch and sift through the mud, finding a small iron key half‑buried beneath silt.  
(set: $inventory to it + “Rusty Iron Key”)  
* [[Pocket the key|NightCrackedReflectionPoolArrival]]</tw-passagedata><tw-passagedata pid="175" name="NightHBBTRapThrice" tags="" position="8150,2250" size="100,100">:: NightHBBTRapThrice
You rap three solemn knocks on the root‑strewn door. From beneath your feet comes a faint, harmonious chime: not the bell above, but hidden bronze plates vibrating in concert.  
(set: $journal to it + (a: &quot;I heard hidden bronze chime beneath tower” &quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
You rap three solemn knocks, once again. This time, beneath your feet, you hear a faint chime of hidden bronze plates… then a sharp crack. The earth trembles.  
* [[Step back quickly|NightHalfBuriedBellTowerArrival]]  
* [[Press on despite the tremor|NightHBBTAfterKnock]]</tw-passagedata><tw-passagedata pid="176" name="NightHBBTWatchMonk" tags="" position="8525,2325" size="100,100">:: NightHBBTWatchMonk
The monk pauses his offering, eyes closed.  
**Monk:** “This tower weeps for its sins. Only sweetness soothes its sorrow.”  
He offers you the unspent honey and beckons you to join his ritual.  
(set: $inventory to it + “Blessed Honey”)  
* [[Accept the honey and bow|NightHalfBuriedBellTowerArrival]]  
* [[Decline and step back|NightHalfBuriedBellTowerArrival]]</tw-passagedata><tw-passagedata pid="177" name="NightHBBTDefaultInteraction" tags="" position="8775,2250" size="100,100">:: NightHBBTDefaultInteraction
You press gently on the door. The roots groan, and a hidden seam parts slightly: just enough to slip a finger through.  
* [[Wriggle the door open|NightTunnelEntrance]]  
* [[Close it carefully|NightHalfBuriedBellTowerArrival]]</tw-passagedata><tw-passagedata pid="178" name="NightWWWExamineStatuette" tags="" position="9025,3350" size="100,100">:: NightWWWExamineStatuette
You lift the statuette from its rack. The child’s form is exquisitely detailed; Corvan’s likeness in the face is eerie. Worm‑shaped veins curl along its limbs.  
In the back, some writing in a language you don&#39;t understand:&quot;Le temps d&#39;avant. L&#39;innocence.&quot;
(set: $journal to it + (a: &quot;I saw a Corvan‑child statuette with Worm‑shaped veins. It had some weird writings on it.&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Place it back gently|NightWheelwrightWorkshopArrival]]</tw-passagedata><tw-passagedata pid="179" name="NightWWWInquireSoulChariot" tags="" position="9225,3350" size="100,100">:: NightWWWInquireSoulChariot
**You:** “You mentioned a soul chariot for Corvan: what became of it?”  
**Craftsman:** “He commissioned it to carry souls through the Veil. I hid it when his ambitions turned… darker.”  
* [[Ask him to show you where it’s hidden|NightWWWRevealSoulChariot]]  
* [[Thank him and step away|NightWheelwrightWorkshopArrival]]</tw-passagedata><tw-passagedata pid="180" name="NightWWWSearchWorkshop" tags="" position="9350,3350" size="100,100">:: NightWWWSearchWorkshop
You scour every shelf and box. Behind a stack of bone wheels you find a hidden drawer containing a scroll titled **“Corvan’s Workshop Designs.”**  
(set: $inventory to it + “Corvan’s Designs Scroll”)  
* [[Tuck the scroll away|NightWheelwrightWorkshopArrival]]</tw-passagedata><tw-passagedata pid="181" name="NightWWWCultistEcho" tags="" position="9475,3350" size="100,100">:: NightWWWCultistEcho
As a Cultist of the Worm, you press your fingers into those carved veins. The statuette’s runes glow faintly, and you taste a whisper of forbidden knowledge in your mind.  
(set: $journal to it + (a: &quot;I received Worm visions from statuette&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Step back, unsettled|NightWheelwrightWorkshopArrival]]</tw-passagedata><tw-passagedata pid="182" name="NightFGGTombstoneExamine" tags="" position="5387.5,2675" size="100,100">:: NightFGGTombstoneExamine
You brush moss from the tombstone. The dates inscribed: centuries ago: imply Corvan was buried here long before his legend began. A shiver runs up your spine.  
(set: $journal to it + “Discovered Corvan’s forgotten burial” )  
* [[Step back|NightForgottenGraveyardGateArrival]]</tw-passagedata><tw-passagedata pid="183" name="NightFGGPressStone" tags="" position="5512.5,2675" size="100,100">:: NightFGGPressStone
You press your palm to the cool stone. A whisper drifts: “I never left.” The ground trembles faintly, and you feel the veil between life and death grow thin.  
(set: $journal to it + (a: &quot;I heard Corvan’s whisper: ‘I never left.’&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Release the stone|NightForgottenGraveyardGateArrival]]</tw-passagedata><tw-passagedata pid="184" name="NightFGGRetrieveKey" tags="" position="5650,2675" size="100,100">:: NightFGGRetrieveKey
You reach up and unhook the rusted root from the gnarled wood. In your hand rests a heavy iron key.  
(set: $inventory to it + “Cemetery Cart Key”)  
* [[Use the key on the cart track gate|NightFGGUnlockTrack]]  
* [[Pocket the key and step back|NightForgottenGraveyardGateArrival]]</tw-passagedata><tw-passagedata pid="185" name="NightWMTHRevealTrapdoor" tags="" position="6800,1325" size="100,100">:: NightWMTHRevealTrapdoor
Beneath the loosened plank lies a trapdoor fitted with iron rings. Through its crack you see a stair spiraling into darkness.  
* [[Descend the trapdoor stair|NightTunnelEntrance]]  
* [[Close it and return|NightWidowMarrowTeaHouseArrival]]</tw-passagedata><tw-passagedata pid="186" name="NightWLAGratePassage" tags="" position="7725,425" size="100,100">:: NightWLAGratePassage
Under the shifted grate is a narrow stair descending into darkness. A damp draft drips down the steps.  
* [[Descend the stair|NightTunnelEntrance]]  
* [[Replace the grate and step back|NightWeepingLanternArchArrival]]</tw-passagedata><tw-passagedata pid="187" name="NightHBBTLastOfSeveredEcho" tags="" position="9000,2100" size="100,100">Your scar thrums in time with the bronze chime. A fragmented memory surfaces: Corvan’s plea: “Help me bind the restless”: echoing beneath these stones.  
(set: $journal to it + (a: &quot;A fragmented memory surfaced: Corvan’s plea: “Help me bind the restless”” &quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Clutch your scar and step back]()]()*</tw-passagedata><tw-passagedata pid="188" name="NightArchiveEntrance" tags="" position="4325,1200" size="100,100">:: NightArchiveEntrance
You squeeze through the gap and descend a narrow shaft of stacked crates. At the bottom, you find a room filled with... paperwork.
The entire village history is laid here, but surely no secrets at all, just reports on bad crops, disputes between neighboors, the taxes that always rise and the complain that follow the same path.
You feel silly having followed that stupid aimal that lead you to his ... wait a minute, is that...

&lt;!--A CHEST--&gt;

(click:&quot;is that...&quot;)[

(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
    a hidden door swings open onto a vaulted library: shelves of dusty tomes, flickering sconces, and a moonbeam‑lit globe at its center.  
* [[Step into the Moonlit Archive|NightArchiveLobby]]
    ]
(else:)
    [
    No. There is nothing ther, for sure. You stay a while more, but it is time to go [[back to reality|NightVelthornHollowOrientation]]
    ]

 ]
 ]
</tw-passagedata><tw-passagedata pid="189" name="NightArchiveLobby" tags="" position="4100,1450" size="100,100">:: NightArchiveLobby
Rows of ancient books stretch endlessly. A spectral librarian hovers at a lectern, ink‑stained robes trailing in the dust.  
**Librarian:** “Welcome, seeker. All knowledge has its price.”  
* [[Ask what price knowledge demands|NightLibrarianPrice]]  
* [[Browse the nearest shelf silently|NightArchiveBrowse]]  
* [[Retreat to the shafts|NightRMSFollowRat]]</tw-passagedata><tw-passagedata pid="190" name="NightArchiveBrowse" tags="" position="4375,1600" size="100,100">:: NightArchiveBrowse
Shelves of leather‑bound volumes line the walls. Titles include **“Severance Codex”**, **“Echoes of the Dead”**, and **“Rituals of the Veil”**.  
* [[Pull “Severance Codex” off the shelf|NightSeveranceCodex]]  
* [[Pull “Echoes of the Dead” off the shelf|NightEchoesDead]]  
* [[Return to the librarian|NightArchiveLobby]]

While browsing through the shelves, you feel something strange...

(click:&quot;something strange...&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
    :: NightHiddenStair
Behind a rolling shelf you discover stone steps spiraling down.  
* [[Descend the hidden stair|NightArchiveLowerLevel]]  
* [[Leave it be|NightArchiveBrowse]]
    ]
(else:)
    [No, that&#39;s nothing, just the general vibes of this old books... 
    ]
]
 ]
</tw-passagedata><tw-passagedata pid="191" name="NightArchiveCornerAlcove" tags="" position="4525,1725" size="100,100">:: NightArchiveCornerAlcove
A narrow alcove holds a pedestal with a single glowing orb.  
* [[Touch the orb|NightOrbTouch]]  
* [[Ignore it and browse elsewhere|NightArchiveBrowse]]</tw-passagedata><tw-passagedata pid="192" name="NightArchiveLowerLevel" tags="" position="4950,1500" size="100,100">:: NightArchiveLowerLevel
You emerge in a circular chamber. At its center, a marble sarcophagus glows faintly.  
* [[Approach the sarcophagus|NightSarcophagusApproach]]  
* [[Climb back up|NightArchiveLobby]]</tw-passagedata><tw-passagedata pid="193" name="NightSarcophagusOpen" tags="" position="5100,1625" size="100,100">:: NightSarcophagusOpen
Inside lies not a body but a crystal heart pulsing with moonlight. It speaks in a whisper: “Release me.”  
* [[Heed its plea|NightHeartRelease]]  
* [[Seal it again|NightSarcophagusClose]]</tw-passagedata><tw-passagedata pid="194" name="NightLibrarianPrice" tags="" position="4200,1700" size="100,100">:: NightLibrarianPrice
The librarian’s eyes glow. “A single truth in exchange for a single lie.”  
* [[Offer a truth about yourself|NightOfferTruth]]  
* [[Offer a lie instead|NightOfferLie]]</tw-passagedata><tw-passagedata pid="195" name="NightOfferTruth" tags="" position="4075,1750" size="100,100">:: NightOfferTruth
**You:** “I once betrayed a friend for power.”  
The librarian nods gravely. “Fair trade.” A tome floats off a shelf: its spine reads **“Corvan’s Diary”**.  
(set: $inventory to it + “Corvan’s Diary”)  
* [[Open the diary|NightOpenCorvanDiary]]  
* [[Thank the librarian and browse more|NightArchiveBrowse]]</tw-passagedata><tw-passagedata pid="196" name="NightOfferLie" tags="" position="4275,1900" size="100,100">:: NightOfferLie
**You:** “I have never feared death.”  
The librarian smiles thinly. “Then you shall fear ignorance.” A volume titled **“Veilbound Grimoire”** hovers free.  
(set: $inventory to it + “Veilbound Grimoire”)  
* [[Pocket the grimoire|NightArchiveBrowse]]  
* [[Step back in unease|NightArchiveLobby]]</tw-passagedata><tw-passagedata pid="197" name="NightOpenCorvanDiary" tags="" position="4125,1950" size="100,100">:: NightOpenCorvanDiary
You flip to a random page: a crude sketch shows three burial urns and a note: “Heart’s bond broken here.”  
(set: $journal to it + (a: &quot;I found a crude sketch shows three burial urns and a note: “Heart’s bond broken here.”&quot;+ &quot;\n\n&quot;))
* [[Close the diary|NightArchiveBrowse]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="198" name="NightSeveranceCodex" tags="" position="4475,1875" size="100,100">:: NightSeveranceCodex
You open the Severance Codex. Inside is Marginalia in a familiar hand: your own? It details how to sever a soul without killing the body.  
(set: $journal to it + (a: &quot;I saw my own hand in the Codex.What a frightening vision!&quot;+ &quot;\n\n&quot;))
* [[Close it and return|NightArchiveBrowse]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
</tw-passagedata><tw-passagedata pid="199" name="NightEchoesDead" tags="" position="4375,2000" size="100,100">:: NightEchoesDead
Scanning “Echoes of the Dead,” you find a hechizo that lets you hear the murmurs of nearby ghosts for a minute.  
(set: $inventory to it + “Echo Spell” )  
* [[Tuck it away|NightArchiveBrowse]]</tw-passagedata><tw-passagedata pid="200" name="NightOrbTouch" tags="" position="4575,1975" size="100,100">:: NightOrbTouch
Your vision shifts: you see Corvan’s hand placing the orb in his chest, binding his heart’s magic. Then the vision fades.  
(set: $journal to it + (a: &quot;I had a vision of Corvan&#39;s heart binding&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Withdraw your hand|NightArchiveCornerAlcove]]
</tw-passagedata><tw-passagedata pid="201" name="NightSarcophagusApproach" tags="" position="4825,1650" size="100,100">:: NightSarcophagusApproach
The lid bears the tri‑burial sigil inlaid in obsidian.  
* [[Push the lid aside|NightSarcophagusOpen]]  
* [[Step back, heart pounding|NightArchiveLowerLevel]]</tw-passagedata><tw-passagedata pid="202" name="NightHeartRelease" tags="" position="4950,1775" size="100,100">:: NightHeartRelease
You lift the heart from its bed. The chamber trembles, and the sarcophagus seals behind you.  
(set: $inventory to it + “Crystal Heart” )  
* [[Search for an exit|NightHeartExitSearch]]</tw-passagedata><tw-passagedata pid="203" name="NightSarcophagusClose" tags="" position="5225,1800" size="100,100">:: NightSarcophagusClose
You close the lid; the glow fades.  
* [[Retreat to the lower level|NightArchiveLowerLevel]]</tw-passagedata><tw-passagedata pid="204" name="NightHeartExitSearch" tags="" position="5025,2025" size="100,100">:: NightHeartExitSearch
Your lantern’s beam finds a tunnel carved through marble.  
* [[Follow the marble tunnel|NightTunnelEntrance]]  
* [[Clutch the heart and return to the archive|NightArchiveLobby]]</tw-passagedata><tw-passagedata pid="205" name="NightWWWRevealSoulChariot" tags="" position="9175,3550" size="100,100">:: NightWWWRevealSoulChariot
You try to convince the craftsman to show you the chariot... Let&#39;s see how that goes...
(click:&quot;convince&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
    The craftsman lifts a loose floorboard. Beneath it lies a small, ornate bone‑and‑silver chariot, its wheels carved with runes that still pulse faintly.  
(set: $inventory to it + “Soul Chariot”)  
* [[Take the Soul Chariot|NightWheelwrightWorkshopArrival]]
    ]
(else:)
    [
    There is nothing you can say, it seems, to change his mind.
   * [[continue|NightWheelwrightWorkshopArrival]]
    ]

 ]
 ]
</tw-passagedata><tw-passagedata pid="206" name="NightFGGUnlockTrack" tags="" position="5650,2800" size="100,100">:: NightFGGUnlockTrack
You find the barred cart track gate nearby. The Cemetery Cart Key fits with a click. The bars swing open, revealing rails that slope into darkness beneath the graves.  
* [[Descend the cart track|NightTunnelEntrance]]  
* [[Leave it closed for now|NightForgottenGraveyardGateArrival]]</tw-passagedata><tw-passagedata pid="207" name="NightMOIClimbParchment" tags="" position="6925,3725" size="100,100">:: NightMOIClimbParchment
You clamber up the rafters, steadying yourself on the oak’s gnarled limbs. You retrieve the parchment: its blood‑smeared ink warns, “Beware the second vein: a path of no return.”  
(set: $journal to it + “Found warning: second vein”+ &quot;\n\n&quot; )  
* [[Descend carefully|NightMourningOakInnArrival]]</tw-passagedata><tw-passagedata pid="208" name="NightMOIDefaultInteraction" tags="" position="7125,3725" size="100,100">:: NightMOIDefaultInteraction
You ask the barkeep for the sap‑laced ale. He pours a thick mug, its sap glowing softly. You lift it to your lips and see, in the swirling amber, visions of a soldier’s last farewell and a whisper: “Choice defines the living.”  
(set: $journal to it + “Vision: soldier’s farewell” + &quot;\n\n&quot;)  
* [[Thank him and set the mug down|NightMourningOakInnArrival]]</tw-passagedata><tw-passagedata pid="209" name="NightMOINobleScionEcho" tags="" position="7375,3700" size="100,100">:: NightMOINobleScionEcho
You examine the parchment’s seal: it bears your family’s crest alongside Corvan’s sigil. A cold dread settles as you realize your lineage might have taken part in these rituals.  
(set: $journal to it + “Discovered familial ties to Corvan” )  
* [[Fold the parchment and step back|NightMourningOakInnArrival]]

</tw-passagedata><tw-passagedata pid="210" name="MOICOMBAT" tags="" position="1175,2625" size="100,100"></tw-passagedata><tw-passagedata pid="211" name="WhisperedRevealSecret" tags="" position="3275,975" size="100,100">:: WhisperedRevealSecret
**You:** “You once saved the mayor’s daughter from a spirit attack: word is, you did it without raising a cry.”  
Brannon freezes. “Where’d you hear that?”  
* (if: $wis &gt;= 12)[
    **You:** “From the shadows themselves.”  
    **Brannon:** He exhales. “No one knows that but me: and the dead. All right, you’ve earned a free dig.”  
    * [[He frees you quietly|VelthornHollowOrientation]]
  ][
    **You:** “Just… from rumor.”  
    **Brannon:** “Rumor’s cheap. If you won’t prove it, I’ll take coin.”  
    * [[Offer coin|WhisperedPay]]
  ]</tw-passagedata><tw-passagedata pid="212" name="WhisperedClearRumor" tags="" position="3425,975" size="100,100">:: WhisperedClearRumor
**You:** “I can silence those who accuse you of theft: the furnace pieces that disappeared last month.”  
Brannon’s grip tightens on the handle. “You’d help me clear my name?”  
* [[Demonstrate your skill: describe the hidden location of the furnace pieces|WhisperedShowProof]]  
* [[Hesitate and try a different approach|WhisperedAskMystery]]</tw-passagedata><tw-passagedata pid="213" name="WhisperedAskMystery" tags="" position="3550,975" size="100,100">:: WhisperedAskMystery
**You:** “What’s the codeword the Wharf Watch uses at midnight?”  
Brannon’s jaw drops. “How: ? That’s not for common ears.”  
* (if: $cha &gt;= 12)[
    **You:** “Whispered tongues hear all.”  
    **Brannon:** “You’re no charlatan. Dig’s on me.”  
    * [[Brannon frees you|VelthornHollowOrientation]]
  ][
    **Brannon:** “Nice try, but I think you’re just fishing. Coin, or silence.”  
    * [[Offer coin|WhisperedPay]]
  ]</tw-passagedata><tw-passagedata pid="214" name="WhisperedPay" tags="" position="3700,1025" size="100,100">:: WhisperedPay
**Brannon:** “Fine. Two silver shards, and I’ll shove you out.”  
(if: $money &gt;= 2)[
  (set: $money to it - 2)
  **Brannon:** “Pleasure doing business.”  
  * [[He digs you free|VelthornHollowOrientation]]
][
  **Brannon:** “No coin, no talk, no dig.”  
  * [[The earth silences you again|GameOverStarve]]
]</tw-passagedata><tw-passagedata pid="215" name="WhisperedShowProof" tags="" position="3425,1100" size="100,100">:: WhisperedShowProof
**You:** “Under the granary floor, behind the loose brick. The pieces were stashed there.”  
Brannon’s eyes narrow: then soften. “By the gods… you’re for real.”  
* [[He shovels you out in gratitude|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="216" name="EmporiumArrival" tags="NEXUS" position="200,2700" size="100,100">
:: EmporiumArrival
You step into the narrow lane between two shuttered stalls and find the Bone &amp; Lantern Emporium. Racks of polished bone trinkets hang beside glowing glass lanterns filled with spectral flame. Behind the counter, a shrewd merchant arranges wares under a warm lantern glow.  

**Merchant (smiling):** “Welcome to my humble shop: everything a would‑be adventurer might need before delving into crypts. Take a look or ask a question.”  
* [[Show me what you have for sale|EmporiumShop]]  
* [[On second thought, I’ll be going|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="217" name="EmporiumShop" tags="" position="100,2875" size="100,100"></tw-passagedata><tw-passagedata pid="218" name="EmporiumRumorArray" tags="" position="250,2875" size="100,100">(set: $EmporiumRumorArray to (a: 
  &quot;They say the Ossuary of Echoes once swallowed an entire procession of mourners, never to return.&quot;,
  &quot;A tinkling jars of ectoplasm have been smuggled out of the Necropolis: worth a fortune to alchemists.&quot;,
  &quot;Old Dieners swear the Mortuary Hall’s walls pulse at midnight, as if remembering each body it’s held.&quot;,
  &quot;The mirrored corridors beneath the Graveyard Gate shift nightly, trapping unwary souls for days.&quot;,
  &quot;Rumor has it a secret vendor deals in worm‑salve near the Wheelwright’s Workshop after dusk.&quot;,
  &quot;Some claim Widow Marrow’s tea recipes were stolen from a Necropolis grimoire, cursed if misused.&quot;,
  &quot;A scholar once vanished in the Rotted Library, found weeks later babbling in runic tongues.&quot;,
  &quot;They say a gilded chariot rides the frozen tracks under the cemetery: ridden by restless ghosts.&quot;,
  &quot;A bell in the Bell Tower tolls on its own at the witching hour, calling spirits to feast.&quot;,
  &quot;Stories tell of a hidden alcove in the Silent Crypt where Corvan’s own bones lie entombed.&quot;
))
</tw-passagedata><tw-passagedata pid="219" name="Passage sans titre" tags="" position="1950,2675" size="100,100">

7. Half‑Buried Bell Tower (HalfBuriedBellTowerArrival)
Where: In the description of the bronze plates.
What to add:

“Bell‑plate harmonies here match the mortar‑tuned chimes of the Reliquary of Frozen Hearts: an uncanny resonance suggesting a shared arcane source.”
Why:
Musical motif ties village bell tower to the Necropolis’s crystal hearts, hinting at common enchantments.

8. Wheelwright’s Workshop (WheelwrightWorkshopArrival)
Where: After revealing the half‑carved statuette.
What to add:

“Late at night, wheel rims creak like the rolling bones of the Ossuary Chapel below: some say the Worm’s faithful bring offerings through hidden tunnels.”
Why:
Creates a rumor that the Workshop’s bone wheels share subterranean tunnels with the Ossuary Chapel.

9. Mourning Oak Inn (MourningOakInnArrival)
Where: Where sap drips into mugs.
What to add:

“Patrons who sleep under the oak wake dreaming of marble corridors and glass‑cased hearts: visions unmistakably drawn from that frozen Reliquary beyond the Graveyard Gate.”
Why:
Connects the Inn’s sap‑drunk visions to the Reliquary of Frozen Hearts, so its magic carries over.

10. Forgotten Graveyard Gate (ForgottenGraveyardGateArrival)
Where: After “Corvan” carved on the fallen stone.
What to add:

“Beyond these bars lie the mortuary halls: the true Necropolis, where the Dieners groom the dead and the Brain Reliquary awaits in secret vaults.”
Why:
Explicitly names the Necropolis as the destination beyond the Gate, pulling village lore into focus.

</tw-passagedata><tw-passagedata pid="220" name="NecroWake" tags="" position="1950,3925" size="100,100">:: NecroWake
You blink awake to silver darkness. Your chest is encased in polished metal: the lid of a coffin of burnished silver. Earth presses everywhere; the faintest shaft of lantern‑blue light glints along the coffin’s rim.   
Somewhere beyond, a distant echoing drip reminds you: your quest is not over.  

What do you do?  
* [[Struggle against the lid|NecroStruggle]]  
* [[Call out for help|NecroCallOut]] </tw-passagedata><tw-passagedata pid="221" name="NecroStruggle" tags="" position="1850,3550" size="100,100">:: NecroStruggle
Your arms strain, but the coffin holds fast. A distant drip echoes around you. You feel the silver walls grow colder as panic rises.  
* [[Stop and catch your breath|NecroCalm]]  
* [[Keep forcing the lid|NecroStruggleFail]]</tw-passagedata><tw-passagedata pid="222" name="NecroCallOut" tags="" position="1600,3600" size="100,100">:: NecroCallOut
Your voice comes as a rasp: “Hello? Anyone: ”  
Silence answers. Only the drip, drip, drip of unseen water.  
* [[Struggle for air and calm yourself|NecroCalm]]  
* [[Call again, louder|NecroCallOutEcho]]</tw-passagedata><tw-passagedata pid="223" name="NecroCalm" tags="" position="1525,3425" size="100,100">:: NecroCalm
You force your racing heart to slow. Lantern‑blue light seeps through a narrow crack. Above, you hear slow footsteps.  
* [[Prepare to speak|NecroDienerArrival]]  </tw-passagedata><tw-passagedata pid="224" name="NecroDienerArrival" tags="" position="1250,3550" size="100,100">:: NecroDienerArrival
A voice rasps through the crack:  
**Diener:** “By the bones… you’re not supposed to wake yet.”  
A grate of metal follows as a slim boot presses against the lid, then a hand fits into the seam and lifts.  

* [[Let him lift the lid|NecroDienerSpeak]]  </tw-passagedata><tw-passagedata pid="225" name="NecroExitCoffin" tags="" position="1600,4000" size="100,100">:: NecroExitCoffin
You haul yourself free of the silver coffin. The floor is cold marble, etched with runes that pulse softly. The Diener steps back, tucking his tools away.  
**Diener:** “Suit yourself. If you want guidance: or supplies: seek me in the Mortuary Hall. I keep a small shop of embalming wares.”  
He vanishes through an arch of carved bones.  

* [[Step forward into the Necropolis|NecroOrientation]]</tw-passagedata><tw-passagedata pid="226" name="NecroStruggleFail" tags="" position="1725,3350" size="100,100">:: NecroStruggleFail
Your muscles burn and you slump back, breath coming in sharp gasps. The coffin’s chill seeps into your bones.  
* [[Steady yourself and pause|NecroCalm]]</tw-passagedata><tw-passagedata pid="227" name="NecroCallOutEcho" tags="" position="1550,3775" size="100,100">:: NecroCallOutEcho
Your echo rings hollow. Far above, you hear the scuff of boots and the scrape of metal.  
* [[Wait quietly|NecroDienerArrival]]  
* [[Shout again with all your might|NecroCallOut]]</tw-passagedata><tw-passagedata pid="228" name="NecroDienerSpeak" tags="" position="1075,3600" size="100,100">:: NecroDienerSpeak
The coffin lid swings open. A lean figure in black‑lined robes stands over you, tools at his belt. He peers in, unimpressed.  
**Diener:** “Wait a minute… you’re not actually dead?”  

What do you say?  
* [[“Please help me out of here.”|NecroDienerNegotiate]]  
* [[“Where am I? Who are you?”|NecroDienerQuestion]]  </tw-passagedata><tw-passagedata pid="229" name="NecroDienerNegotiate" tags="" position="1025,4000" size="100,100">:: NecroDienerNegotiate
**You:** “Please, just get me out.”  
**Diener (shrugging):** “Fine, but first: consider a favor. I need your cooperation, corpse or not.”  
He leans close, voice low:  
**Diener:** “Corvan’s brain rests in the Reliquary beneath this place. You can’t just march straight there: he had himself interred behind wards and sealed doors. You’ll need help getting past them.”  
* [[Climb out of the coffin|NecroExitCoffin]]  </tw-passagedata><tw-passagedata pid="230" name="NecroDienerQuestion" tags="" position="350,3675" size="100,100">:: NecroDienerQuestion
**You:** “Where am I? Who are you?”  
**Diener:** “This is the Mortuary of the Necropolis, and I’m one of its Dieners: an embalmer by trade. Most here prefer to stay dead.”  

What do you want to ask?  
* [[Ask about Magister Corvan|NecroAskCorvan]]  
* [[Ask about this place|NecroAskNecropolis]]  
* [[Ask the Diener’s name and purpose|NecroAskDiener]]  
* [[Climb out of the coffin|NecroExitCoffin]]







</tw-passagedata><tw-passagedata pid="231" name="NecroAskVault" tags="" position="1225,4100" size="100,100">:: NecroAskVault
**You:** “How will I find it?”  
**Diener:** “There’s no direct path: he arranged it so. You’ll have to piece together clues in the mortuary halls, the catacombs, and the ossuary. Best start by getting your legs under you.”  
* [[Climb out of the coffin|NecroExitCoffin]]</tw-passagedata><tw-passagedata pid="232" name="NecroOrientation" tags="" position="1575,4175" size="200,200">: NecroOrientation
You stand at the threshold of the Necropolis proper. Moon‑blue lanterns reveal twelve paths, each descending into a different funeral domain:  
* [[Mortuary Hall|MortuaryHallArrival]] &amp;mdash; White marble tables and embalming tools await.  
* [[Morgue Catacombs|MorgueCatacombsArrival]] &amp;mdash; Frost‑lined vaults of rune‑sealed corpses.  
* [[Ossuary of Echoes|OssuaryEchoesArrival]] &amp;mdash; A domed chamber of bones and ectoplasm.  
* [[Lantern‑lit Gallery|LanternGalleryArrival]] &amp;mdash; Floating lanterns cradling dying souls.  
* [[Gallery of Weeping Effigies|WeepingEffigiesArrival]] &amp;mdash; Statues weeping black sap.  
* [[Silent Crypt|SilentCryptArrival]] &amp;mdash; Windowless vault with muffled moans.  
* [[Ossuary Chapel|OssuaryChapelArrival]] &amp;mdash; Bone‑wrought chapel stained with sacrificial blood.  
* [[Mirror‑Vault|MirrorVaultArrival]] &amp;mdash; Obsidian mirrors reflecting impossible fates.  
* [[Rotted Library|RottedLibraryArrival]] &amp;mdash; Moldy tomes and spilled ink.  
* [[Forgotten Cartway|CartwayArrival]] &amp;mdash; Overgrown tracks leading beneath tombs.  
* [[Pilgrim’s Rest|PilgrimRestArrival]] &amp;mdash; A ruined oratory of blood‑stained pews.  
* [[Reliquary of Frozen Hearts|FrozenHeartsArrival]] &amp;mdash; Glass cases of crystal‑preserved hearts.  

A small wooden sign beside you reads:  
&gt; “Mortuary supplies to the left: ask the Diener. May your steps be cautious.”  

* [[Begin your exploration…|MortuaryHallArrival]]
</tw-passagedata><tw-passagedata pid="233" name="MortuaryHallArrival" tags="NEXUS" position="300,4650" size="100,100">:: MortuaryHallArrival
You step into the vast Mortuary Hall. Polished marble tables stretch in rows beneath cold blue lanterns. Brass embalming tools gleam, and jars of scented oils line the walls. The air is heavy with lavender and decay.  
What do you do?  
* [[Examine the pulsing slab in the center|HallPulsingSlab]]  
* [[Inspect the row of empty bier‑hooks|HallBierHooks]]  
* [[Approach the far lectern with scattered papers|HallLectern]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 1)[  
  * [[You spot a vial that bears your old camp mark. Take it?|HallRefugeeTrigger]]  
]  
</tw-passagedata><tw-passagedata pid="234" name="MorgueCatacombsArrival" tags="NEXUS" position="975,5775" size="100,100">:: MorgueCatacombsArrival
You step into the Morgue Catacombs: a series of low, frost‑chilled vaults lined with stone shelves. Corpse tags sealed in blood‑red ink hang from each slab, and a thin mist coils along the floor. The air tastes of antiseptic and decay.  
What do you do?  
* [[Examine a sealed tag at random|CatacombsOpenTag]]  
* [[Listen for movement among the corpses|CatacombsListen]]  
* [[Inspect the runes carved into the wall|CatacombsInspectRunes]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 2)[  
  * [[Run your fingers along the shelf edges|CatacombsBastardTrigger]]  
]

























</tw-passagedata><tw-passagedata pid="235" name="OssuaryEchoesArrival" tags="NEXUS" position="325,6525" size="100,100">:: OssuaryEchoesArrival
You step into the domed Ossuary of Echoes. Mountains of bleached bones rise on every side, and at the center a fountain drips glowing ectoplasm into a shallow basin. Whispered voices swirl in the dripping mist.  
What do you do?  
* [[Sip from the ectoplasm fountain|EchoesSipEctoplasm]]  
* [[Shout to hear the echoes|EchoesShout]]  
* [[Examine the piled bones|EchoesExamineBones]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 3)[  
  * [[Hold your bone wand to the fountain’s edge|EchoesApprenticeTrigger]]  
]




























</tw-passagedata><tw-passagedata pid="236" name="LanternGalleryArrival" tags="NEXUS" position="1075,7425" size="100,100">:: LanternGalleryArrival
You enter the Lantern‑lit Gallery: a vaulted hall hung with hundreds of floating lanterns, each cradling a flickering soul‑wisp. The lanterns hum softly, and their light casts dancing shadows on walls carved with funerary runes. A faint aroma of burning myrrh drifts on the air.  
What do you do?  
* [[Release a spirit from its lantern|GalleryReleaseSpirit]]  
* [[Study the funeral runes on the walls|GalleryStudyRunes]]  
* [[Search for a hidden alcove behind the lanterns|GallerySearchAlcove]]  
* [[Return to Necropolis entrance|NecroOrientation]]  
(if: $backStory is 4)[  
  * [[Hold your lantern aloft and call your lost flock|GalleryTenderTrigger]]  
]
























</tw-passagedata><tw-passagedata pid="237" name="WeepingEffigiesArrival" tags="NEXUS" position="1100,8325" size="100,100">:: WeepingEffigiesArrival
You enter the Gallery of Weeping Effigies. Marble statues line the corridor, each carved in the likeness of a sorrowing noble, their faces streaked with black sap that pools at their feet. The air is thick with the scent of damp stone and old regret.  
What do you do?  
* [[Wipe sap from a statue’s cheek|EffigiesWipeSap]]  
* [[Study the runes carved at the statues’ bases|EffigiesStudyRunes]]  
* [[Walk the length of the gallery, counting the weeping heads|EffigiesCountHeads]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 5)[  
  * [[Examine the statue bearing your family crest|EffigiesScionTrigger]]  
]
</tw-passagedata><tw-passagedata pid="238" name="SilentCryptArrival" tags="NEXUS" position="3050,8875" size="100,100">:: SilentCryptArrival
You step into the Silent Crypt, a windowless chamber where icy air clings to the stone. Muffles moans hum behind rusted iron bars set into the south wall. Candles in cracked sconces sputter with cold blue flames.  
What do you do?  
* [[Peer through the bars at the source of the moans|CryptPeerMoans]]  
* [[Light a candle from your own lantern|CryptLightCandle]]  
* [[Inspect the frosted floor tiles|CryptInspectTiles]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 6)[  
  * [[Trace your scar over the rune‑sealed bars|CryptSeveredTrigger]]  
]
































</tw-passagedata><tw-passagedata pid="239" name="OssuaryChapelArrival" tags="NEXUS" position="3450,9900" size="100,100">:: OssuaryChapelArrival
You step into the Ossuary Chapel, its walls built of interlocking thigh bones and vertebrae. Dried blood stains the stone altar, and the floor is scattered with bone‑shards glinting in torchlight. A hush of reverence hangs in the air.  
What do you do?  
* [[Kneel and pray at the altar|ChapelPray]]  
* [[Examine the bone caretaker statue|ChapelExamineStatue]]  
* [[Search for hidden levers among the bones|ChapelSearchBones]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 7)[  
  * [[Place your cult fetish upon the altar|ChapelCultistTrigger]]  
]






























</tw-passagedata><tw-passagedata pid="240" name="MirrorVaultArrival" tags="NEXUS" position="3325,11300" size="100,100">:: MirrorVaultArrival
You step into the Mirror‑Vault: a circular chamber lined with eight full‑length obsidian mirrors. Each reflects not your likeness but a different possible death: some peaceful, others horrific. Resin drips from the gilded frames, filling the air with faint jasmine and decay.  
What do you do?  
* [[Touch one of the mirror frames|MirrorVaultTouchFrame]]  
* [[Gaze into a mirror to confront your fate|MirrorVaultGazeMirror]]  
* [[Knock on the nearest mirror surface|MirrorVaultKnockMirror]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 8)[  
  * [[Hum a mournful tune from your bone flute|MirrorVaultSingerTrigger]]  
]
</tw-passagedata><tw-passagedata pid="241" name="RottedLibraryArrival" tags="NEXUS" position="950,9625" size="100,100">:: RottedLibraryArrival
You step into the Rotted Library, where mold‑eaten shelves sag under the weight of charred tomes. The floor is slick with spilled ink and ashes, and the air smells of burnt parchment and damp paper. Flickering lanterns cast trembling shadows on cracked spines.  
What do you do?  
* [[Read aloud a random page|LibraryReadPage]]  
* [[Search the shelves for intact volumes|LibrarySearchShelves]]  
* [[Inspect the lectern’s bleeding manuscript|LibraryInspectManuscript]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 9)[  
  * [[Examine the charred page stamped with your unit’s emblem|LibraryVeteranTrigger]]  
]
</tw-passagedata><tw-passagedata pid="242" name="CartwayArrival" tags="NEXUS" position="1025,10600" size="100,100">(set: $backStory to 10)
(set:$cryptKey to true)
:: CartwayArrival
You step onto the Forgotten Cartway: rusty rails lead beneath collapsed mausoleums, half‑buried carts lined with broken skull‑racks. Damp moss clings to the walls, and the distant drip of water echoes like footsteps.  
What do you do?  
* [[Inspect a derailed cart car|CartwayInspectCart]]  
* [[Follow the moss‑covered rails forward|CartwayFollowRails]]  
* [[Search the tunnel walls for markings|CartwaySearchWalls]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 10)[  
As you round a bend, something catches your eye: a flash of pale chalk beneath a thick patch of moss on the stone wall.  
  * [[Drawn to that flash of white, you kneel and clear the moss away to reveal familiar graffiti: you once carved these letters as a child in Greyglass.|CartwayOrphanTrigger]]  
]
</tw-passagedata><tw-passagedata pid="243" name="PilgrimRestArrival" tags="NEXUS" position="2875,7150" size="100,100">:: PilgrimRestArrival
You step into Pilgrim’s Rest, a ruined oratory whose pews are stained with dried incense and blood‑red wax. The vaulted ceiling is cracked, and faded frescoes depict monks in endless prayer. A single beam of moonlight illuminates a cracked altar at the far end.  
What do you do?  
* [[Chant a prayer at the altar|PrayingPilgrimChant]]  
* [[Inspect the blood‑stained pews|PrayingPilgrimInspectPews]]  
* [[Examine the cracked altar stone|PrayingPilgrimInspectAltar]]  
* [[Search the floor for dropped prayer beads|PrayingPilgrimSearchBeads]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 11)[  
  * [[Sing the Hymn of Bleeding Bones|PrayingPilgrimHymnTrigger]]  
]



























</tw-passagedata><tw-passagedata pid="244" name="FrozenHeartsArrival" tags="NEXUS" position="2950,8075" size="100,100">:: FrozenHeartsArrival
You step into the Reliquary of Frozen Hearts. Glass cases line the walls, each enclosing a crystal‑clear chamber where a heart beats slowly in suspended animation. The air is frigid enough to frost your breath, and the rhythmic pulse of the hearts echoes like distant drums.  
What do you do?  
* [[Reach out to touch a beating heart|HeartsTouchHeart]]  
* [[Inspect the frost‑etched runes on a case|HeartsInspectRunes]]  
* [[Listen closely to the pulse echoes|HeartsListenPulse]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 12)[  
  * [[Step barefoot onto the frozen floor and concentrate on your own heartbeat|HeartsReturnedTrigger]]  
]
(if: $inventory contains “Frozen Reliquary Key”)[  
  * [[Use the Frozen Reliquary Key on the central case|HeartsOpenVault]]  
]  </tw-passagedata><tw-passagedata pid="245" name="NecroAskCorvan" tags="" position="250,3875" size="100,100">:: NecroAskCorvan
**You:** “Do you know anything of Magister Corvan?”  
**Diener:** He glances away, voice hushed. “Corvan? The old necromancer: his brain was sealed in a vault beneath the Mortuary Hall. No door leads straight there; he prepared it so only those who piece together his clues can enter.”  
* [[Thank him and ask more|NecroDienerQuestion]]  
* [[Climb out of the coffin|NecroExitCoffin]]</tw-passagedata><tw-passagedata pid="246" name="NecroAskNecropolis" tags="" position="375,3875" size="100,100">:: NecroAskNecropolis
**You:** “What is this place: truly?”  
**Diener:** “A city of the dead’s caretakers. We embalm, we entomb, we study. Beyond these halls lie the Catacombs, the Ossuary, the Rotted Library… all twelve domains, each more perilous than the last.”  
* [[Ask which domain to explore first|NecroDienerRecommend]]  
* [[Climb out of the coffin|NecroExitCoffin]]
</tw-passagedata><tw-passagedata pid="247" name="NecroAskDiener" tags="" position="525,3775" size="100,100">:: NecroAskDiener
**You:** “And what is your name: and why help me?”  
**Diener:** He brushes dust from his robe. “Call me Malveris. I’ve seen too many corpses wander in here blind. Help me unravel Corvan’s secrets, and I’ll keep your body intact.”  
* [[Agree to his terms|NecroExitCoffin]]  
* [[Climb out of the coffin|NecroExitCoffin]]</tw-passagedata><tw-passagedata pid="248" name="NecroDienerRecommend" tags="" position="475,4000" size="100,100">:: NecroDienerRecommend
**You:** “Which domain would you suggest I tackle first?”  
**Diener:** “Begin in the Mortuary Hall: learn the rites of preservation there, then descend into the Catacombs. Seek me later if you need supplies.”  
* [[Climb out of the coffin|NecroExitCoffin]]</tw-passagedata><tw-passagedata pid="249" name="HallPulsingSlab" tags="" position="0,4750" size="100,100">:: HallPulsingSlab
A faint throb ripples through the marble. As you press your hand to it, a tremor of necrotic energy stuns you. (CON save DC 13 or be stunned 1 turn.)  
* [[Recover and step back|MortuaryHallArrival]]  
* [[Press harder to learn more|HallPulsingSlabPress]]</tw-passagedata><tw-passagedata pid="250" name="HallBierHooks" tags="" position="125,4875" size="100,100">:: HallBierHooks
Rows of hooks hang empty. Above, runic seals stamped “Severance Trial #3” glow faintly. You recall whispered rumors of corpses trialed here by Corvan himself.  
* [[Touch a seal to feel its power|HallSealTouch]]  
* [[Move on|MortuaryHallArrival]]</tw-passagedata><tw-passagedata pid="251" name="HallLectern" tags="" position="250,4875" size="100,100">:: HallLectern
Scattered papers, half‑finished, lie on the lectern: Corvan’s notes on brain preservation. One page mentions a hidden door “behind the east alcove.”  
* [[Read the notes (INT check DC 15)|HallReadNotes]]  
* [[Note the clue and leave|MortuaryHallArrival]]</tw-passagedata><tw-passagedata pid="252" name="HallRefugeeTrigger" tags="" position="625,4575" size="100,100">:: HallRefugeeTrigger

Your fingers close around the “Red Fog Serum” vial: its seal matches the one you used in the plague camps. The memory of those desperate days steels your resolve.  
* [[Pour the serum into the keyhole beneath the slab|HallOpenVault]]  
* [[Step back: this feels too risky|MortuaryHallArrival]]
Next to it, you also see a jar labeled “Embalming Salve”: its lavender scent shocks you back to the plague camps. You remember burying friends in makeshift graves.  
* [[Clutch the jar and steel yourself|HallRefugeeMem1]]  
* [[Step away: this is too much|HallRefugeeReject]]</tw-passagedata><tw-passagedata pid="253" name="HallRefugeeMem1" tags="" position="925,4675" size="100,100">:: HallRefugeeMem1
A swirl of memory overtakes you: a child with fevered cheeks and pleading eyes. The salve was meant to ease her suffering… but you arrived too late.  
* [[Whisper her name|HallRefugeeMem2]]  
* [[Shake off the vision|HallRefugeeMem4]]</tw-passagedata><tw-passagedata pid="254" name="HallRefugeeReject" tags="" position="875,4475" size="100,100">:: HallRefugeeReject
Fear floods you. You stumble back to the center of the hall, heart pounding.  
* [[Breathe deeply and face the hall again|MortuaryHallArrival]]</tw-passagedata><tw-passagedata pid="255" name="HallRefugeeMem4" tags="" position="1100,4875" size="100,100">:: HallRefugeeMem4
Your vision clears. Among the jars you spot one marked “Red Fog Serum”: the same serum you once used in the quarantine ward. A secret vial might open hidden paths here.  
* [[Take the serum vial|HallRefugeeMem5]]  
* [[Leave it be|MortuaryHallArrival]]</tw-passagedata><tw-passagedata pid="256" name="HallSecretCorridor" tags="" position="225,5175" size="100,100">:: HallSecretCorridor
You step into a stone passage lit by phosphorescent moss. Faint dripping echoes ahead.  
* [[Press onward toward the drip sound|HallDripPassage]]  
* [[Retreat to the hall|MortuaryHallArrival]]</tw-passagedata><tw-passagedata pid="257" name="HallDripPassage" tags="" position="325,5325" size="100,100">:: HallDripPassage
The corridor ends at a locked iron gate. A vial‑shaped keyhole beckons.  
* [[Use the Red Fog Serum vial as a key|HallUseSerumKey]]  
* [[Turn back quietly|HallSecretCorridor]]</tw-passagedata><tw-passagedata pid="258" name="MortuaryHallDepth" tags="" position="550,4975" size="100,100">:: MortuaryHallDepth
You emerge into a narrower hall lined with glass display cases holding preserved organs. A single case glows around a brain‑shaped reliquary.  
* [[Approach the brain reliquary|HallBrainReliquary]]  
* [[Study the other organs|HallOrganCases]]  
* [[Fallback to Lectern area|MortuaryHallArrival]]</tw-passagedata><tw-passagedata pid="259" name="HallFleeWithBrain" tags="" position="750,5250" size="100,100">:: HallFleeWithBrain
Clutching the brain vial, you dash back through the secret corridor as alarms begin to echo. Ahead, the Mortuary Hall’s door gapes open: your escape beckons.  
* [[Escape to the Necropolis entrance|NecroOrientation]]</tw-passagedata><tw-passagedata pid="260" name="HallRefugeeMem2" tags="" position="825,4850" size="100,100">:: HallRefugeeMem2
**You (whisper):** “Layla…”  
The lanterns flicker. A pulse in the marble beneath your feet answers: soft, like her final heartbeat.  
* [[Kneel and offer a silent prayer|HallRefugeeMem3]]  
* [[Pull yourself up|HallRefugeeMem4]]</tw-passagedata><tw-passagedata pid="261" name="HallRefugeeMem3" tags="" position="850,5025" size="100,100">:: HallRefugeeMem3
You kneel, offering all the forgiveness you never could back in the camps. The scented air grows warmer, as though acknowledging your plea.  
(set: $flags to it + “LaidLaylaToRest”)  
* [[Stand and continue|HallRefugeeMem4]]</tw-passagedata><tw-passagedata pid="262" name="HallRefugeeMem5" tags="" position="1075,5050" size="100,100">:: HallRefugeeMem5
(set: $inventory to it + “Red Fog Serum”)  
Clutching the vial, you feel both guilt and resolve.  
* [[Press on deeper into the hall|MortuaryHallArrival]]</tw-passagedata><tw-passagedata pid="263" name="HallPulsingSlabPress" tags="" position="0,4925" size="100,100">:: HallPulsingSlabPress
The slab cracks, revealing a carved vial labeled “Red Fog Serum.” Its seal bears your old refugee camp mark.  
(set: $inventory to it + “Red Fog Serum”)  
* [[Pocket the vial|MortuaryHallArrival]]  
* [[Continue exploring|MortuaryHallArrival]]</tw-passagedata><tw-passagedata pid="264" name="HallSealTouch" tags="" position="125,5000" size="100,100">:: HallSealTouch
The seal’s magic flares, showing a ghostly replay of Corvan’s ritual: flesh stripped away, soul bound in crystal. You shudder.  
(set: $journal to it + (a: &quot;I had a chilling vision of what might be a part of the Severance ritual.’&quot;+ &quot;\n\n&quot;))
* [[Step back|MortuaryHallArrival]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="265" name="HallReadNotes" tags="" position="250,5000" size="100,100">:: HallReadNotes
Your scholar’s eye deciphers the complex runes. A panel slides open in the east wall, revealing a narrow corridor.  
* [[Enter the secret corridor|HallSecretCorridor]]  
* [[Ignore and return|MortuaryHallArrival]]</tw-passagedata><tw-passagedata pid="266" name="HallUseSerumKey" tags="" position="325,5475" size="100,100">:: HallUseSerumKey
You pour the serum into the keyhole. It fizzes, the lock clicks: and the gate swings inward. Beyond lies deeper Mortuary galleries.  
* [[Step through into the next wing|MortuaryHallDepth]]  
* [[Close it and reconsider|HallDripPassage]]</tw-passagedata><tw-passagedata pid="267" name="HallBrainReliquary" tags="" position="525,5225" size="100,100">:: HallBrainReliquary
Behind glass, Corvan’s brain pulses in silver fluid. A runic seal binds it.  
* [[Study the seal (INT DC 15)|HallStudySeal]]  
* [[Search for a way inside the case|HallOpenReliquary]]</tw-passagedata><tw-passagedata pid="268" name="HallOrganCases" tags="" position="1100,5250" size="100,100">:: HallOrganCases
You step closer to the glass display cases. Inside rest a heart still faintly beating in viscous amber fluid, a pair of ghost‑white lungs that expand on their own, and a liver etched with arcane runes. Each organ glows under the blue lantern light, pulsing with necromantic energy.  
What do you do?  
* [[Touch the beating heart through the glass|HallTouchHeart]]  
* [[Press your ear against the case to hear the lungs|HallHearLungs]]  
* [[Study the rune‑etched liver for clues|HallStudyLiver]]  
* [[Step back to the Reliquary|MortuaryHallDepth]]
</tw-passagedata><tw-passagedata pid="269" name="HallStudySeal" tags="" position="462.5,5350" size="100,100">:: HallStudySeal
You parse the binding rune: “Only one who embraced the rot may break this bond.”  
* [[Offer to spill the Red Fog Serum on the seal|HallBreakSeal]]  
* [[Step back: this feels deadly|MortuaryHallDepth]]</tw-passagedata><tw-passagedata pid="270" name="HallOpenReliquary" tags="" position="587.5,5350" size="100,100">:: HallOpenReliquary
You jiggle the glass lid: it resists. A hiss of steam escapes a hidden vent.  
* [[Force it with strength (STR DC 14)|HallForceOpenFail]]  
* [[Use a tool from inventory|HallForceOpenSuccess]]</tw-passagedata><tw-passagedata pid="271" name="HallBreakSeal" tags="" position="475,5475" size="100,100">:: HallBreakSeal
Serum eats into the rune. With a hiss, the glass cracks and the case opens. The brain’s pulse quickens.  
(set: $inventory to it + “Corvan’s Brain”)  
* [[Retrieve the brain and prepare to flee|HallFleeWithBrain]]</tw-passagedata><tw-passagedata pid="272" name="HallForceOpenFail" tags="" position="650,5475" size="100,100">:: HallForceOpenFail
Your strength falters. The case hisses steam, burning your forearm.  
(set: $hp to it - 2)  
* [[Withdraw your hand|MortuaryHallDepth]]</tw-passagedata><tw-passagedata pid="273" name="HallForceOpenSuccess" tags="" position="775,5475" size="100,100">:: HallForceOpenSuccess
Your tool snaps a hidden pin; the case pops open. The brain hovers in its fluid.  
(set: $inventory to it + “Corvan’s Brain”)  
* [[Pocket the reliquary vial|HallFleeWithBrain]]</tw-passagedata><tw-passagedata pid="274" name="HallTouchHeart" tags="" position="912.5,5375" size="100,100">:: HallTouchHeart
You lay a trembling fingertip on the glass. The heart’s rhythm quickens, and ghostly tendrils of mist swirl within the case. A sudden pressure builds in your chest: (CON save DC 13 or gain 1 damaged status).  
* [[Withdraw your hand|HallOrganCases]]  
* [[Brace against the glass and hold on|HallEndureHeart]]</tw-passagedata><tw-passagedata pid="275" name="HallHearLungs" tags="" position="1175,5425" size="100,100">:: HallHearLungs
You press your ear to the cold glass. Inhale… exhale… inhale… 
The rhythm echoes like distant chanting. You swear you hear a whispered phrase: “Ascend through the bones.”  
(set: $journal to it + (a: &quot;I received a clue: it said“Ascend through the bones.” .’&quot;+ &quot;\n\n&quot;))
* [[Continue listening|LungSings]]
* [[Step back|HallOrganCases]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="276" name="HallStudyLiver" tags="" position="1325,5350" size="100,100">:: HallStudyLiver
Leaning close, you trace the carved runes on the liver’s surface. In your scholar’s mind, you recognize part of the Severance Ritual’s binding formula.  
(set: $journal to it + “Discovered liver‑rune formula fragment”)  
* [[Memorize the pattern and step away|HallOrganCases]]</tw-passagedata><tw-passagedata pid="277" name="HallEndureHeart" tags="" position="912.5,5500" size="100,100">:: HallEndureHeart
You steel yourself as the heart’s pulse hammers against the glass. Slowly, the case’s magic stabilizes, leaving behind a faint warmth in your bones.  
(set: $buff to it + “Heart’s Warmth”)  
* [[Step back|HallOrganCases]]</tw-passagedata><tw-passagedata pid="278" name="CatacombsOpenTag" tags="" position="350,5975" size="100,100">:: CatacombsOpenTag
You pry open the nearest corpse’s tag. The glove twitches; frost cracks along the bone. The body shudders to life!  
* [[Defend yourself (draw weapon)|CatacombsCombatCorpse]]  
* [[Flee down the corridor|MorgueCatacombsArrival]]</tw-passagedata><tw-passagedata pid="279" name="CatacombsListen" tags="" position="500,5825" size="100,100">:: CatacombsListen
You press your ear to the cold stone. A soft scraping echoes around you: something shifts on the next shelf.  
* [[Investigate the sound|CatacombsOpenTag]]  
* [[Step away quietly|MorgueCatacombsArrival]]</tw-passagedata><tw-passagedata pid="280" name="CatacombsInspectRunes" tags="" position="600,5975" size="100,100">:: CatacombsInspectRunes
The wall runes spell out burial rites in an archaic script. A single phrase stands out: “Bones remember the hand that placed them.”  
* [[Trace the phrase with your finger|CatacombsTraceRunes]]  
* [[Leave them be|MorgueCatacombsArrival]]</tw-passagedata><tw-passagedata pid="281" name="CatacombsBastardTrigger" tags="" position="725,5975" size="100,100">:: CatacombsBastardTrigger
Your fingertips brush familiar tool‑marks on the shelf edge: precise chisel grooves only a Bonepicker would leave. Memories of your first clandestine grave dig flood back.  
* [[Follow the grooves along the wall|CatacombsBastardFollow]]  
* [[Shake off the memory|MorgueCatacombsArrival]]</tw-passagedata><tw-passagedata pid="282" name="CatacombsBastardUseKey" tags="" position="1100,6200" size="100,100">:: CatacombsBastardUseKey
You insert the key into a barred gate set into the far wall. With a heavy click, it unlocks. Beyond is a steep stair descending into deeper catacombs… and closer to the Brain Reliquary.  
* [[Descend the stair|CatacombsDeepStairs]]  
* [[Return to exploring the vaults|MorgueCatacombsArrival]]</tw-passagedata><tw-passagedata pid="283" name="CatacombsCombatCorpse" tags="" position="350,6175" size="100,100">:: CatacombsCombatCorpse
You hack at the animated corpse. It falls back into stillness, but you’re shaken, and your blood chills.  
(set: $health to it - 2)  
* [[Catch your breath|MorgueCatacombsArrival]]</tw-passagedata><tw-passagedata pid="284" name="CatacombsTraceRunes" tags="" position="625,6125" size="100,100">:: CatacombsTraceRunes
Cold energy pulses beneath your touch. You see a phantom hand arranging bones: then the vision fades.  
(set: $journal to it + (a: &quot;I had a vision of a phantom hand arranging bones&quot;+ &quot;\n\n&quot;))
* [[Step back|MorgueCatacombsArrival]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="285" name="CatacombsBastardFollow" tags="" position="850,6100" size="100,100">:: CatacombsBastardFollow
You track the tool marks deeper into the vault. The grooves end at a loose stone shelf covered in your old marking: a crudely carved “B.”  
* [[Lift the shelf slab|CatacombsBastardReveal]]  
* [[Step back, nervous|MorgueCatacombsArrival]]</tw-passagedata><tw-passagedata pid="286" name="CatacombsBastardReveal" tags="" position="850,6225" size="100,100">:: CatacombsBastardReveal
Beneath the slab lies a small alcove containing a rusted key taped to the bone shelf tag. Your old moniker is carved beside it.  
(set: $inventory to it + “Rusty Catacombs Key”)  
* [[Pocket the key|CatacombsBastardUseKey]]  
* [[Inspect it further|CatacombsBastardInspectKey]]</tw-passagedata><tw-passagedata pid="287" name="CatacombsBastardInspectKey" tags="" position="850,6350" size="100,100">:: CatacombsBastardInspectKey
The key bears your childhood “B” brand: a mark you thought lost. A surge of guilt and pride war within you.  
(set: $flags to it + “BastardKeyFound”)  
* [[Use the key on the nearby gate|CatacombsBastardUseKey]]  
* [[Hide it and step away|MorgueCatacombsArrival]]</tw-passagedata><tw-passagedata pid="288" name="CatacombsDeepStairs" tags="" position="1275,6075" size="100,100">:: CatacombsDeepStairs
The steps wind down, slick with frost. Faint lantern‑blue glow reveals carved ossuary reliefs overhead.  
* [[Press on into the darkness|CatacombsDeepCorridor]]  
* [[Climb back up for now|MorgueCatacombsArrival]]</tw-passagedata><tw-passagedata pid="289" name="CatacombsDeepCorridor" tags="" position="1425,5950" size="100,100">:: CatacombsDeepCorridor
You emerge into a narrower gallery, the air thicker with necrotic chill. Ahead, a vault door sealed with Corvan’s tri‑burial sigil stands waiting.  
* [[Prepare to unlock the door|VaultEntrance]]  
* [[Hesitate, pondering your next move|MorgueCatacombsArrival]]</tw-passagedata><tw-passagedata pid="290" name="HallOpenVault" tags="" position="625,4825" size="100,100">:: HallOpenVault
You uncork the vial and let the viscous red mist fill the keyhole carved in the marble slab. With a hiss of dissolving stone, a hidden panel grinds open, revealing a spiraling stair plunging into darkness.  
The symbol near the stairs leave no room for interpretation. This is what you were looking for.
* [[Descend into Corvan’s sealed vault|VaultEntrance]]</tw-passagedata><tw-passagedata pid="291" name="VaultEntrance" tags="NEXUS" position="3025,5475" size="200,200">:: VaultEntrance
You stand before the massive stone door bearing Corvan’s tri‑burial sigil. Lantern‑blue light seeps through its edges, and behind it you feel the thrum of powerful ward magic: and the slow, steady heartbeat of a trapped intelligence.  
What do you do?  
* [[Push on the door|VaultPushDoor]]  
* [[Study the sigil’s runes|VaultStudySigil]]  
* [[Step back to gather yourself|VaultPrepare]]  
* [[Retreat to the Necropolis orientation|NecroOrientation]]
</tw-passagedata><tw-passagedata pid="292" name="EchoesSipEctoplasm" tags="" position="50,6725" size="100,100">:: EchoesSipEctoplasm
You cup your hand and taste the cold ectoplasm. Insight floods your mind: visions of lost rituals and the secret path beneath the bones: but a wisp of a vengeful spirit lunges for your throat!
(click:&quot;your throat&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $charisma &gt;= $diceRoll)
    [
    [[You steel yourself and stand firm|EchoesStandFirm]]
    ]
(else:)
    [You manage to dodge the spirit but have to [[Pull back in alarm|OssuaryEchoesArrival]]  
    ]

 ]
 ]

</tw-passagedata><tw-passagedata pid="293" name="EchoesShout" tags="" position="175,6725" size="100,100">:: EchoesShout
Your voice booms, and thousands of ghostly replies answer back, each one uttering a fragment of Corvan’s name. The floor rumbles.  
* [[Listen for a meaningful phrase|EchoesListen]]  
* [[Fall silent, overwhelmed|OssuaryEchoesArrival]]</tw-passagedata><tw-passagedata pid="294" name="EchoesExamineBones" tags="" position="287.5,6725" size="100,100">:: EchoesExamineBones
You sift through the femurs. A single skull bears your master’s sigil carved in haste: your old notes warned of such a marker here.  
* [[Hold the skull aloft|EchoesSkullVision]]  
* [[Place it back gently|OssuaryEchoesArrival]]</tw-passagedata><tw-passagedata pid="295" name="EchoesApprenticeTrigger" tags="" position="425,6725" size="100,100">:: EchoesApprenticeTrigger
You raise your bone wand; its tip hums. The fountain’s surface parts, revealing a spiral stair descending into bone‑choked darkness.  
* [[Descend the spiral stair|EchoesDescendStair]]  
* [[Lower your wand and step back|OssuaryEchoesArrival]]</tw-passagedata><tw-passagedata pid="296" name="EchoesDescendStair" tags="" position="450,6975" size="100,100">:: EchoesDescendStair
The slippery stair winds down between bone walls. Whispers chase your heels.  
* [[Press on into the gloom|EchoesBoneTunnel]]  
* [[Climb back up|OssuaryEchoesArrival]]</tw-passagedata><tw-passagedata pid="297" name="EchoesBoneTunnel" tags="" position="575,6975" size="100,100">:: EchoesBoneTunnel
You enter a narrow tunnel; bone shards crunch underfoot and phosphorescent mold pulses along the walls.  
* [[Follow the mold’s glow|EchoesFollowMold]]  
* [[Step carefully and listen|EchoesListenDrip]]</tw-passagedata><tw-passagedata pid="298" name="EchoesFollowMold" tags="" position="750,6975" size="100,100">:: EchoesFollowMold
The mold leads to an iron door carved with the tri‑burial sigil. The Obsidian Ossuary Key fits perfectly.  
* [[Insert the key and turn|EchoesOpenVaultDoor]]  
* [[Hesitate at the threshold|EchoesBoneTunnel]]</tw-passagedata><tw-passagedata pid="299" name="EchoesStandFirm" tags="" position="50,6850" size="100,100">:: EchoesStandFirm
You steel your mind and banish the spirit with a thought. The fountain’s glow pulses gratefully.  
Looking at the water again, it seems now to be filled with shards of silver.
&lt;!--(set: $buff to it + “Spirit Ward”)  --&gt;
(click:&quot;shards of silver&quot;)[

&lt;!--AJOUTER OBJET--&gt;
{
    &lt;script&gt;
    // Tableau contenant l&#39;objet à créer
  const newItemData =     { id: &quot;moneySmall&quot;, nom: &quot;Money&quot;, type: &quot;money&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;6&quot;, money: 500, src: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Money/Money.png&quot;, rare: &quot;Common&quot;, inventory: 20,  }

   // Création de l&#39;élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute(&#39;data-id&#39;, newItemData.id);
  itemElement.setAttribute(&#39;draggable&#39;, &#39;true&#39;);

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;)) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));

  itemElement.addEventListener(&#39;mouseenter&#39;, (e) =&gt; showTooltip(e, itemElement));
  itemElement.addEventListener(&#39;touchstart&#39;, (e) =&gt; showTooltip(e, itemElement), { passive: false });
&lt;/script&gt;
}
]
* [[You can now step back|OssuaryEchoesArrival]]</tw-passagedata><tw-passagedata pid="300" name="EchoesListen" tags="" position="162.5,6850" size="100,100">:: EchoesListen
Amid the cacophony, you hear: “Beneath the seventh arch, the heart first shines.” A rune on a distant column glows in response.  
(set: $journal to it + (a: &quot;I heard what could be a clue: “Beneath the seventh arch, the heart first shines.”&quot;+ &quot;\n\n&quot;))
* [[Step toward the glowing column|EchoesApproachColumn]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="301" name="EchoesApproachColumn" tags="" position="162.5,6975" size="100,100">:: EchoesApproachColumn
You approach the column. Its base is carved with looping knots. A faint crack reveals a hidden alcove.  
* [[Prise the stone open|EchoesHiddenAlcove]]  
* [[Ignore and explore elsewhere|OssuaryEchoesArrival]]</tw-passagedata><tw-passagedata pid="302" name="EchoesHiddenAlcove" tags="" position="175,7100" size="100,100">:: EchoesHiddenAlcove
Inside the alcove you find a small obsidian key, etched with your apprentice’s mark.  
(set: $inventory to it + “Obsidian Ossuary Key”)  
* [[Pocket the key|OssuaryEchoesArrival]]</tw-passagedata><tw-passagedata pid="303" name="EchoesSkullVision" tags="" position="287.5,6850" size="100,100">:: EchoesSkullVision
The skull’s empty eye‑sockets flame with pale light. You glimpse Corvan chanting over a crystal reliquary… then darkness returns.  
(set: $journal to it + (a: &quot;I had a vision of Corvan chanting over a crystal reliquary&quot;+ &quot;\n\n&quot;))
* [[Step away|OssuaryEchoesArrival]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="304" name="EchoesListenDrip" tags="" position="575,7100" size="100,100">:: EchoesListenDrip
A steady drip echoes ahead. Leaning in, you hear the distant pulse of the Brain Reliquary’s wards.  
* [[Move toward the sound|EchoesFollowMold]]  
* [[Return to the stair|EchoesDescendStair]]</tw-passagedata><tw-passagedata pid="305" name="EchoesOpenVaultDoor" tags="" position="625,6800" size="100,100">:: EchoesOpenVaultDoor
With a click, the door swings open, revealing a carved stone stair leading upward into torch‑lit vaults.  
* [[Step through into Corvan’s sealed vault|VaultEntrance]]  
* [[Pause to steel yourself|CryptPrepare]]</tw-passagedata><tw-passagedata pid="306" name="GalleryReleaseSpirit" tags="" position="800,7450" size="100,100">:: GalleryReleaseSpirit
You approach a lantern and gently lift its lid. A single soul‑wisp drifts free with a soft sigh: then swirls around you in gratitude, humming in your mind.  
&lt;!--(set: $buff to it + “Guiding Wisp”)  --&gt;
* [[Thank the spirit and step back|LanternGalleryArrival]]</tw-passagedata><tw-passagedata pid="307" name="GalleryStudyRunes" tags="" position="900,7550" size="100,100">:: GalleryStudyRunes
You trace the carved runes: they speak of “souls carried beyond the veil, guided by lantern’s flame.” A glow pulses beneath your fingertip.  
* [[Press the glowing rune|GalleryRunePress]]  
* [[Move on|LanternGalleryArrival]]</tw-passagedata><tw-passagedata pid="308" name="GallerySearchAlcove" tags="" position="1050,7625" size="100,100">:: GallerySearchAlcove
You slip between floating lights to the far wall and discover a small alcove. Inside rests a dusty tome titled **“Guide of Lost Flames.”**  
(set: $inventory to it + “Guide of Lost Flames”)  
* [[Tuck it into your pack|LanternGalleryArrival]]  
* [[Open it now|GalleryReadGuide]]</tw-passagedata><tw-passagedata pid="309" name="GalleryTenderTrigger" tags="" position="1275,7575" size="100,100">:: GalleryTenderTrigger
You lift your personal lantern high. Its flame grows brilliant, and dozens of gallery lanterns flare to life, illuminating a hidden doorway in the floor.  
* [[Open the hatch|GalleryOpenHatch]]  
* [[Lower your lantern|LanternGalleryArrival]]</tw-passagedata><tw-passagedata pid="310" name="GalleryPrepare" tags="" position="1425,7450" size="100,100">:: GalleryPrepare
You steady your breath, checking lantern fuel and tightening your grip on any wards you’ve learned. Beyond the door, the Brain Reliquary waits.  
* [[Open the door|VaultEntrance]]  
* [[Step back one moment|LanternGalleryArrival]]</tw-passagedata><tw-passagedata pid="311" name="EffigiesWipeSap" tags="" position="400,8475" size="100,100">:: EffigiesWipeSap
You press a finger to the sap. It feels sticky and warm: then the statue’s eyes snap open, and its stone hand lashes out!  
(set: $health to it - 2)  
* [[Dodge the strike and step back|WeepingEffigiesArrival]]</tw-passagedata><tw-passagedata pid="312" name="EffigiesStudyRunes" tags="" position="537.5,8475" size="100,100">:: EffigiesStudyRunes
You kneel and trace the faded runes: “Tears of the penitent, seal the path ahead.” A hidden groove beneath the tile clicks softly.  
* [[Press the groove|EffigiesRevealNiche]]  
* [[Stand and move on|WeepingEffigiesArrival]]</tw-passagedata><tw-passagedata pid="313" name="EffigiesCountHeads" tags="" position="662.5,8475" size="100,100">:: EffigiesCountHeads
You count thirteen statues. At the thirteenth, the sap ceases: then gushes all at once, flooding the floor with ebony liquid.  
* [[Retreat carefully|WeepingEffigiesArrival]]  
* [[Brace and let the sap flow over your boots|EffigiesSapFlow]]</tw-passagedata><tw-passagedata pid="314" name="EffigiesScionTrigger" tags="" position="800,8475" size="100,100">:: EffigiesScionTrigger
One effigy bears your family’s crest. Its sap‑streaked lips part, whispering: “Redeem your house’s debts.” A hidden ring at its base turns.  
* [[Turn the ring|EffigiesOpenSecretDoor]]  
* [[Step back in awe|WeepingEffigiesArrival]]</tw-passagedata><tw-passagedata pid="315" name="EffigiesDescendStair" tags="" position="1025,8700" size="100,100">:: EffigiesDescendStair
Each step is carved from bone. The flame flickers, casting dancing shadows on walls etched with your family’s motto.  
* [[Press onward|EffigiesFamilyPassage]]  
* [[Climb back up|WeepingEffigiesArrival]]</tw-passagedata><tw-passagedata pid="316" name="EffigiesPrepare" tags="" position="1325,8500" size="100,100">:: EffigiesPrepare
You pause, checking your equipment and steeling your nerves. The echo of dripping sap guides you downward.  
* [[Continue downward|EffigiesDescendStair]]  
* [[Retreat to the gallery|WeepingEffigiesArrival]]</tw-passagedata><tw-passagedata pid="317" name="EffigiesFamilyPassage" tags="" position="1550,8450" size="100,100">:: EffigiesFamilyPassage
You enter a small chamber lined with ancestral portraits. In its center, a sealed iron door bears the tri‑burial sigil: you’ve reached the vault’s outer door.  
* [[Use the Bone Chapel Key to unlock it|EffigiesUnlockVaultDoor]]  
* [[Study the portraits for clues|EffigiesStudyPortraits]]</tw-passagedata><tw-passagedata pid="318" name="LibraryReadPage" tags="" position="150,9750" size="100,100">:: LibraryReadPage
You open a mold‑caked tome and read the first sentence. Arcane glyphs flare in the lantern light, and a word‑spell bursts from the pages: (random effect: WIS save DC 14 or take 1 health necrotic damage).  
* [[Close the book quickly|RottedLibraryArrival]]  
* [[Press on to see what happens|LibrarySpellEffect]]</tw-passagedata><tw-passagedata pid="319" name="LibrarySearchShelves" tags="" position="275,9750" size="100,100">:: LibrarySearchShelves
You inspect row after row of ruined books. Most crumble at a touch, but one leather‑bound grimoire lies intact: **“Rituals of the Severed Mind.”**  
* [[Pull it free|LibraryTakeGrimoire]]  
* [[Leave it be|RottedLibraryArrival]]</tw-passagedata><tw-passagedata pid="320" name="LibraryInspectManuscript" tags="" position="400,9750" size="100,100">:: LibraryInspectManuscript
On the lectern lies a bleeding manuscript: ink seeps like blood down its pages. You can just make out fragmented notes on memory anchoring.  
* [[Read the fragment (INT check DC 15)|LibraryReadFragment]]  
* [[Step away, unsettled|RottedLibraryArrival]]</tw-passagedata><tw-passagedata pid="321" name="LibraryVeteranTrigger" tags="" position="525,9750" size="100,100">:: LibraryVeteranTrigger
Your scar throbs as you recognize the emblem. The charred page bears your unit’s motto: “Steel and Ash Endures.” The words glow faintly.  
* [[Speak the motto aloud|LibrarySpeakMotto]]  
* [[Fold the page away|RottedLibraryArrival]]</tw-passagedata><tw-passagedata pid="322" name="LibraryDescendStair" tags="" position="1275,9750" size="100,100">:: LibraryDescendStair
You descend the winding stair. The smell of ink and bone grows stronger, and each step echoes on stone.  
* [[Press onward into the vault corridor|LibraryVaultCorridor]]  
* [[Climb back up|RottedLibraryArrival]]</tw-passagedata><tw-passagedata pid="323" name="LibraryVaultCorridor" tags="" position="1525,9750" size="100,100">:: LibraryVaultCorridor
The stair opens onto a short corridor sealed with Corvan’s tri‑burial sigil. Lantern‑blue light spills through its cracks.  
* [[Push through into the vault entrance|VaultEntrance]]  
* [[Study the sigil’s runes|LibraryStudySigil]]</tw-passagedata><tw-passagedata pid="324" name="CartwayInspectCart" tags="" position="150,10725" size="100,100">:: CartwayInspectCart
You lean into a tilted cart car. Broken bone hooks rattle under your hand, sending a chill through your spine.  
* [[Close the cart and back off|CartwayArrival]]  
* [[Peer deeper into the darkness beneath|CartwayPeerBelow]]</tw-passagedata><tw-passagedata pid="325" name="CartwayFollowRails" tags="" position="275,10725" size="100,100">:: CartwayFollowRails
You walk the rails, water dripping from the vaulted ceiling. The rails split ahead: one path rises, the other descends into deeper blackness.  
* [[Take the downward track|CartwayDescend]]  
* [[Climb the upward incline|CartwayAscend]]</tw-passagedata><tw-passagedata pid="326" name="CartwaySearchWalls" tags="" position="400,10625" size="100,100">:: CartwaySearchWalls
Your hands brush over damp stone. Faint chalk marks form an arrow pointing deeper underground. You recognize the scrawl: your own handiwork from Greyglass.  
* [[Follow the arrow very carefully|CartwayOrphanTrigger]]  
* [[Ignore it and keep exploring|CartwayFollowRails]]</tw-passagedata><tw-passagedata pid="327" name="CartwayOrphanTrigger" tags="" position="525,10725" size="100,100">:: CartwayOrphanTrigger
The chalk arrow leads to a moss‑clad grate. Through its bars you glimpse a spiral stair glowing with blue lantern‑light: your childhood expeditions flash in your mind.  
* [[Prise open the grate|CartwayOpenGrate]]  
* [[Step back in wonder|CartwayArrival]]</tw-passagedata><tw-passagedata pid="328" name="CartwayOpenVaultDoor" tags="" position="925,11200" size="100,100">:: CartwayOpenVaultDoor
The iron door groans as it swings inward, revealing a corridor bathed in lantern‑blue glow: the entrance to Corvan’s sealed vault.  
* [[Step forward into the vault entrance|VaultEntrance]]  
* [[Hesitate, breath catching|CartwayPrepare]]</tw-passagedata><tw-passagedata pid="329" name="CartwayPrepare" tags="" position="1175,11175" size="100,100">:: CartwayPrepare
You steady your heart and check your gear. Beyond lies the Brain Reliquary, buried behind wards you’re now poised to breach.  
* [[Open the door|VaultEntrance]]  
* [[Step back for one last look|CartwayArrival]]</tw-passagedata><tw-passagedata pid="330" name="PrayingPilgrimChant" tags="" position="2075,7275" size="100,100">:: PrayingPilgrimChant
You kneel and offer a broken prayer. The air shivers, and distant chanting answers yours in ghostly chorus: then falls silent, leaving only your echo.  
* [[Stand and reflect|PilgrimRestArrival]]</tw-passagedata><tw-passagedata pid="331" name="PrayingPilgrimInspectPews" tags="" position="2200,7275" size="100,100">:: PrayingPilgrimInspectPews
You run your hand along a pew’s surface. Beneath the wax you find a carved monastic emblem: a bleeding chalice: echoing the monastery’s lost ritual.  
* [[Trace the emblem|PrayingPilgrimTraceEmblem]]  
* [[Step back|PilgrimRestArrival]]</tw-passagedata><tw-passagedata pid="332" name="PrayingPilgrimInspectAltar" tags="" position="2325,7275" size="100,100">:: PrayingPilgrimInspectAltar
The cracked altar bears chipped runes: “In blood we bind, in blood we break.” A hairline fissure suggests the top can be lifted.  
* [[Lift the altar slab|PrayingPilgrimAltarLift]]  
* [[Step away|PilgrimRestArrival]]</tw-passagedata><tw-passagedata pid="333" name="PrayingPilgrimSearchBeads" tags="" position="2450,7275" size="100,100">:: PrayingPilgrimSearchBeads
You kneel and gather scattered prayer beads. One string glows with residual aura: and a final bead snaps off, revealing a hidden key carved with monastery runes.  
(set: $inventory to it + &quot;Monastic Key&quot;)  
* [[Tuck it away|PilgrimRestArrival]]</tw-passagedata><tw-passagedata pid="334" name="PrayingPilgrimHymnTrigger" tags="" position="2575,7275" size="100,100">:: PrayingPilgrimHymnTrigger
You begin the Hymn of Bleeding Bones in your softest voice. The incense smoke swirls into shapes of kneeling monks, and the altar’s runes flare. The top of the altar lifts itself.  
* [[Approach the opened altar|PrayingPilgrimRevealStairs]]  
* [[Lower your voice|PilgrimRestArrival]]</tw-passagedata><tw-passagedata pid="335" name="PrayingPilgrimRevealStairs" tags="" position="2950,7275" size="100,100">:: PrayingPilgrimRevealStairs
The lever grinds stone aside, unveiling a narrow stair spiraling down, slick with dripping incense oil.  
* [[Descend the stair|PrayingPilgrimDescendStairs]]  
* [[Step back, wary|PilgrimRestArrival]]</tw-passagedata><tw-passagedata pid="336" name="PrayingPilgrimDescendStairs" tags="" position="3075,7275" size="100,100">:: PrayingPilgrimDescendStairs
The spiral stairs wind down beneath the chapel. Each step is slick, and the walls pulse with lingering chants.  
* [[Press on into the darkness|PrayingPilgrimBoneTunnel]]  
* [[Climb back up for now|PilgrimRestArrival]]</tw-passagedata><tw-passagedata pid="337" name="PrayingPilgrimFollowRunes" tags="" position="3325,7275" size="100,100">:: PrayingPilgrimFollowRunes
The runes lead to a heavy iron door stamped with Corvan’s tri‑burial sigil and your monastery’s chalice emblem. A monastic keyhole awaits.  
* [[Use the Monastic Key|PrayingPilgrimUnlockVault]]  
* [[Hesitate before the door|PrayingPilgrimPrepare]]</tw-passagedata><tw-passagedata pid="338" name="HeartsTouchHeart" tags="" position="2425,8100" size="100,100">:: HeartsTouchHeart
You press your palm to the glass. The heart’s rhythm quickens, and frost spreads across the case. A surge of cold pain stabs your chest: (CON save DC 13 or lose 1 health).  
* [[Withdraw your hand|FrozenHeartsArrival]]  
* [[Brace and hold on|HeartsEndureCold]]</tw-passagedata><tw-passagedata pid="339" name="HeartsInspectRunes" tags="" position="2575,8150" size="100,100">:: HeartsInspectRunes
You kneel to study the runes etched in the frost. They read: “Only the heart reborn may claim its key.” A hidden seam runs along the base of one case.  
* [[Trace the seam|HeartsRevealSeam]]  
* [[Rise and choose again|FrozenHeartsArrival]]</tw-passagedata><tw-passagedata pid="340" name="HeartsListenPulse" tags="" position="2700,8225" size="100,100">:: HeartsListenPulse
You cup your ear to the glass. The hearts’ collective pulse swells and dims like a heartbeat under duress. In the echo you hear a single phrase: “Return the lost.”  
(set: $journal to it + (a: &quot;I learned that I need to &#39;return the lost&#39;&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Step away for clarity|FrozenHeartsArrival]]</tw-passagedata><tw-passagedata pid="341" name="HeartsReturnedTrigger" tags="" position="2975,8250" size="100,100">:: HeartsReturnedTrigger
You stand barefoot on the frozen floor, eyes closed. Your pulse aligns with the crystal hearts’ rhythm: one case cracks softly. Inside, a small alcove appears.  
* [[Approach the cracked case|HeartsApproachAlcove]]  
* [[Step away, shaken|FrozenHeartsArrival]]</tw-passagedata><tw-passagedata pid="342" name="HeartsPrepare" tags="" position="3175,8225" size="100,100">:: HeartsPrepare
You steady your breath, ensuring the shard and key are secure. Ahead lies the final sealed door to Corvan’s brain vault.  
* [[Push onward into the vault|VaultEntrance]]  
* [[Step back for one last check|FrozenHeartsArrival]]</tw-passagedata><tw-passagedata pid="343" name="CryptPeerMoans" tags="" position="2450,9025" size="100,100">:: CryptPeerMoans
You press your ear to the bars. Muffled sobs and rattles echo inside: a bound spirit struggling for release.  
* [[Call out to it|CryptCallSpirit]]  
* [[Step back: this feels wrong|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="344" name="CryptLightCandle" tags="" position="2575,9025" size="100,100">:: CryptLightCandle
You light a candle from your lantern. Its blue flame flares: and for an instant the bars glow with runic script: “Bound by final rite.”  
(set: $journal to it + (a: &quot;I found what seeems to be a clue: final rite binds the captive &quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Study the script closely|CryptStudyScript]]  
* [[Blow out the candle|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="345" name="CryptInspectTiles" tags="" position="2700,9025" size="100,100">:: CryptInspectTiles
The floor tiles are frosted with bone‑dust. One bears a faint footprint made for bare feet: you remember walking these stones in a past life.  
* [[Step onto the marked tile|CryptStepMarked]]  
* [[Avoid it and move on|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="346" name="CryptSeveredTrigger" tags="" position="2825,9025" size="100,100">:: CryptSeveredTrigger
Your ritual‑scar aches as you touch the bars. A voice in your mind recites the Severance incantation you endured. The runes loosen: one bar slides aside, revealing a narrow gap.  
* [[Slip through the gap|CryptSecretPassage]]  
* [[Step away, shaken|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="347" name="CryptSecretPassage" tags="" position="3175,9150" size="100,100">:: CryptSecretPassage
You wriggle through and enter a bone‑lined corridor. The air hums with ward magic. Ahead, an iron door bears Corvan’s tri‑burial sigil.  
* [[Approach the door|CryptVaultDoor]]  
* [[Pause to catch your breath|CryptPrepare]]</tw-passagedata><tw-passagedata pid="348" name="CryptOpenVaultDoor" tags="" position="3575,9225" size="100,100">:: CryptOpenVaultDoor
The key turns; the lock releases with a clang. The door swings inward to reveal a torch‑lit corridor descending into Corvan’s sealed vault.  
* [[Step forward into the vault entrance|VaultEntrance]]  
* [[Hesitate, heart pounding|CryptPrepare]]</tw-passagedata><tw-passagedata pid="349" name="ChapelPray" tags="" position="2575,10025" size="100,100">:: ChapelPray
You kneel before the altar and whisper a prayer. A cold wind rustles through the bones overhead, and you feel unseen eyes upon you.  
* [[Rise and continue exploring|OssuaryChapelArrival]]</tw-passagedata><tw-passagedata pid="350" name="ChapelExamineStatue" tags="" position="2700,10025" size="100,100">:: ChapelExamineStatue
A massive bone statue of a hooded figure stands behind the altar. Its hollow eye‑sockets glow faintly.  
* [[Touch its foot to test its magic|ChapelStatueTouch]]  
* [[Step back respectfully|OssuaryChapelArrival]]</tw-passagedata><tw-passagedata pid="351" name="ChapelSearchBones" tags="" position="2825,10025" size="100,100">:: ChapelSearchBones
You sift through scattered bones at the altar’s base. Under a femur you find a small bone key wrapped in sinew.  
(set: $inventory to it + “Bone Chapel Key”)  
* [[Pocket the key|OssuaryChapelArrival]]  
* [[Continue searching|OssuaryChapelArrival]]</tw-passagedata><tw-passagedata pid="352" name="ChapelCultistTrigger" tags="" position="2950,10025" size="100,100">:: ChapelCultistTrigger
You lay your cult fetish: a small carved worm: upon the altar’s bloodstain. The dried blood liquefies and forms a rune that matches your ritual scar.  
* [[Speak the Worm’s Invocation|ChapelInvokeWorm]]  
* [[Pull the fetish back|OssuaryChapelArrival]]</tw-passagedata><tw-passagedata pid="353" name="ChapelBoneTunnel" tags="" position="3825,10025" size="100,100">:: ChapelBoneTunnel
The bone‑lined tunnel glows faintly with bioluminescent mold. Ahead, a heavy iron door bears Corvan’s tri‑burial sigil.  
* [[Approach the door|ChapelVaultDoor]]  
* [[Pause to check your gear|ChapelPrepare]]</tw-passagedata><tw-passagedata pid="354" name="ChapelPrepare" tags="" position="4075,10025" size="100,100">:: ChapelPrepare
You steady your breath, checking your fetish and wards. Ahead lies the final sealed way to Corvan’s brain reliquary.  
* [[Push forward into the vault entrance|VaultEntrance]]  
* [[Step back for a moment of prayer|OssuaryChapelArrival]]</tw-passagedata><tw-passagedata pid="355" name="ChapelOpenVaultDoor" tags="" position="4200,10025" size="100,100">:: ChapelOpenVaultDoor
You turn the bone key. The lock releases with a resonant clang, and the door swings open onto torchlit vault corridors.  
* [[Step through into Corvan’s sealed vault|VaultEntrance]]  
* [[Pause to gather courage|ChapelPrepare]]</tw-passagedata><tw-passagedata pid="356" name="MirrorVaultTouchFrame" tags="" position="2325,11425" size="100,100">:: MirrorVaultTouchFrame
Your fingers press the cold obsidian. The mirror shudders beneath your touch, and your reflection steps sideways: then snaps back.  
* [[Withdraw and step back|MirrorVaultArrival]]  
* [[Press again to test it|MirrorVaultPressAgain]]</tw-passagedata><tw-passagedata pid="357" name="MirrorVaultGazeMirror" tags="" position="2450,11425" size="100,100">:: MirrorVaultGazeMirror
You stare into a mirror. Your reflection grins before turning to face the room: your heart pounds. (CHA save DC 13 or gain 1 health damage from fear.)  
* [[Step back, shaken|MirrorVaultArrival]]  
* [[Touch the mirror’s surface|MirrorVaultShatterName]]</tw-passagedata><tw-passagedata pid="358" name="MirrorVaultKnockMirror" tags="" position="2575,11425" size="100,100">:: MirrorVaultKnockMirror
Three taps echo unnaturally. One mirror responds with a hollow tone that reveals an inscription on its frame: “Truth lies beyond reflection.”  
* [[Trace the inscription|MirrorVaultTraceInscription]]  
* [[Step away|MirrorVaultArrival]]</tw-passagedata><tw-passagedata pid="359" name="MirrorVaultSingerTrigger" tags="" position="2700,11425" size="100,100">:: MirrorVaultSingerTrigger
You lift your bone flute and play a mournful melody. The mirrors’ reflections sway in time, and the “Truth” mirror’s glass parts like curtains, revealing a hidden doorway.  
* [[Enter the doorway revealed by your song|MirrorVaultHiddenPassage]]  
* [[Lower your flute|MirrorVaultArrival]]</tw-passagedata><tw-passagedata pid="360" name="MirrorVaultHiddenPassage" tags="" position="3075,11425" size="100,100">:: MirrorVaultHiddenPassage
You step into a slender passage lined with mirrored panels. Your footsteps echo twice as you walk.  
* [[Follow the mirrored hall|MirrorVaultMirrorCorridor]]  
* [[Return to the vault room|MirrorVaultArrival]]</tw-passagedata><tw-passagedata pid="361" name="MirrorVaultMirrorCorridor" tags="" position="3450,11425" size="100,100">:: MirrorVaultMirrorCorridor
The corridor ends before a heavy iron door stamped with the tri‑burial sigil. Shattered mirror shards litter the floor.  
* [[Prepare to open the door|MirrorVaultPrepare]]  
* [[Study the sigil’s runes|MirrorVaultStudySigil]]</tw-passagedata><tw-passagedata pid="362" name="MirrorVaultPrepare" tags="" position="3800,11550" size="100,100">:: MirrorVaultPrepare
You take a steadying breath, grip your flute and any wards you’ve learned. Beyond this door lies the brain reliquary you’ve sought.  
* [[Push open the vault door|MirrorVaultOpenVaultDoor]]  
* [[Step back a moment|MirrorVaultMirrorCorridor]]</tw-passagedata><tw-passagedata pid="363" name="MirrorVaultOpenVaultDoor" tags="" position="3675,11275" size="100,100">:: MirrorVaultOpenVaultDoor
The iron door swings inward with a resonant groan, revealing a torch‑lit corridor that leads straight to Corvan’s sealed vault entrance.  
* [[Step forward into the vault entrance|VaultEntrance]]  
* [[Hesitate, heart racing|MirrorVaultPrepare]]</tw-passagedata><tw-passagedata pid="364" name="VaultPushDoor" tags="" position="2675,6225" size="100,100">:: VaultPushDoor
You throw your shoulder into the iron door. It groans but holds fast: ward magic flares at your touch, sending a shock through your arm.  
(health: DAMAGE 1)  
* [[Study the sigil’s runes more closely|VaultStudySigil]]  
* [[Retreat to gather yourself|VaultPrepare]]
</tw-passagedata><tw-passagedata pid="365" name="VaultStudySigil" tags="" position="2525,6350" size="100,100">:: VaultStudySigil
You trace the three interlocking loops. Each pulse matches a warded heartbeat within.  
* [[Press your palm to the sigil|VaultSigilTouch]]  
* [[Return to the door|VaultEntrance]]</tw-passagedata><tw-passagedata pid="366" name="VaultPrepare" tags="" position="2925,6225" size="100,100">:: VaultPrepare
You steady your lantern, check your gear, and adjust your stance. The final challenge awaits.  
* [[Open the door|VaultUseKey]]  
* [[Step back for one last breath|VaultEntrance]]
* Take some time to sit down and meditate
(click:&quot;meditate&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $intelligence &gt;= $diceRoll)
    [
    You center yourself. Focus on your breathing. Calm.
    (set:$health to it +2)
 &lt;script&gt;
 updateHealth($health)
&lt;/script&gt;
    ]
(else:)
    [
    You try to focus, but there is too much noise and threats around you and inside your own mind. Your imagination is too strong for that.
    ]

 ]
]</tw-passagedata><tw-passagedata pid="367" name="VaultUseKey" tags="" position="2450,6000" size="100,100">:: VaultUseKey
You insert the key. The ward unbinds with a resonant click, and the door swings inward. A low moan echoes within.  
* [[Step through into the inner sanctum|InnerSanctumEntry]]  
* [[Pause to ready yourself|VaultPrepare]]</tw-passagedata><tw-passagedata pid="368" name="InnerSanctumEntry" tags="" position="2675,6000" size="100,100">:: InnerSanctumEntry
You cross the threshold into a circular chamber. At its center, on a crystalline dais, floats Corvan’s brain: encased in silver filaments and pulsating with inner light. The air vibrates with its whispered thoughts.  
What do you do?  
* [[Approach and speak to the brain|BrainSpeak]]  
* [[Circle the chamber and search for traps|SanctumSearch]]  
* [[Step away: this feels too uncanny|SanctumRetreat]]</tw-passagedata><tw-passagedata pid="369" name="SanctumSearch" tags="" position="2950,6000" size="100,100">:: SanctumSearch
You circle the inner sanctum, eyes peeled for hidden panels or ritual implements. Flickering sconces reveal scorch marks on the floor and a shallow groove etched into the dais: a clue to a secret mechanism.  
* [[Trace the groove on the dais|SanctumRevealMechanism]]  
* [[Step back to the center|InnerSanctumEntry]]
</tw-passagedata><tw-passagedata pid="370" name="BrainProbe" tags="" position="3550,6000" size="100,100">:: BrainProbe
**You:** “How can I break your wards?”  
**Brain:** “Only one who embraced rot and blood may sever the bond.”  
* [[Recall your Red Fog Serum|BrainRecallSerum]]  
* [[Search for a ritual clue|SanctumSearch]]</tw-passagedata><tw-passagedata pid="371" name="DreamVision" tags="" position="4525,6300" size="100,100">:: DreamVision
You slip into darkness as pain fades. Moments later you stand in a cathedral-sized chamber, torchlight dancing across walls of bone and obsidian. 
But it is not the time or place you have known your entire life. No, this cathedral is of Metal, and its hartbeat is mechanical, not a choir but the steady rhythm of a machine.
&quot;Attrocity!&quot; A desperate voice. 
At its center, Corvan kneels before three sarcophagi: one heart-shaped, one brain-shaped, one inscribed simply with a blank nameplate.  

* [[Approach silently|DreamChamberApproach]]  



















</tw-passagedata><tw-passagedata pid="372" name="BrainCollapse" tags="" position="4275,6100" size="100,100">:: BrainCollapse
Your vision darkens, and you slump against the ground.  
* [[Continue|DreamVision]]</tw-passagedata><tw-passagedata pid="373" name="RiverCourt" tags="" position="6650,6375" size="100,100">:: FinalWake
Once again, you emerge from your slumber in another place, another time, maybe.
You cough against fetid air and realize you lie within the rib‑cage of some colossal beast: flesh still clings between rib bones like rotten curtains. Your lungs burn as you hack away at decomposing sinew.  
(set: $health to it - 1)  
The carcass groans, collapsing inward and pinning you. Darkness presses in.  
* [[Struggle free|FinalStruggle]]


























</tw-passagedata><tw-passagedata pid="374" name="FinalStruggle" tags="" position="6925,6450" size="100,100">:: FinalStruggle
Your arms scrape bone; you bite back bile. At last the ribs crack, and the shallow grave’s soil spills in.  
(if:$health&gt;=2)[
(set: $health to it - 1)  
 &lt;script&gt;
 updateHealth($health)
&lt;/script&gt;
]
* [[Crawl toward the light|FinalCrawlUp]]</tw-passagedata><tw-passagedata pid="375" name="RiverBankArrival" tags="" position="7375,6625" size="100,100">{
&lt;div class=&quot;image-container&quot;&gt;
  &lt;img class=&quot;image-base&quot; src=&quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Illustrations/RiverBankArrival.jpg&quot; /&gt;
&lt;/div&gt;
}
You stand beside a sluggish river of ink‑black water. Moss‑covered ruin stones mark a cobbled landing. A lone skiff made of bone drifts, tended by a silent ferryman in embalmer’s robes. Lantern‑blue light flickers along the prow.  
* [[Call out to the ferryman|RiverCall]]  
* [[Board the skiff in silence|RiverBoard]]</tw-passagedata><tw-passagedata pid="376" name="RiverBoard" tags="" position="7875,6450" size="100,100">:: RiverBoard
You step into the skiff. The ferryman pushes off. Lanterns along the shore wink out as you drift into the black current.  
* [[Sit and hold steady|RiverCrossing]]</tw-passagedata><tw-passagedata pid="377" name="RiverSpeakName" tags="" position="8000,6625" size="100,100">(if: $backStory is 1)[  
  **You (hoarse):** “I am the Plagueborn Refugee, once nameless in the Red Fog’s shadow.”  
](else-if: $backStory is 2)[  
  **You:** “I am the Graverobber’s Bastard: marked by moonlight and bone.”  
](else-if: $backStory is 3)[  
  **You:** “I am the Apprentice Necromancer, bound to the whispers of the dead.”  
](else-if: $backStory is 4)[  
  **You:** “I am the Exiled Lantern Tender, whose flame guides lost souls.”  
](else-if: $backStory is 5)[  
  **You:** “I am the Noble Scion of the Pale Court, heir to faded honors.”  
](else-if: $backStory is 6)[  
  **You:** “I am the Last of the Severed, returned from sacrificial chains.”  
](else-if: $backStory is 7)[  
  **You:** “I am the Cultist of the Worm, marrow‑marked and hungry for truth.”  
](else-if: $backStory is 8)[  
  **You:** “I am the Grave Singer, whose dirge unbinds the lost.”  
](else-if: $backStory is 9)[  
  **You:** “I am the Ashen War Veteran, tempered by fire and blood.”  
](else-if: $backStory is 10)[  
  **You:** “I am the Street Orphan of Greyglass, nameless yet unbroken.”  
](else-if: $backStory is 11)[  
  **You:** “I am the Pilgrim of the Bleeding Monastery, cloaked in prayer and sacrifice.”  
](else-if: $backStory is 12)[  
  **You:** “I am the Returned from the Veil, bearer of the ghostly pulse.”  
]  
The ferryman inclines. Lanterns flare, and the skiff drifts from the landing with a soft creak.  
* [[Climb aboard|RiverBoard]]</tw-passagedata><tw-passagedata pid="378" name="CourtCenter" tags="" position="8625,6825" size="100,100">You step into the vast circular chamber. Moonlight filters through cracks in the obsidian dome, illuminating motes of bone dust drifting through the air. At the center stands a low crystalline dais, its facets radiating fractured light in a dozen directions. Hovering above the dais is Corvan’s fragmented essence poised for final reckoning: a swirling nebula of silver filaments, bone splinters, and ghost-lit motes that writhe like lost souls. Snatches of his final thoughts echo through the hall: whispers of grief, ambition, and regret: coalescing into a single, tremulous heartbeat that pulses beneath your feet.  

The statues in their alcoves shift slightly, their empty eyes fixed on that fractured aura, awaiting your judgment.  

* [[Raise your lantern and face the Court|FinalConfrontationSetup]]
</tw-passagedata><tw-passagedata pid="379" name="GalleryRunePress" tags="" position="850,7700" size="100,100">:: GalleryRunePress
The rune glows bright, revealing a hidden panel behind a cluster of lanterns.  
* [[Pull aside the lanterns|GalleryRevealPassage]]  
* [[Step away|LanternGalleryArrival]]</tw-passagedata><tw-passagedata pid="380" name="GalleryRevealPassage" tags="" position="875,7875" size="100,100">:: GalleryRevealPassage
Behind the lanterns is a narrow stair winding downward, its walls lined with skeletal hands holding snuffed lanterns.  
* [[Descend the stair|GalleryDescendStair]]  
* [[Replace the lanterns and return|LanternGalleryArrival]]</tw-passagedata><tw-passagedata pid="381" name="GalleryDescendStair" tags="" position="675,7675" size="100,100">:: GalleryDescendStair
The stair’s steps are slick with wax. Each lantern above sways as you pass, whispering in hushed tones.  
* [[Press on toward the unseen bottom|GalleryBottomStair]]  
* [[Climb back up|LanternGalleryArrival]]</tw-passagedata><tw-passagedata pid="382" name="GalleryReadGuide" tags="" position="1050,7825" size="100,100">:: GalleryReadGuide
Opening the tome, you read: “Only the tender of lanterns may pass: the true flame reveals the path.”  
(set: $journal to it + (a: &quot;I read what could be a clue:“Only the tender of lanterns may pass: the true flame reveals the path.” &quot;+ &quot;\n\n&quot;))
* [[Close the book|LanternGalleryArrival]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="383" name="GalleryOpenHatch" tags="" position="1300,7725" size="100,100">:: GalleryOpenHatch
You unlatch a trapdoor; it creaks open to reveal a shaft glowing with lantern‑blue light.  
* [[Climb down into the hidden vault shaft|GalleryVaultShaft]]  
* [[Step back, hesitant|LanternGalleryArrival]]</tw-passagedata><tw-passagedata pid="384" name="GalleryVaultShaft" tags="" position="1700,7675" size="100,100">:: GalleryVaultShaft
You clamber down the narrow hatch into a tight stone shaft. The walls are slick with dripping ectoplasm and bone fragments crunch beneath your boots. Faint blue lantern‑light spills down from the room above, illuminating runic etchings on the shaft’s carved stones.  

What do you do?  
* [[Descend carefully to the bottom|GalleryVaultLanding]]  
* [[Climb back up to the gallery|LanternGalleryArrival]]












</tw-passagedata><tw-passagedata pid="385" name="GalleryBottomStair" tags="" position="700,7825" size="100,100">:: GalleryBottomStair
At the stair’s end you find an iron door sealed with the tri‑burial sigil. A faint heartbeat echoes from beyond.  
* [[Push the door open|GalleryOpenVaultDoor]]  
* [[Pause to ready yourself|GalleryPrepare]]</tw-passagedata><tw-passagedata pid="386" name="GalleryOpenVaultDoor" tags="" position="725,8000" size="100,100">:: GalleryOpenVaultDoor
You press on the door. It swings inward to reveal a short corridor lit by blue lanterns: and at its end, the entrance to Corvan’s sealed vault.  
* [[Step forward into the vault entrance|VaultEntrance]]  
* [[Hesitate and breathe deeply|GalleryPrepare]]</tw-passagedata><tw-passagedata pid="387" name="GalleryVaultLanding" tags="" position="1475,7775" size="100,100">:: GalleryVaultLanding
Your feet hit cold marble at the shaft’s end. Before you stretches a torch‑lit corridor sealed by a heavy iron door, its surface carved with Corvan’s tri‑burial sigil and faintly glowing runes.  
* [[Approach and study the door|GalleryVaultDoorStudy]]  
* [[Step back and steel your nerves|GalleryVaultPrepare]]</tw-passagedata><tw-passagedata pid="388" name="GalleryVaultPrepare" tags="" position="1575,7925" size="100,100">:: GalleryVaultPrepare
You steady your lantern, check your inventory for keys or reagents, and breathe deeply. The final barrier to Corvan’s vault stands before you.  
* [[Open the door|GalleryVaultOpenDoor]]  
* [[Step back for one more moment|GalleryVaultLanding]]</tw-passagedata><tw-passagedata pid="389" name="GalleryVaultOpenDoor" tags="" position="1775,7925" size="100,100">:: GalleryVaultOpenDoor
You insert the Obsidian Ossuary Key into the hidden slot. With a resonant click, the wards shatter and the iron door swings inward on oily hinges. Beyond lies the final corridor leading to Corvan’s sealed vault.  
* [[Step through into the vault entrance|VaultEntrance]]  
* [[Hesitate at the threshold|GalleryVaultPrepare]]</tw-passagedata><tw-passagedata pid="390" name="GalleryVaultDoorStudy" tags="" position="1350,7925" size="100,100">:: GalleryVaultDoorStudy
You examine the door’s sigil: three interlocking loops bound by runic wards. Through a narrow slot you feel the faint pulse of trapped power.  
* [[Press your hand to the sigil|GalleryVaultSigilTouch]]  
* [[Return to the shaft entrance|GalleryVaultShaft]]</tw-passagedata><tw-passagedata pid="391" name="GalleryVaultSigilTouch" tags="" position="1450,8000" size="100,100">:: GalleryVaultSigilTouch
Your palm hums in time with the heartbeat behind the iron. The runes flare briefly, then a hidden keyhole appears in the center loop.  
* [[Search for a fitting key|GalleryVaultFindKey]]  
* [[Withdraw and reconsider|GalleryVaultLanding]]</tw-passagedata><tw-passagedata pid="392" name="GalleryVaultFindKey" tags="" position="1525,8125" size="100,100">:: GalleryVaultFindKey
(if: $inventory contains “Obsidian Ossuary Key”)[  
  * [[Use the Obsidian Ossuary Key|GalleryVaultOpenDoor]]  
][  
  You search your pack but find no other key that fits this hidden keyhole.  
]  
* [[Step back|GalleryVaultLanding]]</tw-passagedata><tw-passagedata pid="393" name="CartwayPeerBelow" tags="" position="150,10850" size="100,100">:: CartwayPeerBelow
A faint glow pulses where the rails vanish into rubble. Something scurries away: too quick for you to see.  
* [[Move closer toward the glow|CartwayFollowRails]]  
* [[Step back warily|CartwayArrival]]</tw-passagedata><tw-passagedata pid="394" name="CartwayDescend" tags="" position="300,11075" size="100,100">:: CartwayDescend
The downward track dips steeply. Your foot slips on slick moss: (DEX save DC 12 or lose 1 health).  
* [[Regain footing and press on|CartwayDeepTunnel]]  
* [[Climb back up the rails|CartwayArrival]]</tw-passagedata><tw-passagedata pid="395" name="CartwayAscend" tags="" position="462.5,10850" size="100,100">:: CartwayAscend
You clamber up the rails. The tunnel hums with distant chanting. A shaft of pale lantern light beckons above.  
* [[Climb toward the light|CartwayLightShaft]]  
* [[Descend back down|CartwayArrival]]</tw-passagedata><tw-passagedata pid="396" name="CartwayDeepTunnel" tags="" position="700,11300" size="100,100">:: CartwayDeepTunnel
The downward track levels into a long, narrow tunnel; the air hangs heavy with mist and the walls glisten with phosphorescent moss. The rusted rails vanish beneath ankle‑deep mud, and the drip of water echoes like distant footsteps. Ahead, you glimpse a square iron grate set into the floor.  
* [[Inspect the grate|CartwayInspectGrate]]  
* [[Press onward through the mud|CartwayPressOn]]  
* [[Climb back up to the rails|CartwayArrival]]
</tw-passagedata><tw-passagedata pid="397" name="CartwayLightShaft" tags="" position="462.5,10975" size="100,100">:: CartwayLightShaft
You climb toward the shaft. Moon‑blue light filters down, revealing runes carved in the arch above: “Only the lost find their way.”  
* [[Step through the opening|CartwayOpenVaultDoor]]  
* [[Return below|CartwayArrival]]</tw-passagedata><tw-passagedata pid="398" name="CartwayOpenGrate" tags="" position="700,10875" size="100,100">

(if:$cryptKey is true)[
:: CartwayOpenGrate
You fit the Rusted Crypt Key into the grate’s lock. With a heavy clank, the bars unlatch, and the grate lifts away. A short stair slopes down into an iron‑lined passage.  
* [[Descend the hidden stair|CartwayDescendStair]]  
* [[Step through directly to the vault threshold|VaultEntrance]]
]
(else:)[
:: CartwayOpenGrate
You force the grate open. Beyond lies a narrow stair descending into bone‑lined walls.  
* [[Descend the hidden stair|CartwayDescendStair]]  
* [[Close the grate and reconsider|CartwayArrival]]
]</tw-passagedata><tw-passagedata pid="399" name="CartwayDescendStair" tags="" position="900,11000" size="100,100">:: CartwayDescendStair
The stair winds down beneath the mausoleum’s foundations. Faint echoes of your younger laughter linger in the gloom. The short stair deposits you onto cold marble at the base of a torch‑lit corridor: its iron door carved with the tri‑burial sigil stands open and seems to lead to a sort of reinforced vault.  

* [[Step forward into the vault entrance|VaultEntrance]]  
* [[Escape back to the cartway|CartwayArrival]]
</tw-passagedata><tw-passagedata pid="400" name="CartwayBottomStair" tags="" position="600,11125" size="100,100">:: CartwayBottomStair
At the stair’s end a heavy iron door sealed with Corvan’s tri‑burial sigil bars your path. A faint pulse vibrates through the metal.  
* [[Push the door open|CartwayOpenVaultDoor]]  
* [[Pause to ready yourself|CartwayPrepare]]
</tw-passagedata><tw-passagedata pid="401" name="CartwayInspectGrate" tags="" position="350,11475" size="100,100">:: CartwayInspectGrate
You kneel beside the grate. Its iron bars bear the imprint of a key: one you once found in this labyrinth. Through the slats you see a faint lantern‑blue glow.  
(if: $inventory contains “Rusted Crypt Key”)[  
(set:$cryptKey to true)
  * [[Use the Rusted Crypt Key to unlatch it|CartwayOpenGrate]]  
][else:  
  * [[You lack the correct key: step back|CartwayDeepTunnel]]  
]</tw-passagedata><tw-passagedata pid="402" name="CartwayPressOn" tags="" position="600,11475" size="100,100">:: CartwayPressOn
You trudge through the mud, each step sucking at your boots. The tunnel narrows until you must squeeze past a slick wall. As you do, a hidden lever clicks beneath your elbow.  
* [[Pull the lever|CartwayRevealSidePassage]]  
* [[Ignore it and move forward|CartwayBottomStair]]</tw-passagedata><tw-passagedata pid="403" name="CartwayRevealSidePassage" tags="" position="925,11500" size="100,100">:: CartwayRevealSidePassage
The lever shifts a section of wall, revealing a narrow side‑passage lit by a single blue lantern. A faint pulse echoes from within.  
* [[Enter the side‑passage|CartwaySidePassage]]  
* [[Leave it and continue down the main tunnel|CartwayBottomStair]]</tw-passagedata><tw-passagedata pid="404" name="CartwaySidePassage" tags="" position="675,11775" size="100,100">:: CartwaySidePassage
You step into the side‑passage; its walls are carved with miniature funeral wagons. At its end, an iron door bearing Corvan’s tri‑burial sigil waits.  
* [[Prepare to open the door|CartwayPrepare]]  
* [[Return to the main tunnel|CartwayDeepTunnel]]</tw-passagedata><tw-passagedata pid="405" name="LibrarySpellEffect" tags="" position="150,9875" size="100,100">:: LibrarySpellEffect
A swirl of ink shapes into a spectral quill that scribbles runes in the air: then vanishes. Your vision shudders, but no further harm comes.  
* [[Step back|RottedLibraryArrival]]</tw-passagedata><tw-passagedata pid="406" name="LibraryTakeGrimoire" tags="" position="275,9875" size="100,100">:: LibraryTakeGrimoire
You slide the grimoire into your pack. Its pages hum quietly, as if alive with half‑remembered spells.  
(set: $inventory to it + “Rituals of the Severed Mind”)  
* [[Close the shelf|RottedLibraryArrival]]</tw-passagedata><tw-passagedata pid="407" name="LibraryReadFragment" tags="" position="400,9875" size="100,100">:: LibraryReadFragment
You decipher the fragment: “Anchor the mind to flesh, lest the soul wander.” A hidden latch clicks beneath the lectern.  
* [[Press the latch|LibraryRevealDrawer]]  
* [[Ignore it|RottedLibraryArrival]]</tw-passagedata><tw-passagedata pid="408" name="LibraryRevealDrawer" tags="" position="400,10000" size="100,100">:: LibraryRevealDrawer
A secret drawer opens to reveal a folded charred page stamped with a familiar crest: your old Ashen Battalion emblem.  
* [[Unfold it carefully|LibraryVeteranTrigger]]  
* [[Pocket it unseen|RottedLibraryArrival]]</tw-passagedata><tw-passagedata pid="409" name="LibrarySpeakMotto" tags="" position="500,9875" size="100,100">:: LibrarySpeakMotto
You intone “Steel and Ash Endures.” The walls tremble and a hidden door swings open behind a shelf, revealing a narrow stair lit by blue lanterns.  
* [[Step toward the secret stair|LibraryDescendStair]]  
* [[Hesitate to gather yourself|LibraryPrepare]]
</tw-passagedata><tw-passagedata pid="410" name="LibraryPrepare" tags="" position="625,10000" size="100,100">:: LibraryPrepare
You pause on the top step, checking your equipment and bracing for what lies below.  
* [[Continue downward|LibraryDescendStair]]  
* [[Return to the library|RottedLibraryArrival]]</tw-passagedata><tw-passagedata pid="411" name="LibraryStudySigil" tags="" position="1525,9875" size="100,100">:: LibraryStudySigil
You examine the sigil: “Only the ash‑bound may pass.” Beneath it, a small keyhole glows with ember‑red light.  
* [[Use the Ashen Veteran’s Page as a key|LibraryUsePageKey]]  
* [[Step back|LibraryVaultCorridor]]</tw-passagedata><tw-passagedata pid="412" name="LibraryUsePageKey" tags="" position="1525,10000" size="100,100">:: LibraryUsePageKey
You press the charred page into the keyhole; it burns away in glowing embers. The door swings open silently.  
* [[Enter Corvan’s sealed vault|VaultEntrance]]  
* [[Pause one moment|CryptPrepare]]
</tw-passagedata><tw-passagedata pid="413" name="EffigiesRevealNiche" tags="" position="537.5,8600" size="100,100">:: EffigiesRevealNiche
A small panel slides open, revealing a polished bone key etched with aristocratic flourishes.  
(set: $inventory to it + “Bone Chapel Key”)  
* [[Pocket the key|WeepingEffigiesArrival]]</tw-passagedata><tw-passagedata pid="414" name="EffigiesSapFlow" tags="" position="675,8600" size="100,100">:: EffigiesSapFlow
The cold sap soaks through your boots, chilling your feet. In the swirling black, you glimpse ghostly faces: each offering a silent plea.  
(set: $journal to it + (a: &quot;In the sap, I glimpsed ghostly faces: each offering a silent plea &quot;+ &quot;\n\n&quot;))
* [[Shake out your boots|WeepingEffigiesArrival]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="415" name="EffigiesOpenSecretDoor" tags="" position="825,8625" size="100,100">:: EffigiesOpenSecretDoor
The wall behind the crest statue grinds inward, revealing a narrow arch lit by ghostly flame. Beyond lies a spiral stair descending into silence.  
* [[Descend the secret stair|EffigiesDescendStair]]  
* [[Pause to ready yourself|EffigiesPrepare]]</tw-passagedata><tw-passagedata pid="416" name="EffigiesUnlockVaultDoor" tags="" position="1400,8700" size="100,100">:: EffigiesUnlockVaultDoor
You insert the bone key. The lock clicks, and the door swings open onto a torch‑lit corridor leading directly into Corvan’s sealed vault.  
* [[Step through into the vault entrance|VaultEntrance]]  
* [[Hesitate, heart pounding|EffigiesPrepare]]</tw-passagedata><tw-passagedata pid="417" name="EffigiesStudyPortraits" tags="" position="1600,8675" size="100,100">:: EffigiesStudyPortraits
The portraits depict your forebears in mourning dress, eyes hollow with sorrow. One holds a crystal key: its shape matches the rusted iron key you carry.  

As you turn away, a pale mist coalesces before the central portrait. The ghostly shape of an armored ancestor drifts into view: Lord Ashenvale himself, hand trembling as it reaches toward Corvan’s sigil on the frame.  

**Ancestor’s Ghost (wistful):** “I... I buried him here, believing it would end the madness. But my coin poured fuel on his fire.”  
(set: $journal to it + (a: &quot;My ancestor told me:&#39;I... I buried him here, believing it would end the madness. But my coin poured fuel on his fire&#39; &quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Listen to the ancestor’s confession|AshenvaleConfession]]

&lt;!--
:: EffigiesStudyPortraits
The portraits depict your forebears in mourning dress, eyes hollow with sorrow. One holds a crystal key: its shape matches the rusted iron key you carry.  
(set: $journal to it + “Clue: shape‑match key in portrait” )  
* [[Step to the door|EffigiesFamilyPassage]]
--&gt;</tw-passagedata><tw-passagedata pid="418" name="MirrorVaultPressAgain" tags="" position="2225,11625" size="100,100">:: MirrorVaultPressAgain
You press firmly. The glass ripples like water, and a spectral hand reaches out before vanishing. A soft crack forms along one frame edge.  
* [[Follow the crack|MirrorVaultFollowCrack]]  
* [[Step away quickly|MirrorVaultArrival]]</tw-passagedata><tw-passagedata pid="419" name="MirrorVaultFollowCrack" tags="" position="2275,11850" size="100,100">:: MirrorVaultFollowCrack
You trace the crack; it widens into a seam. Behind the mirror you spy a narrow arch bathed in blue lantern light.  
* [[Step through the hidden arch|MirrorVaultHiddenPassage]]  
* [[Let the mirror settle|MirrorVaultArrival]]</tw-passagedata><tw-passagedata pid="420" name="MirrorVaultShatterName" tags="" position="2425,11650" size="100,100">:: MirrorVaultShatterName
You press your palm and the glass shatters inward in slow motion. Behind the rubble lies a carved keyhole in the wall.  
* [[Peer through the opening|MirrorVaultPeerThrough]]  
* [[Abruptly retreat|MirrorVaultArrival]]</tw-passagedata><tw-passagedata pid="421" name="MirrorVaultPeerThrough" tags="" position="2475,11875" size="100,100">:: MirrorVaultPeerThrough
Through the gap you see a corridor lined with runic mirrors. A faint pulse echoes from beyond.  
* [[Squeeze through into the corridor|MirrorVaultMirrorCorridor]]  
* [[Patch the crack and return|MirrorVaultArrival]]</tw-passagedata><tw-passagedata pid="422" name="MirrorVaultTraceInscription" tags="" position="2675,11650" size="100,100">:: MirrorVaultTraceInscription
Your touch reveals hidden runes: “Step through the truth, shatter the lie.” One mirror’s glass grows translucent.  
* [[Enter the translucent mirror|MirrorVaultEnterMirror]]  
* [[Step back|MirrorVaultArrival]]</tw-passagedata><tw-passagedata pid="423" name="MirrorVaultEnterMirror" tags="" position="2825,11700" size="100,100">:: MirrorVaultEnterMirror
You step forward and pass through the mirror’s surface. You emerge in a narrow hall lit by shards of broken glass, leading downward.  
* [[Press on into the glass‑lit hall|MirrorVaultDescendHall]]  
* [[Retreat through the mirror|MirrorVaultArrival]]</tw-passagedata><tw-passagedata pid="424" name="MirrorVaultDescendHall" tags="" position="2975,11850" size="100,100">:: MirrorVaultDescendHall
You step into the mirrored hall, its walls and floor strewn with jagged fragments of obsidian glass that glow with an inner blue light. Your footsteps echo twice as you pass; each shard reflects a dozen versions of yourself in silent judgment. Faint runes pulse along the floor seams, guiding you toward a distant iron door streaked with moonlit cracks.  

What do you do?  
* [[Move carefully along the rune-lit path|MirrorVaultPath]]  
* [[Kneel to inspect a particularly bright shard|MirrorVaultInspectShard]]  
* [[Gather a handful of glowing fragments|MirrorVaultGatherShards]]  
* [[Return through the mirror portal|MirrorVaultArrival]]








</tw-passagedata><tw-passagedata pid="425" name="MirrorVaultStudySigil" tags="" position="3450,11550" size="100,100">:: MirrorVaultStudySigil
The loops of the sigil shimmer like fractured glass. Beneath them, a bone‑shaped keyhole glows faintly.  
* [[Use the Bone Flute to unlock the seal|MirrorVaultFluteKey]]  
* [[Step back|MirrorVaultMirrorCorridor]]</tw-passagedata><tw-passagedata pid="426" name="MirrorVaultFluteKey" tags="" position="3450,11675" size="100,100">:: MirrorVaultFluteKey
You press your flute into the keyhole. It fits perfectly, and when you blow a single note, the lock clicks open.  
* [[Open the door to the vault|MirrorVaultOpenVaultDoor]]  
* [[Pause to steady your nerves|MirrorVaultPrepare]]</tw-passagedata><tw-passagedata pid="427" name="HeartsEndureCold" tags="" position="2450,8325" size="100,100">:: HeartsEndureCold
You grit your teeth as the frost’s bite eases. A faint warmth spreads through your core, as if the heart acknowledged your resolve.  
&lt;!--(set: $buff to it + “Heart’s Resilience”)  --&gt;
* [[Step back|FrozenHeartsArrival]]</tw-passagedata><tw-passagedata pid="428" name="HeartsRevealSeam" tags="" position="2625,8500" size="100,100">:: HeartsRevealSeam
Your fingertip cracks the frost along the seam. A small panel slides open, revealing a slender crystal shard carved with your name in drifting script.  
(set: $inventory to it + “Veil‑Shard Key”)  
* [[Pocket the shard|FrozenHeartsArrival]]</tw-passagedata><tw-passagedata pid="429" name="HeartsApproachAlcove" tags="" position="2825,8350" size="100,100">:: HeartsApproachAlcove
You kneel before the cracked case. Inside rests a frozen key bearing Corvan’s tri‑burial sigil.  
(set: $inventory to it + “Frozen Reliquary Key”)  
* [[Retrieve the key|FrozenHeartsArrival]]  
* [[Study the key’s frost patterns|HeartsStudyKey]]</tw-passagedata><tw-passagedata pid="430" name="HeartsStudyKey" tags="" position="2925,8550" size="100,100">:: HeartsStudyKey
Frost crystals trace a pattern that matches the vault’s seal. Holding the key warms your hand in defiance of the cold.  
(set: $journal to it + (a: &quot;I Learned that the frost pattern matches the vault seal&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Stand and proceed|FrozenHeartsArrival]]</tw-passagedata><tw-passagedata pid="431" name="ChapelStatueTouch" tags="" position="2700,10150" size="100,100">:: ChapelStatueTouch
At your touch, the statue’s runic inscription pulses: “Bound by blood, servant of the bone.” A secret panel at its base clicks.  
* [[Open the panel|ChapelRevealKeyhole]]  
* [[Withdraw your hand|OssuaryChapelArrival]]</tw-passagedata><tw-passagedata pid="432" name="ChapelRevealKeyhole" tags="" position="2700,10275" size="100,100">:: ChapelRevealKeyhole
The panel slides open to reveal a bone‑crafted keyhole. Something clangs within the altar: a hidden lock awaits.  
* [[Search your inventory for a key|ChapelUseKey]]  
* [[Step away|OssuaryChapelArrival]]</tw-passagedata><tw-passagedata pid="433" name="ChapelUseKey" tags="" position="2700,10400" size="100,100">:: ChapelUseKey
(if: $inventory contains “Bone Chapel Key”)[  
  You insert the bone key into the altar’s lock. With a grinding click, stones shift to reveal a narrow stair spiraling down.  
  * [[Descend the hidden stair|ChapelDescendStair]]  
][else:  
  You have no key that fits. The keyhole remains silent and dark.  
]  
* [[Step away|OssuaryChapelArrival]]</tw-passagedata><tw-passagedata pid="434" name="ChapelDescendStair" tags="" position="2700,10525" size="100,100">:: ChapelDescendStair
The spiral stair winds down into darkness, each step carved from polished femurs. A chill mist drifts upward.  
* [[Press on toward the faint glow below|ChapelBoneTunnel]]  
* [[Climb back up|OssuaryChapelArrival]]</tw-passagedata><tw-passagedata pid="435" name="ChapelInvokeWorm" tags="" position="2950,10150" size="100,100">:: ChapelInvokeWorm
You intone the ancient chant. The altar trembles, then cracks open at its base, revealing a bone‑lined corridor beyond.  
* [[Enter the ritual passage|ChapelRitualPassage]]  
* [[Step back, awed|OssuaryChapelArrival]]</tw-passagedata><tw-passagedata pid="436" name="ChapelRitualPassage" tags="" position="2950,10275" size="100,100">:: ChapelRitualPassage
You slip through the opening and step into a narrow hallway lined with rib arches. The air hums with Worm’s power.  
* [[Follow the hall’s curve|ChapelBoneTunnel]]  
* [[Hesitate at the entrance|OssuaryChapelArrival]]</tw-passagedata><tw-passagedata pid="437" name="ChapelVaultDoor" tags="" position="3825,10150" size="100,100">:: ChapelVaultDoor
You stand before the iron door. A small keyhole at its center waits for the Bone Chapel Key.  
* [[Use the Bone Chapel Key|ChapelOpenVaultDoor]]  
* [[Study the sigil’s loops|ChapelStudySigil]]</tw-passagedata><tw-passagedata pid="438" name="ChapelStudySigil" tags="" position="3825,10275" size="100,100">:: ChapelStudySigil
The tri‑burial loops mirror the Worm’s spiral: and your fetish’s carvings. You sense the door will yield only to those bound by worm‑rite.  
* [[Insert the Bone Chapel Key|ChapelOpenVaultDoor]]  
* [[Step back, breath catching|OssuaryChapelArrival]]</tw-passagedata><tw-passagedata pid="439" name="CryptCallSpirit" tags="" position="2450,9150" size="100,100">:: CryptCallSpirit
Your voice cracks through the iron. The moans hush for a heartbeat, then a hollow whisper: “Free me…”  
* [[Attempt to unlock the iron bars|CryptTryUnlock]]  
* [[Withdraw in fear|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="440" name="CryptTryUnlock" tags="" position="2450,9275" size="100,100">:: CryptTryUnlock
The bars are sealed by runes. You need something to break their magic: or a key.  
* [[Search your pack for tools|CryptSearchTools]]  
* [[Step back and think|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="441" name="CryptSearchTools" tags="" position="2450,9400" size="100,100">:: CryptSearchTools
You rummage through your pack: no lockpicks, only bandages and rations.  
* [[Drop to one knee and think|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="442" name="CryptStudyScript" tags="" position="2575,9150" size="100,100">:: CryptStudyScript
You kneel and trace the words: they describe the Severance Rite you endured. Chant its last line, and the bars may open.  
* [[Whisper the final line|CryptChantFinalLine]]  
* [[Stand and reconsider|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="443" name="CryptChantFinalLine" tags="" position="2575,9275" size="100,100">:: CryptChantFinalLine
You murmur the rite’s last phrase. The runes flare then crumble, and the bars swing open. Inside, a librarian’s ghost holds a bone‑etched key.  
* [[Step through and speak to the spirit|CryptSpeakSpirit]]  
* [[Retreat to gather courage|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="444" name="CryptSpeakSpirit" tags="" position="2575,9400" size="100,100">:: CryptSpeakSpirit
**Spirit:** “If you carry the scar of Severance, prove your claim.”  
* [[Show your ritual scar|CryptShowScar]]  
* [[Hesitate|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="445" name="CryptShowScar" tags="" position="2575,9525" size="100,100">:: CryptShowScar
Your arm’s ritual mark glows faintly in the candlelight. The ghost bows and offers the key. 
(set: $inventory to it + “Severance Key”)  
* [[Thank the spirit and step back|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="446" name="CryptStepMarked" tags="" position="2700,9150" size="100,100">:: CryptStepMarked
The tile depresses and a hidden panel slides open at the south wall: revealing the back of the rune‑sealed bars. A corridor beyond glows with blue lantern light.  
* [[Crawl through the opening|CryptSecretPassage]]  
* [[Close the panel and step back|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="447" name="CryptVaultDoor" tags="" position="3175,9275" size="100,100">:: CryptVaultDoor
You stand before the armored door etched with three loops. A keyhole glows faintly where the Severance Key fits.  
* [[Use the Severance Key|CryptOpenVaultDoor]]  
* [[Study the sigil|CryptStudyVaultSigil]]</tw-passagedata><tw-passagedata pid="448" name="CryptStudyVaultSigil" tags="" position="3175,9400" size="100,100">:: CryptStudyVaultSigil
The sigil’s loops trace your own ritual scars. It reads: “Only one reborn through death may enter.”  
* [[Insert the Severance Key|CryptOpenVaultDoor]]  
* [[Step back for one last moment|SilentCryptArrival]]</tw-passagedata><tw-passagedata pid="449" name="PrayingPilgrimTraceEmblem" tags="" position="2200,7400" size="100,100">:: PrayingPilgrimTraceEmblem
As you trace the chalice, the pew trembles. A hidden panel in its side clicks open, revealing a small vial of **Monastery’s Tears**.  
(set: $inventory to it + &quot;Monastery’s Tears&quot;)  
* [[Pocket the vial|PilgrimRestArrival]]</tw-passagedata><tw-passagedata pid="450" name="PrayingPilgrimAltarLift" tags="" position="2325,7400" size="100,100">:: PrayingPilgrimAltarLift
You lift the heavy slab. Beneath lies a spiral keyhole and a hidden lever carved with a bleeding hand.  
* [[Pull the lever|PrayingPilgrimRevealStairs]]  
* [[Close the slab|PilgrimRestArrival]]</tw-passagedata><tw-passagedata pid="451" name="PrayingPilgrimBoneTunnel" tags="" position="3075,7400" size="100,100">:: PrayingPilgrimBoneTunnel
You enter a narrow tunnel carved through bone‑laced stone. Faint blood‑red runes glow along the walls.  
* [[Follow the runes forward|PrayingPilgrimFollowRunes]]  
* [[Step carefully and listen|PrayingPilgrimListenDrips]]</tw-passagedata><tw-passagedata pid="452" name="PrayingPilgrimListenDrips" tags="" position="3075,7525" size="100,100">:: PrayingPilgrimListenDrips
Drips of incense oil echo like distant chanting. Through the gloom you hear a steady pulse: ward magic humming behind the iron door.  
* [[Move toward the sound|PrayingPilgrimFollowRunes]]  
* [[Retreat to the stair|PrayingPilgrimDescendStairs]]
</tw-passagedata><tw-passagedata pid="453" name="PrayingPilgrimUnlockVault" tags="" position="3262.5,7400" size="100,100">:: PrayingPilgrimUnlockVault
You insert the Monastic Key. The lock clicks, and the iron door swings open onto a torch‑lit corridor leading into Corvan’s sealed vault.  
* [[Step through into the vault entrance|VaultEntrance]]  
* [[Pause to ready yourself|CryptPrepare]]</tw-passagedata><tw-passagedata pid="454" name="PrayingPilgrimPrepare" tags="" position="3387.5,7400" size="100,100">:: PrayingPilgrimPrepare
You steady your breathing and check your talismans. Beyond this door lies the Brain Reliquary’s hidden chamber.  
* [[Open the door|VaultEntrance]]  
* [[Step back for one last prayer|PilgrimRestArrival]]</tw-passagedata><tw-passagedata pid="455" name="VaultSigilTouch" tags="" position="2550,6500" size="100,100">:: VaultSigilTouch
Your touch hums in time with the heart’s pulse. A single loop glows: and a hidden keyhole appears.  
* [[Search your inventory for a fitting key|VaultFindKey]]  
* [[Withdraw and rethink|VaultEntrance]]</tw-passagedata><tw-passagedata pid="456" name="VaultFindKey" tags="" position="2550,6625" size="100,100">:: VaultFindKey
(if: $inventory contains “Rusted Crypt Key”)[  
  * [[Use the Rusted Crypt Key|VaultUseKey]]  
][else if: $inventory contains “Obsidian Ossuary Key”)[  
  * [[Use the Obsidian Ossuary Key|VaultUseKey]]  
][else if: $inventory contains “Bone Chapel Key”)[  
  * [[Use the Bone Chapel Key|VaultUseKey]]  
][else if: $inventory contains “Veil‑Shard Key”)[  
  * [[Use the Veil‑Shard Key|VaultUseKey]]  
][else:  
  * [[You have no key that fits|VaultNoKey]]  
]  
* [[Step back|VaultEntrance]]</tw-passagedata><tw-passagedata pid="457" name="VaultNoKey" tags="" position="2550,6750" size="100,100">:: VaultNoKey
None of your keys fit the hidden keyhole. The sigil’s glow dims.  
* [[Return to the door|VaultEntrance]]</tw-passagedata><tw-passagedata pid="458" name="BrainSpeak" tags="" position="2737.5,6375" size="100,100">:: BrainSpeak
**You:** “Corvan? Can you hear me?”  
The brain’s pulse slows, then speaks in a distant whisper:  
**Brain:** “Mortal… you dare intrude.”  
* [[Ask why he is trapped here|BrainAskWhy]]  
* [[Demand he release you|BrainDemandRelease]]  
* [[Remain silent and listen|BrainListen]]</tw-passagedata><tw-passagedata pid="459" name="SanctumRetreat" tags="" position="2875,6375" size="100,100">:: VaultRetreat
You step back from the barrier, breathing hard. The corridor behind you feels safer: at least until you steel yourself for what lies beyond.  
* [[Approach the door again|VaultEntrance]]  
* [[Return to the Necropolis orientation|NecroOrientation]]</tw-passagedata><tw-passagedata pid="460" name="BrainAskWhy" tags="" position="2737.5,6625" size="100,100">:: BrainAskWhy
**You:** “Why are you bound here?”  
**Brain:** “I defied Death itself. My vessel became vault, my mind its ward.”  
* [[Probe for a weakness|BrainProbe]]  
* [[Step back, thoughtful|InnerSanctumEntry]]</tw-passagedata><tw-passagedata pid="461" name="BrainDemandRelease" tags="" position="2862.5,6625" size="100,100">:: BrainDemandRelease
**You:** “Free me, then I’ll free you.”  
**Brain:** “Freedom demands sacrifice.”  
* [[Ask what sacrifice|BrainAskSacrifice]]  
* [[Retreat into silence|InnerSanctumEntry]]</tw-passagedata><tw-passagedata pid="462" name="BrainListen" tags="" position="2987.5,6625" size="100,100">:: BrainListen
The chamber hums as the brain murmurs fragments: “Blood… ritual… heart’s bond… sever once…”  
* [[Press for clarity|BrainProbe]]  
* [[Step away|InnerSanctumEntry]]</tw-passagedata><tw-passagedata pid="463" name="BrainAskSacrifice" tags="" position="3700,6300" size="100,100">:: BrainAskSacrifice
**You:** “What sacrifice?”  
**Brain:** “Your life’s essence… or my chains remain.”  
* [[Offer your own essence|BrainOfferEssence]]  
* [[Refuse and attack|BrainAttack]]</tw-passagedata><tw-passagedata pid="464" name="BrainOfferEssence" tags="" position="3900,6525" size="100,100">:: BrainOfferEssence
You step forward, resolve hardening. “I’ll give you my life to end this.”  
The brain’s glow flares:  
**Brain:** “Then bleed for your cause…”  
* [[Prepare to sacrifice (CONFIRM)|BrainSacrifice]]</tw-passagedata><tw-passagedata pid="465" name="BrainAttack" tags="" position="3475,6600" size="100,100">:: BrainAttack
You draw your weapon and strike at the filaments. The brain’s psychic scream rattles your mind: (WIS save DC 15 or lose 2 health).  
* [[Press the attack|BrainAttack2]]  
* [[Reconsider your approach|InnerSanctumEntry]]</tw-passagedata><tw-passagedata pid="466" name="BrainRecallSerum" tags="" position="3625,5725" size="100,100">:: BrainRecallSerum
You remember the Red Fog Serum in your pack: once used to breach plague wards.  
* [[Pour the serum at the brain’s base|BrainUseSerum]]  
* [[Hold back and choose differently|InnerSanctumEntry]]</tw-passagedata><tw-passagedata pid="467" name="BrainSacrifice" tags="" position="4225,6475" size="100,100">:: BrainSacrifice
You hold your hand over the brain. Some strange electrical streks spreads from your palm as you bleed into the filaments. The brain’s cage fractures: and you collapse as wards break.  You hear a voice screaming, a voice that you instantly recognize as Magister Corvan.
* [[Instead of dying electrocuted, you feel yourself slipping into a soft dream|DreamVision]]</tw-passagedata><tw-passagedata pid="468" name="BrainAttack2" tags="" position="3500,6825" size="100,100">:: BrainAttack2
Your blow severs one filament. The brain convulses, then stabilizes. Another filament flares bright.  
* [[Strike again|BrainAttackLoop]]  
* [[Retreat, wounded|InnerSanctumEntry]]</tw-passagedata><tw-passagedata pid="469" name="BrainAttackLoop" tags="" position="3300,6900" size="100,100">:: BrainAttackLoop
You slash at the floating brain’s silver filaments again and again. Each strike severs one strand, but two more flare back to life. The brain’s psychic scream rattles your mind.  
(health: DAMAGE 1)  
* [[Strike again|BrainAttack2]]  
* [[Reconsider your approach|InnerSanctumEntry]]</tw-passagedata><tw-passagedata pid="470" name="BrainUseSerum" tags="" position="3925,5800" size="100,100">:: BrainUseSerum
You uncork the serum and let the red mist swirl around the filaments. They sizzle and snap: ward magic shatters with a scream of release.  
* [[Step back as the brain floats free|BrainFreed]]</tw-passagedata><tw-passagedata pid="471" name="BrainFreed" tags="" position="4200,5850" size="100,100">:: BrainFreed
The filaments dissolve. The brain hovers, silent and still.  
**Brain:** “You have done what none dared. Rest now… your journey continues.”  
* [[Step forward and touch the brain|BrainTouchFinal]]  
* [[Collapse from exhaustion|BrainCollapse]]</tw-passagedata><tw-passagedata pid="472" name="BrainTouchFinal" tags="" position="4450,5950" size="100,100">:: BrainTouchFinal
Your fingers brush the brain’s surface. A flash of knowledge floods you: secrets of life and death intertwine.  
A city of Progress, in a time where evrything seems possible. But is progress such a good thing? What if it costed you everything? Wouldn&#39;t you be better off leaving this monstruous reality?
You pray you can, one day, forget all the twisted thoughts and memories that overwhealm you. 
(set: $journal to it + (a: &quot;I received fragments of Corvan&#39;s secrets.&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(1000);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[You feel yourself growing weak…|BrainCollapse]]</tw-passagedata><tw-passagedata pid="473" name="DreamChamberApproach" tags="" position="4725,6300" size="100,100">:: DreamChamberApproach
Corvan’s voice echoes, hollow and resonant:  
**Corvan:** “To master death, one must fracture one’s soul.”  
He traces a rune in the air; for an instant it blooms into a blossoming black flower. Behind him the coffin-vessels glow.  

* [[Step closer|DreamChamberCloser]]  </tw-passagedata><tw-passagedata pid="474" name="DreamChamberCloser" tags="" position="4900,6300" size="100,100">:: DreamChamberCloser
As you draw near, the heart-coffin hisses and drips molten silver. Corvan stands, robes sweeping bone-shards.
A shadowy figure materializes and he shivers. You look at him intensly, and he breaks silence.
**Corvan:** “Grief is a mistress crueler than Fate...”  
He glances to a dust-cloaked portrait on the wall: a woman’s face ringed in sorrow.  

* [[Ask about his wife|DreamAskWife]]  
* [[Remain silent|DreamSilentWitness]]  </tw-passagedata><tw-passagedata pid="475" name="DreamBeastApproach" tags="" position="5275,6275" size="100,100">:: DreamBeastApproach
From the shadows, a colossal beast of bone and sinew emerges: its maw dripping with ectoplasm and earth. Its eyes are hollow lanterns, its breath a fetid wind. Corvan smiles, raising his hands.  
**Corvan:** “Feed, oh great Astaroth. Your time is not there yet, but soon, in another place.”  

* [[Prepare to defend|DreamDefend]]  </tw-passagedata><tw-passagedata pid="476" name="DreamConsumed" tags="" position="5875,6275" size="100,100">:: DreamConsumed
Bone-shards pierce your flesh and you feel Corvan’s laughter echo as the creature’s maw closes. Pain blossoms across your mind: and then, oblivion.  

* [[Wake up if you dare...|RiverCourt]]
</tw-passagedata><tw-passagedata pid="477" name="DreamAskWife" tags="" position="4925,6125" size="100,100">:: DreamAskWife
**You (soft):** “Who was she?”  
**Corvan:** “She choose the worst profession... working with those damned machines!&quot;
**You (intrigued):** “Machines? What are those?&quot;
Corvan’s eyes harden.  
**Corvan (lost in his thought):** “She was my anchor. When Mara died… I severed my first link to mortality. The ritual began as love... and ended as hubris.”  

(set: $journal to it + (a: &quot;I learned Corvan lost his wife Mara, sparking the Severance Ritual&quot;+ &quot;\n\n&quot;))
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}
* [[Press him on the ritual’s cost|DreamAskCost]]  
* [[Step back, unsettled|DreamChamberCloser]]  </tw-passagedata><tw-passagedata pid="478" name="DreamSilentWitness" tags="" position="5050,6450" size="100,100">:: DreamSilentWitness
Corvan doesn’t notice you. He pours black sand from the heart-coffin into the brain-coffin with a chant that warps the air. Strange shapes flicker: metal rounded and interlocking shapes that form a contraption, much to Crovan&#39;s dismay. He waves his hand and they change shape: corpse-flowers, skeletal birds, and mirrored faces.  
* [[Watch in awe|DreamBeastApproach]]  </tw-passagedata><tw-passagedata pid="479" name="DreamAskCost" tags="" position="5125,6125" size="100,100">:: DreamAskCost
**You:** “What cost did your ritual demand?”  
**Corvan:** “Every birthright, reality itself, the city I grew up in and lived my entire life, the city of Light. My name was erased, my body fractured, my heart damned. Yet even this was not enough…”  
He turns, spotlighting you.  
**Corvan:** “Now witness the final sacrifice.”  

* [[Recoil as the chamber shudders|DreamBeastApproach]]  </tw-passagedata><tw-passagedata pid="480" name="DreamDefend" tags="" position="5475,6275" size="100,100">:: DreamDefend
You grip your weapon, stance tense. The beast snarls, advancing on four spindly legs. Each footfall cracks bone-tiles beneath you. Around it, reality itself seems to warp, to get redefined. The cathedral becomes a forest. Then, trees become cities and then a desert made of sable roses. 

* [[Strike at its flank|DreamStrike]]  
* [[Dodge to the side|DreamDodge]]  </tw-passagedata><tw-passagedata pid="481" name="DreamStrike" tags="" position="5700,6425" size="100,100">:: DreamStrike
Your blade sears through decayed sinew: beast shrieks in a sound like breaking gravestones. Yet it lunges, jaws snapping shut around you.  

* [[Scream as darkness floods your vision|DreamConsumed]]  </tw-passagedata><tw-passagedata pid="482" name="DreamDodge" tags="" position="5675,6150" size="100,100">:: DreamDodge
You roll aside; the beast’s teeth catch the floor with a thunder-crack. It whips around and closes in, jaws gaping.  

* [[Stand and face it anyway|DreamConsumed]]  </tw-passagedata><tw-passagedata pid="483" name="FinalCrawlUp" tags="" position="7175,6500" size="100,100">:: FinalCrawlUp
You push through damp earth, lungs searing. At the surface, you collapse on black sands beneath a starless sky. A moon - but not yours - no stars: only the echo of rustling bones in the wind.  
&lt;!--(set: $flags to it + “ArrivedAtRiverBank”)  --&gt;
* [[Rise and step forward|RiverBankArrival]]</tw-passagedata><tw-passagedata pid="484" name="RiverCall" tags="" position="7650,6600" size="100,100">:: RiverCall
**You:** “I need passage.”  
The ferryman’s hooded face does not shift. His rasped voice drifts:  
**Ferryman:** “Speak your true name, that I may guide you across.”  
* [[Speak your true name|RiverSpeakName]]  
* [[Hesitate|RiverHesitate]]</tw-passagedata><tw-passagedata pid="485" name="RiverHesitate" tags="" position="7875,6800" size="100,100">:: RiverHesitate
Your throat tightens. The ferryman’s form fades into shadow.  
* [[Step forward and speak your name|RiverSpeakName]]  
* [[Retreat to the shore|RiverBankArrival]]</tw-passagedata><tw-passagedata pid="486" name="RiverCrossing" tags="" position="8075,6475" size="100,100">:: RiverCrossing
The boat glides between pillars carved with severed hearts and broken wills. Each lantern echoes a name you once lost: drifting souls that nod in blessing or lament.  
(set: $buff to it + “NamesBlessing”)  
* [[Disembark at the far shore|RiverDisembark]]</tw-passagedata><tw-passagedata pid="487" name="RiverDisembark" tags="" position="8200,6600" size="100,100">:: RiverDisembark
Mossy steps rise from the water’s edge. Ahead looms a grand hall carved from obsidian bone. Stained‑glass windows depict three vessels: a heart, a brain, and a shattered sigil. This is the Court of Severance.  
* [[Enter the Court’s threshold|CourtThreshold]]</tw-passagedata><tw-passagedata pid="488" name="CourtThreshold" tags="" position="8400,6625" size="100,100">:: CourtThreshold
A vaulted arch of cracked skulls frames the hall. Statues of twelve hooded figures stand in niches: each bearing the icon of a past, yours or someone elses. Their eyes glow as you pass; distant whispers speak of judgment.  
* [[Walk forward, lantern raised|CourtCenter]]  
* [[Pause and recall your trials|CourtRecall]]</tw-passagedata><tw-passagedata pid="489" name="CourtRecall" tags="" position="8575,6625" size="100,100">:: CourtRecall
You remember every trial: your struggle in the Mortuary, the Catacombs, the Ossuary, the Gallery, and beyond. Each site taught you a fragment of Corvan’s Severance Ritual. Now those fragments stand witness here.  
* [[Steady yourself and proceed|CourtCenter]]</tw-passagedata><tw-passagedata pid="490" name="FinalConfrontationSetup" tags="" position="9050,6800" size="100,100">:: FinalConfrontationSetup
You stand in the rotunda of cracked obsidian and bone, lantern-blue flame dancing across twelve alcoves, each dominated by a towering statue. Their hollow eyes follow you, and distant drip of ichor echoes in the vaulted chamber. Above, a domed ceiling fractures into black sky. Corvan’s voice thunders from every corner:

**Corvan (whispered):** “Choose the one who knows your past... or suffer each trial anew.”

* [[Approach the statues|ChooseStatue]]



















































</tw-passagedata><tw-passagedata pid="491" name="NightHBBTPushDoor" tags="" position="8175,2450" size="100,100">:: NightHBBTPushDoor
You lean and shove. The roots resist, then suddenly give way with a roar: soil collapses beneath you!  
* [[Jump back (DEX save DC 13)|NightHalfBuriedBellTowerArrival]]  
* [[Stumble forward|NightHBBTCollapsePit]]</tw-passagedata><tw-passagedata pid="492" name="NightHBBTChant" tags="" position="8325,2450" size="100,100">:: NightHBBTChant
You speak the monk’s words softly. The roots pause their creaking, then retract to reveal a stone slab inset with a carved heart-sigil.  
* [[Prise up the slab|NightHBBTRevealTunnel]]  
* [[Hesitate and step back|NightHalfBuriedBellTowerArrival]]</tw-passagedata><tw-passagedata pid="493" name="NightHBBTAfterKnock" tags="" position="8025,2375" size="100,100">:: NightHBBTAfterKnock
The roots groan and snap: one arches up to strike you!  
(DEX save DC 12 or take 2 health damage)  
* [[Dodge aside|NightHalfBuriedBellTowerArrival]]  
* [[Stand your ground|NightHBBTRootStrike]]</tw-passagedata><tw-passagedata pid="494" name="NightHBBTRootStrike" tags="" position="8025,2500" size="100,100">:: NightHBBTRootStrike
The root lashes your thigh, vines tearing at your leg as you fall. The world spins: and you black out.  
* [[…|GameOver_Entangled]]  </tw-passagedata><tw-passagedata pid="495" name="GameOver_Entangled" tags="" position="8025,2625" size="100,100">:: GameOver_Entangled
The vines tighten. You struggle, but panic and pain overtake you. You never make it out of the roots’ grasp.  
* [[Restart from the square|VelthornHollowOrientation]]</tw-passagedata><tw-passagedata pid="496" name="NightHBBTCollapsePit" tags="" position="8175,2575" size="100,100">:: NightHBBTCollapsePit
The ground opens into a hidden pit. You plummet into darkness, limbs flailing as bone-spikes loom…  
* [[Scream as you fall|GameOver_Pitfall]]</tw-passagedata><tw-passagedata pid="497" name="GameOver_Pitfall" tags="ENDING" position="8200,2700" size="100,100">:: GameOver_Pitfall
You tumble into a coffin-deep shaft. Bone-tipped stakes await below: and you never reach the bottom alive.  

(set:$currentEnding to 4)
(display:&quot;RestartDonnee&quot;)</tw-passagedata><tw-passagedata pid="498" name="NightHBBTRevealTunnel" tags="" position="8325,2575" size="100,100">:: NightHBBTRevealTunnel
Beneath the slab lies a narrow stair descending into damp darkness. A faint blue glow pulses below.  
* [[Descend into the tunnel|NightTunnelEntrance]]  
* [[Close the slab and reconsider|NightHalfBuriedBellTowerArrival]]</tw-passagedata><tw-passagedata pid="499" name="SanctumRevealMechanism" tags="" position="2675,6850" size="100,100">:: SanctumRevealMechanism
Your fingers follow the groove to a nearly invisible lever beneath the dais. Pulling it, the crystalline floor panels shift, revealing Corvan’s ritual knife embedded in bone.  
(set: $inventory to it + “Ritual Knife”)  
* [[Draw the knife and return|SanctumSearch]]  </tw-passagedata><tw-passagedata pid="500" name="MirrorVaultPath" tags="" position="3225,12275" size="100,100">:: MirrorVaultPath
You follow the runes inlaid in the floor. They lead straight to the iron door, its surface carved with the tri-burial sigil. A soft hum vibrates through the glass underfoot.  
* [[Approach the door|MirrorVaultDoor]]  
* [[Pause to steady your nerves|MirrorVaultPrepare]]</tw-passagedata><tw-passagedata pid="501" name="MirrorVaultInspectShard" tags="" position="2975,12025" size="100,100">:: MirrorVaultInspectShard
You crouch to examine a glowing shard. Its edge feels unnaturally warm, and when you peer into its reflection you see a flash of a grand court: your final destination.  
(set: $journal to it + (a: &quot;I saw a vision of the Severance Court in a mirror shard&quot;+ &quot;\n\n&quot;))
* [[Pocket the shard|MirrorVaultDescendHall]]  
* [[Stand and continue on|MirrorVaultPath]]</tw-passagedata><tw-passagedata pid="502" name="MirrorVaultGatherShards" tags="" position="3250,12050" size="100,100">:: MirrorVaultGatherShards
You scoop up several shards. Their glow intensifies in your hand, illuminating hidden runes on the nearby walls.  
(set: $inventory to it + “Mirror Shard”)  
* [[Tuck them safely away|MirrorVaultDescendHall]]</tw-passagedata><tw-passagedata pid="503" name="MirrorVaultDoor" tags="" position="2800,12150" size="100,100">:: MirrorVaultDoor
You stand before the iron door carved with the tri-burial sigil. Through its cracks you hear the distant pulse of Corvan’s wards: and the slow beat of a captured heart.  
* [[Push the door open|VaultPushDoor]]  
* [[Study the sigil’s runes|VaultStudySigil]]</tw-passagedata><tw-passagedata pid="504" name="HeartsOpenVault" tags="" position="3125,8450" size="100,100">:: HeartsOpenVault
You insert the Frozen Reliquary Key into a hidden keyhole at the base of the central case. With a crystalline click, the glass wall slides open, revealing a torch‑lit corridor beyond.  
* [[Step through into Corvan’s sealed vault|VaultEntrance]]  
* [[Pause to gather your courage|HeartsPrepare]]</tw-passagedata><tw-passagedata pid="505" name="Background" tags="" position="4300,875" size="100,100">You leave that poor soul alone and head to the village, although not knowing exactly where it is. 
A few minutes passes and you start to get your bearings.
While the silhouette of the village starts to reveal itself and remove all notion of grandeur from your sorry brain, you try to piece together fragments of your previous existence... But what fragment was yours ?

    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Plagueborn Refugee&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Mask.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
You trudge along the misty lane, the chill in your bones reminding you of fevered nights.
Once, you braved Mourntide’s Red Fog to save the dying, clutching your cracked plague mask close.
You recall the groans of fevered villagers, the desperate prayers for mercy: and your helpless tears.
Every aching step echoes the weight of lives you couldn’t spare, fueling both guilt and resolve.
Now, each breath you draw carries purpose: to heal what remains… or at least to bury what’s left.
(click:&quot;Plagueborn Refugee&quot;)[
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/CrackedPlagueMask.png&quot;&gt;&lt;/div&gt;

&lt;!--AJOUTER OBJET--&gt;
    &lt;script&gt;
    // Tableau contenant l&#39;objet à créer
  const newItemData = {
      id: &quot;crackedPlagueMask&quot;,
      nom: &quot;A cracked Plague Mask&quot;,
        type: &quot;helmet&quot;,
        armor: 3,
      class: &quot;item-img&quot;,
      src: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/CrackedPlagueMask.png&quot;,
      prix: 1000,
      rare: &quot;Mythic&quot;,
      inventory: 20,
    };

   // Création de l&#39;élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute(&#39;data-id&#39;, newItemData.id);
  itemElement.setAttribute(&#39;draggable&#39;, &#39;true&#39;);

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;)) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));

  itemElement.addEventListener(&#39;mouseenter&#39;, (e) =&gt; showTooltip(e, itemElement));
  itemElement.addEventListener(&#39;touchstart&#39;, (e) =&gt; showTooltip(e, itemElement), { passive: false });
&lt;/script&gt;



&lt;!-- ADD CRACKED PLAGUE MASK --&gt;
(set: $backStory to 1)
    &lt;span class=&quot;twine-link&quot;&gt;[[Very well... Now, let&#39;s enter Velthorn Hollow!|VelthornHollowEntry]]&lt;/span&gt;
]
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Graverobber’s Bastard&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Grave.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
With nimble feet you skirt broken stones, memories flickering of midnight heists.
You remember prying open bone-stacked crypts by torchlight, your lockpicks humming in your palm.
Ghostly whispers once guided your greedy fingertips to hidden reliquaries and cursed trinkets.
The thrill of forbidden treasure still pulses through you, along with the fear of Ossuary Knights.
Today, you walk these streets craving both gold and the secrets only the dead dare tell.
(click:&quot;Graverobber’s Bastard&quot;)[
&lt;!--AJOUTER OBJET--&gt;
    &lt;script&gt;
    // Tableau contenant l&#39;objet à créer
  const newItemData = {
      id: &quot;commonHat&quot;,
      nom: &quot;A common hat&quot;,
        type: &quot;helmet&quot;,
        armor: 1,
      class: &quot;item-img&quot;,
      src: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/Hat03.png&quot;,
      prix: 30,
      rare: &quot;Common&quot;,
      inventory: 19,
    };

   // Création de l&#39;élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute(&#39;data-id&#39;, newItemData.id);
  itemElement.setAttribute(&#39;draggable&#39;, &#39;true&#39;);

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;)) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));

  itemElement.addEventListener(&#39;mouseenter&#39;, (e) =&gt; showTooltip(e, itemElement));
  itemElement.addEventListener(&#39;touchstart&#39;, (e) =&gt; showTooltip(e, itemElement), { passive: false });
&lt;/script&gt;

(set: $backStory to 2)
    &lt;span class=&quot;twine-link&quot;&gt;[[Very well... Now, let&#39;s enter Velthorn Hollow!|VelthornHollowEntry]]&lt;/span&gt;
]
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Apprentice Necromancer&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Necromancer.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
Your boots splash through puddles as thoughts of arcane study surge unbidden.
You see your master’s laboratory: bubbling potions, bound skulls, and runes etched in bone.
The final experiment went catastrophically wrong: black flame consuming everything but you.
Your bone wand pulses in your pocket, a reminder of unfinished rites and forbidden power.
Now, each lantern-lit house you pass beckons with knowledge… if you dare reclaim it.
(click:&quot;Apprentice Necromancer&quot;)[
&lt;!--AJOUTER OBJET--&gt;
    &lt;script&gt;
    // Tableau contenant l&#39;objet à créer
  const newItemData = {
      id: &quot;boneEtchedDagger&quot;,
      nom: &quot;A bone-etched Dagger&quot;,
        type: &quot;sword&quot;,
        strength: 3,
      class: &quot;item-img&quot;,
      src: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/boneEtchedDagger.png&quot;,
      prix: 500,
      rare: &quot;Rare&quot;,
      inventory: 19,
    };

   // Création de l&#39;élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute(&#39;data-id&#39;, newItemData.id);
  itemElement.setAttribute(&#39;draggable&#39;, &#39;true&#39;);

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;)) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));

  itemElement.addEventListener(&#39;mouseenter&#39;, (e) =&gt; showTooltip(e, itemElement));
  itemElement.addEventListener(&#39;touchstart&#39;, (e) =&gt; showTooltip(e, itemElement), { passive: false });
&lt;/script&gt;
(set: $backStory to 3)
    &lt;span class=&quot;twine-link&quot;&gt;[[Very well... Now, let&#39;s enter Velthorn Hollow!|VelthornHollowEntry]]&lt;/span&gt;
]
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Exiled Lantern Tender&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Lantern.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
Under the weeping lanterns you walk, a memory stirring of guiding souls at dusk.
You recall the Veil’s thin edge, comforting the lost until one slipped through your grasp.
Shame and sorrow swirl within you like phantom embers around your sputtering light.
Villagers bow their heads as you pass: some in respect, others in fearful pity.
With every step, you vow to redeem your failure… or embrace the darkness you guard.
(click:&quot;Exiled Lantern Tender&quot;)[
&lt;!--AJOUTER OBJET--&gt;
    &lt;script&gt;
    // Tableau contenant l&#39;objet à créer
  const newItemData = {
      id: &quot;lantern01&quot;,
      nom: &quot;A lantern&quot;,
        type: &quot;object&quot;,
        intelligence: 2,
      class: &quot;item-img&quot;,
      src: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/Lantern01.png&quot;,
      prix: 500,
      rare: &quot;Rare&quot;,
      inventory: 19,
    };

   // Création de l&#39;élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute(&#39;data-id&#39;, newItemData.id);
  itemElement.setAttribute(&#39;draggable&#39;, &#39;true&#39;);

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;)) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));

  itemElement.addEventListener(&#39;mouseenter&#39;, (e) =&gt; showTooltip(e, itemElement));
  itemElement.addEventListener(&#39;touchstart&#39;, (e) =&gt; showTooltip(e, itemElement), { passive: false });
&lt;/script&gt;

(set: $backStory to 4)
    &lt;span class=&quot;twine-link&quot;&gt;[[Very well... Now, let&#39;s enter Velthorn Hollow!|VelthornHollowEntry]]&lt;/span&gt;
]
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;


    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Noble Scion of the Pale Court&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Noble.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
You stride past shuttered windows, recalling silken halls and whispered intrigues.
Courtiers once knelt before you: now they avert their eyes and mutter superstitions.
Your ancestral ring weights heavy on your finger, a relic of privileges long gone.
You remember the knife in the dark, betrayal turning allies into ash.
Now, you walk these streets determined to reclaim your legacy… or let it perish.
(click:&quot;Noble Scion of the Pale Court&quot;)[
&lt;!--AJOUTER OBJET--&gt;
    &lt;script&gt;
    // Tableau contenant l&#39;objet à créer
  const newItemData = {
      id: &quot;ringNobleScion01&quot;,
      nom: &quot;The Scion&#39;s Nobles ring&quot;,
        type: &quot;object&quot;,
        intelligence: 2,
      class: &quot;item-img&quot;,
      src: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/RingNobleScion.png&quot;,
      prix: 1000,
      rare: &quot;Rare&quot;,
      inventory: 19,
    };

   // Création de l&#39;élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute(&#39;data-id&#39;, newItemData.id);
  itemElement.setAttribute(&#39;draggable&#39;, &#39;true&#39;);

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;)) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));

  itemElement.addEventListener(&#39;mouseenter&#39;, (e) =&gt; showTooltip(e, itemElement));
  itemElement.addEventListener(&#39;touchstart&#39;, (e) =&gt; showTooltip(e, itemElement), { passive: false });
&lt;/script&gt;
(set: $backStory to 5)
    &lt;span class=&quot;twine-link&quot;&gt;[[Very well... Now, let&#39;s enter Velthorn Hollow!|VelthornHollowEntry]]&lt;/span&gt;
]
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;


    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Last of the Severed&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Severed.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
Your footsteps echo on cobbles as flashes of that night blaze behind your eyes.
You recall the Severance Ritual’s searing pain, the moment everyone else was consumed.
Your scarred arm tingles with the echo of shattered souls bound within you.
A hush falls over the village as you pass: it senses the survivor of a forbidden rite.
Today, you seek answers: was your survival salvation… or the world’s greatest sin?
(click:&quot;Last of the Severed&quot;)[
&lt;!--AJOUTER OBJET--&gt;
    &lt;script&gt;
    // Tableau contenant l&#39;objet à créer
  const newItemData = {
      id: &quot;RedthreadVeil&quot;,
      nom: &quot;The Redthread Veil&quot;,
        type: &quot;helmet&quot;,
        intelligence: 2,
      class: &quot;item-img&quot;,
      src: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/RedthreadVeil.png&quot;,
      prix: 1000,
      rare: &quot;Rare&quot;,
      inventory: 19,
    };

   // Création de l&#39;élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute(&#39;data-id&#39;, newItemData.id);
  itemElement.setAttribute(&#39;draggable&#39;, &#39;true&#39;);

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;)) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));

  itemElement.addEventListener(&#39;mouseenter&#39;, (e) =&gt; showTooltip(e, itemElement));
  itemElement.addEventListener(&#39;touchstart&#39;, (e) =&gt; showTooltip(e, itemElement), { passive: false });
&lt;/script&gt;
(set: $backStory to 6)
    &lt;span class=&quot;twine-link&quot;&gt;[[Very well... Now, let&#39;s enter Velthorn Hollow!|VelthornHollowEntry]]&lt;/span&gt;
]
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;


    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Cultist of the Worm&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Cultist.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
Mud squelches beneath your boots as the Worm’s whispers coil in your mind.
You remember the hollow chants, flesh offered in dark ceremonies for unholy gifts.
A hunger stirs in your gut, the parasite’s voice urging you to feed… or perish.
Villagers recoil at your passing, their fear as tangible as the worm’s squeeze.
With each step, you weigh the price of this power: your body’s freedom… or your soul’s.
(click:&quot;Cultist of the Worm&quot;)[
&lt;!--AJOUTER OBJET--&gt;
    &lt;script&gt;
    // Tableau contenant l&#39;objet à créer
  const newItemData = {
      id: &quot;WyrmClaspBrooch&quot;,
      nom: &quot;A Wyrm-Clasp Brooch&quot;,
        type: &quot;object&quot;,
        intelligence: 2,
      class: &quot;item-img&quot;,
      src: &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/WyrmClaspBrooch.png&quot;,
      prix: 1000,
      rare: &quot;Rare&quot;,
      inventory: 19,
    };

   // Création de l&#39;élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute(&#39;data-id&#39;, newItemData.id);
  itemElement.setAttribute(&#39;draggable&#39;, &#39;true&#39;);

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;)) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));

  itemElement.addEventListener(&#39;mouseenter&#39;, (e) =&gt; showTooltip(e, itemElement));
  itemElement.addEventListener(&#39;touchstart&#39;, (e) =&gt; showTooltip(e, itemElement), { passive: false });
&lt;/script&gt;
(set: $backStory to 7)
    &lt;span class=&quot;twine-link&quot;&gt;[[Very well... Now, let&#39;s enter Velthorn Hollow!|VelthornHollowEntry]]&lt;/span&gt;
]
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Grave Singer&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/GraveSinger.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
A distant lament drifts to you on the wind, stirring the song half-forgotten in your bones.
You recall crowds hushed by your bone flute, guiding restless spirits to final rest.
Your own voice once soothed the dead: but could not still your own restless heart.
Now, the echoes of your unfinished melody follow you through silent lanes.
Each stride draws you closer to Widow Marrow’s door, where your song might find its end.
(click:&quot;Grave Singer&quot;)[
(set: $backStory to 8)
    &lt;span class=&quot;twine-link&quot;&gt;[[Very well... Now, let&#39;s enter Velthorn Hollow!|VelthornHollowEntry]]&lt;/span&gt;
]
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;


    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Ashen War Veteran&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Veteran.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
Your boots crunch on ash-dusted stones as battlefield memories flare in your chest.
You remember the final charge against revenant hordes, shield raised against wave after wave.
A cursed shell fragment still burns beneath your ribs, a trophy of near-fatal valor.
Nightmares bleed into waking hours, turning every shadow into an old enemy.
Today, you walk toward Velthorn Hollow’s gates, ready to face both ghost and memory.
(click:&quot;Ashen War Veteran&quot;)[
(set: $backStory to 9)
    &lt;span class=&quot;twine-link&quot;&gt;[[Very well... Now, let&#39;s enter Velthorn Hollow!|VelthornHollowEntry]]&lt;/span&gt;
]
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;


    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Street Orphan of Greyglass&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Orphan.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
Your quick steps carry you past fractured mirrors, reflections dancing at the edge of vision.
You recall alleyway scrambles, nimble hands lifting coins from skeletal merchants’ sputtering wares.
Laughter and shards of glass once marked your playground: now they guard your forgotten past.
Your heart races with the thrill of secrets hidden in every cracked window.
With each footfall, you chase the story of who you were…and who you might become.
(click:&quot;Street Orphan of Greyglass&quot;)[
(set: $backStory to 10)
    &lt;span class=&quot;twine-link&quot;&gt;[[Very well... Now, let&#39;s enter Velthorn Hollow!|VelthornHollowEntry]]&lt;/span&gt;
]
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;


    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Pilgrim of the Bleeding Monastery&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Pilgrim.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
Rain-slick stones guide your path as memories of bloody hymns stir within your mind.
You recall chanting monks, prayers soaked with crimson tears whispering of redemption.
Your prayer beads weigh heavy, each one a memory of faith tested by suffering.
Villagers bow low at your approach, sensing the pilgrim who drank of sacred blood.
Today, you walk on, seeking absolution in secrets the Monastery still guards.
(click:&quot;Pilgrim of the Bleeding Monastery&quot;)[
(set: $backStory to 11)
    &lt;span class=&quot;twine-link&quot;&gt;[[Very well... Now, let&#39;s enter Velthorn Hollow!|VelthornHollowEntry]]&lt;/span&gt;
]
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;


    &lt;div class=&quot;character-info&quot;&gt;
  &lt;h2 class=&quot;character-title&quot;&gt;Returned from the Veil&lt;/h2&gt;
    &lt;div class=&quot;character-rangement&quot;&gt;
    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Return.png&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;character-description&quot;&gt;
Fog swirls around your boots as you feel the borrowed beat of your own heart.
You died once: then something yanked you back, leaving you half-remembered, half-alive.
Your pale skin still shimmers faintly with otherworldly glow, a mark of that crossing.
Onlookers whisper and stare, sensing the soul that cheated death’s final embrace.
Each step carries you toward Velthorn Hollow… and the debt you must repay for return.
(click:&quot;Returned from the Veil&quot;)[
(set: $backStory to 12)
    &lt;span class=&quot;twine-link&quot;&gt;[[Very well... Now, let&#39;s enter Velthorn Hollow!|VelthornHollowEntry]]&lt;/span&gt;
]
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

&lt;script&gt;
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem(&quot;characterUnlocked&quot;) === &quot;true&quot;;
        const characterButton = document.querySelector(&#39;.nav-btn[data-panel=&quot;skills&quot;]&#39;);
        const elementsToHide = document.querySelectorAll(&#39;.top-nav, .xp-container, .inventory-sidebar&#39;);

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove(&quot;disabled-btn&quot;);
                characterButton.disabled = false;
            } else {
                characterButton.classList.add(&quot;disabled-btn&quot;);
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el =&gt; {
            el.style.display = characterUnlocked ? &quot;&quot; : &quot;none&quot;;
        });
    }

    // Met à jour l&#39;état de l&#39;UI à chaque changement de passage
    $(document).on(&#39;:passagerender&#39;, function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
&lt;/script&gt;</tw-passagedata><tw-passagedata pid="506" name="ChooseStatue" tags="" position="9050,7075" size="200,100">&lt;!--(set: $backStory to 2)--&gt;
:: ChooseStatue
Twelve statues stand in a half-circle. Each bears the imagery of a past life: a ruined mask, a cracked key, a bleeding chalice, a worm coiled in bone, and more. You must touch the one that reflects your history.
{
(if: $backStory is 1)[  
  * [[Touch the statue marked by a blood-soaked mask|StatueRefugee]]  
]  
(else:)[  
  * [[Touch the statue marked by a blood-soaked mask|StatueWrong1]]  
]

(if: $backStory is 2)[  
  * [[Touch the statue holding a rusted hook|StatueBastard]]  
]  
(else: )[ 
  * [[Touch the statue holding a rusted hook|StatueWrong2]]  
]

(if: $backStory is 3)[  
  * [[Touch the statue cradling a single skull|StatueNecromancer]]  
]  
(else: )[
  * [[Touch the statue cradling a single skull|StatueWrong3]]  
]

(if: $backStory is 4)[  
  * [[Touch the statue bearing a lantern-flame|StatueLanternTender]]  
]  
(else:  )[
  * [[Touch the statue bearing a lantern-flame|StatueWrong4]]  
]

(if: $backStory is 5)[  
  * [[Touch the statue crowned with ice|StatueScion]]  
]  
(else:  )[
  * [[Touch the statue crowned with ice|StatueWrong5]]  
]

(if: $backStory is 6)[  
  * [[Touch the statue shackled in chains|StatueSevered]]  
]  
(else:  )[
  * [[Touch the statue shackled in chains|StatueWrong6]]  
]

(if: $backStory is 7)[  
  * [[Touch the statue with a coiled worm|StatueCultist]]  
]  
(else:  )[
  * [[Touch the statue with a coiled worm|StatueWrong7]]  
]

(if: $backStory is 8)[  
  * [[Touch the statue holding a bone flute|StatueSinger]]  
]  
(else:  )[
  * [[Touch the statue holding a bone flute|StatueWrong8]]  
]

(if: $backStory is 9)[  
  * [[Touch the statue bearing a charred standard|StatueVeteran]]  
]  
(else:  )[
  * [[Touch the statue bearing a charred standard|StatueWrong9]]  
]

(if: $backStory is 10)[  
  * [[Touch the statue with tiny shackled feet|StatueOrphan]]  
]  
(else:  )[
  * [[Touch the statue with tiny shackled feet|StatueWrong10]]  
]

(if: $backStory is 11)[  
  * [[Touch the statue kneeling before a chalice|StatuePilgrim]]  
]  
(else:  )[
  * [[Touch the statue kneeling before a chalice|StatueWrong11]]  
]

(if: $backStory is 12)[  
  * [[Touch the transparent, star-glimmering statue|StatueReturned]]  
]  
(else:  )[
  * [[Touch the transparent, star-glimmering statue|StatueWrong12]]  
]
}</tw-passagedata><tw-passagedata pid="507" name="TrueStatueSuccess" tags="" position="9075,8325" size="100,100">:: TrueStatueSuccess
As you step forward, the statues’ eyes dim and the dais grooves fill with crackling light. Corvan’s final form materializes above the basin: a swirling mass of bone shards, bound by silver filaments.

**Corvan (echoing):** “Now choose your destiny…”  
* [[Bind his essence and mend the Veil|BindEnding]]  
* [[Claim his power as the new Magister|ReplaceEnding]]  
* [[Shatter the fragments and end his line|DestroyEnding]]</tw-passagedata><tw-passagedata pid="508" name="StatueRefugee" tags="" position="7625,7450" size="100,100">:: StatueRefugee
The mask lifts itself from the statue’s face and offers you a small vial of scarlet mist: the Red Fog Serum.  
(set: $inventory to it + “Red Fog Serum”)  
* [[Accept and step forward|TrueStatueSuccess]]</tw-passagedata><tw-passagedata pid="509" name="StatueWrong1" tags="ENDING" position="7725,7975" size="100,100">:: StatueWrong1
The blood-soaked mask glows red at your touch. A searing apparition of your past guilt floods your mind, burning you with regret.  
(click:&quot;regret&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    (set: $health to it - 2)  
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:

A surge of necrotic energy erupts from the blood-soaked mask, and your lungs seize as pestilent vapors choke the life from you, collapsing you into an endless fevered dream.
(set:$currentEnding to 8)
(display:&quot;RestartDonnee&quot;)
    ]

 ]
 ]
</tw-passagedata><tw-passagedata pid="510" name="StatueBastard" tags="" position="7900,7450" size="100,100">:: StatueBastard
The hook loosens in the statue’s hand, revealing the Rusted Crypt Key wrapped in bone-dust.  
(set: $inventory to it + “Rusted Crypt Key”)  
* [[Take it and step forward|TrueStatueSuccess]]</tw-passagedata><tw-passagedata pid="511" name="StatueWrong2" tags="ENDING" position="7975,7975" size="100,100">:: StatueWrong2
The rusted hook clamps shut around your wrist: spectral chains lash at your soul. Pain sears through your bones.  

(click:&quot;your bones&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    (set: $health to it - 1)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
The rusted hook snaps closed on your wrist and drags you screaming into a yawning pit, your bones crushed beneath the earth like shards of shattered hope.
(set:$currentEnding to 9)
(display:&quot;RestartDonnee&quot;)
    ]

 ]
 ]
</tw-passagedata><tw-passagedata pid="512" name="StatueNecromancer" tags="" position="8100,7450" size="100,100">:: StatueNecromancer
The skull drifts down into your hand, whispering the layout of the hidden ossuary tunnels. A hidden door opens.  
(set: $flags to it + “UnlockedOssuaryPath”)  
* [[Proceed through the door|TrueStatueSuccess]]</tw-passagedata><tw-passagedata pid="513" name="StatueWrong3" tags="ENDING" position="8250,7950" size="100,100">:: StatueWrong3
The skull in the statue’s arms whispers your darkest secret and you reel in horror, a phantom hand clawing at your heart.  

(click:&quot;your heart&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    (set: $health to it - 1)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
A spectral skull materializes, its hollow eyes burning with ancient malice, and its whisper fractures your mind: shreds of your sanity torn away as you slump into madness.
(set:$currentEnding to 10)
(display:&quot;RestartDonnee&quot;)
    ]

 ]
 ]</tw-passagedata><tw-passagedata pid="514" name="StatueLanternTender" tags="" position="8350,7425" size="100,100">:: StatueLanternTender
The lantern lights in your hand, its flame steady and bright. A secret alcove glows open.  
(set: $flags to it + “LanternPathOpen”)  
* [[Step inside|TrueStatueSuccess]]</tw-passagedata><tw-passagedata pid="515" name="StatueWrong4" tags="ENDING" position="8500,7925" size="100,100">:: StatueWrong4
The lantern’s flame flares, scorching your face with cold fire. Ice shards pierce your flesh.  
(click:&quot;your flesh&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
The lantern’s flame flares with unnatural cold, encasing your heart in ice. You clutch your chest, breath stolen, and the world goes silent under a frozen sky.
(set:$currentEnding to 11)
(display:&quot;RestartDonnee&quot;)
    ]
    ]
    ]</tw-passagedata><tw-passagedata pid="516" name="StatueScion" tags="" position="8600,7425" size="100,100">:: StatueScion
The ice crown melts, revealing a frozen rune at your feet. You crack it with your heel.  
(set: $flags to it + “ScionRuneCracked”)  
* [[Proceed to the rune-lit stair|TrueStatueSuccess]]</tw-passagedata><tw-passagedata pid="517" name="StatueWrong5" tags="ENDING" position="8725,7900" size="100,100">:: StatueWrong5
The crown of ice freezes your thoughts; you stagger, vision blurred by frost.  
 
(click:&quot;vision blurred by frost&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
Shards of ice leap from the crown and pierce your temples. Your vision blurs in frost-stained darkness as you stagger and fall, your last gasp lost in the shards.
(set:$currentEnding to 12)
(display:&quot;RestartDonnee&quot;)
    ]
    ]
    ]</tw-passagedata><tw-passagedata pid="518" name="StatueSevered" tags="" position="8850,7425" size="100,100">:: StatueSevered
The chains disappear, leaving behind the Severance Key glinting in the dais light.  
&lt;!-- TRANSFORMING ???--&gt;
(set: $inventory to it + “Severance Key”)  
* [[Pocket it and advance|TrueStatueSuccess]]</tw-passagedata><tw-passagedata pid="519" name="StatueWrong6" tags="ENDING" position="8975,7900" size="100,100">:: StatueWrong6
Chains erupt from the floor, wrapping your legs. You struggle, breath failing.  

(click:&quot;vision blurred by frost&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
Ethereal chains erupt from the floor, wrapping tight around your limbs. You struggle futilely as cold steel squeezes the breath from your lungs, and the chamber echoes your final cry.
(set:$currentEnding to 13)
(display:&quot;RestartDonnee&quot;)
    ]
    ]
    ]</tw-passagedata><tw-passagedata pid="520" name="StatueCultist" tags="" position="9125,7425" size="100,100">:: StatueCultist
The worm coiling in the statue’s palm dissolves into a Fetish Worm you carry on your wrist.  
&lt;!-- STRONGER --&gt;
(set: $inventory to it + “Fetish Worm”)  
* [[Press on to the altar|TrueStatueSuccess]]</tw-passagedata><tw-passagedata pid="521" name="StatueWrong7" tags="ENDING" position="9250,7875" size="100,100">:: StatueWrong7
A writhing worm of shadow slithers across your arm, injecting venomous doubt into your veins.  

(click:&quot;vision blurred by frost&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
A shadow-worm bursts from the statue’s palm and burrows under your skin. You collapse as its venom floods your veins, your last thoughts writhing in agony.
(set:$currentEnding to 14)
(display:&quot;RestartDonnee&quot;)
    ]
    ]
    ]</tw-passagedata><tw-passagedata pid="522" name="StatueSinger" tags="" position="9350,7425" size="100,100">:: StatueSinger
The bone flute drifts into your grasp, humming with power. A hidden panel slides open underfoot.  
&lt;!-- STRONGER ? --&gt;
(set: $inventory to it + “Bone Flute”)  
* [[Enter the panel|TrueStatueSuccess]]</tw-passagedata><tw-passagedata pid="523" name="StatueWrong8" tags="ENDING" position="9500,7850" size="100,100">:: StatueWrong8
Your flute song turns to screams as phantom notes shatter your ears.  

(click:&quot;vision blurred by frost&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
A dirge of shattering bone rings in your ears as the flute’s notes slice through your flesh. You crumple under the weight of broken melodies, every breath a crack in your resolve.
(set:$currentEnding to 15)
(display:&quot;RestartDonnee&quot;)
    ]
    ]
    ]</tw-passagedata><tw-passagedata pid="524" name="StatueVeteran" tags="" position="9625,7425" size="100,100">:: StatueVeteran
The charred standard burns away, leaving a banner fragment you can bear.  
(set: $inventory to it + “Battalion Banner”)  
* [[Carry it and move forward|TrueStatueSuccess]]</tw-passagedata><tw-passagedata pid="525" name="StatueWrong9" tags="ENDING" position="9750,7825" size="100,100">:: StatueWrong9
The standard burns your flesh with phantom embers. You cry out in pain.  

(click:&quot;vision blurred by frost&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
Embers flare across the standard’s charred banner, igniting your flesh in ghost-fire. You writhe as the flames consume your hope, leaving only ash and silence.
(set:$currentEnding to 16)
(display:&quot;RestartDonnee&quot;)
    ]
    ]
    ]</tw-passagedata><tw-passagedata pid="526" name="StatueOrphan" tags="" position="9875,7425" size="100,100">:: StatueOrphan
The tiny shackles clatter to the ground, revealing the Greyglass Graffiti Fragment tucked in the floor tile.  
(set: $inventory to it + “Graffiti Fragment”)  
* [[Pick it up|TrueStatueSuccess]]</tw-passagedata><tw-passagedata pid="527" name="StatueWrong10" tags="ENDING" position="10000,7825" size="100,100">:: StatueWrong10
The tiny shackled feet twitch and kick at your shins, sending shockwaves through your body.  

(click:&quot;vision blurred by frost&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
Tiny shackles clamp your ankles and you stagger, blood pooling at your feet. The iron clasps tighten with each heartbeat until your legs give way and the darkness swallows you.
(set:$currentEnding to 17)
(display:&quot;RestartDonnee&quot;)
    ]
    ]
    ]</tw-passagedata><tw-passagedata pid="528" name="StatuePilgrim" tags="" position="10125,7425" size="100,100">:: StatuePilgrim
The chalice lifts itself and pours a drop of Monastery’s Tears into your hand.  
(set: $inventory to it + “Monastery’s Tears”)  
* [[Drink and press on|TrueStatueSuccess]]</tw-passagedata><tw-passagedata pid="529" name="StatueWrong11" tags="ENDING" position="10250,7825" size="100,100">:: StatueWrong11
Blood wells from the chalice, splashing your face with holy ichor that burns like acid.  

(click:&quot;vision blurred by frost&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
A droplet of holy ichor splashes into your eye, burning like acid. You stumble blind and disoriented, your screams swallowed by the monastic gloom.
(set:$currentEnding to 18)
(display:&quot;RestartDonnee&quot;)
    ]
    ]
    ]</tw-passagedata><tw-passagedata pid="530" name="StatueReturned" tags="" position="10375,7425" size="100,100">:: StatueReturned
The statue’s star-glimmering form whispers in your mind and leaves behind the Veil-Shard Key.  
(set: $inventory to it + “Veil-Shard Key”)  
* [[Take it and step forward|TrueStatueSuccess]]</tw-passagedata><tw-passagedata pid="531" name="StatueWrong12" tags="ENDING" position="10475,7825" size="100,100">:: StatueWrong12
A chill gasp of the Veil stuns you; your soul quivers on the brink of oblivion.  

(click:&quot;vision blurred by frost&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
A cold gust from the star-glimmering statue freezes your soul. You shiver into nothingness as the Veil’s chill claim you, your final breath lost in the void.
(set:$currentEnding to 19)
(display:&quot;RestartDonnee&quot;)
    ]
    ]
    ]</tw-passagedata><tw-passagedata pid="532" name="BindEnding" tags="ENDING" position="8800,8650" size="100,100">You place each vessel: heart, brain, name: into its pedestal and speak words drawn from your travels and trials. Light surges along the crystal filaments, weaving the three shards of Corvan’s soul into a single radiant tapestry of bone and spirit. Lantern-blue flame washes over the hall, purging corruption and knitting broken wards back together.

Light floods the Court as you bind Corvan’s shattered vessels into a single, whole soul. The Veil shivers and then settles, renewed.

(if: $job is 1)[  
  As a Gravebinder, you sense every spirit’s chains loosen under your hands: you guided their rest once, and now you mend the greatest fracture of all.  
]  
(elseif: $job is 2)[  
  As a Bone-Singer, your melodies still echo in every ossuary: today your final dirge heals the wound Corvan opened, and even the statues seem to sway in silent tribute.  
]  
(elseif: $job is 3)[  
  As a Spellwright, your runes bind flesh and spirit alike: your glyphwork on the pedestals wove Corvan’s shards into harmony where his own magic failed.  
]  
(elseif: $job is 4)[  
  As a Lantern-Tender, your flame guided lost souls here and now your lantern’s glow sealed their fates in lasting peace, beating back the shadows he once unleashed.  
]  
(elseif: $job is 5)[  
  As a Courtier, you understand the weight of lineage: your wise words at each pedestal echoed the ancient rites and restored balance where hubris once ruled.  
]  
(else:)[  
  As a Shadowstrider, you moved unseen through death’s halls: your silent steps on the dais bound the severed, proving that grace need not glare to be strong.  
]

(if: $backStory is 1)[  
  Once the Plagueborn Refugee, you bore loss in your veins: today, that sorrow became strength, and every drop of your Red Fog Serum sealed a wound in Corvan’s soul.  
]  
(elseif: $backStory is 2)[  
  The Graverobber’s Bastard, you unearthed secrets in tombs: now those same secrets unlocked the path to Corvan’s heart, and you laid his pieces to rest with a thief’s tender care.  
]  
(elseif: $backStory is 3)[  
  Apprentice of Death, you spoke to the dead and learned their rites: today your necromantic lore wove life back into Corvan’s fractured mind.  
]  
(elseif: $backStory is 4)[  
  Exiled Lantern Tender, your flame once guided ghosts through darkness: now that very light healed the severed bonds, shepherding Corvan’s soul home.  
]  
(elseif: $backStory is 5)[  
  Noble Scion of the Pale Court, you carried your family’s honor through ruin: today you restored another’s dignity, proving worth is measured by compassion.  
]  
(elseif: $backStory is 6)[  
  Last of the Severed, you know sacrifice’s price: your scars matched Corvan’s own, and your freedom spurred the ritual that fused his broken essence whole.  
]  
(elseif: $backStory is 7)[  
  Cultist of the Worm, you embraced decay’s truth: today that understanding fed the ritual that bound life and death in unity.  
]  
(elseif: $backStory is 8)[  
  Grave Singer, your dirge once unchained sorrow: now your final melody sealed Corvan’s spirits in peaceful rest.  
]  
(elseif: $backStory is 9)[  
  Ashen War Veteran, your steel-forged will endured horrors: today that resolve hammered Corvan’s shards back into a single, unbreakable core.  
]  
(elseif: $backStory is 10)[  
  Orphan of Greyglass, you carved hope in dark alleys: today you carved the missing pieces of Corvan’s soul, proving that even the lost can heal great wounds.  
]  
(elseif: $backStory is 11)[  
  Pilgrim of the Bleeding Monastery, your prayers soothed torment: today those same prayers wove the final incantation to bind Corvan’s essence.  
]  
(else:)[  
  Returned from the Veil, you walked between worlds: today you guided Corvan across the threshold, sealing the breach with your ghost-borne insight.  
]

As the ritual completes, your vision blurs. You collapse at the foot of the dais, only to awaken outside the Cemetery Gate at dawn’s first light. Your wounds are healed, and the Red Fog Serum in your veins grants you a faint aura of calm vitality. You find in your pack a single crystal heart shard: a gift from Corvan’s spirit, now at peace.

Velthorn Hollow Renewed
In the days that follow, the village stirs with hopeful energy. The sap-drunk mugs at the Mourning Oak Inn no longer bring nightmares but consoling dreams of loved ones. The Weeping Lantern Arch’s tears run clear, and the hidden grate to the Mortuary Hall remains: but no restless spirit hounds the square at night. Graveyards bloom with ghost-orchids once more, and for the first time in decades, townsfolk whisper of rebuilding.

The Necropolis Transformed
The Mortuary Hall’s wards glow gently instead of glaring. Catacomb corridors cease to twist, and living statues stand mute sentinel rather than attack. The River of Forgotten Names still flows, but its ferryman now guides willing souls to their rightful rest. You are remembered as the “Binder of Shards,” honored with a quiet niche in the Lantern-lit Gallery: your lantern forever burning as a beacon for lost spirits.

A New Balance
By mending Corvan’s fractured soul rather than destroying it, you restore the natural order: death remains death, and the veil between worlds is neither rent nor overshadowed by a new tyrant. You carry Corvan’s final blessing in your heart, a promise that grief and hubris can be healed, not simply ended.

(set:$currentEnding to 1)
(display:&quot;RestartDonnee&quot;)

{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(2000);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="533" name="ReplaceEnding" tags="ENDING" position="9075,8650" size="100,100">You step onto the dais and draw the crown of bone and silver overhead. Power crackles through your veins: Corvan’s fragmented will merging with your own. The statues bow and the Court’s obelisk pulses once, then settles into silence.

When you awaken, you stand in the Mortuary Hall’s antechamber, now draped in bone-filigreed tapestries bearing your sigil. Your eyes glow faintly in the lantern light; a ghostly choir murmurs your name. You are no longer merely mortal but risen: the New Magister of Severance.


You claim Corvan’s crown of bone and shadow; power surges through every chamber and you rise as the New Magister.

(if: $job is 1)[  
  As a Gravebinder, your chains now command the dead: tombs tremble at your word, yet you bind them with compassion learned from the hearts you once healed.  
]  
(elseif: $job is 2)[  
  As a Bone-Singer, your song now shapes fleshless bones into guardians for your rule: each echo a testament to your artistry and authority.  
]  
(elseif: $job is 3)[  
  As a Spellwright, your mastery of runes now governs life and death: your new edicts etched in arcane script over every vault door.  
]  
(elseif: $job is 4)[  
  As a Lantern-Tender, your flame now lights the way for spirits you command: withered passages burn bright at your summon.  
]  
(elseif: $job is 5)[  
  As a Courtier, your diplomacy now rules the dead: you broker pacts between mourning families and restless shades.  
]  
(else:)[  
  As a Shadowstrider, you move unseen through halls of bone: no secret remains hidden from your new eyes.  
]

(if: $backStory is 1)[  
  Plagueborn no more, you wield the Red Fog Serum as your signature decree: any who fall ill under your reign find swift and thorough reprieve… or discipline.  
]  
(elseif: $backStory is 2)[  
  Graverobber’s Bastard now commands the crypts: your stolen keys unlock vaults at your whim, and even Corvan’s private chambers lie open.  
]  
(elseif: $backStory is 3)[  
  Apprentice turned Master of Death, your necromantic tomes rewrite themselves in your handwriting, proclaiming your doctrine to bones and spirits alike.  
]  
(elseif: $backStory is 4)[  
  Exile ends as your lantern now hangs in every chapel: each glow a reminder that your flame guides both living and dead.  
]  
(elseif: $backStory is 5)[  
  Scion reborn, your family crest now adorns every tombstone: your house reshaped by your grim stewardship.  
]  
(elseif: $backStory is 6)[  
  Severed last no more, your chains now bind oathbreakers: and your Severance Key demands tribute from every soul.  
]  
(elseif: $backStory is 7)[  
  Worm-cultist exalted, you spread the Worm’s blessing through the Necropolis, and even carrion blooms under your hand.  
]  
(elseif: $backStory is 8)[  
  Singer-turned-sovereign, your final dirge resounds at ceremonies: every funeral your court presides over echoes your reign.  
]  
(elseif: $backStory is 9)[  
  Veteran-general of bone and ash, your banners fly over every crypt: your orders cemented in the marrow of your followers.  
]  
(elseif: $backStory is 10)[  
  Orphan-ruler, your graffiti sigil now marks every gate: your rise from nameless urchin to Magister ignites hope in the downtrodden.  
]  
(elseif: $backStory is 11)[  
  Pilgrim-high priest, your bleeding hymn becomes the state liturgy: your tears sanctify every sacrifice.  
]  
(else:)[  
  Veil-returned, you bridge life and death: your rule extends beyond the Grave, uniting two realms under your sovereign hand.  
]

The village awakes to decree: all deaths here shall pass through your Mortuary Hall. Some hail you as savior: ferryman to the afterlife: while others murmur of a new tyranny born in bone. The Rotted Market thrives anew, trading in grave-goods and ritual wares. The Mourning Oak Inn trades tears for visions of the future, commanded by your word.

The Necropolis as Your Domain
You walk the Ossuary of Echoes free of wards and fear, commanding living statues to rebuild fractured corridors. The Ossuary Chapel becomes your shrine, where you teach the Severance Rite to worthy acolytes. The River of Forgotten Names flows no more; instead, your gate stands open for any who swear fealty, escaping death or forging new unlife.

A Kingdom of Bone and Blood
By replacing Corvan, you reshape the balance: death is harnessed, memories are currency, and your rule ensures the Necropolis’s dark majesty. Those who love you call the age the “Bone Dawn”: a time of power for those who walk its halls: while those who mourn freedom speak quietly of overthrow. Your legacy is not final peace, but a new order born from shattered souls.

(set:$currentEnding to 2)
(display:&quot;RestartDonnee&quot;)

{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(2000);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="534" name="DestroyEnding" tags="ENDING" position="9350,8650" size="100,100">With ritual knife in hand, you slash through each vessel: heart, brain, and name: sending a shockwave of crystalline shards across the Court of Severance. Bone splinters rain down as Corvan’s last vestiges snap free. The statues shatter one by one, and the vaulted chamber trembles before collapsing into dust.

With a single stroke, you shatter Corvan’s last remnants: bone, brain, and name: unleashing a cascade of glass and dust.

(if: $job is 1)[  
  As a Gravebinder, you break every chain you once respected: tombs collapse and spirits flee, leaving the Necropolis empty and silent.  
]  
(elseif: $job is 2)[  
  As a Bone-Singer, you silence the chorus of bones: no more melodies echo in ossuaries, only the hush of ruin.  
]  
(elseif: $job is 3)[  
  As a Spellwright, your final rune obliterates wards: magic itself fractures, leaving the world more mortal than before.  
]  
(elseif: $job is 4)[  
  As a Lantern-Tender, your flame snuffs out the lantern woods: no wisp remains to guide, only darkness.  
]  
(elseif: $job is 5)[  
  As a Courtier, you void every oath: treaties unmade, alliances severed, the Pale Court collapses into anarchy.  
]  
(else:)[  
  As a Shadowstrider, you erase every footprint: no path remains in the catacombs, only the void you create.  
]

(if: $backStory is 1)[  
  Once Plagueborn, your Red Fog Serum boils away: no cure remains for plague here; the living cling ever more desperately to life.  
]  
(elseif: $backStory is 2)[  
  Graverobber’s Bastard no longer robs: crypt doors lock forever, and every stolen secret turns to dust in your wake.  
]  
(elseif: $backStory is 3)[  
  Apprentice of Death, your necromancy ends: no soul stirs at your command, and the dead sleep on undisturbed.  
]  
(elseif: $backStory is 4)[  
  Lantern Tender no more, your flame dies: souls wander lost, and nighttime fears return to haunt the village.  
]  
(elseif: $backStory is 5)[  
  Noble Scion, your lineage crumbles: no memorial stands to honor past glories, and the Court’s history ends with you.  
]  
(elseif: $backStory is 6)[  
  Last of the Severed, your chains lie broken: no sacrifice left to bind, and the Severance Rite is forgotten.  
]  
(elseif: $backStory is 7)[  
  Worm-cultist, your parasite dies: no rot grants knowledge, and forbidden lore is lost to time.  
]  
(elseif: $backStory is 8)[  
  Grave Singer, your final dirge falls silent: no tears echo, and sorrow has no voice.  
]  
(elseif: $backStory is 9)[  
  Ashen Veteran, your war ends: no more battles cry for your steel, and peace bleeds quietly across the land.  
]  
(elseif: $backStory is 10)[  
  Orphan of Greyglass, your graffiti fades: no mark remains of your survival, and every alley lies blank.  
]  
(elseif: $backStory is 11)[  
  Pilgrim of Bones, your hymn ends: the monastery’s gates close forever, and prayers go unheard.  
]  
(else:)[  
  Returned from the Veil, you cross once more into oblivion: no bridge remains, and the worlds stay sundered.  
]

You awaken in the bone-choked tunnel beneath the cemetery gate, your hands slick with ichor and glass. The world is silent: no hiss of spirits, no echo of footsteps, only your ragged breath. Clambering free, you emerge under a pale sunrise, the old cemetery gate hanging open at your touch.

Velthorn Hollow’s Quiet Reprieve
The village feels emptier without ghosts: and yet closer to peace. The sap-drunk mugs stagnate; lanterns flicker out; statues that once wept now stand cold and dry. Mourning Oak’s patrons sip ale without visions, and for the first time, the living outnumber the dead. Villagers breathe easier, though at what cost they do not yet know.

The Necropolis Fallen Silent
Enter the Gate and the Mortuary Hall stands stripped of wards: doors lie open, corridors lie bare, ossuaries lie emptied. No ferryman rows the River of Forgotten Names, for no name remains to guide. The labyrinth becomes a ruin once more, a place for fearless archaeologists rather than mourners or necromancers.

&lt;!-- if you are severd yourself...--&gt;

A World Without Severance
By shattering Corvan’s final remnants, you end his unnatural grasp on life and death: but you leave a wound in the Veil. The boundary between worlds lies open, bleeding: a silent dark that creeps outward unless someone tends the fracture. You vanish from the village’s memory, becoming a ghost story told to children, while the Necropolis drifts into legend, a place of bones and broken promises.

(set:$currentEnding to 3)
(display:&quot;RestartDonnee&quot;)

{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(2000);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="535" name="AshenvaleConfession" tags="" position="1375,8925" size="100,100">:: AshenvaleConfession
**Ancestor’s Ghost:** “In ‘Anno Severis,’ I funded Corvan’s first Severance: foolish hope that he’d bind death’s touch for our house’s glory. Instead, he fractured his soul… and ours with it.”  
* [[Ask why he hid the brain here|AshenvaleAskWhy]]  
* [[Step back, overwhelmed, perhaps it is best not to know.|WeepingEffigiesArrival]]</tw-passagedata><tw-passagedata pid="536" name="AshenvaleAskWhy" tags="" position="1250,9125" size="100,100">:: AshenvaleAskWhy
**You:** “Why bury his brain beneath your crypt?”  
**Ancestor’s Ghost (shaking head):** “Shame, fear… I feared his mind would rise again. So I hid it under our family’s vault, hoping the earth would keep it bound.”  
(set: $journal to it + (a: &quot;My ancestor told me:&#39;I feared his mind would rise again. So I hid it under our family’s vault&#39; &quot;+ &quot;\n\n&quot;))
* [[Press him for the vault’s location|AshenvaleRevealLocation]]  
* [[Thank him and step back|WeepingEffigiesArrival]]
&lt;!-- TEST JOURNAL
* [[If you’ve learned of your family’s link to Corvan, confront Lord Ashenvale’s ghost with your discovery|AshenvaleGhostConfront]]
--&gt;
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(100);
}, &quot;1000&quot;);
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="537" name="AshenvaleRevealLocation" tags="" position="1475,9225" size="100,100">:: AshenvaleRevealLocation
**Ancestor’s Ghost:** “Four stones south of the chapel’s heart-shrine: knock thrice, then give your true name. The earth will grant entrance.”  
(set: $flags to it + “KnowAshenvaleVaultInstructions”)  
* [[Note the instructions and step back|WeepingEffigiesReturn]]</tw-passagedata><tw-passagedata pid="538" name="WeepingEffigiesReturn" tags="" position="1675,9225" size="100,100">:: WeepingEffigiesReturn
You stand before the chapel’s heart-shrine again. Four flat stones lead south. The moonlight seems to point the way.  
* (if: $flags contains “KnowAshenvaleVaultInstructions”)[  
  * [[Knock thrice and speak your name|AshenvaleVaultEntrance]]  
]  
* [[Return to the hall|WeepingEffigiesArrival]]</tw-passagedata><tw-passagedata pid="539" name="AshenvaleVaultEntrance" tags="" position="1825,9325" size="100,100">:: AshenvaleVaultEntrance
You rap thrice on the fourth stone and whisper your true name. A hidden panel slides open to reveal a narrow stair descending into darkness.  
* [[Descend with caution|AshenvaleVaultDescent]]</tw-passagedata><tw-passagedata pid="540" name="AshenvaleVaultDescent" tags="" position="1925,9475" size="100,100">:: AshenvaleVaultDescent
The stair winds down beneath dust and root. Faint echo of a heartbeat leads the way. At the bottom, a stone door bears Corvan’s sigil and your ancestor’s crest interlaced.  
* [[Push open the door|VaultEntrance]]  
* [[Step back and steel yourself|CryptPrepare]]</tw-passagedata><tw-passagedata pid="541" name="Passage sans titre 2" tags="" position="3200,3575" size="100,100">:: CryptPitfallTrap
(Insert in any long corridor where you offer a “step forward” choice.)  
You step on a mosaic tile depicting a skull: only it gives way beneath your foot. The floor collapses into a spike-filled pit. You scream once before impaling your spine on jagged bone.

:: CryptGasTrap
(Insert after “inspect sarcophagi” or similar lore-reading passage.)  
As you crouch to read the rune-carved sarcophagus, a hidden vent hisses, flooding the chamber with pale green gas. Your lungs seize in seconds; your vision blacks out in mid-breath.

:: CryptCeilingSlab
(Insert when the player examines a loose flagstone.)  
You pry at a loose flagstone: and the entire ceiling groans. A slab the size of a tombstone crashes down, shattering your ribs like pottery.

:: CryptAcidPool
(Insert when the player wades into a shallow pool of bone dust.)  
You slip into a concealed pool of bubbling ichor that sizzles your flesh. Your skin peels away in burning ribbons as your body collapses into the bubbling acid.

:: CryptSpectralGrasp
(Insert when the player reaches out to touch a ghostly imprint or handprint.)  
You reach out to touch a phantom handprint: and ghostly arms erupt from the stone, lashing your throat until your vision fades into cold gray oblivion.

:: CryptCoffinRackCollapse
(Insert if the player climbs onto a shelf of coffins.)  
You clamber onto a shelf of stone coffins: the weight shifts and the rack topples. You’re buried alive beneath a mountain of stone lids.

:: CryptMirrorCurse
(Insert when the player picks up a shard of mirror.)  
You lift a gleaming glass shard: its edge cuts your palm and a red rune flares on your wrist. Within heartbeats, your veins blacken as cursed blood binds you to a deadly stillness.

:: CryptRibGuillotine
(Insert under a low arch obstacle, when player “duck to pass”).  
You duck under a low bone arch: suddenly a hidden bone blade swings down, slicing you in two before you can scream.

:: CryptSkullChalicePoison
(Insert when player drinks from a skull chalice).  
You lift the half-buried skull to drink its liquid: then agony strikes as venom floods your arteries. Your tongue swells, your throat constricts, and you choke in the poison’s grip.

:: CryptDustQuicksand
(Insert when player steps into a patch of ash-like dust).  
You mistake fine ash for solid ground: your foot sinks, then you sink deeper until the dust clogs your nostrils and mouth. You suffocate in a granular tomb.

:: CryptBoneSpear
(Insert when player tries to pry a decorative bone spear from the wall).  
You yank the spear: suddenly it twists to life and impales you through the shoulder. You stagger back, only to be skewered through the heart by its twin.

:: CryptFlameBackdraft
(Insert when player lights a torch under a censer).  
You ignite the censer’s fumes: a backdraft roars through the chamber, engulfing you in a pillar of flame that sears you from head to toe.
</tw-passagedata><tw-passagedata pid="542" name="Roll2D" tags="" position="1700,650" size="100,100">{
(set: $counter to 10)
(live: 0.2s)[

(set: $diceRoll1 to (random: 1,6))
(set: $diceRoll1Link to &quot;&lt;img class=&#39;cssde&#39; src=&#39;https://pickyouruniverse.com/DataProjects/General/Dé/&quot; + (str: $diceRoll1) + &quot;.png&#39;&gt;&quot;)

(set: $diceRoll2 to (random: 1,6))
(set: $diceRoll2Link to &quot;&lt;img class=&#39;cssde&#39; src=&#39;https://pickyouruniverse.com/DataProjects/General/Dé/&quot; + (str: $diceRoll2) + &quot;.png&#39;&gt;&quot;)

 &lt;table style=&quot;    display: flex;width: 100%; justify-content: center;&quot;&gt;
 	&lt;tr&gt;
      &lt;td&gt;$diceRoll1Link&lt;/td&gt;
      &lt;td&gt;$diceRoll2Link&lt;/td&gt;
    &lt;/tr&gt;
   &lt;/table&gt;



	(set: $counter to it - 1)
	(if: $counter is 0)
    [(stop:) (set:$diceRoll to (str:$diceRoll1+$diceRoll2))The result is $diceRoll
    (set:$diceRoll to (num:$diceRoll))
    ]
]
}</tw-passagedata><tw-passagedata pid="543" name="Roll1D" tags="" position="1700,525" size="100,100">{
(set: $counter to 10)
(live: 0.2s)[

(set: $diceRoll1 to (random: 1,6))
(set: $diceRoll1Link to &quot;&lt;img class=&#39;cssde&#39; src=&#39;https://pickyouruniverse.com/DataProjects/General/Dé/&quot; + (str: $diceRoll1) + &quot;.png&#39;&gt;&quot;)

 &lt;table style=&quot;    display: flex;width: 100%; justify-content: center;&quot;&gt;
 	&lt;tr&gt;
      &lt;td&gt;$diceRoll1Link&lt;/td&gt;
    &lt;/tr&gt;
   &lt;/table&gt;



	(set: $counter to it - 1)
	(if: $counter is 0)
    [(stop:) (set:$diceRoll to (str:$diceRoll1))The result is $diceRoll
    (set:$diceRoll to (num:$diceRoll))
    ]
]
}</tw-passagedata><tw-passagedata pid="544" name="Damage" tags="" position="1700,775" size="100,100">(click:&quot;&quot;)[
(display:&quot;Roll2D&quot;)

 (live: 3s)[
    (stop:)
You lost (str:$diceRoll) health points
(set:$health to it - $diceRoll)

 ]
 ]
 &lt;!-- - armor ? --&gt;</tw-passagedata><tw-passagedata pid="545" name="LungSings" tags="" position="1175,5550" size="100,100">The lung&#39;s chanting gets more intense, so intense your ears starts to bleed!
(click:&quot;bleed&quot;)[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $strength &gt;= $diceRoll)
    [But you manage to pull yourself out of the transe that was beggining to take hold.
    You only suffer minor injuries.
    (click:&quot;injuries&quot;)[
(display:&quot;Roll1D&quot;)

 (live: 3s)[
    (stop:)
You lost (str:$diceRoll) health points
(set:$health to it - $diceRoll)
(if:$health&lt;=0)[
(set:$currentEnding to 33)
(display:&quot;RestartDonnee&quot;)
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(300);
}, &quot;1000&quot;);
&lt;/script&gt;
}
]
(else:)[
* [[Step back while you still can!|HallOrganCases]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(30);
}, &quot;1000&quot;);
&lt;/script&gt;
}
]
 ]
 ]
    ]
(else:)
    [You get yourself in a transe, your entire body surrendering to the lung&#39;s chant.
        (click:&quot;the lung&#39;s chant&quot;)[
(display:&quot;Roll2D&quot;)

 (live: 3s)[
    (stop:)
You lost (str:$diceRoll) health points
(set:$health to it - $diceRoll)
(if:$health&lt;=0)[
(set:$currentEnding to 34)
(display:&quot;RestartDonnee&quot;)
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(600);
}, &quot;1000&quot;);
&lt;/script&gt;
}
]
(else:)[
* [[Step back while you still can!|HallOrganCases]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp(60);
}, &quot;1000&quot;);
&lt;/script&gt;
}
]
 ]
 ]
    
    ]

 ]
 ]</tw-passagedata><tw-passagedata pid="546" name="AshenvaleGhostConfront" tags="" position="1250,9250" size="100,100"></tw-passagedata><tw-passagedata pid="547" name="initMacroPassage" tags="" position="2300,450" size="100,100">{
(set:$introText to &quot;You lean too far: arms flailing: and nearly topple into the well! You catch yourself, heart pounding, as a gout of chilly mist splashes your face. &quot;)
(set:$clickTest to &quot;splashes your face&quot;)
(set:$AttributeTest to $luck)
(set:$SuccessText to &quot;You take a moment to compose yourself...&quot;)
(set:$FailureText to &quot;  You hurt your hand while catching yourself...&quot;)
(set:$clickDamage to &quot;catching yourself&quot;)
(set:$damageType to 1)
(set:$DeathText to &quot;The mist smells faintly of damp earth: and something bitter beneath it. Almost at once your throat constricts, burning as the cold fumes lace your lungs with toxin. You choke and stagger back, vision narrowing to a pinpoint as the poison steals your breath. In a final rasp, the world goes black around you.&quot;)
(set:$currentEnding to 22)
(set:$LinkText to &quot;Steady yourself and step back&quot;)
(set:$FailureLinkText to &quot;You bandage your hand, steady yourself and step back...&quot;)
(set:$Link to &quot;ShroudedWellArrival&quot;)

(set:$xpSuccess to 30)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:&quot;MacroPassage&quot;)</tw-passagedata><tw-passagedata pid="548" name="DamageTestPassage" tags="" position="1375,2225" size="100,100">{
(set:$introText to &quot;You rap on each tomb door. Silence answers: until a loose panel slams shut behind you, making you jump.&quot;)
(set:$clickTest to &quot;making you jump&quot;)
(set:$AttributeTest to $charisma)
(set:$SuccessText to &quot;You stand up, picking yourself up, and whatever tried to intimidate you crawls back to where it came from.&quot;)
(set:$FailureText to &quot;The loose panel snaps over your shoulder, slamming you forward into a narrow corridor.&quot;)
(set:$clickDamage to &quot;narrow corridor&quot;)
(set:$damageType to 2)
(set:$DeathText to &quot;Before you can recover, the chamber door behind you swings shut with bone-crushing force, trapping your chest between stone and wood. Your ribs fracture, lungs collapse, and the world goes black as your last breath is squeezed from you in a final, rattling gasp.&quot;)
(set:$currentEnding to 27)
(set:$LinkText to &quot;Step back, heart still racing&quot;)
(set:$FailureLinkText to &quot;Step back, heart racing&quot;)
(set:$Link to &quot;ForgottenGraveyardGateArrival&quot;)

(set:$xpSuccess to 35)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:&quot;MacroPassage&quot;)</tw-passagedata><tw-passagedata pid="549" name="BSSTrap" tags="" position="475,950" size="100,100">:: ShrineTreasureDiscovery
You crouch beside the Bone-Stacked Shrine, teeth and femurs piled like savage totems. Faint whispers drift on the breeze, hinting at hidden treasure. Between two skulls you spot a small iron box, its lid etched with childish runes.  
* [[Try to open the box|ShrineAttemptOpen]]  
* [[Ignore it and step back|BoneStackedShrineArrival]]

</tw-passagedata><tw-passagedata pid="550" name="ShrineAttemptOpen" tags="" position="475,1100" size="100,100">:: ShrineAttemptOpen
You lift the lid. Inside, a tarnished silver trinket glints: then the box shudders.  
* [[Grab the trinket and hold tight|ShrineToxicBlast]]  
* [[Drop it and leap away|ShrineEvade]]</tw-passagedata><tw-passagedata pid="551" name="ShrineToxicBlast" tags="" position="625,1100" size="100,100">{
(set:$shrineTreasure to false)
(set:$introText to &quot;The box snaps shut with a pop, unleashing a cloud of sickly green gas. Whispers crackle in your ears: laughter and curses woven together. You choke as the fumes fill your lungs. &quot;)
(set:$clickTest to &quot;your lungs&quot;)
(set:$AttributeTest to $strength)
(set:$SuccessText to &quot;You grit your teeth and force deep breaths. The poison’s grip loosens; your cough fades to a rasp. Though weakened, you rise on shaking legs, determined to press onward. &quot;)
(set:$FailureText to &quot;Your vision swims. Your throat tightens, and your head pounds in time with distant mocking laughter.  &quot;)
(set:$clickDamage to &quot;mocking laughter&quot;)
(set:$damageType to 2)
(set:$DeathText to &quot;Your knees buckle. The laughter echoes as your sight darkens. You gasp once: then the world slips away.&quot;)
(set:$currentEnding to 25)
(set:$LinkText to &quot;Steady yourself and return.&quot;)
(set:$FailureLinkText to &quot;Gasp for breath and Press on despite the terrible cough&quot;)
(set:$Link to &quot;BoneStackedShrineArrival&quot;)
|BoneStackedShrineArrival
(set:$xpSuccess to 24)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:&quot;MacroPassage&quot;)</tw-passagedata><tw-passagedata pid="552" name="ShrineEvade" tags="" position="625,950" size="100,100">:: ShrineEvade
You hurl the trinket aside and dive clear just as the box erupts. The toxic cloud billows past your cloak. You cough once, but your lungs burn instead of seize.  
* [[Catch your breath and step back|BoneStackedShrineArrival]]</tw-passagedata><tw-passagedata pid="553" name="Passage sans titre 1" tags="" position="2500,150" size="100,100">Ajouter images inventaire
$inventory
Ajouter illustrations

TheThreeBurials/imagejeux/Icons/Hat01.png
TheThreeBurials/imagejeux/Icons/Hat02.png
TheThreeBurials/imagejeux/Icons/Hat03.png
TheThreeBurials/imagejeux/Icons/boneEtchedDagger.png

    &lt;div class=&quot;character-portrait&quot;&gt;&lt;img class=&quot;ImgCharacter&quot; src= &quot;https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Mask.png&quot;&gt;&lt;/div&gt;

Donner de l&#39;argent
(click:&quot;argent&quot;)[
(set:$money to it +50)
 &lt;script&gt;
 updateHealth($health)
&lt;/script&gt;
]

Faire baisser des points de vie
(click:&quot;vie&quot;)[
(set:$health to it -2)
 &lt;script&gt;
 updateHealth($health)
&lt;/script&gt;
]

Remettre à zéro
(click:&quot;zéro&quot;)[
&lt;script&gt;
  localStorage.clear();
  sessionStorage.clear();
&lt;/script&gt;
]</tw-passagedata><tw-passagedata pid="554" name="Admin" tags="Admin" position="900,0" size="200,100"></tw-passagedata><tw-passagedata pid="555" name="Zone Notes" tags="ZoneNotes" position="1675,0" size="200,100"></tw-passagedata><tw-passagedata pid="556" name="Code de jeux" tags="CodeJeux" position="1650,275" size="200,100"></tw-passagedata><tw-passagedata pid="557" name="casino" tags="" position="1575,400" size="100,100">&lt;script&gt;
if (typeof $money !== &quot;number&quot;) {
  $money = 1000;
}

window.casinoGameHTML = `
  &lt;style&gt;
    .casino-console {
      font-family: &#39;Orbitron&#39;, sans-serif;
      background: linear-gradient(145deg, #0a0f30, #1a1f40);
      color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      width: 320px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
      border: 1px solid #00ffff33;
      text-align: center;
    }
    .casino-console h2 {
      margin-bottom: 1rem;
      color: #00ffff;
      font-size: 1.4rem;
      text-shadow: 0 0 5px #00ffffaa;
    }
    .casino-console button {
      background-color: #00aaff;
      color: #fff;
      border: none;
      padding: 0.6rem 1.2rem;
      margin: 0.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      transition: background 0.2s ease;
      cursor: pointer;
    }
    .casino-console button:hover {
      background-color: #0088cc;
    }
    .casino-console #message {
      min-height: 1.5em;
      margin: 1rem 0;
      font-style: italic;
    }
    .casino-console input[type=&quot;number&quot;] {
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      width: 140px;
      margin-bottom: 1rem;
      text-align: center;
    }
    .centrerBouton {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  &lt;/style&gt;
  &lt;div class=&quot;casino-console&quot;&gt;
    &lt;h2&gt;🛸 Galactic Casino&lt;/h2&gt;
    &lt;div id=&quot;credits&quot;&gt;Credits: &lt;strong&gt;${$money}&lt;/strong&gt;&lt;/div&gt;
    &lt;input id=&quot;wagerInput&quot; type=&quot;number&quot; min=&quot;1&quot; placeholder=&quot;Enter your bet&quot;&gt;
    &lt;div id=&quot;message&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;centrerBouton&quot;&gt;
      &lt;button id=&quot;betBtn&quot;&gt;Place Bet&lt;/button&gt;
      &lt;button id=&quot;cashBtn&quot;&gt;Cash Out&lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;
`;

// Modal creation (if not already done)
if (!window._casinoModalInit) {
  window._casinoModalInit = true;

  const overlay = document.createElement(&#39;div&#39;);
  Object.assign(overlay.style, {
    position: &#39;fixed&#39;,
    top: &#39;0&#39;,
    left: &#39;0&#39;,
    width: &#39;100vw&#39;,
    height: &#39;100vh&#39;,
    background: &#39;rgba(0,0,20,0.8)&#39;,
    display: &#39;none&#39;,
    alignItems: &#39;center&#39;,
    justifyContent: &#39;center&#39;,
    zIndex: 9999
  });
  document.body.appendChild(overlay);

  const container = document.createElement(&#39;div&#39;);
  overlay.appendChild(container);

  window.twShowModal = function (html) {
    container.innerHTML = html;
    overlay.style.display = &#39;flex&#39;;
  };
  window.twHideModal = function () {
    overlay.style.display = &#39;none&#39;;
    container.innerHTML = &#39;&#39;;
  };
}

// Game logic
window.setupCasino = function () {
  let credits = $money;

  const creditsEl = document.getElementById(&#39;credits&#39;);
  const messageEl = document.getElementById(&#39;message&#39;);
  const betBtn = document.getElementById(&#39;betBtn&#39;);
  const cashBtn = document.getElementById(&#39;cashBtn&#39;);
  const wagerInput = document.getElementById(&#39;wagerInput&#39;);

  function render() {
    creditsEl.innerHTML = &#39;Credits: &lt;strong&gt;&#39; + credits + &#39;&lt;/strong&gt;&#39;;
    if (credits &lt;= 0) {
      messageEl.textContent = &quot;💥 You&#39;re out of credits!&quot;;
      betBtn.disabled = true;
      wagerInput.disabled = true;
    }
  }

  function flipQuantum() {
    return Math.random() &lt; 0.5;
  }

  betBtn.addEventListener(&#39;click&#39;, function () {
    const wager = parseInt(wagerInput.value, 10);
    if (!wager || wager &lt; 1 || wager &gt; credits) {
      messageEl.textContent = `⛔ Invalid bet. Enter 1–${credits}.`;
      return;
    }

    const win = flipQuantum();
    credits += win ? wager : -wager;
    $money = credits;

    messageEl.textContent = win
      ? `🎉 You won ${wager} credits!`
      : `😢 You lost ${wager} credits.`;

    render();
    wagerInput.value = &#39;&#39;;
  });

  cashBtn.addEventListener(&#39;click&#39;, function () {
    messageEl.textContent = `💰 You cashed out with ${credits} credits.`;
    $money = credits;
    setTimeout(() =&gt; window.twHideModal(), 1500);
  });

  render();
};

// Open the casino
window.openCasino = function () {
  twShowModal(window.casinoGameHTML);
  setupCasino();
};
&lt;/script&gt;
</tw-passagedata><tw-passagedata pid="558" name="ParamFight" tags="" position="1825,400" size="100,100">  ##You fight for your life !
{    
&lt;div id=&quot;combat-container&quot;&gt;

        &lt;div id=&quot;turn-indicator&quot;&gt;YOUR TURN !&lt;/div&gt;
        &lt;div id=&quot;combat-log&quot;&gt;Combat Started!&lt;/div&gt;
        
          &lt;div id=&quot;actions&quot;&gt;
            &lt;button class=&quot;action-button&quot; data-action=&quot;attack&quot;&gt;Attack&lt;/button&gt;
            &lt;button class=&quot;action-button&quot; data-action=&quot;flee&quot;&gt;Flee&lt;/button&gt;
        &lt;/div&gt;
        
       &lt;div class=&quot;blockCombats&quot;&gt;
        &lt;div id=&quot;player&quot; class=&quot;Combatscharacter&quot;&gt;
            &lt;div class=&quot;hp-text&quot; id=&quot;player-hp-text&quot;&gt;HP: $health/$maxHealth&lt;/div&gt;
            &lt;div class=&quot;hp-bar&quot;&gt;&lt;div class=&quot;hp-fill&quot; id=&quot;player-hp&quot; style=&quot;width:100%&quot;&gt;&lt;/div&gt;&lt;/div&gt;
            &lt;img class=&quot;tailleImgCombats&quot; src=&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Combats/PersoCombat.png&quot; alt=&quot;Player&quot;&gt;
        &lt;/div&gt;

        &lt;div id=&quot;enemy&quot; class=&quot;Combatscharacter&quot;&gt;
            &lt;div class=&quot;hp-text&quot; id=&quot;enemy-hp-text&quot;&gt;HP: $ehp/$ehp&lt;/div&gt;
            &lt;div class=&quot;hp-bar&quot;&gt;&lt;div class=&quot;hp-fill&quot; id=&quot;enemy-hp&quot; style=&quot;width:100%&quot;&gt;&lt;/div&gt;&lt;/div&gt;
            &lt;img class=&quot;tailleImgCombats&quot; src=&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Combats/ParasiteCombat.png&quot; alt=&quot;Enemy&quot;&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
       &lt;div class=&quot;dice-overlay&quot;&gt;
            &lt;div class=&quot;dice-container&quot;&gt;
                &lt;div class=&quot;die&quot;&gt;&lt;img class=&#39;cssde&#39; id=&quot;die1&quot; src=&quot;https://pickyouruniverse.com/DataProjects/2024/05/1.png&quot;&gt;&lt;/div&gt;
                &lt;div class=&quot;die&quot;&gt;&lt;img class=&#39;cssde&#39; id=&quot;die2&quot; src=&quot;https://pickyouruniverse.com/DataProjects/2024/05/1.png&quot;&gt;&lt;/div&gt;
                &lt;div class=&quot;die&quot;&gt;&lt;img class=&#39;cssde&#39; id=&quot;die3&quot; src=&quot;https://pickyouruniverse.com/DataProjects/2024/05/1.png&quot;&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
&lt;/div&gt;}


  &lt;script&gt;
        const soundEffects = {
            attackHit: new Audio(&#39;https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/degats.wav&#39;),
            attackMiss: new Audio(&#39;https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/AttackManque.wav&#39;),
            enemyHit: new Audio(&#39;https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/degatsEnnemie.wav&#39;),
            enemyMiss: new Audio(&#39;https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/EnemieAManque.wav&#39;),
            victory: new Audio(&#39;https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/victoire.wav&#39;),
            defeat: new Audio(&#39;https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/defaite.wav&#39;),
             flee: new Audio(&#39;https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/fuite.wav&#39;)
        };

function playSound(soundKey) {
    if (window.sfxEnabled &amp;&amp; soundEffects[soundKey]) {
        soundEffects[soundKey].volume = window.sfxVolume || 0.5;
        soundEffects[soundKey].play().catch(err =&gt; console.log(&quot;Erreur lecture son:&quot;, err));
    }
}

        const state = {
			player: { hp: $health, maxHp: $maxHealth, attack: $strength,  armor: $totalArmor },
            enemy: { hp: $ehp, maxHp: $ehp, attack: $eStrength, defense: 3 },
            isPlayerTurn: true,
            diceOverlay: document.querySelector(&#39;.dice-overlay&#39;),
            fled: false,
        };
console.log(&quot;💬 ARMURE DU JOUEUR :&quot;, $totalArmor);

        function updateTurnIndicator() {
            const indicator = document.getElementById(&#39;turn-indicator&#39;);
            indicator.textContent = state.isPlayerTurn ? &quot;YOUR TURN !&quot; : &quot;ENEMY TURN !&quot;;
        }

        function initGame() {
            updateTurnIndicator();
            updateHpBars();
            document.querySelectorAll(&#39;.action-button&#39;).forEach(button =&gt; {
                button.addEventListener(&#39;click&#39;, () =&gt; {
                    if (state.isPlayerTurn) handleAction(button.dataset.action);
                });
            });
        }

        async function rollDice() {
            return new Promise(async resolve =&gt; {
                state.diceOverlay.style.display = &#39;flex&#39;;
                const diceElements = [document.getElementById(&#39;die1&#39;), 
                                    document.getElementById(&#39;die2&#39;), 
                                    document.getElementById(&#39;die3&#39;)];

                for (let i = 0; i &lt; 10; i++) {
                    diceElements.forEach(die =&gt; {
                        die.src = `https://pickyouruniverse.com/DataProjects/General/Dé/${Math.floor(Math.random() * 6) + 1}.png`;
                    });
                    await new Promise(r =&gt; setTimeout(r, 50));
                }

                const finalRoll = [];
                for (let i = 0; i &lt; 5; i++) {
                    finalRoll.length = 0;
                    diceElements.forEach(die =&gt; {
                        finalRoll.push(Math.floor(Math.random() * 6) + 1);
                        die.src = `https://pickyouruniverse.com/DataProjects/General/Dé/${finalRoll[finalRoll.length-1]}.png`;
                    });
                    await new Promise(r =&gt; setTimeout(r, 100 + i*50));
                }

                setTimeout(() =&gt; {
                    state.diceOverlay.style.display = &#39;none&#39;;
                    resolve(finalRoll.reduce((a, b) =&gt; a + b, 0));
                }, 1000);
            });
        }
function mettreAJourSante() {
    console.log(&quot;Mise à jour de la santé...&quot;);

    const playerHpBar = document.getElementById(&#39;player-hp&#39;);
    const enemyHpBar = document.getElementById(&#39;enemy-hp&#39;);
    const playerHpText = document.getElementById(&#39;player-hp-text&#39;);
    const enemyHpText = document.getElementById(&#39;enemy-hp-text&#39;);

    if (!playerHpBar || !enemyHpBar || !playerHpText || !enemyHpText) {
        console.error(&quot;❌ Erreur : Un élément HP est introuvable !&quot;);
        return;
    }

    // Mise à jour des barres de vie
    const playerHpPercentage = (state.player.hp / state.player.maxHp) * 100;
    const enemyHpPercentage = (state.enemy.hp / state.enemy.maxHp) * 100;
    playerHpBar.style.width = `${playerHpPercentage}%`;
    enemyHpBar.style.width = `${enemyHpPercentage}%`;

    // Mise à jour du texte HP
    playerHpText.textContent = `HP: ${state.player.hp}/${state.player.maxHp}`;
    enemyHpText.textContent = `HP: ${state.enemy.hp}/${state.enemy.maxHp}`;

    // Vérification et mise à jour de $health si c&#39;est bien une variable globale Twine
    if (typeof $health !== &#39;undefined&#39;) {
        $health = state.player.hp;
        console.log(`Nouvelle valeur de $health : ${$health}`);
    } else {
        console.warn(&quot;⚠️ $health n&#39;est pas défini dans Twine.&quot;);
    }
}

async function handleAction(action) {
            if (!state.isPlayerTurn) return;

            let message = &#39;&#39;;
            
            
    if (action === &#39;attack&#39;) {
        let diceResult;
        if (window.$skillCheckEnableFight) {
            // Animation du dé avec rollDice()
            diceResult = await rollDice();
        } else {
            // Pas d&#39;animation, résultat direct (par ex. un lancé aléatoire)
            diceResult = Math.floor(Math.random() * 6) + 1
                       + Math.floor(Math.random() * 6) + 1
                       + Math.floor(Math.random() * 6) + 1;
        }

        const hitScore = diceResult - state.enemy.defense;
        if ($strength &gt;= hitScore) {
            const rawDamage = Math.floor(Math.sqrt(state.player.attack) + (diceResult / 3));
            const damage = Math.max(rawDamage - state.enemy.defense, 0);
            state.enemy.hp = Math.max(state.enemy.hp - damage, 0);
            message = `Attack successful! Roll: ${diceResult}, Damage dealt: ${damage}`;
            animateAttack(document.getElementById(&#39;player&#39;), document.getElementById(&#39;enemy&#39;), damage);
            playSound(&quot;attackHit&quot;);
        } else {
            message = `Your attack missed! Roll: ${diceResult}`;
            playSound(&quot;attackMiss&quot;);
        }
    } else if (action === &#39;flee&#39;) {
        let diceResult;
        if (window.$skillCheckEnableFight) {
            diceResult = await rollDice();
        } else {
            diceResult = Math.floor(Math.random() * 6) + 1
                       + Math.floor(Math.random() * 6) + 1
                       + Math.floor(Math.random() * 6) + 1;
        }
        
        if (diceResult &gt;= $intelligence) {
            message = `Successful escape! (${diceResult}) !`;
            state.fled = true;
        } else {
            message = `Failed escape (${diceResult}) !`;
            playSound(&quot;attackMiss&quot;);
        }
    }

            updateCombatLog(message);
            updateHpBars();
            mettreAJourSante();
            if (checkGameOver()) return;
            
            if (state.enemy.hp &gt; 0) {
                state.isPlayerTurn = false;
                updateTurnIndicator();
                setTimeout(enemyTurn, 1500);
            }
        }

async function enemyTurn() {
    let diceResult;
    if (window.$skillCheckEnableFight) {
        diceResult = await rollDice();
    } else {
        diceResult = Math.floor(Math.random() * 6) + 1
                   + Math.floor(Math.random() * 6) + 1
                   + Math.floor(Math.random() * 6) + 1;
    }

    let message = &#39;&#39;;

    if ($eStrength &gt;= diceResult) {
        const rawDamage = Math.floor(Math.sqrt(state.enemy.attack) + (diceResult / 3));
        const damage = Math.max(rawDamage - state.player.armor, 0);
        state.player.hp = Math.max(state.player.hp - damage, 0);
        message = `Enemy attacks (${diceResult}) for ${damage} damage!`;
        animateAttack(document.getElementById(&#39;enemy&#39;), document.getElementById(&#39;player&#39;), damage);
        playSound(&quot;enemyHit&quot;);
    } else {
        message = `Enemy attack (${diceResult}) misses!`;
        playSound(&quot;enemyMiss&quot;);
    }

    updateCombatLog(message);
    updateHpBars();
    mettreAJourSante();
    checkGameOver();
    state.isPlayerTurn = true;
    updateTurnIndicator();
}

          function animateAttack(attacker, target, amount) {
              attacker.classList.add(attacker.id === &#39;player&#39; ? &#39;attack-move&#39; : &#39;enemy-attack-move&#39;);
              target.classList.add(&#39;hit-flash&#39;);

              // Déterminer la couleur et la position
              const color = attacker.id === &#39;player&#39; ? &#39;gold&#39; : &#39;#ff0000&#39;;
              const targetRect = target.getBoundingClientRect();
              const containerRect = document.getElementById(&#39;combat-container&#39;).getBoundingClientRect();

              showDamage(
                  targetRect.left - containerRect.left + target.offsetWidth/2,
                  targetRect.top - containerRect.top,
                  amount, 
                  color
              );
              
              function showDamage(x, y, amount, color) {
                    const damageElement = document.createElement(&#39;div&#39;);
                    damageElement.className = &#39;damage-popup&#39;;
                    damageElement.textContent = amount;
                    damageElement.style.color = color;
                    damageElement.style.position = &#39;absolute&#39;;
                    damageElement.style.left = `${x}px`;
                    damageElement.style.top = `${y}px`;
                    damageElement.style.fontSize = &#39;24px&#39;;
                    damageElement.style.fontWeight = &#39;bold&#39;;
                    damageElement.style.textShadow = &#39;2px 2px 2px rgba(0, 0, 0, 0.8)&#39;;
                    damageElement.style.animation = &#39;damageFloat 1s ease-out forwards&#39;;

                    document.getElementById(&#39;combat-container&#39;).appendChild(damageElement);

                    setTimeout(() =&gt; {
                        damageElement.remove();
                    }, 1000);
                }

              setTimeout(() =&gt; {
                  attacker.classList.remove(&#39;attack-move&#39;, &#39;enemy-attack-move&#39;);
                  target.classList.remove(&#39;hit-flash&#39;);
              }, 300);
          }
          
        function animateHeal(target, amount) {
            target.classList.add(&#39;hit-flash&#39;);
            showDamage(target, `+${amount}`, &#39;green&#39;);
            setTimeout(() =&gt; target.classList.remove(&#39;hit-flash&#39;), 300);
        }

        function showDamage(target, amount, color) {
            const damageElement = document.createElement(&#39;div&#39;);
            damageElement.className = &#39;damage-number&#39;;
            damageElement.textContent = amount;
            damageElement.style.color = color;
            damageElement.style.left = `${target.offsetLeft + 75}px`;
            damageElement.style.top = `${target.offsetTop}px`;
            
            document.getElementById(&#39;combat-container&#39;).appendChild(damageElement);
            setTimeout(() =&gt; damageElement.remove(), 800);
        }

     function updateHpBars() {
    const playerHpPercentage = (state.player.hp / state.player.maxHp) * 100;
    const enemyHpPercentage = (state.enemy.hp / state.enemy.maxHp) * 100;

    document.getElementById(&#39;player-hp&#39;).style.width = `${playerHpPercentage}%`;
    document.getElementById(&#39;enemy-hp&#39;).style.width = `${enemyHpPercentage}%`;

    document.getElementById(&#39;player-hp-text&#39;).textContent = `HP: ${state.player.hp}/${state.player.maxHp}`;
    document.getElementById(&#39;enemy-hp-text&#39;).textContent = `HP: ${state.enemy.hp}/${state.enemy.maxHp}`;
    
    updateHealth(state.player.hp);
}

        function updateCombatLog(message) {
            document.getElementById(&#39;combat-log&#39;).textContent = message;
        }

function checkGameOver() {
    if (state.fled) {
        if (window.musiqueCombats) {
            window.musiqueCombats.pause();
            window.musiqueCombats.currentTime = 0;
        }
        playSound(&quot;flee&quot;);
        document.getElementById(&#39;fuite&#39;).style.display = &#39;flex&#39;;
        document.querySelectorAll(&#39;.action-button&#39;).forEach(button =&gt; {
            button.style.display = &#39;none&#39;;
        });
        return true;
    }

    if (state.enemy.hp &lt;= 0) {
        updateCombatLog(&#39;Victoire !&#39;);
        if (window.musiqueCombats) {
            window.musiqueCombats.pause();
            window.musiqueCombats.currentTime = 0;
        }
        	playSound(&quot;victory&quot;);
        document.getElementById(&#39;victoryLink&#39;).style.display = &#39;flex&#39;;
        document.querySelectorAll(&#39;.action-button&#39;).forEach(button =&gt; {
                button.style.display = &#39;none&#39;;
            });
        return true;
    }
    if (state.player.hp &lt;= 0) {
        updateCombatLog(&#39;Défaite...&#39;);
                if (window.musiqueCombats) {
            window.musiqueCombats.pause();
            window.musiqueCombats.currentTime = 0;
        }
        playSound(&quot;defeat&quot;);
        document.getElementById(&#39;defeatLink&#39;).style.display = &#39;flex&#39;;
         document.querySelectorAll(&#39;.action-button&#39;).forEach(button =&gt; {
                button.style.display = &#39;none&#39;;
            });
        return true;
    }
    return false;
}
        initGame();
        
(function observeHealthFromHUD() {
    const barText = document.getElementById(&quot;bar-text&quot;);
    if (!barText) return;

    let lockObserver = false;

    const observer = new MutationObserver(() =&gt; {
        if (lockObserver) return; 

        const [current, max] = barText.textContent.split(&#39;/&#39;).map(v =&gt; parseInt(v));
        if (!isNaN(current) &amp;&amp; state.player) {
            state.player.hp = current;
            state.player.maxHp = max;

            lockObserver = true; 
            updateHpBars();     
            mettreAJourSante();  
            setTimeout(() =&gt; { lockObserver = false }, 50);
        }
    });

    observer.observe(barText, {
        childList: true,
        characterData: true,
        subtree: true
    });
})();

    &lt;/script&gt;    
    
    
    &lt;script&gt;
    if (window.musiqueDeFond) {
      window.musiqueDeFond.pause();
      window.musiqueDeFond.currentTime = 0;
    }

    // Lancer la musique des crédits
    const musiqueCombats = new Audio(&quot;https://pickyouruniverse.com/DataProjects/General/SonEvenements/combats.mp3&quot;);
    musiqueCombats.loop = true;
    musiqueCombats.volume = 0.7;
    musiqueCombats.play().catch(err =&gt; console.log(&quot;Lecture bloquée par le navigateur&quot;, err));

    // Rendre la musique accessible globalement si besoin
    window.musiqueCombats = musiqueCombats;

document.querySelectorAll(&#39;.suite&#39;).forEach(btn =&gt; {
  btn.addEventListener(&#39;click&#39;, function () {
    if (window.musiqueCombats) {
      window.musiqueCombats.pause();
      window.musiqueCombats.currentTime = 0;
             window.musiqueDeFond.play();
    }
  });
});
  &lt;/script&gt;</tw-passagedata><tw-passagedata pid="559" name="Test" tags="test" position="2500,25" size="200,100"></tw-passagedata><tw-passagedata pid="560" name="AjouteMoney" tags="" position="600,125" size="100,100">//Ce code est dans le header !
window.updateMoney = function(addAmount) {
    const moneyEl = document.querySelector(&#39;.money&#39;);
    if (!moneyEl) return;

    // Extraire le texte actuel et convertir en nombre
    const currentText = moneyEl.textContent.trim().replace(/[^\d]/g, &#39;&#39;);
    const currentMoney = parseInt(currentText, 10) || 0;

    const newMoney = currentMoney + addAmount;

    // Mettre à jour l&#39;affichage
    const coinIcon = moneyEl.querySelector(&#39;i&#39;);
    moneyEl.textContent = newMoney + &quot; &quot;;
    if (coinIcon) {
        moneyEl.appendChild(coinIcon);
    }

    // Sauvegarder la nouvelle valeur
    localStorage.setItem(&#39;playerMoney&#39;, newMoney);
};



//Ajouter Argent
window.updateMoney(250);</tw-passagedata><tw-passagedata pid="561" name="DetecterBonObjet" tags="" position="725,125" size="100,100">[[Admin]]
{
&lt;!--Block ou donner le bon objet --&gt;
&lt;div id=&quot;donation-box&quot; class=&quot;donation-box&quot;&gt;
 &lt;img style=&quot;width: 60%;&quot; class=&quot;decorative-image&quot; src=&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Casque.png&quot;&gt;
  &lt;span class=&quot;subtext&quot;&gt;Offer the astronaut&#39;s helmet&lt;/span&gt;
&lt;/div&gt;

&lt;!-- Résultat --&gt;
&lt;p id=&quot;donation-result&quot; class=&quot;donation-message&quot;&gt;&lt;/p&gt;

&lt;!-- Inventaire --&gt;
&lt;div class=&quot;chest&quot;&gt;
  &lt;div class=&quot;inventoryPlayerChest&quot; id=&quot;chestInventory&quot;&gt;
    &lt;div class=&quot;slotPlayerChest&quot;&gt;
      &lt;img src=&quot;helmet.png&quot; class=&quot;item-img&quot; data-nom=&quot;astronaut&#39;s helmet&quot; data-type=&quot;helmet&quot;&gt;
    &lt;/div&gt;
    &lt;!-- Vous pouvez ajouter d&#39;autres objets ici --&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;!-- Récompense --&gt;
&lt;div id=&quot;recompenseDonPassage&quot;&gt;
  [Start2]] 
&lt;/div&gt;

&lt;script&gt;
const donationManager = {
  init() {
    const box = document.getElementById(&#39;donation-box&#39;);
    box.addEventListener(&#39;dragover&#39;, this.handleDragOver);
    box.addEventListener(&#39;drop&#39;, this.handleDrop.bind(this));
  },

  handleDragOver(e) {
    e.preventDefault();
    e.target.classList.add(&#39;hover&#39;);
  },

  handleDrop(e) {
    e.preventDefault();
    e.target.classList.remove(&#39;hover&#39;);

    const item = document.querySelector(&#39;.dragging&#39;);
    if (!item) return;

    if (this.isValidItem(item)) {
      item.remove();
      this.showResult(&quot;Perfect, you may proceed&quot;, &quot;gold&quot;);
      document.getElementById(&#39;donation-box&#39;).style.display = &#39;none&#39;;
      document.getElementById(&#39;recompenseDonPassage&#39;).style.display = &#39;block&#39;;
    } else {
      this.showResult(&quot;This is not the correct item&quot;, &quot;red&quot;);
    }
  },

  isValidItem(item) {
    return item.dataset.nom === &quot;astronaut&#39;s helmet&quot; &amp;&amp; item.dataset.type === &quot;helmet&quot;;   //(nom + type objet pour vérifier l&#39;objet)
  },

  showResult(msg, color) {
    const result = document.getElementById(&#39;donation-result&#39;);
    result.textContent = msg;
    result.style.color = color;
    setTimeout(() =&gt; result.textContent = &#39;&#39;, 3000);
  }
};

const dragManager = {
  currentItem: null,
  clone: null,
  originalSlot: null,

  init() {
    document.addEventListener(&#39;pointerdown&#39;, this.startDrag.bind(this));
  },

  startDrag(e) {
    const item = e.target.closest(&#39;.item-img&#39;);
    if (!item) return;

    this.currentItem = item;
    this.originalSlot = item.parentElement;

    item.classList.add(&#39;dragging&#39;);

    this.createClone(e);
    document.addEventListener(&#39;pointermove&#39;, this.moveClone);
    document.addEventListener(&#39;pointerup&#39;, this.dropItem.bind(this));
  },

  createClone(e) {
    this.clone = this.currentItem.cloneNode(true);
    this.clone.style.position = &#39;fixed&#39;;
    this.clone.style.width = &#39;60px&#39;;
    this.clone.style.height = &#39;60px&#39;;
    this.clone.style.pointerEvents = &#39;none&#39;;
    this.clone.style.transform = `translate(${e.clientX - 30}px, ${e.clientY - 30}px)`;
    document.body.appendChild(this.clone);
  },

  moveClone(e) {
    if (!this.clone) return;
    this.clone.style.transform = `translate(${e.clientX - 30}px, ${e.clientY - 30}px)`;
  },

  dropItem(e) {
    document.removeEventListener(&#39;pointermove&#39;, this.moveClone);
    document.removeEventListener(&#39;pointerup&#39;, this.dropItem);
    this.clone?.remove();
    this.currentItem?.classList.remove(&#39;dragging&#39;);

    const dropTarget = document.elementFromPoint(e.clientX, e.clientY);
    const validContainer = dropTarget?.closest(&#39;.slotPlayerChest&#39;);

    if (validContainer) {
      this.moveToContainer(validContainer);
    } else if (!dropTarget?.closest(&#39;#donation-box&#39;)) {
      this.returnToOriginalSlot();
    }
  },

  moveToContainer(container) {
    const existingItem = container.querySelector(&#39;.item-img&#39;);
    if (existingItem) {
      this.originalSlot.appendChild(existingItem);
    }
    container.appendChild(this.currentItem);
  },

  returnToOriginalSlot() {
    this.originalSlot.appendChild(this.currentItem);
  }
};

donationManager.init();
dragManager.init();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;}</tw-passagedata><tw-passagedata pid="562" name="unObjet" tags="" position="850,125" size="100,100">Un objet
  &lt;script&gt;
  const newItemData = {
        id: &quot;soin1&quot;,
        nom: &quot;Healing Potion&quot;,
        type: &quot;soin&quot;,
        life: 7,
        class: &quot;item-img&quot;,
        draggable: true,
        inventory: &quot;23&quot;,
        src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Pills.png&quot;,
        &quot;prix&quot;: 25,
        &quot;rare&quot;: &quot;Common&quot;
  };

    // Création de l&#39;élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute(&#39;data-id&#39;, newItemData.id);
  itemElement.setAttribute(&#39;draggable&#39;, &#39;true&#39;);

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;)) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));

  itemElement.addEventListener(&#39;mouseenter&#39;, (e) =&gt; showTooltip(e, itemElement));
  itemElement.addEventListener(&#39;touchstart&#39;, (e) =&gt; showTooltip(e, itemElement), { passive: false });
&lt;/script&gt;
[[Admin]]</tw-passagedata><tw-passagedata pid="563" name="PlusieursObjets" tags="" position="850,250" size="100,100">Plusieurs objets : 

&lt;script&gt;
  const newItems = [
    {
      id: &quot;soin1&quot;,
      nom: &quot;Healing Potion&quot;,
      type: &quot;soin&quot;,
      life: 25,
      inventory: 24,
      src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Medkit.png&quot;,
      prix: 25,
      rare: &quot;Common&quot;
    },
    {
      id: &quot;soin2&quot;,
      nom: &quot;Healing Potion&quot;,
      type: &quot;soin&quot;,
      life: 25,
      inventory: 23,
      src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Medkit.png&quot;,
      prix: 25,
      rare: &quot;Common&quot;
    }
  ];

  newItems.forEach((itemData) =&gt; {
    const itemElement = createItem(
      itemData.type,
      itemData.src,
      itemData.id,
      itemData.nom,
      itemData.strength,
      itemData.durability,
      itemData.life,
      itemData.armor,
      itemData.prix,
      itemData.rare,
      itemData.money
    );

    itemElement.setAttribute(&#39;data-id&#39;, itemData.id);
    itemElement.setAttribute(&#39;draggable&#39;, &#39;true&#39;);

    const targetSlot = document.getElementById(`slot-${itemData.inventory}`);
    if (targetSlot &amp;&amp; targetSlot.childNodes.length === 0) {
      targetSlot.appendChild(itemElement);

      let inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;)) || Array(24).fill(null);
      inventoryGridData[itemData.inventory - 1] = {
        id: itemData.id,
        type: itemData.type,
        src: itemData.src,
        nom: itemData.nom,
        strength: itemData.strength,
        durability: itemData.durability,
        life: itemData.life,
        armor: itemData.armor,
        prix: itemData.prix,
        rare: itemData.rare,
        money: itemData.money,
      };
      localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));

      itemElement.addEventListener(&#39;mouseenter&#39;, (e) =&gt; showTooltip(e, itemElement));
      itemElement.addEventListener(&#39;touchstart&#39;, (e) =&gt; showTooltip(e, itemElement), { passive: false });
    }
  });
&lt;/script&gt;


[[Admin]]</tw-passagedata><tw-passagedata pid="564" name="SuppressionObjet" tags="" position="850,375" size="100,100">&lt;script&gt;
function removeItemFromInventory(itemId) {
    let inventoryGridData = JSON.parse(localStorage.getItem(&#39;inventoryGridInventory&#39;)) || Array(24).fill(null);
    let itemRemoved = false;

    inventoryGridData.forEach((item, index) =&gt; {
        if (item &amp;&amp; item.id === itemId) {
            const slot = document.getElementById(`slot-${index + 1}`);
            if (slot) {
                const itemElement = slot.querySelector(`[data-id=&quot;${itemId}&quot;]`);
                if (itemElement) {
                    itemElement.remove();
                }
            }
            inventoryGridData[index] = null;
            itemRemoved = true;
        }
    });

    localStorage.setItem(&#39;inventoryGridInventory&#39;, JSON.stringify(inventoryGridData));

}

removeItemFromInventory(&#39;casque1&#39;);
&lt;/script&gt;

[[Admin]]</tw-passagedata><tw-passagedata pid="565" name="Marchand1" tags="" position="975,125" size="100,100">{
    &lt;body&gt;
    &lt;style&gt;.money{display:none;}&lt;/style&gt;
        &lt;div class=&quot;container&quot;&gt;
            &lt;!-- Titre du menu --&gt;
            &lt;div class=&quot;MarchandHaut&quot;&gt;
                &lt;h1&gt;Gerard the Merchant&#39;s Shop&lt;/h1&gt;
                &lt;div class=&quot;gold-display&quot;&gt;
                    &lt;i class=&quot;fas fa-coins&quot;&gt;&lt;/i&gt;
                    &lt;span id=&quot;gold-amount&quot; data-valeur-de-base=&quot;0&quot;&gt;0 gold coins&lt;/span&gt;
                &lt;/div&gt;
            &lt;/div&gt;
    
            &lt;!-- Contenu principal --&gt;
            &lt;div class=&quot;main-content&quot;&gt;
                &lt;!-- Interface du marchand (gauche) --&gt;
                &lt;div class=&quot;merchant-section&quot;&gt;
                    &lt;div class=&quot;merchant-card&quot;&gt;
                        &lt;div class=&quot;card-header&quot;&gt;
                            &lt;h2&gt;Merchant&lt;/h2&gt;
                        &lt;/div&gt;
                        &lt;div class=&quot;merchant-tabs&quot;&gt;
                            &lt;button class=&quot;tab-button active&quot; data-tab=&quot;achats&quot;&gt;
                                &lt;i class=&quot;fas fa-shopping-cart&quot;&gt;&lt;/i&gt; Buy
                            &lt;/button&gt;
                            &lt;button class=&quot;tab-button&quot; data-tab=&quot;vente&quot;&gt;
                                &lt;i class=&quot;fas fa-shopping-bag&quot;&gt;&lt;/i&gt; Sell
                            &lt;/button&gt;
                            &lt;button class=&quot;tab-button&quot; data-tab=&quot;anecdotes&quot;&gt;
                                &lt;i class=&quot;fas fa-comment&quot;&gt;&lt;/i&gt; Conversation
                            &lt;/button&gt;
                        &lt;/div&gt;
                        &lt;div class=&quot;tab-content&quot;&gt;
                            &lt;!-- Contenu de l&#39;onglet Achats --&gt;
                            &lt;div class=&quot;tab-pane active&quot; id=&quot;achats&quot;&gt;
                                &lt;h3&gt;Available items :&lt;/h3&gt;
                                &lt;div class=&quot;merchant-items&quot; id=&quot;merchant-items&quot;&gt;
                                    &lt;!-- Les articles du marchand seront générés par JavaScript --&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
    
                            &lt;!-- Contenu de l&#39;onglet Vente --&gt;
                            &lt;div class=&quot;tab-pane&quot; id=&quot;vente&quot;&gt;
                                &lt;div class=&quot;sell-container&quot;&gt;
                                    &lt;h3&gt;Sell an item&lt;/h3&gt;
                                    &lt;p&gt;Select an item from your inventory to sell to the merchant&lt;/p&gt;
                                    &lt;div class=&quot;sell-item-details&quot; id=&quot;sell-item-details&quot;&gt;
                                        &lt;p class=&quot;no-selection&quot;&gt;No item selected. Click on an item in your inventory&lt;/p&gt;
                                    &lt;/div&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
    
                            &lt;!-- Contenu de l&#39;onglet Anecdotes --&gt;
                            &lt;div class=&quot;tab-pane&quot; id=&quot;anecdotes&quot;&gt;
                                &lt;div class=&quot;anecdote-container&quot;&gt;
                                    &lt;div class=&quot;anecdote-icon&quot;&gt;
                                        &lt;i class=&quot;fas fa-comment&quot;&gt;&lt;/i&gt;
                                    &lt;/div&gt;
                                    &lt;div class=&quot;anecdote-content&quot;&gt;
                                        &lt;h3&gt;The merchant tells you :&lt;/h3&gt;
                                        &lt;p id=&quot;anecdote-text&quot; class=&quot;anecdote-text&quot;&gt;&quot;I learned some information recently !&quot;&lt;/p&gt; &lt;!-- phrase de base --&gt;
                                        &lt;button class=&quot;anecdote-button&quot; id=&quot;new-anecdote&quot;&gt;Conversation&lt;/button&gt;
                                    &lt;/div&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
    
                    &lt;!-- Détails de l&#39;objet sélectionné (pour l&#39;achat) --&gt;
                    &lt;div class=&quot;buy-item-details&quot; id=&quot;buy-item-details&quot;&gt;
                        &lt;!-- Détails de l&#39;objet à acheter --&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                
                
                 &lt;!-- Inventaire du joueur (droite) --&gt;
                &lt;div class=&quot;inventory-card&quot;&gt;
                    &lt;div class=&quot;card-header&quot;&gt;
                        &lt;h2&gt;Your Inventory&lt;/h2&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;card-content&quot;&gt;
                     &lt;!--equipements éphémére--&gt;    
                          &lt;div class=&quot;inventoryPlayerMarchand&quot; id=&quot;chestInventory&quot;&gt;&lt;/div&gt;
                  &lt;!--FIN equipements éphémére--&gt;
                      
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;button id=&quot;explore&quot;&gt;[[Admin]]&lt;/button&gt;
    &lt;button id=&quot;explore2&quot;&gt;[[Admin]]&lt;/button&gt;
        &lt;script&gt;
const merchantItems = [
    { id: &quot;sword3&quot;, nom: &quot;Dague des fromans&quot;, type: &quot;sword&quot;, strength: 9, durability: 10, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;2&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/RayGun.png&quot;, &quot;prix&quot;: 142,&quot;rare&quot;: &quot;Common&quot; },
   { id: &quot;sword4&quot;, nom: &quot;Horn&quot;, type: &quot;sword&quot;, strength: 8, durability: 30, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;4&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/Horn.png&quot;,&quot;prix&quot;: 180,&quot;rare&quot;: &quot;Epic&quot;  },
    { id: &quot;soin2&quot;, nom: &quot;Healing Potion&quot;, type: &quot;soin&quot;, life: 15, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;6&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Medkit.png&quot;,&quot;prix&quot;: 35,&quot;rare&quot;: &quot;Common&quot;  },
    { id: &quot;glasse1&quot;, nom: &quot;glasse&quot;, type: &quot;object&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;7&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Objets/Glasses.png&quot;,&quot;prix&quot;: 67,&quot;rare&quot;: &quot;Common&quot;  },
    { id: &quot;Watch1&quot;, nom: &quot;Watch&quot;, type: &quot;object&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;8&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Objets/Watch.png&quot;,&quot;prix&quot;: 115,&quot;rare&quot;: &quot;Rare&quot;  },
];

const anecdotes = [
    &quot;J&#39;ai entendu dire que le roi prépare une grande fête pour célébrer la victoire contre les orcs.&quot;,
    &quot;On raconte que des trésors sont cachés dans les montagnes du nord.&quot;,
    &quot;Je me suis promener ce matin, c&#39;est pas mal!&quot;,
    &quot;Non sérieusement j&#39;ai rien à dire donc voilà c&#39;est pas mal.&quot;,
    &quot;Le forgeron du village voisin aurait découvert une nouvelle technique pour renforcer les armes.&quot;,
];


// Variables globales
let money = parseInt(localStorage.getItem(&quot;$money&quot;)) || 0;
let baseGold = parseInt(document.getElementById(&#39;gold-amount&#39;).getAttribute(&#39;data-valeur-de-base&#39;)) || 0;
let gold = $money + baseGold;
document.getElementById(&#39;gold-amount&#39;).textContent = `${gold} gold coins`;
let selectedItem = null;
let currentTab = &quot;achats&quot;;
let selectedSlot = null; 

// Variables pour le drag and drop mobile
let touchDraggedItem = null;
let touchGhost = null;
let touchStartX = 0;
let touchStartY = 0;
let initialSlot = null;
let touchStartTime = 0;
let touchMoved = false;
const CLICK_DELAY = 300; 
const MOVE_THRESHOLD = 10; 

// Initialisation
generateMerchantItems();
setupTabButtons();
setupAnecdoteButton();
setupInventoryClicks();
setupDragDropInventory();
setupExploreButton();
setupMobileDragDrop();

// Génération des articles du marchand
function generateMerchantItems() {
    const merchantItemsContainer = document.getElementById(&#39;merchant-items&#39;);
    merchantItemsContainer.innerHTML = &#39;&#39;;

    merchantItems.forEach(item =&gt; {
        const itemElement = document.createElement(&#39;div&#39;);
        itemElement.className = &#39;merchant-item&#39;;
        itemElement.dataset.itemId = item.id;

        const img = document.createElement(&#39;img&#39;);
        img.src = item.src;
        img.alt = item.nom;

        const name = document.createElement(&#39;h4&#39;);
        name.textContent = item.nom;

        const price = document.createElement(&#39;div&#39;);
        price.className = &#39;price&#39;;
        price.innerHTML = `&lt;i class=&quot;fas fa-coins&quot;&gt;&lt;/i&gt; ${item.prix}`;

        itemElement.appendChild(img);
        itemElement.appendChild(name);
        itemElement.appendChild(price);
        merchantItemsContainer.appendChild(itemElement);

        itemElement.addEventListener(&#39;click&#39;, () =&gt; selectMerchantItem(item));
    });
}

// Configuration des boutons d&#39;onglet
function setupTabButtons() {
    const tabButtons = document.querySelectorAll(&#39;.tab-button&#39;);

    tabButtons.forEach(button =&gt; {
        button.addEventListener(&#39;click&#39;, () =&gt; {
            tabButtons.forEach(btn =&gt; btn.classList.remove(&#39;active&#39;));
            document.querySelectorAll(&#39;.tab-pane&#39;).forEach(pane =&gt; pane.classList.remove(&#39;active&#39;));

            button.classList.add(&#39;active&#39;);
            const tabId = button.dataset.tab;
            document.getElementById(tabId).classList.add(&#39;active&#39;);
            currentTab = tabId;

            // Masquer ou afficher l&#39;inventaire selon l&#39;onglet sélectionné
            const inventoryCard = document.querySelector(&#39;.inventory-card&#39;);
            if (tabId === &#39;anecdotes&#39;) {
                inventoryCard.style.display = &#39;none&#39;;
            } else {
                inventoryCard.style.display = &#39;block&#39;;
            }

            if (tabId !== &#39;achats&#39;) {
                const buyItemDetails = document.getElementById(&#39;buy-item-details&#39;);
                buyItemDetails.classList.remove(&#39;active&#39;);
                buyItemDetails.innerHTML = &#39;&#39;;
            }

            if (currentTab === &#39;vente&#39; &amp;&amp; selectedItem) {
                updateSellInterface(selectedItem);
            }
        });
    });
}


// Configuration du bouton d&#39;anecdote
function setupAnecdoteButton() {
    document.getElementById(&#39;new-anecdote&#39;).addEventListener(&#39;click&#39;, () =&gt; {
        const randomIndex = Math.floor(Math.random() * anecdotes.length);
        document.getElementById(&#39;anecdote-text&#39;).textContent = `&quot;${anecdotes[randomIndex]}&quot;`;
    });
}

// Gestion des clics sur l&#39;inventaire
function setupInventoryClicks() {
    document.getElementById(&#39;chestInventory&#39;).addEventListener(&#39;click&#39;, (e) =&gt; {
        // Vérifier si c&#39;est un clic sur une image d&#39;objet
        const clickedItem = e.target.closest(&#39;.item-img&#39;);
        if (!clickedItem) return;
        
        // Trouver le slot parent
        const slot = clickedItem.closest(&#39;.slotChest&#39;);
        if (!slot) return;

        // Désélectionner tous les slots
        document.querySelectorAll(&#39;.slotChest&#39;).forEach(s =&gt; s.classList.remove(&#39;selected&#39;));

        // Sélectionner le nouveau slot et ajouter un effet visuel
        slot.classList.add(&#39;selected&#39;);
        pulseEffect(clickedItem); 
        selectedSlot = slot;

        // Récupérer les données de l&#39;objet
        selectedItem = {
            id: clickedItem.dataset.id,
            nom: clickedItem.dataset.nom,
            type: clickedItem.dataset.type,
            strength: clickedItem.dataset.strength !== undefined ? clickedItem.dataset.strength : &#39;N/A&#39;,
            armor: clickedItem.dataset.armor !== undefined ? clickedItem.dataset.armor : &#39;N/A&#39;,
            life: clickedItem.dataset.life !== undefined ? clickedItem.dataset.life : &#39;N/A&#39;,
            prix: parseInt(clickedItem.dataset.prix) || 0,
            src: clickedItem.src
        };

        // Basculer automatiquement vers l&#39;onglet de vente
        document.querySelector(&#39;[data-tab=&quot;vente&quot;]&#39;).click();
        
        // Mettre à jour l&#39;interface de vente avec l&#39;objet sélectionné
        updateSellInterface(selectedItem);
        
        // Faire défiler jusqu&#39;à l&#39;interface de vente si nécessaire (pour mobile)
        const sellDetails = document.getElementById(&#39;sell-item-details&#39;);
        if (sellDetails) {
            sellDetails.scrollIntoView({ behavior: &#39;smooth&#39; });
        }
    });
}

// Effet de pulsation pour indiquer la sélection
function pulseEffect(element) {
    // Créer un style pour l&#39;animation si nécessaire
    if (!document.getElementById(&#39;pulse-animation-style&#39;)) {
        const style = document.createElement(&#39;style&#39;);
        style.id = &#39;pulse-animation-style&#39;;
        style.textContent = `
            @keyframes pulse-animation {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); box-shadow: 0 0 10px gold; }
                100% { transform: scale(1); }
            }
            .pulse {
                animation: pulse-animation 0.5s ease-in-out;
            }
        `;
        document.head.appendChild(style);
    }
    
    // Appliquer l&#39;animation
    element.classList.add(&#39;pulse&#39;);
    
    // Supprimer la classe après l&#39;animation
    setTimeout(() =&gt; {
        element.classList.remove(&#39;pulse&#39;);
    }, 500);
}

// Mise à jour de l&#39;interface de vente 
function updateSellInterface(item) {
    const sellDetails = document.getElementById(&#39;sell-item-details&#39;);
    if (!sellDetails) return;
    sellDetails.classList.add(&#39;active&#39;);

    if (!item || !item.prix || isNaN(item.prix)) {
        sellDetails.innerHTML = `&lt;p class=&quot;no-selection&quot;&gt;Item not for sale&lt;/p&gt;`;
        return;
    }

    sellDetails.innerHTML = `
        &lt;div class=&quot;sell-item-content&quot;&gt;
            &lt;h3&gt;${item.nom}&lt;/h3&gt;
            &lt;img src=&quot;${item.src}&quot; alt=&quot;${item.nom}&quot; class=&quot;sell-item-img&quot;&gt;
            &lt;div class=&quot;sell-item-stats&quot;&gt;
                ${item.type ? `&lt;p&gt;Type : ${item.type}&lt;/p&gt;` : &#39;&#39;}
                ${item.strength &amp;&amp; item.strength !== &#39;N/A&#39; ? `&lt;p&gt;Force : ${item.strength}&lt;/p&gt;` : &#39;&#39;}
                ${item.armor &amp;&amp; item.armor !== &#39;N/A&#39; ? `&lt;p&gt;Armure : ${item.armor}&lt;/p&gt;` : &#39;&#39;}
                ${item.life &amp;&amp; item.life !== &#39;N/A&#39; ? `&lt;p&gt;Soin : ${item.life}&lt;/p&gt;` : &#39;&#39;}
                &lt;p class=&quot;sell-price&quot;&gt;Valeur : ${item.prix} &lt;i class=&quot;fas fa-coins&quot;&gt;&lt;/i&gt;&lt;/p&gt;
                &lt;button class=&quot;btn btn-primary&quot; id=&quot;sell-button&quot;&gt;Sell this item&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    `;

    document.getElementById(&#39;sell-button&#39;).addEventListener(&#39;click&#39;, sellItem);
}

// Vente d&#39;un objet
function sellItem() {
    if (!selectedItem?.prix) {
        console.error(&quot;Prix non défini&quot;, selectedItem);
        return;
    }
    const selectedSlot = document.querySelector(&#39;.slotChest.selected&#39;);
    if (!selectedSlot) return;

    const prixVente = parseInt(selectedItem.prix) || 0;
    gold += prixVente;
    window.money = gold;
    updateLocalStorage();
    document.getElementById(&#39;gold-amount&#39;).textContent = `${gold} gold coins`;
    selectedSlot.remove();

    const sellDetails = document.getElementById(&#39;sell-item-details&#39;);
    if (window.sfxEnabled) {
    let vendSound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/vendre.wav&quot;);
    vendSound.volume = window.sfxVolume;
    vendSound.play();
  }
    sellDetails.innerHTML = `&lt;p class=&quot;no-selection&quot;&gt;Sold for ${prixVente} coins!&lt;/p&gt;`;
    selectedItem = null;
}

// Achat d&#39;un objet
function selectMerchantItem(item) {
    if (gold &lt; item.prix) {
        alert(&quot;You don&#39;t have enough gold to purchase this item.&quot;);
        return;
    }
    gold -= item.prix;
    window.money = gold;
    updateLocalStorage();
    document.getElementById(&#39;gold-amount&#39;).textContent = `${gold} gold coins`;

    if (window.sfxEnabled) {
        let moneySound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/argent.wav&quot;);
        moneySound.volume = window.sfxVolume;
        moneySound.play();
    }

    const inventory = document.getElementById(&#39;chestInventory&#39;);

    // Trouver une case vide
    const emptySlot = [...inventory.querySelectorAll(&#39;.slotChest&#39;)].find(slot =&gt; slot.children.length === 0);
    if (!emptySlot) {
        alert(&quot;Inventory full! No empty slots available.&quot;);
        return;
    }

    // Ajouter l’objet dans la case vide
    emptySlot.innerHTML = `
        &lt;img src=&quot;${item.src}&quot; id=&quot;${item.id}&quot; alt=&quot;${item.nom}&quot; class=&quot;${item.class} item-img&quot; draggable=&quot;true&quot;
             data-id=&quot;${item.id}&quot; data-nom=&quot;${item.nom}&quot; data-type=&quot;${item.type}&quot;
             data-strength=&quot;${item.strength || &#39;&#39;}&quot; data-durability=&quot;${item.durability || &#39;&#39;}&quot;
             data-life=&quot;${item.life || &#39;&#39;}&quot; data-prix=&quot;${item.prix}&quot; data-rare=&quot;${item.rare}&quot;&gt;
    `;

    const img = emptySlot.querySelector(&#39;.item-img&#39;);
    img.addEventListener(&#39;dragstart&#39;, dragStart);
    img.addEventListener(&#39;dragend&#39;, dragEnd);
    setupTouchEventsForItem(img);
}


// Gestion du drag &amp; drop sur l&#39;image (desktop)
function dragStart(event) {
    event.dataTransfer.setData(&quot;text/plain&quot;, event.target.outerHTML);
    event.target.classList.add(&quot;dragging&quot;);
    event.target.style.opacity = &quot;0.5&quot;;
    event.target.style.zIndex = &quot;1000&quot;;
}

function dragEnd(event) {
    event.target.classList.remove(&quot;dragging&quot;);
    event.target.style.opacity = &quot;1&quot;;
    event.target.style.zIndex = &quot;&quot;;
}

// Configuration de la zone d&#39;inventaire pour recevoir le drop
function setupDragDropInventory() {
    const chestInventory = document.getElementById(&#39;chestInventory&#39;);

    // Ajouter les événements tactiles aux éléments existants
    const existingItems = chestInventory.querySelectorAll(&#39;.item-img[draggable=&quot;true&quot;]&#39;);
    existingItems.forEach(item =&gt; {
        setupTouchEventsForItem(item);
    });

    chestInventory.addEventListener(&#39;dragover&#39;, function(e) {
        e.preventDefault();
        
        // Trouver le slot sous le curseur
        const slot = e.target.closest(&#39;.slotChest&#39;);
        if (slot) {
            // Ajouter un indicateur visuel
            document.querySelectorAll(&#39;.slotChest&#39;).forEach(s =&gt; {
                s.classList.remove(&#39;drop-target&#39;);
            });
            slot.classList.add(&#39;drop-target&#39;);
        }
    });

    chestInventory.addEventListener(&#39;dragleave&#39;, function(e) {
        const slot = e.target.closest(&#39;.slotChest&#39;);
        if (slot) {
            slot.classList.remove(&#39;drop-target&#39;);
        }
    });

    chestInventory.addEventListener(&#39;drop&#39;, function(e) {
        e.preventDefault();
        
        // Réinitialiser les indicateurs visuels
        document.querySelectorAll(&#39;.slotChest&#39;).forEach(slot =&gt; {
            slot.classList.remove(&#39;drop-target&#39;);
        });
        
        // Récupérer l&#39;élément en cours de déplacement
        const draggingElement = document.querySelector(&quot;.dragging&quot;);
        if (!draggingElement) return;
        
        // Récupérer le slot d&#39;origine
        const originSlot = draggingElement.closest(&#39;.slotChest&#39;);
        
        // Trouver le slot sous le curseur
        const dropTarget = e.target.closest(&#39;.slotChest&#39;);
        if (!dropTarget) return;
        
        // Si on dépose sur un slot différent
        if (dropTarget !== originSlot) {
            // Si le slot cible contient déjà un élément
            const targetImg = dropTarget.querySelector(&#39;.item-img&#39;);
            
            if (targetImg) {
                // Échange des éléments
                originSlot.appendChild(targetImg);
                dropTarget.appendChild(draggingElement);
            } else {
                // Le slot cible est vide
                dropTarget.appendChild(draggingElement);
            }
        }
           if (window.sfxEnabled) {
      let possessionSound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/possageobjet.wav&quot;);
      possessionSound.volume = window.sfxVolume;
      possessionSound.play();
    }
        // Réinitialiser l&#39;élément déplacé
        draggingElement.classList.remove(&quot;dragging&quot;);
        draggingElement.style.opacity = &quot;1&quot;;
        draggingElement.style.zIndex = &quot;&quot;;
    });
}

// Implémentation du drag and drop pour mobile
function setupMobileDragDrop() {
    // Ajouter un style pour les indicateurs visuels
    if (!document.getElementById(&#39;mobile-drag-drop-style&#39;)) {
        const style = document.createElement(&#39;style&#39;);
        style.id = &#39;mobile-drag-drop-style&#39;;
        style.textContent = `
            .drop-target {
                background-color: rgba(0, 255, 0, 0.2);
                border: 2px dashed green !important;
            }
            #drag-ghost {
                position: fixed;
                pointer-events: none;
                z-index: 1000;
                opacity: 0.7;
                max-width: 50px;
                max-height: 50px;
                object-fit: contain;
            }
            @keyframes pulse-animation {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); box-shadow: 0 0 10px gold; }
                100% { transform: scale(1); }
            }
            .pulse {
                animation: pulse-animation 0.5s ease-in-out;
            }
        `;
        document.head.appendChild(style);
    }
}

// Configurer les événements tactiles pour un élément
function setupTouchEventsForItem(item) {
    item.addEventListener(&#39;touchstart&#39;, handleTouchStart, { passive: false });
    item.addEventListener(&#39;touchmove&#39;, handleTouchMove, { passive: false });
    item.addEventListener(&#39;touchend&#39;, handleTouchEnd);
    item.addEventListener(&#39;touchcancel&#39;, handleTouchEnd);
}

// Gérer le début du toucher
function handleTouchStart(e) {
    // Enregistrer le temps de début du toucher
    touchStartTime = new Date().getTime();
    touchMoved = false;
    
    // Enregistrer la position initiale
    const touch = e.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    
    // Ne pas empêcher le comportement par défaut immédiatement
    // pour permettre les clics simples
    
    touchDraggedItem = this;
    initialSlot = touchDraggedItem.closest(&#39;.slotChest&#39;);
}

// Gérer le déplacement du toucher
function handleTouchMove(e) {
    const touch = e.touches[0];
    
    // Calculer la distance parcourue
    const distX = Math.abs(touch.clientX - touchStartX);
    const distY = Math.abs(touch.clientY - touchStartY);
    
    // Si le mouvement dépasse le seuil, c&#39;est un drag
    if (distX &gt; MOVE_THRESHOLD || distY &gt; MOVE_THRESHOLD) {
        touchMoved = true;
        
        // Maintenant on peut empêcher le comportement par défaut
        e.preventDefault();
        
        // Si c&#39;est le premier mouvement significatif, créer le ghost
        if (!touchGhost &amp;&amp; touchDraggedItem) {
            // Créer l&#39;élément fantôme
            touchGhost = document.createElement(&#39;img&#39;);
            touchGhost.src = touchDraggedItem.src;
            touchGhost.id = &#39;drag-ghost&#39;;
            touchGhost.style.position = &#39;fixed&#39;;
            touchGhost.style.width = &#39;50px&#39;; // Taille fixe
            touchGhost.style.height = &#39;50px&#39;; // Taille fixe
            touchGhost.style.left = (touch.clientX - 25) + &#39;px&#39;;
            touchGhost.style.top = (touch.clientY - 25) + &#39;px&#39;;
            touchGhost.style.opacity = &#39;0.7&#39;;
            touchGhost.style.pointerEvents = &#39;none&#39;;
            touchGhost.style.zIndex = &#39;1000&#39;;
            document.body.appendChild(touchGhost);
            
            touchDraggedItem.classList.add(&#39;dragging&#39;);
            touchDraggedItem.style.opacity = &#39;0.3&#39;;
        }
        
        // Déplacer l&#39;élément fantôme
        if (touchGhost) {
            touchGhost.style.left = (touch.clientX - 25) + &#39;px&#39;;
            touchGhost.style.top = (touch.clientY - 25) + &#39;px&#39;;
        }
        
        // Trouver le slot sous le doigt
        const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        const slotBelow = elemBelow ? elemBelow.closest(&#39;.slotChest&#39;) : null;
        
        // Réinitialiser les indicateurs visuels
        document.querySelectorAll(&#39;.slotChest&#39;).forEach(slot =&gt; {
            slot.classList.remove(&#39;drop-target&#39;);
        });
        
        // Ajouter un indicateur visuel au slot cible
        if (slotBelow &amp;&amp; slotBelow !== initialSlot) {
            slotBelow.classList.add(&#39;drop-target&#39;);
        }
    }
}

// Gérer la fin du toucher
function handleTouchEnd(e) {
    const currentTime = new Date().getTime();
    const touchDuration = currentTime - touchStartTime;
    
    // Si c&#39;était un toucher court sans mouvement, c&#39;est un clic
    if (!touchMoved &amp;&amp; touchDuration &lt; CLICK_DELAY) {
        // Simuler un clic sur l&#39;élément
        simulateClick(touchDraggedItem);
    } 
    // Sinon, c&#39;est un drag qui se termine
    else if (touchGhost) {
        const touch = e.changedTouches[0];
        
        // Trouver le slot sous le doigt
        const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        const slotBelow = elemBelow ? elemBelow.closest(&#39;.slotChest&#39;) : null;
        
        // Réinitialiser tous les indicateurs visuels
        document.querySelectorAll(&#39;.slotChest&#39;).forEach(slot =&gt; {
            slot.classList.remove(&#39;drop-target&#39;);
        });
        
        // Si on a trouvé un slot valide et différent du slot d&#39;origine
        if (slotBelow &amp;&amp; slotBelow !== initialSlot &amp;&amp; touchDraggedItem) {
            // Si le slot cible contient déjà un élément
            const targetImg = slotBelow.querySelector(&#39;.item-img&#39;);
            
            if (targetImg) {
                // Échange des éléments
                initialSlot.appendChild(targetImg);
                slotBelow.appendChild(touchDraggedItem);
            } else {
                // Le slot cible est vide
                slotBelow.appendChild(touchDraggedItem);
            }
        }
        
        // Supprimer l&#39;élément fantôme
        touchGhost.remove();
        touchGhost = null;
    }
    
    // Réinitialiser l&#39;élément déplacé
    if (touchDraggedItem) {
        touchDraggedItem.classList.remove(&#39;dragging&#39;);
        touchDraggedItem.style.opacity = &#39;1&#39;;
    }
    
    // Réinitialiser les variables
    touchDraggedItem = null;
    initialSlot = null;
    touchMoved = false;
}

// Fonction pour simuler un clic
function simulateClick(element) {
    if (!element) return;
    
    // Trouver le slot parent
    const slot = element.closest(&#39;.slotChest&#39;);
    if (!slot) return;

    // Désélectionner tous les slots
    document.querySelectorAll(&#39;.slotChest&#39;).forEach(s =&gt; s.classList.remove(&#39;selected&#39;));

    // Sélectionner le nouveau slot
    slot.classList.add(&#39;selected&#39;);
    selectedSlot = slot;

    // Ajouter un effet visuel
    pulseEffect(element);

    // Récupérer les données de l&#39;objet
    selectedItem = {
        id: element.dataset.id,
        nom: element.dataset.nom,
        type: element.dataset.type,
        strength: element.dataset.strength !== undefined ? element.dataset.strength : &#39;N/A&#39;,
        armor: element.dataset.armor !== undefined ? element.dataset.armor : &#39;N/A&#39;,
        life: element.dataset.life !== undefined ? element.dataset.life : &#39;N/A&#39;,
        prix: parseInt(element.dataset.prix) || 0,
        src: element.src
    };

    // Basculer automatiquement vers l&#39;onglet de vente
    document.querySelector(&#39;[data-tab=&quot;vente&quot;]&#39;).click();
    
    // Mettre à jour l&#39;interface de vente avec l&#39;objet sélectionné
    updateSellInterface(selectedItem);
    
    // Faire défiler jusqu&#39;à l&#39;interface de vente
    const sellDetails = document.getElementById(&#39;sell-item-details&#39;);
    if (sellDetails) {
        sellDetails.scrollIntoView({ behavior: &#39;smooth&#39; });
    }
}

// Sauvegarde la valeur de gold dans le localStorage
function updateLocalStorage() {
    localStorage.setItem(&quot;$money&quot;, gold);
}

// Configuration du bouton &quot;Explore the galaxy&quot; pour sauvegarder et (éventuellement) naviguer
function setupExploreButton() {
    document.getElementById(&#39;explore&#39;).addEventListener(&#39;click&#39;, () =&gt; {
        const goldText = document.getElementById(&#39;gold-amount&#39;).textContent;
        const goldValue = parseInt(goldText.replace(/\D/g, &#39;&#39;)) || 0;
        $money = goldValue;
        localStorage.setItem(&quot;$money&quot;, goldValue);
    });
}

// Fonction de fermeture des détails (si besoin)
function closeItemDetails() {
    const detailsContainer = document.getElementById(&#39;chestInventory&#39;);
    detailsContainer.innerHTML = &#39;&#39;;
    selectedItem = null;
}



//musique de marchand
   if (window.musiqueDeFond) {
      window.musiqueDeFond.pause();
      window.musiqueDeFond.currentTime = 0;
    }

    // Lancer la musique des crédits
    const musiqueMarchand = new Audio(&quot;https://pickyouruniverse.com/DataProjects/General/SonEvenements/marchand.mp3&quot;);
    musiqueMarchand.loop = true;
    musiqueMarchand.volume = 0.7;
    musiqueMarchand.play().catch(err =&gt; console.log(&quot;Lecture bloquée par le navigateur&quot;, err));

    // Rendre la musique accessible globalement si besoin
    window.musiqueMarchand = musiqueMarchand;

  document.getElementById(&#39;explore&#39;)?.addEventListener(&#39;click&#39;, function () {
    if (window.musiqueMarchand) {
      window.musiqueMarchand.pause();
      window.musiqueMarchand.currentTime = 0;
       window.musiqueDeFond.play();
    }
  });

  document.getElementById(&#39;explore2&#39;)?.addEventListener(&#39;click&#39;, function () {
    if (window.musiqueMarchand) {
      window.musiqueMarchand.pause();
      window.musiqueMarchand.currentTime = 0;
       window.musiqueDeFond.play();
    }
  });
      &lt;/script&gt;
    &lt;/body&gt;
    &lt;/html&gt;}</tw-passagedata><tw-passagedata pid="566" name="Don" tags="" position="1100,125" size="100,100">{
&lt;style&gt;.money{display:none;}&lt;/style&gt;
&lt;!-- Boîte de don --&gt;
&lt;div id=&quot;donation-box&quot; class=&quot;donation-box&quot;&gt;
  🎁 &lt;strong&gt;Offer a sacred object&lt;/strong&gt;&lt;br&gt;
  &lt;span class=&quot;subtext&quot;&gt;Drag an item here... the Xylith will judge its value&lt;/span&gt;
&lt;/div&gt;

&lt;!-- Résultat --&gt;
&lt;p id=&quot;donation-result&quot; class=&quot;donation-message&quot;&gt;&lt;/p&gt;

&lt;!-- Coffre --&gt;
&lt;div class=&quot;chest&quot;&gt;
  &lt;div class=&quot;inventoryPlayerChest&quot; id=&quot;chestInventory&quot;&gt;
    &lt;!-- Slots d&#39;inventaire --&gt;
    &lt;div class=&quot;slotPlayerChest&quot;&gt;&lt;img src=&quot;helmet.png&quot; class=&quot;item-img&quot; data-nom=&quot;astronaut&#39;s helmet&quot; data-type=&quot;helmet&quot;&gt;&lt;/div&gt;
    &lt;!-- Ajouter d&#39;autres slots selon besoin --&gt;
  &lt;/div&gt;
&lt;/div&gt;

[[Admin]] 
&lt;style&gt;
.donation-box {
  border: 3px dashed gold;
  border-radius: 20px;
  padding: 30px;
  margin: 30px auto;
  width: 300px;
  text-align: center;
  background: linear-gradient(to bottom right, #1f1f1f, #3b3b3b);
  color: gold;
  font-family: &#39;Trebuchet MS&#39;, sans-serif;
  transition: all 0.3s ease;
  cursor: grab;
}
&lt;script&gt;
// Gestionnaire de dons
const donationManager = {
  init() {
    const box = document.getElementById(&#39;donation-box&#39;);
    box.addEventListener(&#39;dragover&#39;, this.handleDragOver);
    box.addEventListener(&#39;drop&#39;, this.handleDrop.bind(this));
  },

  handleDragOver(e) {
    e.preventDefault();
    e.target.classList.add(&#39;hover&#39;);
  },

  handleDrop(e) {
    e.preventDefault();
    e.target.classList.remove(&#39;hover&#39;);
    
    const item = document.querySelector(&#39;.dragging&#39;);
    if (!item) return;

    if (this.isValidItem(item)) {
      item.remove();
      this.updateMoney(500);
      this.showResult(&quot;Thank you for your donation. 500 coins added!&quot;, &quot;green&quot;);
      
          document.getElementById(&#39;donation-box&#39;).style.display = &#39;none&#39;;
    } else {
      this.showResult(&quot;Object refused by the Xylith&quot;, &quot;red&quot;);
    }
  },

  isValidItem(item) {
    return item.dataset.nom === &quot;astronaut&#39;s helmet&quot; &amp;&amp; item.dataset.type === &quot;helmet&quot;;
  },

updateMoney(amount) {
  // Récupérer l&#39;argent actuel dans le localStorage ou initialiser à 0
  let money = parseInt(localStorage.getItem(&#39;playerMoney&#39;) || 0) + amount;

  // Mettre à jour la valeur dans le localStorage
  localStorage.setItem(&#39;playerMoney&#39;, money);

    $money = money;
},
  showResult(msg, color) {
    const result = document.getElementById(&#39;donation-result&#39;);
    result.textContent = msg;
    result.style.color = color;
    setTimeout(() =&gt; result.textContent = &#39;&#39;, 3000);
  }
};

// Système de drag &amp; drop
const dragManager = {
  currentItem: null,
  clone: null,
  originalSlot: null,

  init() {
    document.addEventListener(&#39;pointerdown&#39;, this.startDrag.bind(this));
  },

  startDrag(e) {
    const item = e.target.closest(&#39;.item-img&#39;);
    if (!item) return;

    this.currentItem = item;
    this.originalSlot = item.parentElement;
    
    item.classList.add(&#39;dragging&#39;);
    
    this.createClone(e);
    document.addEventListener(&#39;pointermove&#39;, this.moveClone);
    document.addEventListener(&#39;pointerup&#39;, this.dropItem.bind(this));
  },

  createClone(e) {
    this.clone = this.currentItem.cloneNode(true);
    this.clone.style.position = &#39;fixed&#39;;
    this.clone.style.width = &#39;60px&#39;;
    this.clone.style.height = &#39;60px&#39;;
    this.clone.style.pointerEvents = &#39;none&#39;;
    this.clone.style.transform = `translate(${e.clientX - 30}px, ${e.clientY - 30}px)`;
    document.body.appendChild(this.clone);
  },

  moveClone(e) {
    if (!this.clone) return;
    this.clone.style.transform = `translate(${e.clientX - 30}px, ${e.clientY - 30}px)`;
  },

  dropItem(e) {
    // Cleanup
    document.removeEventListener(&#39;pointermove&#39;, this.moveClone);
    document.removeEventListener(&#39;pointerup&#39;, this.dropItem);
    this.clone?.remove();
    this.currentItem?.classList.remove(&#39;dragging&#39;);

    // Handle drop
    const dropTarget = document.elementFromPoint(e.clientX, e.clientY);
    const validContainer = dropTarget?.closest(&#39;.slotPlayerChest, .iconArmors&#39;);

    if (validContainer) {
      this.moveToContainer(validContainer);
    } else if (!dropTarget?.closest(&#39;#donation-box&#39;)) {
      this.returnToOriginalSlot();
    }
  },

  moveToContainer(container) {
    const existingItem = container.querySelector(&#39;.item-img&#39;);
    if (existingItem) {
      this.originalSlot.appendChild(existingItem);
    }
    container.appendChild(this.currentItem);
  },

  returnToOriginalSlot() {
    this.originalSlot.appendChild(this.currentItem);
  }
};

// Initialisation
donationManager.init();
dragManager.init();
&lt;/script&gt;
}</tw-passagedata><tw-passagedata pid="567" name="Coffre" tags="" position="1225,125" size="100,100">{ &lt;style&gt;.money{display:none;}&lt;/style&gt;
&lt;div class=&quot;chest&quot;&gt;
    &lt;!-- Bouton de switch avec icônes --&gt;
    &lt;button id=&quot;toggleView&quot; class=&quot;toggle-view-btn&quot;&gt;
        &lt;span class=&quot;inventory-icon&quot;&gt;📦&lt;/span&gt;
        &lt;span class=&quot;equipment-icon&quot;&gt;🛡️&lt;/span&gt;
        &lt;div class=&quot;toggle-slider&quot;&gt;&lt;/div&gt;
    &lt;/button&gt;
    
    &lt;div class=&quot;chest-content&quot;&gt;
        &lt;div class=&quot;inventoryChest&quot; id=&quot;chest1&quot;&gt;
            &lt;!-- 27 emplacements d&#39;inventaire --&gt;
        &lt;/div&gt;

        &lt;div class=&quot;inventoryPlayerChest&quot; id=&quot;chestInventory&quot;&gt;
            &lt;!-- 27 emplacements d&#39;inventaire --&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;!-- Vue Inventaire --&gt;
    &lt;div class=&quot;chest-view active&quot; id=&quot;inventoryView&quot;&gt;
       
    &lt;/div&gt;

&lt;div class=&quot;chest-view&quot; id=&quot;equipmentView&quot;&gt;
  &lt;div class=&quot;special-armorsCoffre&quot;&gt;
    &lt;div class=&quot;blockEquipements&quot; id=&quot;chestEquipmentMirror&quot;&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
}

[[Get what you need, than get the hell out of here !-&gt;Admin]]

&lt;script&gt;
  const chestId = &quot;coffre&quot;;

  // Liste d&#39;objets par défaut (votre code de base)
  const itemsDefault = [
    { id: &quot;sword3&quot;, nom: &quot;Dague des fromans&quot;, type: &quot;sword&quot;, strength: 9, durability: 10, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;1&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/RayGun.png&quot;, prix: 142, rare: &quot;Uncommon&quot; },
    { id: &quot;sword4&quot;, nom: &quot;Horn&quot;, type: &quot;sword&quot;, strength: 8, durability: 30, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;2&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/Horn.png&quot;, prix: 180, rare: &quot;Epic&quot;  },
    { id: &quot;soin2&quot;, nom: &quot;Healing Potion&quot;, type: &quot;soin&quot;, life: 15, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;3&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Medkit.png&quot;, prix: 35, rare: &quot;Common&quot;  },
    { id: &quot;glasse1&quot;, nom: &quot;glasse&quot;, type: &quot;object&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;4&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Objets/Glasses.png&quot;, prix: 67, rare: &quot;Common&quot;  },
    { id: &quot;Watch1&quot;, nom: &quot;Watch&quot;, type: &quot;object&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;5&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Objets/Watch.png&quot;, prix: 115, rare: &quot;Common&quot;  },
    { id: &quot;petitPiece&quot;, nom: &quot;Money&quot;, type: &quot;money&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;6&quot;, money: 500, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Money/SmallMoney.png&quot;, rare: &quot;Common&quot;  },
    { id: &quot;armor1&quot;, nom: &quot;Armor&quot;, type: &quot;armor&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;7&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Body.png&quot;, rare: &quot;Common&quot;  },
    { id: &quot;boots1&quot;, nom: &quot;Boots&quot;, type: &quot;boots&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;8&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Boots.png&quot;, rare: &quot;Common&quot;  },
  ];

  // Vérifie si le coffre a déjà été initialisé
  const hasOpened = localStorage.getItem(&quot;chest_opened_&quot; + chestId);
  
  if (!hasOpened) {
    // Première arrivée : on charge les objets par défaut et on les sauvegarde
    renderChestInventory(itemsDefault);
    localStorage.setItem(&quot;chest_inventory_&quot; + chestId, JSON.stringify(itemsDefault));
    localStorage.setItem(&quot;chest_opened_&quot; + chestId, &quot;true&quot;);
    console.log(&quot;✨ Coffre rempli pour la première fois&quot;);
  } else {
    // On récupère les données sauvegardées
    const savedItems = localStorage.getItem(&quot;chest_inventory_&quot; + chestId);
    if (savedItems) {
      const itemsSaved = JSON.parse(savedItems);
      renderChestInventory(itemsSaved);
    }
    console.log(&quot;🚫 Coffre déjà ouvert, état récupéré&quot;);
  }
    
  function mirrorEquipment() {
    const headerEquip = document.querySelector(&#39;.inventaireBas .blockEquipements&#39;);
    const chestMirror = document.getElementById(&#39;chestEquipmentMirror&#39;);
    if (headerEquip &amp;&amp; chestMirror) {
      chestMirror.innerHTML = headerEquip.innerHTML;
      reattachDragAndDrop();
      saveEquipmentState(); 
      attachTooltipEquipements();
    }
  }

  const headerEquipContainer = document.querySelector(&#39;.inventaireBas .blockEquipements&#39;);
  if (headerEquipContainer) {
    const observer = new MutationObserver(mirrorEquipment);
    observer.observe(headerEquipContainer, { childList: true, subtree: true });
  }

  function reattachDragAndDrop() {
    document.querySelectorAll(&#39;.iconArmors .item-img, .inventoryPlayerChest .item-img, .blockEquipements .item-img, .inventoryChest .item-img&#39;)
      .forEach(item =&gt; {
        item.removeEventListener(&#39;mousedown&#39;, startDragging);
        item.removeEventListener(&#39;touchstart&#39;, startDragging);
        item.addEventListener(&#39;mousedown&#39;, startDragging);
        item.addEventListener(&#39;touchstart&#39;, startDragging, { passive: false });
      });
  }

  /* ---------------------------
     Drag &amp; Drop personnalisé pour les équipements
     --------------------------- */
  window.startDragging = function(e) {
    e.preventDefault();
    const draggable = this;
    const rect = draggable.getBoundingClientRect();
  
    let clientX, clientY;
    if (e.touches) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    const startX = clientX - rect.left;
    const startY = clientY - rect.top;
    const originalParent = draggable.parentElement; 

    const draggedCopy = draggable.cloneNode(true);
    draggedCopy.style.position = &#39;fixed&#39;;
    draggedCopy.style.zIndex = &#39;1000&#39;;
    draggedCopy.style.pointerEvents = &#39;none&#39;;
    draggedCopy.style.width = rect.width + &#39;px&#39;;
    draggedCopy.style.height = rect.height + &#39;px&#39;;
    document.body.appendChild(draggedCopy);

    draggable.style.visibility = &#39;hidden&#39;;

    function moveItem(moveEvent) {
      let moveClientX, moveClientY;
      if (moveEvent.type === &#39;touchmove&#39;) {
        moveClientX = moveEvent.touches[0].clientX;
        moveClientY = moveEvent.touches[0].clientY;
      } else {
        moveClientX = moveEvent.clientX;
        moveClientY = moveEvent.clientY;
      }
      const x = moveClientX - startX;
      const y = moveClientY - startY;
      draggedCopy.style.left = x + &#39;px&#39;;
      draggedCopy.style.top = y + &#39;px&#39;;
    }

    function stopDragging(upEvent) {
      document.removeEventListener(&#39;mousemove&#39;, moveItem);
      document.removeEventListener(&#39;mouseup&#39;, stopDragging);
      document.removeEventListener(&#39;touchmove&#39;, moveItem);
      document.removeEventListener(&#39;touchend&#39;, stopDragging);
      
      if (draggedCopy &amp;&amp; draggedCopy.parentElement) {
        document.body.removeChild(draggedCopy);
      }
      draggable.style.visibility = &#39;visible&#39;;

      const moneyValue = parseInt(draggable.getAttribute(&#39;data-money&#39;)) || 0;
      if (moneyValue &gt; 0) {
        let currentMoney = parseInt(localStorage.getItem(&#39;playerMoney&#39;)) || 0;
        let newTotal = currentMoney + moneyValue;
        localStorage.setItem(&#39;playerMoney&#39;, newTotal);
        $money += newTotal;
        alert(&quot;The money has been added to your purse.&quot;);
        if (window.sfxEnabled) {
          let moneySound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/argent.wav&quot;);
          moneySound.volume = window.sfxVolume;
          moneySound.play();
        }
        draggable.remove();
        synchronizeInventories();
        return;
      }
      let endClientX, endClientY;
      if (upEvent.type === &#39;touchend&#39; &amp;&amp; upEvent.changedTouches &amp;&amp; upEvent.changedTouches.length &gt; 0) {
        endClientX = upEvent.changedTouches[0].clientX;
        endClientY = upEvent.changedTouches[0].clientY;
      } else if (upEvent.clientX &amp;&amp; upEvent.clientY) {
        endClientX = upEvent.clientX;
        endClientY = upEvent.clientY;
      } else {
        endClientX = 0;
        endClientY = 0;
      }

      // Recherche du conteneur cible de dépôt
      const dropTarget = document.elementFromPoint(endClientX, endClientY);
      const container = dropTarget ? dropTarget.closest(&#39;.iconArmors, .slotChest, .slotPlayerChest&#39;) : null;

      if (container) {
        if (container.classList.contains(&#39;iconArmors&#39;)) {
          const slotType = container.getAttribute(&#39;data-type&#39;);
          const itemType = draggable.getAttribute(&#39;data-type&#39;);
          
          if (slotType !== itemType) {
            originalParent.appendChild(draggable);
            return synchronizeInventories();
          }

          const existingItem = container.querySelector(&#39;.item-img&#39;);
          if (existingItem) {
            originalParent.appendChild(existingItem);
          }
          container.appendChild(draggable);
        } else {
          const invExisting = container.querySelector(&#39;.item-img&#39;);
          if (invExisting &amp;&amp; invExisting !== draggable) {
            originalParent.appendChild(invExisting);
          }
          if (window.sfxEnabled) {
            let possessionSound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/possageobjet.wav&quot;);
            possessionSound.volume = window.sfxVolume;
            possessionSound.play();
          }
          container.appendChild(draggable);
        }
      } else {
        const playerSlots = document.querySelectorAll(&#39;#chestInventory .slotPlayerChest&#39;);
        let emptySlot = null;
        for (const slot of playerSlots) {
          if (!slot.querySelector(&#39;.item-img&#39;)) {
            emptySlot = slot;
            break;
          }
        }
        if (emptySlot) {
          emptySlot.appendChild(draggable);
        } else {
          originalParent.appendChild(draggable);
        }
      }
      synchronizeInventories();
    }

    document.addEventListener(&#39;mousemove&#39;, moveItem);
    document.addEventListener(&#39;mouseup&#39;, stopDragging);
    document.addEventListener(&#39;touchmove&#39;, moveItem, { passive: false });
    document.addEventListener(&#39;touchend&#39;, stopDragging, { passive: false });
  };

  /* ---------------------------
     Gestion du Toggle entre inventaire et équipements
     --------------------------- */
  const toggleBtn = document.getElementById(&#39;toggleView&#39;);
  const inventoryView = document.getElementById(&#39;inventoryView&#39;);
  const equipmentView = document.getElementById(&#39;equipmentView&#39;);

  toggleBtn.addEventListener(&#39;click&#39;, () =&gt; {
    inventoryView.classList.toggle(&#39;active&#39;);
    equipmentView.classList.toggle(&#39;active&#39;);
    toggleBtn.classList.toggle(&#39;active&#39;);
    
    if (equipmentView.classList.contains(&#39;active&#39;)) {
      synchronizeEquipments();
    }
  });

  /* ---------------------------
     Synchronisation des équipements pour le header
     --------------------------- */
  function synchronizeEquipments() {
    const equipSlots = document.querySelectorAll(&#39;#equipmentView .iconArmors&#39;);
    equipSlots.forEach(slot =&gt; {
      const item = slot.querySelector(&#39;.item-img&#39;);
      if (item) {
        const decorative = slot.querySelector(&#39;.decorative-image&#39;);
        if (decorative) decorative.remove();
        item.removeEventListener(&#39;mousedown&#39;, startDragging);
        item.addEventListener(&#39;mousedown&#39;, startDragging);
        item.removeEventListener(&#39;touchstart&#39;, startDragging);
        item.addEventListener(&#39;touchstart&#39;, startDragging);
      } else {
        const decorative = slot.querySelector(&#39;.decorative-image&#39;);
        if (decorative) decorative.style.display = &#39;block&#39;;
      }
    });
    setTimeout(saveEquipmentState, 100);
  }

  /* ---------------------------
     Affichage de l&#39;infobulle (tooltip) pour équipements
     --------------------------- */
  function showTooltipEquipements(event, itemElement) {
    const existing = document.querySelector(&#39;.tooltip&#39;);
    if (existing) existing.remove();
    if (itemElement.classList.contains(&#39;iconArmors&#39;)) {
      itemElement = itemElement.querySelector(&#39;.item-img&#39;);
    }
    if (!itemElement) return;
    const tooltip = document.createElement(&#39;div&#39;);
    tooltip.className = &#39;tooltip&#39;;
    tooltip.style.position = &#39;absolute&#39;;
    tooltip.style.backgroundColor = &#39;rgba(0,0,0,0.8)&#39;;
    tooltip.style.color = &#39;#fff&#39;;
    tooltip.style.padding = &#39;8px&#39;;
    tooltip.style.borderRadius = &#39;5px&#39;;
    tooltip.style.fontSize = &#39;12px&#39;;
    tooltip.style.zIndex = &#39;1000&#39;;
    tooltip.style.display = &#39;none&#39;;
    let content = &#39;&#39;;
    function addAttr(label, attr) {
      const val = itemElement.getAttribute(attr);
      if (val &amp;&amp; val.trim() !== &#39;&#39; &amp;&amp; val.toLowerCase() !== &#39;null&#39;) {
        content += `&lt;strong&gt;${label}:&lt;/strong&gt; ${val}&lt;br&gt;`;
      }
    }
    addAttr(&#39;Nom&#39;, &#39;data-nom&#39;);
    addAttr(&#39;Type&#39;, &#39;data-type&#39;);
    addAttr(&#39;Strength&#39;, &#39;data-strength&#39;);
    addAttr(&#39;Durability&#39;, &#39;data-durability&#39;);
    addAttr(&#39;Life&#39;, &#39;data-life&#39;);
    addAttr(&#39;Armor&#39;, &#39;data-armor&#39;);
    addAttr(&#39;Prix&#39;, &#39;data-prix&#39;);
    addAttr(&#39;Rare&#39;, &#39;data-rare&#39;);
    addAttr(&#39;Money&#39;, &#39;data-money&#39;);

    if (!content) return;
    tooltip.innerHTML = content;
    tooltip.style.display = &#39;block&#39;;
    tooltip.style.left = (event.clientX + 10) + &#39;px&#39;;
    tooltip.style.top = (event.clientY + 10) + &#39;px&#39;;
    document.body.appendChild(tooltip);
    function onMouseMove(e) {
      tooltip.style.left = (e.clientX + 10) + &#39;px&#39;;
      tooltip.style.top = (e.clientY + 10) + &#39;px&#39;;
    }
    document.addEventListener(&#39;mousemove&#39;, onMouseMove);
    itemElement.addEventListener(&#39;mouseleave&#39;, function() {
      tooltip.remove();
      document.removeEventListener(&#39;mousemove&#39;, onMouseMove);
    }, { once: true });
  }

  /* ---------------------------
     Attachement des tooltips pour équipements
     --------------------------- */
  function attachTooltipEquipements() {
    document.querySelectorAll(&#39;#chestEquipmentMirror .item-img&#39;).forEach(item =&gt; {
      item.removeEventListener(&#39;mouseenter&#39;, tooltipEquipListener);
      item.addEventListener(&#39;mouseenter&#39;, tooltipEquipListener);
    });
  }
  function tooltipEquipListener(e) {
    showTooltipEquipements(e, e.currentTarget);
  }
  
  /* ---------------------------
     Rendu des objets dans l&#39;inventaire (chestInventory)
     --------------------------- */
  function renderChestInventory(itemsArray) {
    const slots = document.querySelectorAll(&quot;.inventoryChest .slotChest&quot;);
    slots.forEach(slot =&gt; slot.innerHTML = &quot;&quot;);
    itemsArray.forEach(item =&gt; {
      if (item.inventorychest) {
        const slotIndex = parseInt(item.inventorychest) - 1;
        const slot = slots[slotIndex];
        if (slot) {
          const img = document.createElement(&quot;img&quot;);
          img.setAttribute(&quot;data-id&quot;, item.id);
          img.setAttribute(&quot;data-nom&quot;, item.nom);
          img.setAttribute(&quot;data-type&quot;, item.type);
          if (item.strength) img.setAttribute(&quot;data-strength&quot;, item.strength);
          if (item.durability) img.setAttribute(&quot;data-durability&quot;, item.durability);
          if (item.life) img.setAttribute(&quot;data-life&quot;, item.life);
          if (item.armor) img.setAttribute(&quot;data-armor&quot;, item.armor);
          if (item.prix) img.setAttribute(&quot;data-prix&quot;, item.prix);
          if (item.rare) img.setAttribute(&quot;data-rare&quot;, item.rare);
          if (item.money) img.setAttribute(&quot;data-money&quot;, item.money);
          img.src = item.src;
          img.className = item.class;
          img.draggable = item.draggable;
          img.id = item.id;
          img.addEventListener(&quot;mouseenter&quot;, event =&gt; showTooltip(event, img));
          slot.appendChild(img);
        }
      }
    });
  }

  /* ---------------------------
     Initialisation du Drag &amp; Drop pour l&#39;inventaire
     --------------------------- */
  function initDragAndDrop() {
    const draggables = document.querySelectorAll(&#39;.item-img&#39;);
    const containers = document.querySelectorAll(&#39;.slotChest, .slotPlayerChest&#39;);
    draggables.forEach(draggable =&gt; {
      draggable.addEventListener(&#39;dragstart&#39;, function(e) {
        draggable.classList.add(&#39;dragging&#39;);
        draggable.dataset.source = draggable.parentElement.id;
      });
      draggable.addEventListener(&#39;dragend&#39;, function(e) {
        draggable.classList.remove(&#39;dragging&#39;);
        delete draggable.dataset.source;
      });
    });
    containers.forEach(container =&gt; {
      container.addEventListener(&#39;dragover&#39;, function(e) {
        e.preventDefault();
      });
      container.addEventListener(&#39;drop&#39;, function(e) {
        e.preventDefault();
        const draggedItem = document.querySelector(&#39;.dragging&#39;);
        if (!draggedItem) return;
        const sourceContainer = document.getElementById(draggedItem.dataset.source);
        const targetContainer = container;
        const existing = targetContainer.querySelector(&#39;.item-img&#39;);
        if (existing &amp;&amp; existing !== draggedItem) {
          targetContainer.removeChild(existing);
          if (sourceContainer) {
            sourceContainer.appendChild(existing);
          }
        }
        targetContainer.appendChild(draggedItem);
        synchronizeInventories();
      });
    });
  }

  /* ---------------------------
     Synchronisation globale (inventaire et équipements)
     --------------------------- */
  function synchronizeInventories() {
    synchronizeEquipments();
    const chestSlots = document.querySelectorAll(&#39;.inventoryChest .slotChest&#39;);
    const savedItems = [];
    chestSlots.forEach((slot, index) =&gt; {
      const item = slot.querySelector(&#39;.item-img&#39;);
      if (item) {
        savedItems.push({
          id: item.id,
          nom: item.getAttribute(&#39;data-nom&#39;),
          type: item.getAttribute(&#39;data-type&#39;),
          strength: item.getAttribute(&#39;data-strength&#39;),
          durability: item.getAttribute(&#39;data-durability&#39;),
          life: item.getAttribute(&#39;data-life&#39;),
          armor: item.getAttribute(&#39;data-armor&#39;),
          prix: item.getAttribute(&#39;data-prix&#39;),
          rare: item.getAttribute(&#39;data-rare&#39;),
          money: item.getAttribute(&#39;data-money&#39;),
           src: item.src,
           class: item.className,
          inventorychest: slot.dataset.slot || (index + 1)
        });
      }
    });
    localStorage.setItem(&quot;chest_inventory_&quot; + chestId, JSON.stringify(savedItems));
  }

  /* ---------------------------
     Gestion de l&#39;état des équipements
     --------------------------- */
  function saveEquipmentState() {
    const slots = document.querySelectorAll(&#39;#chestEquipmentMirror .iconArmors&#39;);
    const data = [];
    slots.forEach(slot =&gt; {
      const item = slot.querySelector(&#39;.item-img&#39;);
      if (item) {
        data.push({
          type: item.getAttribute(&#39;data-type&#39;),
          src: item.src,
          id: item.getAttribute(&#39;data-id&#39;),
          nom: item.getAttribute(&#39;data-nom&#39;),
          strength: item.getAttribute(&#39;data-strength&#39;),
          durability: item.getAttribute(&#39;data-durability&#39;),
          life: item.getAttribute(&#39;data-life&#39;),
          armor: item.getAttribute(&#39;data-armor&#39;),
          prix: item.getAttribute(&#39;data-prix&#39;),
          rare: item.getAttribute(&#39;data-rare&#39;),
          money: item.getAttribute(&#39;data-money&#39;),
        });
      } else {
        data.push(null);
      }
    });
    localStorage.setItem(&#39;specialArmorInventory&#39;, JSON.stringify(data));
  }
  
  const chestEquipContainer = document.getElementById(&#39;chestEquipmentMirror&#39;);
  if (chestEquipContainer) {
    const chestObserver = new MutationObserver(() =&gt; {
      saveEquipmentState();
      synchronizeEquipments();
    });
    chestObserver.observe(chestEquipContainer, { 
      childList: true, 
      subtree: true,
      attributes: true,
      attributeFilter: [&#39;data-type&#39;, &#39;data-strength&#39;, &#39;data-durability&#39;] 
    });
  }

  function createItem(type, src, id, nom, strength, durability, life, armor, prix, rare, money) {
    const img = document.createElement(&#39;img&#39;);
    img.setAttribute(&quot;data-id&quot;, id);
    img.setAttribute(&quot;data-nom&quot;, nom);
    img.setAttribute(&quot;data-type&quot;, type);
    if (strength) img.setAttribute(&quot;data-strength&quot;, strength);
    if (durability) img.setAttribute(&quot;data-durability&quot;, durability);
    if (life) img.setAttribute(&quot;data-life&quot;, life);
    if (armor) img.setAttribute(&quot;data-armor&quot;, armor);
    if (prix) img.setAttribute(&quot;data-prix&quot;, prix);
    if (rare) img.setAttribute(&quot;data-rare&quot;, rare);
    if (money) img.setAttribute(&quot;data-money&quot;, money);
    img.src = src;
    img.className = &quot;item-img&quot;;
    img.draggable = true;
    img.addEventListener(&#39;dragstart&#39;, () =&gt; img.classList.add(&#39;dragging&#39;));
    img.addEventListener(&#39;dragend&#39;, () =&gt; img.classList.remove(&#39;dragging&#39;));
    img.addEventListener(&#39;mousedown&#39;, startDragging);
    return img;
  }

  function loadEquipmentState() {
    const data = JSON.parse(localStorage.getItem(&#39;specialArmorInventory&#39;));
    if (!data) return;
    const slots = document.querySelectorAll(&#39;#chestEquipmentMirror .iconArmors&#39;);
    data.forEach((d, i) =&gt; {
      if (d &amp;&amp; slots[i]) {
        slots[i].innerHTML = &#39;&#39;;
        const newItem = createItem(d.type, d.src, d.id, d.nom, d.strength, d.durability, d.life, d.armor, d.prix, d.rare);
        slots[i].appendChild(newItem);
        reattachDragAndDrop();
        attachTooltipEquipements();
      }
    });
  }

  /* ---------------------------
     Drag &amp; Drop pour équipements
     --------------------------- */
  function setupEquipmentDragAndDrop() {
    const equipmentSlots = document.querySelectorAll(&#39;.special-armors .iconArmors&#39;);
    equipmentSlots.forEach(slot =&gt; {
      slot.addEventListener(&#39;dragover&#39;, function(e) {
        e.preventDefault();
      });
      slot.addEventListener(&#39;drop&#39;, function(e) {
        e.preventDefault();
        const draggedItem = document.querySelector(&#39;.dragging&#39;);
        if (draggedItem) {
          const slotType = slot.getAttribute(&#39;data-type&#39;);
          const itemType = draggedItem.getAttribute(&#39;data-type&#39;);
          if (slotType !== itemType) {
            const source = document.getElementById(draggedItem.dataset.source);
            if (source) source.appendChild(draggedItem);
            return;
          }
          if (draggedItem.parentElement) {
            draggedItem.parentElement.removeChild(draggedItem);
          }
          slot.innerHTML = &#39;&#39;;
          slot.appendChild(draggedItem);
          setTimeout(synchronizeEquipments, 100);
        } else {
          const decorative = slot.querySelector(&#39;.decorative-image&#39;);
          if (!slot.querySelector(&#39;.item-img&#39;) &amp;&amp; decorative) {
            decorative.style.display = &#39;block&#39;;
          }
        }
      });
    });
  }

  /* ---------------------------
     Outil pour attacher les tooltips
     --------------------------- */
  function attachTooltip(selector) {
    document.querySelectorAll(selector).forEach(elem =&gt; {
      const target = elem.hasAttribute(&#39;data-type&#39;) ? elem : (elem.querySelector(&#39;img&#39;) || elem);
      target.addEventListener(&#39;mouseenter&#39;, event =&gt; showTooltip(event, target));
    });
  }

  // Initialisations principales
  loadEquipmentState();
  setupEquipmentDragAndDrop();
  initDragAndDrop();
  attachTooltip(&#39;.slotChest&#39;);
  attachTooltip(&#39;.iconArmors&#39;);

  const toggleEquipBtn = document.getElementById(&quot;toggle-equipement&quot;);
  if (toggleEquipBtn) {
    toggleEquipBtn.remove();
  }

  // Suppression d&#39;éléments inutiles pour l&#39;inventaire du coffre
  const chestContainer = document.querySelector(&quot;.chest&quot;);
  if (chestContainer) {
    const iconArmorsWithoutDataType = document.querySelectorAll(&quot;.iconArmors:not([data-type])&quot;);
    if (iconArmorsWithoutDataType.length &gt; 0) {
      iconArmorsWithoutDataType[iconArmorsWithoutDataType.length - 1].remove();
    }
  }
&lt;/script&gt;</tw-passagedata><tw-passagedata pid="568" name="Coffre2" tags="" position="1225,250" size="100,100">{ &lt;style&gt;.money{display:none;}&lt;/style&gt;
&lt;div class=&quot;chest&quot;&gt;
    &lt;!-- Bouton de switch avec icônes --&gt;
    &lt;button id=&quot;toggleView&quot; class=&quot;toggle-view-btn&quot;&gt;
        &lt;span class=&quot;inventory-icon&quot;&gt;📦&lt;/span&gt;
        &lt;span class=&quot;equipment-icon&quot;&gt;🛡️&lt;/span&gt;
        &lt;div class=&quot;toggle-slider&quot;&gt;&lt;/div&gt;
    &lt;/button&gt;
    
    &lt;div class=&quot;chest-content&quot;&gt;
        &lt;div class=&quot;inventoryChest&quot; id=&quot;chest1&quot;&gt;
            &lt;!-- 27 emplacements d&#39;inventaire --&gt;
        &lt;/div&gt;

        &lt;div class=&quot;inventoryPlayerChest&quot; id=&quot;chestInventory&quot;&gt;
            &lt;!-- 27 emplacements d&#39;inventaire --&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;!-- Vue Inventaire --&gt;
    &lt;div class=&quot;chest-view active&quot; id=&quot;inventoryView&quot;&gt;
       
    &lt;/div&gt;

&lt;div class=&quot;chest-view&quot; id=&quot;equipmentView&quot;&gt;
  &lt;div class=&quot;special-armorsCoffre&quot;&gt;
    &lt;div class=&quot;blockEquipements&quot; id=&quot;chestEquipmentMirror&quot;&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
}

[[Get what you need, than get the hell out of here !-&gt;Admin]]

&lt;script&gt;
  const chestId = &quot;coffre2&quot;;

  // Liste d&#39;objets par défaut (votre code de base)
  const itemsDefault = [
    { id: &quot;sword3&quot;, nom: &quot;Dague des fromans&quot;, type: &quot;sword&quot;, strength: 9, durability: 10, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;1&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/RayGun.png&quot;, prix: 142, rare: &quot;Uncommon&quot; },
    { id: &quot;sword4&quot;, nom: &quot;Horn&quot;, type: &quot;sword&quot;, strength: 8, durability: 30, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;2&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/Horn.png&quot;, prix: 180, rare: &quot;Epic&quot;  },
    { id: &quot;soin2&quot;, nom: &quot;Healing Potion&quot;, type: &quot;soin&quot;, life: 15, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;3&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Medkit.png&quot;, prix: 35, rare: &quot;Common&quot;  },
    { id: &quot;glasse1&quot;, nom: &quot;glasse&quot;, type: &quot;object&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;4&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Objets/Glasses.png&quot;, prix: 67, rare: &quot;Common&quot;  },
    { id: &quot;Watch1&quot;, nom: &quot;Watch&quot;, type: &quot;object&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;5&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Objets/Watch.png&quot;, prix: 115, rare: &quot;Common&quot;  },
    { id: &quot;petitPiece&quot;, nom: &quot;Money&quot;, type: &quot;money&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;6&quot;, money: 500, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Money/SmallMoney.png&quot;, rare: &quot;Common&quot;  },
    { id: &quot;armor1&quot;, nom: &quot;Armor&quot;, type: &quot;armor&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;7&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Body.png&quot;, rare: &quot;Common&quot;  },
    { id: &quot;boots1&quot;, nom: &quot;Boots&quot;, type: &quot;boots&quot;, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;8&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Boots.png&quot;, rare: &quot;Common&quot;  },
  ];

  // Vérifie si le coffre a déjà été initialisé
  const hasOpened = localStorage.getItem(&quot;chest_opened_&quot; + chestId);
  
  if (!hasOpened) {
    // Première arrivée : on charge les objets par défaut et on les sauvegarde
    renderChestInventory(itemsDefault);
    localStorage.setItem(&quot;chest_inventory_&quot; + chestId, JSON.stringify(itemsDefault));
    localStorage.setItem(&quot;chest_opened_&quot; + chestId, &quot;true&quot;);
    console.log(&quot;✨ Coffre rempli pour la première fois&quot;);
  } else {
    // On récupère les données sauvegardées
    const savedItems = localStorage.getItem(&quot;chest_inventory_&quot; + chestId);
    if (savedItems) {
      const itemsSaved = JSON.parse(savedItems);
      renderChestInventory(itemsSaved);
    }
    console.log(&quot;🚫 Coffre déjà ouvert, état récupéré&quot;);
  }
    
  function mirrorEquipment() {
    const headerEquip = document.querySelector(&#39;.inventaireBas .blockEquipements&#39;);
    const chestMirror = document.getElementById(&#39;chestEquipmentMirror&#39;);
    if (headerEquip &amp;&amp; chestMirror) {
      chestMirror.innerHTML = headerEquip.innerHTML;
      reattachDragAndDrop();
      saveEquipmentState(); 
      attachTooltipEquipements();
    }
  }

  const headerEquipContainer = document.querySelector(&#39;.inventaireBas .blockEquipements&#39;);
  if (headerEquipContainer) {
    const observer = new MutationObserver(mirrorEquipment);
    observer.observe(headerEquipContainer, { childList: true, subtree: true });
  }

  function reattachDragAndDrop() {
    document.querySelectorAll(&#39;.iconArmors .item-img, .inventoryPlayerChest .item-img, .blockEquipements .item-img, .inventoryChest .item-img&#39;)
      .forEach(item =&gt; {
        item.removeEventListener(&#39;mousedown&#39;, startDragging);
        item.removeEventListener(&#39;touchstart&#39;, startDragging);
        item.addEventListener(&#39;mousedown&#39;, startDragging);
        item.addEventListener(&#39;touchstart&#39;, startDragging, { passive: false });
      });
  }

  /* ---------------------------
     Drag &amp; Drop personnalisé pour les équipements
     --------------------------- */
  window.startDragging = function(e) {
    e.preventDefault();
    const draggable = this;
    const rect = draggable.getBoundingClientRect();
  
    let clientX, clientY;
    if (e.touches) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    const startX = clientX - rect.left;
    const startY = clientY - rect.top;
    const originalParent = draggable.parentElement; 

    const draggedCopy = draggable.cloneNode(true);
    draggedCopy.style.position = &#39;fixed&#39;;
    draggedCopy.style.zIndex = &#39;1000&#39;;
    draggedCopy.style.pointerEvents = &#39;none&#39;;
    draggedCopy.style.width = rect.width + &#39;px&#39;;
    draggedCopy.style.height = rect.height + &#39;px&#39;;
    document.body.appendChild(draggedCopy);

    draggable.style.visibility = &#39;hidden&#39;;

    function moveItem(moveEvent) {
      let moveClientX, moveClientY;
      if (moveEvent.type === &#39;touchmove&#39;) {
        moveClientX = moveEvent.touches[0].clientX;
        moveClientY = moveEvent.touches[0].clientY;
      } else {
        moveClientX = moveEvent.clientX;
        moveClientY = moveEvent.clientY;
      }
      const x = moveClientX - startX;
      const y = moveClientY - startY;
      draggedCopy.style.left = x + &#39;px&#39;;
      draggedCopy.style.top = y + &#39;px&#39;;
    }

    function stopDragging(upEvent) {
      document.removeEventListener(&#39;mousemove&#39;, moveItem);
      document.removeEventListener(&#39;mouseup&#39;, stopDragging);
      document.removeEventListener(&#39;touchmove&#39;, moveItem);
      document.removeEventListener(&#39;touchend&#39;, stopDragging);
      
      if (draggedCopy &amp;&amp; draggedCopy.parentElement) {
        document.body.removeChild(draggedCopy);
      }
      draggable.style.visibility = &#39;visible&#39;;

      const moneyValue = parseInt(draggable.getAttribute(&#39;data-money&#39;)) || 0;
      if (moneyValue &gt; 0) {
        let currentMoney = parseInt(localStorage.getItem(&#39;playerMoney&#39;)) || 0;
        let newTotal = currentMoney + moneyValue;
        localStorage.setItem(&#39;playerMoney&#39;, newTotal);
        $money += newTotal;
        alert(&quot;The money has been added to your purse.&quot;);
        if (window.sfxEnabled) {
          let moneySound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/argent.wav&quot;);
          moneySound.volume = window.sfxVolume;
          moneySound.play();
        }
        draggable.remove();
        synchronizeInventories();
        return;
      }
      let endClientX, endClientY;
      if (upEvent.type === &#39;touchend&#39; &amp;&amp; upEvent.changedTouches &amp;&amp; upEvent.changedTouches.length &gt; 0) {
        endClientX = upEvent.changedTouches[0].clientX;
        endClientY = upEvent.changedTouches[0].clientY;
      } else if (upEvent.clientX &amp;&amp; upEvent.clientY) {
        endClientX = upEvent.clientX;
        endClientY = upEvent.clientY;
      } else {
        endClientX = 0;
        endClientY = 0;
      }

      // Recherche du conteneur cible de dépôt
      const dropTarget = document.elementFromPoint(endClientX, endClientY);
      const container = dropTarget ? dropTarget.closest(&#39;.iconArmors, .slotChest, .slotPlayerChest&#39;) : null;

      if (container) {
        if (container.classList.contains(&#39;iconArmors&#39;)) {
          const slotType = container.getAttribute(&#39;data-type&#39;);
          const itemType = draggable.getAttribute(&#39;data-type&#39;);
          
          if (slotType !== itemType) {
            originalParent.appendChild(draggable);
            return synchronizeInventories();
          }

          const existingItem = container.querySelector(&#39;.item-img&#39;);
          if (existingItem) {
            originalParent.appendChild(existingItem);
          }
          container.appendChild(draggable);
        } else {
          const invExisting = container.querySelector(&#39;.item-img&#39;);
          if (invExisting &amp;&amp; invExisting !== draggable) {
            originalParent.appendChild(invExisting);
          }
          if (window.sfxEnabled) {
            let possessionSound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/possageobjet.wav&quot;);
            possessionSound.volume = window.sfxVolume;
            possessionSound.play();
          }
          container.appendChild(draggable);
        }
      } else {
        const playerSlots = document.querySelectorAll(&#39;#chestInventory .slotPlayerChest&#39;);
        let emptySlot = null;
        for (const slot of playerSlots) {
          if (!slot.querySelector(&#39;.item-img&#39;)) {
            emptySlot = slot;
            break;
          }
        }
        if (emptySlot) {
          emptySlot.appendChild(draggable);
        } else {
          originalParent.appendChild(draggable);
        }
      }
      synchronizeInventories();
    }

    document.addEventListener(&#39;mousemove&#39;, moveItem);
    document.addEventListener(&#39;mouseup&#39;, stopDragging);
    document.addEventListener(&#39;touchmove&#39;, moveItem, { passive: false });
    document.addEventListener(&#39;touchend&#39;, stopDragging, { passive: false });
  };

  /* ---------------------------
     Gestion du Toggle entre inventaire et équipements
     --------------------------- */
  const toggleBtn = document.getElementById(&#39;toggleView&#39;);
  const inventoryView = document.getElementById(&#39;inventoryView&#39;);
  const equipmentView = document.getElementById(&#39;equipmentView&#39;);

  toggleBtn.addEventListener(&#39;click&#39;, () =&gt; {
    inventoryView.classList.toggle(&#39;active&#39;);
    equipmentView.classList.toggle(&#39;active&#39;);
    toggleBtn.classList.toggle(&#39;active&#39;);
    
    if (equipmentView.classList.contains(&#39;active&#39;)) {
      synchronizeEquipments();
    }
  });

  /* ---------------------------
     Synchronisation des équipements pour le header
     --------------------------- */
  function synchronizeEquipments() {
    const equipSlots = document.querySelectorAll(&#39;#equipmentView .iconArmors&#39;);
    equipSlots.forEach(slot =&gt; {
      const item = slot.querySelector(&#39;.item-img&#39;);
      if (item) {
        const decorative = slot.querySelector(&#39;.decorative-image&#39;);
        if (decorative) decorative.remove();
        item.removeEventListener(&#39;mousedown&#39;, startDragging);
        item.addEventListener(&#39;mousedown&#39;, startDragging);
        item.removeEventListener(&#39;touchstart&#39;, startDragging);
        item.addEventListener(&#39;touchstart&#39;, startDragging);
      } else {
        const decorative = slot.querySelector(&#39;.decorative-image&#39;);
        if (decorative) decorative.style.display = &#39;block&#39;;
      }
    });
    setTimeout(saveEquipmentState, 100);
  }

  /* ---------------------------
     Affichage de l&#39;infobulle (tooltip) pour équipements
     --------------------------- */
  function showTooltipEquipements(event, itemElement) {
    const existing = document.querySelector(&#39;.tooltip&#39;);
    if (existing) existing.remove();
    if (itemElement.classList.contains(&#39;iconArmors&#39;)) {
      itemElement = itemElement.querySelector(&#39;.item-img&#39;);
    }
    if (!itemElement) return;
    const tooltip = document.createElement(&#39;div&#39;);
    tooltip.className = &#39;tooltip&#39;;
    tooltip.style.position = &#39;absolute&#39;;
    tooltip.style.backgroundColor = &#39;rgba(0,0,0,0.8)&#39;;
    tooltip.style.color = &#39;#fff&#39;;
    tooltip.style.padding = &#39;8px&#39;;
    tooltip.style.borderRadius = &#39;5px&#39;;
    tooltip.style.fontSize = &#39;12px&#39;;
    tooltip.style.zIndex = &#39;1000&#39;;
    tooltip.style.display = &#39;none&#39;;
    let content = &#39;&#39;;
    function addAttr(label, attr) {
      const val = itemElement.getAttribute(attr);
      if (val &amp;&amp; val.trim() !== &#39;&#39; &amp;&amp; val.toLowerCase() !== &#39;null&#39;) {
        content += `&lt;strong&gt;${label}:&lt;/strong&gt; ${val}&lt;br&gt;`;
      }
    }
    addAttr(&#39;Nom&#39;, &#39;data-nom&#39;);
    addAttr(&#39;Type&#39;, &#39;data-type&#39;);
    addAttr(&#39;Strength&#39;, &#39;data-strength&#39;);
    addAttr(&#39;Durability&#39;, &#39;data-durability&#39;);
    addAttr(&#39;Life&#39;, &#39;data-life&#39;);
    addAttr(&#39;Armor&#39;, &#39;data-armor&#39;);
    addAttr(&#39;Prix&#39;, &#39;data-prix&#39;);
    addAttr(&#39;Rare&#39;, &#39;data-rare&#39;);
    addAttr(&#39;Money&#39;, &#39;data-money&#39;);

    if (!content) return;
    tooltip.innerHTML = content;
    tooltip.style.display = &#39;block&#39;;
    tooltip.style.left = (event.clientX + 10) + &#39;px&#39;;
    tooltip.style.top = (event.clientY + 10) + &#39;px&#39;;
    document.body.appendChild(tooltip);
    function onMouseMove(e) {
      tooltip.style.left = (e.clientX + 10) + &#39;px&#39;;
      tooltip.style.top = (e.clientY + 10) + &#39;px&#39;;
    }
    document.addEventListener(&#39;mousemove&#39;, onMouseMove);
    itemElement.addEventListener(&#39;mouseleave&#39;, function() {
      tooltip.remove();
      document.removeEventListener(&#39;mousemove&#39;, onMouseMove);
    }, { once: true });
  }

  /* ---------------------------
     Attachement des tooltips pour équipements
     --------------------------- */
  function attachTooltipEquipements() {
    document.querySelectorAll(&#39;#chestEquipmentMirror .item-img&#39;).forEach(item =&gt; {
      item.removeEventListener(&#39;mouseenter&#39;, tooltipEquipListener);
      item.addEventListener(&#39;mouseenter&#39;, tooltipEquipListener);
    });
  }
  function tooltipEquipListener(e) {
    showTooltipEquipements(e, e.currentTarget);
  }
  
  /* ---------------------------
     Rendu des objets dans l&#39;inventaire (chestInventory)
     --------------------------- */
  function renderChestInventory(itemsArray) {
    const slots = document.querySelectorAll(&quot;.inventoryChest .slotChest&quot;);
    slots.forEach(slot =&gt; slot.innerHTML = &quot;&quot;);
    itemsArray.forEach(item =&gt; {
      if (item.inventorychest) {
        const slotIndex = parseInt(item.inventorychest) - 1;
        const slot = slots[slotIndex];
        if (slot) {
          const img = document.createElement(&quot;img&quot;);
          img.setAttribute(&quot;data-id&quot;, item.id);
          img.setAttribute(&quot;data-nom&quot;, item.nom);
          img.setAttribute(&quot;data-type&quot;, item.type);
          if (item.strength) img.setAttribute(&quot;data-strength&quot;, item.strength);
          if (item.durability) img.setAttribute(&quot;data-durability&quot;, item.durability);
          if (item.life) img.setAttribute(&quot;data-life&quot;, item.life);
          if (item.armor) img.setAttribute(&quot;data-armor&quot;, item.armor);
          if (item.prix) img.setAttribute(&quot;data-prix&quot;, item.prix);
          if (item.rare) img.setAttribute(&quot;data-rare&quot;, item.rare);
          if (item.money) img.setAttribute(&quot;data-money&quot;, item.money);
          img.src = item.src;
          img.className = item.class;
          img.draggable = item.draggable;
          img.id = item.id;
          img.addEventListener(&quot;mouseenter&quot;, event =&gt; showTooltip(event, img));
          slot.appendChild(img);
        }
      }
    });
  }

  /* ---------------------------
     Initialisation du Drag &amp; Drop pour l&#39;inventaire
     --------------------------- */
  function initDragAndDrop() {
    const draggables = document.querySelectorAll(&#39;.item-img&#39;);
    const containers = document.querySelectorAll(&#39;.slotChest, .slotPlayerChest&#39;);
    draggables.forEach(draggable =&gt; {
      draggable.addEventListener(&#39;dragstart&#39;, function(e) {
        draggable.classList.add(&#39;dragging&#39;);
        draggable.dataset.source = draggable.parentElement.id;
      });
      draggable.addEventListener(&#39;dragend&#39;, function(e) {
        draggable.classList.remove(&#39;dragging&#39;);
        delete draggable.dataset.source;
      });
    });
    containers.forEach(container =&gt; {
      container.addEventListener(&#39;dragover&#39;, function(e) {
        e.preventDefault();
      });
      container.addEventListener(&#39;drop&#39;, function(e) {
        e.preventDefault();
        const draggedItem = document.querySelector(&#39;.dragging&#39;);
        if (!draggedItem) return;
        const sourceContainer = document.getElementById(draggedItem.dataset.source);
        const targetContainer = container;
        const existing = targetContainer.querySelector(&#39;.item-img&#39;);
        if (existing &amp;&amp; existing !== draggedItem) {
          targetContainer.removeChild(existing);
          if (sourceContainer) {
            sourceContainer.appendChild(existing);
          }
        }
        targetContainer.appendChild(draggedItem);
        synchronizeInventories();
      });
    });
  }

  /* ---------------------------
     Synchronisation globale (inventaire et équipements)
     --------------------------- */
  function synchronizeInventories() {
    synchronizeEquipments();
    const chestSlots = document.querySelectorAll(&#39;.inventoryChest .slotChest&#39;);
    const savedItems = [];
    chestSlots.forEach((slot, index) =&gt; {
      const item = slot.querySelector(&#39;.item-img&#39;);
      if (item) {
        savedItems.push({
          id: item.id,
          nom: item.getAttribute(&#39;data-nom&#39;),
          type: item.getAttribute(&#39;data-type&#39;),
          strength: item.getAttribute(&#39;data-strength&#39;),
          durability: item.getAttribute(&#39;data-durability&#39;),
          life: item.getAttribute(&#39;data-life&#39;),
          armor: item.getAttribute(&#39;data-armor&#39;),
          prix: item.getAttribute(&#39;data-prix&#39;),
          rare: item.getAttribute(&#39;data-rare&#39;),
          money: item.getAttribute(&#39;data-money&#39;),
           src: item.src,
           class: item.className,
          inventorychest: slot.dataset.slot || (index + 1)
        });
      }
    });
    localStorage.setItem(&quot;chest_inventory_&quot; + chestId, JSON.stringify(savedItems));
  }

  /* ---------------------------
     Gestion de l&#39;état des équipements
     --------------------------- */
  function saveEquipmentState() {
    const slots = document.querySelectorAll(&#39;#chestEquipmentMirror .iconArmors&#39;);
    const data = [];
    slots.forEach(slot =&gt; {
      const item = slot.querySelector(&#39;.item-img&#39;);
      if (item) {
        data.push({
          type: item.getAttribute(&#39;data-type&#39;),
          src: item.src,
          id: item.getAttribute(&#39;data-id&#39;),
          nom: item.getAttribute(&#39;data-nom&#39;),
          strength: item.getAttribute(&#39;data-strength&#39;),
          durability: item.getAttribute(&#39;data-durability&#39;),
          life: item.getAttribute(&#39;data-life&#39;),
          armor: item.getAttribute(&#39;data-armor&#39;),
          prix: item.getAttribute(&#39;data-prix&#39;),
          rare: item.getAttribute(&#39;data-rare&#39;),
          money: item.getAttribute(&#39;data-money&#39;),
        });
      } else {
        data.push(null);
      }
    });
    localStorage.setItem(&#39;specialArmorInventory&#39;, JSON.stringify(data));
  }
  
  const chestEquipContainer = document.getElementById(&#39;chestEquipmentMirror&#39;);
  if (chestEquipContainer) {
    const chestObserver = new MutationObserver(() =&gt; {
      saveEquipmentState();
      synchronizeEquipments();
    });
    chestObserver.observe(chestEquipContainer, { 
      childList: true, 
      subtree: true,
      attributes: true,
      attributeFilter: [&#39;data-type&#39;, &#39;data-strength&#39;, &#39;data-durability&#39;] 
    });
  }

  function createItem(type, src, id, nom, strength, durability, life, armor, prix, rare, money) {
    const img = document.createElement(&#39;img&#39;);
    img.setAttribute(&quot;data-id&quot;, id);
    img.setAttribute(&quot;data-nom&quot;, nom);
    img.setAttribute(&quot;data-type&quot;, type);
    if (strength) img.setAttribute(&quot;data-strength&quot;, strength);
    if (durability) img.setAttribute(&quot;data-durability&quot;, durability);
    if (life) img.setAttribute(&quot;data-life&quot;, life);
    if (armor) img.setAttribute(&quot;data-armor&quot;, armor);
    if (prix) img.setAttribute(&quot;data-prix&quot;, prix);
    if (rare) img.setAttribute(&quot;data-rare&quot;, rare);
    if (money) img.setAttribute(&quot;data-money&quot;, money);
    img.src = src;
    img.className = &quot;item-img&quot;;
    img.draggable = true;
    img.addEventListener(&#39;dragstart&#39;, () =&gt; img.classList.add(&#39;dragging&#39;));
    img.addEventListener(&#39;dragend&#39;, () =&gt; img.classList.remove(&#39;dragging&#39;));
    img.addEventListener(&#39;mousedown&#39;, startDragging);
    return img;
  }

  function loadEquipmentState() {
    const data = JSON.parse(localStorage.getItem(&#39;specialArmorInventory&#39;));
    if (!data) return;
    const slots = document.querySelectorAll(&#39;#chestEquipmentMirror .iconArmors&#39;);
    data.forEach((d, i) =&gt; {
      if (d &amp;&amp; slots[i]) {
        slots[i].innerHTML = &#39;&#39;;
        const newItem = createItem(d.type, d.src, d.id, d.nom, d.strength, d.durability, d.life, d.armor, d.prix, d.rare);
        slots[i].appendChild(newItem);
        reattachDragAndDrop();
        attachTooltipEquipements();
      }
    });
  }

  /* ---------------------------
     Drag &amp; Drop pour équipements
     --------------------------- */
  function setupEquipmentDragAndDrop() {
    const equipmentSlots = document.querySelectorAll(&#39;.special-armors .iconArmors&#39;);
    equipmentSlots.forEach(slot =&gt; {
      slot.addEventListener(&#39;dragover&#39;, function(e) {
        e.preventDefault();
      });
      slot.addEventListener(&#39;drop&#39;, function(e) {
        e.preventDefault();
        const draggedItem = document.querySelector(&#39;.dragging&#39;);
        if (draggedItem) {
          const slotType = slot.getAttribute(&#39;data-type&#39;);
          const itemType = draggedItem.getAttribute(&#39;data-type&#39;);
          if (slotType !== itemType) {
            const source = document.getElementById(draggedItem.dataset.source);
            if (source) source.appendChild(draggedItem);
            return;
          }
          if (draggedItem.parentElement) {
            draggedItem.parentElement.removeChild(draggedItem);
          }
          slot.innerHTML = &#39;&#39;;
          slot.appendChild(draggedItem);
          setTimeout(synchronizeEquipments, 100);
        } else {
          const decorative = slot.querySelector(&#39;.decorative-image&#39;);
          if (!slot.querySelector(&#39;.item-img&#39;) &amp;&amp; decorative) {
            decorative.style.display = &#39;block&#39;;
          }
        }
      });
    });
  }

  /* ---------------------------
     Outil pour attacher les tooltips
     --------------------------- */
  function attachTooltip(selector) {
    document.querySelectorAll(selector).forEach(elem =&gt; {
      const target = elem.hasAttribute(&#39;data-type&#39;) ? elem : (elem.querySelector(&#39;img&#39;) || elem);
      target.addEventListener(&#39;mouseenter&#39;, event =&gt; showTooltip(event, target));
    });
  }

  // Initialisations principales
  loadEquipmentState();
  setupEquipmentDragAndDrop();
  initDragAndDrop();
  attachTooltip(&#39;.slotChest&#39;);
  attachTooltip(&#39;.iconArmors&#39;);

  const toggleEquipBtn = document.getElementById(&quot;toggle-equipement&quot;);
  if (toggleEquipBtn) {
    toggleEquipBtn.remove();
  }

  // Suppression d&#39;éléments inutiles pour l&#39;inventaire du coffre
  const chestContainer = document.querySelector(&quot;.chest&quot;);
  if (chestContainer) {
    const iconArmorsWithoutDataType = document.querySelectorAll(&quot;.iconArmors:not([data-type])&quot;);
    if (iconArmorsWithoutDataType.length &gt; 0) {
      iconArmorsWithoutDataType[iconArmorsWithoutDataType.length - 1].remove();
    }
  }
&lt;/script&gt;</tw-passagedata><tw-passagedata pid="569" name="Coffre3" tags="" position="1225,375" size="100,100">{ &lt;style&gt;.money{display:none;}&lt;/style&gt;
&lt;div class=&quot;chest&quot;&gt;
    &lt;!-- Bouton de switch avec icônes --&gt;
    &lt;button id=&quot;toggleView&quot; class=&quot;toggle-view-btn&quot;&gt;
        &lt;span class=&quot;inventory-icon&quot;&gt;📦&lt;/span&gt;
        &lt;span class=&quot;equipment-icon&quot;&gt;🛡️&lt;/span&gt;
        &lt;div class=&quot;toggle-slider&quot;&gt;&lt;/div&gt;
    &lt;/button&gt;
    
    &lt;div class=&quot;chest-content&quot;&gt;
        &lt;div class=&quot;inventoryChest&quot; id=&quot;chest1&quot;&gt;
            &lt;!-- 27 emplacements d&#39;inventaire --&gt;
        &lt;/div&gt;

        &lt;div class=&quot;inventoryPlayerChest&quot; id=&quot;chestInventory&quot;&gt;
            &lt;!-- 27 emplacements d&#39;inventaire --&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;!-- Vue Inventaire --&gt;
    &lt;div class=&quot;chest-view active&quot; id=&quot;inventoryView&quot;&gt;
       
    &lt;/div&gt;

&lt;div class=&quot;chest-view&quot; id=&quot;equipmentView&quot;&gt;
  &lt;div class=&quot;special-armorsCoffre&quot;&gt;
    &lt;div class=&quot;blockEquipements&quot; id=&quot;chestEquipmentMirror&quot;&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
}

[[Get what you need, than get the hell out of here !-&gt;Admin]]

&lt;script&gt;
  const chestId = &quot;coffre3&quot;;

  // Liste d&#39;objets par défaut (votre code de base)
  const itemsDefault = [
    { id: &quot;soin2&quot;, nom: &quot;Healing Potion&quot;, type: &quot;soin&quot;, life: 15, class: &quot;item-img&quot;, draggable: true, inventorychest: &quot;3&quot;, src: &quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Medkit.png&quot;, prix: 35, rare: &quot;Common&quot;  },
  ];

  // Vérifie si le coffre a déjà été initialisé
  const hasOpened = localStorage.getItem(&quot;chest_opened_&quot; + chestId);
  
  if (!hasOpened) {
    // Première arrivée : on charge les objets par défaut et on les sauvegarde
    renderChestInventory(itemsDefault);
    localStorage.setItem(&quot;chest_inventory_&quot; + chestId, JSON.stringify(itemsDefault));
    localStorage.setItem(&quot;chest_opened_&quot; + chestId, &quot;true&quot;);
    console.log(&quot;✨ Coffre rempli pour la première fois&quot;);
  } else {
    // On récupère les données sauvegardées
    const savedItems = localStorage.getItem(&quot;chest_inventory_&quot; + chestId);
    if (savedItems) {
      const itemsSaved = JSON.parse(savedItems);
      renderChestInventory(itemsSaved);
    }
    console.log(&quot;🚫 Coffre déjà ouvert, état récupéré&quot;);
  }
    
  function mirrorEquipment() {
    const headerEquip = document.querySelector(&#39;.inventaireBas .blockEquipements&#39;);
    const chestMirror = document.getElementById(&#39;chestEquipmentMirror&#39;);
    if (headerEquip &amp;&amp; chestMirror) {
      chestMirror.innerHTML = headerEquip.innerHTML;
      reattachDragAndDrop();
      saveEquipmentState(); 
      attachTooltipEquipements();
    }
  }

  const headerEquipContainer = document.querySelector(&#39;.inventaireBas .blockEquipements&#39;);
  if (headerEquipContainer) {
    const observer = new MutationObserver(mirrorEquipment);
    observer.observe(headerEquipContainer, { childList: true, subtree: true });
  }

  function reattachDragAndDrop() {
    document.querySelectorAll(&#39;.iconArmors .item-img, .inventoryPlayerChest .item-img, .blockEquipements .item-img, .inventoryChest .item-img&#39;)
      .forEach(item =&gt; {
        item.removeEventListener(&#39;mousedown&#39;, startDragging);
        item.removeEventListener(&#39;touchstart&#39;, startDragging);
        item.addEventListener(&#39;mousedown&#39;, startDragging);
        item.addEventListener(&#39;touchstart&#39;, startDragging, { passive: false });
      });
  }

  /* ---------------------------
     Drag &amp; Drop personnalisé pour les équipements
     --------------------------- */
  window.startDragging = function(e) {
    e.preventDefault();
    const draggable = this;
    const rect = draggable.getBoundingClientRect();
  
    let clientX, clientY;
    if (e.touches) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    const startX = clientX - rect.left;
    const startY = clientY - rect.top;
    const originalParent = draggable.parentElement; 

    const draggedCopy = draggable.cloneNode(true);
    draggedCopy.style.position = &#39;fixed&#39;;
    draggedCopy.style.zIndex = &#39;1000&#39;;
    draggedCopy.style.pointerEvents = &#39;none&#39;;
    draggedCopy.style.width = rect.width + &#39;px&#39;;
    draggedCopy.style.height = rect.height + &#39;px&#39;;
    document.body.appendChild(draggedCopy);

    draggable.style.visibility = &#39;hidden&#39;;

    function moveItem(moveEvent) {
      let moveClientX, moveClientY;
      if (moveEvent.type === &#39;touchmove&#39;) {
        moveClientX = moveEvent.touches[0].clientX;
        moveClientY = moveEvent.touches[0].clientY;
      } else {
        moveClientX = moveEvent.clientX;
        moveClientY = moveEvent.clientY;
      }
      const x = moveClientX - startX;
      const y = moveClientY - startY;
      draggedCopy.style.left = x + &#39;px&#39;;
      draggedCopy.style.top = y + &#39;px&#39;;
    }

    function stopDragging(upEvent) {
      document.removeEventListener(&#39;mousemove&#39;, moveItem);
      document.removeEventListener(&#39;mouseup&#39;, stopDragging);
      document.removeEventListener(&#39;touchmove&#39;, moveItem);
      document.removeEventListener(&#39;touchend&#39;, stopDragging);
      
      if (draggedCopy &amp;&amp; draggedCopy.parentElement) {
        document.body.removeChild(draggedCopy);
      }
      draggable.style.visibility = &#39;visible&#39;;

      const moneyValue = parseInt(draggable.getAttribute(&#39;data-money&#39;)) || 0;
      if (moneyValue &gt; 0) {
        let currentMoney = parseInt(localStorage.getItem(&#39;playerMoney&#39;)) || 0;
        let newTotal = currentMoney + moneyValue;
        localStorage.setItem(&#39;playerMoney&#39;, newTotal);
        $money += newTotal;
        alert(&quot;The money has been added to your purse.&quot;);
        if (window.sfxEnabled) {
          let moneySound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/argent.wav&quot;);
          moneySound.volume = window.sfxVolume;
          moneySound.play();
        }
        draggable.remove();
        synchronizeInventories();
        return;
      }
      let endClientX, endClientY;
      if (upEvent.type === &#39;touchend&#39; &amp;&amp; upEvent.changedTouches &amp;&amp; upEvent.changedTouches.length &gt; 0) {
        endClientX = upEvent.changedTouches[0].clientX;
        endClientY = upEvent.changedTouches[0].clientY;
      } else if (upEvent.clientX &amp;&amp; upEvent.clientY) {
        endClientX = upEvent.clientX;
        endClientY = upEvent.clientY;
      } else {
        endClientX = 0;
        endClientY = 0;
      }

      // Recherche du conteneur cible de dépôt
      const dropTarget = document.elementFromPoint(endClientX, endClientY);
      const container = dropTarget ? dropTarget.closest(&#39;.iconArmors, .slotChest, .slotPlayerChest&#39;) : null;

      if (container) {
        if (container.classList.contains(&#39;iconArmors&#39;)) {
          const slotType = container.getAttribute(&#39;data-type&#39;);
          const itemType = draggable.getAttribute(&#39;data-type&#39;);
          
          if (slotType !== itemType) {
            originalParent.appendChild(draggable);
            return synchronizeInventories();
          }

          const existingItem = container.querySelector(&#39;.item-img&#39;);
          if (existingItem) {
            originalParent.appendChild(existingItem);
          }
          container.appendChild(draggable);
        } else {
          const invExisting = container.querySelector(&#39;.item-img&#39;);
          if (invExisting &amp;&amp; invExisting !== draggable) {
            originalParent.appendChild(invExisting);
          }
          if (window.sfxEnabled) {
            let possessionSound = new Audio(&quot;https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/possageobjet.wav&quot;);
            possessionSound.volume = window.sfxVolume;
            possessionSound.play();
          }
          container.appendChild(draggable);
        }
      } else {
        const playerSlots = document.querySelectorAll(&#39;#chestInventory .slotPlayerChest&#39;);
        let emptySlot = null;
        for (const slot of playerSlots) {
          if (!slot.querySelector(&#39;.item-img&#39;)) {
            emptySlot = slot;
            break;
          }
        }
        if (emptySlot) {
          emptySlot.appendChild(draggable);
        } else {
          originalParent.appendChild(draggable);
        }
      }
      synchronizeInventories();
    }

    document.addEventListener(&#39;mousemove&#39;, moveItem);
    document.addEventListener(&#39;mouseup&#39;, stopDragging);
    document.addEventListener(&#39;touchmove&#39;, moveItem, { passive: false });
    document.addEventListener(&#39;touchend&#39;, stopDragging, { passive: false });
  };

  /* ---------------------------
     Gestion du Toggle entre inventaire et équipements
     --------------------------- */
  const toggleBtn = document.getElementById(&#39;toggleView&#39;);
  const inventoryView = document.getElementById(&#39;inventoryView&#39;);
  const equipmentView = document.getElementById(&#39;equipmentView&#39;);

  toggleBtn.addEventListener(&#39;click&#39;, () =&gt; {
    inventoryView.classList.toggle(&#39;active&#39;);
    equipmentView.classList.toggle(&#39;active&#39;);
    toggleBtn.classList.toggle(&#39;active&#39;);
    
    if (equipmentView.classList.contains(&#39;active&#39;)) {
      synchronizeEquipments();
    }
  });

  /* ---------------------------
     Synchronisation des équipements pour le header
     --------------------------- */
  function synchronizeEquipments() {
    const equipSlots = document.querySelectorAll(&#39;#equipmentView .iconArmors&#39;);
    equipSlots.forEach(slot =&gt; {
      const item = slot.querySelector(&#39;.item-img&#39;);
      if (item) {
        const decorative = slot.querySelector(&#39;.decorative-image&#39;);
        if (decorative) decorative.remove();
        item.removeEventListener(&#39;mousedown&#39;, startDragging);
        item.addEventListener(&#39;mousedown&#39;, startDragging);
        item.removeEventListener(&#39;touchstart&#39;, startDragging);
        item.addEventListener(&#39;touchstart&#39;, startDragging);
      } else {
        const decorative = slot.querySelector(&#39;.decorative-image&#39;);
        if (decorative) decorative.style.display = &#39;block&#39;;
      }
    });
    setTimeout(saveEquipmentState, 100);
  }

  /* ---------------------------
     Affichage de l&#39;infobulle (tooltip) pour équipements
     --------------------------- */
  function showTooltipEquipements(event, itemElement) {
    const existing = document.querySelector(&#39;.tooltip&#39;);
    if (existing) existing.remove();
    if (itemElement.classList.contains(&#39;iconArmors&#39;)) {
      itemElement = itemElement.querySelector(&#39;.item-img&#39;);
    }
    if (!itemElement) return;
    const tooltip = document.createElement(&#39;div&#39;);
    tooltip.className = &#39;tooltip&#39;;
    tooltip.style.position = &#39;absolute&#39;;
    tooltip.style.backgroundColor = &#39;rgba(0,0,0,0.8)&#39;;
    tooltip.style.color = &#39;#fff&#39;;
    tooltip.style.padding = &#39;8px&#39;;
    tooltip.style.borderRadius = &#39;5px&#39;;
    tooltip.style.fontSize = &#39;12px&#39;;
    tooltip.style.zIndex = &#39;1000&#39;;
    tooltip.style.display = &#39;none&#39;;
    let content = &#39;&#39;;
    function addAttr(label, attr) {
      const val = itemElement.getAttribute(attr);
      if (val &amp;&amp; val.trim() !== &#39;&#39; &amp;&amp; val.toLowerCase() !== &#39;null&#39;) {
        content += `&lt;strong&gt;${label}:&lt;/strong&gt; ${val}&lt;br&gt;`;
      }
    }
    addAttr(&#39;Nom&#39;, &#39;data-nom&#39;);
    addAttr(&#39;Type&#39;, &#39;data-type&#39;);
    addAttr(&#39;Strength&#39;, &#39;data-strength&#39;);
    addAttr(&#39;Durability&#39;, &#39;data-durability&#39;);
    addAttr(&#39;Life&#39;, &#39;data-life&#39;);
    addAttr(&#39;Armor&#39;, &#39;data-armor&#39;);
    addAttr(&#39;Prix&#39;, &#39;data-prix&#39;);
    addAttr(&#39;Rare&#39;, &#39;data-rare&#39;);
    addAttr(&#39;Money&#39;, &#39;data-money&#39;);

    if (!content) return;
    tooltip.innerHTML = content;
    tooltip.style.display = &#39;block&#39;;
    tooltip.style.left = (event.clientX + 10) + &#39;px&#39;;
    tooltip.style.top = (event.clientY + 10) + &#39;px&#39;;
    document.body.appendChild(tooltip);
    function onMouseMove(e) {
      tooltip.style.left = (e.clientX + 10) + &#39;px&#39;;
      tooltip.style.top = (e.clientY + 10) + &#39;px&#39;;
    }
    document.addEventListener(&#39;mousemove&#39;, onMouseMove);
    itemElement.addEventListener(&#39;mouseleave&#39;, function() {
      tooltip.remove();
      document.removeEventListener(&#39;mousemove&#39;, onMouseMove);
    }, { once: true });
  }

  /* ---------------------------
     Attachement des tooltips pour équipements
     --------------------------- */
  function attachTooltipEquipements() {
    document.querySelectorAll(&#39;#chestEquipmentMirror .item-img&#39;).forEach(item =&gt; {
      item.removeEventListener(&#39;mouseenter&#39;, tooltipEquipListener);
      item.addEventListener(&#39;mouseenter&#39;, tooltipEquipListener);
    });
  }
  function tooltipEquipListener(e) {
    showTooltipEquipements(e, e.currentTarget);
  }
  
  /* ---------------------------
     Rendu des objets dans l&#39;inventaire (chestInventory)
     --------------------------- */
  function renderChestInventory(itemsArray) {
    const slots = document.querySelectorAll(&quot;.inventoryChest .slotChest&quot;);
    slots.forEach(slot =&gt; slot.innerHTML = &quot;&quot;);
    itemsArray.forEach(item =&gt; {
      if (item.inventorychest) {
        const slotIndex = parseInt(item.inventorychest) - 1;
        const slot = slots[slotIndex];
        if (slot) {
          const img = document.createElement(&quot;img&quot;);
          img.setAttribute(&quot;data-id&quot;, item.id);
          img.setAttribute(&quot;data-nom&quot;, item.nom);
          img.setAttribute(&quot;data-type&quot;, item.type);
          if (item.strength) img.setAttribute(&quot;data-strength&quot;, item.strength);
          if (item.durability) img.setAttribute(&quot;data-durability&quot;, item.durability);
          if (item.life) img.setAttribute(&quot;data-life&quot;, item.life);
          if (item.armor) img.setAttribute(&quot;data-armor&quot;, item.armor);
          if (item.prix) img.setAttribute(&quot;data-prix&quot;, item.prix);
          if (item.rare) img.setAttribute(&quot;data-rare&quot;, item.rare);
          if (item.money) img.setAttribute(&quot;data-money&quot;, item.money);
          img.src = item.src;
          img.className = item.class;
          img.draggable = item.draggable;
          img.id = item.id;
          img.addEventListener(&quot;mouseenter&quot;, event =&gt; showTooltip(event, img));
          slot.appendChild(img);
        }
      }
    });
  }

  /* ---------------------------
     Initialisation du Drag &amp; Drop pour l&#39;inventaire
     --------------------------- */
  function initDragAndDrop() {
    const draggables = document.querySelectorAll(&#39;.item-img&#39;);
    const containers = document.querySelectorAll(&#39;.slotChest, .slotPlayerChest&#39;);
    draggables.forEach(draggable =&gt; {
      draggable.addEventListener(&#39;dragstart&#39;, function(e) {
        draggable.classList.add(&#39;dragging&#39;);
        draggable.dataset.source = draggable.parentElement.id;
      });
      draggable.addEventListener(&#39;dragend&#39;, function(e) {
        draggable.classList.remove(&#39;dragging&#39;);
        delete draggable.dataset.source;
      });
    });
    containers.forEach(container =&gt; {
      container.addEventListener(&#39;dragover&#39;, function(e) {
        e.preventDefault();
      });
      container.addEventListener(&#39;drop&#39;, function(e) {
        e.preventDefault();
        const draggedItem = document.querySelector(&#39;.dragging&#39;);
        if (!draggedItem) return;
        const sourceContainer = document.getElementById(draggedItem.dataset.source);
        const targetContainer = container;
        const existing = targetContainer.querySelector(&#39;.item-img&#39;);
        if (existing &amp;&amp; existing !== draggedItem) {
          targetContainer.removeChild(existing);
          if (sourceContainer) {
            sourceContainer.appendChild(existing);
          }
        }
        targetContainer.appendChild(draggedItem);
        synchronizeInventories();
      });
    });
  }

  /* ---------------------------
     Synchronisation globale (inventaire et équipements)
     --------------------------- */
  function synchronizeInventories() {
    synchronizeEquipments();
    const chestSlots = document.querySelectorAll(&#39;.inventoryChest .slotChest&#39;);
    const savedItems = [];
    chestSlots.forEach((slot, index) =&gt; {
      const item = slot.querySelector(&#39;.item-img&#39;);
      if (item) {
        savedItems.push({
          id: item.id,
          nom: item.getAttribute(&#39;data-nom&#39;),
          type: item.getAttribute(&#39;data-type&#39;),
          strength: item.getAttribute(&#39;data-strength&#39;),
          durability: item.getAttribute(&#39;data-durability&#39;),
          life: item.getAttribute(&#39;data-life&#39;),
          armor: item.getAttribute(&#39;data-armor&#39;),
          prix: item.getAttribute(&#39;data-prix&#39;),
          rare: item.getAttribute(&#39;data-rare&#39;),
          money: item.getAttribute(&#39;data-money&#39;),
           src: item.src,
           class: item.className,
          inventorychest: slot.dataset.slot || (index + 1)
        });
      }
    });
    localStorage.setItem(&quot;chest_inventory_&quot; + chestId, JSON.stringify(savedItems));
  }

  /* ---------------------------
     Gestion de l&#39;état des équipements
     --------------------------- */
  function saveEquipmentState() {
    const slots = document.querySelectorAll(&#39;#chestEquipmentMirror .iconArmors&#39;);
    const data = [];
    slots.forEach(slot =&gt; {
      const item = slot.querySelector(&#39;.item-img&#39;);
      if (item) {
        data.push({
          type: item.getAttribute(&#39;data-type&#39;),
          src: item.src,
          id: item.getAttribute(&#39;data-id&#39;),
          nom: item.getAttribute(&#39;data-nom&#39;),
          strength: item.getAttribute(&#39;data-strength&#39;),
          durability: item.getAttribute(&#39;data-durability&#39;),
          life: item.getAttribute(&#39;data-life&#39;),
          armor: item.getAttribute(&#39;data-armor&#39;),
          prix: item.getAttribute(&#39;data-prix&#39;),
          rare: item.getAttribute(&#39;data-rare&#39;),
          money: item.getAttribute(&#39;data-money&#39;),
        });
      } else {
        data.push(null);
      }
    });
    localStorage.setItem(&#39;specialArmorInventory&#39;, JSON.stringify(data));
  }
  
  const chestEquipContainer = document.getElementById(&#39;chestEquipmentMirror&#39;);
  if (chestEquipContainer) {
    const chestObserver = new MutationObserver(() =&gt; {
      saveEquipmentState();
      synchronizeEquipments();
    });
    chestObserver.observe(chestEquipContainer, { 
      childList: true, 
      subtree: true,
      attributes: true,
      attributeFilter: [&#39;data-type&#39;, &#39;data-strength&#39;, &#39;data-durability&#39;] 
    });
  }

  function createItem(type, src, id, nom, strength, durability, life, armor, prix, rare, money) {
    const img = document.createElement(&#39;img&#39;);
    img.setAttribute(&quot;data-id&quot;, id);
    img.setAttribute(&quot;data-nom&quot;, nom);
    img.setAttribute(&quot;data-type&quot;, type);
    if (strength) img.setAttribute(&quot;data-strength&quot;, strength);
    if (durability) img.setAttribute(&quot;data-durability&quot;, durability);
    if (life) img.setAttribute(&quot;data-life&quot;, life);
    if (armor) img.setAttribute(&quot;data-armor&quot;, armor);
    if (prix) img.setAttribute(&quot;data-prix&quot;, prix);
    if (rare) img.setAttribute(&quot;data-rare&quot;, rare);
    if (money) img.setAttribute(&quot;data-money&quot;, money);
    img.src = src;
    img.className = &quot;item-img&quot;;
    img.draggable = true;
    img.addEventListener(&#39;dragstart&#39;, () =&gt; img.classList.add(&#39;dragging&#39;));
    img.addEventListener(&#39;dragend&#39;, () =&gt; img.classList.remove(&#39;dragging&#39;));
    img.addEventListener(&#39;mousedown&#39;, startDragging);
    return img;
  }

  function loadEquipmentState() {
    const data = JSON.parse(localStorage.getItem(&#39;specialArmorInventory&#39;));
    if (!data) return;
    const slots = document.querySelectorAll(&#39;#chestEquipmentMirror .iconArmors&#39;);
    data.forEach((d, i) =&gt; {
      if (d &amp;&amp; slots[i]) {
        slots[i].innerHTML = &#39;&#39;;
        const newItem = createItem(d.type, d.src, d.id, d.nom, d.strength, d.durability, d.life, d.armor, d.prix, d.rare);
        slots[i].appendChild(newItem);
        reattachDragAndDrop();
        attachTooltipEquipements();
      }
    });
  }

  /* ---------------------------
     Drag &amp; Drop pour équipements
     --------------------------- */
  function setupEquipmentDragAndDrop() {
    const equipmentSlots = document.querySelectorAll(&#39;.special-armors .iconArmors&#39;);
    equipmentSlots.forEach(slot =&gt; {
      slot.addEventListener(&#39;dragover&#39;, function(e) {
        e.preventDefault();
      });
      slot.addEventListener(&#39;drop&#39;, function(e) {
        e.preventDefault();
        const draggedItem = document.querySelector(&#39;.dragging&#39;);
        if (draggedItem) {
          const slotType = slot.getAttribute(&#39;data-type&#39;);
          const itemType = draggedItem.getAttribute(&#39;data-type&#39;);
          if (slotType !== itemType) {
            const source = document.getElementById(draggedItem.dataset.source);
            if (source) source.appendChild(draggedItem);
            return;
          }
          if (draggedItem.parentElement) {
            draggedItem.parentElement.removeChild(draggedItem);
          }
          slot.innerHTML = &#39;&#39;;
          slot.appendChild(draggedItem);
          setTimeout(synchronizeEquipments, 100);
        } else {
          const decorative = slot.querySelector(&#39;.decorative-image&#39;);
          if (!slot.querySelector(&#39;.item-img&#39;) &amp;&amp; decorative) {
            decorative.style.display = &#39;block&#39;;
          }
        }
      });
    });
  }

  /* ---------------------------
     Outil pour attacher les tooltips
     --------------------------- */
  function attachTooltip(selector) {
    document.querySelectorAll(selector).forEach(elem =&gt; {
      const target = elem.hasAttribute(&#39;data-type&#39;) ? elem : (elem.querySelector(&#39;img&#39;) || elem);
      target.addEventListener(&#39;mouseenter&#39;, event =&gt; showTooltip(event, target));
    });
  }

  // Initialisations principales
  loadEquipmentState();
  setupEquipmentDragAndDrop();
  initDragAndDrop();
  attachTooltip(&#39;.slotChest&#39;);
  attachTooltip(&#39;.iconArmors&#39;);

  const toggleEquipBtn = document.getElementById(&quot;toggle-equipement&quot;);
  if (toggleEquipBtn) {
    toggleEquipBtn.remove();
  }

  // Suppression d&#39;éléments inutiles pour l&#39;inventaire du coffre
  const chestContainer = document.querySelector(&quot;.chest&quot;);
  if (chestContainer) {
    const iconArmorsWithoutDataType = document.querySelectorAll(&quot;.iconArmors:not([data-type])&quot;);
    if (iconArmorsWithoutDataType.length &gt; 0) {
      iconArmorsWithoutDataType[iconArmorsWithoutDataType.length - 1].remove();
    }
  }
&lt;/script&gt;</tw-passagedata><tw-passagedata pid="570" name="MacroPassage" tags="" position="1575,650" size="100,100">$introText
(click:(str:$clickTest))[
(display:&quot;diceRollMacro&quot;)

 (live: 3s)[
    (stop:)
(if: $AttributeTest &gt;= $diceRoll)
    [$SuccessText
    {
    * [[(str:$LinkText)|(str:$Link)]]
    &lt;script&gt;

	setTimeout(() =&gt; {
 	 gainXp($xpSuccess);
	}, &quot;1000&quot;);
	&lt;/script&gt;
	}
    ]
(else:)
    [
    $FailureText
    (click:(str:$clickDamage))[
    (if:$damageType is 1)[(display:&quot;Roll1D&quot;)]
    (else:)[(display:&quot;Roll2D&quot;)]

 (live: 3s)[
    (stop:)
You lost (str:$diceRoll) health points
(set:$health to it - $diceRoll)
(if:$health&lt;=0)[
 $DeathText
(display:&quot;RestartDonnee&quot;)
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp($xpDeath);
}, &quot;1000&quot;);
&lt;/script&gt;
}
]
(else:)[
   * [[(str:$FailureLinkText)|(str:$Link)]]
{
&lt;script&gt;
setTimeout(() =&gt; {
  gainXp($xpFailure);
}, &quot;1000&quot;);
&lt;/script&gt;
}
 ]
 ]
 ]
]
 ]
 ]</tw-passagedata><tw-passagedata pid="571" name="(str:$Link)" tags="" position="1575,775" size="100,100"></tw-passagedata><tw-passagedata pid="572" name="StartGravebinder" tags="" position="3200,250" size="100,100">
(set: $job to 1)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**You:** “I’m a Gravebinder.”  
**Brannon:** “A Gravebinder, eh? Keepers of the dead and all that. Respectable trade.”  
He cracks a smile. “And I suppose you want me to dig you out, right?
**You:** “That would be lovely.”
**Brannon:** “Diggin’s on the house for one of you... if you help me find his body of course....”  
**You:** “Anything you want, just get me out of here!”
**You:** “No way!&quot;

(click:&quot;get me out of here!&quot;)[
You emerge from the coffin [[with difficulty|MainQuest]]
(replace:&quot;No way!&quot;)[no way.]
]
(click:&quot;No way!&quot;)[The man walk away, [[desapointed|GameOverStarve]].]
]

</tw-passagedata><tw-passagedata pid="573" name="Start Lantern Bearer" tags="" position="3125,575" size="100,100">(set: $job to 2)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**You:** “I’m a Lantern Bearer.”  
**Brannon:** He scratches his chin. “Lantern Bearers… light folkin’ in the dark. I’ll get you out: just toss me a silver shard for the candles, and I will need your help to find his body of course....”  
* [[If you pay 1 silver shard and accept to find the body foor him|PayForLight]]  
* [[If you refuse to pay or to help him|RefuseToPay2]]
]</tw-passagedata><tw-passagedata pid="574" name="Play Ossuary Knight" tags="" position="3125,725" size="100,100">(set: $job to 3)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**You:** “I’m an Ossuary Knight.”  
**Brannon:** “An Ossuary Knight, are ye? Heavy bones and all that. I don’t trust yer kind much…”  
He narrows his eyes. “That’ll be five silver shards: no exceptions... and I will need your help to find his body of course....”  
* [[Pay the five shards and agree to help him|PayKnightFee]]  
* [[Try to haggle|HaggleKnight]]
]</tw-passagedata><tw-passagedata pid="575" name="Start Whispered" tags="" position="3125,875" size="100,100">(set: $job to 4)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**You:** “I’m a Whispered.”  
**Brannon (from above):** “A Whispered, eh? Well I may need help of someone your kind to dig out the real Magister Corvan...
**You:** “Anything you want!”  
**Brannon (from above):** “Yes, yes, of course. You say that now that I got you buried here. But I don&#39;t trust your kind. Silent killers with secrets in every breath. Speak up: convince me you’re worth digging out.”  
He taps his shovel impatiently.  

What do you say?  
* [[Reveal a critical secret about Brannon’s past|WhisperedRevealSecret]]  
* [[Offer to clear his name of a rumor|WhisperedClearRumor]]  
* [[Ask a question that only a Whispered could know|WhisperedAskMystery]]  
* [[Offer coin instead|WhisperedPay]]  
]








</tw-passagedata><tw-passagedata pid="576" name="Start Pale Scholar" tags="" position="3025,1225" size="100,100">(set: $job to 5)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**You:** “I’m a Pale Scholar.”  
**Brannon:** “Pale Scholar, eh? big words, empty purses.” He chuckles. “I’ll get you out: for a service and a lesson. 
**You:** “A service? I don&#39;t know how I can help you from down there?”  
**Brannon:** “Of course, I will dig you out and you will help me out to find the Magister&#39;s body.&quot;
**You:** “That seems reasonable, but what about the lesson then?&quot;.
**Brannon:** “Ye! The lesson... I have been wondering, you see... I’ve heard all kinds of tales about Magister Corvan: but no one agrees on the truth.”  
He leans on his shovel and clears his throat. “Open those big ears of yours, then tell me what you make of it.”

* [[Hear Brannon’s account|ScholarLore1]]
]
















</tw-passagedata><tw-passagedata pid="577" name="Start Exhumed" tags="" position="2900,1475" size="100,100">(set: $job to 6)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**You:** “I’m an Exhumed.”  
**Brannon:** He recoils. “Half-dead folk give me the creeps. I’ll help: for the **highest** bid... but you need first to agree to help me find Magister Corvan&#39;s body of course...Although I don&#39;t know if your help means much at all....”  
* [[Offer all your money and your help|ExhumedOfferAll]]  
* [[Threaten him until he digs anyway|ExhumedThreaten]]
]




</tw-passagedata><tw-passagedata pid="578" name="Start God" tags="" position="2800,1700" size="100,100">(set: $job to 0)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**Brannon:** He recoils. &quot;Oh, sir. I didn&#39;t recognize you. Let me help you out. &quot;

As you leave your coffin, You try to move your perfectly preverved body to [[continue your conversation|MainQuest]].
]</tw-passagedata></tw-storydata>
<script title="Twine engine code" data-main="harlowe">(function(){"use strict";
var require,define;!function(){var e={},r={};require=function(i){var n=e[i];return n&&(r[i]=n[1].apply(void 0,n[0].map(require)),e[i]=void 0),r[i]},(define=function(r,i,n){if("function"==typeof r)return r();e[r]=[i,n]}).amd=!0}();/*!
 * https://github.com/paulmillr/es6-shim
 * @license es6-shim Copyright 2013-2016 by Paul Miller (http://paulmillr.com)
 *   and contributors,  MIT License
 * es6-shim: v0.35.4
 * see https://github.com/paulmillr/es6-shim/blob/0.35.3/LICENSE
 * Details and documentation:
 * https://github.com/paulmillr/es6-shim/
 */
(function(e,t){if(typeof define==="function"&&define.amd){define(t)}else if(typeof exports==="object"){module.exports=t()}else{e.returnExports=t()}})(this,function(){"use strict";var e=Function.call.bind(Function.apply);var t=Function.call.bind(Function.call);var r=Array.isArray;var n=Object.keys;var o=function notThunker(t){return function notThunk(){return!e(t,this,arguments)}};var i=function(e){try{e();return false}catch(t){return true}};var a=function valueOrFalseIfThrows(e){try{return e()}catch(t){return false}};var u=o(i);var f=function(){return!i(function(){return Object.defineProperty({},"x",{get:function(){}})})};var s=!!Object.defineProperty&&f();var c=function foo(){}.name==="foo";var l=Function.call.bind(Array.prototype.forEach);var p=Function.call.bind(Array.prototype.reduce);var v=Function.call.bind(Array.prototype.filter);var y=Function.call.bind(Array.prototype.some);var h=function(e,t,r,n){if(!n&&t in e){return}if(s){Object.defineProperty(e,t,{configurable:true,enumerable:false,writable:true,value:r})}else{e[t]=r}};var b=function(e,t,r){l(n(t),function(n){var o=t[n];h(e,n,o,!!r)})};var g=Function.call.bind(Object.prototype.toString);var d=typeof/abc/==="function"?function IsCallableSlow(e){return typeof e==="function"&&g(e)==="[object Function]"}:function IsCallableFast(e){return typeof e==="function"};var m={getter:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}Object.defineProperty(e,t,{configurable:true,enumerable:false,get:r})},proxy:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,{configurable:n.configurable,enumerable:n.enumerable,get:function getKey(){return e[t]},set:function setKey(r){e[t]=r}})},redefine:function(e,t,r){if(s){var n=Object.getOwnPropertyDescriptor(e,t);n.value=r;Object.defineProperty(e,t,n)}else{e[t]=r}},defineByDescriptor:function(e,t,r){if(s){Object.defineProperty(e,t,r)}else if("value"in r){e[t]=r.value}},preserveToString:function(e,t){if(t&&d(t.toString)){h(e,"toString",t.toString.bind(t),true)}}};var O=Object.create||function(e,t){var r=function Prototype(){};r.prototype=e;var o=new r;if(typeof t!=="undefined"){n(t).forEach(function(e){m.defineByDescriptor(o,e,t[e])})}return o};var w=function(e,t){if(!Object.setPrototypeOf){return false}return a(function(){var r=function Subclass(t){var r=new e(t);Object.setPrototypeOf(r,Subclass.prototype);return r};Object.setPrototypeOf(r,e);r.prototype=O(e.prototype,{constructor:{value:r}});return t(r)})};var j=function(){if(typeof self!=="undefined"){return self}if(typeof window!=="undefined"){return window}if(typeof global!=="undefined"){return global}throw new Error("unable to locate global object")};var S=j();var T=S.isFinite;var I=Function.call.bind(String.prototype.indexOf);var E=Function.apply.bind(Array.prototype.indexOf);var P=Function.call.bind(Array.prototype.concat);var C=Function.call.bind(String.prototype.slice);var M=Function.call.bind(Array.prototype.push);var x=Function.apply.bind(Array.prototype.push);var N=Function.call.bind(Array.prototype.join);var A=Function.call.bind(Array.prototype.shift);var _=Math.max;var R=Math.min;var k=Math.floor;var L=Math.abs;var F=Math.exp;var D=Math.log;var z=Math.sqrt;var q=Function.call.bind(Object.prototype.hasOwnProperty);var W;var G=function(){};var H=S.Map;var V=H&&H.prototype["delete"];var B=H&&H.prototype.get;var U=H&&H.prototype.has;var $=H&&H.prototype.set;var J=S.Symbol||{};var X=J.species||"@@species";var K=Number.isNaN||function isNaN(e){return e!==e};var Z=Number.isFinite||function isFinite(e){return typeof e==="number"&&T(e)};var Y=d(Math.sign)?Math.sign:function sign(e){var t=Number(e);if(t===0){return t}if(K(t)){return t}return t<0?-1:1};var Q=function log1p(e){var t=Number(e);if(t<-1||K(t)){return NaN}if(t===0||t===Infinity){return t}if(t===-1){return-Infinity}return 1+t-1===0?t:t*(D(1+t)/(1+t-1))};var ee=function isArguments(e){return g(e)==="[object Arguments]"};var te=function isArguments(e){return e!==null&&typeof e==="object"&&typeof e.length==="number"&&e.length>=0&&g(e)!=="[object Array]"&&g(e.callee)==="[object Function]"};var re=ee(arguments)?ee:te;var ne={primitive:function(e){return e===null||typeof e!=="function"&&typeof e!=="object"},string:function(e){return g(e)==="[object String]"},regex:function(e){return g(e)==="[object RegExp]"},symbol:function(e){return typeof S.Symbol==="function"&&typeof e==="symbol"}};var oe=function overrideNative(e,t,r){var n=e[t];h(e,t,r,true);m.preserveToString(e[t],n)};var ie=typeof J==="function"&&typeof J["for"]==="function"&&ne.symbol(J());var ae=ne.symbol(J.iterator)?J.iterator:"_es6-shim iterator_";if(S.Set&&typeof(new S.Set)["@@iterator"]==="function"){ae="@@iterator"}if(!S.Reflect){h(S,"Reflect",{},true)}var ue=S.Reflect;var fe=String;var se=typeof document==="undefined"||!document?null:document.all;var ce=se==null?function isNullOrUndefined(e){return e==null}:function isNullOrUndefinedAndNotDocumentAll(e){return e==null&&e!==se};var le={Call:function Call(t,r){var n=arguments.length>2?arguments[2]:[];if(!le.IsCallable(t)){throw new TypeError(t+" is not a function")}return e(t,r,n)},RequireObjectCoercible:function(e,t){if(ce(e)){throw new TypeError(t||"Cannot call method on "+e)}return e},TypeIsObject:function(e){if(e===void 0||e===null||e===true||e===false){return false}return typeof e==="function"||typeof e==="object"||e===se},ToObject:function(e,t){return Object(le.RequireObjectCoercible(e,t))},IsCallable:d,IsConstructor:function(e){return le.IsCallable(e)},ToInt32:function(e){return le.ToNumber(e)>>0},ToUint32:function(e){return le.ToNumber(e)>>>0},ToNumber:function(e){if(ie&&g(e)==="[object Symbol]"){throw new TypeError("Cannot convert a Symbol value to a number")}return+e},ToInteger:function(e){var t=le.ToNumber(e);if(K(t)){return 0}if(t===0||!Z(t)){return t}return(t>0?1:-1)*k(L(t))},ToLength:function(e){var t=le.ToInteger(e);if(t<=0){return 0}if(t>Number.MAX_SAFE_INTEGER){return Number.MAX_SAFE_INTEGER}return t},SameValue:function(e,t){if(e===t){if(e===0){return 1/e===1/t}return true}return K(e)&&K(t)},SameValueZero:function(e,t){return e===t||K(e)&&K(t)},GetIterator:function(e){if(re(e)){return new W(e,"value")}var t=le.GetMethod(e,ae);if(!le.IsCallable(t)){throw new TypeError("value is not an iterable")}var r=le.Call(t,e);if(!le.TypeIsObject(r)){throw new TypeError("bad iterator")}return r},GetMethod:function(e,t){var r=le.ToObject(e)[t];if(ce(r)){return void 0}if(!le.IsCallable(r)){throw new TypeError("Method not callable: "+t)}return r},IteratorComplete:function(e){return!!e.done},IteratorClose:function(e,t){var r=le.GetMethod(e,"return");if(r===void 0){return}var n,o;try{n=le.Call(r,e)}catch(i){o=i}if(t){return}if(o){throw o}if(!le.TypeIsObject(n)){throw new TypeError("Iterator's return method returned a non-object.")}},IteratorNext:function(e){var t=arguments.length>1?e.next(arguments[1]):e.next();if(!le.TypeIsObject(t)){throw new TypeError("bad iterator")}return t},IteratorStep:function(e){var t=le.IteratorNext(e);var r=le.IteratorComplete(t);return r?false:t},Construct:function(e,t,r,n){var o=typeof r==="undefined"?e:r;if(!n&&ue.construct){return ue.construct(e,t,o)}var i=o.prototype;if(!le.TypeIsObject(i)){i=Object.prototype}var a=O(i);var u=le.Call(e,a,t);return le.TypeIsObject(u)?u:a},SpeciesConstructor:function(e,t){var r=e.constructor;if(r===void 0){return t}if(!le.TypeIsObject(r)){throw new TypeError("Bad constructor")}var n=r[X];if(ce(n)){return t}if(!le.IsConstructor(n)){throw new TypeError("Bad @@species")}return n},CreateHTML:function(e,t,r,n){var o=le.ToString(e);var i="<"+t;if(r!==""){var a=le.ToString(n);var u=a.replace(/"/g,"&quot;");i+=" "+r+'="'+u+'"'}var f=i+">";var s=f+o;return s+"</"+t+">"},IsRegExp:function IsRegExp(e){if(!le.TypeIsObject(e)){return false}var t=e[J.match];if(typeof t!=="undefined"){return!!t}return ne.regex(e)},ToString:function ToString(e){if(ie&&g(e)==="[object Symbol]"){throw new TypeError("Cannot convert a Symbol value to a number")}return fe(e)}};if(s&&ie){var pe=function defineWellKnownSymbol(e){if(ne.symbol(J[e])){return J[e]}var t=J["for"]("Symbol."+e);Object.defineProperty(J,e,{configurable:false,enumerable:false,writable:false,value:t});return t};if(!ne.symbol(J.search)){var ve=pe("search");var ye=String.prototype.search;h(RegExp.prototype,ve,function search(e){return le.Call(ye,e,[this])});var he=function search(e){var t=le.RequireObjectCoercible(this);if(!ce(e)){var r=le.GetMethod(e,ve);if(typeof r!=="undefined"){return le.Call(r,e,[t])}}return le.Call(ye,t,[le.ToString(e)])};oe(String.prototype,"search",he)}if(!ne.symbol(J.replace)){var be=pe("replace");var ge=String.prototype.replace;h(RegExp.prototype,be,function replace(e,t){return le.Call(ge,e,[this,t])});var de=function replace(e,t){var r=le.RequireObjectCoercible(this);if(!ce(e)){var n=le.GetMethod(e,be);if(typeof n!=="undefined"){return le.Call(n,e,[r,t])}}return le.Call(ge,r,[le.ToString(e),t])};oe(String.prototype,"replace",de)}if(!ne.symbol(J.split)){var me=pe("split");var Oe=String.prototype.split;h(RegExp.prototype,me,function split(e,t){return le.Call(Oe,e,[this,t])});var we=function split(e,t){var r=le.RequireObjectCoercible(this);if(!ce(e)){var n=le.GetMethod(e,me);if(typeof n!=="undefined"){return le.Call(n,e,[r,t])}}return le.Call(Oe,r,[le.ToString(e),t])};oe(String.prototype,"split",we)}var je=ne.symbol(J.match);var Se=je&&function(){var e={};e[J.match]=function(){return 42};return"a".match(e)!==42}();if(!je||Se){var Te=pe("match");var Ie=String.prototype.match;h(RegExp.prototype,Te,function match(e){return le.Call(Ie,e,[this])});var Ee=function match(e){var t=le.RequireObjectCoercible(this);if(!ce(e)){var r=le.GetMethod(e,Te);if(typeof r!=="undefined"){return le.Call(r,e,[t])}}return le.Call(Ie,t,[le.ToString(e)])};oe(String.prototype,"match",Ee)}}var Pe=function wrapConstructor(e,t,r){m.preserveToString(t,e);if(Object.setPrototypeOf){Object.setPrototypeOf(e,t)}if(s){l(Object.getOwnPropertyNames(e),function(n){if(n in G||r[n]){return}m.proxy(e,n,t)})}else{l(Object.keys(e),function(n){if(n in G||r[n]){return}t[n]=e[n]})}t.prototype=e.prototype;m.redefine(e.prototype,"constructor",t)};var Ce=function(){return this};var Me=function(e){if(s&&!q(e,X)){m.getter(e,X,Ce)}};var xe=function(e,t){var r=t||function iterator(){return this};h(e,ae,r);if(!e[ae]&&ne.symbol(ae)){e[ae]=r}};var Ne=function createDataProperty(e,t,r){if(s){Object.defineProperty(e,t,{configurable:true,enumerable:true,writable:true,value:r})}else{e[t]=r}};var Ae=function createDataPropertyOrThrow(e,t,r){Ne(e,t,r);if(!le.SameValue(e[t],r)){throw new TypeError("property is nonconfigurable")}};var _e=function(e,t,r,n){if(!le.TypeIsObject(e)){throw new TypeError("Constructor requires `new`: "+t.name)}var o=t.prototype;if(!le.TypeIsObject(o)){o=r}var i=O(o);for(var a in n){if(q(n,a)){var u=n[a];h(i,a,u,true)}}return i};if(String.fromCodePoint&&String.fromCodePoint.length!==1){var Re=String.fromCodePoint;oe(String,"fromCodePoint",function fromCodePoint(e){return le.Call(Re,this,arguments)})}var ke={fromCodePoint:function fromCodePoint(e){var t=[];var r;for(var n=0,o=arguments.length;n<o;n++){r=Number(arguments[n]);if(!le.SameValue(r,le.ToInteger(r))||r<0||r>1114111){throw new RangeError("Invalid code point "+r)}if(r<65536){M(t,String.fromCharCode(r))}else{r-=65536;M(t,String.fromCharCode((r>>10)+55296));M(t,String.fromCharCode(r%1024+56320))}}return N(t,"")},raw:function raw(e){var t=arguments.length-1;var r=le.ToObject(e,"bad template");var raw=le.ToObject(r.raw,"bad raw value");var n=raw.length;var o=le.ToLength(n);if(o<=0){return""}var i=[];var a=0;var u,f,s,c;while(a<o){u=le.ToString(a);s=le.ToString(raw[u]);M(i,s);if(a+1>=o){break}f=a+1<arguments.length?arguments[a+1]:"";c=le.ToString(f);M(i,c);a+=1}return N(i,"")}};if(String.raw&&String.raw({raw:{0:"x",1:"y",length:2}})!=="xy"){oe(String,"raw",ke.raw)}b(String,ke);var Le=function repeat(e,t){if(t<1){return""}if(t%2){return repeat(e,t-1)+e}var r=repeat(e,t/2);return r+r};var Fe=Infinity;var De={repeat:function repeat(e){var t=le.ToString(le.RequireObjectCoercible(this));var r=le.ToInteger(e);if(r<0||r>=Fe){throw new RangeError("repeat count must be less than infinity and not overflow maximum string size")}return Le(t,r)},startsWith:function startsWith(e){var t=le.ToString(le.RequireObjectCoercible(this));if(le.IsRegExp(e)){throw new TypeError('Cannot call method "startsWith" with a regex')}var r=le.ToString(e);var n;if(arguments.length>1){n=arguments[1]}var o=_(le.ToInteger(n),0);return C(t,o,o+r.length)===r},endsWith:function endsWith(e){var t=le.ToString(le.RequireObjectCoercible(this));if(le.IsRegExp(e)){throw new TypeError('Cannot call method "endsWith" with a regex')}var r=le.ToString(e);var n=t.length;var o;if(arguments.length>1){o=arguments[1]}var i=typeof o==="undefined"?n:le.ToInteger(o);var a=R(_(i,0),n);return C(t,a-r.length,a)===r},includes:function includes(e){if(le.IsRegExp(e)){throw new TypeError('"includes" does not accept a RegExp')}var t=le.ToString(e);var r;if(arguments.length>1){r=arguments[1]}return I(this,t,r)!==-1},codePointAt:function codePointAt(e){var t=le.ToString(le.RequireObjectCoercible(this));var r=le.ToInteger(e);var n=t.length;if(r>=0&&r<n){var o=t.charCodeAt(r);var i=r+1===n;if(o<55296||o>56319||i){return o}var a=t.charCodeAt(r+1);if(a<56320||a>57343){return o}return(o-55296)*1024+(a-56320)+65536}}};if(String.prototype.includes&&"a".includes("a",Infinity)!==false){oe(String.prototype,"includes",De.includes)}if(String.prototype.startsWith&&String.prototype.endsWith){var ze=i(function(){return"/a/".startsWith(/a/)});var qe=a(function(){return"abc".startsWith("a",Infinity)===false});if(!ze||!qe){oe(String.prototype,"startsWith",De.startsWith);oe(String.prototype,"endsWith",De.endsWith)}}if(ie){var We=a(function(){var e=/a/;e[J.match]=false;return"/a/".startsWith(e)});if(!We){oe(String.prototype,"startsWith",De.startsWith)}var Ge=a(function(){var e=/a/;e[J.match]=false;return"/a/".endsWith(e)});if(!Ge){oe(String.prototype,"endsWith",De.endsWith)}var He=a(function(){var e=/a/;e[J.match]=false;return"/a/".includes(e)});if(!He){oe(String.prototype,"includes",De.includes)}}b(String.prototype,De);var Ve=["\t\n\x0B\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003","\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028","\u2029\ufeff"].join("");var Be=new RegExp("(^["+Ve+"]+)|(["+Ve+"]+$)","g");var Ue=function trim(){return le.ToString(le.RequireObjectCoercible(this)).replace(Be,"")};var $e=["\x85","\u200b","\ufffe"].join("");var Je=new RegExp("["+$e+"]","g");var Xe=/^[-+]0x[0-9a-f]+$/i;var Ke=$e.trim().length!==$e.length;h(String.prototype,"trim",Ue,Ke);var Ze=function(e){return{value:e,done:arguments.length===0}};var Ye=function(e){le.RequireObjectCoercible(e);h(this,"_s",le.ToString(e));h(this,"_i",0)};Ye.prototype.next=function(){var e=this._s;var t=this._i;if(typeof e==="undefined"||t>=e.length){this._s=void 0;return Ze()}var r=e.charCodeAt(t);var n,o;if(r<55296||r>56319||t+1===e.length){o=1}else{n=e.charCodeAt(t+1);o=n<56320||n>57343?1:2}this._i=t+o;return Ze(e.substr(t,o))};xe(Ye.prototype);xe(String.prototype,function(){return new Ye(this)});var Qe={from:function from(e){var r=this;var n;if(arguments.length>1){n=arguments[1]}var o,i;if(typeof n==="undefined"){o=false}else{if(!le.IsCallable(n)){throw new TypeError("Array.from: when provided, the second argument must be a function")}if(arguments.length>2){i=arguments[2]}o=true}var a=typeof(re(e)||le.GetMethod(e,ae))!=="undefined";var u,f,s;if(a){f=le.IsConstructor(r)?Object(new r):[];var c=le.GetIterator(e);var l,p;s=0;while(true){l=le.IteratorStep(c);if(l===false){break}p=l.value;try{if(o){p=typeof i==="undefined"?n(p,s):t(n,i,p,s)}f[s]=p}catch(v){le.IteratorClose(c,true);throw v}s+=1}u=s}else{var y=le.ToObject(e);u=le.ToLength(y.length);f=le.IsConstructor(r)?Object(new r(u)):new Array(u);var h;for(s=0;s<u;++s){h=y[s];if(o){h=typeof i==="undefined"?n(h,s):t(n,i,h,s)}Ae(f,s,h)}}f.length=u;return f},of:function of(){var e=arguments.length;var t=this;var n=r(t)||!le.IsCallable(t)?new Array(e):le.Construct(t,[e]);for(var o=0;o<e;++o){Ae(n,o,arguments[o])}n.length=e;return n}};b(Array,Qe);Me(Array);W=function(e,t){h(this,"i",0);h(this,"array",e);h(this,"kind",t)};b(W.prototype,{next:function(){var e=this.i;var t=this.array;if(!(this instanceof W)){throw new TypeError("Not an ArrayIterator")}if(typeof t!=="undefined"){var r=le.ToLength(t.length);if(e<r){var n=this.kind;var o;if(n==="key"){o=e}else if(n==="value"){o=t[e]}else if(n==="entry"){o=[e,t[e]]}this.i=e+1;return Ze(o)}}this.array=void 0;return Ze()}});xe(W.prototype);var et=Array.of===Qe.of||function(){var e=function Foo(e){this.length=e};e.prototype=[];var t=Array.of.apply(e,[1,2]);return t instanceof e&&t.length===2}();if(!et){oe(Array,"of",Qe.of)}var tt={copyWithin:function copyWithin(e,t){var r=le.ToObject(this);var n=le.ToLength(r.length);var o=le.ToInteger(e);var i=le.ToInteger(t);var a=o<0?_(n+o,0):R(o,n);var u=i<0?_(n+i,0):R(i,n);var f;if(arguments.length>2){f=arguments[2]}var s=typeof f==="undefined"?n:le.ToInteger(f);var c=s<0?_(n+s,0):R(s,n);var l=R(c-u,n-a);var p=1;if(u<a&&a<u+l){p=-1;u+=l-1;a+=l-1}while(l>0){if(u in r){r[a]=r[u]}else{delete r[a]}u+=p;a+=p;l-=1}return r},fill:function fill(e){var t;if(arguments.length>1){t=arguments[1]}var r;if(arguments.length>2){r=arguments[2]}var n=le.ToObject(this);var o=le.ToLength(n.length);t=le.ToInteger(typeof t==="undefined"?0:t);r=le.ToInteger(typeof r==="undefined"?o:r);var i=t<0?_(o+t,0):R(t,o);var a=r<0?o+r:r;for(var u=i;u<o&&u<a;++u){n[u]=e}return n},find:function find(e){var r=le.ToObject(this);var n=le.ToLength(r.length);if(!le.IsCallable(e)){throw new TypeError("Array#find: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0,a;i<n;i++){a=r[i];if(o){if(t(e,o,a,i,r)){return a}}else if(e(a,i,r)){return a}}},findIndex:function findIndex(e){var r=le.ToObject(this);var n=le.ToLength(r.length);if(!le.IsCallable(e)){throw new TypeError("Array#findIndex: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0;i<n;i++){if(o){if(t(e,o,r[i],i,r)){return i}}else if(e(r[i],i,r)){return i}}return-1},keys:function keys(){return new W(this,"key")},values:function values(){return new W(this,"value")},entries:function entries(){return new W(this,"entry")}};if(Array.prototype.keys&&!le.IsCallable([1].keys().next)){delete Array.prototype.keys}if(Array.prototype.entries&&!le.IsCallable([1].entries().next)){delete Array.prototype.entries}if(Array.prototype.keys&&Array.prototype.entries&&!Array.prototype.values&&Array.prototype[ae]){b(Array.prototype,{values:Array.prototype[ae]});if(ne.symbol(J.unscopables)){Array.prototype[J.unscopables].values=true}}if(c&&Array.prototype.values&&Array.prototype.values.name!=="values"){var rt=Array.prototype.values;oe(Array.prototype,"values",function values(){return le.Call(rt,this,arguments)});h(Array.prototype,ae,Array.prototype.values,true)}b(Array.prototype,tt);if(1/[true].indexOf(true,-0)<0){h(Array.prototype,"indexOf",function indexOf(e){var t=E(this,arguments);if(t===0&&1/t<0){return 0}return t},true)}xe(Array.prototype,function(){return this.values()});if(Object.getPrototypeOf){var nt=Object.getPrototypeOf([].values());if(nt){xe(nt)}}var ot=function(){return a(function(){return Array.from({length:-1}).length===0})}();var it=function(){var e=Array.from([0].entries());return e.length===1&&r(e[0])&&e[0][0]===0&&e[0][1]===0}();if(!ot||!it){oe(Array,"from",Qe.from)}var at=function(){return a(function(){return Array.from([0],void 0)})}();if(!at){var ut=Array.from;oe(Array,"from",function from(e){if(arguments.length>1&&typeof arguments[1]!=="undefined"){return le.Call(ut,this,arguments)}return t(ut,this,e)})}var ft=-(Math.pow(2,32)-1);var st=function(e,r){var n={length:ft};n[r?(n.length>>>0)-1:0]=true;return a(function(){t(e,n,function(){throw new RangeError("should not reach here")},[]);return true})};if(!st(Array.prototype.forEach)){var ct=Array.prototype.forEach;oe(Array.prototype,"forEach",function forEach(e){return le.Call(ct,this.length>=0?this:[],arguments)})}if(!st(Array.prototype.map)){var lt=Array.prototype.map;oe(Array.prototype,"map",function map(e){return le.Call(lt,this.length>=0?this:[],arguments)})}if(!st(Array.prototype.filter)){var pt=Array.prototype.filter;oe(Array.prototype,"filter",function filter(e){return le.Call(pt,this.length>=0?this:[],arguments)})}if(!st(Array.prototype.some)){var vt=Array.prototype.some;oe(Array.prototype,"some",function some(e){return le.Call(vt,this.length>=0?this:[],arguments)})}if(!st(Array.prototype.every)){var yt=Array.prototype.every;oe(Array.prototype,"every",function every(e){return le.Call(yt,this.length>=0?this:[],arguments)})}if(!st(Array.prototype.reduce)){var ht=Array.prototype.reduce;oe(Array.prototype,"reduce",function reduce(e){return le.Call(ht,this.length>=0?this:[],arguments)})}if(!st(Array.prototype.reduceRight,true)){var bt=Array.prototype.reduceRight;oe(Array.prototype,"reduceRight",function reduceRight(e){return le.Call(bt,this.length>=0?this:[],arguments)})}var gt=Number("0o10")!==8;var dt=Number("0b10")!==2;var mt=y($e,function(e){return Number(e+0+e)===0});if(gt||dt||mt){var Ot=Number;var wt=/^0b[01]+$/i;var jt=/^0o[0-7]+$/i;var St=wt.test.bind(wt);var Tt=jt.test.bind(jt);var It=function(e,t){var r;if(typeof e.valueOf==="function"){r=e.valueOf();if(ne.primitive(r)){return r}}if(typeof e.toString==="function"){r=e.toString();if(ne.primitive(r)){return r}}throw new TypeError("No default value")};var Et=Je.test.bind(Je);var Pt=Xe.test.bind(Xe);var Ct=function(){var e=function Number(t){var r;if(arguments.length>0){r=ne.primitive(t)?t:It(t,"number")}else{r=0}if(typeof r==="string"){r=le.Call(Ue,r);if(St(r)){r=parseInt(C(r,2),2)}else if(Tt(r)){r=parseInt(C(r,2),8)}else if(Et(r)||Pt(r)){r=NaN}}var n=this;var o=a(function(){Ot.prototype.valueOf.call(n);return true});if(n instanceof e&&!o){return new Ot(r)}return Ot(r)};return e}();Pe(Ot,Ct,{});b(Ct,{NaN:Ot.NaN,MAX_VALUE:Ot.MAX_VALUE,MIN_VALUE:Ot.MIN_VALUE,NEGATIVE_INFINITY:Ot.NEGATIVE_INFINITY,POSITIVE_INFINITY:Ot.POSITIVE_INFINITY});Number=Ct;m.redefine(S,"Number",Ct)}var Mt=Math.pow(2,53)-1;b(Number,{MAX_SAFE_INTEGER:Mt,MIN_SAFE_INTEGER:-Mt,EPSILON:2.220446049250313e-16,parseInt:S.parseInt,parseFloat:S.parseFloat,isFinite:Z,isInteger:function isInteger(e){return Z(e)&&le.ToInteger(e)===e},isSafeInteger:function isSafeInteger(e){return Number.isInteger(e)&&L(e)<=Number.MAX_SAFE_INTEGER},isNaN:K});h(Number,"parseInt",S.parseInt,Number.parseInt!==S.parseInt);if([,1].find(function(){return true})===1){oe(Array.prototype,"find",tt.find)}if([,1].findIndex(function(){return true})!==0){oe(Array.prototype,"findIndex",tt.findIndex)}var xt=Function.bind.call(Function.bind,Object.prototype.propertyIsEnumerable);var Nt=function ensureEnumerable(e,t){if(s&&xt(e,t)){Object.defineProperty(e,t,{enumerable:false})}};var At=function sliceArgs(){var e=Number(this);var t=arguments.length;var r=t-e;var n=new Array(r<0?0:r);for(var o=e;o<t;++o){n[o-e]=arguments[o]}return n};var _t=function assignTo(e){return function assignToSource(t,r){t[r]=e[r];return t}};var Rt=function(e,t){var r=n(Object(t));var o;if(le.IsCallable(Object.getOwnPropertySymbols)){o=v(Object.getOwnPropertySymbols(Object(t)),xt(t))}return p(P(r,o||[]),_t(t),e)};var kt={assign:function(e,t){var r=le.ToObject(e,"Cannot convert undefined or null to object");return p(le.Call(At,1,arguments),Rt,r)},is:function is(e,t){return le.SameValue(e,t)}};var Lt=Object.assign&&Object.preventExtensions&&function(){var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return e[1]==="y"}}();if(Lt){oe(Object,"assign",kt.assign)}b(Object,kt);if(s){var Ft={setPrototypeOf:function(e){var r;var n=function(e,t){if(!le.TypeIsObject(e)){throw new TypeError("cannot set prototype on a non-object")}if(!(t===null||le.TypeIsObject(t))){throw new TypeError("can only set prototype to an object or null"+t)}};var o=function(e,o){n(e,o);t(r,e,o);return e};try{r=e.getOwnPropertyDescriptor(e.prototype,"__proto__").set;t(r,{},null)}catch(i){if(e.prototype!=={}.__proto__){return}r=function(e){this.__proto__=e};o.polyfill=o(o({},null),e.prototype)instanceof e}return o}(Object)};b(Object,Ft)}if(Object.setPrototypeOf&&Object.getPrototypeOf&&Object.getPrototypeOf(Object.setPrototypeOf({},null))!==null&&Object.getPrototypeOf(Object.create(null))===null){(function(){var e=Object.create(null);var t=Object.getPrototypeOf;var r=Object.setPrototypeOf;Object.getPrototypeOf=function(r){var n=t(r);return n===e?null:n};Object.setPrototypeOf=function(t,n){var o=n===null?e:n;return r(t,o)};Object.setPrototypeOf.polyfill=false})()}var Dt=!i(function(){return Object.keys("foo")});if(!Dt){var zt=Object.keys;oe(Object,"keys",function keys(e){return zt(le.ToObject(e))});n=Object.keys}var qt=i(function(){return Object.keys(/a/g)});if(qt){var Wt=Object.keys;oe(Object,"keys",function keys(e){if(ne.regex(e)){var t=[];for(var r in e){if(q(e,r)){M(t,r)}}return t}return Wt(e)});n=Object.keys}if(Object.getOwnPropertyNames){var Gt=!i(function(){return Object.getOwnPropertyNames("foo")});if(!Gt){var Ht=typeof window==="object"?Object.getOwnPropertyNames(window):[];var Vt=Object.getOwnPropertyNames;oe(Object,"getOwnPropertyNames",function getOwnPropertyNames(e){var t=le.ToObject(e);if(g(t)==="[object Window]"){try{return Vt(t)}catch(r){return P([],Ht)}}return Vt(t)})}}if(Object.getOwnPropertyDescriptor){var Bt=!i(function(){return Object.getOwnPropertyDescriptor("foo","bar")});if(!Bt){var Ut=Object.getOwnPropertyDescriptor;oe(Object,"getOwnPropertyDescriptor",function getOwnPropertyDescriptor(e,t){return Ut(le.ToObject(e),t)})}}if(Object.seal){var $t=!i(function(){return Object.seal("foo")});if(!$t){var Jt=Object.seal;oe(Object,"seal",function seal(e){if(!le.TypeIsObject(e)){return e}return Jt(e)})}}if(Object.isSealed){var Xt=!i(function(){return Object.isSealed("foo")});if(!Xt){var Kt=Object.isSealed;oe(Object,"isSealed",function isSealed(e){if(!le.TypeIsObject(e)){return true}return Kt(e)})}}if(Object.freeze){var Zt=!i(function(){return Object.freeze("foo")});if(!Zt){var Yt=Object.freeze;oe(Object,"freeze",function freeze(e){if(!le.TypeIsObject(e)){return e}return Yt(e)})}}if(Object.isFrozen){var Qt=!i(function(){return Object.isFrozen("foo")});if(!Qt){var er=Object.isFrozen;oe(Object,"isFrozen",function isFrozen(e){if(!le.TypeIsObject(e)){return true}return er(e)})}}if(Object.preventExtensions){var tr=!i(function(){return Object.preventExtensions("foo")});if(!tr){var rr=Object.preventExtensions;oe(Object,"preventExtensions",function preventExtensions(e){if(!le.TypeIsObject(e)){return e}return rr(e)})}}if(Object.isExtensible){var nr=!i(function(){return Object.isExtensible("foo")});if(!nr){var or=Object.isExtensible;oe(Object,"isExtensible",function isExtensible(e){if(!le.TypeIsObject(e)){return false}return or(e)})}}if(Object.getPrototypeOf){var ir=!i(function(){return Object.getPrototypeOf("foo")});if(!ir){var ar=Object.getPrototypeOf;oe(Object,"getPrototypeOf",function getPrototypeOf(e){return ar(le.ToObject(e))})}}var ur=s&&function(){var e=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags");return e&&le.IsCallable(e.get)}();if(s&&!ur){var fr=function flags(){if(!le.TypeIsObject(this)){throw new TypeError("Method called on incompatible type: must be an object.")}var e="";if(this.global){e+="g"}if(this.ignoreCase){e+="i"}if(this.multiline){e+="m"}if(this.unicode){e+="u"}if(this.sticky){e+="y"}return e};m.getter(RegExp.prototype,"flags",fr)}var sr=s&&a(function(){return String(new RegExp(/a/g,"i"))==="/a/i"});var cr=ie&&s&&function(){var e=/./;e[J.match]=false;return RegExp(e)===e}();var lr=a(function(){return RegExp.prototype.toString.call({source:"abc"})==="/abc/"});var pr=lr&&a(function(){return RegExp.prototype.toString.call({source:"a",flags:"b"})==="/a/b"});if(!lr||!pr){var vr=RegExp.prototype.toString;h(RegExp.prototype,"toString",function toString(){var e=le.RequireObjectCoercible(this);if(ne.regex(e)){return t(vr,e)}var r=fe(e.source);var n=fe(e.flags);return"/"+r+"/"+n},true);m.preserveToString(RegExp.prototype.toString,vr);RegExp.prototype.toString.prototype=void 0}if(s&&(!sr||cr)){var yr=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags").get;var hr=Object.getOwnPropertyDescriptor(RegExp.prototype,"source")||{};var br=function(){return this.source};var gr=le.IsCallable(hr.get)?hr.get:br;var dr=RegExp;var mr=function(){return function RegExp(e,t){var r=le.IsRegExp(e);var n=this instanceof RegExp;if(!n&&r&&typeof t==="undefined"&&e.constructor===RegExp){return e}var o=e;var i=t;if(ne.regex(e)){o=le.Call(gr,e);i=typeof t==="undefined"?le.Call(yr,e):t;return new RegExp(o,i)}else if(r){o=e.source;i=typeof t==="undefined"?e.flags:t}return new dr(e,t)}}();Pe(dr,mr,{$input:true});RegExp=mr;m.redefine(S,"RegExp",mr)}if(s){var Or={input:"$_",lastMatch:"$&",lastParen:"$+",leftContext:"$`",rightContext:"$'"};l(n(Or),function(e){if(e in RegExp&&!(Or[e]in RegExp)){m.getter(RegExp,Or[e],function get(){return RegExp[e]})}})}Me(RegExp);var wr=1/Number.EPSILON;var jr=function roundTiesToEven(e){return e+wr-wr};var Sr=Math.pow(2,-23);var Tr=Math.pow(2,127)*(2-Sr);var Ir=Math.pow(2,-126);var Er=Math.E;var Pr=Math.LOG2E;var Cr=Math.LOG10E;var Mr=Number.prototype.clz;delete Number.prototype.clz;var xr={acosh:function acosh(e){var t=Number(e);if(K(t)||e<1){return NaN}if(t===1){return 0}if(t===Infinity){return t}var r=1/(t*t);if(t<2){return Q(t-1+z(1-r)*t)}var n=t/2;return Q(n+z(1-r)*n-1)+1/Pr},asinh:function asinh(e){var t=Number(e);if(t===0||!T(t)){return t}var r=L(t);var n=r*r;var o=Y(t);if(r<1){return o*Q(r+n/(z(n+1)+1))}return o*(Q(r/2+z(1+1/n)*r/2-1)+1/Pr)},atanh:function atanh(e){var t=Number(e);if(t===0){return t}if(t===-1){return-Infinity}if(t===1){return Infinity}if(K(t)||t<-1||t>1){return NaN}var r=L(t);return Y(t)*Q(2*r/(1-r))/2},cbrt:function cbrt(e){var t=Number(e);if(t===0){return t}var r=t<0;var n;if(r){t=-t}if(t===Infinity){n=Infinity}else{n=F(D(t)/3);n=(t/(n*n)+2*n)/3}return r?-n:n},clz32:function clz32(e){var t=Number(e);var r=le.ToUint32(t);if(r===0){return 32}return Mr?le.Call(Mr,r):31-k(D(r+.5)*Pr)},cosh:function cosh(e){var t=Number(e);if(t===0){return 1}if(K(t)){return NaN}if(!T(t)){return Infinity}var r=F(L(t)-1);return(r+1/(r*Er*Er))*(Er/2)},expm1:function expm1(e){var t=Number(e);if(t===-Infinity){return-1}if(!T(t)||t===0){return t}if(L(t)>.5){return F(t)-1}var r=t;var n=0;var o=1;while(n+r!==n){n+=r;o+=1;r*=t/o}return n},hypot:function hypot(e,t){var r=0;var n=0;for(var o=0;o<arguments.length;++o){var i=L(Number(arguments[o]));if(n<i){r*=n/i*(n/i);r+=1;n=i}else{r+=i>0?i/n*(i/n):i}}return n===Infinity?Infinity:n*z(r)},log2:function log2(e){return D(e)*Pr},log10:function log10(e){return D(e)*Cr},log1p:Q,sign:Y,sinh:function sinh(e){var t=Number(e);if(!T(t)||t===0){return t}var r=L(t);if(r<1){var n=Math.expm1(r);return Y(t)*n*(1+1/(n+1))/2}var o=F(r-1);return Y(t)*(o-1/(o*Er*Er))*(Er/2)},tanh:function tanh(e){var t=Number(e);if(K(t)||t===0){return t}if(t>=20){return 1}if(t<=-20){return-1}return(Math.expm1(t)-Math.expm1(-t))/(F(t)+F(-t))},trunc:function trunc(e){var t=Number(e);return t<0?-k(-t):k(t)},imul:function imul(e,t){var r=le.ToUint32(e);var n=le.ToUint32(t);var o=r>>>16&65535;var i=r&65535;var a=n>>>16&65535;var u=n&65535;return i*u+(o*u+i*a<<16>>>0)|0},fround:function fround(e){var t=Number(e);if(t===0||t===Infinity||t===-Infinity||K(t)){return t}var r=Y(t);var n=L(t);if(n<Ir){return r*jr(n/Ir/Sr)*Ir*Sr}var o=(1+Sr/Number.EPSILON)*n;var i=o-(o-n);if(i>Tr||K(i)){return r*Infinity}return r*i}};var Nr=function withinULPDistance(e,t,r){return L(1-e/t)/Number.EPSILON<(r||8)};b(Math,xr);h(Math,"sinh",xr.sinh,Math.sinh(710)===Infinity);h(Math,"cosh",xr.cosh,Math.cosh(710)===Infinity);h(Math,"log1p",xr.log1p,Math.log1p(-1e-17)!==-1e-17);h(Math,"asinh",xr.asinh,Math.asinh(-1e7)!==-Math.asinh(1e7));
h(Math,"asinh",xr.asinh,Math.asinh(1e300)===Infinity);h(Math,"atanh",xr.atanh,Math.atanh(1e-300)===0);h(Math,"tanh",xr.tanh,Math.tanh(-2e-17)!==-2e-17);h(Math,"acosh",xr.acosh,Math.acosh(Number.MAX_VALUE)===Infinity);h(Math,"acosh",xr.acosh,!Nr(Math.acosh(1+Number.EPSILON),Math.sqrt(2*Number.EPSILON)));h(Math,"cbrt",xr.cbrt,!Nr(Math.cbrt(1e-300),1e-100));h(Math,"sinh",xr.sinh,Math.sinh(-2e-17)!==-2e-17);var Ar=Math.expm1(10);h(Math,"expm1",xr.expm1,Ar>22025.465794806718||Ar<22025.465794806718);h(Math,"hypot",xr.hypot,Math.hypot(Infinity,NaN)!==Infinity);var _r=Math.round;var Rr=Math.round(.5-Number.EPSILON/4)===0&&Math.round(-.5+Number.EPSILON/3.99)===1;var kr=wr+1;var Lr=2*wr-1;var Fr=[kr,Lr].every(function(e){return Math.round(e)===e});h(Math,"round",function round(e){var t=k(e);var r=t===-1?-0:t+1;return e-t<.5?t:r},!Rr||!Fr);m.preserveToString(Math.round,_r);var Dr=Math.imul;if(Math.imul(4294967295,5)!==-5){Math.imul=xr.imul;m.preserveToString(Math.imul,Dr)}if(Math.imul.length!==2){oe(Math,"imul",function imul(e,t){return le.Call(Dr,Math,arguments)})}var zr=function(){var e=S.setTimeout;if(typeof e!=="function"&&typeof e!=="object"){return}le.IsPromise=function(e){if(!le.TypeIsObject(e)){return false}if(typeof e._promise==="undefined"){return false}return true};var r=function(e){if(!le.IsConstructor(e)){throw new TypeError("Bad promise constructor")}var t=this;var r=function(e,r){if(t.resolve!==void 0||t.reject!==void 0){throw new TypeError("Bad Promise implementation!")}t.resolve=e;t.reject=r};t.resolve=void 0;t.reject=void 0;t.promise=new e(r);if(!(le.IsCallable(t.resolve)&&le.IsCallable(t.reject))){throw new TypeError("Bad promise constructor")}};var n;if(typeof window!=="undefined"&&le.IsCallable(window.postMessage)){n=function(){var e=[];var t="zero-timeout-message";var r=function(r){M(e,r);window.postMessage(t,"*")};var n=function(r){if(r.source===window&&r.data===t){r.stopPropagation();if(e.length===0){return}var n=A(e);n()}};window.addEventListener("message",n,true);return r}}var o=function(){var e=S.Promise;var t=e&&e.resolve&&e.resolve();return t&&function(e){return t.then(e)}};var i=le.IsCallable(S.setImmediate)?S.setImmediate:typeof process==="object"&&process.nextTick?process.nextTick:o()||(le.IsCallable(n)?n():function(t){e(t,0)});var a=function(e){return e};var u=function(e){throw e};var f=0;var s=1;var c=2;var l=0;var p=1;var v=2;var y={};var h=function(e,t,r){i(function(){g(e,t,r)})};var g=function(e,t,r){var n,o;if(t===y){return e(r)}try{n=e(r);o=t.resolve}catch(i){n=i;o=t.reject}o(n)};var d=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.fulfillReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+l],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=s;r.reactionLength=0};var m=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.rejectReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+p],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=c;r.reactionLength=0};var O=function(e){var t=false;var r=function(r){var n;if(t){return}t=true;if(r===e){return m(e,new TypeError("Self resolution"))}if(!le.TypeIsObject(r)){return d(e,r)}try{n=r.then}catch(o){return m(e,o)}if(!le.IsCallable(n)){return d(e,r)}i(function(){j(e,r,n)})};var n=function(r){if(t){return}t=true;return m(e,r)};return{resolve:r,reject:n}};var w=function(e,r,n,o){if(e===I){t(e,r,n,o,y)}else{t(e,r,n,o)}};var j=function(e,t,r){var n=O(e);var o=n.resolve;var i=n.reject;try{w(r,t,o,i)}catch(a){i(a)}};var T,I;var E=function(){var e=function Promise(t){if(!(this instanceof e)){throw new TypeError('Constructor Promise requires "new"')}if(this&&this._promise){throw new TypeError("Bad construction")}if(!le.IsCallable(t)){throw new TypeError("not a valid resolver")}var r=_e(this,e,T,{_promise:{result:void 0,state:f,reactionLength:0,fulfillReactionHandler0:void 0,rejectReactionHandler0:void 0,reactionCapability0:void 0}});var n=O(r);var o=n.reject;try{t(n.resolve,o)}catch(i){o(i)}return r};return e}();T=E.prototype;var P=function(e,t,r,n){var o=false;return function(i){if(o){return}o=true;t[e]=i;if(--n.count===0){var a=r.resolve;a(t)}}};var C=function(e,t,r){var n=e.iterator;var o=[];var i={count:1};var a,u;var f=0;while(true){try{a=le.IteratorStep(n);if(a===false){e.done=true;break}u=a.value}catch(s){e.done=true;throw s}o[f]=void 0;var c=t.resolve(u);var l=P(f,o,r,i);i.count+=1;w(c.then,c,l,r.reject);f+=1}if(--i.count===0){var p=r.resolve;p(o)}return r.promise};var x=function(e,t,r){var n=e.iterator;var o,i,a;while(true){try{o=le.IteratorStep(n);if(o===false){e.done=true;break}i=o.value}catch(u){e.done=true;throw u}a=t.resolve(i);w(a.then,a,r.resolve,r.reject)}return r.promise};b(E,{all:function all(e){var t=this;if(!le.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=le.GetIterator(e);i={iterator:o,done:false};return C(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{le.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},race:function race(e){var t=this;if(!le.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=le.GetIterator(e);i={iterator:o,done:false};return x(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{le.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},reject:function reject(e){var t=this;if(!le.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}var n=new r(t);var o=n.reject;o(e);return n.promise},resolve:function resolve(e){var t=this;if(!le.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}if(le.IsPromise(e)){var n=e.constructor;if(n===t){return e}}var o=new r(t);var i=o.resolve;i(e);return o.promise}});b(T,{"catch":function(e){return this.then(null,e)},then:function then(e,t){var n=this;if(!le.IsPromise(n)){throw new TypeError("not a promise")}var o=le.SpeciesConstructor(n,E);var i;var b=arguments.length>2&&arguments[2]===y;if(b&&o===E){i=y}else{i=new r(o)}var g=le.IsCallable(e)?e:a;var d=le.IsCallable(t)?t:u;var m=n._promise;var O;if(m.state===f){if(m.reactionLength===0){m.fulfillReactionHandler0=g;m.rejectReactionHandler0=d;m.reactionCapability0=i}else{var w=3*(m.reactionLength-1);m[w+l]=g;m[w+p]=d;m[w+v]=i}m.reactionLength+=1}else if(m.state===s){O=m.result;h(g,i,O)}else if(m.state===c){O=m.result;h(d,i,O)}else{throw new TypeError("unexpected Promise state")}return i.promise}});y=new r(E);I=T.then;return E}();if(S.Promise){delete S.Promise.accept;delete S.Promise.defer;delete S.Promise.prototype.chain}if(typeof zr==="function"){b(S,{Promise:zr});var qr=w(S.Promise,function(e){return e.resolve(42).then(function(){})instanceof e});var Wr=!i(function(){return S.Promise.reject(42).then(null,5).then(null,G)});var Gr=i(function(){return S.Promise.call(3,G)});var Hr=function(e){var t=e.resolve(5);t.constructor={};var r=e.resolve(t);try{r.then(null,G).then(null,G)}catch(n){return true}return t===r}(S.Promise);var Vr=s&&function(){var e=0;var t=Object.defineProperty({},"then",{get:function(){e+=1}});Promise.resolve(t);return e===1}();var Br=function BadResolverPromise(e){var t=new Promise(e);e(3,function(){});this.then=t.then;this.constructor=BadResolverPromise};Br.prototype=Promise.prototype;Br.all=Promise.all;var Ur=a(function(){return!!Br.all([1,2])});if(!qr||!Wr||!Gr||Hr||!Vr||Ur){Promise=zr;oe(S,"Promise",zr)}if(Promise.all.length!==1){var $r=Promise.all;oe(Promise,"all",function all(e){return le.Call($r,this,arguments)})}if(Promise.race.length!==1){var Jr=Promise.race;oe(Promise,"race",function race(e){return le.Call(Jr,this,arguments)})}if(Promise.resolve.length!==1){var Xr=Promise.resolve;oe(Promise,"resolve",function resolve(e){return le.Call(Xr,this,arguments)})}if(Promise.reject.length!==1){var Kr=Promise.reject;oe(Promise,"reject",function reject(e){return le.Call(Kr,this,arguments)})}Nt(Promise,"all");Nt(Promise,"race");Nt(Promise,"resolve");Nt(Promise,"reject");Me(Promise)}var Zr=function(e){var t=n(p(e,function(e,t){e[t]=true;return e},{}));return e.join(":")===t.join(":")};var Yr=Zr(["z","a","bb"]);var Qr=Zr(["z",1,"a","3",2]);if(s){var en=function fastkey(e,t){if(!t&&!Yr){return null}if(ce(e)){return"^"+le.ToString(e)}else if(typeof e==="string"){return"$"+e}else if(typeof e==="number"){if(!Qr){return"n"+e}return e}else if(typeof e==="boolean"){return"b"+e}return null};var tn=function emptyObject(){return Object.create?Object.create(null):{}};var rn=function addIterableToMap(e,n,o){if(r(o)||ne.string(o)){l(o,function(e){if(!le.TypeIsObject(e)){throw new TypeError("Iterator value "+e+" is not an entry object")}n.set(e[0],e[1])})}else if(o instanceof e){t(e.prototype.forEach,o,function(e,t){n.set(t,e)})}else{var i,a;if(!ce(o)){a=n.set;if(!le.IsCallable(a)){throw new TypeError("bad map")}i=le.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=le.IteratorStep(i);if(u===false){break}var f=u.value;try{if(!le.TypeIsObject(f)){throw new TypeError("Iterator value "+f+" is not an entry object")}t(a,n,f[0],f[1])}catch(s){le.IteratorClose(i,true);throw s}}}}};var nn=function addIterableToSet(e,n,o){if(r(o)||ne.string(o)){l(o,function(e){n.add(e)})}else if(o instanceof e){t(e.prototype.forEach,o,function(e){n.add(e)})}else{var i,a;if(!ce(o)){a=n.add;if(!le.IsCallable(a)){throw new TypeError("bad set")}i=le.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=le.IteratorStep(i);if(u===false){break}var f=u.value;try{t(a,n,f)}catch(s){le.IteratorClose(i,true);throw s}}}}};var on={Map:function(){var e={};var r=function MapEntry(e,t){this.key=e;this.value=t;this.next=null;this.prev=null};r.prototype.isRemoved=function isRemoved(){return this.key===e};var n=function isMap(e){return!!e._es6map};var o=function requireMapSlot(e,t){if(!le.TypeIsObject(e)||!n(e)){throw new TypeError("Method Map.prototype."+t+" called on incompatible receiver "+le.ToString(e))}};var i=function MapIterator(e,t){o(e,"[[MapIterator]]");h(this,"head",e._head);h(this,"i",this.head);h(this,"kind",t)};i.prototype={isMapIterator:true,next:function next(){if(!this.isMapIterator){throw new TypeError("Not a MapIterator")}var e=this.i;var t=this.kind;var r=this.head;if(typeof this.i==="undefined"){return Ze()}while(e.isRemoved()&&e!==r){e=e.prev}var n;while(e.next!==r){e=e.next;if(!e.isRemoved()){if(t==="key"){n=e.key}else if(t==="value"){n=e.value}else{n=[e.key,e.value]}this.i=e;return Ze(n)}}this.i=void 0;return Ze()}};xe(i.prototype);var a;var u=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}if(this&&this._es6map){throw new TypeError("Bad construction")}var e=_e(this,Map,a,{_es6map:true,_head:null,_map:H?new H:null,_size:0,_storage:tn()});var t=new r(null,null);t.next=t.prev=t;e._head=t;if(arguments.length>0){rn(Map,e,arguments[0])}return e};a=u.prototype;m.getter(a,"size",function(){if(typeof this._size==="undefined"){throw new TypeError("size method called on incompatible Map")}return this._size});b(a,{get:function get(e){o(this,"get");var t;var r=en(e,true);if(r!==null){t=this._storage[r];if(t){return t.value}return}if(this._map){t=B.call(this._map,e);if(t){return t.value}return}var n=this._head;var i=n;while((i=i.next)!==n){if(le.SameValueZero(i.key,e)){return i.value}}},has:function has(e){o(this,"has");var t=en(e,true);if(t!==null){return typeof this._storage[t]!=="undefined"}if(this._map){return U.call(this._map,e)}var r=this._head;var n=r;while((n=n.next)!==r){if(le.SameValueZero(n.key,e)){return true}}return false},set:function set(e,t){o(this,"set");var n=this._head;var i=n;var a;var u=en(e,true);if(u!==null){if(typeof this._storage[u]!=="undefined"){this._storage[u].value=t;return this}a=this._storage[u]=new r(e,t);i=n.prev}else if(this._map){if(U.call(this._map,e)){B.call(this._map,e).value=t}else{a=new r(e,t);$.call(this._map,e,a);i=n.prev}}while((i=i.next)!==n){if(le.SameValueZero(i.key,e)){i.value=t;return this}}a=a||new r(e,t);if(le.SameValue(-0,e)){a.key=+0}a.next=this._head;a.prev=this._head.prev;a.prev.next=a;a.next.prev=a;this._size+=1;return this},"delete":function(t){o(this,"delete");var r=this._head;var n=r;var i=en(t,true);if(i!==null){if(typeof this._storage[i]==="undefined"){return false}n=this._storage[i].prev;delete this._storage[i]}else if(this._map){if(!U.call(this._map,t)){return false}n=B.call(this._map,t).prev;V.call(this._map,t)}while((n=n.next)!==r){if(le.SameValueZero(n.key,t)){n.key=e;n.value=e;n.prev.next=n.next;n.next.prev=n.prev;this._size-=1;return true}}return false},clear:function clear(){o(this,"clear");this._map=H?new H:null;this._size=0;this._storage=tn();var t=this._head;var r=t;var n=r.next;while((r=n)!==t){r.key=e;r.value=e;n=r.next;r.next=r.prev=t}t.next=t.prev=t},keys:function keys(){o(this,"keys");return new i(this,"key")},values:function values(){o(this,"values");return new i(this,"value")},entries:function entries(){o(this,"entries");return new i(this,"key+value")},forEach:function forEach(e){o(this,"forEach");var r=arguments.length>1?arguments[1]:null;var n=this.entries();for(var i=n.next();!i.done;i=n.next()){if(r){t(e,r,i.value[1],i.value[0],this)}else{e(i.value[1],i.value[0],this)}}}});xe(a,a.entries);return u}(),Set:function(){var e=function isSet(e){return e._es6set&&typeof e._storage!=="undefined"};var r=function requireSetSlot(t,r){if(!le.TypeIsObject(t)||!e(t)){throw new TypeError("Set.prototype."+r+" called on incompatible receiver "+le.ToString(t))}};var o;var i=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}if(this&&this._es6set){throw new TypeError("Bad construction")}var e=_e(this,Set,o,{_es6set:true,"[[SetData]]":null,_storage:tn()});if(!e._es6set){throw new TypeError("bad set")}if(arguments.length>0){nn(Set,e,arguments[0])}return e};o=i.prototype;var a=function(e){var t=e;if(t==="^null"){return null}else if(t==="^undefined"){return void 0}var r=t.charAt(0);if(r==="$"){return C(t,1)}else if(r==="n"){return+C(t,1)}else if(r==="b"){return t==="btrue"}return+t};var u=function ensureMap(e){if(!e["[[SetData]]"]){var t=new on.Map;e["[[SetData]]"]=t;l(n(e._storage),function(e){var r=a(e);t.set(r,r)});e["[[SetData]]"]=t}e._storage=null};m.getter(i.prototype,"size",function(){r(this,"size");if(this._storage){return n(this._storage).length}u(this);return this["[[SetData]]"].size});b(i.prototype,{has:function has(e){r(this,"has");var t;if(this._storage&&(t=en(e))!==null){return!!this._storage[t]}u(this);return this["[[SetData]]"].has(e)},add:function add(e){r(this,"add");var t;if(this._storage&&(t=en(e))!==null){this._storage[t]=true;return this}u(this);this["[[SetData]]"].set(e,e);return this},"delete":function(e){r(this,"delete");var t;if(this._storage&&(t=en(e))!==null){var n=q(this._storage,t);return delete this._storage[t]&&n}u(this);return this["[[SetData]]"]["delete"](e)},clear:function clear(){r(this,"clear");if(this._storage){this._storage=tn()}if(this["[[SetData]]"]){this["[[SetData]]"].clear()}},values:function values(){r(this,"values");u(this);return new f(this["[[SetData]]"].values())},entries:function entries(){r(this,"entries");u(this);return new f(this["[[SetData]]"].entries())},forEach:function forEach(e){r(this,"forEach");var n=arguments.length>1?arguments[1]:null;var o=this;u(o);this["[[SetData]]"].forEach(function(r,i){if(n){t(e,n,i,i,o)}else{e(i,i,o)}})}});h(i.prototype,"keys",i.prototype.values,true);xe(i.prototype,i.prototype.values);var f=function SetIterator(e){h(this,"it",e)};f.prototype={isSetIterator:true,next:function next(){if(!this.isSetIterator){throw new TypeError("Not a SetIterator")}return this.it.next()}};xe(f.prototype);return i}()};var an=S.Set&&!Set.prototype["delete"]&&Set.prototype.remove&&Set.prototype.items&&Set.prototype.map&&Array.isArray((new Set).keys);if(an){S.Set=on.Set}if(S.Map||S.Set){var un=a(function(){return new Map([[1,2]]).get(1)===2});if(!un){S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new H;if(arguments.length>0){rn(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,S.Map.prototype);return e};S.Map.prototype=O(H.prototype);h(S.Map.prototype,"constructor",S.Map,true);m.preserveToString(S.Map,H)}var fn=new Map;var sn=function(){var e=new Map([[1,0],[2,0],[3,0],[4,0]]);e.set(-0,e);return e.get(0)===e&&e.get(-0)===e&&e.has(0)&&e.has(-0)}();var cn=fn.set(1,2)===fn;if(!sn||!cn){oe(Map.prototype,"set",function set(e,r){t($,this,e===0?0:e,r);return this})}if(!sn){b(Map.prototype,{get:function get(e){return t(B,this,e===0?0:e)},has:function has(e){return t(U,this,e===0?0:e)}},true);m.preserveToString(Map.prototype.get,B);m.preserveToString(Map.prototype.has,U)}var ln=new Set;var pn=Set.prototype["delete"]&&Set.prototype.add&&Set.prototype.has&&function(e){e["delete"](0);e.add(-0);return!e.has(0)}(ln);var vn=ln.add(1)===ln;if(!pn||!vn){var yn=Set.prototype.add;Set.prototype.add=function add(e){t(yn,this,e===0?0:e);return this};m.preserveToString(Set.prototype.add,yn)}if(!pn){var hn=Set.prototype.has;Set.prototype.has=function has(e){return t(hn,this,e===0?0:e)};m.preserveToString(Set.prototype.has,hn);var bn=Set.prototype["delete"];Set.prototype["delete"]=function SetDelete(e){return t(bn,this,e===0?0:e)};m.preserveToString(Set.prototype["delete"],bn)}var gn=w(S.Map,function(e){var t=new e([]);t.set(42,42);return t instanceof e});var dn=Object.setPrototypeOf&&!gn;var mn=function(){try{return!(S.Map()instanceof S.Map)}catch(e){return e instanceof TypeError}}();if(S.Map.length!==0||dn||!mn){S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new H;if(arguments.length>0){rn(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Map.prototype);return e};S.Map.prototype=H.prototype;h(S.Map.prototype,"constructor",S.Map,true);m.preserveToString(S.Map,H)}var On=w(S.Set,function(e){var t=new e([]);t.add(42,42);return t instanceof e});var wn=Object.setPrototypeOf&&!On;var jn=function(){try{return!(S.Set()instanceof S.Set)}catch(e){return e instanceof TypeError}}();if(S.Set.length!==0||wn||!jn){var Sn=S.Set;S.Set=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}var e=new Sn;if(arguments.length>0){nn(Set,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Set.prototype);return e};S.Set.prototype=Sn.prototype;h(S.Set.prototype,"constructor",S.Set,true);m.preserveToString(S.Set,Sn)}var Tn=new S.Map;var In=!a(function(){return Tn.keys().next().done});if(typeof S.Map.prototype.clear!=="function"||(new S.Set).size!==0||Tn.size!==0||typeof S.Map.prototype.keys!=="function"||typeof S.Set.prototype.keys!=="function"||typeof S.Map.prototype.forEach!=="function"||typeof S.Set.prototype.forEach!=="function"||u(S.Map)||u(S.Set)||typeof Tn.keys().next!=="function"||In||!gn){b(S,{Map:on.Map,Set:on.Set},true)}if(S.Set.prototype.keys!==S.Set.prototype.values){h(S.Set.prototype,"keys",S.Set.prototype.values,true)}xe(Object.getPrototypeOf((new S.Map).keys()));xe(Object.getPrototypeOf((new S.Set).keys()));if(c&&S.Set.prototype.has.name!=="has"){var En=S.Set.prototype.has;oe(S.Set.prototype,"has",function has(e){return t(En,this,e)})}}b(S,on);Me(S.Map);Me(S.Set)}var Pn=function throwUnlessTargetIsObject(e){if(!le.TypeIsObject(e)){throw new TypeError("target must be an object")}};var Cn={apply:function apply(){return le.Call(le.Call,null,arguments)},construct:function construct(e,t){if(!le.IsConstructor(e)){throw new TypeError("First argument must be a constructor.")}var r=arguments.length>2?arguments[2]:e;if(!le.IsConstructor(r)){throw new TypeError("new.target must be a constructor.")}return le.Construct(e,t,r,"internal")},deleteProperty:function deleteProperty(e,t){Pn(e);if(s){var r=Object.getOwnPropertyDescriptor(e,t);if(r&&!r.configurable){return false}}return delete e[t]},has:function has(e,t){Pn(e);return t in e}};if(Object.getOwnPropertyNames){Object.assign(Cn,{ownKeys:function ownKeys(e){Pn(e);var t=Object.getOwnPropertyNames(e);if(le.IsCallable(Object.getOwnPropertySymbols)){x(t,Object.getOwnPropertySymbols(e))}return t}})}var Mn=function ConvertExceptionToBoolean(e){return!i(e)};if(Object.preventExtensions){Object.assign(Cn,{isExtensible:function isExtensible(e){Pn(e);return Object.isExtensible(e)},preventExtensions:function preventExtensions(e){Pn(e);return Mn(function(){return Object.preventExtensions(e)})}})}if(s){var xn=function get(e,t,r){var n=Object.getOwnPropertyDescriptor(e,t);if(!n){var o=Object.getPrototypeOf(e);if(o===null){return void 0}return xn(o,t,r)}if("value"in n){return n.value}if(n.get){return le.Call(n.get,r)}return void 0};var Nn=function set(e,r,n,o){var i=Object.getOwnPropertyDescriptor(e,r);if(!i){var a=Object.getPrototypeOf(e);if(a!==null){return Nn(a,r,n,o)}i={value:void 0,writable:true,enumerable:true,configurable:true}}if("value"in i){if(!i.writable){return false}if(!le.TypeIsObject(o)){return false}var u=Object.getOwnPropertyDescriptor(o,r);if(u){return ue.defineProperty(o,r,{value:n})}return ue.defineProperty(o,r,{value:n,writable:true,enumerable:true,configurable:true})}if(i.set){t(i.set,o,n);return true}return false};Object.assign(Cn,{defineProperty:function defineProperty(e,t,r){Pn(e);return Mn(function(){return Object.defineProperty(e,t,r)})},getOwnPropertyDescriptor:function getOwnPropertyDescriptor(e,t){Pn(e);return Object.getOwnPropertyDescriptor(e,t)},get:function get(e,t){Pn(e);var r=arguments.length>2?arguments[2]:e;return xn(e,t,r)},set:function set(e,t,r){Pn(e);var n=arguments.length>3?arguments[3]:e;return Nn(e,t,r,n)}})}if(Object.getPrototypeOf){var An=Object.getPrototypeOf;Cn.getPrototypeOf=function getPrototypeOf(e){Pn(e);return An(e)}}if(Object.setPrototypeOf&&Cn.getPrototypeOf){var _n=function(e,t){var r=t;while(r){if(e===r){return true}r=Cn.getPrototypeOf(r)}return false};Object.assign(Cn,{setPrototypeOf:function setPrototypeOf(e,t){Pn(e);if(t!==null&&!le.TypeIsObject(t)){throw new TypeError("proto must be an object or null")}if(t===ue.getPrototypeOf(e)){return true}if(ue.isExtensible&&!ue.isExtensible(e)){return false}if(_n(e,t)){return false}Object.setPrototypeOf(e,t);return true}})}var Rn=function(e,t){if(!le.IsCallable(S.Reflect[e])){h(S.Reflect,e,t)}else{var r=a(function(){S.Reflect[e](1);S.Reflect[e](NaN);S.Reflect[e](true);return true});if(r){oe(S.Reflect,e,t)}}};Object.keys(Cn).forEach(function(e){Rn(e,Cn[e])});var kn=S.Reflect.getPrototypeOf;if(c&&kn&&kn.name!=="getPrototypeOf"){oe(S.Reflect,"getPrototypeOf",function getPrototypeOf(e){return t(kn,S.Reflect,e)})}if(S.Reflect.setPrototypeOf){if(a(function(){S.Reflect.setPrototypeOf(1,{});return true})){oe(S.Reflect,"setPrototypeOf",Cn.setPrototypeOf)}}if(S.Reflect.defineProperty){if(!a(function(){var e=!S.Reflect.defineProperty(1,"test",{value:1});var t=typeof Object.preventExtensions!=="function"||!S.Reflect.defineProperty(Object.preventExtensions({}),"test",{});return e&&t})){oe(S.Reflect,"defineProperty",Cn.defineProperty)}}if(S.Reflect.construct){if(!a(function(){var e=function F(){};return S.Reflect.construct(function(){},[],e)instanceof e})){oe(S.Reflect,"construct",Cn.construct)}}if(String(new Date(NaN))!=="Invalid Date"){var Ln=Date.prototype.toString;var Fn=function toString(){var e=+this;if(e!==e){return"Invalid Date"}return le.Call(Ln,this)};oe(Date.prototype,"toString",Fn)}var Dn={anchor:function anchor(e){return le.CreateHTML(this,"a","name",e)},big:function big(){return le.CreateHTML(this,"big","","")},blink:function blink(){return le.CreateHTML(this,"blink","","")},bold:function bold(){return le.CreateHTML(this,"b","","")},fixed:function fixed(){return le.CreateHTML(this,"tt","","")},fontcolor:function fontcolor(e){return le.CreateHTML(this,"font","color",e)},fontsize:function fontsize(e){return le.CreateHTML(this,"font","size",e)},italics:function italics(){return le.CreateHTML(this,"i","","")},link:function link(e){return le.CreateHTML(this,"a","href",e)},small:function small(){return le.CreateHTML(this,"small","","")},strike:function strike(){return le.CreateHTML(this,"strike","","")},sub:function sub(){return le.CreateHTML(this,"sub","","")},sup:function sub(){return le.CreateHTML(this,"sup","","")}};l(Object.keys(Dn),function(e){var r=String.prototype[e];var n=false;if(le.IsCallable(r)){var o=t(r,"",' " ');var i=P([],o.match(/"/g)).length;n=o!==o.toLowerCase()||i>2}else{n=true}if(n){oe(String.prototype,e,Dn[e])}});var zn=function(){if(!ie){return false}var e=typeof JSON==="object"&&typeof JSON.stringify==="function"?JSON.stringify:null;if(!e){return false}if(typeof e(J())!=="undefined"){return true}if(e([J()])!=="[null]"){return true}var t={a:J()};t[J()]=true;if(e(t)!=="{}"){return true}return false}();var qn=a(function(){if(!ie){return true}return JSON.stringify(Object(J()))==="{}"&&JSON.stringify([Object(J())])==="[{}]"});if(zn||!qn){var Wn=JSON.stringify;oe(JSON,"stringify",function stringify(e){if(typeof e==="symbol"){return}var n;if(arguments.length>1){n=arguments[1]}var o=[e];if(!r(n)){var i=le.IsCallable(n)?n:null;var a=function(e,r){var n=i?t(i,this,e,r):r;if(typeof n!=="symbol"){if(ne.symbol(n)){return _t({})(n)}return n}};o.push(a)}else{o.push(n)}if(arguments.length>2){o.push(arguments[2])}return Wn.apply(this,o)})}return S});
//# sourceMappingURL=es6-shim.map
/*! jQuery v3.7.1 | (c) OpenJS Foundation and other contributors | jquery.org/license */
!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(ie,e){"use strict";var oe=[],r=Object.getPrototypeOf,ae=oe.slice,g=oe.flat?function(e){return oe.flat.call(e)}:function(e){return oe.concat.apply([],e)},s=oe.push,se=oe.indexOf,n={},i=n.toString,ue=n.hasOwnProperty,o=ue.toString,a=o.call(Object),le={},v=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType&&"function"!=typeof e.item},y=function(e){return null!=e&&e===e.window},C=ie.document,u={type:!0,src:!0,nonce:!0,noModule:!0};function m(e,t,n){var r,i,o=(n=n||C).createElement("script");if(o.text=e,t)for(r in u)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,i);n.head.appendChild(o).parentNode.removeChild(o)}function x(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[i.call(e)]||"object":typeof e}var t="3.7.1",l=/HTML$/i,ce=function(e,t){return new ce.fn.init(e,t)};function c(e){var t=!!e&&"length"in e&&e.length,n=x(e);return!v(e)&&!y(e)&&("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e)}function fe(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}ce.fn=ce.prototype={jquery:t,constructor:ce,length:0,toArray:function(){return ae.call(this)},get:function(e){return null==e?ae.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=ce.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return ce.each(this,e)},map:function(n){return this.pushStack(ce.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(ae.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(ce.grep(this,function(e,t){return(t+1)%2}))},odd:function(){return this.pushStack(ce.grep(this,function(e,t){return t%2}))},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:s,sort:oe.sort,splice:oe.splice},ce.extend=ce.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||v(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&a!==r&&(l&&r&&(ce.isPlainObject(r)||(i=Array.isArray(r)))?(n=a[t],o=i&&!Array.isArray(n)?[]:i||ce.isPlainObject(n)?n:{},i=!1,a[t]=ce.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},ce.extend({expando:"jQuery"+(t+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==i.call(e))&&(!(t=r(e))||"function"==typeof(n=ue.call(t,"constructor")&&t.constructor)&&o.call(n)===a)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t,n){m(e,{nonce:t&&t.nonce},n)},each:function(e,t){var n,r=0;if(c(e)){for(n=e.length;r<n;r++)if(!1===t.call(e[r],r,e[r]))break}else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},text:function(e){var t,n="",r=0,i=e.nodeType;if(!i)while(t=e[r++])n+=ce.text(t);return 1===i||11===i?e.textContent:9===i?e.documentElement.textContent:3===i||4===i?e.nodeValue:n},makeArray:function(e,t){var n=t||[];return null!=e&&(c(Object(e))?ce.merge(n,"string"==typeof e?[e]:e):s.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:se.call(t,e,n)},isXMLDoc:function(e){var t=e&&e.namespaceURI,n=e&&(e.ownerDocument||e).documentElement;return!l.test(t||n&&n.nodeName||"HTML")},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,a=[];if(c(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&a.push(i);return g(a)},guid:1,support:le}),"function"==typeof Symbol&&(ce.fn[Symbol.iterator]=oe[Symbol.iterator]),ce.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var pe=oe.pop,de=oe.sort,he=oe.splice,ge="[\\x20\\t\\r\\n\\f]",ve=new RegExp("^"+ge+"+|((?:^|[^\\\\])(?:\\\\.)*)"+ge+"+$","g");ce.contains=function(e,t){var n=t&&t.parentNode;return e===n||!(!n||1!==n.nodeType||!(e.contains?e.contains(n):e.compareDocumentPosition&&16&e.compareDocumentPosition(n)))};var f=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g;function p(e,t){return t?"\0"===e?"\ufffd":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e}ce.escapeSelector=function(e){return(e+"").replace(f,p)};var ye=C,me=s;!function(){var e,b,w,o,a,T,r,C,d,i,k=me,S=ce.expando,E=0,n=0,s=W(),c=W(),u=W(),h=W(),l=function(e,t){return e===t&&(a=!0),0},f="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",t="(?:\\\\[\\da-fA-F]{1,6}"+ge+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",p="\\["+ge+"*("+t+")(?:"+ge+"*([*^$|!~]?=)"+ge+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+t+"))|)"+ge+"*\\]",g=":("+t+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+p+")*)|.*)\\)|)",v=new RegExp(ge+"+","g"),y=new RegExp("^"+ge+"*,"+ge+"*"),m=new RegExp("^"+ge+"*([>+~]|"+ge+")"+ge+"*"),x=new RegExp(ge+"|>"),j=new RegExp(g),A=new RegExp("^"+t+"$"),D={ID:new RegExp("^#("+t+")"),CLASS:new RegExp("^\\.("+t+")"),TAG:new RegExp("^("+t+"|[*])"),ATTR:new RegExp("^"+p),PSEUDO:new RegExp("^"+g),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+ge+"*(even|odd|(([+-]|)(\\d*)n|)"+ge+"*(?:([+-]|)"+ge+"*(\\d+)|))"+ge+"*\\)|)","i"),bool:new RegExp("^(?:"+f+")$","i"),needsContext:new RegExp("^"+ge+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+ge+"*((?:-\\d)?\\d*)"+ge+"*\\)|)(?=[^-]|$)","i")},N=/^(?:input|select|textarea|button)$/i,q=/^h\d$/i,L=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,H=/[+~]/,O=new RegExp("\\\\[\\da-fA-F]{1,6}"+ge+"?|\\\\([^\\r\\n\\f])","g"),P=function(e,t){var n="0x"+e.slice(1)-65536;return t||(n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320))},M=function(){V()},R=J(function(e){return!0===e.disabled&&fe(e,"fieldset")},{dir:"parentNode",next:"legend"});try{k.apply(oe=ae.call(ye.childNodes),ye.childNodes),oe[ye.childNodes.length].nodeType}catch(e){k={apply:function(e,t){me.apply(e,ae.call(t))},call:function(e){me.apply(e,ae.call(arguments,1))}}}function I(t,e,n,r){var i,o,a,s,u,l,c,f=e&&e.ownerDocument,p=e?e.nodeType:9;if(n=n||[],"string"!=typeof t||!t||1!==p&&9!==p&&11!==p)return n;if(!r&&(V(e),e=e||T,C)){if(11!==p&&(u=L.exec(t)))if(i=u[1]){if(9===p){if(!(a=e.getElementById(i)))return n;if(a.id===i)return k.call(n,a),n}else if(f&&(a=f.getElementById(i))&&I.contains(e,a)&&a.id===i)return k.call(n,a),n}else{if(u[2])return k.apply(n,e.getElementsByTagName(t)),n;if((i=u[3])&&e.getElementsByClassName)return k.apply(n,e.getElementsByClassName(i)),n}if(!(h[t+" "]||d&&d.test(t))){if(c=t,f=e,1===p&&(x.test(t)||m.test(t))){(f=H.test(t)&&U(e.parentNode)||e)==e&&le.scope||((s=e.getAttribute("id"))?s=ce.escapeSelector(s):e.setAttribute("id",s=S)),o=(l=Y(t)).length;while(o--)l[o]=(s?"#"+s:":scope")+" "+Q(l[o]);c=l.join(",")}try{return k.apply(n,f.querySelectorAll(c)),n}catch(e){h(t,!0)}finally{s===S&&e.removeAttribute("id")}}}return re(t.replace(ve,"$1"),e,n,r)}function W(){var r=[];return function e(t,n){return r.push(t+" ")>b.cacheLength&&delete e[r.shift()],e[t+" "]=n}}function F(e){return e[S]=!0,e}function $(e){var t=T.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function B(t){return function(e){return fe(e,"input")&&e.type===t}}function _(t){return function(e){return(fe(e,"input")||fe(e,"button"))&&e.type===t}}function z(t){return function(e){return"form"in e?e.parentNode&&!1===e.disabled?"label"in e?"label"in e.parentNode?e.parentNode.disabled===t:e.disabled===t:e.isDisabled===t||e.isDisabled!==!t&&R(e)===t:e.disabled===t:"label"in e&&e.disabled===t}}function X(a){return F(function(o){return o=+o,F(function(e,t){var n,r=a([],e.length,o),i=r.length;while(i--)e[n=r[i]]&&(e[n]=!(t[n]=e[n]))})})}function U(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}function V(e){var t,n=e?e.ownerDocument||e:ye;return n!=T&&9===n.nodeType&&n.documentElement&&(r=(T=n).documentElement,C=!ce.isXMLDoc(T),i=r.matches||r.webkitMatchesSelector||r.msMatchesSelector,r.msMatchesSelector&&ye!=T&&(t=T.defaultView)&&t.top!==t&&t.addEventListener("unload",M),le.getById=$(function(e){return r.appendChild(e).id=ce.expando,!T.getElementsByName||!T.getElementsByName(ce.expando).length}),le.disconnectedMatch=$(function(e){return i.call(e,"*")}),le.scope=$(function(){return T.querySelectorAll(":scope")}),le.cssHas=$(function(){try{return T.querySelector(":has(*,:jqfake)"),!1}catch(e){return!0}}),le.getById?(b.filter.ID=function(e){var t=e.replace(O,P);return function(e){return e.getAttribute("id")===t}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&C){var n=t.getElementById(e);return n?[n]:[]}}):(b.filter.ID=function(e){var n=e.replace(O,P);return function(e){var t="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===n}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&C){var n,r,i,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];i=t.getElementsByName(e),r=0;while(o=i[r++])if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),b.find.TAG=function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):t.querySelectorAll(e)},b.find.CLASS=function(e,t){if("undefined"!=typeof t.getElementsByClassName&&C)return t.getElementsByClassName(e)},d=[],$(function(e){var t;r.appendChild(e).innerHTML="<a id='"+S+"' href='' disabled='disabled'></a><select id='"+S+"-\r\\' disabled='disabled'><option selected=''></option></select>",e.querySelectorAll("[selected]").length||d.push("\\["+ge+"*(?:value|"+f+")"),e.querySelectorAll("[id~="+S+"-]").length||d.push("~="),e.querySelectorAll("a#"+S+"+*").length||d.push(".#.+[+~]"),e.querySelectorAll(":checked").length||d.push(":checked"),(t=T.createElement("input")).setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),r.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&d.push(":enabled",":disabled"),(t=T.createElement("input")).setAttribute("name",""),e.appendChild(t),e.querySelectorAll("[name='']").length||d.push("\\["+ge+"*name"+ge+"*="+ge+"*(?:''|\"\")")}),le.cssHas||d.push(":has"),d=d.length&&new RegExp(d.join("|")),l=function(e,t){if(e===t)return a=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)==(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!le.sortDetached&&t.compareDocumentPosition(e)===n?e===T||e.ownerDocument==ye&&I.contains(ye,e)?-1:t===T||t.ownerDocument==ye&&I.contains(ye,t)?1:o?se.call(o,e)-se.call(o,t):0:4&n?-1:1)}),T}for(e in I.matches=function(e,t){return I(e,null,null,t)},I.matchesSelector=function(e,t){if(V(e),C&&!h[t+" "]&&(!d||!d.test(t)))try{var n=i.call(e,t);if(n||le.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){h(t,!0)}return 0<I(t,T,null,[e]).length},I.contains=function(e,t){return(e.ownerDocument||e)!=T&&V(e),ce.contains(e,t)},I.attr=function(e,t){(e.ownerDocument||e)!=T&&V(e);var n=b.attrHandle[t.toLowerCase()],r=n&&ue.call(b.attrHandle,t.toLowerCase())?n(e,t,!C):void 0;return void 0!==r?r:e.getAttribute(t)},I.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},ce.uniqueSort=function(e){var t,n=[],r=0,i=0;if(a=!le.sortStable,o=!le.sortStable&&ae.call(e,0),de.call(e,l),a){while(t=e[i++])t===e[i]&&(r=n.push(i));while(r--)he.call(e,n[r],1)}return o=null,e},ce.fn.uniqueSort=function(){return this.pushStack(ce.uniqueSort(ae.apply(this)))},(b=ce.expr={cacheLength:50,createPseudo:F,match:D,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(O,P),e[3]=(e[3]||e[4]||e[5]||"").replace(O,P),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||I.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&I.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return D.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&j.test(n)&&(t=Y(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(O,P).toLowerCase();return"*"===e?function(){return!0}:function(e){return fe(e,t)}},CLASS:function(e){var t=s[e+" "];return t||(t=new RegExp("(^|"+ge+")"+e+"("+ge+"|$)"))&&s(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(n,r,i){return function(e){var t=I.attr(e,n);return null==t?"!="===r:!r||(t+="","="===r?t===i:"!="===r?t!==i:"^="===r?i&&0===t.indexOf(i):"*="===r?i&&-1<t.indexOf(i):"$="===r?i&&t.slice(-i.length)===i:"~="===r?-1<(" "+t.replace(v," ")+" ").indexOf(i):"|="===r&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(d,e,t,h,g){var v="nth"!==d.slice(0,3),y="last"!==d.slice(-4),m="of-type"===e;return 1===h&&0===g?function(e){return!!e.parentNode}:function(e,t,n){var r,i,o,a,s,u=v!==y?"nextSibling":"previousSibling",l=e.parentNode,c=m&&e.nodeName.toLowerCase(),f=!n&&!m,p=!1;if(l){if(v){while(u){o=e;while(o=o[u])if(m?fe(o,c):1===o.nodeType)return!1;s=u="only"===d&&!s&&"nextSibling"}return!0}if(s=[y?l.firstChild:l.lastChild],y&&f){p=(a=(r=(i=l[S]||(l[S]={}))[d]||[])[0]===E&&r[1])&&r[2],o=a&&l.childNodes[a];while(o=++a&&o&&o[u]||(p=a=0)||s.pop())if(1===o.nodeType&&++p&&o===e){i[d]=[E,a,p];break}}else if(f&&(p=a=(r=(i=e[S]||(e[S]={}))[d]||[])[0]===E&&r[1]),!1===p)while(o=++a&&o&&o[u]||(p=a=0)||s.pop())if((m?fe(o,c):1===o.nodeType)&&++p&&(f&&((i=o[S]||(o[S]={}))[d]=[E,p]),o===e))break;return(p-=g)===h||p%h==0&&0<=p/h}}},PSEUDO:function(e,o){var t,a=b.pseudos[e]||b.setFilters[e.toLowerCase()]||I.error("unsupported pseudo: "+e);return a[S]?a(o):1<a.length?(t=[e,e,"",o],b.setFilters.hasOwnProperty(e.toLowerCase())?F(function(e,t){var n,r=a(e,o),i=r.length;while(i--)e[n=se.call(e,r[i])]=!(t[n]=r[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:F(function(e){var r=[],i=[],s=ne(e.replace(ve,"$1"));return s[S]?F(function(e,t,n,r){var i,o=s(e,null,r,[]),a=e.length;while(a--)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,n){return r[0]=e,s(r,null,n,i),r[0]=null,!i.pop()}}),has:F(function(t){return function(e){return 0<I(t,e).length}}),contains:F(function(t){return t=t.replace(O,P),function(e){return-1<(e.textContent||ce.text(e)).indexOf(t)}}),lang:F(function(n){return A.test(n||"")||I.error("unsupported lang: "+n),n=n.replace(O,P).toLowerCase(),function(e){var t;do{if(t=C?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=ie.location&&ie.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===r},focus:function(e){return e===function(){try{return T.activeElement}catch(e){}}()&&T.hasFocus()&&!!(e.type||e.href||~e.tabIndex)},enabled:z(!1),disabled:z(!0),checked:function(e){return fe(e,"input")&&!!e.checked||fe(e,"option")&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return q.test(e.nodeName)},input:function(e){return N.test(e.nodeName)},button:function(e){return fe(e,"input")&&"button"===e.type||fe(e,"button")},text:function(e){var t;return fe(e,"input")&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:X(function(){return[0]}),last:X(function(e,t){return[t-1]}),eq:X(function(e,t,n){return[n<0?n+t:n]}),even:X(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:X(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:X(function(e,t,n){var r;for(r=n<0?n+t:t<n?t:n;0<=--r;)e.push(r);return e}),gt:X(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=B(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=_(e);function G(){}function Y(e,t){var n,r,i,o,a,s,u,l=c[e+" "];if(l)return t?0:l.slice(0);a=e,s=[],u=b.preFilter;while(a){for(o in n&&!(r=y.exec(a))||(r&&(a=a.slice(r[0].length)||a),s.push(i=[])),n=!1,(r=m.exec(a))&&(n=r.shift(),i.push({value:n,type:r[0].replace(ve," ")}),a=a.slice(n.length)),b.filter)!(r=D[o].exec(a))||u[o]&&!(r=u[o](r))||(n=r.shift(),i.push({value:n,type:o,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?I.error(e):c(e,s).slice(0)}function Q(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function J(a,e,t){var s=e.dir,u=e.next,l=u||s,c=t&&"parentNode"===l,f=n++;return e.first?function(e,t,n){while(e=e[s])if(1===e.nodeType||c)return a(e,t,n);return!1}:function(e,t,n){var r,i,o=[E,f];if(n){while(e=e[s])if((1===e.nodeType||c)&&a(e,t,n))return!0}else while(e=e[s])if(1===e.nodeType||c)if(i=e[S]||(e[S]={}),u&&fe(e,u))e=e[s]||e;else{if((r=i[l])&&r[0]===E&&r[1]===f)return o[2]=r[2];if((i[l]=o)[2]=a(e,t,n))return!0}return!1}}function K(i){return 1<i.length?function(e,t,n){var r=i.length;while(r--)if(!i[r](e,t,n))return!1;return!0}:i[0]}function Z(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function ee(d,h,g,v,y,e){return v&&!v[S]&&(v=ee(v)),y&&!y[S]&&(y=ee(y,e)),F(function(e,t,n,r){var i,o,a,s,u=[],l=[],c=t.length,f=e||function(e,t,n){for(var r=0,i=t.length;r<i;r++)I(e,t[r],n);return n}(h||"*",n.nodeType?[n]:n,[]),p=!d||!e&&h?f:Z(f,u,d,n,r);if(g?g(p,s=y||(e?d:c||v)?[]:t,n,r):s=p,v){i=Z(s,l),v(i,[],n,r),o=i.length;while(o--)(a=i[o])&&(s[l[o]]=!(p[l[o]]=a))}if(e){if(y||d){if(y){i=[],o=s.length;while(o--)(a=s[o])&&i.push(p[o]=a);y(null,s=[],i,r)}o=s.length;while(o--)(a=s[o])&&-1<(i=y?se.call(e,a):u[o])&&(e[i]=!(t[i]=a))}}else s=Z(s===t?s.splice(c,s.length):s),y?y(null,t,s,r):k.apply(t,s)})}function te(e){for(var i,t,n,r=e.length,o=b.relative[e[0].type],a=o||b.relative[" "],s=o?1:0,u=J(function(e){return e===i},a,!0),l=J(function(e){return-1<se.call(i,e)},a,!0),c=[function(e,t,n){var r=!o&&(n||t!=w)||((i=t).nodeType?u(e,t,n):l(e,t,n));return i=null,r}];s<r;s++)if(t=b.relative[e[s].type])c=[J(K(c),t)];else{if((t=b.filter[e[s].type].apply(null,e[s].matches))[S]){for(n=++s;n<r;n++)if(b.relative[e[n].type])break;return ee(1<s&&K(c),1<s&&Q(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(ve,"$1"),t,s<n&&te(e.slice(s,n)),n<r&&te(e=e.slice(n)),n<r&&Q(e))}c.push(t)}return K(c)}function ne(e,t){var n,v,y,m,x,r,i=[],o=[],a=u[e+" "];if(!a){t||(t=Y(e)),n=t.length;while(n--)(a=te(t[n]))[S]?i.push(a):o.push(a);(a=u(e,(v=o,m=0<(y=i).length,x=0<v.length,r=function(e,t,n,r,i){var o,a,s,u=0,l="0",c=e&&[],f=[],p=w,d=e||x&&b.find.TAG("*",i),h=E+=null==p?1:Math.random()||.1,g=d.length;for(i&&(w=t==T||t||i);l!==g&&null!=(o=d[l]);l++){if(x&&o){a=0,t||o.ownerDocument==T||(V(o),n=!C);while(s=v[a++])if(s(o,t||T,n)){k.call(r,o);break}i&&(E=h)}m&&((o=!s&&o)&&u--,e&&c.push(o))}if(u+=l,m&&l!==u){a=0;while(s=y[a++])s(c,f,t,n);if(e){if(0<u)while(l--)c[l]||f[l]||(f[l]=pe.call(r));f=Z(f)}k.apply(r,f),i&&!e&&0<f.length&&1<u+y.length&&ce.uniqueSort(r)}return i&&(E=h,w=p),c},m?F(r):r))).selector=e}return a}function re(e,t,n,r){var i,o,a,s,u,l="function"==typeof e&&e,c=!r&&Y(e=l.selector||e);if(n=n||[],1===c.length){if(2<(o=c[0]=c[0].slice(0)).length&&"ID"===(a=o[0]).type&&9===t.nodeType&&C&&b.relative[o[1].type]){if(!(t=(b.find.ID(a.matches[0].replace(O,P),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}i=D.needsContext.test(e)?0:o.length;while(i--){if(a=o[i],b.relative[s=a.type])break;if((u=b.find[s])&&(r=u(a.matches[0].replace(O,P),H.test(o[0].type)&&U(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&Q(o)))return k.apply(n,r),n;break}}}return(l||ne(e,c))(r,t,!C,n,!t||H.test(e)&&U(t.parentNode)||t),n}G.prototype=b.filters=b.pseudos,b.setFilters=new G,le.sortStable=S.split("").sort(l).join("")===S,V(),le.sortDetached=$(function(e){return 1&e.compareDocumentPosition(T.createElement("fieldset"))}),ce.find=I,ce.expr[":"]=ce.expr.pseudos,ce.unique=ce.uniqueSort,I.compile=ne,I.select=re,I.setDocument=V,I.tokenize=Y,I.escape=ce.escapeSelector,I.getText=ce.text,I.isXML=ce.isXMLDoc,I.selectors=ce.expr,I.support=ce.support,I.uniqueSort=ce.uniqueSort}();var d=function(e,t,n){var r=[],i=void 0!==n;while((e=e[t])&&9!==e.nodeType)if(1===e.nodeType){if(i&&ce(e).is(n))break;r.push(e)}return r},h=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},b=ce.expr.match.needsContext,w=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function T(e,n,r){return v(n)?ce.grep(e,function(e,t){return!!n.call(e,t,e)!==r}):n.nodeType?ce.grep(e,function(e){return e===n!==r}):"string"!=typeof n?ce.grep(e,function(e){return-1<se.call(n,e)!==r}):ce.filter(n,e,r)}ce.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?ce.find.matchesSelector(r,e)?[r]:[]:ce.find.matches(e,ce.grep(t,function(e){return 1===e.nodeType}))},ce.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(ce(e).filter(function(){for(t=0;t<r;t++)if(ce.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)ce.find(e,i[t],n);return 1<r?ce.uniqueSort(n):n},filter:function(e){return this.pushStack(T(this,e||[],!1))},not:function(e){return this.pushStack(T(this,e||[],!0))},is:function(e){return!!T(this,"string"==typeof e&&b.test(e)?ce(e):e||[],!1).length}});var k,S=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(ce.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||k,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:S.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof ce?t[0]:t,ce.merge(this,ce.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:C,!0)),w.test(r[1])&&ce.isPlainObject(t))for(r in t)v(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=C.getElementById(r[2]))&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):v(e)?void 0!==n.ready?n.ready(e):e(ce):ce.makeArray(e,this)}).prototype=ce.fn,k=ce(C);var E=/^(?:parents|prev(?:Until|All))/,j={children:!0,contents:!0,next:!0,prev:!0};function A(e,t){while((e=e[t])&&1!==e.nodeType);return e}ce.fn.extend({has:function(e){var t=ce(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(ce.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&ce(e);if(!b.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&ce.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?ce.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?se.call(ce(e),this[0]):se.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(ce.uniqueSort(ce.merge(this.get(),ce(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),ce.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return d(e,"parentNode")},parentsUntil:function(e,t,n){return d(e,"parentNode",n)},next:function(e){return A(e,"nextSibling")},prev:function(e){return A(e,"previousSibling")},nextAll:function(e){return d(e,"nextSibling")},prevAll:function(e){return d(e,"previousSibling")},nextUntil:function(e,t,n){return d(e,"nextSibling",n)},prevUntil:function(e,t,n){return d(e,"previousSibling",n)},siblings:function(e){return h((e.parentNode||{}).firstChild,e)},children:function(e){return h(e.firstChild)},contents:function(e){return null!=e.contentDocument&&r(e.contentDocument)?e.contentDocument:(fe(e,"template")&&(e=e.content||e),ce.merge([],e.childNodes))}},function(r,i){ce.fn[r]=function(e,t){var n=ce.map(this,i,e);return"Until"!==r.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=ce.filter(t,n)),1<this.length&&(j[r]||ce.uniqueSort(n),E.test(r)&&n.reverse()),this.pushStack(n)}});var D=/[^\x20\t\r\n\f]+/g;function N(e){return e}function q(e){throw e}function L(e,t,n,r){var i;try{e&&v(i=e.promise)?i.call(e).done(t).fail(n):e&&v(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}ce.Callbacks=function(r){var e,n;r="string"==typeof r?(e=r,n={},ce.each(e.match(D)||[],function(e,t){n[t]=!0}),n):ce.extend({},r);var i,t,o,a,s=[],u=[],l=-1,c=function(){for(a=a||r.once,o=i=!0;u.length;l=-1){t=u.shift();while(++l<s.length)!1===s[l].apply(t[0],t[1])&&r.stopOnFalse&&(l=s.length,t=!1)}r.memory||(t=!1),i=!1,a&&(s=t?[]:"")},f={add:function(){return s&&(t&&!i&&(l=s.length-1,u.push(t)),function n(e){ce.each(e,function(e,t){v(t)?r.unique&&f.has(t)||s.push(t):t&&t.length&&"string"!==x(t)&&n(t)})}(arguments),t&&!i&&c()),this},remove:function(){return ce.each(arguments,function(e,t){var n;while(-1<(n=ce.inArray(t,s,n)))s.splice(n,1),n<=l&&l--}),this},has:function(e){return e?-1<ce.inArray(e,s):0<s.length},empty:function(){return s&&(s=[]),this},disable:function(){return a=u=[],s=t="",this},disabled:function(){return!s},lock:function(){return a=u=[],t||i||(s=t=""),this},locked:function(){return!!a},fireWith:function(e,t){return a||(t=[e,(t=t||[]).slice?t.slice():t],u.push(t),i||c()),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!o}};return f},ce.extend({Deferred:function(e){var o=[["notify","progress",ce.Callbacks("memory"),ce.Callbacks("memory"),2],["resolve","done",ce.Callbacks("once memory"),ce.Callbacks("once memory"),0,"resolved"],["reject","fail",ce.Callbacks("once memory"),ce.Callbacks("once memory"),1,"rejected"]],i="pending",a={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},"catch":function(e){return a.then(null,e)},pipe:function(){var i=arguments;return ce.Deferred(function(r){ce.each(o,function(e,t){var n=v(i[t[4]])&&i[t[4]];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&v(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[t[0]+"With"](this,n?[e]:arguments)})}),i=null}).promise()},then:function(t,n,r){var u=0;function l(i,o,a,s){return function(){var n=this,r=arguments,e=function(){var e,t;if(!(i<u)){if((e=a.apply(n,r))===o.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,v(t)?s?t.call(e,l(u,o,N,s),l(u,o,q,s)):(u++,t.call(e,l(u,o,N,s),l(u,o,q,s),l(u,o,N,o.notifyWith))):(a!==N&&(n=void 0,r=[e]),(s||o.resolveWith)(n,r))}},t=s?e:function(){try{e()}catch(e){ce.Deferred.exceptionHook&&ce.Deferred.exceptionHook(e,t.error),u<=i+1&&(a!==q&&(n=void 0,r=[e]),o.rejectWith(n,r))}};i?t():(ce.Deferred.getErrorHook?t.error=ce.Deferred.getErrorHook():ce.Deferred.getStackHook&&(t.error=ce.Deferred.getStackHook()),ie.setTimeout(t))}}return ce.Deferred(function(e){o[0][3].add(l(0,e,v(r)?r:N,e.notifyWith)),o[1][3].add(l(0,e,v(t)?t:N)),o[2][3].add(l(0,e,v(n)?n:q))}).promise()},promise:function(e){return null!=e?ce.extend(e,a):a}},s={};return ce.each(o,function(e,t){var n=t[2],r=t[5];a[t[1]]=n.add,r&&n.add(function(){i=r},o[3-e][2].disable,o[3-e][3].disable,o[0][2].lock,o[0][3].lock),n.add(t[3].fire),s[t[0]]=function(){return s[t[0]+"With"](this===s?void 0:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){var n=arguments.length,t=n,r=Array(t),i=ae.call(arguments),o=ce.Deferred(),a=function(t){return function(e){r[t]=this,i[t]=1<arguments.length?ae.call(arguments):e,--n||o.resolveWith(r,i)}};if(n<=1&&(L(e,o.done(a(t)).resolve,o.reject,!n),"pending"===o.state()||v(i[t]&&i[t].then)))return o.then();while(t--)L(i[t],a(t),o.reject);return o.promise()}});var H=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;ce.Deferred.exceptionHook=function(e,t){ie.console&&ie.console.warn&&e&&H.test(e.name)&&ie.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},ce.readyException=function(e){ie.setTimeout(function(){throw e})};var O=ce.Deferred();function P(){C.removeEventListener("DOMContentLoaded",P),ie.removeEventListener("load",P),ce.ready()}ce.fn.ready=function(e){return O.then(e)["catch"](function(e){ce.readyException(e)}),this},ce.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--ce.readyWait:ce.isReady)||(ce.isReady=!0)!==e&&0<--ce.readyWait||O.resolveWith(C,[ce])}}),ce.ready.then=O.then,"complete"===C.readyState||"loading"!==C.readyState&&!C.documentElement.doScroll?ie.setTimeout(ce.ready):(C.addEventListener("DOMContentLoaded",P),ie.addEventListener("load",P));var M=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===x(n))for(s in i=!0,n)M(e,t,s,n[s],!0,o,a);else if(void 0!==r&&(i=!0,v(r)||(a=!0),l&&(a?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(ce(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},R=/^-ms-/,I=/-([a-z])/g;function W(e,t){return t.toUpperCase()}function F(e){return e.replace(R,"ms-").replace(I,W)}var $=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function B(){this.expando=ce.expando+B.uid++}B.uid=1,B.prototype={cache:function(e){var t=e[this.expando];return t||(t={},$(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[F(t)]=n;else for(r in t)i[F(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][F(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(F):(t=F(t))in r?[t]:t.match(D)||[]).length;while(n--)delete r[t[n]]}(void 0===t||ce.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!ce.isEmptyObject(t)}};var _=new B,z=new B,X=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,U=/[A-Z]/g;function V(e,t,n){var r,i;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(U,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===(i=n)||"false"!==i&&("null"===i?null:i===+i+""?+i:X.test(i)?JSON.parse(i):i)}catch(e){}z.set(e,t,n)}else n=void 0;return n}ce.extend({hasData:function(e){return z.hasData(e)||_.hasData(e)},data:function(e,t,n){return z.access(e,t,n)},removeData:function(e,t){z.remove(e,t)},_data:function(e,t,n){return _.access(e,t,n)},_removeData:function(e,t){_.remove(e,t)}}),ce.fn.extend({data:function(n,e){var t,r,i,o=this[0],a=o&&o.attributes;if(void 0===n){if(this.length&&(i=z.get(o),1===o.nodeType&&!_.get(o,"hasDataAttrs"))){t=a.length;while(t--)a[t]&&0===(r=a[t].name).indexOf("data-")&&(r=F(r.slice(5)),V(o,r,i[r]));_.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof n?this.each(function(){z.set(this,n)}):M(this,function(e){var t;if(o&&void 0===e)return void 0!==(t=z.get(o,n))?t:void 0!==(t=V(o,n))?t:void 0;this.each(function(){z.set(this,n,e)})},null,e,1<arguments.length,null,!0)},removeData:function(e){return this.each(function(){z.remove(this,e)})}}),ce.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=_.get(e,t),n&&(!r||Array.isArray(n)?r=_.access(e,t,ce.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=ce.queue(e,t),r=n.length,i=n.shift(),o=ce._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){ce.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return _.get(e,n)||_.access(e,n,{empty:ce.Callbacks("once memory").add(function(){_.remove(e,[t+"queue",n])})})}}),ce.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?ce.queue(this[0],t):void 0===n?this:this.each(function(){var e=ce.queue(this,t,n);ce._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&ce.dequeue(this,t)})},dequeue:function(e){return this.each(function(){ce.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=ce.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};"string"!=typeof e&&(t=e,e=void 0),e=e||"fx";while(a--)(n=_.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var G=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,Y=new RegExp("^(?:([+-])=|)("+G+")([a-z%]*)$","i"),Q=["Top","Right","Bottom","Left"],J=C.documentElement,K=function(e){return ce.contains(e.ownerDocument,e)},Z={composed:!0};J.getRootNode&&(K=function(e){return ce.contains(e.ownerDocument,e)||e.getRootNode(Z)===e.ownerDocument});var ee=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&K(e)&&"none"===ce.css(e,"display")};function te(e,t,n,r){var i,o,a=20,s=r?function(){return r.cur()}:function(){return ce.css(e,t,"")},u=s(),l=n&&n[3]||(ce.cssNumber[t]?"":"px"),c=e.nodeType&&(ce.cssNumber[t]||"px"!==l&&+u)&&Y.exec(ce.css(e,t));if(c&&c[3]!==l){u/=2,l=l||c[3],c=+u||1;while(a--)ce.style(e,t,c+l),(1-o)*(1-(o=s()/u||.5))<=0&&(a=0),c/=o;c*=2,ce.style(e,t,c+l),n=n||[]}return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}var ne={};function re(e,t){for(var n,r,i,o,a,s,u,l=[],c=0,f=e.length;c<f;c++)(r=e[c]).style&&(n=r.style.display,t?("none"===n&&(l[c]=_.get(r,"display")||null,l[c]||(r.style.display="")),""===r.style.display&&ee(r)&&(l[c]=(u=a=o=void 0,a=(i=r).ownerDocument,s=i.nodeName,(u=ne[s])||(o=a.body.appendChild(a.createElement(s)),u=ce.css(o,"display"),o.parentNode.removeChild(o),"none"===u&&(u="block"),ne[s]=u)))):"none"!==n&&(l[c]="none",_.set(r,"display",n)));for(c=0;c<f;c++)null!=l[c]&&(e[c].style.display=l[c]);return e}ce.fn.extend({show:function(){return re(this,!0)},hide:function(){return re(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){ee(this)?ce(this).show():ce(this).hide()})}});var xe,be,we=/^(?:checkbox|radio)$/i,Te=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,Ce=/^$|^module$|\/(?:java|ecma)script/i;xe=C.createDocumentFragment().appendChild(C.createElement("div")),(be=C.createElement("input")).setAttribute("type","radio"),be.setAttribute("checked","checked"),be.setAttribute("name","t"),xe.appendChild(be),le.checkClone=xe.cloneNode(!0).cloneNode(!0).lastChild.checked,xe.innerHTML="<textarea>x</textarea>",le.noCloneChecked=!!xe.cloneNode(!0).lastChild.defaultValue,xe.innerHTML="<option></option>",le.option=!!xe.lastChild;var ke={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function Se(e,t){var n;return n="undefined"!=typeof e.getElementsByTagName?e.getElementsByTagName(t||"*"):"undefined"!=typeof e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&fe(e,t)?ce.merge([e],n):n}function Ee(e,t){for(var n=0,r=e.length;n<r;n++)_.set(e[n],"globalEval",!t||_.get(t[n],"globalEval"))}ke.tbody=ke.tfoot=ke.colgroup=ke.caption=ke.thead,ke.th=ke.td,le.option||(ke.optgroup=ke.option=[1,"<select multiple='multiple'>","</select>"]);var je=/<|&#?\w+;/;function Ae(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),p=[],d=0,h=e.length;d<h;d++)if((o=e[d])||0===o)if("object"===x(o))ce.merge(p,o.nodeType?[o]:o);else if(je.test(o)){a=a||f.appendChild(t.createElement("div")),s=(Te.exec(o)||["",""])[1].toLowerCase(),u=ke[s]||ke._default,a.innerHTML=u[1]+ce.htmlPrefilter(o)+u[2],c=u[0];while(c--)a=a.lastChild;ce.merge(p,a.childNodes),(a=f.firstChild).textContent=""}else p.push(t.createTextNode(o));f.textContent="",d=0;while(o=p[d++])if(r&&-1<ce.inArray(o,r))i&&i.push(o);else if(l=K(o),a=Se(f.appendChild(o),"script"),l&&Ee(a),n){c=0;while(o=a[c++])Ce.test(o.type||"")&&n.push(o)}return f}var De=/^([^.]*)(?:\.(.+)|)/;function Ne(){return!0}function qe(){return!1}function Le(e,t,n,r,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)Le(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=qe;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return ce().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=ce.guid++)),e.each(function(){ce.event.add(this,t,i,r,n)})}function He(e,r,t){t?(_.set(e,r,!1),ce.event.add(e,r,{namespace:!1,handler:function(e){var t,n=_.get(this,r);if(1&e.isTrigger&&this[r]){if(n)(ce.event.special[r]||{}).delegateType&&e.stopPropagation();else if(n=ae.call(arguments),_.set(this,r,n),this[r](),t=_.get(this,r),_.set(this,r,!1),n!==t)return e.stopImmediatePropagation(),e.preventDefault(),t}else n&&(_.set(this,r,ce.event.trigger(n[0],n.slice(1),this)),e.stopPropagation(),e.isImmediatePropagationStopped=Ne)}})):void 0===_.get(e,r)&&ce.event.add(e,r,Ne)}ce.event={global:{},add:function(t,e,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=_.get(t);if($(t)){n.handler&&(n=(o=n).handler,i=o.selector),i&&ce.find.matchesSelector(J,i),n.guid||(n.guid=ce.guid++),(u=v.events)||(u=v.events=Object.create(null)),(a=v.handle)||(a=v.handle=function(e){return"undefined"!=typeof ce&&ce.event.triggered!==e.type?ce.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(D)||[""]).length;while(l--)d=g=(s=De.exec(e[l])||[])[1],h=(s[2]||"").split(".").sort(),d&&(f=ce.event.special[d]||{},d=(i?f.delegateType:f.bindType)||d,f=ce.event.special[d]||{},c=ce.extend({type:d,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&ce.expr.match.needsContext.test(i),namespace:h.join(".")},o),(p=u[d])||((p=u[d]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(t,r,h,a)||t.addEventListener&&t.addEventListener(d,a)),f.add&&(f.add.call(t,c),c.handler.guid||(c.handler.guid=n.guid)),i?p.splice(p.delegateCount++,0,c):p.push(c),ce.event.global[d]=!0)}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=_.hasData(e)&&_.get(e);if(v&&(u=v.events)){l=(t=(t||"").match(D)||[""]).length;while(l--)if(d=g=(s=De.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),d){f=ce.event.special[d]||{},p=u[d=(r?f.delegateType:f.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;while(o--)c=p[o],!i&&g!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(p.splice(o,1),c.selector&&p.delegateCount--,f.remove&&f.remove.call(e,c));a&&!p.length&&(f.teardown&&!1!==f.teardown.call(e,h,v.handle)||ce.removeEvent(e,d,v.handle),delete u[d])}else for(d in u)ce.event.remove(e,d+t[l],n,r,!0);ce.isEmptyObject(u)&&_.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=new Array(arguments.length),u=ce.event.fix(e),l=(_.get(this,"events")||Object.create(null))[u.type]||[],c=ce.event.special[u.type]||{};for(s[0]=u,t=1;t<arguments.length;t++)s[t]=arguments[t];if(u.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,u)){a=ce.event.handlers.call(this,u,l),t=0;while((i=a[t++])&&!u.isPropagationStopped()){u.currentTarget=i.elem,n=0;while((o=i.handlers[n++])&&!u.isImmediatePropagationStopped())u.rnamespace&&!1!==o.namespace&&!u.rnamespace.test(o.namespace)||(u.handleObj=o,u.data=o.data,void 0!==(r=((ce.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,s))&&!1===(u.result=r)&&(u.preventDefault(),u.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,u),u.result}},handlers:function(e,t){var n,r,i,o,a,s=[],u=t.delegateCount,l=e.target;if(u&&l.nodeType&&!("click"===e.type&&1<=e.button))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(o=[],a={},n=0;n<u;n++)void 0===a[i=(r=t[n]).selector+" "]&&(a[i]=r.needsContext?-1<ce(i,this).index(l):ce.find(i,this,null,[l]).length),a[i]&&o.push(r);o.length&&s.push({elem:l,handlers:o})}return l=this,u<t.length&&s.push({elem:l,handlers:t.slice(u)}),s},addProp:function(t,e){Object.defineProperty(ce.Event.prototype,t,{enumerable:!0,configurable:!0,get:v(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[ce.expando]?e:new ce.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return we.test(t.type)&&t.click&&fe(t,"input")&&He(t,"click",!0),!1},trigger:function(e){var t=this||e;return we.test(t.type)&&t.click&&fe(t,"input")&&He(t,"click"),!0},_default:function(e){var t=e.target;return we.test(t.type)&&t.click&&fe(t,"input")&&_.get(t,"click")||fe(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},ce.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},ce.Event=function(e,t){if(!(this instanceof ce.Event))return new ce.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?Ne:qe,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&ce.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[ce.expando]=!0},ce.Event.prototype={constructor:ce.Event,isDefaultPrevented:qe,isPropagationStopped:qe,isImmediatePropagationStopped:qe,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=Ne,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=Ne,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=Ne,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},ce.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,"char":!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:!0},ce.event.addProp),ce.each({focus:"focusin",blur:"focusout"},function(r,i){function o(e){if(C.documentMode){var t=_.get(this,"handle"),n=ce.event.fix(e);n.type="focusin"===e.type?"focus":"blur",n.isSimulated=!0,t(e),n.target===n.currentTarget&&t(n)}else ce.event.simulate(i,e.target,ce.event.fix(e))}ce.event.special[r]={setup:function(){var e;if(He(this,r,!0),!C.documentMode)return!1;(e=_.get(this,i))||this.addEventListener(i,o),_.set(this,i,(e||0)+1)},trigger:function(){return He(this,r),!0},teardown:function(){var e;if(!C.documentMode)return!1;(e=_.get(this,i)-1)?_.set(this,i,e):(this.removeEventListener(i,o),_.remove(this,i))},_default:function(e){return _.get(e.target,r)},delegateType:i},ce.event.special[i]={setup:function(){var e=this.ownerDocument||this.document||this,t=C.documentMode?this:e,n=_.get(t,i);n||(C.documentMode?this.addEventListener(i,o):e.addEventListener(r,o,!0)),_.set(t,i,(n||0)+1)},teardown:function(){var e=this.ownerDocument||this.document||this,t=C.documentMode?this:e,n=_.get(t,i)-1;n?_.set(t,i,n):(C.documentMode?this.removeEventListener(i,o):e.removeEventListener(r,o,!0),_.remove(t,i))}}}),ce.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,i){ce.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,n=e.relatedTarget,r=e.handleObj;return n&&(n===this||ce.contains(this,n))||(e.type=r.origType,t=r.handler.apply(this,arguments),e.type=i),t}}}),ce.fn.extend({on:function(e,t,n,r){return Le(this,e,t,n,r)},one:function(e,t,n,r){return Le(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,ce(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=qe),this.each(function(){ce.event.remove(this,e,n,t)})}});var Oe=/<script|<style|<link/i,Pe=/checked\s*(?:[^=]|=\s*.checked.)/i,Me=/^\s*<!\[CDATA\[|\]\]>\s*$/g;function Re(e,t){return fe(e,"table")&&fe(11!==t.nodeType?t:t.firstChild,"tr")&&ce(e).children("tbody")[0]||e}function Ie(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function We(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Fe(e,t){var n,r,i,o,a,s;if(1===t.nodeType){if(_.hasData(e)&&(s=_.get(e).events))for(i in _.remove(t,"handle events"),s)for(n=0,r=s[i].length;n<r;n++)ce.event.add(t,i,s[i][n]);z.hasData(e)&&(o=z.access(e),a=ce.extend({},o),z.set(t,a))}}function $e(n,r,i,o){r=g(r);var e,t,a,s,u,l,c=0,f=n.length,p=f-1,d=r[0],h=v(d);if(h||1<f&&"string"==typeof d&&!le.checkClone&&Pe.test(d))return n.each(function(e){var t=n.eq(e);h&&(r[0]=d.call(this,e,t.html())),$e(t,r,i,o)});if(f&&(t=(e=Ae(r,n[0].ownerDocument,!1,n,o)).firstChild,1===e.childNodes.length&&(e=t),t||o)){for(s=(a=ce.map(Se(e,"script"),Ie)).length;c<f;c++)u=e,c!==p&&(u=ce.clone(u,!0,!0),s&&ce.merge(a,Se(u,"script"))),i.call(n[c],u,c);if(s)for(l=a[a.length-1].ownerDocument,ce.map(a,We),c=0;c<s;c++)u=a[c],Ce.test(u.type||"")&&!_.access(u,"globalEval")&&ce.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?ce._evalUrl&&!u.noModule&&ce._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")},l):m(u.textContent.replace(Me,""),u,l))}return n}function Be(e,t,n){for(var r,i=t?ce.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||ce.cleanData(Se(r)),r.parentNode&&(n&&K(r)&&Ee(Se(r,"script")),r.parentNode.removeChild(r));return e}ce.extend({htmlPrefilter:function(e){return e},clone:function(e,t,n){var r,i,o,a,s,u,l,c=e.cloneNode(!0),f=K(e);if(!(le.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||ce.isXMLDoc(e)))for(a=Se(c),r=0,i=(o=Se(e)).length;r<i;r++)s=o[r],u=a[r],void 0,"input"===(l=u.nodeName.toLowerCase())&&we.test(s.type)?u.checked=s.checked:"input"!==l&&"textarea"!==l||(u.defaultValue=s.defaultValue);if(t)if(n)for(o=o||Se(e),a=a||Se(c),r=0,i=o.length;r<i;r++)Fe(o[r],a[r]);else Fe(e,c);return 0<(a=Se(c,"script")).length&&Ee(a,!f&&Se(e,"script")),c},cleanData:function(e){for(var t,n,r,i=ce.event.special,o=0;void 0!==(n=e[o]);o++)if($(n)){if(t=n[_.expando]){if(t.events)for(r in t.events)i[r]?ce.event.remove(n,r):ce.removeEvent(n,r,t.handle);n[_.expando]=void 0}n[z.expando]&&(n[z.expando]=void 0)}}}),ce.fn.extend({detach:function(e){return Be(this,e,!0)},remove:function(e){return Be(this,e)},text:function(e){return M(this,function(e){return void 0===e?ce.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return $e(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Re(this,e).appendChild(e)})},prepend:function(){return $e(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Re(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return $e(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return $e(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(ce.cleanData(Se(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return ce.clone(this,e,t)})},html:function(e){return M(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!Oe.test(e)&&!ke[(Te.exec(e)||["",""])[1].toLowerCase()]){e=ce.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(ce.cleanData(Se(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=[];return $e(this,arguments,function(e){var t=this.parentNode;ce.inArray(this,n)<0&&(ce.cleanData(Se(this)),t&&t.replaceChild(e,this))},n)}}),ce.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){ce.fn[e]=function(e){for(var t,n=[],r=ce(e),i=r.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),ce(r[o])[a](t),s.apply(n,t.get());return this.pushStack(n)}});var _e=new RegExp("^("+G+")(?!px)[a-z%]+$","i"),ze=/^--/,Xe=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=ie),t.getComputedStyle(e)},Ue=function(e,t,n){var r,i,o={};for(i in t)o[i]=e.style[i],e.style[i]=t[i];for(i in r=n.call(e),t)e.style[i]=o[i];return r},Ve=new RegExp(Q.join("|"),"i");function Ge(e,t,n){var r,i,o,a,s=ze.test(t),u=e.style;return(n=n||Xe(e))&&(a=n.getPropertyValue(t)||n[t],s&&a&&(a=a.replace(ve,"$1")||void 0),""!==a||K(e)||(a=ce.style(e,t)),!le.pixelBoxStyles()&&_e.test(a)&&Ve.test(t)&&(r=u.width,i=u.minWidth,o=u.maxWidth,u.minWidth=u.maxWidth=u.width=a,a=n.width,u.width=r,u.minWidth=i,u.maxWidth=o)),void 0!==a?a+"":a}function Ye(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function e(){if(l){u.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",l.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",J.appendChild(u).appendChild(l);var e=ie.getComputedStyle(l);n="1%"!==e.top,s=12===t(e.marginLeft),l.style.right="60%",o=36===t(e.right),r=36===t(e.width),l.style.position="absolute",i=12===t(l.offsetWidth/3),J.removeChild(u),l=null}}function t(e){return Math.round(parseFloat(e))}var n,r,i,o,a,s,u=C.createElement("div"),l=C.createElement("div");l.style&&(l.style.backgroundClip="content-box",l.cloneNode(!0).style.backgroundClip="",le.clearCloneStyle="content-box"===l.style.backgroundClip,ce.extend(le,{boxSizingReliable:function(){return e(),r},pixelBoxStyles:function(){return e(),o},pixelPosition:function(){return e(),n},reliableMarginLeft:function(){return e(),s},scrollboxSize:function(){return e(),i},reliableTrDimensions:function(){var e,t,n,r;return null==a&&(e=C.createElement("table"),t=C.createElement("tr"),n=C.createElement("div"),e.style.cssText="position:absolute;left:-11111px;border-collapse:separate",t.style.cssText="box-sizing:content-box;border:1px solid",t.style.height="1px",n.style.height="9px",n.style.display="block",J.appendChild(e).appendChild(t).appendChild(n),r=ie.getComputedStyle(t),a=parseInt(r.height,10)+parseInt(r.borderTopWidth,10)+parseInt(r.borderBottomWidth,10)===t.offsetHeight,J.removeChild(e)),a}}))}();var Qe=["Webkit","Moz","ms"],Je=C.createElement("div").style,Ke={};function Ze(e){var t=ce.cssProps[e]||Ke[e];return t||(e in Je?e:Ke[e]=function(e){var t=e[0].toUpperCase()+e.slice(1),n=Qe.length;while(n--)if((e=Qe[n]+t)in Je)return e}(e)||e)}var et=/^(none|table(?!-c[ea]).+)/,tt={position:"absolute",visibility:"hidden",display:"block"},nt={letterSpacing:"0",fontWeight:"400"};function rt(e,t,n){var r=Y.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function it(e,t,n,r,i,o){var a="width"===t?1:0,s=0,u=0,l=0;if(n===(r?"border":"content"))return 0;for(;a<4;a+=2)"margin"===n&&(l+=ce.css(e,n+Q[a],!0,i)),r?("content"===n&&(u-=ce.css(e,"padding"+Q[a],!0,i)),"margin"!==n&&(u-=ce.css(e,"border"+Q[a]+"Width",!0,i))):(u+=ce.css(e,"padding"+Q[a],!0,i),"padding"!==n?u+=ce.css(e,"border"+Q[a]+"Width",!0,i):s+=ce.css(e,"border"+Q[a]+"Width",!0,i));return!r&&0<=o&&(u+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-u-s-.5))||0),u+l}function ot(e,t,n){var r=Xe(e),i=(!le.boxSizingReliable()||n)&&"border-box"===ce.css(e,"boxSizing",!1,r),o=i,a=Ge(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if(_e.test(a)){if(!n)return a;a="auto"}return(!le.boxSizingReliable()&&i||!le.reliableTrDimensions()&&fe(e,"tr")||"auto"===a||!parseFloat(a)&&"inline"===ce.css(e,"display",!1,r))&&e.getClientRects().length&&(i="border-box"===ce.css(e,"boxSizing",!1,r),(o=s in e)&&(a=e[s])),(a=parseFloat(a)||0)+it(e,t,n||(i?"border":"content"),o,r,a)+"px"}function at(e,t,n,r,i){return new at.prototype.init(e,t,n,r,i)}ce.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Ge(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,aspectRatio:!0,borderImageSlice:!0,columnCount:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,scale:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeMiterlimit:!0,strokeOpacity:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=F(t),u=ze.test(t),l=e.style;if(u||(t=Ze(s)),a=ce.cssHooks[t]||ce.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:l[t];"string"===(o=typeof n)&&(i=Y.exec(n))&&i[1]&&(n=te(e,t,i),o="number"),null!=n&&n==n&&("number"!==o||u||(n+=i&&i[3]||(ce.cssNumber[s]?"":"px")),le.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u?l.setProperty(t,n):l[t]=n))}},css:function(e,t,n,r){var i,o,a,s=F(t);return ze.test(t)||(t=Ze(s)),(a=ce.cssHooks[t]||ce.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=Ge(e,t,r)),"normal"===i&&t in nt&&(i=nt[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),ce.each(["height","width"],function(e,u){ce.cssHooks[u]={get:function(e,t,n){if(t)return!et.test(ce.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?ot(e,u,n):Ue(e,tt,function(){return ot(e,u,n)})},set:function(e,t,n){var r,i=Xe(e),o=!le.scrollboxSize()&&"absolute"===i.position,a=(o||n)&&"border-box"===ce.css(e,"boxSizing",!1,i),s=n?it(e,u,n,a,i):0;return a&&o&&(s-=Math.ceil(e["offset"+u[0].toUpperCase()+u.slice(1)]-parseFloat(i[u])-it(e,u,"border",!1,i)-.5)),s&&(r=Y.exec(t))&&"px"!==(r[3]||"px")&&(e.style[u]=t,t=ce.css(e,u)),rt(0,t,s)}}}),ce.cssHooks.marginLeft=Ye(le.reliableMarginLeft,function(e,t){if(t)return(parseFloat(Ge(e,"marginLeft"))||e.getBoundingClientRect().left-Ue(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),ce.each({margin:"",padding:"",border:"Width"},function(i,o){ce.cssHooks[i+o]={expand:function(e){for(var t=0,n={},r="string"==typeof e?e.split(" "):[e];t<4;t++)n[i+Q[t]+o]=r[t]||r[t-2]||r[0];return n}},"margin"!==i&&(ce.cssHooks[i+o].set=rt)}),ce.fn.extend({css:function(e,t){return M(this,function(e,t,n){var r,i,o={},a=0;if(Array.isArray(t)){for(r=Xe(e),i=t.length;a<i;a++)o[t[a]]=ce.css(e,t[a],!1,r);return o}return void 0!==n?ce.style(e,t,n):ce.css(e,t)},e,t,1<arguments.length)}}),((ce.Tween=at).prototype={constructor:at,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||ce.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(ce.cssNumber[n]?"":"px")},cur:function(){var e=at.propHooks[this.prop];return e&&e.get?e.get(this):at.propHooks._default.get(this)},run:function(e){var t,n=at.propHooks[this.prop];return this.options.duration?this.pos=t=ce.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):at.propHooks._default.set(this),this}}).init.prototype=at.prototype,(at.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=ce.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){ce.fx.step[e.prop]?ce.fx.step[e.prop](e):1!==e.elem.nodeType||!ce.cssHooks[e.prop]&&null==e.elem.style[Ze(e.prop)]?e.elem[e.prop]=e.now:ce.style(e.elem,e.prop,e.now+e.unit)}}}).scrollTop=at.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},ce.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},ce.fx=at.prototype.init,ce.fx.step={};var st,ut,lt,ct,ft=/^(?:toggle|show|hide)$/,pt=/queueHooks$/;function dt(){ut&&(!1===C.hidden&&ie.requestAnimationFrame?ie.requestAnimationFrame(dt):ie.setTimeout(dt,ce.fx.interval),ce.fx.tick())}function ht(){return ie.setTimeout(function(){st=void 0}),st=Date.now()}function gt(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=Q[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function vt(e,t,n){for(var r,i=(yt.tweeners[t]||[]).concat(yt.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function yt(o,e,t){var n,a,r=0,i=yt.prefilters.length,s=ce.Deferred().always(function(){delete u.elem}),u=function(){if(a)return!1;for(var e=st||ht(),t=Math.max(0,l.startTime+l.duration-e),n=1-(t/l.duration||0),r=0,i=l.tweens.length;r<i;r++)l.tweens[r].run(n);return s.notifyWith(o,[l,n,t]),n<1&&i?t:(i||s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l]),!1)},l=s.promise({elem:o,props:ce.extend({},e),opts:ce.extend(!0,{specialEasing:{},easing:ce.easing._default},t),originalProperties:e,originalOptions:t,startTime:st||ht(),duration:t.duration,tweens:[],createTween:function(e,t){var n=ce.Tween(o,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(n),n},stop:function(e){var t=0,n=e?l.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)l.tweens[t].run(1);return e?(s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l,e])):s.rejectWith(o,[l,e]),this}}),c=l.props;for(!function(e,t){var n,r,i,o,a;for(n in e)if(i=t[r=F(n)],o=e[n],Array.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=ce.cssHooks[r])&&"expand"in a)for(n in o=a.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=i);else t[r]=i}(c,l.opts.specialEasing);r<i;r++)if(n=yt.prefilters[r].call(l,o,c,l.opts))return v(n.stop)&&(ce._queueHooks(l.elem,l.opts.queue).stop=n.stop.bind(n)),n;return ce.map(c,vt,l),v(l.opts.start)&&l.opts.start.call(o,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),ce.fx.timer(ce.extend(u,{elem:o,anim:l,queue:l.opts.queue})),l}ce.Animation=ce.extend(yt,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return te(n.elem,e,Y.exec(t),n),n}]},tweener:function(e,t){v(e)?(t=e,e=["*"]):e=e.match(D);for(var n,r=0,i=e.length;r<i;r++)n=e[r],yt.tweeners[n]=yt.tweeners[n]||[],yt.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,p=this,d={},h=e.style,g=e.nodeType&&ee(e),v=_.get(e,"fxshow");for(r in n.queue||(null==(a=ce._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,ce.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[r],ft.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!v||void 0===v[r])continue;g=!0}d[r]=v&&v[r]||ce.style(e,r)}if((u=!ce.isEmptyObject(t))||!ce.isEmptyObject(d))for(r in f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=v&&v.display)&&(l=_.get(e,"display")),"none"===(c=ce.css(e,"display"))&&(l?c=l:(re([e],!0),l=e.style.display||l,c=ce.css(e,"display"),re([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===ce.css(e,"float")&&(u||(p.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",p.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1,d)u||(v?"hidden"in v&&(g=v.hidden):v=_.access(e,"fxshow",{display:l}),o&&(v.hidden=!g),g&&re([e],!0),p.done(function(){for(r in g||re([e]),_.remove(e,"fxshow"),d)ce.style(e,r,d[r])})),u=vt(g?v[r]:0,r,p),r in v||(v[r]=u.start,g&&(u.end=u.start,u.start=0))}],prefilter:function(e,t){t?yt.prefilters.unshift(e):yt.prefilters.push(e)}}),ce.speed=function(e,t,n){var r=e&&"object"==typeof e?ce.extend({},e):{complete:n||!n&&t||v(e)&&e,duration:e,easing:n&&t||t&&!v(t)&&t};return ce.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in ce.fx.speeds?r.duration=ce.fx.speeds[r.duration]:r.duration=ce.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){v(r.old)&&r.old.call(this),r.queue&&ce.dequeue(this,r.queue)},r},ce.fn.extend({fadeTo:function(e,t,n,r){return this.filter(ee).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(t,e,n,r){var i=ce.isEmptyObject(t),o=ce.speed(e,n,r),a=function(){var e=yt(this,ce.extend({},t),o);(i||_.get(this,"finish"))&&e.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(i,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof i&&(o=e,e=i,i=void 0),e&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",n=ce.timers,r=_.get(this);if(t)r[t]&&r[t].stop&&a(r[t]);else for(t in r)r[t]&&r[t].stop&&pt.test(t)&&a(r[t]);for(t=n.length;t--;)n[t].elem!==this||null!=i&&n[t].queue!==i||(n[t].anim.stop(o),e=!1,n.splice(t,1));!e&&o||ce.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=_.get(this),n=t[a+"queue"],r=t[a+"queueHooks"],i=ce.timers,o=n?n.length:0;for(t.finish=!0,ce.queue(this,a,[]),r&&r.stop&&r.stop.call(this,!0),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),ce.each(["toggle","show","hide"],function(e,r){var i=ce.fn[r];ce.fn[r]=function(e,t,n){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(gt(r,!0),e,t,n)}}),ce.each({slideDown:gt("show"),slideUp:gt("hide"),slideToggle:gt("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,r){ce.fn[e]=function(e,t,n){return this.animate(r,e,t,n)}}),ce.timers=[],ce.fx.tick=function(){var e,t=0,n=ce.timers;for(st=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||ce.fx.stop(),st=void 0},ce.fx.timer=function(e){ce.timers.push(e),ce.fx.start()},ce.fx.interval=13,ce.fx.start=function(){ut||(ut=!0,dt())},ce.fx.stop=function(){ut=null},ce.fx.speeds={slow:600,fast:200,_default:400},ce.fn.delay=function(r,e){return r=ce.fx&&ce.fx.speeds[r]||r,e=e||"fx",this.queue(e,function(e,t){var n=ie.setTimeout(e,r);t.stop=function(){ie.clearTimeout(n)}})},lt=C.createElement("input"),ct=C.createElement("select").appendChild(C.createElement("option")),lt.type="checkbox",le.checkOn=""!==lt.value,le.optSelected=ct.selected,(lt=C.createElement("input")).value="t",lt.type="radio",le.radioValue="t"===lt.value;var mt,xt=ce.expr.attrHandle;ce.fn.extend({attr:function(e,t){return M(this,ce.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){ce.removeAttr(this,e)})}}),ce.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return"undefined"==typeof e.getAttribute?ce.prop(e,t,n):(1===o&&ce.isXMLDoc(e)||(i=ce.attrHooks[t.toLowerCase()]||(ce.expr.match.bool.test(t)?mt:void 0)),void 0!==n?null===n?void ce.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=ce.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!le.radioValue&&"radio"===t&&fe(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(D);if(i&&1===e.nodeType)while(n=i[r++])e.removeAttribute(n)}}),mt={set:function(e,t,n){return!1===t?ce.removeAttr(e,n):e.setAttribute(n,n),n}},ce.each(ce.expr.match.bool.source.match(/\w+/g),function(e,t){var a=xt[t]||ce.find.attr;xt[t]=function(e,t,n){var r,i,o=t.toLowerCase();return n||(i=xt[o],xt[o]=r,r=null!=a(e,t,n)?o:null,xt[o]=i),r}});var bt=/^(?:input|select|textarea|button)$/i,wt=/^(?:a|area)$/i;function Tt(e){return(e.match(D)||[]).join(" ")}function Ct(e){return e.getAttribute&&e.getAttribute("class")||""}function kt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(D)||[]}ce.fn.extend({prop:function(e,t){return M(this,ce.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[ce.propFix[e]||e]})}}),ce.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&ce.isXMLDoc(e)||(t=ce.propFix[t]||t,i=ce.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=ce.find.attr(e,"tabindex");return t?parseInt(t,10):bt.test(e.nodeName)||wt.test(e.nodeName)&&e.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),le.optSelected||(ce.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),ce.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){ce.propFix[this.toLowerCase()]=this}),ce.fn.extend({addClass:function(t){var e,n,r,i,o,a;return v(t)?this.each(function(e){ce(this).addClass(t.call(this,e,Ct(this)))}):(e=kt(t)).length?this.each(function(){if(r=Ct(this),n=1===this.nodeType&&" "+Tt(r)+" "){for(o=0;o<e.length;o++)i=e[o],n.indexOf(" "+i+" ")<0&&(n+=i+" ");a=Tt(n),r!==a&&this.setAttribute("class",a)}}):this},removeClass:function(t){var e,n,r,i,o,a;return v(t)?this.each(function(e){ce(this).removeClass(t.call(this,e,Ct(this)))}):arguments.length?(e=kt(t)).length?this.each(function(){if(r=Ct(this),n=1===this.nodeType&&" "+Tt(r)+" "){for(o=0;o<e.length;o++){i=e[o];while(-1<n.indexOf(" "+i+" "))n=n.replace(" "+i+" "," ")}a=Tt(n),r!==a&&this.setAttribute("class",a)}}):this:this.attr("class","")},toggleClass:function(t,n){var e,r,i,o,a=typeof t,s="string"===a||Array.isArray(t);return v(t)?this.each(function(e){ce(this).toggleClass(t.call(this,e,Ct(this),n),n)}):"boolean"==typeof n&&s?n?this.addClass(t):this.removeClass(t):(e=kt(t),this.each(function(){if(s)for(o=ce(this),i=0;i<e.length;i++)r=e[i],o.hasClass(r)?o.removeClass(r):o.addClass(r);else void 0!==t&&"boolean"!==a||((r=Ct(this))&&_.set(this,"__className__",r),this.setAttribute&&this.setAttribute("class",r||!1===t?"":_.get(this,"__className__")||""))}))},hasClass:function(e){var t,n,r=0;t=" "+e+" ";while(n=this[r++])if(1===n.nodeType&&-1<(" "+Tt(Ct(n))+" ").indexOf(t))return!0;return!1}});var St=/\r/g;ce.fn.extend({val:function(n){var r,e,i,t=this[0];return arguments.length?(i=v(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=i?n.call(this,e,ce(this).val()):n)?t="":"number"==typeof t?t+="":Array.isArray(t)&&(t=ce.map(t,function(e){return null==e?"":e+""})),(r=ce.valHooks[this.type]||ce.valHooks[this.nodeName.toLowerCase()])&&"set"in r&&void 0!==r.set(this,t,"value")||(this.value=t))})):t?(r=ce.valHooks[t.type]||ce.valHooks[t.nodeName.toLowerCase()])&&"get"in r&&void 0!==(e=r.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(St,""):null==e?"":e:void 0}}),ce.extend({valHooks:{option:{get:function(e){var t=ce.find.attr(e,"value");return null!=t?t:Tt(ce.text(e))}},select:{get:function(e){var t,n,r,i=e.options,o=e.selectedIndex,a="select-one"===e.type,s=a?null:[],u=a?o+1:i.length;for(r=o<0?u:a?o:0;r<u;r++)if(((n=i[r]).selected||r===o)&&!n.disabled&&(!n.parentNode.disabled||!fe(n.parentNode,"optgroup"))){if(t=ce(n).val(),a)return t;s.push(t)}return s},set:function(e,t){var n,r,i=e.options,o=ce.makeArray(t),a=i.length;while(a--)((r=i[a]).selected=-1<ce.inArray(ce.valHooks.option.get(r),o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),ce.each(["radio","checkbox"],function(){ce.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=-1<ce.inArray(ce(e).val(),t)}},le.checkOn||(ce.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var Et=ie.location,jt={guid:Date.now()},At=/\?/;ce.parseXML=function(e){var t,n;if(!e||"string"!=typeof e)return null;try{t=(new ie.DOMParser).parseFromString(e,"text/xml")}catch(e){}return n=t&&t.getElementsByTagName("parsererror")[0],t&&!n||ce.error("Invalid XML: "+(n?ce.map(n.childNodes,function(e){return e.textContent}).join("\n"):e)),t};var Dt=/^(?:focusinfocus|focusoutblur)$/,Nt=function(e){e.stopPropagation()};ce.extend(ce.event,{trigger:function(e,t,n,r){var i,o,a,s,u,l,c,f,p=[n||C],d=ue.call(e,"type")?e.type:e,h=ue.call(e,"namespace")?e.namespace.split("."):[];if(o=f=a=n=n||C,3!==n.nodeType&&8!==n.nodeType&&!Dt.test(d+ce.event.triggered)&&(-1<d.indexOf(".")&&(d=(h=d.split(".")).shift(),h.sort()),u=d.indexOf(":")<0&&"on"+d,(e=e[ce.expando]?e:new ce.Event(d,"object"==typeof e&&e)).isTrigger=r?2:3,e.namespace=h.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:ce.makeArray(t,[e]),c=ce.event.special[d]||{},r||!c.trigger||!1!==c.trigger.apply(n,t))){if(!r&&!c.noBubble&&!y(n)){for(s=c.delegateType||d,Dt.test(s+d)||(o=o.parentNode);o;o=o.parentNode)p.push(o),a=o;a===(n.ownerDocument||C)&&p.push(a.defaultView||a.parentWindow||ie)}i=0;while((o=p[i++])&&!e.isPropagationStopped())f=o,e.type=1<i?s:c.bindType||d,(l=(_.get(o,"events")||Object.create(null))[e.type]&&_.get(o,"handle"))&&l.apply(o,t),(l=u&&o[u])&&l.apply&&$(o)&&(e.result=l.apply(o,t),!1===e.result&&e.preventDefault());return e.type=d,r||e.isDefaultPrevented()||c._default&&!1!==c._default.apply(p.pop(),t)||!$(n)||u&&v(n[d])&&!y(n)&&((a=n[u])&&(n[u]=null),ce.event.triggered=d,e.isPropagationStopped()&&f.addEventListener(d,Nt),n[d](),e.isPropagationStopped()&&f.removeEventListener(d,Nt),ce.event.triggered=void 0,a&&(n[u]=a)),e.result}},simulate:function(e,t,n){var r=ce.extend(new ce.Event,n,{type:e,isSimulated:!0});ce.event.trigger(r,null,t)}}),ce.fn.extend({trigger:function(e,t){return this.each(function(){ce.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return ce.event.trigger(e,t,n,!0)}});var qt=/\[\]$/,Lt=/\r?\n/g,Ht=/^(?:submit|button|image|reset|file)$/i,Ot=/^(?:input|select|textarea|keygen)/i;function Pt(n,e,r,i){var t;if(Array.isArray(e))ce.each(e,function(e,t){r||qt.test(n)?i(n,t):Pt(n+"["+("object"==typeof t&&null!=t?e:"")+"]",t,r,i)});else if(r||"object"!==x(e))i(n,e);else for(t in e)Pt(n+"["+t+"]",e[t],r,i)}ce.param=function(e,t){var n,r=[],i=function(e,t){var n=v(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!ce.isPlainObject(e))ce.each(e,function(){i(this.name,this.value)});else for(n in e)Pt(n,e[n],t,i);return r.join("&")},ce.fn.extend({serialize:function(){return ce.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=ce.prop(this,"elements");return e?ce.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!ce(this).is(":disabled")&&Ot.test(this.nodeName)&&!Ht.test(e)&&(this.checked||!we.test(e))}).map(function(e,t){var n=ce(this).val();return null==n?null:Array.isArray(n)?ce.map(n,function(e){return{name:t.name,value:e.replace(Lt,"\r\n")}}):{name:t.name,value:n.replace(Lt,"\r\n")}}).get()}});var Mt=/%20/g,Rt=/#.*$/,It=/([?&])_=[^&]*/,Wt=/^(.*?):[ \t]*([^\r\n]*)$/gm,Ft=/^(?:GET|HEAD)$/,$t=/^\/\//,Bt={},_t={},zt="*/".concat("*"),Xt=C.createElement("a");function Ut(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,r=0,i=e.toLowerCase().match(D)||[];if(v(t))while(n=i[r++])"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function Vt(t,i,o,a){var s={},u=t===_t;function l(e){var r;return s[e]=!0,ce.each(t[e]||[],function(e,t){var n=t(i,o,a);return"string"!=typeof n||u||s[n]?u?!(r=n):void 0:(i.dataTypes.unshift(n),l(n),!1)}),r}return l(i.dataTypes[0])||!s["*"]&&l("*")}function Gt(e,t){var n,r,i=ce.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&ce.extend(!0,e,r),e}Xt.href=Et.href,ce.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Et.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(Et.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":zt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":ce.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Gt(Gt(e,ce.ajaxSettings),t):Gt(ce.ajaxSettings,e)},ajaxPrefilter:Ut(Bt),ajaxTransport:Ut(_t),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,f,p,n,d,r,h,g,i,o,v=ce.ajaxSetup({},t),y=v.context||v,m=v.context&&(y.nodeType||y.jquery)?ce(y):ce.event,x=ce.Deferred(),b=ce.Callbacks("once memory"),w=v.statusCode||{},a={},s={},u="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(h){if(!n){n={};while(t=Wt.exec(p))n[t[1].toLowerCase()+" "]=(n[t[1].toLowerCase()+" "]||[]).concat(t[2])}t=n[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return h?p:null},setRequestHeader:function(e,t){return null==h&&(e=s[e.toLowerCase()]=s[e.toLowerCase()]||e,a[e]=t),this},overrideMimeType:function(e){return null==h&&(v.mimeType=e),this},statusCode:function(e){var t;if(e)if(h)T.always(e[T.status]);else for(t in e)w[t]=[w[t],e[t]];return this},abort:function(e){var t=e||u;return c&&c.abort(t),l(0,t),this}};if(x.promise(T),v.url=((e||v.url||Et.href)+"").replace($t,Et.protocol+"//"),v.type=t.method||t.type||v.method||v.type,v.dataTypes=(v.dataType||"*").toLowerCase().match(D)||[""],null==v.crossDomain){r=C.createElement("a");try{r.href=v.url,r.href=r.href,v.crossDomain=Xt.protocol+"//"+Xt.host!=r.protocol+"//"+r.host}catch(e){v.crossDomain=!0}}if(v.data&&v.processData&&"string"!=typeof v.data&&(v.data=ce.param(v.data,v.traditional)),Vt(Bt,v,t,T),h)return T;for(i in(g=ce.event&&v.global)&&0==ce.active++&&ce.event.trigger("ajaxStart"),v.type=v.type.toUpperCase(),v.hasContent=!Ft.test(v.type),f=v.url.replace(Rt,""),v.hasContent?v.data&&v.processData&&0===(v.contentType||"").indexOf("application/x-www-form-urlencoded")&&(v.data=v.data.replace(Mt,"+")):(o=v.url.slice(f.length),v.data&&(v.processData||"string"==typeof v.data)&&(f+=(At.test(f)?"&":"?")+v.data,delete v.data),!1===v.cache&&(f=f.replace(It,"$1"),o=(At.test(f)?"&":"?")+"_="+jt.guid+++o),v.url=f+o),v.ifModified&&(ce.lastModified[f]&&T.setRequestHeader("If-Modified-Since",ce.lastModified[f]),ce.etag[f]&&T.setRequestHeader("If-None-Match",ce.etag[f])),(v.data&&v.hasContent&&!1!==v.contentType||t.contentType)&&T.setRequestHeader("Content-Type",v.contentType),T.setRequestHeader("Accept",v.dataTypes[0]&&v.accepts[v.dataTypes[0]]?v.accepts[v.dataTypes[0]]+("*"!==v.dataTypes[0]?", "+zt+"; q=0.01":""):v.accepts["*"]),v.headers)T.setRequestHeader(i,v.headers[i]);if(v.beforeSend&&(!1===v.beforeSend.call(y,T,v)||h))return T.abort();if(u="abort",b.add(v.complete),T.done(v.success),T.fail(v.error),c=Vt(_t,v,t,T)){if(T.readyState=1,g&&m.trigger("ajaxSend",[T,v]),h)return T;v.async&&0<v.timeout&&(d=ie.setTimeout(function(){T.abort("timeout")},v.timeout));try{h=!1,c.send(a,l)}catch(e){if(h)throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,n,r){var i,o,a,s,u,l=t;h||(h=!0,d&&ie.clearTimeout(d),c=void 0,p=r||"",T.readyState=0<e?4:0,i=200<=e&&e<300||304===e,n&&(s=function(e,t,n){var r,i,o,a,s=e.contents,u=e.dataTypes;while("*"===u[0])u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}(v,T,n)),!i&&-1<ce.inArray("script",v.dataTypes)&&ce.inArray("json",v.dataTypes)<0&&(v.converters["text script"]=function(){}),s=function(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];o=c.shift();while(o)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}(v,s,T,i),i?(v.ifModified&&((u=T.getResponseHeader("Last-Modified"))&&(ce.lastModified[f]=u),(u=T.getResponseHeader("etag"))&&(ce.etag[f]=u)),204===e||"HEAD"===v.type?l="nocontent":304===e?l="notmodified":(l=s.state,o=s.data,i=!(a=s.error))):(a=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",i?x.resolveWith(y,[o,l,T]):x.rejectWith(y,[T,l,a]),T.statusCode(w),w=void 0,g&&m.trigger(i?"ajaxSuccess":"ajaxError",[T,v,i?o:a]),b.fireWith(y,[T,l]),g&&(m.trigger("ajaxComplete",[T,v]),--ce.active||ce.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return ce.get(e,t,n,"json")},getScript:function(e,t){return ce.get(e,void 0,t,"script")}}),ce.each(["get","post"],function(e,i){ce[i]=function(e,t,n,r){return v(t)&&(r=r||n,n=t,t=void 0),ce.ajax(ce.extend({url:e,type:i,dataType:r,data:t,success:n},ce.isPlainObject(e)&&e))}}),ce.ajaxPrefilter(function(e){var t;for(t in e.headers)"content-type"===t.toLowerCase()&&(e.contentType=e.headers[t]||"")}),ce._evalUrl=function(e,t,n){return ce.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){ce.globalEval(e,t,n)}})},ce.fn.extend({wrapAll:function(e){var t;return this[0]&&(v(e)&&(e=e.call(this[0])),t=ce(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstElementChild)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(n){return v(n)?this.each(function(e){ce(this).wrapInner(n.call(this,e))}):this.each(function(){var e=ce(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=v(t);return this.each(function(e){ce(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){ce(this).replaceWith(this.childNodes)}),this}}),ce.expr.pseudos.hidden=function(e){return!ce.expr.pseudos.visible(e)},ce.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},ce.ajaxSettings.xhr=function(){try{return new ie.XMLHttpRequest}catch(e){}};var Yt={0:200,1223:204},Qt=ce.ajaxSettings.xhr();le.cors=!!Qt&&"withCredentials"in Qt,le.ajax=Qt=!!Qt,ce.ajaxTransport(function(i){var o,a;if(le.cors||Qt&&!i.crossDomain)return{send:function(e,t){var n,r=i.xhr();if(r.open(i.type,i.url,i.async,i.username,i.password),i.xhrFields)for(n in i.xhrFields)r[n]=i.xhrFields[n];for(n in i.mimeType&&r.overrideMimeType&&r.overrideMimeType(i.mimeType),i.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)r.setRequestHeader(n,e[n]);o=function(e){return function(){o&&(o=a=r.onload=r.onerror=r.onabort=r.ontimeout=r.onreadystatechange=null,"abort"===e?r.abort():"error"===e?"number"!=typeof r.status?t(0,"error"):t(r.status,r.statusText):t(Yt[r.status]||r.status,r.statusText,"text"!==(r.responseType||"text")||"string"!=typeof r.responseText?{binary:r.response}:{text:r.responseText},r.getAllResponseHeaders()))}},r.onload=o(),a=r.onerror=r.ontimeout=o("error"),void 0!==r.onabort?r.onabort=a:r.onreadystatechange=function(){4===r.readyState&&ie.setTimeout(function(){o&&a()})},o=o("abort");try{r.send(i.hasContent&&i.data||null)}catch(e){if(o)throw e}},abort:function(){o&&o()}}}),ce.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),ce.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return ce.globalEval(e),e}}}),ce.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),ce.ajaxTransport("script",function(n){var r,i;if(n.crossDomain||n.scriptAttrs)return{send:function(e,t){r=ce("<script>").attr(n.scriptAttrs||{}).prop({charset:n.scriptCharset,src:n.url}).on("load error",i=function(e){r.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),C.head.appendChild(r[0])},abort:function(){i&&i()}}});var Jt,Kt=[],Zt=/(=)\?(?=&|$)|\?\?/;ce.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Kt.pop()||ce.expando+"_"+jt.guid++;return this[e]=!0,e}}),ce.ajaxPrefilter("json jsonp",function(e,t,n){var r,i,o,a=!1!==e.jsonp&&(Zt.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Zt.test(e.data)&&"data");if(a||"jsonp"===e.dataTypes[0])return r=e.jsonpCallback=v(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(Zt,"$1"+r):!1!==e.jsonp&&(e.url+=(At.test(e.url)?"&":"?")+e.jsonp+"="+r),e.converters["script json"]=function(){return o||ce.error(r+" was not called"),o[0]},e.dataTypes[0]="json",i=ie[r],ie[r]=function(){o=arguments},n.always(function(){void 0===i?ce(ie).removeProp(r):ie[r]=i,e[r]&&(e.jsonpCallback=t.jsonpCallback,Kt.push(r)),o&&v(i)&&i(o[0]),o=i=void 0}),"script"}),le.createHTMLDocument=((Jt=C.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Jt.childNodes.length),ce.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(le.createHTMLDocument?((r=(t=C.implementation.createHTMLDocument("")).createElement("base")).href=C.location.href,t.head.appendChild(r)):t=C),o=!n&&[],(i=w.exec(e))?[t.createElement(i[1])]:(i=Ae([e],t,o),o&&o.length&&ce(o).remove(),ce.merge([],i.childNodes)));var r,i,o},ce.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return-1<s&&(r=Tt(e.slice(s)),e=e.slice(0,s)),v(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),0<a.length&&ce.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?ce("<div>").append(ce.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},ce.expr.pseudos.animated=function(t){return ce.grep(ce.timers,function(e){return t===e.elem}).length},ce.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=ce.css(e,"position"),c=ce(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=ce.css(e,"top"),u=ce.css(e,"left"),("absolute"===l||"fixed"===l)&&-1<(o+u).indexOf("auto")?(a=(r=c.position()).top,i=r.left):(a=parseFloat(o)||0,i=parseFloat(u)||0),v(t)&&(t=t.call(e,n,ce.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},ce.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){ce.offset.setOffset(this,t,e)});var e,n,r=this[0];return r?r.getClientRects().length?(e=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:e.top+n.pageYOffset,left:e.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===ce.css(r,"position"))t=r.getBoundingClientRect();else{t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;while(e&&(e===n.body||e===n.documentElement)&&"static"===ce.css(e,"position"))e=e.parentNode;e&&e!==r&&1===e.nodeType&&((i=ce(e).offset()).top+=ce.css(e,"borderTopWidth",!0),i.left+=ce.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-ce.css(r,"marginTop",!0),left:t.left-i.left-ce.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent;while(e&&"static"===ce.css(e,"position"))e=e.offsetParent;return e||J})}}),ce.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;ce.fn[t]=function(e){return M(this,function(e,t,n){var r;if(y(e)?r=e:9===e.nodeType&&(r=e.defaultView),void 0===n)return r?r[i]:e[t];r?r.scrollTo(o?r.pageXOffset:n,o?n:r.pageYOffset):e[t]=n},t,e,arguments.length)}}),ce.each(["top","left"],function(e,n){ce.cssHooks[n]=Ye(le.pixelPosition,function(e,t){if(t)return t=Ge(e,n),_e.test(t)?ce(e).position()[n]+"px":t})}),ce.each({Height:"height",Width:"width"},function(a,s){ce.each({padding:"inner"+a,content:s,"":"outer"+a},function(r,o){ce.fn[o]=function(e,t){var n=arguments.length&&(r||"boolean"!=typeof e),i=r||(!0===e||!0===t?"margin":"border");return M(this,function(e,t,n){var r;return y(e)?0===o.indexOf("outer")?e["inner"+a]:e.document.documentElement["client"+a]:9===e.nodeType?(r=e.documentElement,Math.max(e.body["scroll"+a],r["scroll"+a],e.body["offset"+a],r["offset"+a],r["client"+a])):void 0===n?ce.css(e,t,i):ce.style(e,t,n,i)},s,n?e:void 0,n)}})}),ce.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){ce.fn[t]=function(e){return this.on(t,e)}}),ce.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},hover:function(e,t){return this.on("mouseenter",e).on("mouseleave",t||e)}}),ce.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,n){ce.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}});var en=/^[\s\uFEFF\xA0]+|([^\s\uFEFF\xA0])[\s\uFEFF\xA0]+$/g;ce.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),v(e))return r=ae.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(ae.call(arguments)))}).guid=e.guid=e.guid||ce.guid++,i},ce.holdReady=function(e){e?ce.readyWait++:ce.ready(!0)},ce.isArray=Array.isArray,ce.parseJSON=JSON.parse,ce.nodeName=fe,ce.isFunction=v,ce.isWindow=y,ce.camelCase=F,ce.type=x,ce.now=Date.now,ce.isNumeric=function(e){var t=ce.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},ce.trim=function(e){return null==e?"":(e+"").replace(en,"$1")},"function"==typeof define&&define.amd&&define("jquery",[],function(){return ce});var tn=ie.jQuery,nn=ie.$;return ce.noConflict=function(e){return ie.$===ce&&(ie.$=nn),e&&ie.jQuery===ce&&(ie.jQuery=tn),ce},"undefined"==typeof e&&(ie.jQuery=ie.$=ce),ce});
"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,o,i,s=[],c=!0,l=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=o.call(n)).done)&&(s.push(r.value),s.length!==t);c=!0);}catch(e){l=!0,a=e}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(l)throw a}}return s}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function ownKeys(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:String(e)}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);n=n.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _createForOfIteratorHelper(e,t){var n,r,a,o,i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return r=!(n=!0),{s:function(){i=i.call(e)},n:function(){var e=i.next();return n=e.done,e},e:function(e){r=!0,a=e},f:function(){try{n||null==i.return||i.return()}finally{if(r)throw a}}};if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return i&&(e=i),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var n;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(n="Object"===(n=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}define("engine",["jquery","utils","state","section","passages"],function(N,j,P,R,I){var t,V=j.impossible,M=j.passageSelector,D=j.transitionOut,F=j.options;function L(e,t,n){var r,a,o;if(n?(n=n.get("name"),(a=I.getTree(n)).children.length&&(r={type:"include",tag:t,name:n,children:a.children,text:a.text})):r=I.getTree(t),r){for(;(o=e[e.length-1])&&("root"===o.type||"include"===o.type)&&o.children.some(function(e){return e.type.startsWith("unclosed")});)e[e.length-1]=Object.create(o),e=e[e.length-1].children=o.children.slice();e.push(r)}}function n(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=n.loadedGame,a=I.get(e),o=j.storyElement,i=o.parent(),s=n.stretch,n=n.transition,n=void 0===n?{}:n,c=n.depart,c=void 0===c?"instant":c,l=n.arrive,l=void 0===l?"dissolve":l,u=n.departOrigin,p=n.arriveOrigin,n=n.time,d=(i.findAndFilter("tw-enchantment").each(function(e,t){var n=(t=N(t)).data("enchantedProperties");n&&o.css(n.reduce(function(e,t){return e[t]="",e},{})),t[0]===i[0]&&(i=o.unwrap().parent())}),I.hasValid(e)||V("Engine.showPassage","There's no passage with the name \""+e+'"!'),o.children(M).not(".transition-out, .transition-out *")),a=(a.get("tags")||[]).join(" "),f=(t=N("<tw-passage><tw-sidebar>"),f=t.children("tw-sidebar"),h=N('<tw-icon tabindex=0 alt="Undo" title="Undo">&#8630;</tw-icon>'),g=N('<tw-icon tabindex=0 alt="Redo" title="Redo">&#8631;</tw-icon>'),P.pastLength<=0&&h.css("visibility","hidden"),P.futureLength<=0&&g.css("visibility","hidden"),f.append(h,g),t),h=("function"==typeof u&&(u=u.call(d)),"function"==typeof p&&(p=p.call(f)),!s&&c),m=h&&d.css("width"),g=(j.detachStoryElement(),f.appendTo(o).attr({tags:a}),h&&(D(d,c,n,0,0,0,u),d.css({position:"absolute",width:function(){return"0px"!==m?m:"100%"}})),o.attr({tags:a}),R.create(f)),y=(r&&(g.loadedGame=!0),[]);if(P.pastLength<=0&&1===P.turns){var b,v=_createForOfIteratorHelper(I.getTagged("startup"));try{for(v.s();!(b=v.n()).done;)L(y,"startup",b.value)}catch(e){v.e(e)}finally{v.f()}if(F.debug){var w,k=_createForOfIteratorHelper(I.getTagged("debug-startup"));try{for(k.s();!(w=k.n()).done;)L(y,"debug-startup",w.value)}catch(e){k.e(e)}finally{k.f()}}}var S,T=_createForOfIteratorHelper(I.getTagged("header"));try{for(T.s();!(S=T.n()).done;)L(y,"header",S.value)}catch(e){T.e(e)}finally{T.f()}if(F.debug){var _,x=_createForOfIteratorHelper(I.getTagged("debug-header"));try{for(x.s();!(_=x.n()).done;)L(y,"debug-header",_.value)}catch(e){x.e(e)}finally{x.f()}}L(y,e);var O,A=_createForOfIteratorHelper(I.getTagged("footer"));try{for(A.s();!(O=A.n()).done;)L(y,"footer",O.value)}catch(e){A.e(e)}finally{A.f()}if(F.debug){var C,E=_createForOfIteratorHelper(I.getTagged("debug-footer"));try{for(E.s();!(C=E.n()).done;)L(y,"debug-footer",C.value)}catch(e){E.e(e)}finally{E.f()}}g.renderInto(y,f,{transition:l,transitionTime:n,transitionOrigin:p}),g.loadedGame=!1,j.reattachStoryElement(),scroll(0,s?f.offset().top-.05*N(window).height():o[0].getBoundingClientRect().top+document.body.scrollTop)}return Object.freeze({goBack:function(e){P.rewind()&&n(P.passage,e)},goForward:function(e){P.fastForward()&&n(P.passage,e)},goToPassage:function(e,t){P.play(e),n(e,t)},redirect:function(e,t){P.redirect(e),n(e,t)},toggleFullscreen:function(){var e=document.documentElement;document.fullscreenElement?document.exitFullscreen():document.msFullscreenElement?document.msExitFullscreen():(e.msRequestFullscreen||e.requestFullscreen).call(e)},showPassage:n,enableDebugMode:function(){t&&t()},registerDebugMode:function(e){t=t||e}})}),define("harlowe",["jquery","debugmode/mode","renderer","state","section","engine","passages","utils","utils/renderutils","internaltypes/varscope","internaltypes/twineerror","macros","macrolib/values","macrolib/commands","macrolib/datastructures","macrolib/stylechangers","macrolib/enchantments","macrolib/metadata","macrolib/patterns","macrolib/links","macrolib/custommacros","utils/jqueryplugins","repl"],function($,DebugMode,Renderer,State,Section,Engine,Passages,Utils,_ref,VarScope){var dialog=_ref.dialog;function __HarloweEval(text){eval(text+"")}function printJSError(e){var t,n="".concat(e.name,": ").concat(e.message);return e.stack&&(t=(e=e.stack.split("\n")).findIndex(function(e){return e.includes("__HarloweEval")}),n+="\n".concat(e.slice(0,t).join("\n").replace(/\([^)]+\)/g,""))),"<div style='font-family:monospace;overflow-y:scroll;max-height:30vh'>```"+n+"```</div>"}!function(o){window.onerror=function(e,t,n,r,a){window.onerror=o,Utils.storyElement.parent().append(dialog({message:"Sorry to interrupt, but this page's code has got itself in a mess.\n\n".concat(printJSError(a),"\n(This is probably due to a bug in the Harlowe game engine.)")}).addClass("harlowe-crash")),"function"==typeof o&&o.apply(void 0,arguments)}}(window.onerror),Utils.onStartup(function(){var n,e,t,r,a=$("tw-storydata");0!==a.length&&(Utils.options.ifid=a.attr("ifid"),(a.attr("tags")||"").split(/\s/).forEach(function(e){"uncompressed-pure-values"!==e&&"uncompressed-saves"!==e||(Utils.options.uncompressedPureValues=!0),"uncompressed-structures"!==e&&"uncompressed-saves"!==e||(Utils.options.uncompressedStructures=!0)}),(a.attr("options")||"").split(/\s/).forEach(function(e){e&&(Utils.options[e]=!0),"debug"===e&&DebugMode()}),a=(a=a.attr("startnode"))||[].reduce.call($("tw-passagedata"),function(e,t){t=t.getAttribute("pid");return t<e?t:e},1/0),a=$("tw-passagedata[pid='"+a+"']").attr("name"),$(document.documentElement).on("keydown",function(e){13===e.which&&"0"===e.target.getAttribute("tabindex")&&$(e.target).trigger("click")}),n=!1,$("[role=script]").each(function(t){try{__HarloweEval($(this).html())}catch(e){n||(n=!0,dialog({parent:Utils.storyElement.parent(),message:"There is a problem with this story's "+Utils.nth(t+1)+" script:\n\n"+printJSError(e)}))}}),$("[role=stylesheet]").each(function(e,t){$(document.head).append("<style data-title=\"Story stylesheet '".concat(e+1,"'\">").concat($(t).html()))}),(e=Section.create()).stack=[{tempVariables:Object.create(VarScope)}],(r=Passages.loadMetadata(e)).length&&(t=dialog({parent:Utils.storyElement.parent(),message:"These errors occurred when running the `(metadata:)` macro calls in this story's passages:<p></p>"}),r.forEach(function(e){return t.find("p").append(e.render())})),(r=!Utils.options.debug&&State.hasSessionStorage&&sessionStorage.getItem("Saved Session"))&&!0===State.deserialise(e,r)?Engine.showPassage(State.passage):Engine.goToPassage(a))})}),define("macros",["utils/naturalsort","utils","utils/operationutils","datatypes/changercommand","datatypes/custommacro","datatypes/lambda","datatypes/codehook","internaltypes/changedescriptor","internaltypes/twineerror"],function(g,e,t,o,r,y,b,p,v){var w=e.insensitiveName,k=e.nth,S=e.andList,T=t.objectName,_=t.typeName,d=t.toSource,x=Array.isArray,i={};function O(e){return e===s.TypeSignature.Any||(x(e.innerType)?e.innerType.some(O):!!e.innerType&&O(e.innerType))}function a(e,t,n,r){var a,o,i,s,c,l,u,p,d=t.fn,f=t.typeSignature,h=t.returnType,m=(r=function(e){for(var t,n,r,a=[],o=0;o<e.length;o+=1)o in e&&(!0===(null==(t=e[o])?void 0:t.spreader)?(n=t.value,(r=v.containsError(n))?a.push(r):x(n)||"string"==typeof n?a.push.apply(a,_toConsumableArray(n)):n instanceof Set?a.push.apply(a,_toConsumableArray(Array.from(n).sort(g("en")))):a.push(v.create("operation","I can't spread out "+T(n)+", because it is not a string, dataset, or array."))):a.push(t));return a}(r),"string"!=typeof e&&(a=e,e=""),a?"":"("+(x(e)&&1<e.length?e[0]:e)+":)");for(e=a?a.TwineScript_KnownName?"the custom macro, ".concat(a.TwineScript_KnownName):"an unnamed custom macro":"the ".concat(m," macro"),o=0<f.length?1===f.length&&O(f[0])?1===r.length?"That value can't be given to macros as-is.":"Give only a single value to this macro.":e+" must only be given "+S(f.map(_))+(1<f.length?", in that order":"."):e+" must not be given any data."+(a?"":" Just write "+m),s=0,c=Math.max(r.length,f.length);s<c;s+=1){if(p=f[s],l=r[s],v.containsError(l))return l;if(s>=f.length&&!i)return v.create("datatype",r.length-f.length+" too many values were given to "+e+".",o);if(!(p=p||i).innerType||"rest"!==p.pattern&&"zero or more"!==p.pattern||(i=p.innerType,"rest"===p.pattern&&(p=p.innerType)),!function e(t,n){if(null===n)return void 0===t;var r=_typeof(t);if("function"!=typeof n&&n.pattern){if("optional"===n.pattern||"zero or more"===n.pattern)return void 0===t||e(t,n.innerType);if("either"===n.pattern){for(var a=0;a<n.innerType.length;a+=1)if(e(t,n.innerType[a]))return!0;return!1}if("lambda"===n.pattern&&e(t,n.innerType))return n.clauses.includes("where")===("where"in t||"each"in t)&&n.clauses.includes("making")==="making"in t&&n.clauses.includes("via")==="via"in t&&n.clauses.includes("with")==="with"in t;if("insensitive set"===n.pattern)return n.innerType.includes(w(t));if("range"===n.pattern)return n.range(t);if("wrapped"===n.pattern)return e(t,n.innerType)}return(void 0===n||void 0!==t)&&("anything"===n.TwineScript_TypeName&&void 0!==t&&!t.TwineScript_Unstorable||"everything"===n.TwineScript_TypeName&&void 0!==t||(n===String?"string"===r:n===Boolean?"boolean"===r:n===parseInt?"number"===r&&!Number.isNaN(t)&&!(t+"").includes("."):n===Number?"number"===r&&!Number.isNaN(t):n===Array?x(t):n===Map||n===Set?t instanceof n:Object.isPrototypeOf.call(n,t)))}(l,p))return void 0===l?(u=f.filter(function(e){return!("optional"===e.pattern||"zero or more"===e.pattern)}).length,v.create("datatype","".concat(e," was given ").concat(r.length?S(r.map(T)):"nothing",", but needs ").concat(u-s," more value").concat(1<u-s?"s":"","."),o)):null!=(u=l)&&u.TwineScript_Unstorable&&O(p)?v.create("datatype",e+"'s "+k(s+1)+" value, "+T(l)+", is not valid data for this macro.",o):b.isPrototypeOf(l)&&"Changer"===h?v.create("syntax","Please put this hook outside the parentheses of "+e+", not inside it.","Hooks should appear after a macro"+(a?".":": "+m+"[Some text]")):l&&y.isPrototypeOf(l)&&"lambda"===p.pattern?v.create("datatype",e+"'s "+k(s+1)+" value (a lambda) should have "+S(["where","when","making","via","with"].filter(function(e){return p.clauses.includes(e)}).map(function(e){return"a '"+e+"' clause"}))+", not "+S(["where","when","making","via","with"].filter(function(e){return e in l}).map(function(e){return"a '"+e+"' clause"}))+"."):"insensitive set"===p.pattern?v.create("datatype",T(l)+" is not a valid name string for "+e+".","Only the following names are recognised (capitalisation and hyphens ignored): "+S(p.innerType)+"."):v.create("datatype","".concat(e,"'s ").concat(k(s+1)," value is ").concat(T(l),", but should be ").concat(_(p),"."),p.message||o)}return d.apply(null,[n].concat(r))}function f(e,t,n,r){var a={fn:n,typeSignature:r=[].concat(r||[]),returnType:t};Object.freeze(a),[].concat(e).forEach(function(e){return Object.defineProperty(i,w(e),{value:a})})}var s={has:function(e){return e=w(e),hasOwnProperty.call(i,e)},get:function(e){return e=w(e),hasOwnProperty.call(i,e)&&i[e]},add:function e(t,n,r,a){return f(t,n,r,a),e},addChanger:function e(t,n,r,a){return f(t,"Changer",n,a),o.register(x(t)?t[0]:t,r),e},addCommand:function e(t,n,r,a){var s,c,l,u,o=!(4<arguments.length&&void 0!==arguments[4])||arguments[4],i=[].concat(t)[0];return f(t,"Command",(s=i,c=n,l=r,u=o,function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a,o,i=c.apply(void 0,n);return i||(a=p.create(),o=_objectSpread({TwineScript_TypeID:"command",TwineScript_ObjectName:"a (".concat(s,":) command"),TwineScript_TypeName:"a (".concat(s,":) command"),TwineScript_Print:function(){return"`[A (".concat(s,":) command]`")},TwineScript_ToSource:function(){return"(".concat(s,":").concat(n.map(d),")")},TwineScript_is:function(e){return d(this)===d(e)}},u?{TwineScript_Attach:function(e,t){return a.section=e,t.run(a),o},TwineScript_Run:function(e){e=l.apply(void 0,[a,e].concat(n));return a=p.create(),e}}:{TwineScript_Run:function(e){return l.apply(void 0,[e].concat(n))}}))}),a),e},TypeSignature:{optional:function(e){return{pattern:"optional",innerType:e}},zeroOrMore:function(e){return{pattern:"zero or more",innerType:e}},either:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{pattern:"either",innerType:t}},rest:function(e){return{pattern:"rest",innerType:e}},insensitiveSet:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{pattern:"insensitive set",innerType:t}},numberRange:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1/0;return{pattern:"range",min:t,max:n,range:function(e){return"number"==typeof e&&!Number.isNaN(e)&&t<=e&&e<=n}}},nonNegativeInteger:{pattern:"range",integer:!0,min:0,max:1/0,range:function(e){return"number"==typeof e&&!Number.isNaN(e)&&0<=e&&!(e+"").includes(".")}},positiveInteger:{pattern:"range",integer:!0,min:1,max:1/0,range:function(e){return"number"==typeof e&&!Number.isNaN(e)&&1<=e&&!(e+"").includes(".")}},wrapped:function(e,t){return{pattern:"wrapped",innerType:e,message:t}},Any:{TwineScript_TypeName:"anything"},Everything:{TwineScript_TypeName:"everything"}},run:function(e,t,n){return s.has(e)?a(e,s.get(e),t,n):v.create("macrocall","I can't run the macro '"+e+"' because it doesn't exist.","Did you mean to run a macro? If you have a word written like (this:), it is regarded as a macro name.")},runCustom:function(e,t,n){return r.isPrototypeOf(e)?a(e,e,t,n):v.containsError(e)?e:v.create("macrocall","I can't call ".concat(T(e)," because it isn't a custom macro."))}};return Object.assign(s.TypeSignature,{positiveNumber:s.TypeSignature.numberRange(Math.pow(2,-52),1/0),nonNegativeNumber:s.TypeSignature.numberRange(0,1/0),percent:s.TypeSignature.numberRange(0,1)}),Object.freeze(s)}),define("passages",["jquery","utils/naturalsort","utils","markup","internaltypes/twineerror"],function(t,s,e,c,l){var u=e.insensitiveName,p=e.unescape,n=e.onStartup,o=e.impossible,d=Object.assign,f=RegExp(c.Patterns.macroFront+c.Patterns.macroName,"ig");function r(e){var t,r,a,o,n=e.attr("name"),i=p(e.html()),s=(t=n,o=["metadata","storylet","exclusivity","urgency"],((s=i).match(f)||[]).some(function(t){return o.some(function(e){return u(t.slice(1,-1))===e})})?(r=!1,a={},c.lex(s,t).children.forEach(function e(t){if("macro"===t.type){var n=u(t.name);if(o.some(function(e){return n===e})){if(l.isPrototypeOf(a[n]))return;if(r)return void(a[n]=l.create("syntax","The (".concat(t.name,":) macro can't appear after non-metadata macros.")));if(a[n])return void(a[n]=l.create("syntax","There is more than one (".concat(t.name,":) macro.")));a[n]=t}else r=!0;t.children.forEach(function e(t){var n=u(t.name);"macro"===t.type&&o.some(function(e){return n===e})?a[n]=l.create("syntax","The (".concat(t.name,":) macro can't be inside another macro.")):t.children.forEach(e)})}else t.children.forEach(e)}),a):{});return d(new Map([["source",i],["tags",(e.attr("tags")||"").split(/\s/)||[]],["name",n]]),{TwineScript_TypeName:"a passage datamap",TwineScript_ObjectName:"a passage datamap",metadata:s,tree:null})}var a=Object.create(null),i=[],h=null,m=d(new Map,{TwineScript_ObjectName:"the Passages datamap",getTagged:function(n){var e,r;return a[n]||(e=s("en",function(e){return e.get("name")}),r=[],this.forEach(function(e){var t=e instanceof Map&&e.get("tags");Array.isArray(t)&&t.includes(n)&&r.push(e)}),r.sort(e),a[n]=r)},clearTagCache:function(){a=Object.create(null)},clear:function(){Map.prototype.clear.call(this),this.clearTagCache(),this.clearTreeCache(),this.clearStoryletCache()},delete:function(){var e;(e=Map.prototype.delete).call.apply(e,[this].concat(Array.prototype.slice.call(arguments))),this.clearTagCache(),this.clearTreeCache(),this.clearStoryletCache()},getTree:function(e){if(!this.has(e))return o("Passages.getTree","No passage name?"),[];var t=this.get(e),n=t.get("tags");if(n.includes("header")||n.includes("footer")||n.includes("debug-header")||n.includes("debug-footer"))return t.tree||(t.tree=c.lex(t.get("source"),e)),t.tree;for(var r,a=0;a<i.length;a+=1)if(i[a]&&i[a].place===e)return r=i.splice(a,1)[0],i.unshift(r),r;n=c.lex(t.get("source"),e);return i.unshift(n),16<i.length&&i.pop(),n},clearTreeCache:function(){i=[]},getStorylets:function(r,e){var a,o,i,e=e?e.filter(r,_toConsumableArray(m.values())):_toConsumableArray(m.values());return l.containsError(e)?e:(a=[],o=-1/0,e.reduce(function(e,t){if(e)return e;e=t.get("storylet");if(e){var n=r.speculate(e,t.get("name"),"a (storylet:) macro");if(l.containsError(n))return n.message="There's an error in the storylet passage \""+t.get("name")+'":\n'+n.message,n.source=e.TwineScript_ToSource(),n;n&&(e=t.get("exclusivity"),o=Math.max(o,"number"==typeof e?e:0),a.push(t))}},void 0)||(i=s("en"),a.filter(function(e){e=e.get("exclusivity");return("number"==typeof e?e:0)===o}).sort(function(e,t){var n=e.get("urgency"),r=t.get("urgency");return(n="number"==typeof n?n:0)!==(r="number"==typeof r?r:0)?r-n:i(e.get("name"),t.get("name"))})))},allStorylets:function(){return h=h||_toConsumableArray(m.values()).filter(function(e){return e.get("storylet")})},clearStoryletCache:function(){h=null},loadMetadata:function(i){var s=[];return m.forEach(function(o){o.metadata&&Object.keys(o.metadata).forEach(function(e){var t,n,r;function a(e,t){o.has(e)?s.push(l.create("syntax","This passage's datamap already has a '"+JSON.stringify(e)+"' data name.")):o.set(e,t)}l.containsError(o.metadata[e])?s.push(o.metadata[e]):(t=o.metadata[e],n=i.speculate(t,o.get("name"),"a ("+e+":) macro"),r='In "'+o.get("name")+'":\n',l.containsError(n)?(n.message=r+n.message,n.source=t.text,s.push(n)):n instanceof Map?n.forEach(function(e,t){return a(t,e)}):a(e,n))}),o.metadata=void 0}),s},hasValid:function(e){e=this.get(e);return e&&e instanceof Map&&e.has("source")},create:r});return n(function(){t("tw-storydata > tw-passagedata").get().forEach(function(e){e=t(e),m.set(e.attr("name"),new r(e))})}),m}),define("renderer",["jquery","utils","markup","internaltypes/twineerror"],function(a,e,S,T){var _=e.escape,x=e.insensitiveName,O=e.options;function A(e,t,n){n=2<arguments.length&&void 0!==n?n:"";return"<"+t+(n?" "+n:"")+">"+e+"</"+t+">"}var C="text-align: center; max-width:50%; ";function E(m,g){function y(e,t,n){e=E(e.children,g);return e&&A(e,t,n)}var b="",v=[];if(m)for(var e,w=(m=Array.isArray(m)?m:[m]).length,k=0;k<w;k+=1)if(e=function(e){var n=m[e];switch(n.type){case"include":b+=y(n,"tw-"+n.type,'type="'.concat(n.tag,'" name="').concat(n.name,'"'));break;case"error":b+=T.create("syntax",n.message,n.explanation).render(_(n.text))[0].outerHTML;break;case"numbered":case"bulleted":for(var t="numbered"===n.type?"ol":"ul",r=(b+="<"+t+">",1);e<w&&m[e];){if("br"===m[e].type){if(b+="</li>",!m[e+1]||m[e+1].type!==n.type)break}else m[e].type===n.type?(b=(b+=("<"+t+">").repeat(Math.max(0,m[e].depth-r)))+("</"+t+">").repeat(Math.max(0,r-m[e].depth))+"<li>",r=m[e].depth):b+=E([m[e]],g);e+=1}b+=("</"+t+">").repeat(r+1);break;case"align":for(;n&&"align"===n.type;){var a=n.align,o=e+=1;if("left"===a){--e;break}for(;e<w&&m[e]&&"align"!==m[e].type;)e+=1;var o=E(m.slice(o,e),g),i="";switch(a){case"center":i+=C+"margin-left: auto; margin-right: auto;";break;case"justify":case"right":i+="text-align: "+a+";";break;default:+a&&(i+=C+"margin-left: "+a+"%;")}b+="<tw-align "+(i?'style="'+i+'"':"")+">"+o+"</tw-align>\n",n=m[e]}break;case"column":for(var s,c=[];n&&"column"===n.type;){var l=n.column,u=e+=1;if("none"===l){--e;break}for(;e<w&&m[e]&&"column"!==m[e].type;)e+=1;c.push({text:n.text,type:l,body:E(m.slice(u,e),g),width:n.width,marginLeft:n.marginLeft,marginRight:n.marginRight}),n=m[e]}c.length&&(s=c.reduce(function(e,t){return e+t.width},0),b+="<tw-columns>"+c.map(function(e){return"<tw-column type=".concat(e.type," ",' style="width:').concat(e.width/s*100,"%; margin-left: ").concat(e.marginLeft,"em; margin-right: ").concat(e.marginRight,'em;">').concat(e.body,"</tw-column>\n")}).join("")+"</tw-columns>");break;case"heading":for(b+="<h"+n.depth+">";++e<w&&m[e];){if("br"===m[e].type){b+="</h"+n.depth+">";break}b+=E([m[e]],g)}break;case"br":if(!v.length||/td|th/.test(v[0])){b+="<br>";for(var p=m[e+1];p&&("br"===p.type||"tag"===p.type&&/^<br\b/i.test(p.text));)b+="<tw-consecutive-br"+("tag"===p.type?" data-raw":"")+"></tw-consecutive-br>",p=m[(e+=1)+1]}break;case"hr":b+="<hr>";break;case"escapedLine":case"comment":break;case"inlineUrl":b+='<a class="link" href="'+_(n.text)+'">'+n.text+"</a>";break;case"scriptStyleTag":case"tag":var d=n.text.toLowerCase();/^<\/?(?:table|thead|tbody|tr|tfoot|td|th|svg)\b/.test(d)&&!n.text.endsWith("/>")&&v[n.text.startsWith("</")?"shift":"unshift"](d),b+=n.text.startsWith("</")?n.text:n.text.replace(/(\/)?>$/,function(e,t){return" data-raw".concat(t?"></".concat(n.text.match(/[\w-]+/)):"",">")});break;case"sub":case"sup":case"strong":case"em":b+=y(n,n.type);break;case"strike":b+=y(n,"s");break;case"bold":b+=y(n,"b");break;case"italic":b+=y(n,"i");break;case"twineLink":d=_slicedToArray(S.lex("(link-goto:"+JSON.stringify(n.innerText)+","+JSON.stringify(n.passage)+")").children,1)[0];b+='<tw-expression type="macro" name="link-goto"'+(O.debug?' title="'+_(n.text)+'"':"")+' code="'+g.code.length+'"></tw-expression>',g.code.push(d);break;case"hook":b+="<tw-hook "+(n.hidden?"hidden ":"")+(n.name?'name="'+x(n.name)+'"':"")+(O.debug&&n.name?' title="Hook: ?'+n.name+'"':"")+' source="'+g.source.length+'"></tw-hook>',g.source.push(n.children);break;case"unclosedHook":return b+="<tw-hook "+(n.hidden?"hidden ":"")+(n.name?'name="'+x(n.name)+'"':"")+'source="'+g.source.length+'"></tw-hook>',g.source.push(m.slice(e+1,w)),{v:b};case"verbatim":b+=A(_(n.innerText).replace(/\n/g,"<br>"),"tw-verbatim");break;case"collapsed":b+=y(n,"tw-collapsed");break;case"unclosedCollapsed":return{v:b+="<tw-collapsed>"+E(m.slice(e+1,w),g)+"</tw-collapsed>"};case"variable":case"tempVariable":case"macro":var f=[],h=[];if("macro"===n.type&&!function e(t){"string"!==t.type&&"hook"!==t.type&&t.children.every(e);var n=x(t.name);if("macro"!==t.type||"prompt"!==n&&"confirm"!==n){if("hook"===t.type&&!t.everyLeaf(function(e){return"error"!==e.type||(h.push(e),!1)}))return!1}else f.push(t);return!0}(n),h.length)return{v:T.create("syntax","This code hook's markup contained "+h.length+" error"+(h.length?"s":"")+":<br>\u2014"+h.map(function(e){return e.message}).join("<br>\u2014")).render(_(n.text))[0].outerHTML};d=f.map(function(e){return e.blockerTree=g.blockers.length,g.blockers.push(e),e.blockerTree});b+='<tw-expression type="'+n.type+'" name="'+_(n.name||n.text)+'"'+(O.debug?' title="'+_(n.text)+'"':"")+(d.length?' blockers="'+d+'"':"")+' code="'+g.code.length+'"></tw-expression>',g.code.push(n);break;default:b+=n.children&&n.children.length?E(n.children,g):n.text}k=e}(k))return e.v;return b}return Object.freeze({exec:function(e){var r={code:[],blockers:[],source:[]},e=E(e="string"==typeof e?S.lex(e).children:e,r),e=a(a.parseHTML(e,document,!0));return e.findAndFilter("script:not([src])").each(function(e,t){var n=t.getAttribute("type");n&&"text/javascript"!==n.toLowerCase()||t.setAttribute("type","application/x-harlowe")}),r.blockers=r.blockers.map(function(e){e.blockedValue=!0;e=Object.create(e);return e.blockedValue=!1,e}),e.findAndFilter("tw-expression[code]:not([data-raw]), tw-expression[blockers]:not([data-raw]), tw-hook[source]:not([data-raw])").each(function(e,t){var n;(t=a(t)).attr("blockers")&&(n=t.popAttr("blockers").split(",").map(function(e){return r.blockers[e]}),t.data("blockers",n)),t.attr("source")&&t.data("source",r.source[t.popAttr("source")]),t.attr("code")&&t.data("code",r.code[t.popAttr("code")])}),e}})}),define("repl",["utils","markup","section"],function(e,t,n){e.onStartup(function(){return setTimeout(function(){e.options.debug&&(window.REPL=function(e){e=n.create().eval(t.lex("(print:"+e+")"));return e.TwineScript_Run?e.TwineScript_Run().source:e},window.LEX=function(e){e=t.lex(e);return 1===e.length?e[0]:e})})})}),define("section",["jquery","utils","twinescript/runner","twinescript/operations","state","utils/operationutils","utils/renderutils","utils/scripttag","datatypes/changercommand","datatypes/colour","datatypes/lambda","datatypes/codehook","internaltypes/changedescriptor","internaltypes/varscope","internaltypes/twineerror","internaltypes/twinenotifier"],function(p,f,a,u,r,e,t,i,d,h,o,m,g,y,b,v){var w=e.printBuiltinValue,k=e.objectName,S=e.typeID,T=e.isObject,s=t.collapse,_=Object.assign,x=Object.create,O=Object.keys;function A(e,t,n){if(t&&"object"===_typeof(t)&&d.isPrototypeOf(t)){var r=n.popData("source")||(null==(r=n[0].cachedData)?void 0:r.source),a=(null!=(a=n[0])&&a.cachedData&&(n[0].cachedData.source=void 0),n.data("originalSource",r),g.create({target:n,source:r,section:this,append:"append"})),o=t.run(a);if(b.containsError(o)&&e.replaceWith(o.render(e.attr("title"))),!this.renderInto(r,null,a))return o=f.insensitiveName(e.attr("name")),["if","elseif","unless","else","testfalse"].includes(o)&&(e.addClass("false"),"elseif"!==o)&&(this.stackTop.lastHookShown=!1),n.data("live")&&function(t,n,r){function a(e){p&&(d-=(e-p)*(f.options.debug&&void 0!==f.options.speedMultiplier?f.options.speedMultiplier:1)),p=e,0<d?requestAnimationFrame(a):(d=s,o())}var o,i=this,e=r.data("live"),s=e.delay,c=e.event,l=((n=_objectSpread(_objectSpread({},n),{},{append:"replace",transitionDeferred:!1,enabled:!0})).data=_objectSpread(_objectSpread({},n.data),{},{live:void 0}),r.data("originalSource")||""),u=this.stackTop.tempVariables,p=null,d=s;o=this.whenUnblocked.bind(this,function(){var e;i.inDOM()&&(e=null==c?void 0:c.filter(i,[!0],u),b.containsError(e)?e.render(i,t.attr("title")).replaceAll(t):c&&!e[0]?requestAnimationFrame(a):(i.renderInto(l,r,n,u),e||r.find("tw-expression[name='stop']").length||i.inDOM()&&requestAnimationFrame(a)))}),requestAnimationFrame(a)}.call(this,e,a,n),!0}else{if(!1===t)return o=n.popData("source")||(null==(r=n[0].cachedData)?void 0:r.source),null!=(a=n[0])&&a.cachedData&&(n[0].cachedData.source=void 0),o&&(n.cachedData&&(n.cachedData.source=void 0),n.data("originalSource",o),n.data("hidden",!0)),e.addClass("false"),!(this.stackTop.lastHookShown=!1);if(!0!==t)return!1}return this.stackTop.lastHookShown=!0}function C(e){var t,n,e=(e instanceof p?e[0]:e).nextSibling;return e&&(e instanceof Text&&!e.textContent.trim()||["br","tw-consecutive-br"].includes((e.tagName||"").toLowerCase()))?(t=(n=C(e)).whitespace,n=n.nextElem,{whitespace:p(e).add(t),nextElem:n}):{whitespace:p(),nextElem:p(e)}}function E(e){if(null!=e&&e.length)return p("<tw-open-button replay label='\ud83d\udd0d'>").data("evalReplay",e)}function c(e,t){var n=this.eval(t);e.append(E(this.evalReplay)),e.append(function(e,t){if(/a \((go-to|undo|redirect|restart):\) command/.exec(null==t?void 0:t.TwineScript_TypeName))return p("<tw-open-button goto label='GO'>").data("goto",{section:e,command:t})}(this,n)),this.stackTop.evaluateOnly&&n&&(d.isPrototypeOf(n)||"function"==typeof n.TwineScript_Run)&&(n=b.create("syntax","I can't work out what ".concat(this.stackTop.evaluateOnly," should evaluate to, because it contains a ").concat(d.isPrototypeOf(n)?"changer.":"command."),"Please rewrite this without putting changers or commands here."));var r=p();for(i=e;d.isPrototypeOf(n);){var a=C(i),o=a.whitespace;if((i=a.nextElem)[0]&&i[0].nodeType===Node.TEXT_NODE&&"+"===i[0].textContent.trim()){var i,a=i,s=C(a),c=s.whitespace;if((i=s.nextElem).is("tw-expression")){var s=i.popData("code")||(null==(s=i[0])||null==(s=s.cachedData)?void 0:s.code),l=(null!=(l=i[0])&&l.cachedData&&(i[0].cachedData.code=void 0),this.eval(s));if(b.containsError(l)){n=l;break}s=u["+"](n,l);p(o).add(a).add(c).remove(),n=b.containsError(s)?b.create("operation","I can't combine "+k(n)+" with "+k(l)+".","function"==typeof l.TwineScript_Run?"If you want to attach this changer to ".concat(k(l),", remove the + between them."):"Changers can only be added to other changers."):s;continue}}if(i.is("tw-expression")){c=i.popData("code")||(null==(a=i[0])||null==(a=a.cachedData)?void 0:a.code),s=(null!=(l=i[0])&&l.cachedData&&(i[0].cachedData.code=void 0),this.eval(c));if(i.append(E(this.evalReplay)),b.containsError(s)){n=s;break}if(s&&"object"===_typeof(s)&&"function"==typeof s.TwineScript_Attach){n=s.TwineScript_Attach(this,n);break}return d.isPrototypeOf(s)?void e.replaceWith(b.create("operation","Changers like (".concat(n.macroName,":) need to be combined using + between them."),"Place the + between the changer macros, or the variables holding them. The + is absent only between a changer and its attached hook or command.").render(e.attr("title"))):void e.replaceWith(b.create("operation","".concat(k(s)," can't have changers like (").concat(n.macroName,":) attached."),"Changers placed just before hooks, links and commands will attempt to attach, but in this case it didn't work.").render(e.attr("title")))}if(i.is("tw-hook")){o.remove(),r=i;break}n.macroName||f.impossible("Section.runExpression","changer has no macroName");a=e.attr("title")||"("+n.macroName+": ...)";return void e.replaceWith(b.create("syntax","The (".concat(n.macroName,":) changer should be stored in a variable or attached to a hook."),"Macros like this should appear before a hook: ".concat(a,"[Some text]")).render(e.attr("title")))}e.attr("return",S(n)),r=r.length?r:C(e).nextElem.filter("tw-hook"),(t=b.containsError(n))?e.replaceWith(t.render(e.attr("title")).append(E(this.evalReplay))):v.isPrototypeOf(n)?e.append(n.render()):n&&"function"==typeof n.TwineScript_Run?(n=n.TwineScript_Run(this),b.containsError(n)?e.replaceWith(n.render(e.attr("title"))):g.isPrototypeOf(n)?null!=(t=n.data)&&t.live?e.replaceWith(b.create("unimplemented","I currently can't attach (live:) or (event:) macros to commands - only hooks.").render(e.attr("title"))):(n.section=this,n.target=i,this.renderInto("",i,n)):T(n)&&n.blocked?(this.stackTop.blocked=n.blocked,e.data("code",{type:"macro",blockedValue:!0,text:e.attr("title")||"",start:0,end:(e.attr("title")||"").length})):n&&f.impossible("Section.runExpression","TwineScript_Run() returned a non-ChangeDescriptor ".concat(_typeof(n),': "').concat(n,'"'))):r.length&&A.call(this,e,n,r)||("string"==typeof n||"number"==typeof n||n instanceof Map||n instanceof Set||Array.isArray(n)||h.isPrototypeOf(n)||m.isPrototypeOf(n)||n&&"function"==typeof n.TwineScript_Print&&!d.isPrototypeOf(n)?(n=w(n),b.containsError(n)?e.replaceWith(n.render(e.attr("title"))):"string"==typeof n||Array.isArray(n)?this.renderInto(n,e):f.impossible("printBuiltinValue() produced a non-string non-array ".concat(_typeof(n)))):d.isPrototypeOf(n)||"boolean"==typeof n||f.impossible("Section.runExpression","The expression evaluated to an unknown value: ".concat(n)))}var l={add:[],remove:[]};return Object.preventExtensions({create:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:f.storyElement,n=_(x(this),{timestamp:Date.now(),dom:e,stack:[],enchantments:[],unblockCallbacks:[],freeVariables:null,evalReplay:null,loadedGame:!1,Identifiers:{TwineScript_Identifiers:!0,it:0,get time(){var e;return null!=(e=n.stackTop)&&e.evaluateOnly?b.create("operation","'time' can't be used in ".concat(n.stackTop.evaluateOnly,".")):(Date.now()-n.timestamp)*(f.options.debug&&void 0!==f.options.speedMultiplier?f.options.speedMultiplier:1)},get turns(){return r.turns},get turn(){return r.turns},get visits(){var t=n.stackTop.speculativePassage;return r.history().filter(function(e){return e===(t||r.passage)}).length+(!t||t===r.passage)},get visit(){return n.Identifiers.visits},get exits(){var e;return null!=(e=n.stackTop)&&e.evaluateOnly?b.create("operation","'exit' and 'exits' can't be used in ".concat(n.stackTop.evaluateOnly,".")):n.dom.find("tw-enchantment, tw-link").filter(function(e,t){return(t=p(t)).data("enchantmentEvent")||t.parent().data("linkPassageName")||t.parent().data("clickEvent")}).length},get exit(){return n.Identifiers.exits},get pos(){return n.stackTop&&!n.stackTop.evaluateOnly&&n.stackTop.lambdaPos?+n.stackTop.lambdaPos||1:b.create("operation","'pos' can only be used in lambdas that aren't 'when' lambdas.")}}});return n},eval:function(t){var e,n;f.options.debug&&f.options.evalReplay&&(n=Array.isArray(t)?t.reduce(function(e,t){return e+t.text},""):t.text||"",this.evalReplay=[{code:n,fromCode:n,basis:(Array.isArray(t)?t[0]:t).start,start:0,end:n.length,diff:0}]);try{e=a(this,t)}catch(e){return null!=(n=window.console)&&n.error(e),this.evalReplay=null,b.create("","An internal error occurred while trying to run ".concat([].concat(t).map(function(e){return e.text}).join(""),"."),'The error was "'.concat(e.message,'".\nIf this is the latest version of Harlowe, please consider reporting a bug (see the documentation).'))}return this.evalReplay&&2===this.evalReplay.length&&this.evalReplay.shift(),e},get stackTop(){return this.stack[0]},inDOM:function(){return 0<f.storyElement.find(this.dom).length},evaluateTwineMarkup:function(e,t){var n=p("<p>");return this.stack.unshift({desc:g.create({target:n,source:e,section:this,append:"append"}),tempVariables:this.stackTop.tempVariables,evaluateOnly:t,finalIter:!0}),this.execute(),0<(e=n.find("tw-error")).length?e:n},speculate:function(e,t,n){this.stack.unshift({evaluateOnly:n,finalIter:!0,tempVariables:_(x(y),{TwineScript_VariableStore:{type:"temp",name:n}}),speculativePassage:t});var r,n=this.evalReplay;return this.evalReplay=null,o.isPrototypeOf(e)?r=e.apply(this,{fail:!1,pass:!0}):e&&(r=a(this,e)),this.stack.shift(),this.evalReplay=n,r},renderInto:function(e,a,t){var o=this,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,i=g.create({target:a,source:e,section:this,append:"append"});if(t)if(d.isPrototypeOf(t)){var e=t.run(i);if(b.containsError(e))return e.render(a.attr("title")).replaceAll(a),!1}else _(i,t);if((a=i.target,50<=this.stack.length)&&50<=this.stack.reduce(function(e,t){return e+!!t.finalIter},0))return b.create("infinite","Printing this expression may have trapped me in an infinite loop.").render(a.attr("title")).replaceAll(a),!1;var s=function(e,t,n){var r=a instanceof p&&a.is("tw-hook")&&0<a.parents("tw-collapsed,[collapsing=true]").length;o.stack.unshift({desc:e,finalIter:n,tempVariables:t,collapses:r,evaluateOnly:o.stackTop&&o.stackTop.evaluateOnly})},r=r||x(this.stack.length?this.stackTop.tempVariables:y),t=(hasOwnProperty.call(r,"TwineScript_VariableStore")||(t=null==(e=a)?void 0:e.tag(),r.TwineScript_VariableStore={type:"temp",name:"tw-hook"===t?a.attr("name")?"?"+a.attr("name"):"an unnamed hook":"tw-expression"===t?"a "+a.attr("type")+" expression":"tw-passage"===t?"this passage":"an unknown scope"}),null==(e=this.stackTop)?void 0:e.blocked);if(O(i.loopVars).length){var c=_objectSpread({},i.loopVars),l=Math.min.apply(Math,_toConsumableArray(O(c).map(function(e){return c[e].length})));if(v.create(l+" loop"+(1!==l?"s":"")).render().prependTo(a),l){for(var n=l-1;0<=n;--n)!function(n){s(i,O(c).reduce(function(e,t){return e[t]=c[t][n],e},x(r),n===l-1))}(n);for(var u=l-1;0<=u&&!this.stackTop.blocked;--u)this.execute()}}else s(i,r,!0),this.execute();return(0===this.stack.length||!t&&null!=(e=this.stackTop)&&e.blocked)&&this.updateEnchantments(),i.enabled},execute:function(){var a=this,e=this.stackTop,t=e.desc,n=e.dom,r=e.collapses,o=e.evaluateOnly;t&&!n&&(n=t.render(),this.stackTop.dom=n,this.stackTop.desc=void 0),n.findAndFilter('tw-hook,tw-expression,script[type="application/x-harlowe"]').each(function(e,t){var n=p(t).data();t.cachedData={blockers:n.blockers,code:n.code,source:n.source}}).each(function(e,t){if(a.stackTop.blocked)return!1;var n=t.cachedData;switch(n&&(t.cachedData=void 0),(t=p(t)).tag()){case"tw-hook":var r=t.popData("source")||(null==n?void 0:n.source);(r&&t.data("originalSource",r),t.data("tempVariables",a.stackTop.tempVariables),t.popAttr("hidden"))?t.data("hidden",!0):r&&a.renderInto(r,t);break;case"tw-expression":var r=t.data("blockers")||(null==n?void 0:n.blockers);if(r){if(o)return void t.removeData("blockers").removeData("code").replaceWith(b.create("syntax","I can't use a macro like (prompt:) or (confirm:) in ".concat(o,"."),"Please rewrite this without putting such macros here.").render(t.attr("title"),t));if(r.length)return a.stackTop.blocked=!0,r=a.eval(r.shift()),b.containsError(r)&&(a.stackTop.blocked=!1,t.removeData("blockers").replaceWith(r.render(t.attr("title"),t))),!1;t.removeData("blockers")}r=t.popData("code")||(null==n?void 0:n.code);r&&c.call(a,t,r);break;case"script":if(f.reattachStoryElement(),t.text())try{i(t.text(),a.stackTop.tempVariables)}catch(e){b.isPrototypeOf(e)?t.replaceWith(e.render(t.text(),t)):(null!=(r=window.console)&&r.error(e),t.replaceWith(b.create("","A Javascript error occurred while running this <script> element.",'The error was "'.concat(e,'". Check the browser console for more details.')).render(t.text(),t)))}}}),this.stackTop.blocked||(n.length&&r&&s(n),n.findAndFilter("tw-collapsed,[collapsing=true]").each(function(){s(p(this))}),setTimeout(function(){return n.find("input, textarea").first().focus()},100),this.stack.shift())},updateEnchantments:function(){this.enchantments.forEach(function(e){e.disenchant(),e.enchantScope()})},on:function(e,t){return l[e].push(t),this},addEnchantment:function(t){var n=this;this.enchantments.push(t),l.add.forEach(function(e){return e(n,t)})},removeEnchantment:function(t){var n=this,e=this.enchantments.indexOf(t);this.enchantments.splice(e,1),t.disenchant(),l.remove.forEach(function(e){return e(n,t)})},unblock:function(e){for(this.stack.length||f.impossible("Section.unblock","stack is empty"),this.stackTop.blocked=!1,void 0!==e&&(this.stackTop.blockedValues=(this.stackTop.blockedValues||[]).concat(e));this.stack.length&&!this.stackTop.blocked;)this.execute();if(!this.stack.length)for(;0<this.unblockCallbacks.length;){var t;if(this.unblockCallbacks.shift()(),null!=(t=this.stackTop)&&t.blocked)return}},whenUnblocked:function(e,t){this.stack.length&&this.stackTop.blocked?this.unblockCallbacks=this.unblockCallbacks.concat(e):(t||e)()},blockedValue:function(){var e=this.stackTop;return e?e.blockedValues&&e.blockedValues.length?e.blockedValues.shift():(f.impossible("Section.blockedValue","blockedValues is missing or empty"),0):(f.impossible("Section.blockedValue","stack is empty"),0)}})}),define("state",["jquery","utils","passages","datatypes/customcommand","utils/operationutils","markup"],function(n,y,b,v,e,t){var i,w,C=e.toSource,E=e.is,k=t.lex,o=Object.assign,h=Object.create,e=Object.defineProperty,N=Array.isArray,s=Math.imul,t=(e(Map.prototype,"toJSON",{value:void 0}),e(Set.prototype,"toJSON",{value:void 0}),["localStorage","sessionStorage"].map(function(e){try{return!!window[e]&&(window[e].setItem("test","1"),window[e].removeItem("test"),!0)}catch(e){return!1}}));function S(e,t){var n=0<arguments.length&&void 0!==e?e:String.fromCodePoint(Date.now()%1114112),e=1<arguments.length&&void 0!==t?t:0;i.seedIter=e,i.seed=n;for(var r,a=0,o=2166136261;a<n.length;a+=1)r=s(n.charCodeAt(a),3432918353),o^=s(r<<15|r>>>17,461845907),o=s(o=o<<13|o>>>19,5)+3864292196|0;return o^=n.length,o=s(o^=o>>>16,2246822507),o=s(o^=o>>>13,3266489909),o=((o^=o>>>16)>>>0)+1831565813*e,function(){i.seedIter+=1;var e=o+=1831565813,e=s(e^e>>>15,1|e);return(((e^=e+s(e^e>>>7,61|e))^e>>>14)>>>0)/4294967296}}function r(e,t){for(var n,r=t.variables,a=h(null),o=e.length-1;0<=o;--o){for(var i,s,c=e[o],l=0,u=["mockVisits","mockTurns","seed","seedIter"];l<u.length;l++){var p=u[l];hasOwnProperty.call(c,p)&&!hasOwnProperty.call(t,p)&&(t[p]=c[p])}for(i in c.forgetVisits&&(t.forgetVisits=Math.max(t.forgetVisits||0,c.forgetVisits)),void 0!==c.turns&&(t.turns=(t.turns||0)+c.turns),t.pastVisits||(t.pastVisits=[]),o!==e.length-1&&(void 0!==e[o+1].visits&&Array.isArray(t.pastVisits[0])?t.pastVisits[0]:t.pastVisits).unshift(c.passage),void 0!==c.pastVisits&&t.pastVisits.unshift(c.pastVisits),void 0!==c.visits&&t.pastVisits.unshift(c.visits),c.variables)if("TwineScript_TypeDefs"===i)for(var d in r[i]||(r[i]=h(null)),c.variables[i])r[i][d]||(r[i][d]=c.variables[i][d]);else i.startsWith("TwineScript_")||i in r||(null===c.variables[i]&&(a[i]=!0),a[i])||(r[i]=c.variables[i],!(s=c.valueRefs[i]))||"via"in s||t.valueRefs[i]||(t.valueRefs[i]=s)}for(n in t.valueRefs){var f=t.valueRefs[n];f&&"via"in f&&delete t.valueRefs[n]}}var a,c={passage:"",variables:h(null),visits:void 0,turns:void 0,seed:void 0,seedIter:void 0,mockVisits:void 0,mockTurns:void 0,forgetVisits:void 0,create:function(e){var t=h(c);return t.passage=e||"",t.variables=h(null),t.valueRefs=h(null),t}},l={forward:[],back:[],load:[],beforeForward:[],beforeBack:[],beforeLoad:[],forgetUndos:[]},u=[],p=-1,d=c.create(),f="";function m(){i.history=i.pastVisits.slice(i.forgetVisits).reduce(function(e,t){return e.concat(t)},[]),i.mockVisits&&(i.history=i.mockVisits.concat(i.history))}function g(){var e=c.create();e.pastVisits=[],o(e.variables,{TwineScript_ObjectName:"this story's variables",TwineScript_TypeDefs:h(null),TwineScript_VariableStore:{type:"global",name:"this story's variables"},TwineScript_Delete:function(e){delete this[e],d.variables[e]=null,delete d.valueRefs[e]},TwineScript_Set:function(e,t,n){if(this[e]=t,d.variables[e]=t,n)d.valueRefs[e]=n;else if((N(t)||t instanceof Map||t instanceof Set||"string"==typeof t)&&!y.options.uncompressedStructures)for(var r=p;0<=r;--r){var a=u[r].variables[e];if(void 0!==a){a=function e(t,n,r){var a="it"===r?"its":r+"'s",o="";if(N(n)&&N(t)&&n.length){for(var i=n.length===t.length,o="(a:",s=0;s<n.length;s+=1){var c,l,u,p=n[s];E(p,t[s])?(c=C(p),l="".concat(a," ").concat(s+1,"th"),o+=(c.length<l.length?c:l)+","):(i=!1,-1<(c=t.indexOf(p))?(l=C(p),u="".concat(a," ").concat(c+1,"th"),o+=(l.length<u.length?l:u)+","):o+=e(t[s],p,"".concat(a," ").concat(s+1,"th"))+",")}o=i?r:o.slice(0,-1)+")"}else if(n instanceof Map&&t instanceof Map&&n.size){var d,f=n.size===t.size,h=(o="(dm:",_createForOfIteratorHelper(n.entries()));try{for(h.s();!(d=h.n()).done;){var m,g,y=_slicedToArray(d.value,2),b=y[0],v=y[1];o+="".concat(C(b),","),E(v,t.get(b))?(m=C(v),g="".concat(a," (").concat(C(b),")"),o+=(m.length<g.length?m:g)+","):(f=!1,o+=e(t.get(b),v,"".concat(a," (").concat(C(b),")"))+",")}}catch(e){h.e(e)}finally{h.f()}o=f?r:o.slice(0,-1)+")"}else if(n instanceof Set&&t instanceof Set&&n.size){var w,k=new Set,S=new Set,T=_createForOfIteratorHelper(t);try{for(T.s();!(w=T.n()).done;){var _=w.value;n.has(_)||k.add(_)}}catch(e){T.e(e)}finally{T.f()}var x,O=_createForOfIteratorHelper(n);try{for(O.s();!(x=O.n()).done;){var A=x.value;t.has(A)||S.add(A)}}catch(e){O.e(e)}finally{O.f()}k.size||S.size||(o=r),o=k.size+S.size>n.size?C(n):r+(S.size?"+"+C(S):"")+(k.size?"-"+C(k):"")}else"string"==typeof n&&"string"==typeof t&&n&&(n.startsWith(t)?o=r+"+"+C(n.slice(t.length)):n.endsWith(t)&&(o=C(n.slice(0,n.length-t.length))+"+"+r));return o?"it"===r?{via:o}:o:"it"===r?void 0:C(n)}(a,t,"it");a&&("it"===a.via?delete d.variables[e]:d.valueRefs[e]=a);break}}},TwineScript_GetProperty:function(e){return this[e]},TwineScript_DefineType:function(e,t){this.TwineScript_TypeDefs[e]=t,hasOwnProperty.call(d.variables,"TwineScript_TypeDefs")||(d.variables.TwineScript_TypeDefs=h(null)),d.variables.TwineScript_TypeDefs[e]=t}}),r(u.slice(0,p+1),e),i=e,m(),w=S(e.seed,e.seedIter)}function T(e){d=c.create(e);e=a.serialise(!0),f=e.past,e=e.pastAndPresent;if(a.hasSessionStorage&&"string"==typeof e)try{sessionStorage.setItem("Saved Session",e)}catch(e){}}function _(e,t,n,r){for(var a in r)if(hasOwnProperty.call(r,a)&&!a.startsWith("TwineScript_"))if("object"===_typeof(r[a]))if(hasOwnProperty.call(r[a],"at")){n.valueRefs[a]=r[a];var o=r[a],i=o.at,s=o.from,c=o.to,l=o.hash,u=o.seed,p=o.seedIter,o=o.blockedValues;if(!b.has(i))throw Error('The data refers to a passage named `"'.concat(n.passage,"\"`, but it isn't in this story."));var d=b.get(i).get("source"),f=d.slice(s,c);if(void 0!==l)for(var h=0,m=c-s;y.hash(f).toString(16)!==l;){if(h+m>=d.length)throw Error("The value (or type) of the variable `$".concat(a,"` couldn't be found in the passage `\"").concat(i,'"`.'));(h+=1)===s&&(h+=1),f=d.slice(h,h+m)}c=k(f,"","macro");void 0!==u&&void 0!==p&&(w=S(u,p)),void 0!==o&&(e.stackTop.blockedValues=o,c.forEach(function e(t){var n;"string"!==t.type&&"hook"!==t.type&&t.children.every(e),"macro"!==t.type||"prompt"!==(n=y.insensitiveName(t.name))&&"confirm"!==n||(t.blockedValue=!0)})),r[a]=e.eval(c)}else if(hasOwnProperty.call(r[a],"via")){for(var g=t.length-1;0<=g;--g)if(hasOwnProperty.call(t[g].variables,a)){e.Identifiers.it=t[g].variables[a];break}r[a]=e.eval(k(r[a].via,"","macro")),e.Identifiers.it=0}else hasOwnProperty.call(r[a],"changer")&&(r[a].changer=e.eval(k(r[a].changer,"","macro")),r[a].hook=e.eval(k(r[a].hook,"","macro")),_(e,t,n,r[a].variables),r[a]=v.create(r[a]));else r[a]=e.eval(k(r[a],"","macro"));else"TwineScript_MockVisits"===a&&(n.mockVisits=r[a])}return g(),d.seed=i.seed,d.seedIter=0,(a={get passage(){return d.passage},get variables(){return i.variables},get pastLength(){return p},get turns(){return p+1+(i.turns||0)+(i.mockTurns||0)},get futureLength(){return u.length-1-p},get mockVisits(){return i.mockVisits||[]},set mockVisits(e){i.mockVisits=e,d.mockVisits=e,m()},get mockTurns(){return i.mockTurns||0},set mockTurns(e){i.mockTurns=e,d.mockTurns=e},history:function(){return i.history},forgetUndos:function(e){e<0&&(e=u.length+e);var t,e=u.splice(0,Math.min(u.length-1,e));e.length&&(p=u.length-1,t=u[0],r(e,t),t.pastVisits.push(e[e.length-1].passage),t.turns=(t.turns||0)+e.length,i.turns=(i.turns||0)+e.length,t.forgetVisits&&(t.pastVisits=t.pastVisits.slice(t.forgetVisits-t.turns),t.forgetVisits-=t.turns),f="",0===p&&n("tw-link[undo], tw-icon[alt='Undo']",y.storyElement).each(function(e,t){(n(t).closest("tw-expression, tw-hook").data("forgetUndosEvent")||Object)(t)}),l.forgetUndos.forEach(function(e){return e()}))},forgetVisits:function(e){(e=e<0?u.length+e:e)>p+i.turns&&(e=p+i.turns),d.forgetVisits=i.forgetVisits=Math.max(i.forgetVisits||0,e),m()},passageNameVisited:function(e){var t=0;if(!b.get(e))return 0;for(var n=0;n<i.history.length;n++)t+=+(e===i.history[n]);return t},get timeline(){return u},play:function(t){var e;d||y.impossible("State.play","present is undefined!"),l.beforeForward.forEach(function(e){return e()}),d.passage&&((null!=(e=d.visits)&&e.length&&Array.isArray(i.pastVisits[i.pastVisits.length-1])?i.pastVisits[i.pastVisits.length-1]:i.pastVisits).push(d.passage),i.history.push(d.passage)),d.passage=t,u=u.slice(0,p+1).concat(d),p+=1,T(t),l.forward.forEach(function(e){return e(t)})},redirect:function(e){var t;d||y.impossible("State.redirect","present is undefined!"),d.passage&&(null!=(t=d.visits)&&t.length&&Array.isArray(i.pastVisits[i.pastVisits.length-1])?i.pastVisits[i.pastVisits.length-1].push(d.passage):i.pastVisits.push([d.passage]),i.history.push(d.passage)),d.visits=(d.visits||[]).concat(e),d.passage=e},rewind:function(e){for(var t=void 0!==e?e:1,n=!1;0<t&&0<p;t--)n=!0,--p;return n&&(l.beforeBack.forEach(function(e){return e()}),f="",T(u[p].passage),g(),l.back.forEach(function(e){return e()})),n},fastForward:function(e){var t=1,n=!1;for("number"==typeof e&&(t=e);0<t&&0<u.length;t--)n=!0,p+=1;return n&&(l.beforeForward.forEach(function(e){return e()}),T(u[p].passage),g(),l.forward.forEach(function(e){return e(u[p].passage,"fastForward")})),n},on:function(e,t){if(e in l)return"function"!=typeof t||l[e].includes(t)||l[e].push(t),a;y.impossible("State.on","invalid event name")},reset:function(){l.beforeLoad.forEach(function(e){return e()}),u=[],p=-1,g(),(d=c.create()).seed=i.seed,d.seedIter=0,f="",w=S(),l.load.forEach(function(e){return e(u)})},hasStorage:t[0],hasSessionStorage:t[1],setSeed:function(e){w=S(e),d.seed=i.seed,d.seedIter=0},get seed(){return i.seed},get seedIter(){return i.seedIter},random:function(){var e=w();return d.seedIter=i.seedIter,e},shuffled:function(){for(var a=this,e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t.reduce(function(e,t,n){var r=a.random()*(n+1)|0;return r===n?e.push(t):(e.push(e[r]),e[r]=t),e},[]);return d.seedIter=i.seedIter,r}}).serialise=function(e){function o(e,t){if("TwineScript_TypeDefs"===t){var n,r={};for(n in e[t])r[n]=C(e[t][n]);return r}var a;return null===e[t]?null:e[t]&&hasOwnProperty.call(e[t],"TwineScript_CustomCommand")?(a=e[t].TwineScript_CustomCommand(),{changer:C(a.changer),toSource:a.toSource,hook:C(a.hook),variables:Object.keys(a.variables).reduce(function(e,t){return e[t]=o(a.variables,t),e},{})}):C(e[t])}function t(e,t){if(c.isPrototypeOf(t)&&void 0===t.visits&&void 0===t.turns&&void 0===t.mockVisits&&void 0===t.forgetVisits&&void 0===t.pastVisits&&void 0===t.mockTurns&&void 0===t.seed&&void 0===t.seedIter&&Object.keys(t.variables).every(function(e){return e.startsWith("TwineScript_")}))return t.passage;if(!c.isPrototypeOf(this)||"valueRefs"!==e){if(c.isPrototypeOf(this)&&"variables"===e){var n,r={};for(n in this.variables)this.valueRefs[n]?r[n]=this.valueRefs[n]:r[n]=o(this.variables,n);return r}return t}}var e=u.slice(f?e?p-1:p:0,p+1),n=e.slice(0,-1),r=f;try{return{past:r=n.length?(r?r.slice(0,-1)+",":"[")+JSON.stringify(n,t).slice(1):r,pastAndPresent:r.slice(0,-1)+(r?",":"[")+JSON.stringify(e.slice(-1),t).slice(1)}}catch(e){return{past:!1,pastAndPresent:!1}}},a.deserialise=function(e,t){var n;try{n=JSON.parse(t)}catch(e){return Error("The save data is unintelligible.")}if(!N(n))return Error("The save data isn't a sequence of past turns.");for(var r=0;r<n.length;r+=1){var a=n[r];if("string"==typeof a)a={passage:a,variables:{}};else if("object"!==_typeof(a)||!hasOwnProperty.call(a,"variables")){n.splice(r--,1);continue}if(a.valueRefs=h(null),a.variables=o(h(null),a.variables),!b.hasValid(a.passage))return Error('The data refers to a passage named `"'.concat(a.passage,"\"`, but it isn't in this story."));if(hasOwnProperty.call(a.variables,"TwineScript_TypeDefs"))try{_(e,n.slice(0,r),a,a.variables.TwineScript_TypeDefs)}catch(e){return Error("The variable types on turn ".concat(r+1," couldn't be reconstructed.").concat(e.message?" (".concat(e.message,")"):""))}try{_(e,n.slice(0,r),a,a.variables)}catch(e){return Error("The variables on turn ".concat(r+1," couldn't be reconstructed.").concat(e.message?" (".concat(e.message,")"):""))}n[r]=o(h(c),a)}return p=(u=n).length-1,l.load.forEach(function(e){return e(u)}),f="",g(),T(u[p].passage),!0},Object.seal(c),Object.freeze(a)}),define("utils",["jquery","markup","utils/polyfills"],function(d){var r=String.fromCharCode,n="audio,blockquote,canvas,div,h1,h2,h3,h4,h5,hr,ol,p,pre,table,ul,video,tw-align,tw-story,tw-passage,tw-sidebar,tw-columns,tw-column,tw-meter".split(","),a="a,b,i,em,strong,sup,sub,abbr,acronym,s,strike,del,big,small,script,img,button,input,tw-link,tw-broken-link,tw-verbatim,tw-collapsed,tw-error,tw-colour,tw-icon".split(","),f=["audio"],e=_slicedToArray([function(e){return r(e)!==r(e).toLowerCase()},function(e){return r(e)!==r(e).toUpperCase()},function(e){return r(e).toLowerCase()!==r(e).toUpperCase()}].map(function(e){return"["+Array.from(Array(57343)).map(function(e,t){return t}).filter(e).map(function(e,t,n){return e===n[t-1]+1&&e===n[t+1]-1?"-":r(e)}).join("").replace(/-+/g,"-")+"]"}),3),t=e[0],o=e[1],e=e[2];function s(e){return"instant"===e?0:800}var i,c,l=[],u={},p=0,h={},m=0,g={};function y(n,r,e,a,o){var i=null,s=0,c=r+e;function l(e){var t;1&n[0].compareDocumentPosition(document)&&(c=0),i&&(c-=t=e-i),i=e,0<a&&0<p+m&&n.data("expediteAnim")(a),c<=r&&(s+=t||0,"paused"===n.css("animation-play-state"))&&n.css({visibility:"","animation-play-state":"running"}),c<=0?(n.removeData("expediteAnim"),o()):requestAnimationFrame(l)}n.data("expediteAnim",function(e){var t;c-=e=void 0===e?s:e,"running"===n.css("animation-play-state")&&n.css("animation-delay",(("ms"===(t=(t=n.css("animation-delay")).toLowerCase()).slice(-2)?+t.slice(0,-2)||0:"s"===t.slice(-1)&&1e3*+t.slice(0,-1)||0)||0)-e+"ms")}),c?requestAnimationFrame(l):l()}d(document.documentElement).on("keydown keyup mousedown mouseup",function(e){var t=e.key,n=e.button,e=e.type.includes("down"),r=t?u:h,n=t&&v.insensitiveName(t)||n;r[n]&&!e?t?p=Math.max(p-1,0):m=Math.max(m-1,0):!r[n]&&e&&(t?p+=1:m+=1),r[n]=e}).on("mousemove",function(e){var t=e.pageX,e=e.pageY;g.x=t,g.y=e});var b=/-|_/g,v={hash:function(e){for(var t=9,n=e.length;0<n;)--n,t=Math.imul(t^e.charCodeAt(n),Math.pow(9,9));return(t^t>>>9)>>>0},permutations:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r,a,o=t.length,i=[[].concat(t)],s=Array(o).fill(0),c=1;c<o;)s[c]<c?(r=c%2&&s[c],a=t[c],t[c]=t[r],t[r]=a,++s[c],c=1,i.push([].concat(t))):(s[c]=0,++c);return i},nth:function(e){var t=+e+"";return e+("1"!==t[t.length-1]||1!==t.length&&"1"===t[t.length-2]?"2"!==t[t.length-1]||1!==t.length&&"1"===t[t.length-2]?"3"!==t[t.length-1]||1!==t.length&&"1"===t[t.length-2]?"th":"rd":"nd":"st")},plural:function(e,t,n){return e+" "+(1!==Math.abs(e)?n||t+"s":t)},andList:function(e){return e.length<=1?e[0]:e.slice(0,-1).join(", ")+" and "+e[e.length-1]},realWhitespace:"[ \\n\\r\\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]",anyRealLetter:"[\\dA-Za-z\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171\\uD800-\\uDFFF]",anyUppercase:t,anyLowercase:o,anyCasedLetter:e,anyNewline:"(?:\\n|\\r|\\r\\n)",unescape:function(e){return e.replace(/&(?:amp|lt|gt|quot|nbsp|zwnj|#39|#96);/g,function(e){return{"&amp;":"&","&gt;":">","&lt;":"<","&quot;":'"',"&#39;":"'","&nbsp;":String.fromCharCode(160),"&zwnj;":String.fromCharCode(8204)}[e]})},escape:function(e){return e.replace(/[&><"']/g,function(e){return{"&":"&amp;",">":"&gt;","<":"&lt;",'"':"&quot;","'":"&#39;"}[e]})},insensitiveName:function(e){return(e+"").toLowerCase().replace(b,"")},allKeysDown:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.every(function(e){return u[e]})},someKeysDown:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.some(function(e){return u[e]})},buttonsDown:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.every(function(e){return h[e]})},anyInputDown:function(){return 0<p+m},mouseCoords:g,parentColours:function(e){for(var t,n={colour:null,backgroundColour:null},r=/^\w+a\(.+?,\s*0\s*\)$|^transparent$/;e.length&&e[0]!==document;e=e.parent())if(n.backgroundColour||(t=e.css("background-color")).match(r)||(n.backgroundColour=t),n.colour||(t=e.css("color")).match(r)||(n.colour=t),n.colour&&n.backgroundColour)return n;return{colour:"#fff",backgroundColour:"#000"}},childrenProbablyInline:function(e){var t=[];return[].every.call(e.findAndFilter("*"),function(e){if(!(e.hidden||/none|inline/.test(e.style.display)||/display: (none|inline)/.test(e.getAttribute("style")))){if(n.includes(e.tagName.toLowerCase())||/display: (?!none|inline|inherit|unset)/.test(e.getAttribute("style")))return!1;a.includes(e.tagName.toLowerCase())||t.push(e)}return!0})&&t.every(function(e){return/inline|none/.test(window.getComputedStyle(e).display)})},transitionOut:function(e,t,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,o=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,i=6<arguments.length&&void 0!==arguments[6]?arguments[6]:void 0;0!==e.length&&(n=n||s(t),!(1<e.length)&&v.childrenProbablyInline(e)&&["tw-hook","tw-passage","tw-sidebar","tw-expression"].includes(e.tag())||(e=e.wrapAll("<tw-transition-container>").parent()),i&&e.css("transform-origin",i),e.attr("data-t8n",t).addClass("transition-out").css({"animation-duration":"".concat(n,"ms"),"animation-delay":"".concat(-o,"ms"),"animation-play-state":"paused"}),requestAnimationFrame(function(){v.childrenProbablyInline(e)?e.css("display","inline"):e.parent().is("tw-backdrop,tw-story")||e[0].setAttribute("style",e[0].getAttribute("style")+"display:block !important;width:100%")}),y(e,n,r-o,a,function(){e.remove()}))},transitionIn:function(u,e,t){var p,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:void 0;0!==u.length&&(t=t||s(e),(p=1<u.length||!v.childrenProbablyInline(u)||!["tw-hook","tw-passage","tw-sidebar","tw-expression"].includes(u.tag()))&&(u=u.wrapAll("<tw-transition-container>").parent()),o&&u.css("transform-origin",o),u.attr("data-t8n",e).addClass("transition-in").css(_objectSpread({"animation-duration":"".concat(t,"ms"),"animation-delay":"".concat(-a,"ms")},n-a?{visibility:"hidden","animation-play-state":"paused"}:{})),requestAnimationFrame(function(){v.childrenProbablyInline(u)?u.css("display","inline"):u.parent().is("tw-backdrop,tw-story")||u[0].setAttribute("style",u[0].getAttribute("style")+"display:block !important;width:100%")}),y(u,t,n-a,r,function(){var e=0===u.filter(f.join(",")).length;if(p&&e){u.find("tw-transition-container, .transition-in, .transition-out").each(function(e,t){((t=d(t)).data("expediteAnim")||Object)()});for(var t=[],n=u.find("*"),r=0;r<n.length;r+=1){var a=n[r];0===a.scrollTop&&0===a.scrollLeft||t.push([a,a.scrollLeft,a.scrollTop])}e=u.find(document.activeElement);u.contents().unwrap();for(var o=0,i=t;o<i.length;o++){var s=_slicedToArray(i[o],3),c=s[0],l=s[1],s=s[2];c.scrollLeft=l,c.scrollTop=s}e.length&&e[0].focus()}else u.removeClass("transition-in").removeAttr("data-t8n")}))},debounce:function(e){function t(){300<Date.now()-l||s<=u?(u=n=0,p=!i,o?(e(c),c=[]):e.apply(void 0,_toConsumableArray(c)),p=!1):n=requestAnimationFrame(t)}var n,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=r.batch,o=void 0!==a&&a,a=r.recur,i=void 0!==a&&a,a=r.maxWait,s=void 0===a?1/0:a,c=[],l=0,u=0,p=!1;return function(){var e;p||(e=Date.now(),u+=e-l,l=e,o?c.push(arguments):c=arguments,n&&cancelAnimationFrame(n),n=requestAnimationFrame(t))}},impossible:function(e,t){window.console&&console.error(e+"(): "+t)},onStartup:function(e){l?l.push(e):e()},get storyElement(){return i},detachStoryElement:function(){document.documentElement.contains(i[0])&&(c=i.parent(),i.detach())},reattachStoryElement:function(){document.documentElement.contains(i[0])||(c||d(document.body)).append(i.parents().length?i.parents().last():i)},options:{speedMultiplier:1}};return d(function(){i=d("tw-story"),l.forEach(function(e){return e()}),l=null}),Object.freeze(v)}),define("datatypes/assignmentrequest",["utils/operationutils","datatypes/typedvar","datatypes/datatype","internaltypes/varref","internaltypes/twineerror"],function(e,y,b,v,w){var k=e.objectName,S=e.matches,t=e.toSource;return Object.freeze({assignmentRequest:!0,TwineScript_TypeName:"a VariableToValue (a 'to' or 'into' expression)",TwineScript_ObjectName:"a VariableToValue (a 'to' or 'into' expression)",TwineScript_ToSource:function(){return"into"===this.operator?"".concat(t(this.src)," ").concat(this.operator," ").concat(t(this.dest)):"".concat(t(this.dest)," ").concat(this.operator," ").concat(t(this.src))},TwineScript_Unstorable:!0,set:function(){var e,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0],n=[],r=function e(t,n,r){var a=!(2<arguments.length&&void 0!==r)||r,o=[],i=n&&v.isPrototypeOf(n)?n.get():n;if(w.containsError(i))return i;if(Array.isArray(i)&&Array.isArray(t)){for(var s=0,c=0;s<t.length&&c<i.length;){var l=t[s],u=i[c];if(y.isPrototypeOf(l)&&l.datatype.rest||b.isPrototypeOf(l)&&l.rest){for(var p=c;c<i.length&&S(l,u);)u=i[c+=1];y.isPrototypeOf(l)?l.datatype=[l.datatype]:b.isPrototypeOf(l)&&(l=b.create("array")),o=o.concat(e(l,v.isPrototypeOf(n)?v.create(n,{first:p+1,last:c+1}):i.slice(p,c)))}else o=o.concat(e(l,v.isPrototypeOf(n)?v.create(n,c+1):u)),c+=1;s+=1}return s<t.length?a&&w.create("operation","I can't unpack this array because it needs ".concat(t.length-s," more value").concat(0<t.length-s?"s":"",".")):o}if(t instanceof Map&&i instanceof Map){var d,f=_createForOfIteratorHelper(t.entries());try{for(f.s();!(d=f.n()).done;){var h=_slicedToArray(d.value,2),m=h[0],g=h[1];if(!i.has(m))return a&&w.create("operation","I can't unpack this datamap because it needs a '"+m+"' data name.");o=o.concat(e(g,v.isPrototypeOf(n)?v.create(n,m):i.get(m)))}}catch(e){f.e(e)}finally{f.f()}return o}if(y.isPrototypeOf(t)){if("function"==typeof t.datatype.destructure)return[{dest:t,value:i,src:n}].concat(t.datatype.destructure(i));if(!S(i,t.datatype))return a&&w.create("operation","I can't put ".concat(k(i)," into ").concat(t.varRef.TwineScript_ToSource()," because it doesn't match ").concat(t.varRef.TwineScript_ToSource(),"'s datatype, ").concat(k(t.datatype),"."));o=o.concat(e(t.datatype,i))}return v.isPrototypeOf(t)||y.isPrototypeOf(t)?o.concat({dest:t,value:i,src:n}):"function"==typeof t.destructure?o.concat(t.destructure(i)):S(i,t)?o:a&&w.create("operation","I tried to unpack, but "+k(t)+" in the pattern didn't match "+k(i)+".")}(this.dest,this.src);if(e=w.containsError(r))return e;if(!r.length)return w.create("operation","I can't store a new value inside "+k(this.dest)+" that isn't in a variable.","You need a variable, or a data structure containing variables at certain positions, to store the value.");var a,o=_createForOfIteratorHelper(r.reverse());try{for(o.s();!(a=o.n()).done;){var i=a.value,s=i.dest,c=i.value,l=i.src;if(y.isPrototypeOf(s)){if(e=w.containsError(s.defineType()))return e;s=s.varRef}if(e=s.set(c,this.srcRef),w.isPrototypeOf(e))return e;t&&l&&l.delete(),n.shift(k(s)+" is now "+k(c))}}catch(e){o.e(e)}finally{o.f()}return n.join("; ")},create:function(e,t,n,r){return w.containsError(e)?e:w.containsError(t)?t:Object.assign(Object.create(this),{dest:e,src:t,operator:n,srcRef:r})}})}),define("datatypes/changercommand",["utils","utils/operationutils","internaltypes/changedescriptor","internaltypes/twineerror"],function(e,t,n,r){var i=e.plural,a=e.impossible,o=t.is,s=t.toSource,c={},l={TwineScript_TypeID:"changer",TwineScript_TypeName:"a changer",TwineScript_Print:function(){return"`[A ("+this.macroName+":) changer]`"},TwineScript_ToSource:function(){return"("+this.macroName+":"+("else"===this.name?"":this.params.map(s))+")"+(this.next?"+"+this.next.TwineScript_ToSource():"")},get TwineScript_ObjectName(){1===this.params.length&&36<(e=s(this.params[0])).length&&(e=void 0);for(var e,t="a (".concat(this.macroName,":").concat(e||"",") changer"),n=this.next,r=(n&&(t+=" combined with "),0);n&&t.length<48;){var a="(".concat(n.macroName,":)");t+=(0<r&&!n.next?" and ":"")+a+(n.next?", ":""),n=n.next,r+=1}for(var o=0;n&&o<99;)n=n.next,o+=1;return 0<o&&(t+="".concat(0<r?" and ":"").concat(i(o,"other changer"))),t},summary:function(){var e=n.create();return this.run(e),e.summary()},create:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,r=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];return Array.isArray(t)||a("ChangerCommand.create","params was not an array but "+t),Object.assign(Object.create(this),{macroName:e,params:t,next:n,canEnchant:r})},"TwineScript_+":function(e){for(var t=this.TwineScript_Clone(),n=t;n.next;)n=n.next;return n.next=e,t.canEnchant=this.canEnchant&&e.canEnchant,t},TwineScript_is:function(e){if(l.isPrototypeOf(e))return this.macroName===e.macroName&&o(this.params,e.params)&&o(this.next,e.next)},TwineScript_Clone:function(){for(var e=l.create(this.macroName,this.params,this.next),t=e;t.next;)t=t.next=t.next.TwineScript_Clone();return e.canEnchant=this.canEnchant,e},run:function(e,t){var n="output"===this.macroName?[t||this]:this.params,n=c[this.macroName].apply(c,[e].concat(_toConsumableArray(n)));if(r.containsError(n))return n;this.next&&this.next.run(e,t||this)},register:function(e,t){c[e]=t}};return Object.freeze(l)}),define("datatypes/codehook",[],function(){var t=Object.freeze({TwineScript_TypeName:"a code hook",TwineScript_ObjectName:"a code hook",TwineScript_ToSource:function(){return this.source},TwineScript_Print:function(){return this.code},TwineScript_toString:function(){return this.source},TwineScript_is:function(e){return t.isPrototypeOf(e)&&this.source===e.source},TwineScript_Clone:function(){return t.create(this.code,this.source)},create:function(e,t){return Object.assign(Object.create(this),{code:e,source:t})}});return t}),define("datatypes/colour",["jquery"],function(c){var l=Math.max,u=Math.min,a=Math.sin,o=Math.cos,i=Math.pow,p=Math.round,d=Math.floor,s=Math.atan2,f=Math.cbrt,h=Math.sqrt,m=Math.PI,g=Object.assign,y=Object.create,b=/^([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,t=/^([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,v=y(null);function w(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];if(0<r.length)return w.apply(void 0,[w(e,t)].concat(r));if(!t)return e;for(var o=[],i=0;i<e.length;i++){o[i]=[];for(var s=0;s<t[0].length;s++){for(var c=0,l=0;l<e[0].length;l++)c+=e[i][l]*t[l][s];o[i][s]=c}}return o}function n(e){var t,n=e.r,r=e.g,a=e.b,e=e.a,o=l(n/=255,r/=255,a/=255),i=u(n,r,a),s=(o+i)/2,c=o-i;if(o===i)return{h:0,s:0,l:s};switch(o){case n:t=(r-a)/c+(r<a?6:0);break;case r:t=(a-n)/c+2;break;case a:t=(n-r)/c+4}return{h:t=p(60*t),s:.5<s?c/(2-o-i):c/(o+i),l:s,a:e}}var k=[.9642956764295677,1,.8251046025104602],S=24389/27,T=216/24389,_=function(e){return e.map(function(e){return[e]})},x=function(e){return e.map(function(e){return e[0]})};function O(e){var t=e.l,n=e.c,r=e.h,e=e.a,n=[t*=100,n*o(r*m/180),n*a(r*m/180)],r=[];r[1]=(n[0]+16)/116,r[0]=n[1]/500+r[1],r[2]=r[1]-n[2]/200;n=[i(r[0],3)>T?i(r[0],3):(116*r[0]-16)/S,S*T<t?i((16+t)/116,3):t/S,i(r[2],3)>T?i(r[2],3):(116*r[2]-16)/S].map(function(e,t){return e*k[t]}),t=_slicedToArray(x(w([[3.2409699419045226,-1.537383177570094,-.4986107602930034],[-.9692436362808796,1.8759675015077202,.04155505740717559],[.05563007969699366,-.20397695888897652,1.0569715142428786]],w([[.9554734527042182,-.023098536874261423,.0632593086610217],[-.028369706963208136,1.0099954580058226,.021041398966943008],[.012314001688319899,-.020507696433477912,1.3303659366080753]],_(n)))).map(function(e){return u(255,l(0,255*(.0031308<(e=e)?1.055*i(e,1/2.4)-.055:12.92*e)))}),3);return{r:t[0],g:t[1],b:t[2],a:e}}function e(e){function t(e){return 1e-5<=n[e]&&n[e]<=255-1e-5}var n=O(e);if(Object.keys(n).every(t))return n;var r=(e=_objectSpread({},e)).c,a=0;for(e.c/=2;1e-5<r-a;)n=O(e),Object.keys(n).every(t)?a=e.c:r=e.c,e.c=(r+a)/2;return O(e)}var A=Object.freeze({TwineScript_TypeID:"colour",TwineScript_TypeName:"a colour",TwineScript_ObjectName:"a colour",TwineScript_DebugName:function(){return"a colour "+this.TwineScript_Print()},"TwineScript_+":function(e){var t=this.toRGBA(),e=e.toRGBA();return A.create({r:u(p(.6*(t.r+e.r)),255),g:u(p(.6*(t.g+e.g)),255),b:u(p(.6*(t.b+e.b)),255),a:(t.a+e.a)/2})},TwineScript_Print:function(){var e=this.toRGBA();return"<tw-colour style='background-color:rgba("+[e.r,e.g,e.b,e.a]+");'></tw-colour>"},TwineScript_is:function(e){var t;return!!A.isPrototypeOf(e)&&(e.lcha&&this.lcha?e.lcha.l===this.lcha.l&&e.lcha.c===this.lcha.c&&e.lcha.h===this.lcha.h&&e.a===this.a:(t=this.toRGBA(),(e=e.toRGBA()).r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a))},TwineScript_Clone:function(){return A.create(this)},toRGBAString:function(){var e=this.toRGBA(),t=e.r,n=e.g,r=e.b,e=e.a;return"rgba(".concat(t,", ").concat(n,", ").concat(r,", ").concat(e,")")},toHSLA:function(){return n(this.toRGBA())},toRGBA:function(){return this.lch?e(_objectSpread({a:this.a},this.lch)):this},toLCHA:function(){return this.lch?_objectSpread({a:this.a},this.lch):(t=(e=this).r,n=e.g,r=e.b,e=e.a,n=[116*(t=x(w([[1.0479298208405488,.022946793341019088,-.05019222954313557],[.029627815688159344,.990434484573249,-.01707382502938514],[-.009243058152591178,.015055144896577895,.7518742899580008]],w([[.41239079926595934,.357584339383878,.1804807884018343],[.21263900587151027,.715168678767756,.07219231536073371],[.01933081871559182,.11919477979462598,.9505321522496607]],_([t/255,n/255,r/255].map(function(e){return e<.04045?e/12.92:i((e+.055)/1.055,2.4)}))))).map(function(e,t){return e/k[t]}).map(function(e){return T<e?f(e):(S*e+16)/116}))[1]-16,500*(t[0]-t[1]),200*(t[1]-t[2])],r=180*s(n[2],n[1])/m,{l:n[0]/100,c:h(i(n[1],2)+i(n[2],2)),h:0<=r?r:360+r,a:e});var e,t,n,r},LCHRotate:function(e){e<0&&(e=360+e);var t=this.toLCHA();return t.h=(t.h+e)%360,A.create(t)},TwineScript_GetProperty:function(e){var t;return"lch"===e?(t=this.toLCHA(),new Map([["l",t.l],["c",t.c],["h",t.h]])):(t=this.toRGBA(),"h"===e||"s"===e||"l"===e?n(t)[e]:"r"===e||"g"===e||"b"===e||"a"===e?t[e]:void 0)},TwineScript_Properties:["h","s","l","r","g","b","a","lch"],TwineScript_ToSource:function(){if(0===this.a)return"transparent";var e=!this.lch&&n(this);if(1===e.l&&!e.h&&!e.s)return"white";if(0===e.l&&!e.h&&!e.s)return"black";if(.5<=e.l&&e.l<.5334&&0===e.s)return"gray";if(.5===e.l&&.8<=e.s&&e.s<.804){var t={0:"red",30:"orange",60:"yellow",90:"lime",120:"green",180:"cyan",210:"blue",240:"navy",270:"purple",300:"magenta"}[e.h];if(t)return t}return"(".concat(this.lch?"lch":"hsl",":").concat(this.lch?[this.lch.l,this.lch.c,this.lch.h]:[e.h,e.s,e.l]).concat(1!==this.a?","+this.a:"",")")},create:function(e){var t,n,r,a,o,i;return"string"==typeof e?this.create((A.isHexString(e)?function(e){return"string"!=typeof e?e:(e=(e=e.replace("#","")).replace(b,"$1$1$2$2$3$3"),{r:parseInt(e.slice(0,2),16),g:parseInt(e.slice(2,4),16),b:parseInt(e.slice(4,6),16)})}:function(e){var t;return e in v?v[e]:(t="transparent"===(t=c("<p>").css("background-color",e).css("background-color"))?{r:0,g:0,b:0,a:0}:t.startsWith("rgb")?t.match(/\d+/g).reduce(function(e,t,n){return e["rgb"[n]]=+t,e},{}):{r:192,g:192,b:192},v[e]=t)})(e)):!("h"in e&&"s"in e&&"l"in e)||"r"in e||"g"in e||"b"in e?("a"in e&&"number"==typeof e.a||(e.a=1),"h"in e&&"c"in e&&!("s"in e)&&"l"in e?g(y(this),{a:e.a,lch:{l:e.l,c:e.c,h:e.h}}):g(y(this),e)):this.create((a=(t=e).h,o=e.s,i=e.l,t=e.a,0===o?{r:e=d(255*i),g:e,b:e}:(r=2*i-(n=i<.5?i*(1+o):i+o-i*o),{r:d(255*s((a/=360)+1/3)),g:d(255*s(a)),b:d(255*s(a-1/3)),a:t})));function s(e){return e<0&&(e+=1),1<e&&--e,e<1/6?r+6*(n-r)*e:e<.5?n:e<2/3?r+(n-r)*(2/3-e)*6:r}},isHexString:function(e){return"string"==typeof e&&"#"===e[0]&&(e.slice(1).match(b)||e.slice(1).match(t))},isCSS3Function:function(e){return"string"==typeof e&&/^(?:rgb|hsl)a?\(\s*\d+(?:\.\d+)?\s*,\s*\d+(?:\.\d+)?%?\s*,\s*\d+(?:\.\d+)?%?(?:,\s*\d+(?:\.\d+)?\s*)?\)$/.test(e)}});return A}),define("datatypes/customcommand",["internaltypes/changedescriptor","internaltypes/twineerror"],function(l,u){var p=Object.assign,d=Object.create;return Object.seal({TwineScript_TypeID:"command",TwineScript_ObjectName:"a custom command",TwineScript_TypeName:"a custom command",TwineScript_Print:function(){return"`[a custom command]`"},create:function(e){var t,n=e.toSource,r=e.changer,a=e.hook,o=e.variables,i={};for(t in o)i[t]=[o[t]];var s,c=l.create({source:a,loopVars:i},r);return u.containsError(c)?c:s=p(d(this),{TwineScript_Attach:function(e,t){c.section=e;e=t.run(c);return u.containsError(e)?e:s},TwineScript_Run:function(e){c.section=e;e=c;return c=l.create({source:a,loopVars:i},r),e},TwineScript_ToSource:function(){return n},TwineScript_CustomCommand:function(){return e}})}})}),define("datatypes/custommacro",["jquery","utils","renderer","utils/operationutils","datatypes/customcommand","internaltypes/varref","internaltypes/varscope","internaltypes/twineerror","internaltypes/twinenotifier"],function(w,e,k,t,S,T,_,x,O){function n(v){return function(e){v.called+=1;for(var t=v.varNames,n=v.params,r=v.body,a=E(N(_),{TwineScript_VariableStore:{type:"temp",name:v.TwineScript_ObjectName+" call #"+v.called},TwineScript_TypeDefs:N(null)}),o=[],i=0,s=!1,c=arguments.length,l=new Array(1<c?c-1:0),u=1;u<c;u++)l[u-1]=arguments[u];for(var p=0;p<l.length;p+=1){var d=l[p],f=t[i],h=(a.TwineScript_TypeDefs[f]=n[i].datatype.rest?n[i].datatype.create("array"):n[i].datatype,T.create(a,f));if(x.containsError(h))return h;if(n[i].datatype.rest){var s=!0,m=(a[f]||[]).concat([d]);if(p<l.length-1){a[f]=m;continue}h.set(m)}else h.set(d),i+=1;o.push(O.create(A(h)+" is now "+A(a[f])))}if(!s&&null!=(g=n[i])&&g.datatype.rest){var g=T.create(a,t[i]);if(x.containsError(g))return g;g.set([]),a.TwineScript_TypeDefs[name]=n[i].datatype.create("array")}var y,g=w("<p>").append(k.exec(r.code)),b=e.stack.length,r=(e.stack.unshift({tempVariables:a,dom:g,output:function(e){y=e}}),e.evalReplay);for(e.evalReplay=null,e.execute();e.stack.length>b;)e.stack.shift();e.evalReplay=r;r=g.find("tw-error");return r.length?(g.prepend(o.map(function(e){return e.render()}),"<br>"),x.create("propagated","".concat(r.length," error").concat(1<r.length?"s":""," occurred when running ").concat(v.TwineScript_ObjectName,"."),void 0,g)):void 0===y?x.create("custommacro","".concat(v.TwineScript_ObjectName," didn't output any data or hooks using (output:) or (output-data:).")):"object"===_typeof(y)&&"changer"in y?S.create(E(y,{toSource:"(".concat(v.TwineScript_KnownName||"unnamed",":").concat(l.map(C),")")})):y}}var r=e.andList,A=t.objectName,a=t.typeName,o=t.matches,C=t.toSource,E=Object.assign,N=Object.create,i=Object.seal({TwineScript_TypeID:"macro",TwineScript_TypeName:"a custom macro",TwineScript_GetProperty:function(e){if("params"===e)return _toConsumableArray(this.params)},TwineScript_Properties:["params"],TwineScript_Print:function(){return"`["+this.TwineScript_ObjectName+"]`"},TwineScript_Clone:function(){var e=E(N(i),this);return e.fn=n(e),e},TwineScript_ToSource:function(){return"(macro:"+this.params.map(function(e){return e.TwineScript_ToSource()}).concat("")+this.body.TwineScript_ToSource()+")"},createFromFn:function(e,t,n,r){return E(N(i),{params:[],fn:e,typeSignature:r,TwineScript_ObjectName:t,TwineScript_ToSource:n,TwineScript_KnownName:""})},create:function(e,t){t=E(N(i),{params:e,called:0,varNames:e.map(function(e){return e.varRef.propertyChain[0]}),typeSignature:e.map(function(t){var e=t.datatype.toTypeSignatureObject?t.datatype.toTypeSignatureObject({rest:t.rest}):{pattern:"range",range:function(e){return o(t.datatype,e)},name:a(t.datatype)};return t.rest?{pattern:"zero or more",innerType:e}:e}),body:t,TwineScript_KnownName:"",TwineScript_ObjectName:"a custom macro (with ".concat(e.length?r(e.map(C)):"no params",")")});return t.fn=n(t),t}});return i}),define("datatypes/datatype",["utils","utils/operationutils","datatypes/changercommand","datatypes/colour","datatypes/gradient","datatypes/lambda","datatypes/custommacro","datatypes/codehook","internaltypes/twineerror"],function(e,t,n,r,a,o,i,s,c){var l=e.realWhitespace,u=e.anyRealLetter,p=e.anyCasedLetter,d=e.anyNewline,f=t.objectName,e=Object.seal,h=Object.keys,m=Math.floor,g=Math.abs,y={TwineScript_TypeID:"datatype",TwineScript_TypeName:"a datatype",TwineScript_Print:function(){return"`["+this.TwineScript_ObjectName+"]`"},get TwineScript_ObjectName(){return"the "+(this.rest?"...":"")+this.name+" datatype"},TwineScript_is:function(e){return y.isPrototypeOf(e)&&e.name===this.name},TwineScript_Clone:function(){return this.rest?this:Object.create(this)},TwineScript_ToSource:function(){return(this.rest?"...":"")+this.name},TwineScript_IsTypeOf:function(e){var t=this.name,n=this.rest;return!!v[t]&&v[t](e,n)},toTypeSignatureObject:function(){var e=this.name,e={pattern:"range",range:v[e],name:"a "+("dm"===e?"datamap":"ds"===e?"dataset":"num"===e?e+"ber":"str"===e?e+"ing":"color"===e?"colour":"bool"===e?e+"ean":"alnum"===e?"alphanumeric character":"int"===e?e+"eger":"even"===e||"odd"===e?e+" number":e.endsWith("case")||"whitespace"===e?e+" character":"empty"===e?e+" value":e)};return this.rest?{pattern:"zero or more",innerType:e}:e},create:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=(e="datamap"===e?"dm":"dataset"===e?"ds":"number"===e?"num":"string"===e?"str":"color"===e?"colour":"boolean"===e?"bool":"alphanumeric"===e?"alnum":"integer"===e?"int":"newline"===e?"linebreak":e,Object.create(this));return n.name=e,n.rest=t,n},from:function(t){var e=h(b).find(function(e){return b[e](t)});return e?y.create(e):c.create("datatype",f(t)+" doesn't correspond to a datatype value.")}},b={array:Array.isArray,dm:function(e){return e instanceof Map},ds:function(e){return e instanceof Set},datatype:function(e){return y.isPrototypeOf(e)},changer:function(e){return n.isPrototypeOf(e)},colour:function(e){return r.isPrototypeOf(e)},gradient:function(e){return a.isPrototypeOf(e)},lambda:function(e){return o.isPrototypeOf(e)},macro:function(e){return i.isPrototypeOf(e)},codehook:function(e){return s.isPrototypeOf(e)},command:function(e){return e&&"command"===e.TwineScript_TypeID},str:function(e){return"string"==typeof e},num:function(e){return"number"==typeof e},bool:function(e){return"boolean"==typeof e}},v=_objectSpread(_objectSpread({},b),{},{even:function(e){return!isNaN(e)&&m(g(e))%2==0},odd:function(e){return!isNaN(e)&&m(g(e))%2==1},empty:function(e){return e instanceof Map||e instanceof Set?!e.size:!(!Array.isArray(e)&&"string"!=typeof e||e.length)},int:function(e){return"number"==typeof e&&e===(0|e)},uppercase:function(e){return"string"==typeof e&&1===_toConsumableArray(e).length&&_toConsumableArray(e).every(function(e){return e!==e.toLowerCase()})},lowercase:function(e){return"string"==typeof e&&1===_toConsumableArray(e).length&&_toConsumableArray(e).every(function(e){return e!==e.toUpperCase()})},whitespace:function(e){return"string"==typeof e&&!!e.match("^"+l+"$")},digit:function(e){return"string"==typeof e&&!!e.match("^\\d$")},alnum:function(e){return"string"==typeof e&&!!e.match("^"+u+"$")},anycase:function(e){return"string"==typeof e&&!!e.match("^"+p+"$")},linebreak:function(e){return"string"==typeof e&&!!e.match("^"+d+"$")},any:function(){return!0},const:function(){return!0}});return e(y)}),define("datatypes/gradient",["utils/operationutils"],function(e){var t=e.toSource,n=Object.freeze({TwineScript_TypeID:"gradient",TwineScript_TypeName:"a gradient",TwineScript_ObjectName:"a gradient",TwineScript_DebugName:function(){return"a gradient "+this.TwineScript_Print()},TwineScript_GetProperty:function(e){var t=this;return"angle"===e?this.angle:"stops"===e?this.stops.map(function(e){return new Map([[t.repeating?"pixels":"percent",e.stop],["colour",e.colour.TwineScript_Clone()]])}):void 0},TwineScript_Properties:["angle","stops"],TwineScript_ToSource:function(){return"(gradient:"+this.angle+","+this.stops.map(function(e){return t(e.stop)+","+t(e.colour)})+")"},TwineScript_is:function(e){var r=this;return e.angle===this.angle&&e.stops.length===this.stops.length&&e.stops.every(function(e,t){var n=e.colour,e=e.stop;return r.stops[t].stop===e&&r.stops[t].colour.TwineScript_is(n)})},TwineScript_Clone:function(){return n.create(this.angle,_toConsumableArray(this.stops))},TwineScript_Print:function(){return"<tw-colour style='background:"+this.toLinearGradientString()+"'></tw-colour>"},create:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];return Object.assign(Object.create(this),{angle:e,stops:t.sort(function(e,t){return e.stop-t.stop}),repeating:n})},multiply:function(t){return n.create(this.angle,this.stops.map(function(e){return{colour:e.colour,stop:e.stop*t}}))},toLinearGradientString:function(){var r=this;return(this.repeating?"repeating-":"")+"linear-gradient(".concat(this.angle,"deg, ").concat(this.stops.reduce(function(e,t){var n=t.colour,t=t.stop;return e+n.toRGBAString()+" "+t*(r.repeating?1:100)+(r.repeating?"px,":"%,")},"").slice(0,-1),")")}});return n}),define("datatypes/hookset",["jquery","utils","utils/renderutils","utils/operationutils"],function(g,s,e,t){var y=e.textNodeToChars,b=e.realWhitespace,c=e.findTextInNodes,r=t.toSource;function l(e){function t(n,e){if(Array.isArray(e))return e.reduce(function(e,t){return e.add(n.get(t))},g());if(e&&"object"===_typeof(e)&&"first"in e&&"last"in e){for(var t=e.first,r=e.last,a=n.length,o=(t<0&&(t+=a),r<0&&(r+=a),[n.get(t)]);t!==r;)t+=Math.sign(r-t),o.push(n.get(t));return g(o)}if("string"==typeof e){if("chars"===e){var i,s=[],c=_createForOfIteratorHelper(n.textNodes(m));try{for(c.s();!(i=c.n()).done;){var l,u=i.value,p=_createForOfIteratorHelper(y(u));try{for(p.s();!(l=p.n()).done;){var d=l.value;d.textContent.match(b)||s.push(d)}}catch(e){p.e(e)}finally{p.f()}}}catch(e){c.e(e)}finally{c.f()}return g(s)}if("links"===e)return n.findAndFilter("tw-link, .enchantment-link");if("visited"===e)return n.findAndFilter("tw-link.visited");var f,h;if("lines"===e)return f=n.findAndFilter("br:not(tw-sidebar *),tw-consecutive-br:not(tw-sidebar *)").get(),h=[[]],n.contents().each(function e(t,n){var r=(n.tagName||"").toLowerCase();if("tw-sidebar"!==r)if("tw-passage"===r||"tw-transition-container"===r)g(n).contents().each(e);else{if(f.length){if(n===f[0])return f.shift(),void h.push([]);if(16&n.compareDocumentPosition(f[0]))return h.push([]),g(n).contents().each(e),void h.push([])}h[h.length-1].push(n)}}),g(h.map(function(e){return!!e.length&&g(e).wrapAll("<tw-pseudo-hook>").parent()[0]}).filter(Boolean))}return g(n.get(e))}var n,r,a=e.dom,m=":not(tw-error, tw-error *)",o=g();this.next&&(o=o.add(l.call(this.next,e)));if(this.selector){if("string"===this.selector.type)i=this.selector.data,n=c((n=a).textNodes(),i),r=g(),n.forEach(function(e){r=r.add(g(e).wrapAll("<tw-pseudo-hook>").parent())}),i=r;else{if("base"===this.selector.type)return o.add(t(l.call(this.selector.data,e),this.property));n=this.selector.data,e='tw-hook[name="'+(n=s.insensitiveName(n).replace(/"/g,"&quot;"))+'"],tw-enchantment[name="'+n+'"]';var e=e+={page:", tw-story",passage:", tw-passage",sidebar:", tw-sidebar",link:", tw-link, .enchantment-link"}[n]||"",i=a.findAndFilter(e).add(a.parentsUntil(s.storyElement.parent())).filter(e)}o=this.property?o.add(t(i,this.property)):o.add(i)}return o=o.get().reduce(function(e,t){return t=g(t),e.add(t.is("tw-enchantment")&&t.contents().length<=1?t.contents():t)},g())}function a(e){var t,n;return e?(t=e.selector,n=e.property,e=e.next,[JSON.stringify(["base"===t.type?a(t.data):s.insensitiveName(t.data),n])].concat(_toConsumableArray(a(e))).sort()):[]}var o=Object.freeze({forEach:function(e,n){var t=l.call(this,e).each(function(e,t){return n(g(t),e)});return e.dom.findAndFilter("tw-pseudo-hook").contents().unwrap(),t},hooks:function(e){return l.call(this,e)},get TwineScript_ObjectName(){return"the hook name ".concat(this.TwineScript_ToSource())},TwineScript_TypeID:"hookName",TwineScript_TypeName:"a hook name (like ?this)",TwineScript_Unstorable:!0,TwineScript_ToSource:function(){var e="",t=this.selector,n=t.type,t=t.data;return"name"===n?t.match(RegExp("^"+s.anyRealLetter+"+$"))?e+="?"+t:e+="(hooks-named:"+JSON.stringify(t)+")":"string"===n?e+=JSON.stringify(t):"base"===n&&(e+=t.TwineScript_ToSource()+"'s "+r(this.property,"property")),this.next&&(e+=" + "+this.next.TwineScript_ToSource()),e},"TwineScript_+":function(e){for(var t=this.TwineScript_Clone(),n=t;n.next;)n=n.next;return n.next=e,t},TwineScript_is:function(e){return a(this)+""==a(e)+""},TwineScript_GetProperty:function(e){return o.create({type:"base",data:this},e,void 0)},TwineScript_Properties:["chars","links","lines","visited"],TwineScript_Clone:function(){return o.create(this.selector,this.property,this.next)},create:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;return Object.assign(Object.create(this||o),{selector:Object.freeze(e),property:t,next:n})},from:function(e){return o.isPrototypeOf(e)||"string"==typeof e||s.impossible("HookSet.from() was given a non-HookSet non-string."),o.isPrototypeOf(e)?e:o.create({type:"string",data:e})}});return o}),define("datatypes/lambda",["utils/operationutils","internaltypes/varscope","internaltypes/varref","internaltypes/twineerror"],function(e,h,s,m){var g=e.objectName;var c=Object.freeze({TwineScript_TypeID:"lambda",TwineScript_TypeName:"a lambda",get TwineScript_ObjectName(){return'a "'+("making"in this?"making ... ":"")+("each"in this?"each ... ":"")+("where"in this?"where ... ":"")+("when"in this?"when ... ":"")+("via"in this?"via ... ":"")+'" lambda'},TwineScript_Print:function(){return"`[A lambda]`"},TwineScript_is:function(e){return e===this},TwineScript_ToSource:function(){return this.source},TypeSignature:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{pattern:"lambda",innerType:c,clauses:t,typeName:'a "'+t.concat("").join(" ...")+'" lambda'}},TwineScript_Clone:function(){return Object.assign(Object.create(c),this)},create:function(e,t,n,r){var a,o="temp variable, or typed temp variable";function i(e){e=e&&e.varRef?e.varRef:e;return void 0===e||e&&s.isPrototypeOf(e)&&h.isPrototypeOf(e.object)&&1===e.propertyChain.length}if(m.containsError(n))return n;if("making"===t&&!i(n))return m.create("syntax","I need a "+o+", to the right of '"+t+"', not "+g(n)+".");if(m.containsError(e))return e;if(c.isPrototypeOf(e)){if("when"===t||"when"in e)return m.create("syntax","A 'when' lambda cannot have any other clauses, such as '"+t+"'.");if(t in e)return m.create("syntax","This lambda has two '"+t+"' clauses.");a=e}else{if("when"===t&&void 0!==e)return m.create("syntax","A 'when' lambda shouldn't begin with a temp variable (just use 'when' followed by the condition).");if(!i(e))return m.create("syntax","This lambda needs to start with a single "+o+", not "+g(e)+".");(a=Object.create(this)).loop=e||""}return a.source=r.trim(),a[t]=n,a.making&&a.making.getName()===(a.loop&&a.loop.getName())?m.create("syntax","This lambda has two variables named '"+a.loop.getName()+"'.","Lambdas should have all-unique parameter names."):a},apply:function(e,t){var n=t.loop,r=t.pos,a=t.making,o=t.ignoreVia;function i(e,t){if(e){var n,r;if("datatype"in e&&"varRef"in e)return n=e.varRef.create(s,e.varRef.propertyChain),m.containsError(n)?n:(r=n.defineType(e.datatype),m.containsError(r)||(r=n.set(t),m.containsError(r))?r:void 0);s[e.getName()]=t}}var s=(s=t.tempVariables)||Object.create(e.stack.length?e.stackTop.tempVariables:h),t=i(this.loop,n)||i(this.making,a);if(m.containsError(t))return t;e.stack.unshift(Object.assign(Object.create(e.stackTop||null),{tempVariables:s,lambdaPos:this.when?void 0:r})),!n||this.making||this.when?e.Identifiers.it=m.create("operation","I can't use 'it', or an implied 'it', in "+this.TwineScript_ObjectName):e.Identifiers.it=n;var c,l,u,p,d,t=!o&&this.via,o="where"in this||"when"in this,f=e.evalReplay;return e.evalReplay=f?[]:null,o?(c=e.eval(this.where||this.when),l=e.evalReplay,e.evalReplay=l&&t?[]:null,!n||this.making||this.when||(e.Identifiers.it=n),u=c,p=!t||e.eval(t),d=null,u=m.containsError(u)||("boolean"!=typeof u?m.create("operation","This lambda's 'where' clause must evaluate to true or false, not "+g(u)+"."):u?p:d)):c=u=!t||e.eval(t),p=t?e.evalReplay:null,e.stack.shift(),(e.evalReplay=f)&&(o||t)&&(((d=f[f.length-1])||{}).lambda&&d.lambda.obj===this||((d={lambda:{obj:this,loops:[]},code:(f[f.length-1]||{}).code||""}).fromCode=d.code,f.push(d)),d.lambda.loops.push(_objectSpread(_objectSpread(_objectSpread({it:n,pos:r},void 0!==a&&{making:a}),t&&{viaReplay:p,viaResult:u}),o&&{whereReplay:l,whereResult:null!==c&&c}))),u},filter:function(r,e){var a,o=this,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;return e.reduce(function(e,t,n){return a||(n=o.apply(r,{loop:t,pos:n+1,ignoreVia:!0,tempVariables:i}),a=m.containsError(n))||e.concat(n?[t]:[])},[])}});return c}),define("datatypes/typedvar",["utils/operationutils","internaltypes/varref","internaltypes/twineerror"],function(e,a,o){var i=e.typeName,t=e.matches,n=e.toSource,s=e.unstorableValue,e=Object.freeze,c=Object.assign,l=Object.create,u=e({TwineScript_TypeName:"a TypedVar (typed variable name)",get TwineScript_ObjectName(){var e=n(this.datatype);return"the ".concat(e.length<24?e+"-":"","typed variable name, ").concat(this.varRef.TwineScript_ToSource())},TwineScript_Print:function(){return"`[A typed variable name]`"},TwineScript_Unstorable:!0,TwineScript_Clone:function(){return c(l(u),{datatype:this.datatype.TwineScript_Clone(),varRef:this.varRef})},TwineScript_ToSource:function(){return n(this.datatype)+"-type "+this.varRef.TwineScript_ToSource()},TwineScript_GetProperty:function(e){return"name"===e?this.getName():this[e]},TwineScript_Properties:["datatype","name"],TwineScript_IsTypeOf:function(e){return t(this.datatype,e)},get:function(){var e;return(e=this.varRef).get.apply(e,arguments)},getName:function(){return this.varRef.getName()},defineType:function(){if("any"!==this.datatype.name)return this.varRef.defineType(this.datatype)},create:function(e,t){var n,r;return(n=o.containsError(t)||o.containsError(e)||t.error)||(a.isPrototypeOf(t)?(n=t.object,r=t.compiledPropertyChain,n&&n.TwineScript_VariableStore&&1===r.length&&n.TwineScript_TypeDefs?(r=s(e))&&!u.isPrototypeOf(r)?o.create("syntax","The -type syntax can't have "+i(r)+" to its left."):c(l(this),{datatype:e,varRef:t}):o.create("unimplemented","I can only restrict the datatypes of variables, not data names or anything else.")):o.create("syntax","The -type syntax must have a variable to its right."))}});return u}),define("datatypes/varbind",["jquery","utils","utils/operationutils","internaltypes/varref","internaltypes/twineerror"],function(o,e,t,n,r){var a=t.objectName;return n.on("set",function(r,a){r.TwineScript_VariableStore&&e.storyElement.find("[data-2bind]").each(function(e,t){var n=(t=o(t)).data("twoWayBindEvent");"function"==typeof n&&n(t,r,a)})}),Object.freeze({TwineScript_TypeName:"a VarBind (bound variable name)",get TwineScript_ObjectName(){return"a ".concat(this.bind," bind to ").concat(this.varRef.TwineScript_ToSource())},TwineScript_Print:function(){return"`[A bound variable name]`"},TwineScript_Unstorable:!0,TwineScript_ToSource:function(){return("two way"===this.bind?"2":"")+"bind "+this.varRef.TwineScript_ToSource()},set:function(e){var e=this.varRef.set(e);if(e=r.containsError(e))return e},create:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"one way";return r.containsError(e)?e:n.isPrototypeOf(e)?e.error||Object.assign(Object.create(this),{varRef:e,bind:t}):r.create("operation","I can only 'bind' a variable, not "+a(e)+".")}})}),define("debugmode/highlight",["jquery","utils","utils/typecolours","macros","lexer"],function(u,e,t,p,n){var d=e.insensitiveName,f=t.versionClass,h=n.lex;return function(e,t,n,r){if(9999<e.length)return[u("<span>").text(e)];for(var a=h(e,"",t||"macro"),o=[],i="",s=a,c=a.start;c<a.end;c+=1){var l=a.pathAt(c);l[0]!==s[0]&&(o.length&&(o[o.length-1].textContent=i),i="",s=l,o.push(u("<".concat(r&&n<=c&&c<r?"mark":"span",' class="').concat(function(e){for(var t={},n="",r=0;r<e.length;r+=1){var a=e[r],o=a.type,i=a.text,s=("verbatim"!==o&&"comment"!==o||(n=""),f+o);switch(t[s]=(t[s]||0)+1,1<t[s]&&(s+="-"+t[s]),o){case"text":i.trim()&&e.slice(r+1).reduce(function(e,t){return void 0===e?"macro"===t.type||"hook"!==t.type&&e:e},void 0)&&(s+=" ".concat(f,"error"));break;case"macroName":var c,l=e[r].text[0];"_"!==l&&"$"!==l?(c=d(e[r].text.slice(0,-1)),p.has(c)?s+="-"+p.get(c).returnType.toLowerCase():s+=" ".concat(f,"error")):s+=" ".concat(f,"customMacro ").concat(f+("_"===l?"tempV":"v"),"ariable")}n+=s+" "}return n}(s),'">'))[0])),i+=a.text[c-a.start]}return o.length&&(o[o.length-1].textContent=i),o}}),define("debugmode/mode",["jquery","utils","utils/naturalsort","state","engine","internaltypes/varref","internaltypes/twineerror","utils/operationutils","utils/renderutils","passages","section","debugmode/panel","debugmode/highlight","utils/typecolours"],function(I,V,M,D,F,L,H,e,t,z,q,W,B,n){var U=e.objectName,$=e.isObject,G=e.toSource,Y=e.typeID,J=t.dialog,X=n.CSS,K=function(e,t){var f=V.escape,i=V.nth,n=V.debounce,r=I(document.documentElement),a=M(),o={darkMode:!0,fadePanel:!0,evalReplay:!0,width:null,maxHeight:400};if(D.hasStorage)try{var s=localStorage.getItem("(Debug Options "+V.options.ifid+")");s&&(o=JSON.parse(s))}catch(e){}function c(){if(D.hasStorage)try{localStorage.setItem("(Debug Options "+V.options.ifid+")",JSON.stringify(o))}catch(e){}}W.defaultMaxHeight=o.maxHeight;function l(e){return n(function(){if(V.options.debug)return e.apply(this,arguments)},{maxWait:2e3})}var h=I('<tw-debugger class="'.concat([o.darkMode?"theme-dark":"",o.fadePanel?"fade-panel":""].join(" "),'" style="').concat(o.width?"width:"+o.width+"px":"","\">\n<div class='panel panel-errors' hidden><table></table></div>\n<div class='tabs'></div>\n<label style='user-select:none'>Turns: </label><select class='turns' disabled></select>\n<button class='show-invisibles'>\ud83d\udd0d Debug View</button>\n<button class='show-dom'><span style=\"vertical-align:text-top\">&lt;</span><span style=\"vertical-align:text-bottom\">&gt;</span> DOM View</button>\n<button class='close'>\u2716</button>\n<div class='resizer-h'>\n</tw-debugger>")),s=h.find(".tabs"),u=h.find(".show-dom"),p=h.find(".show-invisibles"),d=h.find(".close"),m=h.find(".turns");I(document.documentElement).on("click","tw-expression, tw-error, tw-eval-explanation",n(function(e){var r,a,o,i,l,u,p,d,t=I(e.target).data("evalReplay");function n(){var e,s,c=r[a],t=o.find("tw-eval-explanation").empty(),n=o.find("tw-eval-code");c.toCode||c.toDesc||c.error||c.lambda?(o.find("tw-eval-code").empty().append(B(c.code,"macro",0<a&&c.start,0<a&&c.end+c.diff)),t.append(c.lambda?"":"<code class='".concat(56<c.fromCode.length?"from-block":"from-inline","'></code>"),c.error?"<span> caused an error: </span>":c.lambda?"<span>The lambda <code class='to-lambda'></code> was run, producing these results.</span>":"<span> became".concat(c.ToDesc?"\u2026":""," </span>").concat(c.toDesc?"<span class='to-desc'>".concat(f(c.toDesc),".</span>"):"<code class='to-code'></code>")),c.error?t.append(c.error):c.lambda?(s=function(e,t){return I("<".concat(e,"><code></").concat(e,">")).find("code").append(B(t,"macro")).end()},t.find(".to-lambda").append(B(c.lambda.obj.source,"macro")).end().append((e=I("<table>")).append.apply(e,[I("<tr>").append(s("th","pos"),c.lambda.obj.loop?s("th","_"+c.lambda.obj.loop.getName()).append(" / ",I("<code>").append(B("it","macro"))):s("th","it"),c.lambda.obj.making&&s("th","_"+c.lambda.obj.making.getName()),c.lambda.obj.where&&s("th","where").append(" result"),c.lambda.obj.via&&s("th","via").append(" result"))].concat(_toConsumableArray(c.lambda.loops.map(function(e){var t=e.it,n=e.pos,r=e.making,a=e.whereResult,o=e.whereReplay,i=e.viaResult,e=e.viaReplay;return I("<tr>").append(s("td",G(n)),s("td",G(t)),void 0!==r&&s("td",G(r)),null!=a&&(H.containsError(a)?I("<td>").append(a.render(c.lambda.obj.source,!0)):s("td",G(a))).append(o&&I("<tw-open-button replay label='\ud83d\udd0d'>").data("evalReplay",o)),null!=i&&(H.containsError(i)?I("<td>").append(i.render(c.lambda.obj.source,!0)):s("td",G(i))).append(e&&I("<tw-open-button replay label='\ud83d\udd0d'>").data("evalReplay",e)))})))))):c.toDesc||t.find(".to-code").append(B(c.toCode,"macro")),t.next().html(c.itIdentifier?'(The <code class="cm-harlowe-3-identifier">it</code> identifier now refers to '.concat(f(c.itIdentifier),".)"):"").next().text(c.reason||"")):(n.html(B(c.code,"macro")),t.html("<center>First, there was <code></code>.</center>").next().empty().next().empty()),c.lambda||t.find("code").first().append(B(c.fromCode,"macro")),o.find("mark").each(function(e,t){t.scrollIntoView()}),i.css("visibility",a<=9?"hidden":"visible"),l.css("visibility",a<=0?"hidden":"visible"),p.css("visibility",a>=r.length-1?"hidden":"visible"),d.css("visibility",a>=r.length-10?"hidden":"visible"),u.html("( ".concat(a+1,"/").concat(r.length," )"))}t&&(r=t,t=J({buttons:[{name:"Understood",confirm:!(a=0),callback:function(){return!h.find("tw-backdrop").length&&h.removeClass("show-dialog")}}]}).addClass("eval-replay"),o=I("<tw-eval-replay>".concat(1===r.length?"":"<tw-eval-code></tw-eval-code>","<tw-eval-explanation></tw-eval-explanation><tw-eval-it></tw-eval-it><tw-eval-reason></tw-eval-reason>").concat(1===r.length?"":"<tw-dialog-links><tw-link style='visibility:hidden'>\u2190 10</tw-link><tw-link style='visibility:hidden'>\u2190 \u2190</tw-link><b></b><tw-link>\u2192 \u2192</tw-link><tw-link>10 \u2192</tw-link></tw-dialog-links>","</tw-eval-replay>")),t.find("tw-dialog").css({width:"75vw","max-width":"75vw"}).prepend(o),i=o.find("tw-link:first-of-type"),l=i.next(),u=l.next(),p=u.next(),d=p.next(),n(),i.on("click",function(){a=Math.max(0,a-10),n()}),l.on("click",function(){a=Math.max(0,a-1),n()}),p.on("click",function(){a=Math.min(r.length-1,a+1),n()}),d.on("click",function(){a=Math.min(r.length-1,a+10),n()}),h.find("tw-backdrop").length?h.find("tw-backdrop").before(t):h.addClass("show-dialog").append(t));var s,t=I(e.target).data("goto");t&&(s=V.options.ignoreGotos,V.options.ignoreGotos=!1,t.command.TwineScript_Run(t.section),V.options.ignoreGotos=s),e.stopPropagation()})),h.find(".resizer-h").mousedown(function(e){if(1!==e.which)return!0;e.stopPropagation();var t=e.pageX,n=h.width();r.on("mousemove.debugger-resizer-h",function(e){e=e.pageX;h.width("".concat(n+t-e|0,"px"))}).on("mouseup.debugger-resizer-h",function(){r.off(".debugger-resizer-h"),o.width=h.width(),c()})}),h.on("mousedown",".resizer-v",function(e){if(1!==e.which)return!0;e.stopPropagation();var t=e.pageY,n=I(e.target.parentNode).height();r.on("mousemove.debugger-resizer-v",function(e){e=e.pageY;h.find(".panel").css("maxHeight","".concat(n+t-(0|e),"px"))}).on("mouseup.debugger-resizer-v",function(){r.off(".debugger-resizer-v"),o.maxHeight=h.find(".panel").css("maxHeight"),c()})}),p.click(function(){r.toggleClass("debug-mode").removeClass("dom-debug-mode"),p.toggleClass("enabled"),u.removeClass("enabled")}),u.click(function(){r.toggleClass("dom-debug-mode").removeClass("debug-mode"),u.toggleClass("enabled"),p.removeClass("enabled")}),d.click(function(){r.removeClass("debug-mode dom-debug-mode"),h.detach(),Object.assign(V.options,{debug:!1,speedMultiplier:1,ignoreClickEvents:!1,ignoreGotos:!1})});function g(e){(e=e.parents(".variable-row, .enchantment-row, .source-row")).next(".panel-row-source").find("td").empty().append(B(e.data("value")||G(e.data("enchantment").changer),e.is("source-row")?"markup":"macro"))}function y(){return k=new Set}function b(){I(document.body).append(h),V.options.debug=!0,V.options.evalReplay=o.evalReplay,V.options.speedMultiplier=1,V.options.ignoreClickEvents=!1,V.options.ignoreGotos=!1,R()}var v,w=l(function(){var r=m.children().get(),e=D.timeline,a=0;e.forEach(function(e,t){var n=e.turns,e=e.passage,n=(a+=1+(void 0===n?0:n))+": "+e;r[t]?r[t].textContent=n:m.append("<option value='".concat(t,"'>").concat(n,"</option>"))}),e.length<r.length&&I(r.slice(e.length)).remove(),m[1<=e.length?"removeAttr":"attr"]("disabled"),m.val(D.pastLength)}),k=(m.change(function(e){e=e.target.value-D.pastLength;0!=e&&(D[e<0?"rewind":"fastForward"](Math.abs(e)),F.showPassage(D.passage))}),w(),D.on("forward",w).on("load",w).on("forgetUndos",function(){return w}).on("back",function(){D.pastLength<=1&&m.attr("disabled"),m.find("[selected]").removeAttr("selected"),m.val(D.pastLength)}),new Set),S=W.create({className:"variables",tabName:"Variable",rowWrite:function(e,t){var n,r=e.name,a=e.dataset,o=e.path,i=e.value,s=e.tempScope,e=e.type,c=i&&48<i.length&&!i.TwineScript_DebugName,l=$(i)&&i.TwineScript_DebugName?i.TwineScript_DebugName():f(U(i)),u="",a=(o.length&&(u=o.reduce(function(e,t){return e+t+"'s "},"")),a&&(r="???"),e?G(e):""),e="object"===_typeof(i)||c;return t?(t[0].firstChild.innerHTML=a||"",u&&I(t[0].firstChild).children(".variable-path").html((s?"_":"$")+f(u)),t[0].childNodes[1].lastChild.textContent=(u?"":s?"_":"$")+f(r+""),t[0].childNodes[2].textContent=s||"",t[0].childNodes[3].innerHTML=l,n=(c=I(t[0].lastChild.firstChild)).is(".open"),c[e?"show":"hide"](),c=t.next(".panel-row-source"),n&&c.find("td").empty().append(B(G(i))),t.data("value",G(i)),t.add(c)):I('<div class="variable-row">').attr("data-name",r).attr("data-path",o+"").attr("data-scope",s||"").css("padding-left",Math.min(5,o.length)+"em").append("<td class='variable-type'>".concat(a||"","</td>"),"<td class='variable-name cm-harlowe-3-"+(s?"tempV":"v")+"ariable'><span class='variable-path'>"+(u?(s?"_":"$")+f(u):"")+"</span> "+(u?"":s?"_":"$")+f(r+"")+"</td>","<td class='temporary-variable-scope'>".concat(s||"","</td>"),"<td class='variable-value cm-harlowe-3-macroName-"+Y(i)+"'>"+l+"</td><td class='panel-row-buttons'><tw-folddown tabindex=0 style='display:"+(e?"visible":"none")+"'>(source:) </tw-folddown></td>").data("value",G(i)).find("tw-folddown").data("folddown",g).end().add("<tr class='variable-row panel-row-source' style='display:none'><td colspan='5'></td></tr>")},rowCheck:function(e,t){var n=e.name,r=e.path,e=e.tempScope;return t[0]&&t[0].getAttribute("data-name")===n&&t[0].getAttribute("data-path")===r+""&&t[0].getAttribute("data-scope")===e},columnHead:function(){return'<tr class="panel-head"><th data-col="variable-type">Type</th><th data-col="variable-name">Name</th><th data-col="temporary-variable-scope">Scope</th><th data-col="variable-value">Value</th></tr>'},rowSort:function(e,t,n){if("variable-value"===e)return a(t.attr("class"),n.attr("class"))||a(t.parent().data("value"),n.parent().data("value"))}}),T=l(function(){var e,t,o=[],n=D.variables,r=o.length;for(e in n)e.startsWith("TwineScript")||(r+=1,function n(e){var r,t,a;500<o.length||(o.push(e),r=e.path.concat(e.name),t=e.value,a=e.tempScope,r.length<=4&&(Array.isArray(t)?t.forEach(function(e,t){return n({name:i(t+1),path:r,value:e,tempScope:a})}):t instanceof Map?_toConsumableArray(t).forEach(function(e){var t=(e=_slicedToArray(e,2))[0],e=e[1];return n({name:t,path:r,value:e,tempScope:a})}):t instanceof Set&&_toConsumableArray(t).forEach(function(e,t){return n({name:t,dataset:!0,path:r,value:e,tempScope:a})})))}({name:e,path:[],value:n[e],tempScope:"",type:null==(t=n.TwineScript_TypeDefs)?void 0:t[e]}));o.push.apply(o,_toConsumableArray(k)),r+=k.size,S.update(o,r),0===r!==S.panel[0].classList.contains("panel-variables-empty")&&S.panel.toggleClass("panel-variables-empty")}),_=(L.on("set",function(e,t,n){var r,a;e===D.variables||"temp"!==(null==(a=e.TwineScript_VariableStore)?void 0:a.type)||null!=(a=e.TwineScript_VariableStore)&&a.name.match(/#\d+$/)||(r=null==(a=e.TwineScript_VariableStore)?void 0:a.name,e=null==(a=e.TwineScript_TypeDefs)?void 0:a[t],(a=_toConsumableArray(k).find(function(e){return e.name===t&&e.tempScope===r}))?a.value=n:k.add({name:t,path:[],value:n,tempScope:r,type:e})),T(),v()}).on("delete",function(){T(),v()}),S.panel.append("<div class='panel-variables-bottom'>\n\t\t\t<button class='panel-variables-copy'>Copy $ variables as (set:) call</button>\n\t\t\t<input class='clipboard' type=\"text\" style='opacity:0;pointer-events:none;position:absolute;'></input>\n\t\t</div>").removeAttr("hidden"),S.tab.addClass("enabled"),S.panel.find(".clipboard")),x=(r.on("click",".panel-variables-copy",function(){var e,t=[];for(e in D.variables)e.startsWith("TwineScript")||t.push("$"+e+" to "+G(D.variables[e]));_.val("(set:"+t+")")[0].select(),document.execCommand("copy")}),W.create({className:"enchantments",tabName:"Enchantment",rowWrite:function(e,t){var n=e.scope,r=e.changer,a=e.lambda,o=e.name,i=e.localHook,a=r?f(U(r)):a?f(G(a)):"<em>enchanted with ("+o+":)</em>";return t||I('<div class="enchantment-row">').data("enchantment",e).append("<td><span class='enchantment-name'>"+G(n)+(i?"</span><span class='enchantment-local cm-harlowe-3-hookName'>"+("function"==typeof i.TwineScript_ToSource?i.TwineScript_ToSource():i.attr("name")?"?"+i.attr("name"):"an unnamed hook"):"")+"</span></td><td class='enchantment-value cm-harlowe-3-macroName-"+(r?"changer":"command")+" '>"+a+"</td>"+(r?"<td class='panel-row-buttons'><tw-folddown tabindex=0>(source:)</tw-folddown></td>":"")).find("tw-folddown").data("folddown",g).end().add(r?I("<tr class='panel-row-source' style='display:none'><td colspan='3'></td></tr>"):"")},rowCheck:function(e,t){return t.data("enchantment")===e},columnHead:function(){return'<tr class="panel-head"><th data-col="enchantment-name">Scope</th><th data-col="enchantment-value">Value</th></div>'}})),d=l(function(e){x.update(e.enchantments,e.enchantments.length)}),O=(q.on("add",d).on("remove",d),q.create()),A=W.create({className:"storylets",tabName:"Storylet",rowWrite:function(e,t){var n=e.name,r=e.active,a=e.storyletSource,o=e.exclusive,e=e.urgent;return t?(t.toggleClass("storylet-closed",!r),t[0].firstChild.textContent=r?"\u2713":""):(t=I('<tr class="storylet-row '.concat(r?"":"storylet-closed",'">')).attr("data-name",n).append("<td class='storylet-open'>"+(r?"\u2713":"")+"</td><td class='storylet-name'>"+n+"</td><td class='storylet-lambda'></td><td class='storylet-exclusive'>"+o+"</td><td class='storylet-urgent'>"+e+"</td>")).find(".storylet-lambda").append(B(a.replace(/^when\s+/i,""))),t},rowCheck:function(e,t){e=e.name;return t[0].getAttribute("data-name")===f(e+"")},columnHead:function(){return'<tr class="panel-head"><th data-col="storylet-open" data-order="desc">Open</th><th data-col="storylet-name">Name</th><th data-col="storylet-lambda">Condition</th><th data-col="storylet-exclusive" class=\'storylet-exclusive\'>Exclusivity</th><th data-col="storylet-urgent" class=\'storylet-urgent\'>Urgency</th></tr>'}}),C=(A.tab.hide(),v=l(function(){var r,a,o=z.getStorylets(O),i=H.containsError(o),e=z.allStorylets();A.update(e.map(function(t){var e="number"==typeof t.get("exclusivity")?t.get("exclusivity"):0,n="number"==typeof t.get("urgency")?t.get("urgency"):0;return r=r||e,a=a||e,{name:t.get("name"),storyletSource:t.get("storylet").TwineScript_ToSource(),active:!i&&o.some(function(e){return e.get("name")===t.get("name")}),exclusive:e,urgent:n}}),i?0:o.length),A.panel.toggleClass("storylet-error",i),A.panel.toggleClass("panel-exclusive",r),A.panel.toggleClass("panel-urgent",a),e.length&&A.tab.show()}),W.create({className:"source",tabName:"Source",tabNameCounter:!1,rowWrite:function(e,t){var n=e.name,e=e.tag;return t?t.add(t.next(".panel-row-source")):(t=z.get(n).get("source"),I('<div class="source-row" data-tag="'.concat(e,'">')).data("value",t).append('<td class="source-name">'.concat(n,'</td><td class="source-tags">').concat(e,"</td><td class='panel-row-buttons'><tw-folddown class='").concat(e?"":"open","' tabindex=0></tw-folddown></td>")).find("tw-folddown").data("folddown",g).end().add(I("<tr class='panel-row-source' style='".concat(e?"display:none":"","'><td colspan='3'></td></tr>")).find("td").append(!e&&B(t,"markup")).end()))},rowCheck:function(e,t){e=e.name;return t[0].firstChild.textContent===f(e+"")},tabUpdate:I.noop,columnHead:I.noop})),E=["debug-startup","startup","header","debug-header","footer","debug-footer"].reduce(function(e,t){return e.concat(z.getTagged(t).map(function(e){return{name:e.get("name"),tag:t}}))},[]),N=W.create({className:"errors",tabName:"Error",rowWrite:I.noop,rowCheck:I.noop,columnHead:I.noop,tabUpdate:function(e){return N.tab.css({background:e?"rgba(230,101,204,0.3)":""}).text("".concat(e," Error").concat(1!==e?"s":""))}}),d=n(function(e){var t;V.options.debug&&(N.panelRows.append(e.reduce(function(e,t){var t=_slicedToArray(t,2),n=t[0],t=t[1];return"propagated"===n.type?e:e+'<tr class="error-row"><td class="error-passage">'+D.passage+'</td><td class="error-message" title="'+f(t)+'">'+n.message+"</td></tr>"},"")),500<(t=(e=N.panelRows.children()).length)&&I(Array.prototype.slice.call(N.panelRows[0].childNodes,0,t-500)).remove(),N.tabUpdate(Math.min(500,e.length)))},{batch:!0}),j=(H.on(d),N.panel.append("<div class='panel-errors-bottom'>\n\t\t\t<button class='panel-errors-clean'>\ud83e\uddf9 Clear this panel</button>\n\t\t</div>"),r.on("click",".panel-errors-clean",function(){N.panelRows.empty(),N.tabUpdate(0)}),W.create({className:"tools",tabName:"Tools",tabNameCounter:!1,rowWrite:function(e,t){var n=e.id,r=e.type,a=e.label,o=e.dropdownItems,i=e.dropdownValue;return"checkbox"===r?t?t.find("input").prop("checked",!1):I('<span><input id="debug-'.concat(n,'" type="checkbox"></input><label for="debug-').concat(n,'">').concat(a,"</label></span>")):"dropdown"===r?t?t.find("input").prop("checked",!1):I("<span>".concat(a,'<select style="width:3em" data-default="').concat(i,'" id="debug-').concat(n,'"></span>')).find("select").append(o.map(function(e){return"<option value='".concat(e,"' ").concat(e===i?"selected":"",">").concat(e,"x</option>")})).end():void 0},rowCheck:I.noop,columnHead:I.noop,tabUpdate:function(e){return j.tab.css({background:e?"hsla(210, 72%, 65%, .3)":""})}})),P=(r.on("click, change",'.panel-tools [type="checkbox"], .panel-tools select',function(e){var e=e.target,t=(e=I(e)).attr("id"),n=e.is(":checked")||e.is("select")&&e.val()!==+e.attr("data-default");"debug-peekBehindDialogs"===t&&r.toggleClass("debug-dialogs",n),"debug-ignoreClickEvents"===t&&(V.options.ignoreClickEvents=n),"debug-ignoreGotos"===t&&(V.options.ignoreGotos=n),"debug-speedMultiplier"===t&&(V.options.speedMultiplier=+e.val()),j.tabUpdate(n)}),j.update([{id:"peekBehindDialogs",type:"checkbox",label:"See through and click through <code>(dialog:)</code> boxes"},{id:"ignoreClickEvents",type:"checkbox",label:"Stop links, <code>(click:)</code> and <code>(hover-style:)</code> from activating"},{id:"ignoreGotos",type:"checkbox",label:"Stop <code>(go-to:)</code>, <code>(undo:)</code>, <code>(redirect:)</code> and <code>(restart:)</code> from activating<br><small>(Click 'GO' buttons in Debug View to activate later)</small>"},{id:"speedMultiplier",label:"Speed of timed events (<code>time</code>, <code>(live:)</code>, <code>(after:)</code>): ",type:"dropdown",dropdownValue:1,dropdownItems:[.25,.5,.75,1,1.25,1.5,1.75,2,3,5,10]}]),W.create({className:"options",tabName:"\u2699\ufe0f",tabNameCounter:!1,rowWrite:function(e,t){var n=e.name,e=e.label,r={darkMode:o.darkMode,fadePanel:o.fadePanel,evalReplay:o.evalReplay}[n];return t?t.find("input").prop("checked",r):I('<span><input id="debug-'.concat(n,'" type="checkbox" ').concat(r?"checked":"",'></input><label for="debug-').concat(n,'">').concat(e,"</label></span>"))},rowCheck:I.noop,tabUpdate:I.noop,columnHead:I.noop})),R=(r.on("click",'.panel-options [type="checkbox"]',function(e){var e=e.target,t=(e=I(e)).attr("id"),e=e.is(":checked");"debug-darkMode"===t&&(o.darkMode=e,h.toggleClass("theme-dark",e)),"debug-fadePanel"===t&&(o.fadePanel=e,h.toggleClass("fade-panel",e)),"debug-evalReplay"===t&&(V.options.evalReplay=o.evalReplay=e),c()}),P.update([{name:"darkMode",label:"Debug panel is dark"},{name:"fadePanel",label:"Debug panel is transparent unless the cursor is over it"},{name:"evalReplay",label:"Record expression replays (viewable via \ud83d\udd0d buttons in Debug View; slower)"}]),h.prepend(S.panel,x.panel,N.panel,A.panel,C.panel,j.panel,P.panel),s.prepend(S.tab,x.tab,N.tab,A.tab,C.tab,j.tab,P.tab),D.on("beforeForward",y).on("beforeBack",y).on("beforeLoad",y),l(function(){T(),v(),x.panelRows.empty(),x.tabUpdate(0),D.passage&&z.get(D.passage)&&(C.update(E.concat({name:D.passage,tag:""})),C.panel.find('[data-tag=""], [data-tag=""] + .panel-row-source').insertBefore(C.panel.find('[data-tag="footer"]').first()))}));D.on("forward",R).on("back",R).on("load",R);K=b,I(document.head).append(I("<style>").html(X)),b(),e&&d(e,t)};return F.registerDebugMode(function(e,t){return!V.options.debug&&K(e,t)}),K}),define("debugmode/panel",["jquery","utils/naturalsort"],function(d,e){var i=e();return Object.seal({create:function(e){var n,t=e.className,r=e.rowWrite,a=e.rowCheck,o=e.rowSort,i=e.columnHead,s=e.tabName,c=e.tabNameCounter,l=void 0===c||c,c=e.tabUpdate,u=d("<div class='panel panel-".concat(t,"' style='").concat(this.defaultMaxHeight?"max-height:"+this.defaultMaxHeight+"px":"","' hidden><div class=\"resizer-v\"></div><table class='panel-rows'></table></div>")),p=d("<button class='tab tab-".concat(t,"'>").concat(l?"0 ".concat(s,"s"):s,"</button>"));return p.click(function(){p.toggleClass("enabled"),p.parent().siblings(".panel").attr("hidden",""),p.is(".enabled")&&(p.siblings(".tab:not(.tab-"+t+")").removeClass("enabled"),u.removeAttr("hidden"))}),u.on("click","th",function(e){var e=e.target,t="desc"===(e=d(e)).attr("data-order")?"asc":"desc";n.sort(e.attr("data-col"),t),u.find("th[data-order]").removeAttr("data-order"),e.attr("data-order",t)}),c=c||function(e){return p.text(l?"".concat(e," ").concat(s).concat(1!==e?"s":""):s)},n=Object.assign(Object.create(this),{tabName:s,tab:p,panel:u,panelRows:u.find(".panel-rows"),rowWrite:r,rowSort:o,rowCheck:a,columnHead:i,tabUpdate:c})},sort:function(r,a){var o=this;this.panelRows.children(":not(.panel-head, .panel-row-source)").get().sort(function(e,t){var n;return"desc"===a&&(e=(n=[t,e])[0],t=n[1]),e=e.querySelector("."+r),t=t.querySelector("."+r),o.rowSort&&o.rowSort(r,d(e),d(t))||i(e.textContent,t.textContent)}).forEach(function(e){var t=d(e).next(".panel-row-source").get();o.panelRows.append(e,t)})},update:function(e,t){var r=this.rowCheck,a=this.rowWrite,o=this.panelRows,n=this.columnHead,i=this.panel,s=[],c=o.children(),e=(e.forEach(function(t){var e=c.get().filter(function(e){return r(t,d(e))}),n=a(t,e.length&&d(e));e.length||o.append(n),s.push.apply(s,_toConsumableArray(n.get()))}),c.filter(function(e,t){return!s.includes(t)&&!t.className.includes("panel-head")}).remove(),this.tabUpdate(t),0<t&&!o.find(".panel-head").length?o.prepend(n()):0===t&&o.find(".panel-head").remove(),i.find("th[data-order]"));e.length&&this.sort(e.attr("data-col"),e.attr("data-order"))},defaultMaxHeight:300})}),define("internaltypes/changedescriptor",["jquery","utils","renderer","datatypes/hookset","internaltypes/twineerror"],function(b,e,t,v,n){function w(e){return("string"==typeof e?e:e.map(function(e){return e.text}).join("")).split(/\n/g).reduce(function(e,t,n,r){r=r.length;return e.concat(document.createTextNode(t),n!==r-1&&document.createElement(t.length?"br":"tw-consecutive-br"))},[])}var k=e.impossible,S=e.transitionIn,T=t.exec,r=Object.assign,p=Object.keys,a=Object.create,e=Object.seal,_=Array.isArray,x={source:"",appendSource:null,enabled:!0,enablers:null,verbatim:!1,target:null,append:"",newTargets:null,transition:"",transitionTime:null,transitionDeferred:!1,transitionDelay:0,transitionSkip:0,transitionOrigin:null,loopVars:null,styles:null,attr:null,data:null,innerEnchantments:null,section:null,timestamp:0,output:!1,summary:function(){var t=this;return["source","appendSource","enabled","verbatim","target","append","newTargets","transition","transitionTime","transitionDeferred","transitionDelay","transitionSkip","transitionOrigin","innerEnchantments","enablers","output"].filter(function(e){return hasOwnProperty.call(t,e)}).concat([this.attr.length&&"attr",this.styles.length&&"styles",p(this.loopVars).length&&"loopVars",p(this.data).length&&"data"].filter(Boolean))},create:function(e,t){e=r(a(this),{attr:this.attr?this.attr.slice():[],styles:this.styles?this.styles.slice():[],loopVars:this.loopVars||{},data:this.data||{}},e);if(t){t=t.run(e);if(n.containsError(t))return t}return e},update:function(){function e(t){var e,n,r;_(a.styles)&&0<a.styles.length&&(n=(e=_slicedToArray(a.styles.reduce(function(n,r){return p(r).forEach(function(e){var t=r[e];n[+("function"==typeof t)].push(_defineProperty({},e,t))}),n},[[],[]]),2))[0],r=e[1],n.forEach(function(e){return t.css(e)}),setTimeout(function(){r.forEach(function(e){return t.css(e)})})),a.attr&&a.attr.forEach(function(e){return t.attr(e)}),a.data&&t.data(a.data)}var a=this,t=this.section,n=this.newTargets,r=this.transition,o=this.transitionDeferred,i=this.append,s=this.target;"function"==typeof s&&(s=s());if(_(n)&&n.length&&(s=n.map(function(e){return e.target})),_(s))for(var c=0;c<s.length;c+=1)v.isPrototypeOf(s[c])?s[c].forEach(t,e):e(s[c]);else v.isPrototypeOf(s)?s.forEach(t,e):e(s);if(r&&!o&&!i){for(var l,u=s;(l=u.data("timestamp"))||(u=u.parent()),!l&&u.length;);S(s,r,this.transitionTime,this.transitionDelay,this.transitionSkip,l?Date.now()-l:0,this.transitionOrigin)}},render:function(){var e,r=this,t=this.source,n=this.transition,a=this.transitionTime,o=this.transitionDeferred,i=this.enabled,s=this.enablers,c=this.data,l=this.section,u=this.newTargets,p=this.innerEnchantments,d=this.appendSource,f=this.output,h=this.target,m=this.target,g=this.append;if("function"==typeof h&&(h=h()),!g)return k("ChangeDescriptor.render","This doesn't have an 'append' method chosen."),b();if(f)return b();if(null!=s&&s.length)return s=(f=s[0]).descriptor,f=f.changer,s=s.render(),f&&(e=x.create({section:l,target:s}),f.run(e),e.update()),s;if(!i||void 0!==h.attr("hidden"))return x.create({target:h,attr:this.attr.filter(function(e){return!("style"in e)}),data:_objectSpread(_objectSpread({},c),{},{originalSource:t,hidden:!0})}).update(),b();if(!(h=_(u)&&u.length?u:h))return k("ChangeDescriptor.render","ChangeDescriptor has source but not a target!"),b();var y=b();if([].concat(h).filter(function(e){return!e.jquery}).map(function(e){var t,n,r=g;return e.target&&e.append&&(r=(t=e).append,n=t.before,e=e.target),{elements:e.hooks(l,m).filter(function(){return!(n&&1&this.compareDocumentPosition(document)&&2&this.compareDocumentPosition(m[0]))}),append:r}},[]).forEach(function(e){var t=e.elements,n=e.append;t.each(function(e,t){t=b(t),y=y.add(r.create({target:t,append:n,newTargets:null}).render()),t.filter("tw-pseudo-hook").contents().unwrap()})}),!(y.length||_(h)||v.isPrototypeOf(h))){f=g;if(!(f in h)){if("replace"!==f)return k("ChangeDescriptor.render","The target doesn't have a '"+f+"' method."),b();f=h[0]instanceof Text?"replaceWith":(h.empty(),"append")}h[0]instanceof Text&&"prepend"===(f="append"===f?"after":f)&&(f="before"),y=b(t&&(this.verbatim?w:T)(t)),_(d)&&d.forEach(function(e){var t=e.source,e=e.append,t=b((r.verbatim?w:T)(t));y="append"===e?y.add(t):"prepend"===e?t.add(y):t}),h[f](y.length?y:void 0),h.data("timestamp",Date.now()),this.update(),n&&!o&&S("replace"===g?h:y,n,a,this.transitionDelay,this.transitionSkip,this.expedite,this.transitionOrigin),p&&p.map(function(e){return e(h)}).forEach(function(e){return l.addEnchantment(e)})}return y}};return e(x)}),define("internaltypes/enchantment",["jquery","utils","internaltypes/changedescriptor","datatypes/changercommand","utils/operationutils","internaltypes/twineerror","utils/renderutils"],function(g,y,b,v,e,w,t){var k=e.objectName,S=e.toSource,T=t.collapse;return Object.freeze({create:function(e){return Object.assign(Object.create(this),{enchantments:g()},e)},enchantScope:function(){var i=this,s=this.attr,c=this.data,l=this.functions,u=this.section,p=this.scope,d=this.localHook,f=this.lambda,h=[],m=0;p.forEach(u,function(e,t){if(d){d=d.jquery?d:d.hooks(u);var n=e.find(d);if(n.length)e=n;else if(!d.has(e[0]).length)return}var r,a,o;(!e.is(":empty")||e.data("source")&&e.data("source").length)&&(m+=1,f?(o=f.apply(u,{loop:p.TwineScript_GetProperty(t),pos:m}),w.containsError(o)?(e.replaceWith(o.render()),f=o=null):v.isPrototypeOf(o)?o.canEnchant||(e.replaceWith(w.create("macrocall",'The lambda "'.concat(S(f),"\" can't be or include a revision, enchantment, or interaction changer like (replace:), (click:), or (link:).")).render()),f=o=null):(e.replaceWith(w.create("macrocall",'The lambda "'.concat(S(f),'" must return a changer, not ').concat(k(o),".")).render()),f=o=null)):o=i.changer,n=!s&&!c&&(!o||o.summary().every(function(e){return e.startsWith("transition")})),r=n?e:e.wrap("<tw-enchantment>").parent(),s&&r.attr(s),c&&r.data(c),l&&l.forEach(function(e){return e(r)}),o&&(t=b.create({section:u,target:r}),o.run(t),t.update(),e.is(y.storyElement)?(a=Object.keys(Object.assign.apply(Object,[{}].concat(_toConsumableArray(t.styles)))),e.css(a.reduce(function(e,t){return"background-color"===t||"background-image"===t?(e["background-color"]="transparent",e["background-image"]="none",a.push("background-".concat("background-color"===t?"image":"color"))):e[t]="inherit",e},{})),r.data({enchantedProperties:a})):e.is("tw-passage")&&t.styles.some(function(e){return"margin-left"in e||"margin"in e||"margin-right"in e})&&(o="padding-right",y.storyElement.css(t="padding-left","0px").css(o,"0px"),r.data({enchantedProperties:[t,o]}))),e.is(y.storyElement)&&r.css({"min-width":"100%","min-height":"100%"}),"true"===r.attr("collapsing")&&(r.find("[collapsing=false]").each(function(){g(this).removeAttr("collapsing")}),T(r)),n||h.push(r))}),this.enchantments=g(h)},disenchant:function(){this.enchantments.each(function(e,t){(t=g(t)).contents().unwrap();t=t.data("enchantedProperties");t&&y.storyElement.css(t.reduce(function(e,t){return e[t]="",e},{}))})}})}),define("internaltypes/twineerror",["jquery","utils"],function(i,s){var a=s.impossible,c=s.escape,l=(i(document.documentElement).on("click","tw-folddown",function(e){var t=e.target,e=((t=i(t)).toggleClass("open"),t.popData("folddown"));for("function"==typeof e&&e(t);t&&!t.next().length;)t=t.parent();null!=(e=t)&&e.next().toggle()}),{syntax:"The markup seems to contain a mistake.",saving:"I tried to save or load the game, but I couldn't do it.",operation:"I tried to perform an operation on some data, but the data's type was incorrect.",macrocall:"I tried to use a macro, but its call wasn't written correctly.",datatype:"I tried to use a macro, but was given the wrong type of data to it.",custommacro:"I tried to use a custom macro, but its code hook had a mistake in it.",infinite:"I almost ended up doing the same thing over and over, forever.",property:"I tried to access a value in a string/array/datamap, but I couldn't find it.",unimplemented:"I currently don't have this particular feature. I'm sorry.",propagated:"Click the 'Open' button to see the code hook as it was executed.",user:"This is a custom error created by (error:). It usually means you used a custom macro incorrectly.",assertion:"This command exists to provide a helpful error if a certain important condition wasn't true.",debugonly:"This macro is not meant to be used outside of debugging your story."}),u=[],n={TwineError:!0,create:function(e,t,n,r){return t&&"string"==typeof t||a("TwineError.create","has a bad message string"),n||e in l||a("TwineError.create","no error explanation given"),"user"!==e&&(t=t[0].toUpperCase()+t.slice(1)),Object.assign(Object.create(this),{type:e,message:t,explanation:n,source:void 0,innerDOM:r,appendTitleText:!1})},containsError:function(){for(var e=0;e<arguments.length;e+=1){var t=arguments[e];if(n.isPrototypeOf(t))return t;if(Array.isArray(t)){t=n.containsError.apply(n,t);if(t)return t}}return!1},createWarning:function(e,t){return Object.assign(this.create(e,t),{warning:!0})},render:function(t){var n=this,e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],r=(t="string"==typeof t?t:this.source||"",i("<tw-error class='"+(this.warning?"warning":"error")+"' title='"+c(t)+"'>"+c(this.message+(this.appendTitleText?" "+t:""))+"</tw-error>")),a=i("<tw-error-explanation>").text(this.explanation||l[this.type]).hide(),o=i("<tw-folddown tabindex=0>");return this.innerDOM&&i("<tw-open-button label='Open'>").on("click",function(){var e=i("<tw-backdrop><tw-dialog></tw-backdrop>");e.find("tw-dialog").prepend(n.innerDOM,i("<tw-link tabindex=0>OK</tw-link>").on("click",function(){n.innerDOM.detach(),e.remove()}).wrap("<tw-dialog-links>").parent()),s.storyElement.prepend(e)}).appendTo(r),r.append(o).append(a),r.data("TwineError",this),e||u.forEach(function(e){return e(n,t)}),r},on:function(e){return"function"!=typeof e||u.includes(e)||u.push(e),n}};return Object.preventExtensions(n)}),define("internaltypes/twinenotifier",["jquery","utils"],function(e,t){var n=t.impossible,r={create:function(e){return e||n("TwineNotifier.create","called with only 1 string."),Object.assign(Object.create(r),{message:e})},render:function(){return e("<tw-notifier>").attr("message",this.message)}};return Object.preventExtensions(r)}),define("internaltypes/varref",["state","internaltypes/twineerror","utils","utils/operationutils","datatypes/hookset"],function(u,p,e,t,i){var c,n=e.impossible,s=e.andList,r=e.nth,o=t.is,d=t.isObject,f=t.toSource,h=t.isSequential,m=t.objectName,l=t.typeName,g=t.clone,y=t.isValidDatamapName,b=t.subset,v=t.collectionType,w=t.unstorableValue,a=t.matches,k=Array.isArray,S={set:[],delete:[]},T="You can only access position strings/numbers ('4th', 'last', '2ndlast', (2), etc.), slices ('1stTo2ndlast', '3rdTo5th'), ",_="You can't access the '0th' or '0thlast' position of ";function x(e,t){if(p.containsError(t))return n;if(e instanceof Map&&(n=p.containsError(y(e,t))))return n;if(h(e))if("number"==typeof t){if(0===t)return p.create("property","You can't access elements at position 0 of ".concat(m(e),"."),"Only positive and negative position values exist.");0<t&&--t}else if("string"==typeof t&&(r=/^(\d+)(?:st|[nr]d|th)last$/i.exec(t))){if("0"===r[1])return p.create("property",_+m(e)+".");t=-r[1]}else if("string"==typeof t&&(r=/^(\d+)(?:st|[nr]d|th)$/i.exec(t))){if("0"===r[1])return p.create("property",_+m(e)+".");t=r[1]-1}else if("string"==typeof t&&(r=/^(?:(\d+)(?:st|[nr]d|th)(last)?|last)to(?:(\d+)(?:st|[nr]d|th)(last)?|last)$/i.exec(t))){var n=_slicedToArray(r,5),r=n[1],r=void 0===r?0:r,a=n[2],o=n[3],o=void 0===o?0:o;t={last:n[4]?-o:o-1,first:a?-r:r-1}}else if("last"===t)t=-1;else if("random"===t){if(!e.length)return p.create("property","I can't get a random value from ".concat(m(e),", because it's empty."));t=u.random()*Array.from(e).length|0}else{if(i.isPrototypeOf(e)&&!i.TwineScript_Properties.includes(t))return p.create("property","".concat(T+s(i.TwineScript_Properties.map(function(e){return"'"+e+"'"}))," of ").concat(m(e),", not ").concat(("string"==typeof t?f:m)(t),"."));if(!["length","some","any","all","start","end","random"].includes(t)&&!i.isPrototypeOf(e))return p.create("property","".concat(T,"'length', 'some', 'any', 'all', 'start', 'end', and 'random' of ").concat(m(e),", not ").concat(("string"==typeof t?f:m)(t),"."))}else if(e instanceof Set){if(!["length","some","any","all"].includes(t))return p.create("property","".concat(T,"'length', 'some', 'any', and 'all' of ").concat(m(e),"."),"You can't access specific individual data values from datasets.");"length"===t&&(t="size")}else{if(k(e.TwineScript_Properties)&&!e.TwineScript_Properties.includes(t))return p.create("property","You can only get the ".concat(s(e.TwineScript_Properties.map(function(e){return"'"+e+"'"}))," of ").concat(m(e),", not ").concat(("string"==typeof t?f:m)(t),"."));if("number"==typeof e||"boolean"==typeof e)return p.create("property","You can't get any data values, let alone ".concat(m(t),", from ").concat(m(e)))}return t}function O(e,t){return+t<0&&Math.abs(t)<=e.length?e.length+ +t:t}var A=/[^\uD801-\uDFFF]/,C=new Map;function E(e,t){var n,r,a;return void 0===e?e:e instanceof Map?e.get(t):"some"!==t&&"any"!==t&&"all"!==t&&"start"!==t&&"end"!==t||e.TwineScript_VariableStore?("string"==typeof e&&(C.has(e)?e=C.get(e):A.test(e)?(a=_toConsumableArray(e),C.set(e,a),e=a):C.set(e,e)),h(e)&&Number.isFinite(t)&&(t=O(e,t)),e.TwineScript_GetProperty?e.TwineScript_GetProperty(t):"function"!=typeof(a=e[t])?a:void 0):(n=e,r=t,a='"'.concat(r," value").concat("any"===r?"":"s",'" of '),{determiner:r,determined:n,array:_toConsumableArray(n),string:"string"==typeof n&&n,TwineScript_ObjectName:a+m(n),TwineScript_ToSource:function(){return"".concat(r," of ").concat(f(n))},TwineScript_TypeName:a+"a data structure",TwineScript_Unstorable:!0,TwineScript_Print:function(){return"`["+this.TwineScript_TypeName+"]`"}})}function N(e){var t;return e.computed?(t=e.value,"string"==typeof(t=c.isPrototypeOf(t)?t.get():t)?"('"+t+"')":"("+t+")"):"number"==typeof e?r(e):"'"+e+"'"}function j(t,e,n){if(t.TwineScript_VariableStore){if(t.TwineScript_TypeDefs&&e in t.TwineScript_TypeDefs){var r=t.TwineScript_TypeDefs[e];if("const"===r.name){if(void 0!==t[e])return p.create("operation","I can't alter ".concat(t===u.variables?"$":"_").concat(e," because it's been restricted to a constant value."),"This variable can't be changed for the rest of the story.")}else if(!a(r,n))return p.create("operation","I can't set ".concat(t===u.variables?"$":"_").concat(e," to ").concat(l(n)," because it's been restricted to ").concat(f(r),"-type data."),"You can restrict a variable or data name by giving a typed variable to (set:) or (put:).")}return!0}return k(e)?e.map(function(e){return j(t,e)}):t instanceof Map?"string"==typeof e||p.create("operation","".concat(m(t)," can only have string data names, not ").concat(m(e),".")):h(t)?["length","random","some","any","all","start","end"].includes(e)?p.create("operation","I can't forcibly alter the '"+e+"' of "+m(t)+".","start"===e||"end"===e?"Alter the values at actual positions, like 1st or 2ndlast, rather than just the '"+e+"'.":void 0):+e==(0|e)||p.create("property",m(t)+" can only have position keys ('3rd', '1st', (5), etc.), not "+N(e)+"."):t.TwineScript_Identifiers&&e in t?p.create("keyword","I can't alter the value of the '"+e+"' identifier.","You can only alter data in variables, not fixed identifiers."):p.create("operation","I can't modify "+m(t),t instanceof Set?"You should use an (array:) if you need to modify the data inside this dataset.":i.isPrototypeOf(t)?"You should alter hooks indirectly using macros like (replace:) or (enchant:).":void 0)}function P(t,e,n,r){var a=e;t instanceof Map?t.set(e,n):(h(t)&&(e=O(t,e)),t.TwineScript_Set?t.TwineScript_Set(e,n,r):t[e]=n),S.set.forEach(function(e){return e(t,a,n)})}function R(t,e){var n=e;h(t)&&(e=O(t,e)),k(t)&&/^(?:[1-9]\d*|0)$/.exec(e)?t.splice(e,1):t instanceof Map||t instanceof Set?t.delete(e):t.TwineScript_Delete?t.TwineScript_Delete(e):delete t[e],S.delete.forEach(function(e){return e(t,n)})}function I(t,e){var n,r,a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:e,o=3<arguments.length&&void 0!==arguments[3]&&arguments[3];return e&&"object"===_typeof(e)&&"last"in e&&"first"in e?i.isPrototypeOf(t)?t.TwineScript_GetProperty(e):(n=e.first,r=e.last,b(t,n+(0<=n),r+(0<=r))):k(e)?i.isPrototypeOf(t)?t.TwineScript_GetProperty(e):e.map(function(e){return I(t,e,e)})["string"==typeof t?"join":"valueOf"](""):void 0!==(n=E(t,e))||o?n:t===u.variables?0:"temp"===(null==(r=t.TwineScript_VariableStore)?void 0:r.type)?p.create("property","There isn't a temp variable named _".concat(a," in this place."),"Temp variables only exist inside the same passage, hook, or lambda in which they're created."):k(t)&&"number"==typeof e?p.create("property","This array of ".concat(t.length," elements doesn't have a ").concat(N(a+("number"==typeof a?1:""))," element."),t.length?"It contains: ".concat(s(t.map(m)),"."):"The array is empty."):(o=Array.from("function"==typeof t.keys&&t.keys()),p.create("property","I can't find a ".concat(N(a)," data name in ").concat(m(t)),t instanceof Map&&o.length?"Its names include: ".concat(s(o),"."):void 0))}function V(e,t){var r=this,e=this.compiledPropertyChain.reduce(function(e,t){var n=0===e.length?r.object:I.apply(void 0,_toConsumableArray(e[e.length-1]));return e.push([n,t])&&e},[]).reduceRight(e,t);return p.containsError(e)?e:void 0}return c=Object.freeze({get:function(){for(var e=this.object,t=0;t<this.compiledPropertyChain.length-1;t+=1)if(e=I(e,this.compiledPropertyChain[t]),p.containsError(e))return e;return I(e,this.compiledPropertyChain.slice(-1)[0],this.propertyChain.slice(-1)[0])},has:function(){for(var e=this.object,t=0;t<this.compiledPropertyChain.length-1;t+=1)if(void 0===(e=I(e,this.compiledPropertyChain[t],void 0,!0))||p.containsError(e))return!1;return void 0!==I(e,this.compiledPropertyChain.slice(-1)[0],void 0,!0)},set:function(e,c){var l=this;return!this.object||this.object.TwineScript_VariableStore||this.object.TwineScript_Identifiers?V.call(this,function(n,e,t){var e=_slicedToArray(e,2),r=e[0],a=e[1];if(e=p.containsError(n,r,a)||p.containsError(j(r,a,n)))return e;if(e=w(n))return p.create("operation","".concat(m(n)," can't be stored").concat(!n.TwineScript_Unstorable&&v(n)?" because it holds ".concat(m(e)):"","."));if(0<t)r=g(r);else if("temp"===(null==(e=r.TwineScript_VariableStore)?void 0:e.type)&&r!==u.variables){for(var o=r;"temp"===(null==(i=o.TwineScript_VariableStore)?void 0:i.type)&&!hasOwnProperty.call(o,a);)var i,o=Object.getPrototypeOf(o);"temp"===(null==(t=o.TwineScript_VariableStore)?void 0:t.type)&&(r=o)}if("string"==typeof r){if("string"!=typeof n)return p.create("datatype","I can't put this non-string value, ".concat(m(n),", in a string."));if(n.length!==(k(a)?a.length:1))return p.create("datatype","".concat(m(n),"is not the right length to fit into this string location."));var r=_toConsumableArray(r),s=_toConsumableArray(n);[].concat(a).forEach(function(e){0+e<0&&(e=r.length+(0+e)),r=[].concat(_toConsumableArray(r.slice(0,e)),[s.shift()],_toConsumableArray(r.slice(e+1)))}),r=r.join("")}else d(r)&&(void 0!==n.TwineScript_KnownName&&((n=""!==n.TwineScript_KnownName?g(n):n).TwineScript_KnownName=f(l)),k(a)&&h(n)?("string"==typeof n&&(n=_toConsumableArray(n)),a.map(function(e,t){return[e,n[t]]}).forEach(function(e){var e=_slicedToArray(e,2),t=e[0],e=e[1];return P(r,t,e,c)})):P(r,a,n,c));return r},e):p.create("macrocall","I can't (set:) ".concat(m(this),", if the ").concat((m(this.object).match(/ (.+$)/)||["","value"])[1]," isn't stored in a variable."),"Modifying data structures that aren't in variables won't change the game state at all.")},delete:function(){return V.call(this,function(e,t,n){var r,t=_slicedToArray(t,2),a=t[0],t=t[1];return(r=p.containsError(e,a,t)||p.containsError(j(a,t)))||(0<n&&(a=g(a)),null===e?((r="string"==typeof a)&&(a=_toConsumableArray(a)),k(t)?(h(a)&&(t=_toConsumableArray(new Set(t))).sort(function(e,t){return O(a,t)-O(a,e)}),t.forEach(function(e){return R(a,e)})):R(a,t),r&&(a=a.join(""))):P(a,t,e,!1),a)},null)},defineType:function(e){var t=this.object,n=this.compiledPropertyChain[0],r=(hasOwnProperty.call(t,"TwineScript_TypeDefs")||(t.TwineScript_TypeDefs=Object.create(t.TwineScript_TypeDefs||null)),t.TwineScript_TypeDefs),a=r[n];if(a&&!o(a,e))return p.create("operation","I can't redefine the type of "+m(this)+" to "+(e.TwineScript_ObjectName||l(e))+", as it is already "+(a.TwineScript_ObjectName||l(a))+".");t.TwineScript_DefineType?t.TwineScript_DefineType(n,e):r[n]=e,"const"===e.name&&(t[n]=void 0)},matches:function(e,t){return this.object===e&&this.compiledPropertyChain[0]===t},getName:function(){return this.compiledPropertyChain[0]},create:function(e,t){var n;if(n=p.containsError(e))return n;Array.isArray(t)||(t=[].concat(t)),c.isPrototypeOf(e)&&(t=e.propertyChain.concat(t),e=e.object);var r=function(e,t){for(var n,r=[],a=0;a<t.length;a+=1){var o=t[a];if(o.computed&&(o=o.value),c.isPrototypeOf(o)&&(o=o.get()),k(o)){for(var i=[],s=0;s<o.length;s+=1)i[s]=x(e,o[s]);o=i}else o=x(e,o);if(n=p.containsError(o))return n;a<t.length-1&&(e=I(e,o)),r.push(o)}return r}(e,t);return(n=p.containsError(r))||Object.assign(Object.create(c),{object:e,propertyChain:t,compiledPropertyChain:r})},TwineScript_ToSource:function(){function r(e,t){return!t&&n.object.TwineScript_VariableStore?e:N(e)}var e,n=this;return(this.object===u.variables?"$":"temp"===(null==(e=this.object.TwineScript_VariableStore)?void 0:e.type)?"_":f(this.object)+"'s ")+(1===this.propertyChain.length?r(this.propertyChain[0]):this.propertyChain.reduce(function(e,t,n){return e+"'s "+r(t,n)}))},get TwineScript_ObjectName(){var e;return this.object.TwineScript_VariableStore?"the ".concat("temp"===(null==(e=this.object.TwineScript_VariableStore)?void 0:e.type)?"temp ":"","variable ").concat(this.TwineScript_ToSource()):m(this.object)+"'s "+(1===this.propertyChain.length?N(this.propertyChain[0]):this.propertyChain.reduce(function(e,t,n){return e+"'s "+N(t)}))},on:function(e,t){if(e in S)return"function"!=typeof t||S[e].includes(t)||S[e].push(t),c;n("VarRef.on","invalid event name")}})}),define("internaltypes/varscope",[],function(){return Object.seal({TwineScript_ObjectName:"the temporary variables",TwineScript_VariableStore:{type:"temp",name:"an unknown scope"},TwineScript_TypeDefs:Object.create(null)})}),define("macrolib/commands",["jquery","macros","utils","state","passages","engine","internaltypes/twineerror","internaltypes/twinenotifier","datatypes/assignmentrequest","datatypes/hookset","datatypes/codehook","datatypes/colour","datatypes/gradient","internaltypes/varref","datatypes/typedvar","datatypes/varbind","utils/operationutils","utils/renderutils"],function(u,n,b,c,l,a,y,M,e,o,t,p,d,i,s,v,r,f){var h=r.printBuiltinValue,m=r.objectName,g=r.clone,w=r.toSource,k=f.dialog,S=f.geomParse,D=f.geomStringRegExp,r=n.TypeSignature,f=r.Any,F=r.Everything,T=r.rest,_=r.either,x=r.optional,O=r.zeroOrMore,L=r.percent,H=r.nonNegativeInteger,A=r.positiveInteger,r=r.positiveNumber,C=Object.assign,E=Math.floor,N=Math.ceil,j=Math.abs,z=Math.max,q=Math.min,P=u.noop;function R(e){return"(".concat(e," ").concat(b.options.ifid,") ")}["set","put","unpack"].forEach(function(r){return n.add(r,"Instant",function(e){for(var t=0;t<(arguments.length<=1?0:arguments.length-1);t+=1){var n=t+1<1||arguments.length<=t+1?void 0:arguments[t+1];if("into"===n.operator&&"set"===r)return y.create("macrocall","Please say 'to' when using the (set:) macro.");if("to"===n.operator&&"set"!==r)return y.create("macrocall","Please say 'into' when using the (put:) or (unpack:) macro.");if((i.isPrototypeOf(n.dest)||s.isPrototypeOf(n.dest))===("unpack"===r))return y.create("macrocall","unpack"===r?"Please use the (unpack:) macro with arrays, datamaps or (p:) patterns containing variables to the right of 'into'.":"Please use the (".concat(r,":) macro with just single variables and typed variables to the ").concat("set"===r?"left of 'to'.":"right of 'into'."),"You may wish to change this to the (".concat("unpack"!==r?"unpack":"to"===n.operator?"set":"put",":) macro."));n=n.set();if(y.containsError(n))return n}return{TwineScript_TypeID:"instant",TwineScript_TypeName:"a (".concat(r,":) operation"),TwineScript_ObjectName:"a (".concat(r,":) operation"),TwineScript_Unstorable:!0,TwineScript_Print:function(){return b.options.debug,""}}},[T(e)])}),n.add("move","Instant",function(e){for(var t=0;t<(arguments.length<=1?0:arguments.length-1);t+=1){var n=t+1<1||arguments.length<=t+1?void 0:arguments[t+1];if("into"!==n.operator)return y.create("macrocall","Please say 'into' when using the (move:) macro.");n=n.set(!0);if(y.containsError(n))return n}return{TwineScript_TypeID:"instant",TwineScript_TypeName:"a (move:) operation",TwineScript_ObjectName:"a (move:) operation",TwineScript_Unstorable:!0,TwineScript_Print:function(){return b.options.debug,""}}},[T(e)]),n.addCommand("display",function(e){if(!l.hasValid(e))return y.create("macrocall","I can't (display:) the passage '".concat(e,"' because it doesn't exist."))},function(e,t,n){return e.source=l.getTree(n),e},[String])("print",P,function(e,t,n){return C(e,{source:h(n)})},[f])(["verbatim-print","v6m-print"],P,function(e,t,n){return C(e,{verbatim:!0,source:h(n)})},[f])(["verbatim-source","v6m-source"],function(e){if("command"===(null==e?void 0:e.TwineScript_TypeID)&&!e.TwineScript_ToSource)return y.create("datatype","I can't construct the source code of a command created by a custom macro.")},function(e,t,n){return C(e,{verbatim:!0,source:h(w(n))})},[f])("go-to",function(e){if(!l.hasValid(e))return y.create("macrocall","I can't (go-to:) to the passage '".concat(e,"' because it doesn't exist."),"Check that you didn't mistype the passage name, or rename the passage to something else.")},function(e,t,n){if(!b.options.ignoreGotos)return requestAnimationFrame(function(){return a.goToPassage(n,{transition:e.data.passageT8n})}),{blocked:!0}},[String])("redirect",function(e){if(!l.hasValid(e))return y.create("macrocall","I can't (redirect:) to the passage '".concat(e,"' because it doesn't exist."),"Check that you didn't mistype the passage name, or rename the passage to something else.")},function(e,t,n){if(!b.options.ignoreGotos)return requestAnimationFrame(function(){return a.redirect(n,{transition:e.data.passageT8n})}),{blocked:!0}},[String])("undo",P,function(e,t,n){return c.pastLength<1?C(e,{source:n}):b.options.ignoreGotos?void 0:(requestAnimationFrame(function(){return a.goBack({transition:e.data.passageT8n})}),{blocked:!0})},[x(String)])("debug",P,a.enableDebugMode,[],!1),b.onStartup(function(){return b.storyElement.on("click.icon","tw-icon",function(e){var t=u(this),n=t.data("clickEvent"),r=t.attr("alt");n&&n(t),"Undo"===r&&(e.stopPropagation(),a.goBack()),"Redo"===r&&(e.stopPropagation(),a.goForward()),"Fullscreen"===r&&(e.stopPropagation(),a.toggleFullscreen()),"Restart"===r&&(c.hasSessionStorage&&sessionStorage.removeItem("Saved Session"),window.location.reload())})}),[["Undo","&#8630;",function(){return 0<c.pastLength}],["Redo","&#8631;",function(){return 0<c.futureLength}],["Fullscreen","&#9974;",function(){return document.fullscreenEnabled||document.msFullscreenEnabled}],["Restart","&#10226;",Object]].forEach(function(e){var e=_slicedToArray(e,3),o=e[0],i=e[1],s=e[2];n.addCommand("icon-".concat(o.toLowerCase()),function(e,t){if("string"==typeof e&&"string"==typeof t)return e=_toConsumableArray(e).length,t=_toConsumableArray(t).length,1<e&&1<t?y.create("datatype","One of the two strings given to (icon-".concat(o.toLowerCase(),":) should be 1 character long, for its icon.")):1===e&&1===t?y.create("datatype","One of the two strings given to (icon-".concat(o.toLowerCase(),":) should be 2 or more characters long, for its label.")):void 0},function(t,e,n,r){var a;return("string"==typeof r&&1===_toConsumableArray(r).length||"string"==typeof n&&1<_toConsumableArray(n).length)&&(n=(a=[r,n])[0],r=a[1]),"Undo"===o&&(t.data.forgetUndosEvent=function(e){t.section.whenUnblocked(function(){return u(e).css("visibility","hidden")})}),C(t,{source:'<tw-icon tabindex=0 alt="'.concat(o,'" ').concat(r?'data-label="'.concat(r.replace('"',"&quot;"),'"'):"",' title="').concat(o,'" ').concat(s()?"":'style="visibility:hidden"',">").concat(n||i,"</tw-icon>")})},[x(String),x(String)])}),n.addCommand("icon-counter",function(e,t,n){var r=" label string given to (icon-counter:) can't be empty or only whitespace.";return t&&t.trim()?"string"!=typeof n||n.trim()?void 0:y.create("datatype","The 2nd "+r):y.create("datatype","The 1st "+r)},function(r,e,a,o,i){r.attr.push({"data-2bind":!0}),r.data.twoWayBindEvent=function(e,t,n){a.varRef.matches(t,n)&&"number"==typeof(t=a.varRef.get())&&r.target.children("tw-icon").text((0<t?E:N)(t)).attr("data-label",1!==j(t)&&void 0!==i?i:o)};var t=a.varRef.get();return"number"!=typeof t?y.create("datatype","(icon-counter:) can only be bound to a variable holding a number, not ".concat(m(t),".")):C(r,{source:'<tw-icon data-label="'.concat(b.escape(1!==j(t)&&void 0!==i?i:o),'">').concat((0<t?E:N)(t),"</tw-icon>")})},[v,String,x(String)]),n.addCommand("meter",function(e,t,n,r){return"two way"===e.bind?y.create("datatype","(meter:) shouldn't be given two-way bound variables.",'Change the "2bind" keyword to just "bind".'):"string"!=typeof r||r.trim()?-1===n.search(D)||!n.includes("=")&&1<n.length?y.create("datatype",'The (meter:) macro requires a sizing line("==X==", "==X", "=XXXX=" etc.) be provided, not '+JSON.stringify(n)+"."):void 0:y.create("datatype","The label string given to (meter:) can't be empty or only whitespace.")},function(r,e,a,n,t,o,i){o&&"string"!=typeof o&&(i=o,o=void 0),i=i||p.create({h:0,s:0,l:.5,a:.5}),p.isPrototypeOf(i)&&(i=d.create(90,[{colour:i,stop:0},{colour:i,stop:1}]));function s(e){var t=z(0,q(1,e/n)),e=i.repeating?i:i.multiply(n/e);return"height:100%;background-repeat:no-repeat;background-image:".concat((l?C(e,e.repeating?{}:{angle:270}).toLinearGradientString()+", ":"")+C(e,e.repeating?{}:{angle:l||0===c?90:270}).toLinearGradientString(),";background-size:").concat(l?Array(2).fill(50*t+"%"):100*t+"%",";background-position-x:").concat(l?-100/(2-t)+100+"%,"+100/(2-t)+"%":0===c?"left":"right",";text-align:").concat(l?"center":0===c?"left":"right")}var t=S(t),c=t.marginLeft,t=t.size,l=0<c&&Math.ceil(c+t)<100,u=(r.styles.push({"margin-left":c+"%",width:t+"%",height:"1.5em",display:"block"}),r.attr.push({"data-2bind":!0}),o&&e.stackTop.tempVariables),t=(r.data.twoWayBindEvent=function(e,t,n){a.varRef.matches(t,n)&&"number"==typeof(t=a.varRef.get())&&((n=r.target.children("tw-meter")).attr("style",s(t)),o)&&r.section.renderInto("",null,{source:o,target:n,append:"replace",transitionDeferred:!1},u)},a.varRef.get());return"number"!=typeof t?y.create("datatype","(meter:) can only be bound to a variable holding a number, not ".concat(m(t),".")):C(r,{source:'<tw-meter style="'.concat(s(t),'">').concat(o||"","</tw-meter>")})},[v,r,String,x(_(String,p,d)),x(_(p,d))]),[["cycling-link"],["seq-link","sequence-link"]].forEach(function(t,u){return n.addCommand(t,function(){var e;return""===(arguments.length<=0?void 0:arguments[0])?y.create("datatype","The first string in a ("+t[0]+":) can't be empty."):arguments.length<=(v.isPrototypeOf(arguments.length<=0?void 0:arguments[0])?2:1)?y.create("datatype","I need two or more strings to "+(u?"sequence":"cycle")+" through, not just '"+((e=arguments.length-1)<0||arguments.length<=e?void 0:arguments[e])+"'."):void 0},function(a,e){for(var o,t=arguments.length,i=new Array(2<t?t-2:0),n=2;n<t;n++)i[n-2]=arguments[n];v.isPrototypeOf(i[0])&&(o=i.shift());var s=0,c=("two way"===(null==(l=o)?void 0:l.bind)&&(a.attr.push({"data-2bind":!0}),-1<(l=i.indexOf(o.varRef.get())))&&(s=l),e.stackTop.tempVariables);function r(e,t){var n=s>=i.length-1&&u,r=""===i[s]?"":n?i[s]:"<tw-link>".concat(i[s],"</tw-link>");if(n&&(a.data.clickEvent=void 0),o&&!t){n=o.set(i[s]);if(y.containsError(n))return void e.replaceWith(n.render(i[s]))}t=_objectSpread(_objectSpread({},a),{},{source:r,transitionDeferred:!1});a.section.renderInto("",null,t,c)}i[s]&&(a.data.clickEvent=function(e){s=(s+1)%i.length,r(e,!1)},a.data.twoWayBindEvent=function(e,t,n){o.varRef.matches(t,n)&&(t=o.varRef.get(),-1<(n=i.indexOf(t)))&&n!==s&&(s=n,r(e,!0))});var l="<tw-link>".concat(i[s],"</tw-link>");if(o){e=o.set(i[s]);if(y.containsError(e))return e}return C(a,{source:l,append:"replace",transitionDeferred:!0})},[_(v,String),T(String)])}),b.onStartup(function(){return b.storyElement.on("change.dropdown-macro","select",function(){var e=u(this),t=e.closest("tw-expression, tw-hook").data("dropdownEvent");t&&t(e)})}),n.addCommand("dropdown",function(e){var t;return""===(arguments.length<=1?void 0:arguments[1])||""===((t=(arguments.length<=1?0:arguments.length-1)-1+1)<1||arguments.length<=t?void 0:arguments[t])?y.create("datatype","The first or last strings in a (dropdown:) can't be empty.","Because empty strings create separators within (dropdown:)s, having them at the start or end doesn't make sense."):(arguments.length<=1?0:arguments.length-1)<=1?y.create("datatype","I need two or more strings to create a (dropdown:) menu, not just "+(arguments.length<=1?0:arguments.length-1)+"."):void 0},function(e,t,r){for(var n=arguments.length,a=new Array(3<n?n-3:0),o=3;o<n;o++)a[o-3]=arguments[o];var i=0,s=("two way"===r.bind&&(e.attr.push({"data-2bind":!0}),-1<(c=a.indexOf(r.varRef.get())))&&(i=c),Math.max.apply(Math,_toConsumableArray(a.map(function(e){return _toConsumableArray(e).length})))),c="<select>"+a.map(function(e,t){return"<option".concat(t===i?" selected":"").concat(""===e?" disabled":"",">").concat(b.escape(e||"\u2500".repeat(s)),"</option>")}).join("\n")+"</select>",l=(e.data.dropdownEvent=function(e){var t=e.val(),n=r.set(t);y.containsError(n)&&e.replaceWith(n.render(t))},e.data.twoWayBindEvent=function(e,t,n){r.varRef.matches(t,n)&&(t=r.varRef.get(),-1<(n=a.indexOf(t)))&&n!==i&&(e.find("select").val(t),i=n)},e.styles.push({"background-color":function(){return b.parentColours(u(this)).backgroundColour}}),r.set(a[i]));return y.containsError(l)?l:C(e,{source:c,append:"replace"})},[v,String,T(String)]),b.onStartup(function(){return b.storyElement.on("input.checkbox-macro","input[type=checkbox]",function(){var e=u(this),t=e.closest("tw-expression").data("checkboxEvent");t&&t(e)})});function I(e){return["I can't use a dialog macro in "+e+".","Please rewrite this without putting such macros here."]}var V=1;n.addCommand("checkbox",function(){},function(e,t,r,n){var a=!1,o="checkbox-"+ ++V,i=("two way"===r.bind&&(e.attr.push({"data-2bind":!0}),"boolean"==typeof(i=r.varRef.get())&&(a=i),e.data.twoWayBindEvent=function(e,t,n){r.varRef.matches(t,n)&&"boolean"==typeof(t=r.varRef.get())&&e.children("input[type=checkbox]").prop("checked",t)}),e.data.checkboxEvent=function(e){var t=e.is(":checked"),t=r.set(t);y.containsError(t)&&e.replaceWith(t.render(""))},r.set(a));return y.containsError(i)?i:C(e,{source:'<input id="'.concat(o,'" type="checkbox" ').concat(a?"checked":"",'><label for="').concat(o,'">').concat(n,"</label>"),append:"replace"})},[v,String]),b.onStartup(function(){return u(document).on("fullscreenchange",function(){u("input[type=checkbox][id^=fullscreen]",b.storyElement).each(function(e,t){(u(t).closest("tw-expression").data("fullscreenEvent")||Object)(t)})})}),n.addCommand("checkbox-fullscreen",function(){},function(e,t,n){var r="fullscreenCheckbox-"+ ++V;return e.data.fullscreenEvent=function(e){return u(e).prop("checked",!(!document.fullscreenElement&&!document.msFullscreenElement))},e.data.checkboxEvent=function(){return a.toggleFullscreen()},C(e,{source:'<input id="'.concat(r,'" type="checkbox" ').concat(document.fullscreenEnabled||document.msFullscreenEnabled?" ":"disabled ").concat(document.fullscreenElement||document.msFullscreenElement?"checked":"",'><label for="').concat(r,'">').concat(n,"</label>"),append:"replace"})},[String]),b.onStartup(function(){return b.storyElement.on("input.input-box-macro","textarea, input[type=text]",function(){var e=u(this),t=e.closest("tw-expression").data("inputBoxEvent");t&&t(e)})}),["input","force-input","input-box","force-input-box"].forEach(function(g){return n.addCommand(g,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=g.endsWith("box"),a=v.isPrototypeOf(t[0]),o="string"==typeof t[+a],r=r&&"number"==typeof t[o+a],i=o?t[+a]:t[a+r],s=0<S(i).size,o=s?t[a+r+o]:i;return g.startsWith("force")&&"string"!=typeof o?y.create("datatype","The (".concat(g,":) macro requires a string of text to forcibly input.")):t.length>a+r+s+("string"==typeof o)?y.create("datatype","An incorrect combination of values was given to this (".concat(g,":) macro.")):void 0},function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];var o=g.startsWith("force"),i=g.endsWith("box"),s=v.isPrototypeOf(r[0]),c="string"==typeof r[+s],l=i&&"number"==typeof r[c+s],u=s&&r[0],p=l?r[1+s]:3,d=c?S(r[+s]):{},f=d.marginLeft,d=d.size,h=(d?r[s+l+c]:c&&r[+s])||"",l=o?"":h,c=!1;if("two way"===u.bind){e.attr.push({"data-2bind":!0});s=u.varRef.get();if("string"==typeof s){l=o?h.slice(0,s.length):s,s=u.set(l),c=!0;if(y.containsError(s))return s}e.data.twoWayBindEvent=function(e,t,n){u.varRef.matches(t,n)&&"string"==typeof(t=u.varRef.get())&&e.find(i?"textarea":"input").val(o?h.slice(0,t.length):t)}}if(u&&!c){s=u.set(o?"":h);if(y.containsError(s))return s}!o&&u&&(e.data.inputBoxEvent=function(e){var t=e.val(),t=u.set(t);y.containsError(t)&&e.replaceWith(t.render(""))});var m,c="<".concat(i?"textarea":"input type=text",' style="width:100%" ').concat(i?"rows=".concat(p,">"):'value="').concat(b.escape(l)).concat(i?"</textarea>":'">');return o&&(m=Array.from(h),e.data.inputBoxEvent=function(e){var t=e.val().length,t=m.slice(0,t).join("");return e.val(t),u&&(t=u.set(t),y.containsError(t))&&e.replaceWith(t.render("")),!0}),e.styles.push({display:"block","margin-left":d?f+"%":void 0,width:d?d+"%":"100%","border-style":function(){return this.style.borderStyle||"solid"}}),C(e,{source:c,append:"replace"})},g.endsWith("box")?[_(v,String),x(_(A,String)),x(_(A,String)),x(String)]:[x(_(v,String)),x(String),x(String)])}),["show","rerun"].forEach(function(s){return n.addCommand(s,function(){for(var r,e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.some(function e(t){var n=t.selector,t=t.next;return"name"===n.type&&"page"===n.data?(r=y.create("macrocall","You can't (hide:) the ?page. Sorry."),!0):!!("base"===n.type&&e(n.data)||t&&e(t))||void 0}),r},function(o,i){for(var e=arguments.length,t=new Array(2<e?e-2:0),n=2;n<e;n++)t[n-2]=arguments[n];return t.forEach(function(e){return e.forEach(i,function(e){var t,n,r,a=e.data("hidden");void 0!==a!=("rerun"===s)&&(e.removeData("hidden"),a instanceof u?e.empty().append(a):(a=e.data("tempVariables"),n=(t="tw-passage"===e.tag())?l.getTree(c.passage):e.data("originalSource")||"",t&&(r=e.find("tw-sidebar").detach()),i.renderInto("",null,_objectSpread(_objectSpread({},o),{},{append:"replace",source:n,target:e}),a&&Object.create(a)),r&&e.prepend(r)))})}),o},[T(o)])});n.addCommand("hide",function(){for(var r,e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.some(function e(t){var n=t.selector,t=t.next;return"name"===n.type&&"page"===n.data?(r=y.create("macrocall","You can't (hide:) the ?page. Sorry."),!0):!!("base"===n.type&&e(n.data)||t&&e(t))||void 0}),r},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=0,o=n;a<o.length;a++)o[a].forEach(e,function(e){e.data("hidden")||e.data("hidden",e.contents().detach())})},[T(o)],!1)("scroll",P,function(m,e,g){var y="number"==typeof g&&g;requestAnimationFrame(function(){e.forEach(m,function(e){if(!1!==y){var t,n,r=e[0];null!=(t=(n=r=r===b.storyElement[0]&&r.scrollHeight===r.clientHeight?getComputedStyle(document.body).overflow.includes(" scroll")?document.body:document.documentElement:r).scrollTo)&&t.call(n,0,(r.scrollHeight-r.clientHeight)*y)}else{var a,o=_createForOfIteratorHelper(g.hooks(m).get());try{for(o.s();!(a=o.n()).done;){var i=a.value;if(e.find(i)){for(var s=[],c=e[0];(c=c.parentNode)&&c!==document.body;)s.push([c,c.scrollLeft,c.scrollTop]);i.scrollIntoView();for(var l=0,u=s;l<u.length;l++){var p=_slicedToArray(u[l],3),d=p[0],f=p[1],h=p[2];d.scrollLeft=f,d.scrollTop=h}break}}}catch(e){o.e(e)}finally{o.f()}}})})},[o,_(L,o)],!1)("stop",P,P,[],!1)("load-game",P,function(e,t){var n,r;return e.loadedGame?y.create("infinite","I can't use (load-game:) immediately after loading a game."):(n=localStorage.getItem(R("Saved Game")+t))?(n=c.deserialise(e,n))instanceof Error?{blocked:r=k({message:"Sorry to interrupt... The story tried to load saved data, but there was a problem.\n"+n.message+"\n\nThat data might have been saved from a different version of this story. Should I delete it?\n(Type 'delete' and choose Yes to delete it.)\n\nEither way, the story will now continue without loading the data.",defaultValue:"",buttons:[{name:"Yes",confirm:!0,callback:function(){"delete"===r.find("input").last().val()&&localStorage.removeItem(R("Saved Game")+t),e.unblock("")}},{name:"No",cancel:!0,callback:function(){return e.unblock()}}]})}:void requestAnimationFrame(a.showPassage.bind(a,c.passage,{loadedGame:!0})):y.create("saving","I can't find a save slot named '"+t+"'!")},[String],!1)("forget-undos",P,function(e,t){c.futureLength||c.forgetUndos(t)},[parseInt],!1)("forget-visits",P,function(e,t){c.forgetVisits(t)},[parseInt],!1)("mock-visits",function(){if(!b.options.debug)return y.create("debugonly","(mock-visits:) cannot be used outside of debug mode.");for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t.find(function(e){return!l.hasValid(e)});return r?y.create("datatype","I can't mock-visit '"+r+"' because no passage with that name exists."):void 0},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];c.mockVisits=g(n)},[T(String)],!1)("mock-turns",function(){if(!b.options.debug)return y.create("debugonly","(mock-turns:) cannot be used outside of debug mode.")},function(e,t){c.mockTurns=t},[H],!1)("seed",P,function(e,t){c.setSeed(t)},[String],!1)(["dialog","alert"],function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];if(v.isPrototypeOf(e)){if("two way"===e.bind)return y.create("datatype","(dialog:) shouldn't be given two-way bound variables.",'Change the "2bind" keyword to just "bind".');if(void 0===t)return y.create("datatype","(dialog:) needs a message string or codehook to display.")}else void 0!==t&&r.unshift(t);e=r.findIndex(function(e){return""===e});if(-1<e)return y.create("datatype","(dialog:)'s ".concat(b.nth(e+1)," link text shouldn't be an empty string."))},function(e,n,r,t){for(var a=arguments.length,o=new Array(4<a?a-4:0),i=4;i<a;i++)o[i-4]=arguments[i];return v.isPrototypeOf(r)||(void 0!==t&&o.unshift(t),t=r,r=void 0),o.length||(o=["OK"]),{blocked:k({section:n,message:t,cd:e,buttons:o.map(function(t){return{name:t,callback:function(){var e;n.unblock((null==(e=r)?void 0:e.set(t))||"")}}})})}},[_(v,String,t),x(_(t,String)),O(String)])("open-url",P,function(e,t){window.open(t,"")},[String],!1)(["restart","reload"],P,function(){if(!b.options.ignoreGotos){if(c.turns<=1)return y.create("infinite","I mustn't (restart:) the story in the starting passage.");c.hasSessionStorage&&sessionStorage.removeItem("Saved Session"),window.location.reload()}},[],!1)("goto-url",P,function(e,t){window.location.assign(t)},[String],!1)("ignore",P,P,[O(F)])("assert-exists",function(e){if(""===e)return y.create("datatype","(assert-exists:) mustn't be given an empty string.")},function(e,t,n){var r=0;return("string"==typeof n?o.create({type:"string",data:n}):n).forEach(t,function(){++r}),r?e:y.create("assertion","I didn't see any ".concat("string"==typeof n?"text occurrences of":"hooks matching"," ").concat(w(n)," in this passage."))},[_(o,String)]),n.add("assert","Instant",function(e,t){return t?{TwineScript_TypeID:"instant",TwineScript_TypeName:"an (assert:) operation",TwineScript_ObjectName:"an (assert:) operation",TwineScript_Unstorable:!0,TwineScript_Print:function(){return""}}:C(y.create("assertion","An assertion failed: "),{appendTitleText:!0})},[Boolean])("save-game","Boolean",function(e,t,n){if(n=n||"",!c.hasStorage)return!1;var r=c.serialise(!1).pastAndPresent;if(y.containsError(r))return r;if(!1===r)return!1;try{return localStorage.setItem(R("Saved Game")+t,r),localStorage.setItem(R("Saved Game Filename")+t,n),!0}catch(e){return!1}},[String,x(String)])("prompt","String",function(e,t,n,r,a){var o,i;return null!=(o=e.stackTop)&&o.evaluateOnly?y.create.apply(y,["macrocall"].concat(_toConsumableArray(I(e.stackTop.evaluateOnly)))):""===a?y.create("datatype","The text for (prompt:)'s confirm link can't be blank."):(i=k({section:e,message:t,defaultValue:n,buttons:[{name:a||"OK",confirm:!0,callback:function(){return e.unblock(i.find("input").last().val())}}].concat(""===r?[]:{name:r||"Cancel",cancel:!0,callback:function(){return e.unblock(n)}})}),e.stackTop.blocked=i,0)},[_(String,t),String,x(String),x(String)])("confirm","Boolean",function(e,t,n,r){var a;return null!=(a=e.stackTop)&&a.evaluateOnly?y.create.apply(y,["macrocall"].concat(_toConsumableArray(I(e.stackTop.evaluateOnly)))):""===r?y.create("datatype","The text for (confirm:)'s confirm link can't be blank."):(a=k({section:e,message:t,defaultValue:!1,buttons:[{name:r||"OK",confirm:!0,callback:function(){return e.unblock(!0)}}].concat(""===n?[]:{name:n||"Cancel",cancel:!0,callback:function(){return e.unblock(!1)}})}),e.stackTop.blocked=a,0)},[_(String,t),x(String),x(String)])("page-url","String",function(){return window.location.href},[])}),define("macrolib/custommacros",["utils","macros","state","utils/operationutils","datatypes/changercommand","datatypes/custommacro","datatypes/codehook","datatypes/typedvar","internaltypes/twineerror"],function(c,l,u,e,t,p,n,d,f){function s(e,t,n){if(!t.some(function(e){if("function"==typeof e.output)return e.output(n),!0}))return f.create("macrocall","("+e+":) should only be used inside a code hook passed to (macro:).")}var h=e.objectName,m=e.toSource,e=l.add,r=l.addChanger,a=l.addCommand,o=l.TypeSignature,i=o.rest,g=o.either,y=o.Any,b=o.Everything,o=o.zeroOrMore;e("macro","CustomMacro",function(e){for(var t,n=[],r=arguments.length,a=new Array(1<r?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];for(t=0;t<a.length;t+=1){var i=t===a.length-1;if(d.isPrototypeOf(a[t])===i)return f.create("datatype","The "+(i?"":c.nth(a.length-t+1)+"-")+"last value given to (macro:) should be a "+(i?"code hook":"datatyped variable")+", not "+h(a[t]));if(!i){i="A custom macro";if(a[t].varRef.object===u.variables)return f.create("datatype",i+"'s typed variables must be temp variables (with a '_'), not global variables (with a '$').","Write them with a _ symbol at the start instead of a $ symbol.");if(1<a[t].varRef.propertyChain.length)return f.create("datatype",i+"'s typed variables can't be properties inside a data structure.");if(a[t].datatype.rest&&t!==a.length-2)return f.create("datatype",i+" can only have one spread variable, and it must be its last variable.");var s=a[t].varRef.propertyChain[0];if(n.includes(s))return f.create("datatype",i+"'s typed variables can't both be named '"+s+"'.");n.push(s)}}return p.create(a.slice(0,-1),a[a.length-1])},[i(g(d,n))]);a(["output-data","out-data"],function(){},function(e,t){e=e.stack;return s("output-data",e,t)||{blocked:!0}},[y],!1),r(["output","out"],function(){return Object.assign(t.create("output",[]))},function(e,t){if(e.section){var n,r=e.section,a=r.stack,o=r.stackTop,i={};for(n in o.tempVariables)n.startsWith("TwineScript_")||(i[n]=o.tempVariables[n]);s("output",a,{changer:t,variables:i,hook:Array.isArray(e.source)?"["+e.source.map(function(e){return e.text}).join("")+"]":e.source}),e.output=!0,o.blocked=!0}},[]),a("error",function(e){if(!e)return f.create("datatype","This (error:) macro was given an empty string.")},function(e,t){e=e.stack;return s("error",e,f.create("user",t))||{blocked:!0}},[String],!1),e("partial","CustomMacro",function(e,a){for(var t=arguments.length,o=new Array(2<t?t-2:0),n=2;n<t;n++)o[n-2]=arguments[n];var r="string"!=typeof a&&a,i=!r&&a;if(!r){if(!l.has(i))return f.create("macrocall",'The macro name given to (partial:), "'.concat(a,"\", isn't the name of a built-in macro."));if("Metadata"===l.get(i).returnType)return f.create("macrocall","(partial:) can't be used with metadata macros such as (".concat(a,":)"))}var s="(partial:".concat(m(a),",").concat(o.map(function(e){return m(e)}),")"),c=p.createFromFn(function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];e=l["string"==typeof a?"run":"runCustom"](a,e,o.concat(n));return f.containsError(e)&&(e.message="An error occurred while running the (partial:)-created macro, ".concat(c.TwineScript_ObjectName,":\n")+e.message),e},"a (partial:) custom macro of ".concat(i||r.TwineScript_KnownName?"(".concat(i||r.TwineScript_KnownName,":").concat(o.map(function(e){return m(e)}),")"):"another unnamed custom macro"),function(){return s},(i?l.get(i):r).typeSignature.filter(function(e,t){return t>=o.length||"rest"===e.pattern||"zero or more"===e.pattern}));return c},[g(String,p),o(b)])}),define("macrolib/datastructures",["utils","utils/naturalsort","macros","utils/operationutils","state","engine","passages","datatypes/lambda","datatypes/typedvar","internaltypes/twineerror"],function(e,i,t,n,s,r,a,c,o,l){var u=e.permutations,p=e.options,d=n.objectName,f=n.subset,h=n.collectionType,m=n.isValidDatamapName,g=n.is,y=n.unique,b=n.clone,v=n.range,e=t.TypeSignature,n=e.optional,w=e.rest,k=e.either,S=e.zeroOrMore,T=e.Any,e=e.nonNegativeInteger,_=i("en");t.add(["a","array"],"Array",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n},S(k(o,T)))("range","Array",function(e,t,n){return v(t,n)},[parseInt,parseInt])("subarray","Array",function(e,t,n,r){return f(t,n,r)},[Array,parseInt,parseInt])("reversed","Array",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.reverse().map(b)},S(T))("shuffled","Array",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return s.shuffled.apply(s,n).map(b)},[S(T)])("sorted","Array",function(e){for(var t,n=arguments.length,r=new Array(1<n?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];if(!c.isPrototypeOf(r[0]))return(t=r.filter(function(e){return"string"!=typeof e&&"number"!=typeof e}))&&t.length?1===t.length&&Array.isArray(t[0])?l.create("macrocall","Please give multiple numbers or strings to (sorted:), not a single array.","You can use the spread ... syntax to spread out the array's values into (sorted:)."):l.create("datatype","If (sorted:) isn't given a 'via' lambda, it must be given only numbers and strings, not ".concat(d(t[0]),".")):r.sort(_);var o=r.shift();if("making"in o||"where"in o||"when"in o||!("via"in o))return l.create("datatype","The optional lambda given to (sorted:) must be a 'via' lambda, not ".concat(d(o),"."));for(var i=0;i<r.length;i+=1){var s=o.apply(e,{loop:r[i],pos:i+1});if(l.containsError(s))return s;if("string"!=typeof s&&"number"!=typeof s)return l.create("datatype",'The "via" lambda given to (sorted:) couldn\'t convert '.concat(d(r[i])," into a string or number."));r[i]=[r[i],s]}return r.sort(function(e,t){return _(e[1],t[1])}).map(function(e){return e[0]})},[S(T)])("rotated","Array",function(e,t){if(0===t)return l.create("macrocall","I can't rotate these values by 0 positions.");for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t=-1*(t=Math.abs(t)%r.length*Math.sign(t));return r.slice(t).concat(r.slice(0,t)).map(b)},[parseInt,S(T)])("rotated-to","Array",function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t=t.filter(e,r);return l.containsError(t)?t:t.length?(e=r.indexOf(t[0]),r.slice(e).concat(r.slice(0,e)).map(b)):l.create("macrocall","None of these "+r.length+" values matched the lambda, so I can't rotate them.")},[c.TypeSignature("where"),w(T)])("repeated","Array",function(e,t){for(var n=[],r=arguments.length,a=new Array(2<r?r-2:0),o=2;o<r;o++)a[o-2]=arguments[o];if(!a.length)return n;for(;0<t--;)n.push.apply(n,a);return n.map(b)},[e,w(T)])("interlaced","Array",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=Math.min.apply(Math,_toConsumableArray(n.map(function(e){return e.length}))),o=[],i=0;i<a;i+=1)for(var s=0;s<n.length;s+=1)o.push(b(n[s][i]));return o},[Array,w(Array)])("permutations","Array",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.length?u.apply(void 0,n):[]},[S(T)])("unique","Array",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.filter(y)},[S(T)])("altered","Array",function(n,r){for(var e=arguments.length,t=new Array(2<e?e-2:0),a=2;a<e;a++)t[a-2]=arguments[a];return t.map(function(e,t){t=r.apply(n,{loop:e,pos:t+1});return null===t?e:t})},[k(c.TypeSignature("via"),c.TypeSignature("where","via")),S(T)])("find","Array",function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return t.filter(e,r)},[c.TypeSignature("where"),S(T)])(["all-pass","pass"],"Boolean",function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t=t.filter(e,r);return l.containsError(t)||t.length===r.length},[c.TypeSignature("where"),S(T)])("some-pass","Boolean",function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t=t.filter(e,r);return l.containsError(t)||0<t.length},[c.TypeSignature("where"),S(T)])("none-pass","Boolean",function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t=t.filter(e,r);return l.containsError(t)||0===t.length},[c.TypeSignature("where"),S(T)])("folded","Any",function(r,a){for(var e=arguments.length,t=new Array(2<e?e-2:0),n=2;n<e;n++)t[n-2]=arguments[n];return"where"in a&&(t=[t[0]].concat(_toConsumableArray(a.filter(r,t.slice(1))))),l.containsError(t)||t.reduce(function(e,t,n){return a.apply(r,{making:e,loop:t,pos:n+1})})},[k(c.TypeSignature("where","via","making"),c.TypeSignature("via","making")),w(T)])(["dm-names","datamap-names","datanames"],"Array",function(e,t){return Array.from(t.keys()).sort(i("en"))},[Map])(["dm-values","datamap-values","datavalues"],"Array",function(e,t){return Array.from(t.entries()).sort(i("en",function(e){return String(e[0])})).map(function(e){return b(e[1])})},[Map])(["dm-entries","datamap-entries","dataentries"],"Array",function(e,t){return Array.from(t.entries()).sort(function(e,t){return[e[0],t[0]].sort(i("en"))[0]===e[0]?-1:1}).map(function(e){return new Map([["name",e[0]],["value",b(e[1])]])})},[Map])(["dm-altered","datamap-altered"],"Datamap",function(a,o,e){return Array.from(e.entries()).sort(function(e,t){return[e[0],t[0]].sort(i("en"))[0]===e[0]?-1:1}).reduce(function(e,t,n){if(!l.containsError(e)){var r=new Map([["name",t[0]],["value",b(t[1])]]),r=o.apply(a,{loop:r,pos:n+1});if(l.containsError(r))return r;e.set(t[0],null===r?t[1]:r)}return e},new Map)},[k(c.TypeSignature("via"),c.TypeSignature("where","via")),Map])("history","Array",function(e,t){var n=s.history();return t?(t=t.filter(e,n.map(function(e){return a.get(e)})),l.containsError(t)?t:t.map(function(e){return e.get("name")})):n},[n(c.TypeSignature("where"))])("visited","Boolean",function(e,t){var n;return"string"==typeof t?a.has(t)?0<s.passageNameVisited(t)||s.passage===t:l.create("macrocall","There's no passage named '"+t+"' in this story."):(n=s.history(),n=t.filter(e,n.concat(s.passage).map(function(e){return a.get(e)})),l.containsError(n)?n:0<n.length)},[k(String,c.TypeSignature("where"))])("passage","Datamap",function(e,t){return b(a.get(t||s.passage))||l.create("macrocall","There's no passage named '"+t+"' in this story.")},[n(String)])("passages","Array",function(e,t){var n=i("en"),r=_toConsumableArray(a.values()).map(function(e){return b(e)}),t=t?t.filter(e,r):r,e=l.containsError(t);return e||t.sort(function(e,t){return n(e.get("name"),t.get("name"))})},[n(c.TypeSignature("where"))])("open-storylets","Array",function(e,t){return e.stackTop.evaluateOnly?l.create("macrocall","(open-storylets:) can't be used in "+e.stackTop.evaluateOnly+"."):(e=a.getStorylets(e,t),l.containsError(e)||e.map(b))},[n(c.TypeSignature("where"))])("savedgames","Datamap",function(){function e(e){return"("+e+" "+p.ifid+") "}var t,n,r=0,a=new Map;do{if(!s.hasStorage)break;t=localStorage.key(r),r+=1;var o=e("Saved Game")}while(null!=(n=t)&&n.startsWith(o)&&(t=t.slice(o.length),a.set(t,localStorage.getItem(e("Saved Game Filename")+t))),t);return a},[])(["datamap","dm"],"Datamap",function(e){for(var r,a=new Map,t=arguments.length,n=new Array(1<t?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];var i=n.reduce(function(e,t){var n;if(!l.containsError(e))if(void 0===r)r=t;else{if(n=l.containsError(m(a,r)))return n;if(a.has(r))return l.create("macrocall","You used the same data name ("+d(r)+") twice in the same (datamap:) call.");a.set(r,b(t)),r=void 0}return e},!0);return l.containsError(i)?i:void 0!==r?l.create("macrocall","This datamap has a data name without a value."):a},S(k(o,T)))(["dataset","ds"],"Dataset",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return new Set(n.filter(y).map(b))},S(T))("count","Number",function t(n,r){for(var e,a=arguments.length,o=new Array(2<a?a-2:0),i=2;i<a;i++)o[i-2]=arguments[i];if(1<o.length)return e=o.map(function(e){return t(n,r,e)}),l.containsError(e)||e.reduce(function(e,t){return e+t},0);var s=o[0];switch(h(r)){case"dataset":case"datamap":return l.create("macrocall","(count:) shouldn't be given a datamap or dataset.","You should use the 'contains' operator instead. For instance, write: $variable contains 'value'.");case"string":return"string"!=typeof s?l.create("macrocall",d(r)+" can't contain  "+d(s)+" because it isn't also a string."):s?r.split(s).length-1:0;case"array":return r.reduce(function(e,t){return e+g(t,s)},0);default:return l.create("macrocall",d(r)+" can't contain values, let alone "+d(s)+".")}},[T,w(T)])}),define("macrolib/enchantments",["jquery","utils","utils/operationutils","engine","state","passages","macros","datatypes/hookset","datatypes/codehook","datatypes/changercommand","datatypes/lambda","internaltypes/changedescriptor","internaltypes/enchantment","internaltypes/twineerror"],function(c,r,e,l,s,n,u,p,a,d,t,i,f,h){var m=e.is,e=u.TypeSignature,g=e.either,y=e.rest,o=e.optional,b=Object.assign;function v(e,t){if(d.isPrototypeOf(t)&&!t.canEnchant)return h.create("datatype","The changer given to (".concat(e,":) can't include a revision, enchantment, or interaction changer like (replace:), (click:), or (link:)."))}["enchant","change"].forEach(function(o){u.addCommand(o,function(e,t){t=v(o,t);if(t)return t},function(t,n,e){n=p.from(n);var r,a=[];return d.isPrototypeOf(e)&&(r=i.create({section:t}),e.run(r),0<(r.innerEnchantments||[]).length)&&(r=r.innerEnchantments.map(function(e){return e(n)}),a.push.apply(a,_toConsumableArray(r))),a.push(f.create(_defineProperty(_defineProperty({scope:n},d.isPrototypeOf(e)?"changer":"lambda",e),"section",t))),a.forEach(function(e){"enchant"===o?(t.addEnchantment(e),t.updateEnchantments()):e.enchantScope()}),""},[g(p,String),g(d,t.TypeSignature("via"))],!1)}),u.addChanger("enchant-in",function(e,t,n){var r=v("enchant-in",n);return r||d.create("enchant-in",[t,n])},function(t,n,r){return t.innerEnchantments=(t.innerEnchantments||[]).concat(function(e){return f.create(_defineProperty(_defineProperty({scope:p.from(n),localHook:e},d.isPrototypeOf(r)?"changer":"lambda",r),"section",t.section))}),t},[g(p,String),g(d,t.TypeSignature("via"))]),[["link-style",p.create({type:"name",data:"link"})],["line-style",p.create({type:"base",data:p.create({type:"name",data:"page"})},"lines",void 0)],["char-style",p.create({type:"base",data:p.create({type:"name",data:"page"})},"chars",void 0)]].forEach(function(e){var e=_slicedToArray(e,2),r=e[0],a=e[1];u.addChanger(r,function(e,t){var n=v(r,t);return n||d.create(r,[t])},function(t,n){return t.innerEnchantments=(t.innerEnchantments||[]).concat(function(e){return f.create(_defineProperty(_defineProperty({scope:a,localHook:e},d.isPrototypeOf(n)?"changer":"lambda",n),"section",t.section))}),t},[g(d,t.TypeSignature("via"))])});e=["replace","append","prepend"];function w(i,s){return r.onStartup(function(){var e=i.classList.replace(/ /g,"."),t=i.blockClassList?i.blockClassList.replace(/ /g,"."):"",n="."+e+(t?",."+t:"");r.storyElement.on(i.event.map(function(e){return e+".enchantment"}).join(" "),n,function(){var e,t=c(this);r.options.debug&&r.options.ignoreClickEvents&&!t.is("tw-backdrop.eval-replay *, tw-backdrop.harlowe-crash *")||t.is("tw-open-button")||(e=(t=c(Array.from(t.parents(n).add(this)).sort(function(e,t){return 8&e.compareDocumentPosition(t)?1:-1})[0])).data("enchantmentEvent"))&&e(t)})}),[function(e,t,n){if(!t)return h.create("datatype","A string given to this ("+s+":) macro was empty.");if(n){var r=v(s,n);if(r)return r}return d.create(s,[p.from(t)].concat(n?[n]:[]))},function(t,e,n){t.enabled=!1,t.transitionDeferred=!0,i.rerender&&(t.newTargets=(t.newTargets||[]).concat({target:e,append:i.rerender}));var r,a=null!=(r=t.section)&&r.stackTop?t.section.stackTop.tempVariables:Object.create(null),o=f.create(_defineProperty({functions:[function(e){e.attr("class",e.children().is("tw-story, tw-sidebar, tw-passage")||["block","flex"].includes(e.children().css("display"))?i.blockClassList:i.classList),e.attr({tabIndex:"0"})}],data:{enchantmentEvent:function(){var e;null!=(e=t.section.stackTop)&&e.blocked||(i.once&&t.section.removeEnchantment(o),i.goto?l.goToPassage(i.goto,{transition:i.transition}):i.undo?l.goBack({transition:i.transition}):t.section.renderInto(t.source,null,_objectSpread(_objectSpread({},t),{},{append:i.once?"append":"replace",enabled:!0,transitionDeferred:!1}),a))}},scope:e,section:t.section,name:s},d.isPrototypeOf(n)?"changer":"lambda",n));return t.section&&(t.section.addEnchantment(o),o.enchantScope()),t},[g(p,String),o(g(d,t.TypeSignature("via")))]]}e.forEach(function(o){u.addChanger(o,function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.every(Boolean)?d.create(o,n.map(p.from),null,!1):h.create("datatype","A string given to this (".concat(o,":) macro was empty."))},function(e){var t;0<c(e.target).parents().filter("tw-collapsed,[collapsing=true]").length||e.attr.some(function(e){return e.collapsing})||(e.attr=[].concat(_toConsumableArray(e.attr),[{collapsing:!1}])),e.newTargets=e.newTargets||[];for(var n=arguments.length,r=new Array(1<n?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];return(t=e.newTargets).push.apply(t,_toConsumableArray(r.filter(function(n){return!e.newTargets.some(function(e){var t=e.target,e=e.append;return m(n,t)&&o===e})}).map(function(e){return{target:e,append:o,before:!0}}))),e},y(g(p,String)))(o+"-with",function(e,t){return d.create(o+"-with",[t],null,!1)},function(e,t){return a.isPrototypeOf(t)&&(t=t.code),e.appendSource=(e.appendSource||[]).concat({source:t,append:o}),e},g(a,String))});var k="ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints,S=[{name:"click",enchantDesc:{event:["click"],once:!0,rerender:"",classList:"link enchantment-link",blockClassList:"enchantment-clickblock"}},{name:"mouseover",enchantDesc:{event:["mouseenter",k?"click":""].filter(Boolean),once:!0,rerender:"",classList:"link enchantment-mouseover",blockClassList:"enchantment-mouseoverblock"}},{name:"mouseout",enchantDesc:{event:["mouseleave",k?"click":""].filter(Boolean),once:!0,rerender:"",classList:"link enchantment-mouseout",blockClassList:"enchantment-mouseoutblock"}},{name:"doubleclick",enchantDesc:{event:["dblclick"],once:!0,rerender:"",classList:"link enchantment-dblclick",blockClassList:"enchantment-dblclickblock"}}];S.forEach(function(e){"doubleclick"!==e.name&&(u.addChanger.apply(u,[e.name].concat(_toConsumableArray(w(e.enchantDesc,e.name)))),"click"===e.name)&&u.addChanger.apply(u,[e.name+"-rerun"].concat(_toConsumableArray(w(_objectSpread(_objectSpread({},e.enchantDesc),{},{once:!1}),e.name+"-rerun"))))}),r.onStartup(function(){S.forEach(function(e){var n=e.enchantDesc;n.blockClassList&&r.storyElement.on(n.event.map(function(e){return e+".enchantment"}).join(" "),function(){var e,t=c(this);r.options.debug&&r.options.ignoreClickEvents&&!t.is("tw-backdrop.eval-replay *, tw-backdrop.harlowe-crash *")||t.is("tw-open-button")||(e=(t=c(Array.from(t.parents("."+n.blockClassList.replace(/ /g,"."))).sort(function(e,t){return 8&e.compareDocumentPosition(t)?1:-1})[0])).data("enchantmentEvent"))&&e(t)})})}),e.forEach(function(n){S.forEach(function(e){var t;"doubleclick"!==e&&(t=_objectSpread(_objectSpread({},e.enchantDesc),{},{rerender:n}),e=e.name+"-"+n,u.addChanger.apply(u,[e].concat(_toConsumableArray(w(t,e)))))})}),S.forEach(function(i){"doubleclick"!==i&&["goto","undo"].forEach(function(a){var o=i.name+"-"+a;u.addCommand(o,function(e,t){return!e||!t&&"goto"===a?h.create("datatype","A string given to this ("+o+":) macro was empty."):"goto"!==a||n.hasValid(t)?void 0:h.create("macrocall","I can't ("+o+":) the passage '"+t+"' because it doesn't exist.")},function(e,t,n,r){return"undo"===a&&s.pastLength<1?h.create("macrocall","I can't (undo:) on the first turn."):((0,_slicedToArray(w(_objectSpread(_objectSpread({},i.enchantDesc),{},{transition:e.data.passageT8n},"undo"===a?{undo:!0}:{goto:r}),o),2)[1])({section:t},p.from(n)),b(e,{source:""}))},[g(p,String)].concat("undo"===a?[]:String))})})}),define("macrolib/links",["jquery","macros","utils","state","passages","engine","datatypes/changercommand","internaltypes/changedescriptor","datatypes/hookset","datatypes/lambda","internaltypes/twineerror"],function(i,e,c,l,u,p,a,d,t,f,h){var n=e.TypeSignature,r=n.optional,o=n.rest,n=n.either,m=["Links can't have empty strings for their displayed text.","In the link syntax, a link's displayed text is inside the [[ and ]], and on the non-pointy side of the -> or <- arrow if it's there."],g=Object.assign;function s(e,t,n){n=n||t;var r,a=u.hasValid(t)&&t===n,e=e.evaluateTwineMarkup(c.unescape(n),"a link's passage name");return a?t=(a=0<e.children().length?"`".repeat((n.match(/`+/)||[]).reduce(function(e,t){return Math.max(e,t.length+1)},1)):"")+"\0".repeat(!!a)+t+"\0".repeat(!!a)+a:(e.findAndFilter("tw-error").length&&(r=e.findAndFilter("tw-error").data("TwineError")),n=e.text()),{text:t,passage:n,error:r}}c.onStartup(function(){var e="ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints;function t(e){var t=i(this),n=t.closest("tw-expression"),r=t.closest("tw-expression, tw-hook"),a=r.data("clickEvent"),r=r.data("section");if((!c.options.debug||!c.options.ignoreClickEvents||t.is("tw-backdrop.eval-replay *, tw-backdrop.harlowe-crash *"))&&!t.is("tw-open-button")&&(null==r||!r.stackTop||!r.stackTop.blocked||r.stackTop.blocked instanceof i&&r.stackTop.blocked.find(t).length)){if(a)return 0<t.find("tw-error").length?void 0:(e.stopPropagation(),void a(t));var r=n.data("linkPassageName"),o=_objectSpread({},n.data("passageT8n")||{});n.find("tw-enchantment").each(function(e,t){Object.assign(o,i(t).data("passageT8n")||{})}),r?(e.stopPropagation(),p.goToPassage(r,{transition:o})):t.is("[undo]")?(e.stopPropagation(),p.goBack({transition:o})):t.is("[fullscreen]")&&(e.stopPropagation(),p.toggleFullscreen())}}c.storyElement.on("click.passage-link","tw-link"+(e?"":":not(.enchantment-mouseover):not(.enchantment-mouseout):not(.enchantment-dblclick)"),t).on("mouseover.passage-link","tw-link.enchantment-mouseover, tw-expression.enchantment-mouseover > tw-link",t).on("mouseout.passage-link","tw-link.enchantment-mouseout, tw-expression.enchantment-mouseout > tw-link",t).on("dblclick.passage-link","tw-link.enchantment-dblclick, tw-expression.enchantment-dblclick > tw-link",t),i(document).on("fullscreenchange",function(){i("tw-link[fullscreen]",c.storyElement).each(function(e,t){(i(t).closest("tw-expression, tw-hook").data("fullscreenEvent")||Object)(t)})})}),[["link","link-replace"],["link-reveal","link-append"],["link-repeat"],["link-rerun"]].forEach(function(s){return e.addChanger(s,function(e,t,n){return t?n&&!n.canEnchant?h.create("datatype","The changer given to (".concat(s[0],":) can't be (or include) a revision, enchantment, or interaction changer like (replace:), (click:), or (link:).")):a.create(s[0],[t].concat(n||[]),null,!0):h.create("datatype",m[0])},function(r,e,t){var n,a=s[0],o=null!=(n=r.section)&&n.stackTop?r.section.stackTop.tempVariables:Object.create(null),i=d.create({source:"<tw-link tabindex=0>"+e+"</tw-link>",target:function(){return r.target},append:"replace",data:{section:r.section,clickEvent:function(e){r.enablers=r.enablers.filter(function(e){return e.descriptor!==i}),"link-reveal"===a&&e.contents().unwrap();var t,n=e.parentsUntil(":not(tw-enchantment)").parent();n.length||(n=e.parent()),"link-rerun"===a&&(t=e.parentsUntil(":not(tw-enchantment)"),e.detach(),t.remove()),"link"!==a&&"link-rerun"!==a||n.empty(),r.section.renderInto("",null,r,o),"link-rerun"===a&&n.prepend(e)}}});return r.enablers=(r.enablers||[]).concat({descriptor:i,changer:t}),r},[String,r(a)])}),e.addCommand("link-goto",function(e){if(!e)return h.create.apply(h,["datatype"].concat(m))},function(e,t,n,r){var a,o=s(t,n,r);return n=o.text,r=o.passage,(o=o.error)||(e.transition?h.create("datatype","Please attach ("+(o="transition")+"-depart:) or ("+o+"-arrive:) to a passage link, not ("+o+":)."):(a=(a=u.hasValid(r)?a:'<tw-broken-link passage-name="'+c.escape(r)+'">'+n+"</tw-broken-link>")||"<tw-link tabindex=0 "+(0<l.passageNameVisited(r)?'class="visited" ':"")+">"+n+"</tw-link>",e.data.linkPassageName=r,e.data.section=t,g(e,{source:a,transitionDeferred:!0})))},[String,r(String)])("link-storylet",function(){var e=(e=1===arguments.length||"string"!=typeof(arguments.length<=0?void 0:arguments[0])?0:1)<0||arguments.length<=e?void 0:arguments[e];if(!e||"string"==typeof e)return h.create("datatype","(link-storylet:) should be given one index number or one 'where' lambda, after the optional link text string.")},function(e,t){var n=(n=2+("string"==typeof(arguments.length<=2?void 0:arguments[2])?1:0))<2||arguments.length<=n?void 0:arguments[n],r="string"==typeof(arguments.length<=2?void 0:arguments[2])&&(arguments.length<=2?void 0:arguments[2]),a=((a=(arguments.length<=2?0:arguments.length-2)-1+2)<2||arguments.length<=a?void 0:arguments[a])!==n&&((a=(arguments.length<=2?0:arguments.length-2)-1+2)<2||arguments.length<=a?void 0:arguments[a]);if(e.transition)return h.create("datatype","Please attach (".concat(o="transition","-depart:) or (").concat(o,"-arrive:) to (link-storylet:), not (").concat(o,":)."));var o=f.isPrototypeOf(n),i=u.getStorylets(t,o&&n),s=h.containsError(i);if(s)return s;var c,s=i[o?0:n<0?i.length+n:n-1];if(s)s=s.get("name"),r=r||s,c=c||"<tw-link tabindex=0 "+(0<l.passageNameVisited(s)?'class="visited" ':"")+">"+r+"</tw-link>",e.data.linkPassageName=s,e.data.section=t;else{if(!a)return e;c=a}return g(e,{source:c,transitionDeferred:!0})},[n(parseInt,String,f.TypeSignature("where")),r(n(parseInt,String,f.TypeSignature("where"))),r(String)])("link-undo",function(e){if(!e)return h.create("datatype",m[0])},function(t,e,n){var r,a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"";return l.pastLength<1?g(t,{source:a}):(r=(t.data.section=e).stackTop.tempVariables,t.data.forgetUndosEvent=function(){return t.data.section.whenUnblocked(function(){var e=_objectSpread(_objectSpread({},t),{},{append:"replace",source:a,transitionDeferred:!1});t.section.renderInto("",null,e,r)})},g(t,{source:"<tw-link tabindex=0 undo>"+n+"</tw-link>",transitionDeferred:!0}))},[String,r(String)])("link-show",function(e){if(!e)return h.create("datatype",m[0])},function(r,a,e){for(var t=arguments.length,n=new Array(3<t?t-3:0),o=3;o<t;o++)n[o-3]=arguments[o];return r.data.section=a,r.data.clickEvent=function(e){e.contents().unwrap(),n.forEach(function(e){return e.forEach(a,function(e){var t=e.data("originalSource")||"",n=e.data("hidden");n&&(e.removeData("hidden"),n instanceof i?e.empty().append(n):(n=e.data("tempVariables"),a.renderInto("",null,_objectSpread(_objectSpread({},r),{},{source:t,target:e,transitionDeferred:!1}),n&&Object.create(n))))})})},g(r,{source:"<tw-link tabindex=0>"+e+"</tw-link>",transitionDeferred:!0})},[String,o(t)])("link-fullscreen",function(e,t){if(!e||!t)return h.create("datatype",m[0])},function(t,e,n,r){function a(){return document.fullscreenEnabled||document.msFullscreenEnabled?"<tw-link tabindex=0 fullscreen>"+(document.fullscreenElement||document.msFullscreenElement?r:n)+"</tw-link>":r?"<tw-broken-link>"+r+"</tw-broken-link>":""}var o=e.stackTop.tempVariables;return t.data.section=e,t.data.fullscreenEvent=function(){(document.fullscreenEnabled||document.msFullscreenEnabled)&&t.data.section.whenUnblocked(function(){var e=_objectSpread(_objectSpread({},t),{},{append:"replace",source:a(),transitionDeferred:!1});t.section.renderInto("",null,e,o)})},g(t,{source:a(),transitionDeferred:!0})},[String,String,r(String)]),e.addChanger(["link-reveal-goto"],function(e,t,n,r){if(!t)return h.create.apply(h,["datatype"].concat(m));if(a.isPrototypeOf(n)){if(a.isPrototypeOf(r))return h.create("datatype","You mustn't give two changers to (link-reveal-goto:)");r=n,n=void 0}return r&&!r.canEnchant?h.create("datatype","The changer given to (link-reveal-goto:) can't include a revision, enchantment, or interaction changer like (replace:), (click:), or (link:)."):(t=(e=s(e,t,n)).text,n=e.passage,e.error||a.create("link-reveal-goto",[t,n,r].filter(function(e){return void 0!==e}),null,!1))},function(t,e,n,r){var a,o,i,s;if(u.hasValid(n))return o=l.passageNameVisited(n),i=null!=(a=t.section)&&a.stackTop?t.section.stackTop.tempVariables:Object.create(null),s=d.create({source:"<tw-link tabindex=0 "+(0<o?'class="visited" ':"")+">"+e+"</tw-link>",target:t.target,append:"replace",data:{section:t.section,append:"replace",clickEvent:function(e){t.enablers=t.enablers.filter(function(e){return e.descriptor!==s}),e.contents().unwrap(),t.section.renderInto("",null,t,i),t.section.whenUnblocked(function(){return p.goToPassage(n,{transition:t.data.passageT8n})})}}}),t.enablers=(t.enablers||[]).concat({descriptor:s,changer:r}),t;t.source='<tw-broken-link passage-name="'+c.escape(n)+'">'+e+"</tw-broken-link>"},[String,r(n(a,String)),r(a)])}),define("macrolib/metadata",["macros","utils/operationutils","datatypes/lambda","internaltypes/twineerror"],function(t,e,n,s){function c(e){return{TwineScript_TypeName:"a ("+e+":) macro",TwineScript_ObjectName:"a ("+e+":) macro",TwineScript_Unstorable:!0,TwineScript_Print:function(){return""}}}var l=e.clone,u=e.objectName,p=e.isValidDatamapName,e=t.TypeSignature,r=e.zeroOrMore,e=e.Any;[["storylet",n.TypeSignature("when")],["urgency",Number],["exclusivity",Number]].forEach(function(e){var e=_slicedToArray(e,2),n=e[0],e=e[1];t.add(n,"Metadata",function(e,t){return e.stackTop.speculativePassage?t:c(n)},e)}),t.add("metadata","Metadata",function(e){for(var r,a=new Map,t=arguments.length,n=new Array(1<t?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];var i=n.reduce(function(e,t){var n;if(!s.containsError(e))if(void 0===r)r=t;else{if(n=s.containsError(p(a,r)))return n;if(a.has(r))return s.create("macrocall","You used the same data name ("+u(r)+") twice in the same (metadata:) call.");a.set(r,l(t)),r=void 0}return e},!0);return s.containsError(i)?i:void 0!==r?s.create("macrocall","This (metadata:) macro has a data name without a value."):e.stackTop.speculativePassage?a:c("metadata")},r(e))}),define("macrolib/patterns",["macros","utils","utils/operationutils","datatypes/lambda","datatypes/datatype","datatypes/typedvar","internaltypes/twineerror","internaltypes/varscope"],function(e,t,n,y,b,h,v,w){function k(e){var r,t,a=e.name,n=e.fullArgs,o=e.args,i=e.makeRegExpString,s=void 0===i?function(e){return e.join("")}:i,c=void 0!==(i=e.insensitive)&&i,l=void 0===(i=e.canContainTypedVars)||i,u=void 0===(i=e.canBeUsedAlone)||i,p=void 0===(i=e.canContainTypedGlobals)||i,d=o||n,f=E(null),e=d.map(function e(t){if(h.isPrototypeOf(t)){var n=t.varRef;if(!l)return v.create("operation","Optional string patterns, like (".concat(a,":)").concat("p-many"===a?" with a minimum of 0 matches":"",", can't have typed variables inside them."));if(!p&&!w.isPrototypeOf(n.object))return v.create("operation","Only typed temp variables can be used in patterns given to (".concat(a,":)"));n=n.getName();if(n in f)return v.create("operation","There's already a typed temp variable named _".concat(n," inside this (").concat(a,":) call."));f[n]=!0;n=e(t.datatype);return v.containsError(n)?n:"("+n+")"}if(b.isPrototypeOf(t)){if(!(l&&p||"function"!=typeof t.typedVars)){n=t.typedVars();if(!l&&n.length)return v.create("operation","(".concat(a,":) can't have typed variables inside its pattern."));if(!p&&n.some(function(e){return!w.isPrototypeOf(e.varRef.object)}))return v.create("operation","Only typed temp variables can be used in patterns given to (".concat(a,":)"))}var r;return t.regExp?(t.rest?"(?:":"")+(c?t.insensitive():t).regExp+(t.rest?")*":""):(n=t.name,r=t.rest?"*":"","alnum"===n?m+r:"whitespace"===n?_+r:"uppercase"===n?(c?T:g)+r:"lowercase"===n?(c?T:S)+r:"anycase"===n?T+r:"digit"===n?"\\d"+r:"linebreak"===n?"(?:\\r|\\n|\\r\\n)"+r:"str"===n?".*?":["even","odd","int","num"].includes(n)?v.create("datatype","Please use string datatypes like 'digit' in (".concat(a,":) instead of number datatypes.")):v.create("datatype","The (".concat(a,":) macro must only be given string-related datatypes, not ").concat(O(t),".")))}return"string"==typeof t?(t=t.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&"),c?t.replace(RegExp("(".concat(g,"|").concat(S,")"),"g"),function(e){return"["+e.toUpperCase()+e.toLowerCase()+"]"}):t):(x("createPattern","mapper() was given a non-string non-datatype "+t),"")});return(i=v.containsError(e))||(r=s(e),t=C(E(b),{name:a,regExp:r,insensitive:function(){return c?t:k({name:a,fullArgs:n,args:d.map(function(e){return b.isPrototypeOf(e)&&"function"==typeof e.insensitive?e.insensitive():e}),makeRegExpString:s,insensitive:!0,canContainTypedVars:l,canBeUsedAlone:u})},typedVars:function(){return d.reduce(function(e,t){return h.isPrototypeOf(t)&&(e=e.concat(c?h.create(k({name:"p-ins",fullArgs:[t.datatype],insensitive:!0}),t.varRef):t),t=t.datatype),e=b.isPrototypeOf(t)&&"function"==typeof t.typedVars?e.concat(t.typedVars()):e},[])},destructure:function(e){var n,t;return"string"!=typeof e?[v.create("operation","I can't put ".concat(O(e)," into ").concat(this.TwineScript_ToSource()," because it isn't a string."))]:(n=this.typedVars()).length?(t=(RegExp("^"+(this.rest?"(?:":"")+r+(this.rest?")*":"")+"$").exec(e)||[]).slice(1)).length?t.map(function(e,t){t=n[t];if(t)return t.datatype.rest&&!t.datatype.regExp&&((t=t.TwineScript_Clone()).datatype=k({name:"p",fullArgs:[t.datatype]})),{dest:t,value:e||"",src:void 0}}).filter(Boolean):[v.create("operation","I can't put ".concat(O(e)," because it doesn't match the pattern ").concat(this.TwineScript_ToSource(),"."))]:[]},TwineScript_IsTypeOf:function(e){return u?"string"==typeof e&&!!e.match("^"+(this.rest?"(?:":"")+r+(this.rest?")*":"")+"$"):v.create("operation","A (".concat(a,":) datatype must only be used with a (p:) macro."))},TwineScript_toTypeSignatureObject:function(){var t=this;return{pattern:"range",name:a,range:function(e){return t.TwineScript_IsTypeOf(e)}}},TwineScript_ToSource:function(){return(this.rest?"...":"")+"("+a+":"+n.map(A)+")"}}),Object.defineProperty(t,"TwineScript_ObjectName",{get:function(){return"a (".concat(a,":) datatype")}}),t)}var m=t.anyRealLetter,g=t.anyUppercase,S=t.anyLowercase,T=t.anyCasedLetter,_=t.realWhitespace,x=t.impossible,O=n.objectName,A=n.toSource,t=e.TypeSignature,n=t.rest,r=t.either,a=t.optional,t=t.nonNegativeInteger,C=Object.assign,E=Object.create,o=n(r(String,b,h));e.add(["p","pattern"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p",fullArgs:n})},o)(["p-either","pattern-either"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-either",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"(?:"+e.join("|")+")"}})},o)(["p-opt","pattern-opt","p-optional","pattern-optional"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-opt",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"(?:"+e.join("")+")?"}})},o)(["p-not","pattern-not"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.find(function(e){return"string"==typeof e?1!==_toConsumableArray(e).length:e.rest||e.regExp||["str","empty"].includes(e.name)})?v.create("datatype","(p-not:) should only be given single characters, or datatypes that match single characters"):k({name:"p-not",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"[^"+e.map(function(e){return e.startsWith("[")&&e.endsWith("]")?e.slice(1,-1):e}).join("")+"]"}})},o)(["p-not-before","pattern-not-before"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-not-before",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"(?!"+e.join("")+")"}})},o)(["p-before","pattern-before"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-before",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"(?="+e.join("")+")"}})},o)(["p-start","pattern-start"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-start",fullArgs:n,makeRegExpString:function(e){return"^(?:"+e.join("")+")"}})},o)(["p-end","pattern-end"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-end",fullArgs:n,makeRegExpString:function(e){return"(?:"+e.join("")+")$"}})},o)(["p-many","pattern-many"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a,o,i,s=n.slice();return"number"==typeof n[0]&&(a=n.shift(),o="number"==typeof n[0]?n.shift():1/0),!(void 0!==o&&o<a)&&n.length?(i=n.find(function(e){return"string"!=typeof e&&!b.isPrototypeOf(e)&&!h.isPrototypeOf(e)}))?v.create("datatype","This (p-many:) macro can only be given a min and max number followed by datatypes or strings, but was also given "+O(i)+"."):k({name:"p-many",args:n,fullArgs:s,canContainTypedVars:0<a,makeRegExpString:function(e){return"(?:"+e.join("")+")"+(void 0!==a?"{"+a+(o===1/0?",":o!==a?","+o:"")+"}":"+")}}):v.create("datatype","The (p-many:) macro needs to be given string patterns, not just min and max numbers.")},[n(r(t,String,b,h))])(["p-ins","pattern-ins","p-insensitive","pattern-insensitive"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-ins",fullArgs:n,insensitive:!0})},o)(["split","splitted"],"Array",function(e,t,n){if(t=k({name:"split",fullArgs:[t],canContainTypedVars:!1}),v.containsError(t))return t;if(!n)return[""];if(!t.regExp)return _toConsumableArray(n);for(var r,a=RegExp(t.regExp),o=[];n&&(r=a.exec(n));){if(r.index+r[0].length===0)return o;o.push(n.slice(0,r.index)),n=n.slice(r.index+r[0].length)}return o.concat(n||[])},[r(String,b),String])("trimmed","String",function(e,t,n){return void 0===n||b.isPrototypeOf(t)&&"whitespace"===t.name?t.trim():(t=k({name:"trimmed",fullArgs:[t],canContainTypedVars:!1}),v.containsError(t)?t:t.regExp?n.replace(RegExp("^("+t.regExp+")*|("+t.regExp+")*$","g"),""):n)},[r(String,b),a(String)])(["str-find","string-find"],"String",function(e,t,n){if(t=k({name:"str-find",fullArgs:[t],canContainTypedGlobals:!1}),v.containsError(t))return t;for(var r,a=t.typedVars(),o=RegExp(t.regExp,"g"),i=[],s=o.lastIndex;(r=o.exec(n))&&s!==o.lastIndex;)if(s=o.lastIndex,a.length){for(var c=new Map,l=0;l<a.length;l+=1){if("match"===a[l].varRef.getName())return v.create("macrocall","There was a typed temp variable named _match in the pattern given to (str-find:)","The variable _match is reserved, and can't be used inside (str-find:)'s pattern.");c.set(a[l].varRef.getName(),r[l+1]),c.set("match",r[0])}i.push(c)}else i.push(r[0]);return i},[b,String])(["str-replaced","string-replaced","replaced"],"String",function(e,t,n,r,a){if("number"!=typeof t){if(void 0!==a)return v.create("macrocall","1 too many values were given to (str-replaced:).","If this is given 5 values, the first value must be a number of replacements.");a=r,r=n,n=t,t=1/0}else if(void 0===a)return v.create("macrocall","The (str-replaced:) macro needs 1 more value.","The final string seems to be missing.");if(b.isPrototypeOf(r))return v.create("datatype","The replacement value for (str-replaced:) must be a string or lambda, not ".concat(O(r)));if(y.isPrototypeOf(a)||y.isPrototypeOf(n))return v.create("datatype","The ".concat(y.isPrototypeOf(a)?"final string":"search pattern"," given to (str-replaced:) can't be a lambda."),"Only the replacement value (after the search pattern) can be a 'via' lambda.");if(n=k({name:"str-replaced",fullArgs:[n],canContainTypedGlobals:!1}),v.containsError(n))return n;if(!n.regExp)return a;for(var o,i=RegExp(n.regExp,"g"),s=y.isPrototypeOf(r)?n.typedVars():[],c=1,l=0,u="",p=i.lastIndex;a&&(o=i.exec(a))&&0<t&&p!==i.lastIndex;){for(var p=i.lastIndex,d=Object.create(e.stack.length?e.stackTop.tempVariables:w),f=0;f<s.length;f+=1){var h=s[f],m=h.varRef.create(d,h.varRef.propertyChain);if(v.containsError(m))return m;h=m.defineType(h.datatype);if(v.containsError(h))return h;m.set(o[f+1])}var g=y.isPrototypeOf(r)?r.apply(e,{loop:o[0],pos:c,tempVariables:d}):r;if(v.containsError(g))return g;if("string"!=typeof g)return v.create("datatype","(str-replaced:)'s lambda must produce a string, but it produced ".concat(O(g),' when given "').concat(o[0],'".'));u+=a.slice(l,o.index)+g,c+=1,--t,l=o.index+o[0].length}return u+=a.slice(l)},[r(t,String,b),r(b,String,y.TypeSignature("via")),r(String,y.TypeSignature("via")),a(String)])}),define("macrolib/stylechangers",["jquery","macros","utils","utils/renderutils","datatypes/colour","datatypes/hookset","datatypes/gradient","datatypes/changercommand","datatypes/lambda","internaltypes/changedescriptor","internaltypes/twineerror"],function(s,e,c,t,a,n,r,o,i,l,u){var p,d,f=t.geomParse,h=t.geomStringRegExp,m=Object.assign,t=e.TypeSignature,g=t.either,y=t.wrapped,b=t.optional,v=t.Any,w=t.Everything,k=t.zeroOrMore,S=t.rest,T=t.insensitiveSet,_=t.positiveNumber,x=t.positiveInteger,O=t.nonNegativeNumber,t=t.percent,y=[y(Boolean,'If you gave a number, you may instead want to check that the number is not 0. If you gave a string, you may instead want to check that the string is not "".')],A=(c.onStartup(function(){return c.storyElement.on("mouseenter.hover-macro","[hover=false]",function(){var e=s(this),t=e.data("hoverChanger");c.options.debug&&c.options.ignoreClickEvents&&!e.is("tw-backdrop.eval-replay *, tw-backdrop.harlowe-crash *")||(e.data({mouseoutStyle:e.attr("style")||""}),l.create({target:e},t).update(),e.attr("hover",!0))}).on("mouseleave.hover-macro","[hover=true]",function(){var e=s(this),t=e.data("mouseoutStyle");e.attr("style",t).removeData("mouseoutStyle").attr("hover",!1)})}),u.on(function(){s("tw-expression, tw-hook",c.storyElement).each(function(e,t){((t=s(t)).data("errorEvent")||Object)(t)})}),T("instant","dissolve","fade","rumble","shudder","pulse","zoom","flicker","slideleft","slideright","slideup","slidedown","fadeleft","faderight","fadeup","fadedown","blur")),C=T("dotted","dashed","solid","double","groove","ridge","inset","outset","none");e.addChanger("if",function(e,t){return o.create("if",[t])},function(e,t){return e.enabled=e.enabled&&t},y)("unless",function(e,t){return o.create("unless",[t])},function(e,t){return e.enabled=e.enabled&&!t},y)("elseif",function(e,t){return"lastHookShown"in e.stack[0]?o.create("elseif",[!1===e.stack[0].lastHookShown&&!!t]):u.create("macrocall","There's no (if:) or something else before this to do (else-if:) with.")},function(e,t){return e.enabled=e.enabled&&t},y)("else",function(e){return"lastHookShown"in e.stack[0]?o.create("else",[!1===e.stack[0].lastHookShown]):u.create("macrocall","There's nothing before this to do (else:) with.")},function(e,t){return e.enabled=e.enabled&&t},null)("hidden",function(){return o.create("hidden")},function(e){return e.enabled=!1},null)(["verbatim","v6m"],function(){return o.create("verbatim")},function(e){return e.verbatim=!0},null)("live",function(e,t){return o.create("live",t?[t]:[])},function(e,t){e.enabled=!1,e.transitionDeferred=!0,e.data.live={delay:t}},b(Number))("event",function(e,t){return o.create("event",[t])},function(e,t){e.enabled=!1,e.transitionDeferred=!0,e.data.live={event:t}},i.TypeSignature("when"))("more",function(){return o.create("more")},function(e){e.enabled=!1,e.transitionDeferred=!0,e.data.live={event:{when:!0,filter:function(e){return 0!==e.Identifiers.exits?[]:[!0]}}}},null)("after",function(e,t,n){return o.create("after",[t].concat(void 0!==n?[n]:[]))},function(e,t,n){e.enabled=!1,e.transitionDeferred=!0,e.data.live={event:{when:!0,filter:function(e){return c.anyInputDown()&&n&&(t-=n),e.Identifiers.time>t?[!0]:[]}}}},[_,b(O)])("after-error",function(){return o.create("after-error",[])},function(n){n.enabled=!1,n.transitionDeferred=!0;var r=n.section.stackTop.tempVariables;n.data.errorEvent=function(e){e.removeData("errorEvent");var t=_objectSpread(_objectSpread({},n),{},{enabled:!0,transitionDeferred:!1});t.data&&(t.data.errorEvent=void 0),n.section.whenUnblocked(function(){return n.section.renderInto("",null,t,r)})}},[])("hook",function(e,t){var n;return t?(n=c.insensitiveName(t))?o.create("hook",[n]):u.create("datatype",'The string given to (hook:), "'.concat(t,'", contained only dashes and underscores.')):u.create("datatype","The string given to (hook:) was empty.")},function(e,t){return e.attr.push({name:t})},[String])(["for","loop"],function(e,t){if(!t.loop)return u.create("datatype","The lambda provided to (for:) must refer to a temp variable, not just 'it'.");for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return o.create("for",[t].concat(r))},function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];var o,i=t.filter(e.section,r);if(o=u.containsError(i))return o;e.loopVars[t.loop.getName()]=i||[]},[i.TypeSignature("where"),k(v)])(["transition","t8n"],function(e,t){return o.create("transition",[c.insensitiveName(t)])},function(e,t){return"zoom"===(e.transition=t)&&(e.transitionOrigin=function(){var e=s(this).offset(),t=e.left,e=e.top;return c.mouseCoords.x-t+"px "+(c.mouseCoords.y-e)+"px"}),e},[A])(["transition-time","t8n-time"],function(e,t){return o.create("transition-time",[t])},function(e,t){return e.transitionTime=t,e.data.passageT8n=m(e.data.passageT8n||{},{time:t}),e},[_])(["transition-delay","t8n-delay"],function(e,t){return o.create("transition-delay",[t])},function(e,t){return e.transitionDelay=t,e},[O])(["transition-skip","t8n-skip"],function(e,t){return o.create("transition-skip",[t])},function(e,t){return e.transitionSkip=t,e},[_])(["transition-depart","t8n-depart"],function(e,t){return o.create("transition-depart",[c.insensitiveName(t)])},function(e,t){return e.data.passageT8n=m(e.data.passageT8n||{},{depart:t}),"zoom"===t&&(e.data.passageT8n.departOrigin=function(){var e=s(this).offset(),t=e.left,e=e.top;return c.mouseCoords.x-t+"px "+(c.mouseCoords.y-e)+"px"}),e},[A])(["transition-arrive","t8n-arrive"],function(e,t){return o.create("transition-arrive",[c.insensitiveName(t)])},function(e,t){return e.data.passageT8n=m(e.data.passageT8n||{},{arrive:t}),"zoom"===t&&(e.data.passageT8n.arriveOrigin=function(){var e=s(this),t=e.offset(),n=t.left,t=t.top,r=e.height();return{"transform-origin":100*(c.mouseCoords.x-n)/e.width()+"% "+100*(c.mouseCoords.y-t)/r+"%",height:r+"px"}}),e},[A])("button",function(e,t){return void 0===t||f(t).size?o.create("button",t?[t]:[]):u.create("datatype",'The string given to (button:) should be a sizing line ("==X==", "==X", "=XXXX=" etc.), not '.concat(JSON.stringify(t),"."))},function(e,t){var t=f(t),n=t.marginLeft,t=t.size;return e.attr.push({class:function(){return this.className+(this.classList.contains("enchantment-button")?"":" ".repeat(0<this.className.length)+"enchantment-button")}}),e.styles.push({"margin-left":t?n+"%":void 0,width:t?t+"%":"100%"}),e},[b(String)]).apply(void 0,_toConsumableArray((d={click:{className:"enchantment-link",blockClassName:"enchantment-clickblock"},doubleclick:{className:"enchantment-dblclick",blockClassName:"enchantment-dblclickblock"},mouseover:{className:"enchantment-mouseover",blockClassName:"enchantment-mouseoverblock"},mouseout:{className:"enchantment-mouseout",blockClassName:"enchantment-mouseoutblock"}},["action",function(e,t){return o.create("action",[c.insensitiveName(t)])},function(e,t){return e.attr.push({class:function(){var e=function e(t){return(t=s(t)).is("tw-story, tw-sidebar, tw-passage")||["block","flex"].includes(t.css("display"))||t.children().get().some(e)}(this);return Array.from(this.classList).filter(function(t){return!Object.keys(d).some(function(e){return d[e].className===t||d[e].blockClassName===t})}).concat(d[t][e?"blockClassName":"className"]).join(" ")}}),e},[T.apply(void 0,_toConsumableArray(Object.keys(d)))]])))(["border","b4r"],function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return o.create("border",n.map(c.insensitiveName))},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return e.styles.push({display:function(){var e=s(this).css("display");return n.every(function(e){return"none"===e})||!e.includes("inline")?e:"inline-block"},"border-style":n.join(" "),"border-width":function(){return this.style.borderWidth||"2px"}}),e},[C].concat(_toConsumableArray(Array(3).fill(b(C)))))(["border-size","b4r-size"],function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return o.create("border-size",n)},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return e.styles.push({"border-width":n.map(function(e){return e+"px"}).join(" ")}),e},[O].concat(_toConsumableArray(Array(3).fill(b(O)))))("corner-radius",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return o.create("corner-radius",n)},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return e.styles.push({"border-radius":n.map(function(e){return e+"px"}).join(" "),padding:function(){return this.style.padding||n.map(function(e){return e+"px"}).join(" ")}}),e},[O].concat(_toConsumableArray(Array(3).fill(b(O)))))(["border-colour","b4r-colour","border-color","b4r-color"],function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return o.create("border-colour",n.map(function(e){return a.isPrototypeOf(e)?e.toRGBAString(e):e}))},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return e.styles.push({"border-color":n.join(" ")}),e},[g(String,a)].concat(_toConsumableArray(Array(3).fill(b(g(String,a))))))("opacity",function(e,t){return o.create("opacity",[t])},function(e,t){return e.styles.push({opacity:t})},[t])("font",function(e,t){return o.create("font",[t])},function(e,t){return e.styles.push({"font-family":t}),e},[String])("align",function(e,t){var n=t.indexOf("><");return/^(==+>|<=+|=+><=+|<==+>)$/.test(t)?((n=~n?_objectSpread({"text-align":"center","max-width":"50%"},25===(n=Math.round(n/(t.length-2)*50))?{"margin-left":"auto","margin-right":"auto"}:{"margin-left":n+"%"}):"<"===t[0]&&">"===t.slice(-1)?{"text-align":"justify","max-width":"50%"}:t.includes(">")?{"text-align":"right"}:{"text-align":"left"}).display="block",o.create("align",[n])):u.create("datatype",'The (align:) macro requires an alignment arrow ("==>", "<==", "==><=" etc.) be provided, not "'+t+'"')},function(e,t){e.styles.push(t)},[String])(["text-colour","text-color","color","colour"],function(e,t){return o.create("text-colour",[t])},function(e,t){return a.isPrototypeOf(t)&&(t=t.toRGBAString(t)),e.styles.push({color:t}),e},[g(String,a)])(["text-size","size"],function(e,t){return o.create("text-size",[t])},function(e,t){return e.styles.push({"font-size":24*t+"px","line-height":36*t+"px"}),e},[O])("text-indent",function(e,t){return o.create("text-indent",[t])},function(e,t){return e.styles.push({"text-indent":t+"px",display:"inline-block"}),e},[O])(["text-rotate-z","text-rotate"],function(e,t){return o.create("text-rotate-z",[t])},function(e,t){return e.styles.push({display:"inline-block",transform:function(){var e=s(this).css("transform")||"";return(e="none"===e?"":e)+" rotate("+t+"deg)"}}),e},[Number])("text-rotate-y",function(e,t){return o.create("text-rotate-y",[t])},function(e,t){return e.styles.push({display:"inline-block",transform:function(){var e=s(this).css("transform")||"";return(e="none"===e?"":e)+" perspective(50vw) rotateY("+t+"deg)"}}),e},[Number])("text-rotate-x",function(e,t){return o.create("text-rotate-x",[t])},function(e,t){return e.styles.push({display:"inline-block",transform:function(){var e=s(this).css("transform")||"";return(e="none"===e?"":e)+" perspective(50vw) rotateX("+t+"deg)"}}),e},[Number])(["background","bg"],function(e,t){return o.create("background",[t])},function(e,t){return a.isPrototypeOf(t)?t=t.toRGBAString():r.isPrototypeOf(t)&&(t=t.toLinearGradientString()),t=a.isHexString(t)||a.isCSS3Function(t)?{"background-color":t}:t.startsWith("linear-gradient(")||t.startsWith("repeating-linear-gradient(")?{"background-image":t}:{"background-size":"cover","background-image":"url(".concat(t,")"),"background-attachment":"fixed"},e.styles.push(t,{display:function(){var e=s(this);return!e.children().length||c.childrenProbablyInline(e)?s(this).css("display"):"block"}}),e},[g(String,a,r)]).apply(void 0,_toConsumableArray((y={color:function(){return"transparent"}},p=m(Object.create(null),{none:{},bold:{"font-weight":"bold"},italic:{"font-style":"italic"},underline:{"text-decoration":"underline"},doubleunderline:{"text-decoration":"underline","text-decoration-style":"double"},wavyunderline:{"text-decoration":"underline","text-decoration-style":"wavy"},strike:{"text-decoration":"line-through"},doublestrike:{"text-decoration":"line-through","text-decoration-style":"double"},wavystrike:{"text-decoration":"line-through","text-decoration-style":"wavy"},superscript:{"vertical-align":"super","font-size":".83em"},subscript:{"vertical-align":"sub","font-size":".83em"},blink:{animation:"fade-in-out 1s steps(1,end) infinite alternate"},shudder:{animation:"shudder linear 0.1s 0s infinite"},mark:{"background-color":"hsla(60, 100%, 50%, 0.6)"},condense:{"letter-spacing":"-0.08em"},expand:{"letter-spacing":"0.1em"},outline:[{"text-shadow":function(){var e=s(this).css("color");return"-1px -1px 0 "+e+", 1px -1px 0 "+e+",-1px  1px 0 "+e+", 1px  1px 0 "+e}},{color:function(){return c.parentColours(s(this)).backgroundColour}}],shadow:{"text-shadow":function(){return"0.08em 0.08em 0.08em "+s(this).css("color")}},emboss:{"text-shadow":function(){return"0.04em 0.04em 0em "+s(this).css("color")}},smear:[{"text-shadow":function(){var e=s(this).css("color");return"0em   0em 0.02em "+e+",-0.2em 0em  0.5em "+e+", 0.2em 0em  0.5em "+e}},y],blur:[{"text-shadow":function(){return"0em 0em 0.08em "+s(this).css("color")}},y],blurrier:[{"text-shadow":function(){return"0em 0em 0.2em "+s(this).css("color")},"user-select":"none"},y],mirror:{display:"inline-block",transform:"scaleX(-1)"},upsidedown:{display:"inline-block",transform:"scaleY(-1)"},tall:{display:"inline-block",transform:"scaleY(1.5) translateY(-0.25ex)"},flat:{display:"inline-block",transform:"scaleY(0.5) translateY(0.25ex)"},fadeinout:{animation:"fade-in-out 2s ease-in-out infinite alternate"},rumble:{animation:"rumble linear 0.1s 0s infinite"},sway:{animation:"sway linear 2.5s 0s infinite"},buoy:{animation:"buoy linear 2.5s 0s infinite"},fidget:{animation:function(){return"fidget step-end 60s "+60*-Math.random()+"s infinite"+(Math.random()<.5?" reverse":"")}}}),["text-style",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return o.create("text-style",n.map(c.insensitiveName))},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=0;a<n.length;a+=1)"none"===n[a]?e.styles=[]:e.styles=e.styles.concat(p[n[a]]);return e},[S(T.apply(void 0,_toConsumableArray(Object.keys(p))))]])))("collapse",function(){return o.create("collapse")},function(e){return e.attr.push({collapsing:!0}),e},[])("hover-style",function(e,t){var n=l.create(),r=(t.run(n),n.summary());return r+""=="styles"||r.every(function(e){return"styles"===e||"attr"===e})&&n.attr.every(function(e){return Object.keys(e)+""=="style"})?o.create("hover-style",[t]):u.create("datatype","The changer given to (hover-style:) must only change the hook's style.")},function(e,t){return e.data.hoverChanger=t,e.attr.push({hover:function(e,t){return void 0!==t&&t}}),e},[o])("css",function(e,t){return t.trim().endsWith(";")||(t+=";"),o.create("css",[t])},function(e,t){return e.attr.push({style:function(){return(s(this).attr("style")||"")+t}}),e},[String])("test-true",function(){return o.create("test-true",[])},function(e){return e.enabled=!0},k(w))("test-false",function(){return o.create("test-false",[])},function(e){return e.enabled=!1},k(w)),e.addCommand("animate",s.noop,function(r,e,t,a,o){t.forEach(e,function(e){var t,n;"zoom"===name&&(n=(t=e.offset()).left,t=t.top,n=c.mouseCoords.x-n+"px "+(c.mouseCoords.y-t)+"px"),c.transitionIn(e,a,r.transitionTime||o,r.transitionDelay,r.transitionSkip,0,n)})},[S(n),T.apply(void 0,_toConsumableArray(A.innerType.filter(function(e){return"instant"!==e}))),b(_)]),["box","float-box"].forEach(function(i){return e.addChanger(i,function(e,t,n){var r=-1===t.search(h)||1<t.length&&!t.includes("="),a="float-box"===i&&(-1===n.search(h)||1<n.length&&!n.includes("="));return r||a?u.create("datatype","The ("+i+':) macro requires a sizing line("==X==", "==X", "=XXXX=" etc.) be provided, not "'+(r?t:n)+'".'):o.create(i,[t,n].filter(function(e){return void 0!==e}))},function(e,t,n){var r,t=f(t),a=t.marginLeft,t=t.size,o=("float-box"===i&&(r=(o=f(n)).marginLeft,n=o.size),"box"===i?"%":"vw"),t=_defineProperty(_defineProperty(_defineProperty({display:"block",width:t+o,"max-width":t+o},"box"===i?"margin-left":"left",a+o),"overflow-y","auto"),"padding",function(){var e=s(this).css("padding");return e&&"0px"!==e?e:"1em"});return void 0!==n&&(t.height="box"===i?1.5*n+2+"em":n+"vh"),"float-box"===i&&m(t,{position:"fixed",top:r+"vh","background-color":function(){return c.parentColours(s(this)).backgroundColour}}),e.styles.push(t),e},[String,"box"===i?b(x):String])})}),define("macrolib/values",["macros","state","utils","utils/operationutils","datatypes/colour","datatypes/gradient","datatypes/datatype","datatypes/hookset","datatypes/codehook","internaltypes/twineerror"],function(t,r,e,n,l,c,a,o,i,f){var s=e.realWhitespace,u=e.nth,p=e.anyRealLetter,d=e.plural,h=n.subset,m=n.objectName,g=n.clone,y=n.toSource,e=t.TypeSignature,n=e.rest,b=e.zeroOrMore,v=e.either,w=e.optional,k=e.insensitiveSet,S=e.numberRange,T=e.percent,_=e.nonNegativeInteger,x=e.positiveInteger,e=e.Any,O=Math.max,A=Math.min,C=Math.round,E=Math.floor,N=Math.ceil;function j(t){return function(){var e=t.apply(void 0,arguments);return"number"!=typeof e||isNaN(e)?f.create("macrocall","This mathematical expression doesn't compute!"):e}}t.add(["str","string","text"],"String",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.map(function(e){return i.isPrototypeOf(e)?e.source:e}).join("")},[b(t.TypeSignature.either(String,Number,Boolean,Array,i))])("source","String",function(e,t){return"command"!==(null==t?void 0:t.TwineScript_TypeID)||t.TwineScript_ToSource?y(t):f.create("datatype","I can't construct the source code of a command created by a custom macro.")},[e])("substring","String",function(e,t,n,r){return h(t,n,r)},[String,parseInt,parseInt])("lowercase","String",function(e,t){return t.toLowerCase()},[String])("uppercase","String",function(e,t){return t.toUpperCase()},[String])("lowerfirst","String",function(e,t){return t.replace(RegExp(p+"+"),function(e){return(e=Array.from(e))[0].toLowerCase()+e.slice(1).join("").toLowerCase()})},[String])("upperfirst","String",function(e,t){return t.replace(RegExp(p+"+"),function(e){return(e=Array.from(e))[0].toUpperCase()+e.slice(1).join("").toLowerCase()})},[String])("words","Array",function(e,t){return t.split(RegExp(s+"+")).filter(Boolean)},[String])(["str-repeated","string-repeated"],"String",function(e,t,n){return 0===n.length?f.create("macrocall","I can't repeat an empty string."):n.repeat(t)},[_,String])(["str-reversed","string-reversed"],"String",function(e,t){return _toConsumableArray(t).reverse().join("")},[String])("joined","String",function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return r.join(t)},[n(String)])("plural","String",function(e,t,n,r){return n&&""!==r?d(t,n,r):f.create("macrocall","The (plural:) macro can't be given empty strings.")},[parseInt,String,w(String)])(["str-nth","string-nth"],"String",function(e,t){return u(t)},[parseInt])("digit-format","String",function(e,t,n){if(1e21<=Math.abs(n))return f.create("macrocall","The number given to (digit-format:) is too big.");for(var r=/([^#0])(?=[#0]*$)/g,a=(r.exec(t)||[])[1],o=(/^[#0]*([^#0])/g.exec(t)||[])[1],i=(t=_toConsumableArray(t)).length,s=(a&&(","!==a||o&&","!==o)&&(i=r.lastIndex-1),Math.abs(n).toFixed(16).replace(/(\.\d*?)0+$/,function(e,t){return t}).replace(/^0+/,"")),c=s.includes(".")?s.indexOf("."):s.length,l=0,u="",p=t.length-1;0<=p;--p){var d=t[p];"0"===d||"#"===d?u=(s[c-i+p+l]||("0"===d?"0":""))+u:p<t.length-1&&0<p&&(u=d+u,l+=p===i?0:1)}return(n<0?"-":"")+u},[String,Number])(["num","number"],"Number",function(e,t){return Number.isNaN(+t)?f.create("macrocall","I couldn't convert "+m(t)+" to a number."):+t},[String])("datatype","Datatype",function(e,t){return a.from(t)},[e])("datapattern","Any",function(e,t){return function n(e){var r;return Array.isArray(e)?r=e.map(n):e instanceof Map?(r=new Map,_toConsumableArray(e).forEach(function(e){var e=_slicedToArray(e,2),t=e[0],e=e[1];return r.set(t,n(e))})):r=a.from(e),(e=f.containsError(r))||r}(t)},[e])(["rgb","rgba"],"Colour",function(e){return l.create({r:arguments.length<=1?void 0:arguments[1],g:arguments.length<=2?void 0:arguments[2],b:arguments.length<=3?void 0:arguments[3],a:arguments.length<=4?void 0:arguments[4]})},[S(0,255),S(0,255),S(0,255),w(T)])(["hsl","hsla"],"Colour",function(e,t,n,r,a){return(t=C(t)%360)<0&&(t+=360),l.create({h:t,s:n,l:r,a:a})},[Number,T,T,w(T)])(["lch","lcha"],"Colour",function(e,t,n,r,a){return(r=C(r)%360)<0&&(r+=360),l.create({l:t,c:n,h:r,a:a})},[T,S(0,132),Number,w(T)])("complement","Colour",function(e,t){return t.LCHRotate(180)},[l])("mix","Colour",function(e,t,n,r,a){n=n.toLCHA(),a=a.toLCHA();var o=1,i=(t+r!==1&&(t+r<1&&(o=t+r),t=(i=[t/(t+r),r/(t+r)])[0],r=i[1]),n.c<2||n.l<.01||.99<n.l?n.h=a.h:(a.c<2||a.l<.01||.99<a.l)&&(a.h=n.h),n.l*=n.a,n.c*=n.a,a.l*=a.a,a.c*=a.a,180<a.h-n.h?n.h+=360:a.h-n.h<-180&&(a.h+=360),n.a*t+a.a*r),s=(n.l*t+a.l*r)/i,c=(n.c*t+a.c*r)/i,n=(n.h*t+a.h*r)/i;return l.create({l:s,c:c,h:n,a:i*o})},[T,l,T,l])("palette","Array",function(e,t,n){var r,a=n.toLCHA(),o=a.l,a={l:o<=.75?.75+o/3:.75-3*(1-o),c:80,h:a.h,a:1},i=l.create(a);return a.l+=o<=.75?-.1:.1,a.l<.5&&(a.l*=.5/a.l),r=l.create(a),a.l+=o<=.85?.15:-.15,o=l.create(a),"adjacent"===t?(r=(i=i.LCHRotate(-30)).LCHRotate(30),o=i.LCHRotate(60)):"triad"===t&&(o=i.LCHRotate(180),r=i.LCHRotate(140),i=i.LCHRotate(-140)),[n,i,r,o]},[k("mono","adjacent","triad"),l])("gradient","Gradient",function(e,t){(t=C(t)%360)<0&&(t+=360);for(var n,r,a,o=arguments.length,i=new Array(2<o?o-2:0),s=2;s<o;s++)i[s-2]=arguments[s];return i.length<4?f.create("datatype","(gradient:) must be given at least 2 colour-stop pairs of numbers and colours."):(r=[],a=i.reduce(function(e,t){if(!f.containsError(e))if(void 0===n)n=t;else{if("number"!=typeof n||!l.isPrototypeOf(t))return f.create("datatype","(gradient:) colour-stops should be pairs of numbers and colours, not colours and numbers.");r.push({stop:n,colour:g(t)}),n=void 0}return e},!0),f.containsError(a)?a:void 0!==n?f.create("macrocall","This gradient has a colour-stop percent without a colour."):c.create(t,r))},[Number,n(v(T,l))])("stripes","Gradient",function(e,t,n){(t=C(t)%360)<0&&(t+=360);for(var r=0,a=[],o=arguments.length,i=new Array(3<o?o-3:0),s=3;s<o;s++)i[s-3]=arguments[s];return i.forEach(function(e){a.push({stop:r,colour:g(e)}),r+=n,a.push({stop:r,colour:g(e)})}),c.create(t,a,!0)},[Number,x,l,n(l)])("hooks-named","HookName",function(e,t){return t?o.create({type:"name",data:t}):f.create("datatype","(hooks-named:) can't be given an empty string.")},[String])("cond","Any",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=0;a<n.length;a+=2){var o=n[a];if(a===n.length-1||f.containsError(o))return o;if("boolean"!=typeof o)return f.create("datatype","(cond:)'s "+u(a+1)+" value is "+m(o)+", but should be a boolean.");if(o)return n[a+1]}return f.create("macrocall","An odd number of values must be given to (cond:), not "+n.length,"(cond:) must be given one or more pairs of booleans and values, as well as one final value.")},[Boolean,e,n(e)]);({weekday:[function(){return["Sun","Mon","Tues","Wednes","Thurs","Fri","Satur"][(new Date).getDay()]+"day"},null],monthday:[function(){return(new Date).getDate()},null],currenttime:[function(){var e=new Date,t=e.getHours()<12;return(e.getHours()%12||12)+":"+((e.getMinutes()<10?"0":"")+e.getMinutes())+" "+(t?"A":"P")+"M"},null],currentdate:[function(){return(new Date).toDateString()},null],min:[A,n(Number)],max:[O,n(Number)],abs:[Math.abs,Number],sign:[Math.sign,Number],sin:[Math.sin,Number],cos:[Math.cos,Number],tan:[Math.tan,Number],floor:[E,Number],round:[C,Number],trunc:[function(e){return(0<e?E:N)(e)},Number],ceil:[N,Number],pow:[j(Math.pow),[Number,Number]],exp:[Math.exp,Number],sqrt:[j(Math.sqrt),Number],log:[j(Math.log),Number],log10:[j(Math.log10),Number],log2:[j(Math.log2),Number],random:[function(e,t){var n,t=t?(n=A(e,t),O(e,t)):(n=0,e);return t+=1,~~(r.random()*(t-n))+n},[parseInt,t.TypeSignature.optional(parseInt)]],"":function(){for(var e in this)e&&hasOwnProperty.call(this,e)&&t.add(e,"Number",function(a){return function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return a.apply(void 0,n)}}(this[e][0]),this[e][1])}})[""](),t.add("either","Any",function(e){var t=1+~~(r.random()*(arguments.length<=1?0:arguments.length-1));return t<1||arguments.length<=t?void 0:arguments[t]},n(e))("nth","Any",function(e,t){return t<=0?f.create("datatype","(nth:)'s first value should be a positive whole number, not "+t):(t=(t-1)%(arguments.length<=2?0:arguments.length-2)+2)<2||arguments.length<=t?void 0:arguments[t]},[parseInt,n(e)])}),!function(){var a,k={};function o(e){for(var t in e)this[t]=e[t]}function i(e,t){for(var n,r,a=e.innerText,o=null,i=0,s=i,c=a.length,l=null;i<c;){for(var u=a.slice(i),p=(o&&o.length?o[0]:e).innerMode,d=0,f=p.length;d<f;d+=1){var h=k[p[d]];if(!(h.constraint&&!h.constraint(l)||h.cannotFollowText&&("text"===(null==(w=l)?void 0:w.type)||s<i))&&(h.plainCompare?u.startsWith(h.pattern):h.pattern.test(u))){var m=h.fn(h.plainCompare?h.pattern:h.pattern.exec(u)),g=!1,y=0;if(m.matches){for(;o&&y<o.length;y+=1){var b=o[y],v=b.type,b=b.aka;if(v in m.matches){g=!0;break}b&&(v=b),-1<(null==(b=m.cannotCross)?void 0:b.indexOf(v))&&(y=o.length-1)}if((!o||y>=o.length)&&!m.isFront)continue}s<i&&e.addChild({type:"text",text:a.slice(s,i),innerMode:p});var s=i+=(l=e.addChild(m)).text.length,w=!1;g&&(t&&S(e,l,o[y]),o=o.slice(y+1),w=!0),!w&&l.isFront&&(o?o.unshift(l):o=[l]);break}}d===f&&(i+=1,null===l)&&(l={type:"text"})}for(s<i&&e.addChild({type:"text",text:a.slice(s,i),innerMode:(null!=(n=o)&&n.length?o[0]:e).innerMode});0<(null==(r=o)?void 0:r.length);)o.shift().demote();return e}function S(e,t,n){var r=e.children.indexOf(t),a=e.children.indexOf(n);t.children=e.children.splice(a+1,r-(a+1)),t.type=t.matches[n.type],t.innerText="";for(var o,i=0,s=t.children.length;i<s;i++)t.innerText+=t.children[i].text;for(o in t.start=n.start,t.text=n.text+t.innerText+t.text,n)hasOwnProperty.call(n,o)&&!hasOwnProperty.call(t,o)&&(t[o]=n[o]);t.isFront&&(t.isFront=!1),e.children.splice(a,1)}o.prototype={constructor:o,addChild:function(e){var t=this.lastChildEnd(),n=new o(e);return n.start=t,n.end=e.text&&t+e.text.length,n.place=this.place,n.children=[],n.innerText&&i(n),this.children.push(n),n},lastChildEnd:function(){var e=this.children&&this.children[this.children.length-1]||null;return e?e.end:this.start+Math.max(0,this.text.indexOf(this.innerText))},tokenAt:function(e){if(e<this.start||e>=this.end)return null;if(this.children.length)for(var t=0;t<this.children.length;t+=1)if(e>=this.children[t].start&&e<this.children[t].end){var n=this.children[t].tokenAt(e);if(n)return n}return this},pathAt:function(e){if(e<this.start||e>=this.end)return[];var t=[];if(this.children.length)for(var n=0;n<this.children.length;n+=1)if(e>=this.children[n].start&&e<this.children[n].end){var r=this.children[n].pathAt(e);if(r.length){t=t.concat(r);break}}return t.concat(this)},nearestTokenAt:function(n){return n<this.start||n>=this.end?null:this.children?this.children.reduce(function(e,t){return e||(n>=t.start&&n<t.end?t:null)},null):this},everyLeaf:function(n){return this.children&&0!==this.children.length?this.children.reduce(function(e,t){return e&&t.everyLeaf(n)},!0):!!n(this)},demote:function(){this.type="text"},error:function(e){this.type="error",this.message=e},toString:function(){var e=this.type+"("+this.start+"\u2192"+this.end+")";return this.children&&0<this.children.length&&(e+="["+this.children+"]"),e},copy:function(){var e=new o(this);return e.children=e.children.slice(),e},foldChildren:function(){for(var e=[],t=this.children.slice(),n=0;n<t.length;n+=1){var r=t[n],a=!1;if(r.matches)for(var o=0;o<e.length;o+=1)e[o].type in r.matches&&(S(this,r,e[o]),e=e.slice(o+1),a=!0);!a&&r.isFront&&e.unshift(r)}}},a={lex:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"start",r=3<arguments.length&&void 0!==arguments[3]&&arguments[3];return i(new o({type:"root",place:t,start:0,end:e.length,text:e,innerText:e,children:[],innerMode:a.modes[n]}),!r)},rules:k,modes:{}},"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=a:"function"==typeof define&&define.amd?define("lexer",[],function(){return a}):this&&null!=this&&this.loaded?(this.modules||(this.modules={}),this.modules.Lexer=a):this.Lexer=a}.call(eval("this")||("undefined"!=typeof global?global:window)),!function(){Object.assign=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,r=arguments[t];for(n in r)hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e};var m,g=Object.keys,y=Object.assign;function t(e){function t(n){return n=n||"innerText",function(e){var e=e.reduceRight(function(e,t,n){return e||(n?t:"")},""),t={};return t[n]=e,t}}function n(e,t){var n={};return n[e]=t,function(){return{isFront:!0,matches:n,cannotCross:["verbatimOpener"]}}}var r=Object.bind(0,null);function a(a,e){return Object.keys(e).forEach(function(n){var r=e[n].fn;e[n].fn=function(e){var t=r(e);return t.text||(t.text="string"==typeof e?e:e[0]),t.type||(t.type=n),t.innerMode||(t.innerMode=a),t}}),e}function o(e){switch(e&&e.type){case null:case"br":case"hr":case"bulleted":case"numbered":case"heading":case"align":case"column":case"escapedLine":return!0}return!1}var i=[],s=[],c=[],l=a(i,{hr:{fn:r},bulleted:{fn:function(e){return{depth:e[1].length}}},numbered:{fn:function(e){return{depth:e[1].length/2}}},heading:{fn:function(e){return{depth:e[1].length}}},align:{fn:function(e){var t,e=e[1],n=e.indexOf("><");return~n?25===(t=Math.round(n/(e.length-2)*50))&&(t="center"):"<"===e[0]&&">"===e.slice(-1)?t="justify":-1<e.indexOf(">")?t="right":-1<e.indexOf("<")&&(t="left"),{align:t}}},column:{fn:function(e){var t,e=e[1],n=e.indexOf("|");return n&&n<e.length-1?t="center":"|"===e[0]&&"|"===e.slice(-1)?t="none":n===e.length-1?t="right":n||(t="left"),{column:t,width:/\|+/.exec(e)[0].length,marginLeft:/^=*/.exec(e)[0].length,marginRight:/=*$/.exec(e)[0].length}}}}),u=(g(l).forEach(function(e){l[e].constraint=o,l[e].cannotFollowText=!0}),a(i,{twine1Macro:{fn:function(){return{type:"error",message:"Harlowe macros use a different syntax to Twine 1, SugarCube, and Yarn macros."}}},emBack:{fn:function(){return{matches:{emFront:"em"},cannotCross:["verbatimOpener"]}}},strongBack:{fn:function(){return{matches:{strongFront:"strong"},cannotCross:["verbatimOpener"]}}},strongFront:{fn:function(){return{isFront:!0}}},emFront:{fn:function(){return{isFront:!0}}},boldOpener:{fn:n("boldOpener","bold")},italicOpener:{fn:n("italicOpener","italic")},strikeOpener:{fn:n("strikeOpener","strike")},supOpener:{fn:n("supOpener","sup")},commentFront:{fn:function(){return{isFront:!0}}},commentBack:{fn:function(){return{matches:{commentFront:"comment"}}}},scriptStyleTag:{fn:r},tag:{fn:r},url:{fn:r},hookPrependedFront:{fn:function(e){return{name:e[1],hidden:")"===e[2],isFront:!0,tagPosition:"prepended"}}},hookFront:{fn:function(){return{isFront:!0}}},hookBack:{fn:function(){return{matches:{hookPrependedFront:"hook",hookFront:"hook"},cannotCross:["verbatimOpener"]}}},hookAppendedBack:{fn:function(e){return{name:e[2],hidden:"("===e[1],tagPosition:"appended",matches:{hookFront:"hook"},cannotCross:["verbatimOpener"]}}},unclosedHook:{fn:r},unclosedHookPrepended:{fn:function(e){return{type:"unclosedHook",name:e[1],hidden:")"===e[2]}}},verbatimOpener:{fn:function(e){var e=e[0].length,t={};return{type:(t["verbatim"+e]="verbatim")+e,isFront:!0,matches:t,aka:"verbatimOpener"}}},unclosedCollapsed:{fn:r},collapsedFront:{fn:function(){return{isFront:!0}}},collapsedBack:{fn:function(){return{matches:{collapsedFront:"collapsed"},cannotCross:["verbatimOpener"]}}},escapedLine:{fn:r},legacyLink:{fn:function(e){return{type:"twineLink",innerText:e[1],passage:e[2],innerMode:i}}},br:{fn:r}})),p=y(a(s,{macroFront:{fn:function(e){return{isFront:!0,name:e[1]}}},groupingBack:{fn:function(){return{matches:{groupingFront:"grouping",macroFront:"macro"},cannotCross:["singleStringOpener","doubleStringOpener","hookFront"]}}},passageLink:{fn:function(e){var t=e[1]||"",n=e[2]||"",e=e[3]||"";return{type:"twineLink",innerText:n?e:t,passage:t?e:n,innerMode:i}}},simpleLink:{fn:function(e){return{type:"twineLink",innerText:e[1]||"",passage:e[1]||"",innerMode:i}}},variable:{constraint:function(e){return!e||"macroFront"!==e.type},fn:t("name")},tempVariable:{constraint:function(e){return!e||"macroFront"!==e.type},fn:t("name")}}),{hookFront:u.hookFront,hookBack:u.hookBack}),d=a(s,_objectSpread(_objectSpread({commentBack:{fn:function(){return{matches:{commentFront:"comment"}}}},macroName:{constraint:function(e){return e&&"macroFront"===e.type},fn:t("name")},groupingFront:{fn:function(){return{isFront:!0}}},property:{fn:t("name"),constraint:function(e){if(e)switch(e.type){case"variable":case"hookName":case"property":case"tempVariable":case"colour":case"itsProperty":case"belongingItProperty":case"macro":case"grouping":case"string":case"datatype":case"hook":case"boolean":case"number":return!0}}},possessiveOperator:{fn:r},itsProperty:{cannotFollowText:!0,fn:t("name")},itsOperator:{cannotFollowText:!0,fn:r},belongingItProperty:{cannotFollowText:!0,fn:t("name")},belongingItOperator:{cannotFollowText:!0,fn:r},belongingProperty:{cannotFollowText:!0,fn:t("name")},belongingOperator:{cannotFollowText:!0,fn:r},escapedStringChar:{fn:function(){return{type:"text"}}},singleStringOpener:{fn:function(){return{isFront:!0,matches:{singleStringOpener:"string"},innerMode:c}}},doubleStringOpener:{fn:function(){return{isFront:!0,matches:{doubleStringOpener:"string"},innerMode:c}}},hookName:{fn:t("name")},cssTime:{fn:function(e){return{value:+e[1]*("s"===e[2].toLowerCase()?1e3:1)}}},datatype:{cannotFollowText:!0,fn:function(e){return{name:e[0].toLowerCase()}}},colour:{cannotFollowText:!0,fn:function(e){var e=e[0].toLowerCase(),t={red:"e61919",orange:"e68019",yellow:"e5e619",lime:"80e619",green:"19e619",cyan:"19e5e6",aqua:"19e5e6",blue:"197fe6",navy:"1919e6",purple:"7f19e6",fuchsia:"e619e5",magenta:"e619e5",white:"fff",black:"000",gray:"888",grey:"888"},t=hasOwnProperty.call(t,e)?"#"+t[e]:e;return{colour:t}}},number:{fn:function(e){return{value:parseFloat(e[0])}}},inequality:{fn:function(e){return{operator:e[2],negate:-1<e[1].indexOf("not")}}},augmentedAssign:{fn:function(e){return{operator:e[0][0]}}},identifier:{fn:t("name"),cannotFollowText:!0},whitespace:{fn:r,cannotFollowText:!0},incorrectOperator:{fn:function(e){var t={"=>":">=","=<":"<=",gte:">=",lte:"<=",gt:">",lt:"<",eq:"is",isnot:"is not",neq:"is not",isa:"is a",are:"is",x:"*","or a":"or"}[e[0].toLowerCase().replace(/\s+/g," ")];return{type:"error",message:"Please say "+(t?"'"+t+"'":"something else")+" instead of '"+e[0]+"'.",explanation:"In the interests of readability, I want certain operators to be in a specific form."}},cannotFollowText:!0}},["boolean","is","to","into","where","when","via","making","each","and","or","not","isNot","contains","doesNotContain","isIn","isA","isNotA","isNotIn","matches","doesNotMatch","bind"].reduce(function(e,t){return e[t]={fn:r,cannotFollowText:!0},e},{})),["comma","spread","typeSignature","addition","subtraction","multiplication","division"].reduce(function(e,t){return e[t]={fn:r},e},{}))),f=a(c,{singleStringCloser:d.singleStringOpener,doubleStringCloser:d.doubleStringOpener,escapedStringChar:d.escapedStringChar}),h=(i.push.apply(i,_toConsumableArray(g(l)).concat(_toConsumableArray(g(p)),_toConsumableArray(g(u)))),s.push.apply(s,_toConsumableArray(g(p)).concat(_toConsumableArray(g(d)))),c.push.apply(c,_toConsumableArray(g(f))),_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({},l),u),p),d),f)),u=(g(h).forEach(function(e){m.PlainCompare[e]?(h[e].pattern=m.PlainCompare[e],h[e].plainCompare=!0):h[e].pattern=RegExp("^(?:"+m[e]+")","i")}),y(e.rules,h),e.modes);return u.start=u.markup=i,u.macro=s,u.string=c,e}function n(e){return Object.freeze({lex:t(e).lex,Patterns:m})}"object"===("undefined"==typeof module?"undefined":_typeof(module))?(m=require("./patterns"),module.exports=n(require("./lexer"))):"function"==typeof define&&define.amd?define("markup",["lexer","patterns"],function(e,t){return m=t,n(e)}):this&&this.loaded&&this.modules?(m=this.modules.Patterns,this.modules.Markup=n(this.modules.Lexer)):(m=this.Patterns,this.Markup=n(this.Lexer))}.call(eval("this")||("undefined"!=typeof global?global:window)),!function(){var e;function n(t){return t&&"object"===_typeof(t)?(Object.keys(t).forEach(function(e){t[e]=n(t[e])}),t):(t+"").replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&")}function t(e){return function(){return"("+e+Array.apply(0,arguments).join("|")+")"}}var r=t("?:"),a=t("?!"),o=t("?="),i="[ \\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]*",s=i.replace("*","+"),c="\\b",l="[\\w\\-\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171\\uD800-\\uDFFF]",u=l.replace("\\-",""),p=r("\\n","$"),d=i+"(\\*+)"+s,f=i+"((?:0\\.)+)"+s,h=i+"-{3,}"+i+p,m=i+"(==+>|<=+|=+><=+|<==+>)"+i+p,p=i+"(=+\\|+|\\|+=+|=+\\|+=+|\\|=+\\|)"+i+p,g={opener:"\\[\\[(?!\\[)",text:"("+function(){return"[^"+Array.apply(0,arguments).map(n).join("")+"]*"}("]")+")",rightSeparator:r("\\->","\\|"),leftSeparator:"<\\-",closer:"\\]\\]",legacySeparator:"\\|",legacyText:"("+r("[^\\|\\]]","\\]"+a("\\]"))+"+)"},y=u+"*"+u.replace("\\w","a-zA-Z")+u+"*",b="\\$("+y+")",v="_("+y+")",w="'s"+s+a("_")+"("+y+")",k="("+y+")"+s+"of"+c+a("it\\b"),S="'s"+s,T=r("it","time","turns?","visits?","exits?","pos")+c,_="its"+s+"("+y+")",x="("+y+")"+s+"of"+s+"it"+c,O="of"+s+"it"+c,A={opener:"\\(",name:"("+r("\\$","_")+"?"+l+"+):"+a("\\/"),closer:"\\)"},C=r("=<","=>","[gl]te?\\b","n?eq\\b","isnot\\b","are\\b","x\\b","isa\\b","or"+s+"a"+c),E="[a-zA-Z][\\w\\-]*",N="(?:\"[^\"]*\"|'[^']*'|[^'\">])*?",j="\\|("+l+"+)(>|\\))",P="(<|\\()("+l+"+)\\|",R="((?:\\b\\d+(?:\\.\\d+)?|\\.\\d+)(?:[eE][+\\-]?\\d+)?)"+a("m?s")+c;g.main=g.opener+r(g.text+g.rightSeparator,g.text.replace("*","*?")+g.leftSeparator)+g.text,e={upperLetter:"[A-Z\\u00c0-\\u00de\\u0150\\u0170]",lowerLetter:"[a-z0-9_\\-\\u00df-\\u00ff\\u0151\\u0171]",anyLetter:l,anyLetterStrict:u,whitespace:s.replace("[","[\\n\\r"),escapedLine:"\\\\\\n\\\\?|\\n\\\\",br:"\\n(?!\\\\)",tag:"<\\/?"+E+N+">",scriptStyleTag:"<("+r("script","style","textarea")+")"+N+">[^]*?<\\/\\1>",scriptStyleTagOpener:"<",url:"("+r("https?","mailto","javascript","ftp","data")+":\\/\\/[^\\s<]+[^<.,:;\"')\\]\\s])",bullet:"\\*",hr:h,heading:"[ \\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]*(#{1,6})[ \\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]*",align:m,column:p,bulleted:d,numbered:f,verbatimOpener:"`+",hookAppendedFront:"\\["+a("=+"),hookPrependedFront:j+"\\["+a("=+"),hookFront:"\\["+a("=+"),hookBack:"\\]"+a(P),hookAppendedBack:"\\]"+P,unclosedHook:"\\[=+",unclosedHookPrepended:j+"\\[=+",unclosedCollapsed:"\\{=+",passageLink:g.main+g.closer,legacyLink:g.opener+g.legacyText+g.legacySeparator+g.legacyText+g.closer,simpleLink:g.opener+g.legacyText+g.closer,macroFront:A.opener+o(A.name),macroName:A.name,groupingFront:"\\("+a(A.name),twine1Macro:"<<[^>\\s]+\\s*(?:\\\\.|'(?:[^'\\\\]*\\\\.)*[^'\\\\]*'|\"(?:[^\"\\\\]*\\\\.)*[^\"\\\\]*\"|[^'\"\\\\>]|>(?!>))*>>",validPropertyName:y,property:w,belongingProperty:k,possessiveOperator:S,belongingOperator:"of\\b",itsOperator:"its\\b",belongingItOperator:O,variable:b,tempVariable:v,hookName:"\\?("+l+"+)\\b",cssTime:"(\\d+\\.?\\d*|\\d*\\.?\\d+)(m?s)\\b",colour:r(r("Red","Orange","Yellow","Lime","Green","Cyan","Aqua","Blue","Navy","Purple","Fuchsia","Magenta","White","Gray","Grey","Black","Transparent"),"#[\\dA-Fa-f]{3}(?:[\\dA-Fa-f]{3})?"),datatype:r("alnum","alphanumeric","any(?:case)?","array","bool(?:ean)?","changer","codehook","colou?r","const","command","dm","data"+r("map","type","set"),"ds","digit","gradient","empty","even","int"+a("o")+"(?:eger)?","lambda","lowercase","macro","linebreak","newline","num(?:ber)?","odd","str(?:ing)?","uppercase","whitespace")+c,number:R,boolean:r("true","false")+c,identifier:T,itsProperty:_,belongingItProperty:x,escapedStringChar:"\\\\[^\\n]",singleStringOpener:"'",doubleStringOpener:'"',singleStringCloser:"'",doubleStringCloser:'"',is:"is"+a(s+"not"+c,s+"an?"+c,s+"in"+c,s+"<",s+">")+c,isNot:"is"+s+"not"+a(s+r("an?","in")+c)+c,isA:"is"+s+"an?"+c,isNotA:"is"+s+"not"+s+"an?"+c,matches:"matches\\b",doesNotMatch:"does"+s+"not"+s+"match"+c,and:"and\\b",or:"or\\b",not:"not\\b",inequality:"((?:is(?:"+s+"not)?"+i+")*)("+r("<(?!=)","<=",">(?!=)",">=")+")",isIn:"is"+s+"in"+c,contains:"contains\\b",doesNotContain:"does"+s+"not"+s+"contain"+c,isNotIn:"is"+s+"not"+s+"in"+c,addition:n("+")+a("="),subtraction:n("-")+a("=","type"),multiplication:n("*")+a("="),division:r("/","%")+a("="),spread:"\\.\\.\\."+a("\\."),to:r("to\\b","="),into:"into\\b",making:"making\\b",where:"where\\b",when:"when\\b",via:"via\\b",each:"each\\b",augmentedAssign:r("\\+","\\-","\\*","\\/","%")+"=",bind:"2?bind\\b",typeSignature:n("-type")+c,incorrectOperator:C,PlainCompare:{comma:",",commentFront:"\x3c!--",commentBack:"--\x3e",strikeOpener:"~~",italicOpener:"//",boldOpener:"''",supOpener:"^^",strongFront:"**",strongBack:"**",emFront:"*",emBack:"*",collapsedFront:"{",collapsedBack:"}",groupingBack:")"}},"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=e:"function"==typeof define&&define.amd?define("patterns",[],function(){return e}):this&&this.loaded?(this.modules||(this.modules={}),this.modules.Patterns=e):this.Patterns=e}.call(eval("this")||("undefined"!=typeof global?global:window)),define("twinescript/operations",["utils","utils/operationutils","datatypes/typedvar","datatypes/datatype","internaltypes/twineerror"],function(e,t,n,r,m){var a=e.plural,o=t.isObject,i=t.collectionType,s=t.is,c=t.isA,l=t.clone,u=t.unique,p=t.contains,e=t.matches,g=t.objectName,d=t.toSource;function f(r,a,o,i){return o=o||"do this to",function(e,t){var n;return 1===a.length&&(t=e),(n=m.containsError(e,t))||(_typeof(e)!==r||_typeof(t)!==r?m.create("operation","I can only ".concat(o," ").concat(r,"s, not ").concat(g(_typeof(e)!==r?e:t),"."),i):a(e,t))}}function h(a){return function(e,t){var n,r;return(n=m.containsError(e,t))||(_typeof(e)!==_typeof(t)||o(e)&&"TwineScript_TypeName"in e&&o(t)&&"TwineScript_TypeName"in t&&e.TwineScript_TypeName!==t.TwineScript_TypeName||i(e)!==i(t)?(n="".concat(g(e)," isn't the same type of data as ").concat(g(t)),_typeof(e)+_typeof(t)!=="stringnumber"&&_typeof(e)+_typeof(t)!=="numberstring"||(r="You might want to convert one side to a number using (num:), or to a string using (str:)."),m.create("operation",n[0].toUpperCase()+n.slice(1),r)):a(e,t))}}function y(d,f,e){var h=2<arguments.length&&void 0!==e&&e;return function r(a,o){var e;if(e=m.containsError(a,o))return e;var t=_slicedToArray(a.determiner?[a,o]:o.determiner?[o,a]:[],2),i=t[0],t=t[1];if(i){var n=i,s=n.determiner,n=n.determined;if("start"===s||"end"===s){if(f)return m.create("operation","I can't use '".concat(f,"' with the 'start' or 'end' of ").concat(g(n),"."));if(t.determiner){if("start"===t.determiner||"end"===t.determiner)return m.create("operation","I can't compare one value's 'start' or 'end' with another value's 'start' or 'end'.","Please change one of them to use an exact range, such as '1stto4th' or '2ndlasttolast'.");n=[t,i],i=n[0]}for(var c=i.string||i.array,l=0;l<c.length+1;l+=1){var u=l?"end"===s?c.slice(-l):c.slice(0,l):c.constructor(),u=i===a?r(u,o):r(a,u);if(e=m.containsError(u))return e;if(u!==h)return u}return h}var p="all"===s;return i.array.reduce(function(e,t){var n,t=i===a?r(t,o):r(a,t);return(n=m.containsError(e,t))||(p?e&&t:e||t)},p)}return d(a,o)}}function b(n,e){return y(function(e,t){e=n(e,t);return m.containsError(e)?e:!e},e,!0)}t="If one of these values is a number, you may want to write a check that it 'is not 0'. Also, if one is a string, you may want to write a check that it 'is not \"\" '.",t={and:f("boolean",h(function(e,t){return e&&t}),"use 'and' to join",t),or:f("boolean",h(function(e,t){return e||t}),"use 'or' to join",t),not:f("boolean",function(e){return!e},"use 'not' to invert",t),"+":h(function(e,t){var n;return Array.isArray(e)?[].concat(_toConsumableArray(e),_toConsumableArray(t)):e instanceof Map?(n=new Map(e),t.forEach(function(e,t){return n.set(t,e)}),n):e instanceof Set?new Set([].concat(_toConsumableArray(e),_toConsumableArray(t)).filter(u).map(l)):"function"==typeof e["TwineScript_+"]?e["TwineScript_+"](t):"string|number|boolean".includes(_typeof(e))?e+t:m.create("operation","I can't use + on ".concat(g(e),"."))}),"-":h(function(e,n){var r;return Array.isArray(e)?e.filter(function(t){return!n.some(function(e){return s(t,e)})}):e instanceof Set?(r=_toConsumableArray(n),new Set(_toConsumableArray(e).filter(function(t){return!r.some(function(e){return s(t,e)})}))):"string"==typeof e?e.split(n).join(""):"number"==typeof e?e-n:m.create("operation","I can't use - on ".concat(g(e),"."))}),"*":f("number",h(function(e,t){return e*t}),"multiply"),"/":f("number",h(function(e,t){return 0===t?m.create("operation","I can't divide ".concat(g(e)," by zero.")):e/t}),"divide"),"%":f("number",h(function(e,t){return 0===t?m.create("operation","I can't modulo ".concat(g(e)," by zero.")):e%t}),"modulus"),"<":y(f("number",h(function(e,t){return e<t}),"do < to"),"<"),">":y(f("number",h(function(e,t){return t<e}),"do > to"),">"),"<=":y(f("number",h(function(e,t){return e<=t}),"do <= to"),"<="),">=":y(f("number",h(function(e,t){return t<=e}),"do >= to"),">="),is:y(s),isNot:b(s),contains:y(p,"contains"),doesNotContain:b(p,"does not contain"),isIn:y(function(e,t){return p(t,e)},"is in"),isNotIn:b(function(e,t){return p(t,e)},"is not in"),isA:y(c,"is a"),isNotA:b(c,"is not a"),typifies:y(function(e,t){return c(t,e)}),untypifies:b(function(e,t){return c(t,e)}),matches:y(e),doesNotMatch:b(e),makeSpreader:function(e){var t;return m.containsError(e)?e:n.isPrototypeOf(e)||r.isPrototypeOf(e)?(t=l(e),(n.isPrototypeOf(e)?t.datatype:t).rest=!0,t):{value:e,spreader:!0,TwineScript_TypeName:"a spreaded '...' value",TwineScript_ObjectName:a("string"==typeof e||Array.isArray(e)?_toConsumableArray(e).length:1,"spreaded '...' value"),TwineScript_Unstorable:!0,TwineScript_ToSource:function(){return""+_toConsumableArray(e).map(d)}}}};return Object.freeze(t)}),define("twinescript/runner",["macros","state","utils","utils/operationutils","twinescript/operations","datatypes/colour","datatypes/hookset","datatypes/lambda","datatypes/datatype","datatypes/varbind","datatypes/codehook","datatypes/typedvar","datatypes/assignmentrequest","internaltypes/varref","internaltypes/twineerror"],function(Macros,State,Utils,_ref127,Operations,Colour,HookSet,Lambda,Datatype,VarBind,CodeHook,TypedVar,AssignmentRequest,VarRef,TwineError){var toSource=_ref127.toSource,typeName=_ref127.typeName,objectName=_ref127.objectName,insensitiveName=Utils.insensitiveName,impossible=Utils.impossible,hash=Utils.hash;function addFreeVariable(e,t){var n,r=e.freeVariables;"macro"===t.type?"current-time"===(n=insensitiveName(t.name))||"current-date"===n||"monthday"===n||"weekday"===n||"history"===n||"visited"===n||"passage"===n?e.freeVariables=!0:t.blockedValue&&!r.blockedValues?r.blockedValues=e.stackTop.blockedValues.concat():"random"!==n&&"either"!==n&&"shuffled"!==n||r.seed||(r.seed=State.seed,r.seedIter=State.seedIter):"identifier"===t.type?"time"!==(n=insensitiveName(t.text))&&"exits"!==n&&"it"!==n&&"visits"!==n&&"turns"!==n||(e.freeVariables=!0):"property"===t.type||"belongingProperty"===t.type?"random"!==insensitiveName(t.name)||r.seed||(r.seed=State.seed,r.seedIter=State.seedIter):"variable"!==t.type&&"tempVariable"!==t.type||(e.freeVariables=!0)}var precedenceTable=[["error","text"],["comma"],["to","into"],["where","when","via","making","each"],["typeSignature"],["augmentedAssign"],["and","or"],["is","isNot"],["contains","doesNotContain","isIn","isNotIn"],["isA","isNotA","matches","doesNotMatch"],["inequality"],["addition","subtraction"],["multiplication","division"],{rightAssociative:["spread","bind"]},{rightAssociative:["not","positive","negative"]},{rightAssociative:["belongingProperty","belongingItProperty","belongingOperator","belongingItOperator"]},["property","itsProperty","possessiveOperator","itsOperator"],["twineLink","macro","identifier","variable","tempVariable","hookName","number","cssTime","boolean","string","hook","colour","datatype","root"],["grouping"]];function precedentToken(e,t){var n,r,a,o=[];if(e.length)for("most"===t?(n=precedenceTable.length-1,r=a=-1):(n=0,r=precedenceTable.length,a=1);n!==r;n+=a){var i=precedenceTable[n],s=NaN;if(i.rightAssociative){for(var c=0;c<e.length;c+=1)if(i.rightAssociative.includes(e[c].type)){s=c;break}}else for(var l=e.length-1;0<=l;--l)if(i.includes(e[l].type)){s=l;break}if(!Number.isNaN(s)&&-1<s){o=[e[s],s];break}}return o}var comparisonOpTypes=["inequality","is","isNot","isIn","contains","doesNotContain","isNotIn","isA","typifies","isNotA","untypifies","matches","doesNotMatch"],inequalityNegator={">":"<=","<":">=",">=":"<","<=":">"};function compileComparisonOperator(e){return"inequality"===e.type?e.negate?inequalityNegator[e.operator]:e.operator:e.type}var comparisonReverser={">":"<","<":">",">=":"<=","<=":">=",contains:"isIn",doesNotContain:"isNotIn",isIn:"contains",isA:"typifies",typifies:"isA",isNotA:"untypifies",untypifies:"isNotA"};function reverseComparisonOperator(e){e=compileComparisonOperator(e);return comparisonReverser[e]||e}var tokenSides={error:"neither",identifier:"neither",variable:"neither",tempVariable:"neither",hookName:"neither",number:"neither",boolean:"neither",string:"neither",hook:"neither",colour:"neither",datatype:"neither",root:"neither",twineLink:"neither",macro:"neither",grouping:"neither",itsProperty:"neither",belongingItProperty:"neither",to:"both",into:"both",typeSignature:"both",augmentedAssign:"both",and:"both",or:"both",belongingOperator:"both",possessiveOperator:"both",multiplication:"both",division:"both",spread:"after",bind:"after",not:"after",belongingProperty:"after",each:"after",itsOperator:"after",positive:"after",negative:"after",belongingItOperator:"before",property:"before"};function missingSideError(e,t,n){return TwineError.create("syntax","I need usable code to be ".concat(e?"left ":"").concat(e&&t?"and ":"").concat(t?"right ":"","of ").concat(n.text,"."))}function wrongSideError(e,t,n){return TwineError.create("syntax","There can't be a ".concat(e&&t?e.map(function(e){return e.text}).join("")+" or "+t.map(function(e){return e.text}).join(""):(e||t).map(function(e){return e.text}).join("")," to the ").concat(e?"left ":"").concat(e&&t?"or ":"").concat(t?"right ":"","of ").concat(n.text,"."),"There could be a comma missing between them.")}function makeEvalReplayFrame(e,t){var n=t.val,r=t.fromCode,a=t.toCode,o=t.toDesc,i=t.reason,s=t.it,c=t.tokens,t=t.i;if(!(200<=e.length)){var l=c[t],u=c.slice(0,t),t=c.slice(t+1);if(1===c.length&&(u=t=!1,l=c[0]),!e[e.length-1].error){var p,d,c=TwineError.containsError(n),f=e[e.length-1].code,h=e[0].basis,m=(null!=(p=u)&&p.length&&null!=(p=t)&&p.length&&u[0].start>t[0].start&&(u=(p=[t,u])[0],t=p[1]),p=a||"".concat(null!=(p=u)&&p.length&&"whitespace"===u[u.length-1].type?" ":"").concat(c?" \ud83d\udc1e ":(n&&!n.TwineScript_ToSource&&n.TwineScript_Unstorable?objectName:toSource)(n)).concat(null==(p=t)||!p.length||"whitespace"!==t[0].type&&"addition"!==l.type&&"subtraction"!==l.type?"":" "),(u.length?u[0]:l).start-h),g=(t.length?t[t.length-1]:l).end-h,y=_createForOfIteratorHelper(e);try{for(y.s();!(d=y.n()).done;){var b=d.value;b.start<m?(m+=b.diff,g+=b.diff):b.start<g&&(g+=b.diff)}}catch(e){y.e(e)}finally{y.f()}!r&&(r=f.slice(m,g),a)&&a.trim()===r.trim()||(u=p.length-(g-m),e.push({code:f.slice(0,m)+p+f.slice(g),fromCode:r,toCode:!c&&a,toDesc:!c&&!a&&(o||objectName(n)),start:m,end:g,diff:u,reason:i,itIdentifier:void 0!==s&&objectName(s),error:c&&c.render(f.slice(m,g),!0)}))}}}function setIt(e,t){return(VarRef.isPrototypeOf(t)||TypedVar.isPrototypeOf(t))&&(e.Identifiers.it=t.get()),t}return function run(section,tokens){var isVarRef=2<arguments.length&&void 0!==arguments[2]&&arguments[2],isTypedVar=3<arguments.length&&void 0!==arguments[3]&&arguments[3],evalReplay=section.evalReplay,hasEvalReplay=null==evalReplay?void 0:evalReplay.length,evalReplayReason,evalReplaySkip=!1,evalReplayIt,ops=Operations,token,ret,i,before,after,_precedentToken,_precedentToken2,token,i,before,after;if(Array.isArray(tokens)||(tokens=[tokens]),!tokens.length||!tokens[0])return impossible("Runner.run","No tokens to run!"),0;1===tokens.length?token=tokens[0]:(_precedentToken=precedentToken(tokens,"least"),_precedentToken2=_slicedToArray(_precedentToken,2),token=_precedentToken2[0],i=_precedentToken2[1],before=tokens.slice(0,i),after=tokens.slice(i+1),before.length&&(1!==before.length||"whitespace"!==before[0].type)||(before=!1),after.length&&(1!==after.length||"whitespace"!==after[0].type)||(after=!1));var type=token.type;if(!type)return impossible("Runner.run","Token has no type!"),0;var sides=tokenSides[type]||"",VARREF=("both"!==sides||before&&after?"neither"===sides&&(before||after)?ret=wrongSideError(before,after,token):"before"===sides?before?after&&(ret=wrongSideError(null,after,token)):ret=missingSideError(!0,!1,token):"after"===sides&&(after?before&&(ret=wrongSideError(before,null,token)):ret=missingSideError(!1,!0,token)):ret=missingSideError(!before,!after,token),section.freeVariables&&"object"===_typeof(section.freeVariables)&&addFreeVariable(section,token),!0),TYPEDVAR=!0,_ret4,val,evalReplayReason,ret,source,_source4,_value4,msg;if(!ret){if("comma"===type)return impossible("Section.run","a comma token was run() somehow."),0;if("root"===type)ret=run(section,token.children);else if("identifier"===type)ret=isVarRef?VarRef.create(section.Identifiers,token.text.toLowerCase()):section.Identifiers[token.text.toLowerCase()];else if("variable"===type||"tempVariable"===type){ret=VarRef.create("tempVariable"===type?section.stackTop.tempVariables:State.variables,token.name),isTypedVar?(ret=TypedVar.create(Datatype.create("any"),ret),evalReplayReason=hasEvalReplay&&"Variables in 'to' or 'into' expressions with no -type to their left are considered to be 'any-type' variables that can store any storable value."):isVarRef||TwineError.containsError(ret)?evalReplaySkip=!0:(val=ret.get(),evalReplayReason=hasEvalReplay&&((null==(_ret4=ret)?void 0:_ret4.object)!==State.variables||hasOwnProperty.call(ret.object,ret.compiledPropertyChain[0])?"":"This variable didn't exist; for story-wide $ variables, a default value of 0 is used if they don't exist."),ret=val)}else if("hookName"===type)ret=HookSet.create({type:"name",data:token.name}),evalReplaySkip=!0;else if("number"===type||"cssTime"===type)ret=token.value,evalReplayReason=hasEvalReplay&&"cssTime"===type&&(token.text.endsWith("ms")?"The letters 'ms' at the end of numbers are ignored, so you can use them to indicate that a number represents milliseconds.":"The letter 's' at the end of numbers represents 'seconds'. Harlowe converts them to milliseconds (multiplies them by 1000)."),evalReplaySkip=!evalReplayReason;else if("boolean"===type)ret="true"===token.text.toLowerCase(),evalReplaySkip=!0;else if("string"===type){var t=token.text.replace(/(.?)\n/g,function(e,t){return("\\"===t?"\\\\":"\n"===t?"\\n":t)+"\\n"}).replace(/(\\*)\\0/g,function(e,t){return(t?"\\".repeat(2*t.length):"")+"0"});ret=eval(t),evalReplaySkip=!0}else if("hook"===type)ret=CodeHook.create(token.children,token.text),evalReplaySkip=!0;else if("colour"===type)ret=Colour.create(token.colour),evalReplaySkip=!0;else if("datatype"===type)ret=Datatype.create(token.name),evalReplaySkip=!0;else if("spread"===type)ret=ops.makeSpreader(run(section,after,!1,isTypedVar));else if("bind"===type)ret=VarBind.create(run(section,after,VARREF),token.text.startsWith("2")?"two way":""),evalReplaySkip=!0;else if("to"===type||"into"===type){var dest="to"===type?setIt(section,run(section,before,VARREF,TYPEDVAR)):run(section,after,VARREF,TYPEDVAR);if(TwineError.containsError(dest))ret=dest;else{(VarRef.isPrototypeOf(dest)&&dest.propertyChain.length<=1||TypedVar.isPrototypeOf(dest)&&dest.varRef.propertyChain.length<=1)&&(section.freeVariables=Object.create(null));var src="to"===type?run(section,after,VARREF):setIt(section,run(section,before,VARREF));if(TwineError.containsError(src))return src;var freeVariables=section.freeVariables,srcRef;section.freeVariables=null,token.place&&freeVariables&&"object"===_typeof(freeVariables)&&"boolean"!=typeof src&&"number"!=typeof src&&!Utils.options.uncompressedPureValues&&(srcRef=freeVariables,srcRef.at=token.place,srcRef.from=after[0].start,srcRef.to=after[after.length-1].end,srcRef.hash=hash(after.reduce(function(e,t){return e+t.text},"")).toString(16),JSON.stringify(srcRef).length>=toSource(src).length)&&(srcRef=void 0),ret=AssignmentRequest.create(dest,src,type,srcRef),evalReplaySkip=!0,evalReplayIt=section.Identifiers.it}}else if("typeSignature"===type){var datatype=run(section,before),free=section.freeVariables,variable=(section.freeVariables=null,run(section,after,VARREF));section.freeVariables=free,ret=TypedVar.create(datatype,variable),evalReplaySkip=!0}else if("where"===type||"when"===type||"via"===type){after?(source=tokens.map(function(e){return e.text}).join(""),ret=Lambda.create(before?run(section,before,VARREF):void 0,token.type,after,source),evalReplaySkip=!0):ret=missingSideError(!1,!0,token)}else if("making"===type||"each"===type){after?(_source4=[].concat(tokens).map(function(e){return e.text}).join(""),ret="each"===type?Lambda.create(run(section,after,VARREF),"each",null,_source4):Lambda.create(before?run(section,before,VARREF):void 0,token.type,run(section,after,VARREF),_source4),evalReplaySkip=!0):ret=missingSideError(!1,!0,token)}else if("augmentedAssign"===type)ret=ops.makeAssignmentRequest(run(section,before,VARREF),ops[token.operator](run(section,before),run(section,after)),token.operator),evalReplaySkip=!0;else if("and"===type||"or"===type){var isComparisonOp=function e(t){var n=_slicedToArray(precedentToken(t,"least"),2),r=n[0],n=n[1];if(r&&"whitespace"!==r.type)return comparisonOpTypes.includes(r.type)?r:r.type===type?e(t.slice(0,n))||e(t.slice(n+1)):void 0},leftIsComparison=isComparisonOp(before),rightIsComparison=isComparisonOp(after),ambiguityError=TwineError.create("operation",'This use of "is not" and "'.concat(type,'" is grammatically ambiguous.'),'Maybe try rewriting this as "__ is not __ '.concat(type,' __ is not __"')),operator,getElisionOperands=function e(t){var n,r=_slicedToArray(precedentToken(t,"least"),2),a=r[0],r=r[1];return a&&"whitespace"!==a.type?a.type===type?[].concat(_toConsumableArray(e(t.slice(0,r))),_toConsumableArray(e(t.slice(r+1)))):(a=run(section,t),hasEvalReplay&&"boolean"!=typeof a&&(n=operator.replace(/[A-Z]/g,function(e){return" "+e.toLowerCase()}),makeEvalReplayFrame(evalReplay,{toCode:" it ".concat(n," ").concat(toSource(a)," "),reason:"A missing 'it ".concat(n,"' was inferred to correct the '").concat(type,"' operation."),tokens:t,i:r}),makeEvalReplayFrame(evalReplay,{toCode:" ".concat(toSource(section.Identifiers.it)," ").concat(n," ").concat(toSource(a)," "),tokens:t,i:r})),[{val:a,tokens:t,i:r}]):[]},elidedComparisonOperator=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.reduce(function(e,t){var n=t.val,r=t.tokens,t=t.i;return"boolean"==typeof n?n:(e=Operations[token.type](e,Operations[operator](section.Identifiers.it,n)),hasEvalReplay&&makeEvalReplayFrame(evalReplay,{val:e,tokens:r,i:t}),e)},"and"===token.type)},leftSide,evalBefore,operator,rightSide,rightIndex,swappedSides,evalAfter;ret=leftIsComparison&&!rightIsComparison?(leftSide=leftIsComparison,operator=compileComparisonOperator(leftSide),"isNot"===leftSide.type||"isNotA"===leftSide.type||"untypifies"===leftSide.type?ambiguityError:(evalBefore=run(section,before),ops[type](evalBefore,elidedComparisonOperator.apply(void 0,_toConsumableArray(getElisionOperands(after)))))):!leftIsComparison&&rightIsComparison?(rightSide=rightIsComparison,rightIndex=tokens.indexOf(rightSide),operator=reverseComparisonOperator(rightSide),"isNot"===rightSide.type||"isNotA"===rightSide.type||"untypifies"===rightSide.type?ambiguityError:(swappedSides=[].concat(_toConsumableArray(tokens.slice(rightIndex+1)),[Object.assign(Object.create(rightSide),_defineProperty({},"inequality"===rightSide.type?"operator":"type",reverseComparisonOperator(rightSide)))],_toConsumableArray(tokens.slice(i+1,rightIndex))),evalAfter=run(section,swappedSides),ops[type](evalAfter,elidedComparisonOperator.apply(void 0,_toConsumableArray(getElisionOperands(before)))))):ops[type](run(section,before),run(section,after))}else if(comparisonOpTypes.includes(type)){after||missingSideError(!1,!0,token);var leftOp=before?run(section,before):section.Identifiers.it;ret=ops[compileComparisonOperator(token)](leftOp,run(section,after)),section.Identifiers.it=leftOp,evalReplayIt=leftOp,evalReplayReason=hasEvalReplay&&!before&&"A missing 'it' was inferred to complete the operation."}else if("addition"===type||"subtraction"===type){after||missingSideError(!1,!0,token);var convert=!before,_precedentToken7,_precedentToken8,previousPrecedentToken,_i10,_sides,pType,convert;before&&(_precedentToken7=precedentToken(before,"least"),_precedentToken8=_slicedToArray(_precedentToken7,2),previousPrecedentToken=_precedentToken8[0],_i10=_precedentToken8[1],_sides=tokenSides[previousPrecedentToken.type],pType=previousPrecedentToken.type,convert=("both"===_sides||"after"===_sides||"addition"===pType||"subtraction"===pType)&&(_i10===before.length-1||_i10===before.length-2&&"whitespace"===before[before.length-1].type)),convert?(token.type="addition"===type?"positive":"negative",ret=run(section,tokens),token.type=type,evalReplaySkip=!0):ret=ops[token.text](run(section,before),run(section,after))}else if("multiplication"===type||"division"===type)ret=ops[token.text](run(section,before),run(section,after));else if("positive"===type||"negative"===type)ret=ops["*"]("negative"===type?-1:1,run(section,after)),evalReplaySkip=!0;else if("not"===type)ret=ops.not(run(section,after));else if("belongingProperty"===type){var container=run(section,after,isVarRef),isRef=(ret=VarRef.create(container,token.name),isVarRef||TwineError.containsError(ret));ret=isRef?ret:ret.get(),isRef=isVarRef||TwineError.containsError(ret),hasEvalReplay&&!isRef?makeEvalReplayFrame(evalReplay,{toCode:" ".concat(token.name," of ").concat(toSource(VarRef.isPrototypeOf(container)?container.get():container)," "),tokens:tokens,i:i}):isRef||(evalReplayReason="The value to the right of 'of', ".concat(typeName(container),', had a "').concat(token.name,'" data name corresponding to that data value.'))}else if("belongingOperator"===type||"belongingItOperator"===type){var value=run(section,before);"random"===value&&section.freeVariables&&"object"===_typeof(section.freeVariables)&&!section.freeVariables.seed&&(section.freeVariables.seed=State.seed,section.freeVariables.seedIter=State.seedIter),ret=VarRef.create("belongingItOperator"===type?section.Identifiers.it:run(section,after,isVarRef),{computed:!0,value:value}),ret=isVarRef||TwineError.containsError(ret)?ret:ret.get(),"belongingItOperator"===type&&hasEvalReplay&&makeEvalReplayFrame(evalReplay,{toCode:" ".concat(toSource(value)," of ").concat(toSource(section.Identifiers.it)," "),tokens:tokens,i:i})}else if("property"===type){var _container=run(section,before,VARREF),_isRef=(ret=VarRef.create(_container,token.name),isVarRef||TwineError.containsError(ret));ret=_isRef?ret:ret.get(),_isRef=isVarRef||TwineError.containsError(ret),hasEvalReplay&&VarRef.isPrototypeOf(_container)&&!_isRef?makeEvalReplayFrame(evalReplay,{toCode:" ".concat(toSource(_container.get()),"'s ").concat(token.name," "),tokens:tokens,i:i}):_isRef||(evalReplayReason="The value to the left of 's, ".concat(typeName(_container),', had a "').concat(token.name,'" data name corresponding to that data value.'))}else if("itsProperty"===type||"belongingItProperty"===type)ret=VarRef.create(section.Identifiers.it,token.name),ret=isVarRef||TwineError.containsError(ret)?ret:ret.get(),hasEvalReplay&&makeEvalReplayFrame(evalReplay,{toCode:"itsProperty"===type?" ".concat(toSource(section.Identifiers.it),"'s ").concat(token.name," "):" ".concat(token.name," of ").concat(toSource(section.Identifiers.it)," "),tokens:tokens,i:i});else if("possessiveOperator"===type||"itsOperator"===type){!after||!before&&"itsOperator"!==token.type?ret=missingSideError(!before,!after,token):(_value4=run(section,after),"random"===_value4&&section.freeVariables&&"object"===_typeof(section.freeVariables)&&!section.freeVariables.seed&&(section.freeVariables.seed=State.seed,section.freeVariables.seedIter=State.seedIter),ret=VarRef.create("itsOperator"===token.type?section.Identifiers.it:run(section,before,isVarRef),{computed:!0,value:_value4}),ret=isVarRef||TwineError.containsError(ret)?ret:ret.get(),"itsOperator"===type&&hasEvalReplay&&makeEvalReplayFrame(evalReplay,{toCode:" ".concat(toSource(section.Identifiers.it),"'s ").concat(toSource(_value4)," "),tokens:tokens,i:i}))}else if("twineLink"===type)ret=Macros.run("link-goto",section,[token.innerText,token.passage]),evalReplayReason=hasEvalReplay&&"Passage links are the same as (link-goto:) macro calls.";else if("macro"===type)if(token.blockedValue&&!section.blocked){if(ret=section.blockedValue(),void 0===ret)return impossible("Runner.run","section.blockedValue() returned undefined"),0}else{var macroNameToken=token.children[0],variableCall="$"===macroNameToken.text[0]||"_"===macroNameToken.text[0],macroRef;if("macroName"!==macroNameToken.type&&!variableCall)return impossible("Runner.run","macro token had no macroName child token"),0;variableCall?(macroRef=VarRef.create("_"===macroNameToken.text[0]?section.stackTop.tempVariables:State.variables,macroNameToken.text.trim().slice(1,-1)),TwineError.containsError(macroRef)||(macroRef=macroRef.get())):macroRef=token.name,ret=Macros[variableCall?"runCustom":"run"](macroRef,section,token.children.slice(1).reduce(function(e,t){return"comma"===t.type?e.push([]):e[e.length-1].push(t),e},[[]]).filter(function(e){return e.length&&(1<e.length||"whitespace"!==e[0].type)}).map(function(e){return run(section,e,!1,isTypedVar)})),evalReplayReason=hasEvalReplay&&variableCall&&"I called ".concat(objectName(macroRef),".")}else if("grouping"===type)ret=run(section,token.children,isVarRef),evalReplaySkip=!0;else if("error"===type)ret=TwineError.create("syntax",token.message,token.explanation||"");else{if("text"!==type)return impossible("Section.run","unknown syntax token type: ".concat(type,"!!")),0;token.text.trim().match(/^\d+(?:th|nd|st|rd)(?:last)?(?:to\d+(?:nth|nd|st|rd)(?:last)?)?$/g)&&(msg='Position data names like "'.concat(token.text,'" need to be either left of "of" or right of "\'s".')),ret=TwineError.create("syntax",msg||'"'.concat(token.text,"\" isn't valid Harlowe syntax for the inside of a macro call."),"Maybe you misspelled something? Also, as of 3.3.0, Javascript syntax is not allowed inside macro calls.")}}return void 0===ret?(impossible("Section.run","token ".concat(type).concat(token.name?" (".concat(token.name,":)"):""," produced undefined")),0):ret===section?(impossible("Section.run","token ".concat(type).concat(token.name?" (".concat(token.name,":)"):""," produced the section")),0):(hasEvalReplay&&!evalReplaySkip&&makeEvalReplayFrame(evalReplay,{val:ret,reason:evalReplayReason,it:evalReplayIt,tokens:tokens,i:i}),ret)}}),define("utils/jqueryplugins",["jquery"],function(e){e.prototype.extend({popAttr:function(e){var t=this.attr(e);return this.removeAttr(e),t},popData:function(e){var t=this.data(e);return this.removeData(e),t},tag:function(){return this[0]&&this[0].tagName&&this[0].tagName.toLowerCase()},textNodes:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"*";return 1===this.length&&this[0]&&this[0].nodeType===Node.TEXT_NODE?[this[0]]:this.get().concat(this.contents().get(),this.find(e).contents().get()).filter(function(e,t,n){return(null==e?void 0:e.nodeType)===Node.TEXT_NODE&&n.indexOf(e)===t}).sort(function(e,t){return 2&e.compareDocumentPosition(t)?1:-1})},findAndFilter:function(e){var t=this.find(e),e=this.filter(e);return e.length?t.add(e):t}})}),define("utils/naturalsort",[],function(){return function(h){var m=1<arguments.length&&void 0!==arguments[1]?arguments[1]:String;return function(e,t){var n,r,a,o,i=/(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?$|^0x[0-9a-f]+$|[0-9]+)/gi,s=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[/-]\d{1,4}[/-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,c=/^0x[0-9a-f]+$/i,l=/^0/,e=m(e).trim(),t=m(t).trim(),u=e.replace(i,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),p=t.replace(i,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),i=parseInt(e.match(c))||1!==u.length&&e.match(s)&&Date.parse(e),e=parseInt(t.match(c))||i&&t.match(s)&&Date.parse(t)||null;if(h&&window.Intl&&window.Intl.Collator&&(a=window.Intl.Collator(h)),e){if(i<e)return-1;if(e<i)return 1}for(var d=0,f=Math.max(u.length,p.length);d<f;d++){if(n=!(u[d]||"").match(l)&&parseFloat(u[d])||u[d]||0,r=!(p[d]||"").match(l)&&parseFloat(p[d])||p[d]||0,isNaN(n)!==isNaN(r))return isNaN(n)?1:-1;if(_typeof(n)!==_typeof(r))n+="",r+="";else if("string"==typeof n&&a&&0!==(o=a.compare(n,r)))return o;if(n<r)return-1;if(r<n)return 1}return 0}}}),define("utils/operationutils",["utils/naturalsort","utils","internaltypes/twineerror","patterns"],function(f,e,h,t){var m=e.impossible,g=e.nth,u=e.permutations,s=e.plural,y=t.validPropertyName,r="object",n="boolean",b="string",v="number",w="function";function a(e){return!!e&&(_typeof(e)===r||_typeof(e)===w)}var k=Array.isArray;function S(e){return e&&Object.getPrototypeOf(e)===Object.prototype}function i(e){return k(e)?"array":e instanceof Map?"datamap":e instanceof Set?"dataset":_typeof(e)===b?b:e&&_typeof(e)===r?r:""}function c(e){if(a(e)){if(_typeof(e.TwineScript_Clone)===w)return e.TwineScript_Clone();if(k(e))return _toConsumableArray(e);if(e instanceof Map)return new Map(e);if(e instanceof Set)return new Set(e);if(_typeof(e)===w)return Object.assign(e.bind(),e);switch(Object.getPrototypeOf(e)){case Object.prototype:return _objectSpread({},e);case null:return Object.assign(Object.create(null),e)}m("OperationUtils.clone","The value "+e+" cannot be cloned!")}return e}function o(e,t,n,r){for(var a="",o=0;a.length<=t&&o<e.length;){var i=r(e[o]);if(!(i.length+a.length<=t)){a+=(0<o?" and ":"")+s(e.length-o,(0<o?"other ":"")+n);break}a+=(0<o&&o===e.length-1?" and ":"")+i+(o<e.length-1?", ":""),o+=1}return a}function l(e){var t;return a(e)&&"TwineScript_ObjectName"in e?e.TwineScript_ObjectName:k(e)?0===e.length?"an empty array":"an array (with "+o(e,48,"item",l)+")":e instanceof Map?0===e.size?"an empty datamap":"a datamap (with "+o(_toConsumableArray(e.keys()),48,"dataname",_)+")":e instanceof Set?0===e.size?"an empty dataset":"a dataset (with "+o(_toConsumableArray(e.values()),48,"item",l)+")":_typeof(e)===b?0===e.length?"an empty string":48<(t=_toConsumableArray(e)).length?"a ".concat(t.length,"-character string starting with ").concat(JSON.stringify(t.slice(0,48).join(""))):"the string ".concat(JSON.stringify(e)):_typeof(e)===n?"the boolean value '"+e+"'":_typeof(e)===v?"the number "+JSON.stringify(e):void 0===e?"an empty variable":"...whatever this is"}function T(e,t){return[e[0],t[0]].sort(f("en"))[0]===e[0]?-1:1}function _(e,t){var n=h.containsError(e);if(n&&m("toSource","received a TwineError: "+n.message),_typeof(e.TwineScript_ToSource)===w)return e.TwineScript_ToSource();if(S(e)&&"first"in e&&"last"in e)return(e.first<0?(-1!==e.first?g(-e.first):"")+"last":g(e.first+1))+"to"+(e.last<0?(-1!==e.last?g(-e.last):"")+"last":g(e.last+1));if(k(e)){var r,a="",o=_createForOfIteratorHelper(e);try{for(o.s();!(r=o.n()).done;)var i=r.value,a=(a+=a?",":"(a:")+("property"===t?i+(0<i):_(i))}catch(e){o.e(e)}finally{o.f()}return a+(a?")":"(a:)")}if(e instanceof Map){var s,c="",l=_createForOfIteratorHelper(Array.from(e.entries()).sort(T));try{for(l.s();!(s=l.n()).done;){var u=_slicedToArray(s.value,2),p=u[0],d=u[1];c+=(c?",":"(dm:")+_(p)+","+_(d)}}catch(e){l.e(e)}finally{l.f()}return c+(c?")":"(dm:)")}return e instanceof Set?"(ds:"+Array.from(e).sort(f("en")).map(_)+")":_typeof(e)===v&&"property"===t?e<0?-1===e?"last":g(-e)+"last":g(e+1):_typeof(e)===b&&"property"===t?RegExp(y).test(e)?e:"("+JSON.stringify(e)+")":JSON.stringify(e)}function p(t,n){return _typeof(t)!==r&&_typeof(n)!==r?t===n:k(t)&&k(n)?t.length===n.length&&t.every(function(e,t){return p(n[t],e)}):t instanceof Map&&n instanceof Map?p(Array.from(t.entries()).sort(),Array.from(n.entries()).sort()):t instanceof Set&&n instanceof Set?p(_toConsumableArray(t),_toConsumableArray(n)):t&&_typeof(t.TwineScript_is)===w?t.TwineScript_is(n):t&&_typeof(t)===r&&n&&_typeof(n)===r&&S(t)&&S(n)?p(Object.getOwnPropertyNames(t).map(function(e){return[e,t[e]]}),Object.getOwnPropertyNames(n).map(function(e){return[e,n[e]]})):Object.is(t,n)}return Object.freeze({isObject:a,isValidDatamapName:function(e,t){var n;return e instanceof Map||m("isValidDatamapName","called with non-Map"),h.containsError(t)?t:_typeof(t)!==b&&_typeof(t)!==v?h.create("property","Only strings and numbers can be used as data names for "+l(e)+", not "+l(t)+"."):(n=_typeof(t)===b?+t:""+t,!(!Number.isNaN(n)&&e.has(n))||h.create("property","You mustn't use both "+l(t)+" and "+l(n)+" as data names in the same datamap."))},collectionType:i,isSequential:function(e){return _typeof(e)===b||k(e)||_typeof(e.hooks)===w},unstorableValue:function e(t){return(null==t?void 0:t.TwineScript_Unstorable)&&t||k(t)&&t.find(e)||t instanceof Map&&_toConsumableArray(t.values()).find(e)||t instanceof Set&&_toConsumableArray(t).find(e)},isHarloweJSValue:function e(t){return _typeof(t)===b||_typeof(t)===n||_typeof(t)===v&&!Number.isNaN(t)&&Math.abs(t)!==1/0||Array.isArray(t)&&t.every(e)||t instanceof Set&&_toConsumableArray(t).every(e)||t instanceof Map&&_toConsumableArray(t.values()).every(e)&&_toConsumableArray(t.keys()).every(function(e){return _typeof(e)===b})},clone:c,objectName:l,typeName:function e(t){var n,r=S(t);return r&&t.innerType?t.typeName||("insensitive set"===t.pattern?"a case-insensitive string name":"either"===t.pattern?(k(t.innerType)||m("typeName",'"either" pattern had non-array inner type'),t.innerType.map(e).join(" or ")):"optional"===t.pattern?"(optional) "+e(t.innerType):e(t.innerType)):r&&"range"===t.pattern?t.name||(r=t.min,n=t.max,"a"+(0<r?" positive":"")+(t.integer?" whole":"")+" number"+(0===r?" between 0 and "+n:n<1/0?" up to "+n:"")):t===String||t===Number||t===Boolean?"a "+_typeof(t()):t===parseInt?"a whole number":t===Map?"a datamap":t===Set?"a dataset":t===Array?"an array":a(t)&&"TwineScript_TypeName"in t?t.TwineScript_TypeName:l(t)},typeID:function(e){var t=_typeof(e);return[n,b,v].includes(t)?t:k(e)?"array":e instanceof Map?"datamap":e instanceof Set?"dataset":e.TwineScript_TypeID||""},toSource:_,is:p,contains:function(e,t){if(e||""===e){if(_typeof(e)===b)return _typeof(t)!==b?h.create("operation",l(e)+" can only contain strings, not "+l(t)+"."):e.includes(t);if(k(e))return e.some(function(e){return p(e,t)});if(e instanceof Set||e instanceof Map)return Array.from(e.keys()).some(function(e){return p(e,t)})}return h.create("operation",l(e)+" cannot contain any values, let alone "+l(t))},isA:function(e,t){return _typeof(t.TwineScript_IsTypeOf)===w?t.TwineScript_IsTypeOf(e):h.create("operation",'"is a" should only be used to compare type names, not '+l(t)+".")},matches:function t(n,e){var r=!1;if(n&&_typeof(n.TwineScript_IsTypeOf)===w){var a=n.TwineScript_IsTypeOf(e);if(h.containsError(a))return a;r|=a}if(e&&_typeof(e.TwineScript_IsTypeOf)===w){if(a=e.TwineScript_IsTypeOf(n),h.containsError(a))return a;r|=a}if(r)return!0;if(k(n)&&k(e)){for(var o=0,i=0,s=!0;s&&o<n.length&&i<e.length;){var c=n[o],l=e[i];if(c.rest){for(;i<e.length&&t(c,l);)l=e[i+=1];o+=1}else if(l.rest){for(;o<n.length&&t(c,l);)c=n[o+=1];i+=1}else t(c,l)?(o+=1,i+=1):s=!1}return s&&o>=n.length&&i>=e.length}return n instanceof Map&&e instanceof Map?t(Array.from(n.entries()).sort(),Array.from(e.entries()).sort()):n instanceof Set&&e instanceof Set?(n=_toConsumableArray(n),u.apply(void 0,_toConsumableArray(e)).some(function(e){return t(n,e)})):p(n,e)},subset:function e(t,n,r){var a,o;return n&&r?((a=_typeof(t)===b)&&(t=Array.from(t)),n<0&&(n=Math.max(0,t.length+n+1)),(r=r<0?Math.max(0,t.length+r+1):r)<n?e(arguments[0],r,n):(o=t.slice(0<n?n-1:n,r).map(c),a?o.join(""):o)):h.create("macrocall","The sub"+i(t)+" index value must not be "+(n&&r)+".")},range:function e(t,n){if(n<t)return e(n,t);var r=[t];for(n-=t;0<n--;)r.push(++t);return r},printBuiltinValue:function r(e){return h.containsError(e)?e:e&&_typeof(e.TwineScript_Print)===w?e.TwineScript_Print():e instanceof Map?(e=Array.from(e.entries()),h.containsError(e)?e:e.reduce(function(e,t){var n=(t=_slicedToArray(t,2))[0],t=t[1];return e+"<tr><td>`"+r(n)+"`</td><td>`"+r(t)+"`</td></tr>"},"<table class=datamap>")+"</table>"):e instanceof Set?Array.from(e.values()).map(r)+"":k(e)?e.map(r)+"":e&&_typeof(e.jquery)===b?e:a(e)?h.create("unimplemented","I don't know how to print this value yet."):e+""},unique:function(t,e,n){return n.findIndex(function(e){return p(t,e)})===e}})}),define("utils/polyfills",[],function(){var o=Array.prototype;"function"!=typeof o.includes&&(o.includes=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;if(!Number.isNaN(e)&&Number.isFinite(t)&&void 0!==e)return-1<o.indexOf.call(this,e,t);var n=Object(this),r=parseInt(n.length);if(!(r<=0))for(var a=0<=t?t:Math.max(0,r+t);a<r;){if(Object.is(e,n[a]))return!0;a+=1}return!1}),window.Symbol||(window.Symbol={iterator:"_es6-shim iterator_"})}),define("utils/renderutils",["jquery","utils","renderer"],function(l,u,p){var n=RegExp(u.realWhitespace+"+"),s=RegExp(u.realWhitespace+"+","g");function d(e,t,n){var r,a=e.textContent.length;if(!(a<=t))return r=[e=0===t?e:e.splitText(t)],n&&(n=n<=0?a-n:n)<a&&r.push(e.splitText(n-t)),r}var t,c=function(){var e;return void 0!==t?t:(e=l("<p>"),t=!!e[0].normalize&&(e.append(document.createTextNode("0-"),document.createTextNode("2"),document.createTextNode(""))[0].normalize(),1===e.contents().length))};var f="tw-collapsed,[collapsing=true]";var o=/^(=*)([^=]+)=*$/;return Object.freeze({dialog:function(){var e,t=(c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).section,n=void 0===(n=c.parent)?u.storyElement:n,r=c.cd,a=void 0===(a=c.message)?"":a,o=c.defaultValue,i=void 0===(c=c.buttons)?[{name:"OK",confirm:!0,callback:Object}]:c,s=("a code hook"===a.TwineScript_TypeName&&(a=a.code),l("<tw-backdrop><tw-dialog>"+(o||""===o?"<input type=text style='display:block;margin:0 auto'></input>\n":"")+"<tw-dialog-links>"+(i.length?i.reduce(function(e,t,n){t=t.name;return e+"<tw-link style='margin:0 "+(n===i.length-1?"0 0 0.5em":0===n?"0.5em 0 0":"0.5em")+"' tabindex=0>"+t+"</tw-link>"},""):"<tw-link tabindex=0>"+i[0].name+"</tw-link>")+"</tw-dialog-links></tw-dialog></tw-backdrop>")),c=s.find("tw-dialog");return n.append(s),t?(t.renderInto(a,c,_objectSpread(_objectSpread({},r),{},{append:"prepend"})),null!=(n=(null==r?void 0:r.transition)&&s.find("tw-dialog > tw-transition-container"))&&n.length&&n.appendTo(s).append(c.prepend(n.contents().detach()))):c.prepend(p.exec(a)),o&&((e=s.find("input").last()).val(o).on("keypress",function(e){13===e.which&&(s.remove(),i.filter(function(e){return e.confirm}).forEach(function(e){return e.callback()}))}),setTimeout(function(){return e.focus()},100)),i.reverse().forEach(function(e,t){l(s.find("tw-link").get(-t-1)).on("click",function(){u.options.debug&&u.options.ignoreClickEvents&&!l(s).is(".eval-replay, .harlowe-crash")||(s.remove(),e.callback())})}),s},realWhitespace:n,textNodeToChars:function(r){var e=_toConsumableArray(r.textContent);return 1===e.length?[r]:e.reduce(function(e,t){return t.match(n)&&e.length&&e[e.length-1].match(n)?e[e.length-1]+=t:e.push(t),e},[]).reduce(function(e,t){var n=r;return t.length<r.textContent.length&&(r=r.splitText(t.length)),e.concat(n)},[])},findTextInNodes:function e(t,n){var r=[],a="",o=[];if(!t.length||!n)return o;for(;0<t.length;){r.push(t[0]),a+=t[0].textContent,t.shift();var i=a.indexOf(n);if(-1<i){for(var s=a.length-(i+n.length);i>=r[0].textContent.length;)i-=r[0].textContent.length,r.shift();if(1===r.length){var c=d(r[0],i,i+n.length);o.push(c[0]),c[1]&&t.unshift(c[1]);break}o.push(d(r[0],i,r[0].length)[0]),o.push.apply(o,_toConsumableArray(r.slice(1,-1))),c=d(r[r.length-1],0,r[r.length-1].textContent.length-s),o.push(c[0]),c[1]&&t.unshift(c[1]),o=o.filter(Boolean);break}}return[o].concat(_toConsumableArray(e(t,n)))},collapse:function(e){function n(e){return 0===l(this||e).parentsUntil(f).filter("tw-verbatim, tw-expression, [collapsing=false]").length}var t=function e(t){var n=t[0],r=t.parent();return!r.length||t.findAndFilter("tw-story").length?null:(t=(t=r.textNodes().filter(function(e){return 4&(e=e.compareDocumentPosition(n))&&!(8&e)}))[t.length-1])||e(r)}(e),r=(l(t).parents(f).length||(t=null),function e(t){var n=t[0],r=t.parent();return!r.length||t.findAndFilter("tw-story").length?null:r.textNodes().filter(function(e){return 2&(e=e.compareDocumentPosition(n))&&!(8&e)})[0]||e(r)}(e)),a=(l(r).parents(f).length||(r=null),"br:not([data-raw]),tw-consecutive-br:not([data-raw])"),o=(e.find(a).filter(n).replaceWith(document.createTextNode(" ")),(e=l(e.get().map(function(e){return l(e).filter(n).is(a)?l(document.createTextNode(" ")).replaceAll(e)[0]:e}))).textNodes()),i=0;o.reduce(function(e,t){return n(t)?(t.textContent=t.textContent.replace(s," ")," "!==t.textContent[0]||e&&e.textContent&&!(-1<e.textContent.search(/\s$/))||(t.textContent=t.textContent.slice(1)),t):document.createTextNode("A")},t),_toConsumableArray(o).reverse().every(function(e){return!(!n(e)||(e.textContent.match(/^\s*$/)?(i+=e.textContent.length,e.textContent=""):(e.textContent=e.textContent.replace(/\s+$/,function(e){return i+=e.length,""}),1)))}),0<i&&r&&(o[o.length-1].textContent+=" "),e[0]&&c()&&e[0].normalize()},geomStringRegExp:o,geomParse:function(e){var t,n,r,a;return!e||(t=e.length,n=(a=_slicedToArray(o.exec(e)||[],3))[0],r=a[1],a=a[2],!n)||a===e&&1<a.length?{marginLeft:0,size:0}:{marginLeft:r.length/t*100,size:a.length/t*100}}})}),define("utils/scripttag",["state","utils/operationutils","internaltypes/varref","internaltypes/twineerror"],function(a,o,i,s){return function(e,r){Function("script","scope","with(scope){var scope=void 0,arguments=void 0;eval([script,script=void 0][0]);}")(e,Object.create(null,Object.keys(a.variables).map(function(e){return!e.startsWith("TwineScript_")&&"$"+e}).concat(Object.keys(r).map(function(e){return!e.startsWith("TwineScript_")&&"_"+e})).reduce(function(e,n){return n&&(e[n]={get:function(){var e=("$"===n[0]?a.variables:r)[n.slice(1)];if(o.isHarloweJSValue(e))return o.clone(e);throw s.create("","The contents of the variable ".concat(n,", ").concat(o.objectName(e),", couldn't be converted to a Javascript value."),"Only booleans, strings, numbers, datamaps, datasets and arrays can be converted to Javascript values.")},set:function(e){var t="$"===n[0]?a.variables:r;if(!o.isHarloweJSValue(e))throw s.create("","The Javascript value, ".concat(e,", couldn't be converted to a Harlowe value and assigned to the variable ").concat(n,"."),"Only booleans, strings, numbers (except NaN and Infinity), Maps, Sets and Arrays can be converted to Harlowe values.");e=o.clone(e);t=i.create(t,n.slice(1)).set(e);if(s.containsError(t))throw t}}),e},{})))}}),!function(){function e(t,n,r){return function(e){return"background-color: hsla(".concat(t,",").concat(n,"%,").concat(r,"%,").concat(e,");")}}var t={boolean:"color:hsla(0,0%,30%,1.0)",array:"color:hsla(0,100%,30%,1.0)",dataset:"color:hsla(30,100%,40%,1.0)",number:"color:hsla(30,100%,30%,1.0)",datamap:"color:hsla(60,100%,30%,1.0)",changer:"color:hsla(90,100%,30%,1.0)",lambda:"color:hsla(120,100%,40%,1.0)",hookName:"color:hsla(160,100%,30%,1.0)",string:"color:hsla(180,100%,30%,1.0)",identifier:"color:hsla(200,80%,40%,1.0)",variable:"color:hsla(200,100%,30%,1.0)",tempVariable:"color:hsla(200,70%,20%,1.0)",datatype:"color:hsla(220,100%,30%,1.0)",colour:"color:hsla(280,100%,30%,1.0)",macro:"color:hsla(320,80%,30%,1.0)",twineLink:"color:hsla(240,100%,20%,1.0)"},o=(t.gradient=t.colour,t.command=t.twineLink,t.instant=t.metadata=t.any=t.customMacro=t.macro,Math.min),n=e(40,100,50),r=e(220,100,50),i=/hsla\((\d+),\s*(\d+)%,\s*(\d+)%,\s*(\d+\.\d+)\)/g,s="cm-harlowe-3-",a=(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(n={root:"box-sizing:border-box;",hook:n(.05),"hook-2":n(.1),"hook-3":n(.15),"hook-4":n(.2),"hook-5":n(.25),"hook-6":n(.3),"hook-7":n(.35),"hook-8":n(.4),"^=hook , ^=hook-":"font-weight:bold;",unclosedHook:n(.05)+"font-weight:bold;"},"error:not([class*='"+s+"string'])","background-color: hsla(17,100%,50%,0.5) !important;"),"^=macroName","font-style:italic;"),"macroName-boolean",t.boolean),"macroName-array",t.array),"macroName-dataset",t.dataset),"macroName-datatype",t.datatype),"macroName-number",t.number),"macroName-datamap",t.datamap),"macroName-changer",t.changer),"macroName-string",t.string),_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(n,"macroName-colour, macroName-gradient",t.colour),"macroName-command, macroName-instant, macroName-metadata",t.command),"macroName-custommacro, macroName-macro, macroName-any",t.macro),"^=macro ","font-weight:bold;"+t.macro),"comma, spread",t.macro),"addition",t.any),"subtraction, multiplication, division",t.number),"is, and, or, not, isNot, contains, doesNotContain, isIn, isA, isNotA, isNotIn, matches, doesNotMatch",t.boolean),"bold, strong","font-weight:bold;"),"italic, em","font-style:italic;"),_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(n,"sup","vertical-align: super;font-size:0.8em;"),"strike","text-decoration: line-through;"),"verbatim","background-color: hsla(0,0%,50%,0.1);font:var(--font-monospaced)"),"^=bold, ^=strong, ^=italic, ^=em, ^=sup, ^=verbatim, ^=strike","font-weight:100; color: hsla(0,0%,0%,0.5)"),"^=collapsed","font-weight:bold; color: hsla(201,100%,30%,1.0);"),"unclosedCollapsed",r(.025)+"font-weight:bold; color: hsla(201,100%,30%,1.0);"),"collapsed",r(.025)),"collapsed.hook",r(.05)),"collapsed.hook-2",r(.1)),"collapsed.hook-3",r(.15)),_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(n,"collapsed.hook-4",r(.2)),"collapsed.hook-5",r(.25)),"collapsed.hook-6",r(.3)),"collapsed.hook-7",r(.35)),"collapsed.hook-8",r(.4)),"twineLink:not(.text)",t.twineLink),"tag, scriptStyleTag, comment","color: hsla(240,34%,25%,1.0);"),"boolean",t.boolean),"string",t.string),"number",t.number),_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(n,"variable",t.variable),"tempVariable",t.tempVariable),"hookName",t.hookName),"datatype",t.datatype),"colour",t.colour),"cssTime",t.number),"passageString",t.variable+";text-decoration:underline 1px;"),"tagString",t.variable+";text-decoration:underline 1px dotted;"),"variableOccurrence, hookOccurrence","background: hsla(159,50%,75%,1.0) !important;"),"^=where, ^=via, ^=with, ^=making, ^=each, ^=when",t.lambda+"; font-style:italic;"),_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(n,"heading","font-weight:bold;"),"hr","background-image: linear-gradient(0deg, transparent, transparent 45%, hsla(0,0%,75%,1.0) 45%, transparent 55%, transparent);"),"align","color: hsla(14,99%,37%,1.0); background-color: hsla(14,99%,87%,0.1);"),"column","color: hsla(204,99%,37%,1.0); background-color: hsla(204,99%,87%,0.1);"),"escapedLine","font-weight:bold; color: hsla(51,100%,30%,1.0);"),"identifier, property, belongingProperty, itsProperty, belongingItProperty, belongingItOperator, possessiveOperator, belongingOperator",t.identifier),"toString",function(){var a=this;return Object.keys(this).reduce(function(e,n){var r;return"toString"!==n&&(r=n.split(", ").map(function e(t){return-1<t.indexOf(".")?t.split(/\./g).map(e).join(""):0===t.indexOf("^=")?"[class^='"+s+t.slice(2)+"']":"."+s+t}),e+=r.join(", ")+"{"+a[n]+"}",a[n].match(i))&&[".theme-dark","[data-app-theme=dark]"].forEach(function(t){e+=r.map(function(e){return t+" "+e}).join(", ")+"{"+a[n].replace(i,function(e,t,n,r,a){return"hsla("+t+","+o(100,1.5*+n)+"%,"+(100-r)+"%,"+a+")"})+"}"}),e},"")})+"");"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports={Colours:t,CSS:a,versionClass:s}:"function"==typeof define&&define.amd&&define("utils/typecolours",[],function(){return{Colours:t,CSS:a,versionClass:s}})}.call(void 0);
;require("harlowe")}());
</script>

</body>
</html>
