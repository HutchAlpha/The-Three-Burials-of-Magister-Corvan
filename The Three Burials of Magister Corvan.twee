:: StoryTitle
The Three Burials of Magister Corvan


:: StoryData
{
  "ifid": "f6982699-df01-49fe-a72b-3db976ff8d0a",
  "format": "Harlowe",
  "format-version": "3.3.9",
  "start": "Start1",
  "tag-colors": {
    "INTERFACE": "green",
    "ENDING": "red",
    "NEXUS": "purple",
    "TEMP": "yellow",
    "Admin": "red",
    "ZoneNotes": "green",
    "CodeJeux": "purple",
    "test": "orange"
  },
  "zoom": 0.6
}


:: Admin [Admin] {"position":"900,0","size":"200,100"}



:: AjouteMoney {"position":"600,125","size":"100,100"}
//Ce code est dans le header !
window.updateMoney = function(addAmount) {
    const moneyEl = document.querySelector('.money');
    if (!moneyEl) return;

    // Extraire le texte actuel et convertir en nombre
    const currentText = moneyEl.textContent.trim().replace(/[^\d]/g, '');
    const currentMoney = parseInt(currentText, 10) || 0;

    const newMoney = currentMoney + addAmount;

    // Mettre à jour l'affichage
    const coinIcon = moneyEl.querySelector('i');
    moneyEl.textContent = newMoney + " ";
    if (coinIcon) {
        moneyEl.appendChild(coinIcon);
    }

    // Sauvegarder la nouvelle valeur
    localStorage.setItem('playerMoney', newMoney);
};



//Ajouter Argent
window.updateMoney(250);


:: AshenvaleAskWhy {"position":"1250,9125","size":"100,100"}
\:: AshenvaleAskWhy
**You:** “Why bury his brain beneath your crypt?”  
**Ancestor’s Ghost (shaking head):** “Shame, fear… I feared his mind would rise again. So I hid it under our family’s vault, hoping the earth would keep it bound.”  
(set: $journal to it + (a: "My ancestor told me:'I feared his mind would rise again. So I hid it under our family’s vault' "+ "\n\n"))
* [[Press him for the vault’s location|AshenvaleRevealLocation]]  
* [[Thank him and step back|WeepingEffigiesArrival]]
<!-- TEST JOURNAL
* [[If you’ve learned of your family’s link to Corvan, confront Lord Ashenvale’s ghost with your discovery|AshenvaleGhostConfront]]
-->
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}


:: AshenvaleConfession {"position":"1375,8925","size":"100,100"}
\:: AshenvaleConfession
**Ancestor’s Ghost:** “In ‘Anno Severis,’ I funded Corvan’s first Severance: foolish hope that he’d bind death’s touch for our house’s glory. Instead, he fractured his soul… and ours with it.”  
* [[Ask why he hid the brain here|AshenvaleAskWhy]]  
* [[Step back, overwhelmed, perhaps it is best not to know.|WeepingEffigiesArrival]]


:: AshenvaleGhostConfront {"position":"1250,9250","size":"100,100"}



:: AshenvaleRevealLocation {"position":"1475,9225","size":"100,100"}
\:: AshenvaleRevealLocation
**Ancestor’s Ghost:** “Four stones south of the chapel’s heart-shrine: knock thrice, then give your true name. The earth will grant entrance.”  
(set: $flags to it + “KnowAshenvaleVaultInstructions”)  
* [[Note the instructions and step back|WeepingEffigiesReturn]]


:: AshenvaleVaultDescent {"position":"1925,9475","size":"100,100"}
\:: AshenvaleVaultDescent
The stair winds down beneath dust and root. Faint echo of a heartbeat leads the way. At the bottom, a stone door bears Corvan’s sigil and your ancestor’s crest interlaced.  
* [[Push open the door|VaultEntrance]]  
* [[Step back and steel yourself|CryptPrepare]]


:: AshenvaleVaultEntrance {"position":"1825,9325","size":"100,100"}
\:: AshenvaleVaultEntrance
You rap thrice on the fourth stone and whisper your true name. A hidden panel slides open to reveal a narrow stair descending into darkness.  
* [[Descend with caution|AshenvaleVaultDescent]]


:: BSSBS9Veteran {"position":"750,825","size":"100,100"}
\:: BSSBS9Veteran
You spot your old unit’s ash-stained helmet resting among the bones. Donning it, you feel memories of battle surge through you: and nightmares of revenant foes.  
(set: $inventory to it + “Ashen Veteran’s Helmet”)  
* [[Adjust the fit and stand tall|BoneStackedShrineArrival]]


:: BSSDefaultInteraction {"position":"475,825","size":"100,100"}
You kneel before the altar and whisper a prayer. 
(if: visits is 1)[
The wind stills, and a single skull rolls forward: its jaw opening to reveal a small cache with some silver shards.
(set:$money to it+35)
]
(else:)[
This time, the bones don't seem impressed, or they have nothing left to give...
<!-- DON -->
]

* [[Rise and continue|BoneStackedShrineArrival]]


:: BSSOssuaryKnight {"position":"625,825","size":"100,100"}
You plant your feet and assume Boneguard Stance. 
(if: visits is 1)[
The chanting grows louder, and spectral warding glyphs flare around the altar. You feel your defense hardened against undead assault.  
(set: $strength to it +1)  
But that's not all: Fortifying the shrine brings spectral warding glyphs to life: but can you decypher them?

<!--start-->

(click:"decypher")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
    If not all the glyphs, you recognize the general meaning, it is a series of directions to follow. After a short stroll, you get to another series of glyphs.
    they trace out a shape on the ground that, when brushed aside, uncovers a spiral staircase of rib bones.
    * [[Gather your courage and take the staircase|CryptEntry]]  
    * [[Return to the square|VelthornHollowOrientation]]
    ]
(else:)
    [
    No. The glyphs meaning remain a mystery to you.
    * [[Rise and continue|BoneStackedShrineArrival]]
    * [[Return to the square|VelthornHollowOrientation]]
    ]

 ]
]

<!--END-->


]
(else:)[
You chant all you can, but the warding glyphs stay silent. Until...
(click:"Until")[
(display:"diceRollMacro")
 (live: 3s)[
    (stop:)
(if: $charisma >= $diceRoll)
    [ Some spectral warding glyphs appear in front of you. They move and trace out a shape on the ground that, when brushed aside, uncovers a spiral staircase of rib bones.
    * [[Gather your courage and take the staircase|CryptEntry]]  
    * [[Return to the square|VelthornHollowOrientation]]
    ]
(else:)
    [... no, nothing happens.
    ]

 ]
 ]
]



:: BSSStupidChoice [ENDING] {"position":"350,825","size":"100,100"}
{
(set:$introText to "You perch a skull atop your head and strike a pose. It wobbles… then crashes to the ground with a hollow *clang*. A nearby rat scurries off, unimpressed. ")
(set:$clickTest to "unimpressed")
(set:$AttributeTest to $luck)
(set:$SuccessText to "You look at the rat for a moment...")
(set:$FailureText to "    The moment you lean in, the most ancient skull topples from its perch, as a revengful god. Its hollow cranium connects with your temple in a sickening crack: your vision shatters, blood blooms across your cheek, and a cold void swallows you as your knees buckle beneath the weight of sudden oblivion.")
(set:$clickDamage to "sudden oblivion")
(set:$damageType to 2)
(set:$DeathText to "A burning numbness sears through your veins, spreading from your tongue to your gut in a wave of agony. Your vision blurs; your knees buckle as a poisonous toxin courses through your body. The world tilts and darkens, and the lantern’s final lament fades on your lips as life seeps away.")
(set:$currentEnding to 20)
(set:$LinkText to "Sheepishly retrieve the skull")
(set:$FailureLinkText to "You wake up a few minutes later, with you head severly bleeding. Sheepishly retrieve the skull and stop messing around...")
(set:$Link to "BoneStackedShrineArrival")

(set:$xpSuccess to 30)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:"MacroPassage")


:: BSSTrap {"position":"475,950","size":"100,100"}
\:: ShrineTreasureDiscovery
You crouch beside the Bone-Stacked Shrine, teeth and femurs piled like savage totems. Faint whispers drift on the breeze, hinting at hidden treasure. Between two skulls you spot a small iron box, its lid etched with childish runes.  
* [[Try to open the box|ShrineAttemptOpen]]  
* [[Ignore it and step back|BoneStackedShrineArrival]]




:: BackStoriesDetailsStats {"position":"1725,125","size":"100,100"}
1. Plagueborn Refugee
Stats: +1 CON

Item: Ragged plague mask (advantage against disease).

Advantage: Immune to rot/plague-based damage.

Disadvantage: Town guards treat you with suspicion.

Flavor: You survived Mourntide’s Red Fog and fled with scars… and knowledge.

2. Graverobber’s Bastard
Stats: +1 DEX

Item: Rusted lockpick set.

Advantage: Gain bonus loot from tombs and crypts.

Disadvantage: Hated by the Ossuary Knights (attack on sight in some areas).

Flavor: Born among bonepickers, you learned early how to steal from the dead.

3. Apprentice Necromancer
Stats: +1 INT

Item: Blackened bone wand.

Advantage: Know one minor necromantic spell.

Disadvantage: Hunted by Lantern Bearers as a heretic.

Flavor: You studied the art of death until your master vanished into their own spell.

4. Exiled Lantern Tender
Stats: +1 WIS

Item: Dim Lantern of Mourning (detect nearby undead).

Advantage: Undead are slower to attack you.

Disadvantage: Cannot enter holy sites without conflict.

Flavor: You failed in your duty to guide souls and now bear the burden of guilt.

5. Noble Scion of the Pale Court
Stats: +1 CHA

Item: Ancestral ring of authority.

Advantage: Influence nobles and merchants more easily.

Disadvantage: Targeted by revolutionary factions (Bonepickers).

Flavor: Your bloodline traces back to those who rule from the crypts.

6. Last of the Severed
Stats: +1 STR

Item: Severed arm (can be wielded as a brutal weapon).

Advantage: Immune to fear.

Disadvantage: Constantly haunted by visions of Corvan’s ritual.

Flavor: You alone survived the Severance Ritual that broke the Veil.

7. Cultist of the Worm
Stats: +1 INT

Item: Worm-tongue fetish (grants a minor healing ability).

Advantage: Resistant to corruption effects.

Disadvantage: Occasional loss of speech (tongue paralysis).

Flavor: You served the Worm Priests… now you flee their appetite.

8. Grave Singer
Stats: +1 CHA

Item: Bone flute (soothes restless spirits).

Advantage: Gain bonuses when calming/negotiating with the dead.

Disadvantage: Vulnerable to silence spells/effects.

Flavor: Your songs were once sung at every burial. Now they are forgotten.

9. Ashen War Veteran
Stats: +1 CON

Item: Scarred tower shield (resistant to ghost attacks).

Advantage: Bonus defense against spectral enemies.

Disadvantage: Terrible nightmares reduce morale in safe areas.

Flavor: You fought in the Ash Wars, where armies of revenants marched.

10. Street Orphan of Greyglass
Stats: +1 DEX

Item: Shard of Greyglass Mirror (shows hidden doors).

Advantage: Bonus stealth and trap evasion.

Disadvantage: Easily swayed by ghost voices (weak to possession).

Flavor: Raised on the broken streets where even reflections can kill.

11. Pilgrim of the Bleeding Monastery
Stats: +1 WIS

Item: Blood-soaked prayer beads (increase healing).

Advantage: Bonus to healing received.

Disadvantage: Cannot harm priests or monks without penalty.

Flavor: You sought absolution, but the Monastery gave you more questions than answers.

12. Returned from the Veil
Stats: +1 STR

Item: Pale Shroud (once covered your corpse, increases fear resistance).

Advantage: Bonus damage against undead.

Disadvantage: Life drains faster (lower healing efficiency).

Flavor: You died once. Something sent you back… unfinished.


:: Background {"position":"4300,875","size":"100,100"}
You leave that poor soul alone and head to the village, although not knowing exactly where it is. 
A few minutes passes and you start to get your bearings.
While the silhouette of the village starts to reveal itself and remove all notion of grandeur from your sorry brain, you try to piece together fragments of your previous existence... But what fragment was yours ?

    <div class="character-info">
  <h2 class="character-title">Plagueborn Refugee</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Mask.png"></div>
    <div class="character-description">
You trudge along the misty lane, the chill in your bones reminding you of fevered nights.
Once, you braved Mourntide’s Red Fog to save the dying, clutching your cracked plague mask close.
You recall the groans of fevered villagers, the desperate prayers for mercy: and your helpless tears.
Every aching step echoes the weight of lives you couldn’t spare, fueling both guilt and resolve.
Now, each breath you draw carries purpose: to heal what remains… or at least to bury what’s left.
(click:"Plagueborn Refugee")[
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/CrackedPlagueMask.png"></div>

<!--AJOUTER OBJET-->
    <script>
    // Tableau contenant l'objet à créer
  const newItemData = {
      id: "crackedPlagueMask",
      nom: "A cracked Plague Mask",
        type: "helmet",
        armor: 3,
      class: "item-img",
      src: "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/CrackedPlagueMask.png",
      prix: 1000,
      rare: "Mythic",
      inventory: 20,
    };

   // Création de l'élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute('data-id', newItemData.id);
  itemElement.setAttribute('draggable', 'true');

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory')) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));

  itemElement.addEventListener('mouseenter', (e) => showTooltip(e, itemElement));
  itemElement.addEventListener('touchstart', (e) => showTooltip(e, itemElement), { passive: false });
</script>



<!-- ADD CRACKED PLAGUE MASK -->
(set: $backStory to 1)
    <span class="twine-link">[[Very well... Now, let's enter Velthorn Hollow!|VelthornHollowEntry]]</span>
]
    </div>
    </div>
  </div>

    <div class="character-info">
  <h2 class="character-title">Graverobber’s Bastard</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Grave.png"></div>
    <div class="character-description">
With nimble feet you skirt broken stones, memories flickering of midnight heists.
You remember prying open bone-stacked crypts by torchlight, your lockpicks humming in your palm.
Ghostly whispers once guided your greedy fingertips to hidden reliquaries and cursed trinkets.
The thrill of forbidden treasure still pulses through you, along with the fear of Ossuary Knights.
Today, you walk these streets craving both gold and the secrets only the dead dare tell.
(click:"Graverobber’s Bastard")[
<!--AJOUTER OBJET-->
    <script>
    // Tableau contenant l'objet à créer
  const newItemData = {
      id: "commonHat",
      nom: "A common hat",
        type: "helmet",
        armor: 1,
      class: "item-img",
      src: "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/Hat03.png",
      prix: 30,
      rare: "Common",
      inventory: 19,
    };

   // Création de l'élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute('data-id', newItemData.id);
  itemElement.setAttribute('draggable', 'true');

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory')) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));

  itemElement.addEventListener('mouseenter', (e) => showTooltip(e, itemElement));
  itemElement.addEventListener('touchstart', (e) => showTooltip(e, itemElement), { passive: false });
</script>

(set: $backStory to 2)
    <span class="twine-link">[[Very well... Now, let's enter Velthorn Hollow!|VelthornHollowEntry]]</span>
]
    </div>
    </div>
  </div>

    <div class="character-info">
  <h2 class="character-title">Apprentice Necromancer</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Necromancer.png"></div>
    <div class="character-description">
Your boots splash through puddles as thoughts of arcane study surge unbidden.
You see your master’s laboratory: bubbling potions, bound skulls, and runes etched in bone.
The final experiment went catastrophically wrong: black flame consuming everything but you.
Your bone wand pulses in your pocket, a reminder of unfinished rites and forbidden power.
Now, each lantern-lit house you pass beckons with knowledge… if you dare reclaim it.
(click:"Apprentice Necromancer")[
<!--AJOUTER OBJET-->
    <script>
    // Tableau contenant l'objet à créer
  const newItemData = {
      id: "boneEtchedDagger",
      nom: "A bone-etched Dagger",
        type: "sword",
        strength: 3,
      class: "item-img",
      src: "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/boneEtchedDagger.png",
      prix: 500,
      rare: "Rare",
      inventory: 19,
    };

   // Création de l'élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute('data-id', newItemData.id);
  itemElement.setAttribute('draggable', 'true');

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory')) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));

  itemElement.addEventListener('mouseenter', (e) => showTooltip(e, itemElement));
  itemElement.addEventListener('touchstart', (e) => showTooltip(e, itemElement), { passive: false });
</script>
(set: $backStory to 3)
    <span class="twine-link">[[Very well... Now, let's enter Velthorn Hollow!|VelthornHollowEntry]]</span>
]
    </div>
    </div>
  </div>

    <div class="character-info">
  <h2 class="character-title">Exiled Lantern Tender</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Lantern.png"></div>
    <div class="character-description">
Under the weeping lanterns you walk, a memory stirring of guiding souls at dusk.
You recall the Veil’s thin edge, comforting the lost until one slipped through your grasp.
Shame and sorrow swirl within you like phantom embers around your sputtering light.
Villagers bow their heads as you pass: some in respect, others in fearful pity.
With every step, you vow to redeem your failure… or embrace the darkness you guard.
(click:"Exiled Lantern Tender")[
<!--AJOUTER OBJET-->
    <script>
    // Tableau contenant l'objet à créer
  const newItemData = {
      id: "lantern01",
      nom: "A lantern",
        type: "object",
        intelligence: 2,
      class: "item-img",
      src: "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/Lantern01.png",
      prix: 500,
      rare: "Rare",
      inventory: 19,
    };

   // Création de l'élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute('data-id', newItemData.id);
  itemElement.setAttribute('draggable', 'true');

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory')) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));

  itemElement.addEventListener('mouseenter', (e) => showTooltip(e, itemElement));
  itemElement.addEventListener('touchstart', (e) => showTooltip(e, itemElement), { passive: false });
</script>

(set: $backStory to 4)
    <span class="twine-link">[[Very well... Now, let's enter Velthorn Hollow!|VelthornHollowEntry]]</span>
]
    </div>
    </div>
  </div>


    <div class="character-info">
  <h2 class="character-title">Noble Scion of the Pale Court</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Noble.png"></div>
    <div class="character-description">
You stride past shuttered windows, recalling silken halls and whispered intrigues.
Courtiers once knelt before you: now they avert their eyes and mutter superstitions.
Your ancestral ring weights heavy on your finger, a relic of privileges long gone.
You remember the knife in the dark, betrayal turning allies into ash.
Now, you walk these streets determined to reclaim your legacy… or let it perish.
(click:"Noble Scion of the Pale Court")[
<!--AJOUTER OBJET-->
    <script>
    // Tableau contenant l'objet à créer
  const newItemData = {
      id: "ringNobleScion01",
      nom: "The Scion's Nobles ring",
        type: "object",
        intelligence: 2,
      class: "item-img",
      src: "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/RingNobleScion.png",
      prix: 1000,
      rare: "Rare",
      inventory: 19,
    };

   // Création de l'élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute('data-id', newItemData.id);
  itemElement.setAttribute('draggable', 'true');

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory')) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));

  itemElement.addEventListener('mouseenter', (e) => showTooltip(e, itemElement));
  itemElement.addEventListener('touchstart', (e) => showTooltip(e, itemElement), { passive: false });
</script>
(set: $backStory to 5)
    <span class="twine-link">[[Very well... Now, let's enter Velthorn Hollow!|VelthornHollowEntry]]</span>
]
    </div>
    </div>
  </div>


    <div class="character-info">
  <h2 class="character-title">Last of the Severed</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Severed.png"></div>
    <div class="character-description">
Your footsteps echo on cobbles as flashes of that night blaze behind your eyes.
You recall the Severance Ritual’s searing pain, the moment everyone else was consumed.
Your scarred arm tingles with the echo of shattered souls bound within you.
A hush falls over the village as you pass: it senses the survivor of a forbidden rite.
Today, you seek answers: was your survival salvation… or the world’s greatest sin?
(click:"Last of the Severed")[
<!--AJOUTER OBJET-->
    <script>
    // Tableau contenant l'objet à créer
  const newItemData = {
      id: "RedthreadVeil",
      nom: "The Redthread Veil",
        type: "helmet",
        intelligence: 2,
      class: "item-img",
      src: "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/RedthreadVeil.png",
      prix: 1000,
      rare: "Rare",
      inventory: 19,
    };

   // Création de l'élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute('data-id', newItemData.id);
  itemElement.setAttribute('draggable', 'true');

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory')) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));

  itemElement.addEventListener('mouseenter', (e) => showTooltip(e, itemElement));
  itemElement.addEventListener('touchstart', (e) => showTooltip(e, itemElement), { passive: false });
</script>
(set: $backStory to 6)
    <span class="twine-link">[[Very well... Now, let's enter Velthorn Hollow!|VelthornHollowEntry]]</span>
]
    </div>
    </div>
  </div>


    <div class="character-info">
  <h2 class="character-title">Cultist of the Worm</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Cultist.png"></div>
    <div class="character-description">
Mud squelches beneath your boots as the Worm’s whispers coil in your mind.
You remember the hollow chants, flesh offered in dark ceremonies for unholy gifts.
A hunger stirs in your gut, the parasite’s voice urging you to feed… or perish.
Villagers recoil at your passing, their fear as tangible as the worm’s squeeze.
With each step, you weigh the price of this power: your body’s freedom… or your soul’s.
(click:"Cultist of the Worm")[
<!--AJOUTER OBJET-->
    <script>
    // Tableau contenant l'objet à créer
  const newItemData = {
      id: "WyrmClaspBrooch",
      nom: "A Wyrm-Clasp Brooch",
        type: "object",
        intelligence: 2,
      class: "item-img",
      src: "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Icons/WyrmClaspBrooch.png",
      prix: 1000,
      rare: "Rare",
      inventory: 19,
    };

   // Création de l'élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute('data-id', newItemData.id);
  itemElement.setAttribute('draggable', 'true');

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory')) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));

  itemElement.addEventListener('mouseenter', (e) => showTooltip(e, itemElement));
  itemElement.addEventListener('touchstart', (e) => showTooltip(e, itemElement), { passive: false });
</script>
(set: $backStory to 7)
    <span class="twine-link">[[Very well... Now, let's enter Velthorn Hollow!|VelthornHollowEntry]]</span>
]
    </div>
    </div>
  </div>

    <div class="character-info">
  <h2 class="character-title">Grave Singer</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/GraveSinger.png"></div>
    <div class="character-description">
A distant lament drifts to you on the wind, stirring the song half-forgotten in your bones.
You recall crowds hushed by your bone flute, guiding restless spirits to final rest.
Your own voice once soothed the dead: but could not still your own restless heart.
Now, the echoes of your unfinished melody follow you through silent lanes.
Each stride draws you closer to Widow Marrow’s door, where your song might find its end.
(click:"Grave Singer")[
(set: $backStory to 8)
    <span class="twine-link">[[Very well... Now, let's enter Velthorn Hollow!|VelthornHollowEntry]]</span>
]
    </div>
    </div>
  </div>


    <div class="character-info">
  <h2 class="character-title">Ashen War Veteran</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Veteran.png"></div>
    <div class="character-description">
Your boots crunch on ash-dusted stones as battlefield memories flare in your chest.
You remember the final charge against revenant hordes, shield raised against wave after wave.
A cursed shell fragment still burns beneath your ribs, a trophy of near-fatal valor.
Nightmares bleed into waking hours, turning every shadow into an old enemy.
Today, you walk toward Velthorn Hollow’s gates, ready to face both ghost and memory.
(click:"Ashen War Veteran")[
(set: $backStory to 9)
    <span class="twine-link">[[Very well... Now, let's enter Velthorn Hollow!|VelthornHollowEntry]]</span>
]
    </div>
    </div>
  </div>


    <div class="character-info">
  <h2 class="character-title">Street Orphan of Greyglass</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Orphan.png"></div>
    <div class="character-description">
Your quick steps carry you past fractured mirrors, reflections dancing at the edge of vision.
You recall alleyway scrambles, nimble hands lifting coins from skeletal merchants’ sputtering wares.
Laughter and shards of glass once marked your playground: now they guard your forgotten past.
Your heart races with the thrill of secrets hidden in every cracked window.
With each footfall, you chase the story of who you were…and who you might become.
(click:"Street Orphan of Greyglass")[
(set: $backStory to 10)
    <span class="twine-link">[[Very well... Now, let's enter Velthorn Hollow!|VelthornHollowEntry]]</span>
]
    </div>
    </div>
  </div>


    <div class="character-info">
  <h2 class="character-title">Pilgrim of the Bleeding Monastery</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Pilgrim.png"></div>
    <div class="character-description">
Rain-slick stones guide your path as memories of bloody hymns stir within your mind.
You recall chanting monks, prayers soaked with crimson tears whispering of redemption.
Your prayer beads weigh heavy, each one a memory of faith tested by suffering.
Villagers bow low at your approach, sensing the pilgrim who drank of sacred blood.
Today, you walk on, seeking absolution in secrets the Monastery still guards.
(click:"Pilgrim of the Bleeding Monastery")[
(set: $backStory to 11)
    <span class="twine-link">[[Very well... Now, let's enter Velthorn Hollow!|VelthornHollowEntry]]</span>
]
    </div>
    </div>
  </div>


    <div class="character-info">
  <h2 class="character-title">Returned from the Veil</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Return.png"></div>
    <div class="character-description">
Fog swirls around your boots as you feel the borrowed beat of your own heart.
You died once: then something yanked you back, leaving you half-remembered, half-alive.
Your pale skin still shimmers faintly with otherworldly glow, a mark of that crossing.
Onlookers whisper and stare, sensing the soul that cheated death’s final embrace.
Each step carries you toward Velthorn Hollow… and the debt you must repay for return.
(click:"Returned from the Veil")[
(set: $backStory to 12)
    <span class="twine-link">[[Very well... Now, let's enter Velthorn Hollow!|VelthornHollowEntry]]</span>
]
    </div>
    </div>
  </div>

<script>
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem("characterUnlocked") === "true";
        const characterButton = document.querySelector('.nav-btn[data-panel="skills"]');
        const elementsToHide = document.querySelectorAll('.top-nav, .xp-container, .inventory-sidebar');

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove("disabled-btn");
                characterButton.disabled = false;
            } else {
                characterButton.classList.add("disabled-btn");
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el => {
            el.style.display = characterUnlocked ? "" : "none";
        });
    }

    // Met à jour l'état de l'UI à chaque changement de passage
    $(document).on(':passagerender', function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
</script>


:: BindEnding [ENDING] {"position":"8800,8650","size":"100,100"}
You place each vessel: heart, brain, name: into its pedestal and speak words drawn from your travels and trials. Light surges along the crystal filaments, weaving the three shards of Corvan’s soul into a single radiant tapestry of bone and spirit. Lantern-blue flame washes over the hall, purging corruption and knitting broken wards back together.

Light floods the Court as you bind Corvan’s shattered vessels into a single, whole soul. The Veil shivers and then settles, renewed.

(if: $job is 1)[  
  As a Gravebinder, you sense every spirit’s chains loosen under your hands: you guided their rest once, and now you mend the greatest fracture of all.  
]  
(elseif: $job is 2)[  
  As a Bone-Singer, your melodies still echo in every ossuary: today your final dirge heals the wound Corvan opened, and even the statues seem to sway in silent tribute.  
]  
(elseif: $job is 3)[  
  As a Spellwright, your runes bind flesh and spirit alike: your glyphwork on the pedestals wove Corvan’s shards into harmony where his own magic failed.  
]  
(elseif: $job is 4)[  
  As a Lantern-Tender, your flame guided lost souls here and now your lantern’s glow sealed their fates in lasting peace, beating back the shadows he once unleashed.  
]  
(elseif: $job is 5)[  
  As a Courtier, you understand the weight of lineage: your wise words at each pedestal echoed the ancient rites and restored balance where hubris once ruled.  
]  
(else:)[  
  As a Shadowstrider, you moved unseen through death’s halls: your silent steps on the dais bound the severed, proving that grace need not glare to be strong.  
]

(if: $backStory is 1)[  
  Once the Plagueborn Refugee, you bore loss in your veins: today, that sorrow became strength, and every drop of your Red Fog Serum sealed a wound in Corvan’s soul.  
]  
(elseif: $backStory is 2)[  
  The Graverobber’s Bastard, you unearthed secrets in tombs: now those same secrets unlocked the path to Corvan’s heart, and you laid his pieces to rest with a thief’s tender care.  
]  
(elseif: $backStory is 3)[  
  Apprentice of Death, you spoke to the dead and learned their rites: today your necromantic lore wove life back into Corvan’s fractured mind.  
]  
(elseif: $backStory is 4)[  
  Exiled Lantern Tender, your flame once guided ghosts through darkness: now that very light healed the severed bonds, shepherding Corvan’s soul home.  
]  
(elseif: $backStory is 5)[  
  Noble Scion of the Pale Court, you carried your family’s honor through ruin: today you restored another’s dignity, proving worth is measured by compassion.  
]  
(elseif: $backStory is 6)[  
  Last of the Severed, you know sacrifice’s price: your scars matched Corvan’s own, and your freedom spurred the ritual that fused his broken essence whole.  
]  
(elseif: $backStory is 7)[  
  Cultist of the Worm, you embraced decay’s truth: today that understanding fed the ritual that bound life and death in unity.  
]  
(elseif: $backStory is 8)[  
  Grave Singer, your dirge once unchained sorrow: now your final melody sealed Corvan’s spirits in peaceful rest.  
]  
(elseif: $backStory is 9)[  
  Ashen War Veteran, your steel-forged will endured horrors: today that resolve hammered Corvan’s shards back into a single, unbreakable core.  
]  
(elseif: $backStory is 10)[  
  Orphan of Greyglass, you carved hope in dark alleys: today you carved the missing pieces of Corvan’s soul, proving that even the lost can heal great wounds.  
]  
(elseif: $backStory is 11)[  
  Pilgrim of the Bleeding Monastery, your prayers soothed torment: today those same prayers wove the final incantation to bind Corvan’s essence.  
]  
(else:)[  
  Returned from the Veil, you walked between worlds: today you guided Corvan across the threshold, sealing the breach with your ghost-borne insight.  
]

As the ritual completes, your vision blurs. You collapse at the foot of the dais, only to awaken outside the Cemetery Gate at dawn’s first light. Your wounds are healed, and the Red Fog Serum in your veins grants you a faint aura of calm vitality. You find in your pack a single crystal heart shard: a gift from Corvan’s spirit, now at peace.

Velthorn Hollow Renewed
In the days that follow, the village stirs with hopeful energy. The sap-drunk mugs at the Mourning Oak Inn no longer bring nightmares but consoling dreams of loved ones. The Weeping Lantern Arch’s tears run clear, and the hidden grate to the Mortuary Hall remains: but no restless spirit hounds the square at night. Graveyards bloom with ghost-orchids once more, and for the first time in decades, townsfolk whisper of rebuilding.

The Necropolis Transformed
The Mortuary Hall’s wards glow gently instead of glaring. Catacomb corridors cease to twist, and living statues stand mute sentinel rather than attack. The River of Forgotten Names still flows, but its ferryman now guides willing souls to their rightful rest. You are remembered as the “Binder of Shards,” honored with a quiet niche in the Lantern-lit Gallery: your lantern forever burning as a beacon for lost spirits.

A New Balance
By mending Corvan’s fractured soul rather than destroying it, you restore the natural order: death remains death, and the veil between worlds is neither rent nor overshadowed by a new tyrant. You carry Corvan’s final blessing in your heart, a promise that grief and hubris can be healed, not simply ended.

(set:$currentEnding to 1)
(display:"RestartDonnee")

{
<script>
setTimeout(() => {
  gainXp(2000);
}, "1000");
</script>
}


:: BoneStackedShrineArrival [NEXUS] {"position":"550,650","size":"100,100"}
You enter the **Bone-Stacked Shrine**, where piles of skulls and femurs form a jagged altar. A dry wind rattles the bones like sad chimes, and distant, half-heard chanting stirs the air. From time to time, the skull‑chimes ring of their own accord: resonating like the distant echoes heard in the Gallery of Weeping Effigies. A sort of sad and beautiful song if you care for that sort of thing.

What do you do?  
* [[Balance a skull on your head for “intimidation practice”|BSSStupidChoice]]  
* [[Offer a prayer at the altar|BSSDefaultInteraction]]  
* (if: $job is 3)[[Invoke your Boneguard Stance to fortify the shrine’s wards|BSSOssuaryKnight]]  
* (if: $backStory is 9)[[Recognize the war sigil on a femur and claim your old helmet|BSSBS9Veteran]]  
* [[Return to the square|VelthornHollowOrientation]]
(if:$shrineTreasure is true)[
* [[look for the treasure the whispers talked about...|BSSTrap]]
]


:: BrainAskSacrifice {"position":"3700,6300","size":"100,100"}
\:: BrainAskSacrifice
**You:** “What sacrifice?”  
**Brain:** “Your life’s essence… or my chains remain.”  
* [[Offer your own essence|BrainOfferEssence]]  
* [[Refuse and attack|BrainAttack]]


:: BrainAskWhy {"position":"2737.5,6625","size":"100,100"}
\:: BrainAskWhy
**You:** “Why are you bound here?”  
**Brain:** “I defied Death itself. My vessel became vault, my mind its ward.”  
* [[Probe for a weakness|BrainProbe]]  
* [[Step back, thoughtful|InnerSanctumEntry]]


:: BrainAttack {"position":"3475,6600","size":"100,100"}
\:: BrainAttack
You draw your weapon and strike at the filaments. The brain’s psychic scream rattles your mind: (WIS save DC 15 or lose 2 health).  
* [[Press the attack|BrainAttack2]]  
* [[Reconsider your approach|InnerSanctumEntry]]


:: BrainAttack2 {"position":"3500,6825","size":"100,100"}
\:: BrainAttack2
Your blow severs one filament. The brain convulses, then stabilizes. Another filament flares bright.  
* [[Strike again|BrainAttackLoop]]  
* [[Retreat, wounded|InnerSanctumEntry]]


:: BrainAttackLoop {"position":"3300,6900","size":"100,100"}
\:: BrainAttackLoop
You slash at the floating brain’s silver filaments again and again. Each strike severs one strand, but two more flare back to life. The brain’s psychic scream rattles your mind.  
(health: DAMAGE 1)  
* [[Strike again|BrainAttack2]]  
* [[Reconsider your approach|InnerSanctumEntry]]


:: BrainCollapse {"position":"4275,6100","size":"100,100"}
\:: BrainCollapse
Your vision darkens, and you slump against the ground.  
* [[Continue|DreamVision]]


:: BrainDemandRelease {"position":"2862.5,6625","size":"100,100"}
\:: BrainDemandRelease
**You:** “Free me, then I’ll free you.”  
**Brain:** “Freedom demands sacrifice.”  
* [[Ask what sacrifice|BrainAskSacrifice]]  
* [[Retreat into silence|InnerSanctumEntry]]


:: BrainFreed {"position":"4200,5850","size":"100,100"}
\:: BrainFreed
The filaments dissolve. The brain hovers, silent and still.  
**Brain:** “You have done what none dared. Rest now… your journey continues.”  
* [[Step forward and touch the brain|BrainTouchFinal]]  
* [[Collapse from exhaustion|BrainCollapse]]


:: BrainListen {"position":"2987.5,6625","size":"100,100"}
\:: BrainListen
The chamber hums as the brain murmurs fragments: “Blood… ritual… heart’s bond… sever once…”  
* [[Press for clarity|BrainProbe]]  
* [[Step away|InnerSanctumEntry]]


:: BrainOfferEssence {"position":"3900,6525","size":"100,100"}
\:: BrainOfferEssence
You step forward, resolve hardening. “I’ll give you my life to end this.”  
The brain’s glow flares:  
**Brain:** “Then bleed for your cause…”  
* [[Prepare to sacrifice (CONFIRM)|BrainSacrifice]]


:: BrainProbe {"position":"3550,6000","size":"100,100"}
\:: BrainProbe
**You:** “How can I break your wards?”  
**Brain:** “Only one who embraced rot and blood may sever the bond.”  
* [[Recall your Red Fog Serum|BrainRecallSerum]]  
* [[Search for a ritual clue|SanctumSearch]]


:: BrainRecallSerum {"position":"3625,5725","size":"100,100"}
\:: BrainRecallSerum
You remember the Red Fog Serum in your pack: once used to breach plague wards.  
* [[Pour the serum at the brain’s base|BrainUseSerum]]  
* [[Hold back and choose differently|InnerSanctumEntry]]


:: BrainSacrifice {"position":"4225,6475","size":"100,100"}
\:: BrainSacrifice
You hold your hand over the brain. Some strange electrical streks spreads from your palm as you bleed into the filaments. The brain’s cage fractures: and you collapse as wards break.  You hear a voice screaming, a voice that you instantly recognize as Magister Corvan.
* [[Instead of dying electrocuted, you feel yourself slipping into a soft dream|DreamVision]]


:: BrainSpeak {"position":"2737.5,6375","size":"100,100"}
\:: BrainSpeak
**You:** “Corvan? Can you hear me?”  
The brain’s pulse slows, then speaks in a distant whisper:  
**Brain:** “Mortal… you dare intrude.”  
* [[Ask why he is trapped here|BrainAskWhy]]  
* [[Demand he release you|BrainDemandRelease]]  
* [[Remain silent and listen|BrainListen]]


:: BrainTouchFinal {"position":"4450,5950","size":"100,100"}
\:: BrainTouchFinal
Your fingers brush the brain’s surface. A flash of knowledge floods you: secrets of life and death intertwine.  
A city of Progress, in a time where evrything seems possible. But is progress such a good thing? What if it costed you everything? Wouldn't you be better off leaving this monstruous reality?
You pray you can, one day, forget all the twisted thoughts and memories that overwhealm you. 
(set: $journal to it + (a: "I received fragments of Corvan's secrets."+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(1000);
}, "1000");
</script>
}
* [[You feel yourself growing weak…|BrainCollapse]]


:: BrainUseSerum {"position":"3925,5800","size":"100,100"}
\:: BrainUseSerum
You uncork the serum and let the red mist swirl around the filaments. They sizzle and snap: ward magic shatters with a scream of release.  
* [[Step back as the brain floats free|BrainFreed]]


:: CORVAN {"position":"1850,125","size":"100,100"}
Moral ambiguity: The “villain” might be the only one trying to fix a dying world.

Corvan was a member of the Hermetic Order of the Sable Rose when he lived in Paris, around 1920.


:: CRPBS10Orphan {"position":"1925,1950","size":"100,100"}
\:: CRPBS10Orphan
In the fractured reflections, you see the alleys of Greyglass and your younger self darting through shadows. For a moment, your heart lifts: and you gain +1 to your charisma.  
(set: $charisma to it + 1)  
* [[Let the memory fade and step back|CrackedReflectionPoolArrival]]


:: CRPDefaultInteraction {"position":"1675,1950","size":"100,100"}
Leaning over the water, your reflection shatters into dozens of versions of yourself: some dead, some living. A soft sob escapes your lips as you glimpse your fears and hopes entwined. 
(click:"fears and hopes entwined")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $charisma >= $diceRoll)
    [The water seems to understand you... and react. A small ripple brings a health potion to the shore, right between your feet.
    <!-- ADD HEALTH POTION -->
    ]
(else:)
    [The scene is beautiful, but silent, dead. You are not welcomed here.
    ]

 ]
 ]
As the ripples settle, you glimpse distant marble steps beyond the pool: scenes that match the description of the lower levels of the legendary Mirror‑Vault far beneath the Ossuary’s main rotunda of the Necropolis.
* [[Step back, unsettled|VelthornHollowOrientation]]


:: CRPStupidChoice [ENDING] {"position":"1550,1950","size":"100,100"}
{
(set:$introText to "You step forward and plunge your foot into the cold water… and immediately regret it as spectral frostbite numbs your toes.  ")
(set:$clickTest to "numbs your toes")
(set:$AttributeTest to $strength)
(set:$SuccessText to "You yank your foot free in an instant: your boot’s leather scorched but your toes unharmed. The spectral chill recedes as mist curls away into the darkness.")
(set:$FailureText to "You jerk your foot back, but not before icy shards bite into your flesh: pain blossoms across your toes as you stagger, hobbling away with frostbitten agony.")
(set:$clickDamage to "agony")
(set:$damageType to 2)
(set:$DeathText to "The icy current sears through your boot and up your leg in an instant. Pain blossoms like frozen daggers along every nerve, and before you can yank your foot free, the spectral frost spreads into your body: cracking bone and freezing your blood. You gasp as the cold steals your breath, and in a final shudder, your vision flickers out like a lantern snuffed by an unseen wind.")
(set:$currentEnding to 26)
(set:$LinkText to "Put your shoes back and stand up")
(set:$FailureLinkText to "Withdraw and shake your foot")
(set:$Link to "CrackedReflectionPoolArrival")

(set:$xpSuccess to 35)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:"MacroPassage")


:: CRPWhispered {"position":"1800,1950","size":"100,100"}
\:: CRPWhispered
You vanish in a swirl of mist and step onto the other side of the mirror. There, a hidden alcove holds a **Silvered Dagger**, perfect for cutting through spiritual bonds.  
(set: $inventory to it + “Silvered Dagger”)  

After close inspection, the alcove has an old and partially rusted door that was conceled. The opening seems to be protected from your abilities. But you can try to pry it open if you have the strengh to do so...

(click:"strengh to do so...")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strengh >= $diceRoll)
    [
After alot of trial and error, you manage to find how to place your body to best push the opening. After the deed is done, you find a narrow tunnel carved into the stone’s underside: leading directly toward vaulted crypt doors.
* [[Gather your courage and open the doors|CryptEntry]]  
* [[Return to the square|VelthornHollowOrientation]]
    ]
(else:)
    [
    No... you just can't move the door..
* [[Return to the pool’s edge|CrackedReflectionPoolArrival]]
* [[Return to the square|VelthornHollowOrientation]]
    ]
]
 ]





:: CartwayArrival [NEXUS] {"position":"1025,10600","size":"100,100"}
(set: $backStory to 10)
(set:$cryptKey to true)
\:: CartwayArrival
You step onto the Forgotten Cartway: rusty rails lead beneath collapsed mausoleums, half‑buried carts lined with broken skull‑racks. Damp moss clings to the walls, and the distant drip of water echoes like footsteps.  
What do you do?  
* [[Inspect a derailed cart car|CartwayInspectCart]]  
* [[Follow the moss‑covered rails forward|CartwayFollowRails]]  
* [[Search the tunnel walls for markings|CartwaySearchWalls]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 10)[  
As you round a bend, something catches your eye: a flash of pale chalk beneath a thick patch of moss on the stone wall.  
  * [[Drawn to that flash of white, you kneel and clear the moss away to reveal familiar graffiti: you once carved these letters as a child in Greyglass.|CartwayOrphanTrigger]]  
]



:: CartwayAscend {"position":"462.5,10850","size":"100,100"}
\:: CartwayAscend
You clamber up the rails. The tunnel hums with distant chanting. A shaft of pale lantern light beckons above.  
* [[Climb toward the light|CartwayLightShaft]]  
* [[Descend back down|CartwayArrival]]


:: CartwayBottomStair {"position":"600,11125","size":"100,100"}
\:: CartwayBottomStair
At the stair’s end a heavy iron door sealed with Corvan’s tri‑burial sigil bars your path. A faint pulse vibrates through the metal.  
* [[Push the door open|CartwayOpenVaultDoor]]  
* [[Pause to ready yourself|CartwayPrepare]]



:: CartwayDeepTunnel {"position":"700,11300","size":"100,100"}
\:: CartwayDeepTunnel
The downward track levels into a long, narrow tunnel; the air hangs heavy with mist and the walls glisten with phosphorescent moss. The rusted rails vanish beneath ankle‑deep mud, and the drip of water echoes like distant footsteps. Ahead, you glimpse a square iron grate set into the floor.  
* [[Inspect the grate|CartwayInspectGrate]]  
* [[Press onward through the mud|CartwayPressOn]]  
* [[Climb back up to the rails|CartwayArrival]]



:: CartwayDescend {"position":"300,11075","size":"100,100"}
\:: CartwayDescend
The downward track dips steeply. Your foot slips on slick moss: (DEX save DC 12 or lose 1 health).  
* [[Regain footing and press on|CartwayDeepTunnel]]  
* [[Climb back up the rails|CartwayArrival]]


:: CartwayDescendStair {"position":"900,11000","size":"100,100"}
\:: CartwayDescendStair
The stair winds down beneath the mausoleum’s foundations. Faint echoes of your younger laughter linger in the gloom. The short stair deposits you onto cold marble at the base of a torch‑lit corridor: its iron door carved with the tri‑burial sigil stands open and seems to lead to a sort of reinforced vault.  

* [[Step forward into the vault entrance|VaultEntrance]]  
* [[Escape back to the cartway|CartwayArrival]]



:: CartwayFollowRails {"position":"275,10725","size":"100,100"}
\:: CartwayFollowRails
You walk the rails, water dripping from the vaulted ceiling. The rails split ahead: one path rises, the other descends into deeper blackness.  
* [[Take the downward track|CartwayDescend]]  
* [[Climb the upward incline|CartwayAscend]]


:: CartwayInspectCart {"position":"150,10725","size":"100,100"}
\:: CartwayInspectCart
You lean into a tilted cart car. Broken bone hooks rattle under your hand, sending a chill through your spine.  
* [[Close the cart and back off|CartwayArrival]]  
* [[Peer deeper into the darkness beneath|CartwayPeerBelow]]


:: CartwayInspectGrate {"position":"350,11475","size":"100,100"}
\:: CartwayInspectGrate
You kneel beside the grate. Its iron bars bear the imprint of a key: one you once found in this labyrinth. Through the slats you see a faint lantern‑blue glow.  
(if: $inventory contains “Rusted Crypt Key”)[  
(set:$cryptKey to true)
  * [[Use the Rusted Crypt Key to unlatch it|CartwayOpenGrate]]  
][else:  
  * [[You lack the correct key: step back|CartwayDeepTunnel]]  
]


:: CartwayLightShaft {"position":"462.5,10975","size":"100,100"}
\:: CartwayLightShaft
You climb toward the shaft. Moon‑blue light filters down, revealing runes carved in the arch above: “Only the lost find their way.”  
* [[Step through the opening|CartwayOpenVaultDoor]]  
* [[Return below|CartwayArrival]]


:: CartwayOpenGrate {"position":"700,10875","size":"100,100"}


(if:$cryptKey is true)[
\:: CartwayOpenGrate
You fit the Rusted Crypt Key into the grate’s lock. With a heavy clank, the bars unlatch, and the grate lifts away. A short stair slopes down into an iron‑lined passage.  
* [[Descend the hidden stair|CartwayDescendStair]]  
* [[Step through directly to the vault threshold|VaultEntrance]]
]
(else:)[
\:: CartwayOpenGrate
You force the grate open. Beyond lies a narrow stair descending into bone‑lined walls.  
* [[Descend the hidden stair|CartwayDescendStair]]  
* [[Close the grate and reconsider|CartwayArrival]]
]


:: CartwayOpenVaultDoor {"position":"925,11200","size":"100,100"}
\:: CartwayOpenVaultDoor
The iron door groans as it swings inward, revealing a corridor bathed in lantern‑blue glow: the entrance to Corvan’s sealed vault.  
* [[Step forward into the vault entrance|VaultEntrance]]  
* [[Hesitate, breath catching|CartwayPrepare]]


:: CartwayOrphanTrigger {"position":"525,10725","size":"100,100"}
\:: CartwayOrphanTrigger
The chalk arrow leads to a moss‑clad grate. Through its bars you glimpse a spiral stair glowing with blue lantern‑light: your childhood expeditions flash in your mind.  
* [[Prise open the grate|CartwayOpenGrate]]  
* [[Step back in wonder|CartwayArrival]]


:: CartwayPeerBelow {"position":"150,10850","size":"100,100"}
\:: CartwayPeerBelow
A faint glow pulses where the rails vanish into rubble. Something scurries away: too quick for you to see.  
* [[Move closer toward the glow|CartwayFollowRails]]  
* [[Step back warily|CartwayArrival]]


:: CartwayPrepare {"position":"1175,11175","size":"100,100"}
\:: CartwayPrepare
You steady your heart and check your gear. Beyond lies the Brain Reliquary, buried behind wards you’re now poised to breach.  
* [[Open the door|VaultEntrance]]  
* [[Step back for one last look|CartwayArrival]]


:: CartwayPressOn {"position":"600,11475","size":"100,100"}
\:: CartwayPressOn
You trudge through the mud, each step sucking at your boots. The tunnel narrows until you must squeeze past a slick wall. As you do, a hidden lever clicks beneath your elbow.  
* [[Pull the lever|CartwayRevealSidePassage]]  
* [[Ignore it and move forward|CartwayBottomStair]]


:: CartwayRevealSidePassage {"position":"925,11500","size":"100,100"}
\:: CartwayRevealSidePassage
The lever shifts a section of wall, revealing a narrow side‑passage lit by a single blue lantern. A faint pulse echoes from within.  
* [[Enter the side‑passage|CartwaySidePassage]]  
* [[Leave it and continue down the main tunnel|CartwayBottomStair]]


:: CartwaySearchWalls {"position":"400,10625","size":"100,100"}
\:: CartwaySearchWalls
Your hands brush over damp stone. Faint chalk marks form an arrow pointing deeper underground. You recognize the scrawl: your own handiwork from Greyglass.  
* [[Follow the arrow very carefully|CartwayOrphanTrigger]]  
* [[Ignore it and keep exploring|CartwayFollowRails]]


:: CartwaySidePassage {"position":"675,11775","size":"100,100"}
\:: CartwaySidePassage
You step into the side‑passage; its walls are carved with miniature funeral wagons. At its end, an iron door bearing Corvan’s tri‑burial sigil waits.  
* [[Prepare to open the door|CartwayPrepare]]  
* [[Return to the main tunnel|CartwayDeepTunnel]]


:: CatacombsBastardFollow {"position":"850,6100","size":"100,100"}
\:: CatacombsBastardFollow
You track the tool marks deeper into the vault. The grooves end at a loose stone shelf covered in your old marking: a crudely carved “B.”  
* [[Lift the shelf slab|CatacombsBastardReveal]]  
* [[Step back, nervous|MorgueCatacombsArrival]]


:: CatacombsBastardInspectKey {"position":"850,6350","size":"100,100"}
\:: CatacombsBastardInspectKey
The key bears your childhood “B” brand: a mark you thought lost. A surge of guilt and pride war within you.  
(set: $flags to it + “BastardKeyFound”)  
* [[Use the key on the nearby gate|CatacombsBastardUseKey]]  
* [[Hide it and step away|MorgueCatacombsArrival]]


:: CatacombsBastardReveal {"position":"850,6225","size":"100,100"}
\:: CatacombsBastardReveal
Beneath the slab lies a small alcove containing a rusted key taped to the bone shelf tag. Your old moniker is carved beside it.  
(set: $inventory to it + “Rusty Catacombs Key”)  
* [[Pocket the key|CatacombsBastardUseKey]]  
* [[Inspect it further|CatacombsBastardInspectKey]]


:: CatacombsBastardTrigger {"position":"725,5975","size":"100,100"}
\:: CatacombsBastardTrigger
Your fingertips brush familiar tool‑marks on the shelf edge: precise chisel grooves only a Bonepicker would leave. Memories of your first clandestine grave dig flood back.  
* [[Follow the grooves along the wall|CatacombsBastardFollow]]  
* [[Shake off the memory|MorgueCatacombsArrival]]


:: CatacombsBastardUseKey {"position":"1100,6200","size":"100,100"}
\:: CatacombsBastardUseKey
You insert the key into a barred gate set into the far wall. With a heavy click, it unlocks. Beyond is a steep stair descending into deeper catacombs… and closer to the Brain Reliquary.  
* [[Descend the stair|CatacombsDeepStairs]]  
* [[Return to exploring the vaults|MorgueCatacombsArrival]]


:: CatacombsCombatCorpse {"position":"350,6175","size":"100,100"}
\:: CatacombsCombatCorpse
You hack at the animated corpse. It falls back into stillness, but you’re shaken, and your blood chills.  
(set: $health to it - 2)  
* [[Catch your breath|MorgueCatacombsArrival]]


:: CatacombsDeepCorridor {"position":"1425,5950","size":"100,100"}
\:: CatacombsDeepCorridor
You emerge into a narrower gallery, the air thicker with necrotic chill. Ahead, a vault door sealed with Corvan’s tri‑burial sigil stands waiting.  
* [[Prepare to unlock the door|VaultEntrance]]  
* [[Hesitate, pondering your next move|MorgueCatacombsArrival]]


:: CatacombsDeepStairs {"position":"1275,6075","size":"100,100"}
\:: CatacombsDeepStairs
The steps wind down, slick with frost. Faint lantern‑blue glow reveals carved ossuary reliefs overhead.  
* [[Press on into the darkness|CatacombsDeepCorridor]]  
* [[Climb back up for now|MorgueCatacombsArrival]]


:: CatacombsInspectRunes {"position":"600,5975","size":"100,100"}
\:: CatacombsInspectRunes
The wall runes spell out burial rites in an archaic script. A single phrase stands out: “Bones remember the hand that placed them.”  
* [[Trace the phrase with your finger|CatacombsTraceRunes]]  
* [[Leave them be|MorgueCatacombsArrival]]


:: CatacombsListen {"position":"500,5825","size":"100,100"}
\:: CatacombsListen
You press your ear to the cold stone. A soft scraping echoes around you: something shifts on the next shelf.  
* [[Investigate the sound|CatacombsOpenTag]]  
* [[Step away quietly|MorgueCatacombsArrival]]


:: CatacombsOpenTag {"position":"350,5975","size":"100,100"}
\:: CatacombsOpenTag
You pry open the nearest corpse’s tag. The glove twitches; frost cracks along the bone. The body shudders to life!  
* [[Defend yourself (draw weapon)|CatacombsCombatCorpse]]  
* [[Flee down the corridor|MorgueCatacombsArrival]]


:: CatacombsTraceRunes {"position":"625,6125","size":"100,100"}
\:: CatacombsTraceRunes
Cold energy pulses beneath your touch. You see a phantom hand arranging bones: then the vision fades.  
(set: $journal to it + (a: "I had a vision of a phantom hand arranging bones"+ "\n\n"))
* [[Step back|MorgueCatacombsArrival]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}


:: ChapelBoneTunnel {"position":"3825,10025","size":"100,100"}
\:: ChapelBoneTunnel
The bone‑lined tunnel glows faintly with bioluminescent mold. Ahead, a heavy iron door bears Corvan’s tri‑burial sigil.  
* [[Approach the door|ChapelVaultDoor]]  
* [[Pause to check your gear|ChapelPrepare]]


:: ChapelCultistTrigger {"position":"2950,10025","size":"100,100"}
\:: ChapelCultistTrigger
You lay your cult fetish: a small carved worm: upon the altar’s bloodstain. The dried blood liquefies and forms a rune that matches your ritual scar.  
* [[Speak the Worm’s Invocation|ChapelInvokeWorm]]  
* [[Pull the fetish back|OssuaryChapelArrival]]


:: ChapelDescendStair {"position":"2700,10525","size":"100,100"}
\:: ChapelDescendStair
The spiral stair winds down into darkness, each step carved from polished femurs. A chill mist drifts upward.  
* [[Press on toward the faint glow below|ChapelBoneTunnel]]  
* [[Climb back up|OssuaryChapelArrival]]


:: ChapelExamineStatue {"position":"2700,10025","size":"100,100"}
\:: ChapelExamineStatue
A massive bone statue of a hooded figure stands behind the altar. Its hollow eye‑sockets glow faintly.  
* [[Touch its foot to test its magic|ChapelStatueTouch]]  
* [[Step back respectfully|OssuaryChapelArrival]]


:: ChapelInvokeWorm {"position":"2950,10150","size":"100,100"}
\:: ChapelInvokeWorm
You intone the ancient chant. The altar trembles, then cracks open at its base, revealing a bone‑lined corridor beyond.  
* [[Enter the ritual passage|ChapelRitualPassage]]  
* [[Step back, awed|OssuaryChapelArrival]]


:: ChapelOpenVaultDoor {"position":"4200,10025","size":"100,100"}
\:: ChapelOpenVaultDoor
You turn the bone key. The lock releases with a resonant clang, and the door swings open onto torchlit vault corridors.  
* [[Step through into Corvan’s sealed vault|VaultEntrance]]  
* [[Pause to gather courage|ChapelPrepare]]


:: ChapelPray {"position":"2575,10025","size":"100,100"}
\:: ChapelPray
You kneel before the altar and whisper a prayer. A cold wind rustles through the bones overhead, and you feel unseen eyes upon you.  
* [[Rise and continue exploring|OssuaryChapelArrival]]


:: ChapelPrepare {"position":"4075,10025","size":"100,100"}
\:: ChapelPrepare
You steady your breath, checking your fetish and wards. Ahead lies the final sealed way to Corvan’s brain reliquary.  
* [[Push forward into the vault entrance|VaultEntrance]]  
* [[Step back for a moment of prayer|OssuaryChapelArrival]]


:: ChapelRevealKeyhole {"position":"2700,10275","size":"100,100"}
\:: ChapelRevealKeyhole
The panel slides open to reveal a bone‑crafted keyhole. Something clangs within the altar: a hidden lock awaits.  
* [[Search your inventory for a key|ChapelUseKey]]  
* [[Step away|OssuaryChapelArrival]]


:: ChapelRitualPassage {"position":"2950,10275","size":"100,100"}
\:: ChapelRitualPassage
You slip through the opening and step into a narrow hallway lined with rib arches. The air hums with Worm’s power.  
* [[Follow the hall’s curve|ChapelBoneTunnel]]  
* [[Hesitate at the entrance|OssuaryChapelArrival]]


:: ChapelSearchBones {"position":"2825,10025","size":"100,100"}
\:: ChapelSearchBones
You sift through scattered bones at the altar’s base. Under a femur you find a small bone key wrapped in sinew.  
(set: $inventory to it + “Bone Chapel Key”)  
* [[Pocket the key|OssuaryChapelArrival]]  
* [[Continue searching|OssuaryChapelArrival]]


:: ChapelStatueTouch {"position":"2700,10150","size":"100,100"}
\:: ChapelStatueTouch
At your touch, the statue’s runic inscription pulses: “Bound by blood, servant of the bone.” A secret panel at its base clicks.  
* [[Open the panel|ChapelRevealKeyhole]]  
* [[Withdraw your hand|OssuaryChapelArrival]]


:: ChapelStudySigil {"position":"3825,10275","size":"100,100"}
\:: ChapelStudySigil
The tri‑burial loops mirror the Worm’s spiral: and your fetish’s carvings. You sense the door will yield only to those bound by worm‑rite.  
* [[Insert the Bone Chapel Key|ChapelOpenVaultDoor]]  
* [[Step back, breath catching|OssuaryChapelArrival]]


:: ChapelUseKey {"position":"2700,10400","size":"100,100"}
\:: ChapelUseKey
(if: $inventory contains “Bone Chapel Key”)[  
  You insert the bone key into the altar’s lock. With a grinding click, stones shift to reveal a narrow stair spiraling down.  
  * [[Descend the hidden stair|ChapelDescendStair]]  
][else:  
  You have no key that fits. The keyhole remains silent and dark.  
]  
* [[Step away|OssuaryChapelArrival]]


:: ChapelVaultDoor {"position":"3825,10150","size":"100,100"}
\:: ChapelVaultDoor
You stand before the iron door. A small keyhole at its center waits for the Bone Chapel Key.  
* [[Use the Bone Chapel Key|ChapelOpenVaultDoor]]  
* [[Study the sigil’s loops|ChapelStudySigil]]


:: CharacterClass {"position":"2300,1300","size":"100,100"}
This world is full of wonders. But the most distrubing thing, by far, is the job diversity. You could say it is a calling, a sacred duty more than a mere ... Fortunatly, because you don't even get paid for all your hard labor).

Let's see :

⚰️ 1. Gravebinder
Role: Necromantic Warden / Controller

Description: You are one of the Gravebinders: those who enforce the bindings upon the dead. You wield chains and runes that tether souls to their tombs… or drag them back.

Stats:

STR: 12

DEX: 10

CON: 14

INT: 14

WIS: 16

CHA: 8

Special Abilities:

Soul Chain: Bind a nearby undead to stop its movement.

Seal of Rest: Prevents corpses from rising again.

Armor/Weapons: Heavy iron chains, rune-etched manacles.

Playstyle: Control enemies, prevent resurrection, strong defense against undead.

🔥 2. Lantern Bearer
Role: Guide / Light-Bringer / Support

Description: Bearers of the sacred Lanterns, they guide souls to the Veil: or away from it. Some say the lanterns themselves whisper truths from beyond.

Stats:

STR: 10

DEX: 12

CON: 12

INT: 14

WIS: 16

CHA: 14

Special Abilities:

Lantern Light: Illuminates hidden ghosts and weakens wraiths.

Soul Passage: Speak to spirits; gain clues or boons.

Armor/Weapons: Light chainmail, relic lantern, staff.

Playstyle: Support, illumination of hidden threats, spirit diplomacy.

⚔️ 3. Ossuary Knight
Role: Tank / Frontline Fighter

Description: Sworn to the Orders that guard the bone-pits and necropolises. Clad in armor crafted from sanctified bones, they are bastions against the tide of the restless dead.

Stats:

STR: 16

DEX: 10

CON: 16

INT: 8

WIS: 12

CHA: 10

Special Abilities:

Boneguard Stance: Increases defense when stationary.

Hammer of Sanctity: Deals extra damage to undead.

Armor/Weapons: Bone-forged plate armor, sanctified warhammer or maul.

Playstyle: Frontline tank, area control, anti-undead damage dealer.

🕯️ 4. Whispered
Role: Stealth / Assassin / Scout

Description: Silent killers who learned to walk the gravepaths and shadow-ways. They steal secrets from the dead… and lives from the living.

Stats:

STR: 10

DEX: 16

CON: 12

INT: 14

WIS: 12

CHA: 12

Special Abilities:

Ghost Step: Temporary invisibility against undead.

Silent Knife: Backstab bonuses; critical strikes cause silence.

Armor/Weapons: Light leathers, bone daggers, silence dust.

Playstyle: High mobility, stealth kills, infiltration.

📜 5. Pale Scholar
Role: Caster / Lore Master

Description: Archivists of death, readers of forgotten rites. They inscribe spells on flesh and wield bone wands to command death and life alike.

Stats:

STR: 8

DEX: 12

CON: 10

INT: 18

WIS: 16

CHA: 10

Special Abilities:

Runes of Severance: Weakens undead defenses.

Bone Scribe: Craft magical wards, traps, and talismans.

Armor/Weapons: Scholar’s robes, bone wand, rune-etched scrolls.

Playstyle: Spells, summoning, wards, knowledge-based solutions.

🩸 6. Exhumed
Role: Hybrid Fighter / Cursed Berserker

Description: You were dead. You clawed your way back. Part corpse, part human, the Exhumed burn their second lives for strength… but the grave always calls.

Stats:

STR: 16

DEX: 14

CON: 14

INT: 8

WIS: 10

CHA: 8

Special Abilities:

Death Surge: Sacrifice health for massive damage.

Grave Hunger: Regenerate by feasting on enemies.

Armor/Weapons: Rotten flesh armor, grave iron weapons.

Playstyle: High-risk melee DPS, self-sustain, terrifying presence.


:: ChooseStatue {"position":"9050,7075","size":"200,100"}
<!--(set: $backStory to 2)-->
\:: ChooseStatue
Twelve statues stand in a half-circle. Each bears the imagery of a past life: a ruined mask, a cracked key, a bleeding chalice, a worm coiled in bone, and more. You must touch the one that reflects your history.
{
(if: $backStory is 1)[  
  * [[Touch the statue marked by a blood-soaked mask|StatueRefugee]]  
]  
(else:)[  
  * [[Touch the statue marked by a blood-soaked mask|StatueWrong1]]  
]

(if: $backStory is 2)[  
  * [[Touch the statue holding a rusted hook|StatueBastard]]  
]  
(else: )[ 
  * [[Touch the statue holding a rusted hook|StatueWrong2]]  
]

(if: $backStory is 3)[  
  * [[Touch the statue cradling a single skull|StatueNecromancer]]  
]  
(else: )[
  * [[Touch the statue cradling a single skull|StatueWrong3]]  
]

(if: $backStory is 4)[  
  * [[Touch the statue bearing a lantern-flame|StatueLanternTender]]  
]  
(else:  )[
  * [[Touch the statue bearing a lantern-flame|StatueWrong4]]  
]

(if: $backStory is 5)[  
  * [[Touch the statue crowned with ice|StatueScion]]  
]  
(else:  )[
  * [[Touch the statue crowned with ice|StatueWrong5]]  
]

(if: $backStory is 6)[  
  * [[Touch the statue shackled in chains|StatueSevered]]  
]  
(else:  )[
  * [[Touch the statue shackled in chains|StatueWrong6]]  
]

(if: $backStory is 7)[  
  * [[Touch the statue with a coiled worm|StatueCultist]]  
]  
(else:  )[
  * [[Touch the statue with a coiled worm|StatueWrong7]]  
]

(if: $backStory is 8)[  
  * [[Touch the statue holding a bone flute|StatueSinger]]  
]  
(else:  )[
  * [[Touch the statue holding a bone flute|StatueWrong8]]  
]

(if: $backStory is 9)[  
  * [[Touch the statue bearing a charred standard|StatueVeteran]]  
]  
(else:  )[
  * [[Touch the statue bearing a charred standard|StatueWrong9]]  
]

(if: $backStory is 10)[  
  * [[Touch the statue with tiny shackled feet|StatueOrphan]]  
]  
(else:  )[
  * [[Touch the statue with tiny shackled feet|StatueWrong10]]  
]

(if: $backStory is 11)[  
  * [[Touch the statue kneeling before a chalice|StatuePilgrim]]  
]  
(else:  )[
  * [[Touch the statue kneeling before a chalice|StatueWrong11]]  
]

(if: $backStory is 12)[  
  * [[Touch the transparent, star-glimmering statue|StatueReturned]]  
]  
(else:  )[
  * [[Touch the transparent, star-glimmering statue|StatueWrong12]]  
]
}


:: Classes {"position":"2725,825","size":"100,100"}
<h1> <center>Choose your class... </center></h1><br>
<div class="character-info">
  <h2 class="character-title">Gravebinder</h2>
  <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/GraveBinder.png"></div>

    <div class="character-description">
You are $heroNameGravebinder, once the chief ritualist at the Silent Orders. In life, you oversaw the binding of restless spirits, but hesitation during your final rite cost you everything. Betrayed by the very chains you commanded, your heart gave out. They sealed you inside an rotten coffin, thinking to contain your cursed soul. But something stirred beneath the lid. When your eyes flutter open, the world smells of dust and sorrow: and the chains now answer only to you.
(click:"Master Lorcan Vale")[
(set: $heroNameGravebinder to (prompt: "Do you want to change the name ?","Master Lorcan Vale", ))
(set: $heroName to $heroNameGravebinder)
(goto:"Classes")]
    <span class="twine-link">[[Play as a Gravebinder]]</span>
    </div>
    </div>
  </div>

    <div class="character-info">
  <h2 class="character-title">A Lantern Bearer</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Lantern.png"></div>
    <div class="character-description">
You were $heroNameLanternBearer, keeper of the Lantern of True Dawn. When the Red Fog descended, you stayed behind to comfort the dying: and joined their number. They entombed you in, hoping your spirit would find peace. But as the centuries passed, the light within your lantern refused to extinguish. Now, as you push open the heavy lid, the pale flame sputters to life once more, guiding your first uncertain steps back into a ruined world.
(click:"Sister Ailith Mara")[
(set: $heroNameLanternBearer to (prompt: "Do you want to change the name ?","Sister Ailith Mara", ))
(set: $heroName to $heroNameLanternBearer)
(goto:"Classes")]

    <span class="twine-link">[[Play as a Lantern Bearer]]</span>
    </div>
    </div>
  </div>

    <div class="character-info">
  <h2 class="character-title">An Ossuary Knight</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Knight.png"></div>
    <div class="character-description">
$heroNameOssuaryKnight, fallen hero of the Ash Wars. Cut down by a cursed blade, your final honors were grim: a tomb of rotten pelts of some dead creatures, your armor rusted shut around you. Yet no grave could hold your iron will forever. Now, with a groan of rusted hinges and crumbling stone, you push, trying to shove aside your coffin's heavy lid. The world needs its knight once more: even if the sun will never rise again on your battered shield.
(click:"Rourke Belgrave")[
(set: $heroNameOssuaryKnight to (prompt: "Do you want to change the name ?","Rourke Belgrave", ))
(set: $heroName to $heroNameOssuaryKnight)
(goto:"Classes")]
    <span class="twine-link">[[Play as an Ossuary Knight]]</span>
    </div>
    </div>
  </div>

    <div class="character-info">
  <h2 class="character-title">A Whispered</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Whispered.png"></div>
    <div class="character-description">
You were $heroNameWhispered, once a silent blade for the Pale Court. When your masters turned against you, your betrayal was swift and merciless. They disposed of your body in a shallow grave... but the secrets you carried rooted deep into your restless soul. Now, blinking against the faint, rotten light, you push your way free from a cracked, hastily-nailed coffin. Your fingers find your dagger even before your mind remembers your name. There is still work to do in this broken world.
(click:"Marek Slayne")[
(set: $heroNameWhispered to (prompt: "Do you want to change the name ?","Marek Slayne", ))
(set: $heroName to $heroNameWhispered)
(goto:"Classes")]
    <span class="twine-link">[[Play as a Whispered]]</span>
    </div>
    </div>
  </div>

    <div class="character-info">
  <h2 class="character-title">A Pale Scholar</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Scholar.png"></div>
    <div class="character-description">
$heroNamePaleScholar, last of the Archivists of Erelith. You sought forbidden knowledge and found something deeper: death beyond death. They buried you with your grim tomes clutched to your chest, a precaution against the curses sewn into your bones. Yet when your eyes flicker open in your cramped coffin, the runes carved into the wood begin to weep ink, as if welcoming you home. You are now awake, scholar no longer: a living relic, desperate to rewrite your fate.
(click:"Lady Thyrenia Arkwright")[
(set: $heroNamePaleScholar to (prompt: "Do you want to change the name ?","Lady Thyrenia Arkwright", ))
(set: $heroName to $heroNamePaleScholar)
(goto:"Classes")]
    <span class="twine-link">[[Play as a Pale Scholar]]</span>
    </div>
    </div>
  </div>

    <div class="character-info">
  <h2 class="character-title">An Exhumed</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/Exhumed.png"></div>
    <div class="character-description">
You were $heroNameExhumed, condemned criminal, test subject of a forgotten experiment. Death came slowly, but not completely. The wardens buried you in a nameless grave, bound with iron nails and cursed chains. Yet the experiment refused to end. Now, you are awake, and this world, whatever it is, will snap apart under your fists. Your muscles ache with unnatural hunger as somewhere deep in your fractured mind, you know this is just the beginning of your true sentence.
(click:"Garron Fletch")[
(set: $heroNameExhumed to (prompt: "Do you want to change the name ?","Garron Fletch", ))
(set: $heroName to $heroNameExhumed)
(goto:"Classes")]
    <span class="twine-link">[[Play as an Exhumed]]</span>
    </div>
    </div>
  </div>

    <p class="note">This decision is yours, remember you can always restart the game with another character at anytime. To restart or save the game, click on the 'options' button. If you made an account, you will be able to save the game on your profile and be in our leaderboard.</p>

(if: $heroName is "Flavius")[
 <div class="character-info">
  <h2 class="character-title">A God amongst men</h2>
    <div class="character-rangement">
    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Classes/"></div>
    <div class="character-description">
But your name could lead you to a better destiny, should you choose it :
    <span class="twine-link">[[Play a god]]</span>
    </div>
    </div>
  </div>
]

<script>
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem("characterUnlocked") === "true";
        const characterButton = document.querySelector('.nav-btn[data-panel="skills"]');
        const elementsToHide = document.querySelectorAll('.top-nav, .xp-container, .inventory-sidebar');

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove("disabled-btn");
                characterButton.disabled = false;
            } else {
                characterButton.classList.add("disabled-btn");
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el => {
            el.style.display = characterUnlocked ? "" : "none";
        });
    }

    // Met à jour l'état de l'UI à chaque changement de passage
    $(document).on(':passagerender', function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
</script>


:: Code de jeux [CodeJeux] {"position":"1650,275","size":"200,100"}



:: Coffre {"position":"1225,125","size":"100,100"}
{ <style>.money{display:none;}</style>
<div class="chest">
    <!-- Bouton de switch avec icônes -->
    <button id="toggleView" class="toggle-view-btn">
        <span class="inventory-icon">📦</span>
        <span class="equipment-icon">🛡️</span>
        <div class="toggle-slider"></div>
    </button>
    
    <div class="chest-content">
        <div class="inventoryChest" id="chest1">
            <!-- 27 emplacements d'inventaire -->
        </div>

        <div class="inventoryPlayerChest" id="chestInventory">
            <!-- 27 emplacements d'inventaire -->
        </div>
    </div>
    
    <!-- Vue Inventaire -->
    <div class="chest-view active" id="inventoryView">
       
    </div>

<div class="chest-view" id="equipmentView">
  <div class="special-armorsCoffre">
    <div class="blockEquipements" id="chestEquipmentMirror"></div>
  </div>
</div>
</div>
}

[[Get what you need, than get the hell out of here !->Admin]]

<script>
  const chestId = "coffre";

  // Liste d'objets par défaut (votre code de base)
  const itemsDefault = [
    { id: "sword3", nom: "Dague des fromans", type: "sword", strength: 9, durability: 10, class: "item-img", draggable: true, inventorychest: "1", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/RayGun.png", prix: 142, rare: "Uncommon" },
    { id: "sword4", nom: "Horn", type: "sword", strength: 8, durability: 30, class: "item-img", draggable: true, inventorychest: "2", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/Horn.png", prix: 180, rare: "Epic"  },
    { id: "soin2", nom: "Healing Potion", type: "soin", life: 15, class: "item-img", draggable: true, inventorychest: "3", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Medkit.png", prix: 35, rare: "Common"  },
    { id: "glasse1", nom: "glasse", type: "object", class: "item-img", draggable: true, inventorychest: "4", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Objets/Glasses.png", prix: 67, rare: "Common"  },
    { id: "Watch1", nom: "Watch", type: "object", class: "item-img", draggable: true, inventorychest: "5", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Objets/Watch.png", prix: 115, rare: "Common"  },
    { id: "petitPiece", nom: "Money", type: "money", class: "item-img", draggable: true, inventorychest: "6", money: 500, src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Money/SmallMoney.png", rare: "Common"  },
    { id: "armor1", nom: "Armor", type: "armor", class: "item-img", draggable: true, inventorychest: "7", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Body.png", rare: "Common"  },
    { id: "boots1", nom: "Boots", type: "boots", class: "item-img", draggable: true, inventorychest: "8", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Boots.png", rare: "Common"  },
  ];

  // Vérifie si le coffre a déjà été initialisé
  const hasOpened = localStorage.getItem("chest_opened_" + chestId);
  
  if (!hasOpened) {
    // Première arrivée : on charge les objets par défaut et on les sauvegarde
    renderChestInventory(itemsDefault);
    localStorage.setItem("chest_inventory_" + chestId, JSON.stringify(itemsDefault));
    localStorage.setItem("chest_opened_" + chestId, "true");
    console.log("✨ Coffre rempli pour la première fois");
  } else {
    // On récupère les données sauvegardées
    const savedItems = localStorage.getItem("chest_inventory_" + chestId);
    if (savedItems) {
      const itemsSaved = JSON.parse(savedItems);
      renderChestInventory(itemsSaved);
    }
    console.log("🚫 Coffre déjà ouvert, état récupéré");
  }
    
  function mirrorEquipment() {
    const headerEquip = document.querySelector('.inventaireBas .blockEquipements');
    const chestMirror = document.getElementById('chestEquipmentMirror');
    if (headerEquip && chestMirror) {
      chestMirror.innerHTML = headerEquip.innerHTML;
      reattachDragAndDrop();
      saveEquipmentState(); 
      attachTooltipEquipements();
    }
  }

  const headerEquipContainer = document.querySelector('.inventaireBas .blockEquipements');
  if (headerEquipContainer) {
    const observer = new MutationObserver(mirrorEquipment);
    observer.observe(headerEquipContainer, { childList: true, subtree: true });
  }

  function reattachDragAndDrop() {
    document.querySelectorAll('.iconArmors .item-img, .inventoryPlayerChest .item-img, .blockEquipements .item-img, .inventoryChest .item-img')
      .forEach(item => {
        item.removeEventListener('mousedown', startDragging);
        item.removeEventListener('touchstart', startDragging);
        item.addEventListener('mousedown', startDragging);
        item.addEventListener('touchstart', startDragging, { passive: false });
      });
  }

  /* ---------------------------
     Drag & Drop personnalisé pour les équipements
     --------------------------- */
  window.startDragging = function(e) {
    e.preventDefault();
    const draggable = this;
    const rect = draggable.getBoundingClientRect();
  
    let clientX, clientY;
    if (e.touches) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    const startX = clientX - rect.left;
    const startY = clientY - rect.top;
    const originalParent = draggable.parentElement; 

    const draggedCopy = draggable.cloneNode(true);
    draggedCopy.style.position = 'fixed';
    draggedCopy.style.zIndex = '1000';
    draggedCopy.style.pointerEvents = 'none';
    draggedCopy.style.width = rect.width + 'px';
    draggedCopy.style.height = rect.height + 'px';
    document.body.appendChild(draggedCopy);

    draggable.style.visibility = 'hidden';

    function moveItem(moveEvent) {
      let moveClientX, moveClientY;
      if (moveEvent.type === 'touchmove') {
        moveClientX = moveEvent.touches[0].clientX;
        moveClientY = moveEvent.touches[0].clientY;
      } else {
        moveClientX = moveEvent.clientX;
        moveClientY = moveEvent.clientY;
      }
      const x = moveClientX - startX;
      const y = moveClientY - startY;
      draggedCopy.style.left = x + 'px';
      draggedCopy.style.top = y + 'px';
    }

    function stopDragging(upEvent) {
      document.removeEventListener('mousemove', moveItem);
      document.removeEventListener('mouseup', stopDragging);
      document.removeEventListener('touchmove', moveItem);
      document.removeEventListener('touchend', stopDragging);
      
      if (draggedCopy && draggedCopy.parentElement) {
        document.body.removeChild(draggedCopy);
      }
      draggable.style.visibility = 'visible';

      const moneyValue = parseInt(draggable.getAttribute('data-money')) || 0;
      if (moneyValue > 0) {
        let currentMoney = parseInt(localStorage.getItem('playerMoney')) || 0;
        let newTotal = currentMoney + moneyValue;
        localStorage.setItem('playerMoney', newTotal);
        $money += newTotal;
        alert("The money has been added to your purse.");
        if (window.sfxEnabled) {
          let moneySound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/argent.wav");
          moneySound.volume = window.sfxVolume;
          moneySound.play();
        }
        draggable.remove();
        synchronizeInventories();
        return;
      }
      let endClientX, endClientY;
      if (upEvent.type === 'touchend' && upEvent.changedTouches && upEvent.changedTouches.length > 0) {
        endClientX = upEvent.changedTouches[0].clientX;
        endClientY = upEvent.changedTouches[0].clientY;
      } else if (upEvent.clientX && upEvent.clientY) {
        endClientX = upEvent.clientX;
        endClientY = upEvent.clientY;
      } else {
        endClientX = 0;
        endClientY = 0;
      }

      // Recherche du conteneur cible de dépôt
      const dropTarget = document.elementFromPoint(endClientX, endClientY);
      const container = dropTarget ? dropTarget.closest('.iconArmors, .slotChest, .slotPlayerChest') : null;

      if (container) {
        if (container.classList.contains('iconArmors')) {
          const slotType = container.getAttribute('data-type');
          const itemType = draggable.getAttribute('data-type');
          
          if (slotType !== itemType) {
            originalParent.appendChild(draggable);
            return synchronizeInventories();
          }

          const existingItem = container.querySelector('.item-img');
          if (existingItem) {
            originalParent.appendChild(existingItem);
          }
          container.appendChild(draggable);
        } else {
          const invExisting = container.querySelector('.item-img');
          if (invExisting && invExisting !== draggable) {
            originalParent.appendChild(invExisting);
          }
          if (window.sfxEnabled) {
            let possessionSound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/possageobjet.wav");
            possessionSound.volume = window.sfxVolume;
            possessionSound.play();
          }
          container.appendChild(draggable);
        }
      } else {
        const playerSlots = document.querySelectorAll('#chestInventory .slotPlayerChest');
        let emptySlot = null;
        for (const slot of playerSlots) {
          if (!slot.querySelector('.item-img')) {
            emptySlot = slot;
            break;
          }
        }
        if (emptySlot) {
          emptySlot.appendChild(draggable);
        } else {
          originalParent.appendChild(draggable);
        }
      }
      synchronizeInventories();
    }

    document.addEventListener('mousemove', moveItem);
    document.addEventListener('mouseup', stopDragging);
    document.addEventListener('touchmove', moveItem, { passive: false });
    document.addEventListener('touchend', stopDragging, { passive: false });
  };

  /* ---------------------------
     Gestion du Toggle entre inventaire et équipements
     --------------------------- */
  const toggleBtn = document.getElementById('toggleView');
  const inventoryView = document.getElementById('inventoryView');
  const equipmentView = document.getElementById('equipmentView');

  toggleBtn.addEventListener('click', () => {
    inventoryView.classList.toggle('active');
    equipmentView.classList.toggle('active');
    toggleBtn.classList.toggle('active');
    
    if (equipmentView.classList.contains('active')) {
      synchronizeEquipments();
    }
  });

  /* ---------------------------
     Synchronisation des équipements pour le header
     --------------------------- */
  function synchronizeEquipments() {
    const equipSlots = document.querySelectorAll('#equipmentView .iconArmors');
    equipSlots.forEach(slot => {
      const item = slot.querySelector('.item-img');
      if (item) {
        const decorative = slot.querySelector('.decorative-image');
        if (decorative) decorative.remove();
        item.removeEventListener('mousedown', startDragging);
        item.addEventListener('mousedown', startDragging);
        item.removeEventListener('touchstart', startDragging);
        item.addEventListener('touchstart', startDragging);
      } else {
        const decorative = slot.querySelector('.decorative-image');
        if (decorative) decorative.style.display = 'block';
      }
    });
    setTimeout(saveEquipmentState, 100);
  }

  /* ---------------------------
     Affichage de l'infobulle (tooltip) pour équipements
     --------------------------- */
  function showTooltipEquipements(event, itemElement) {
    const existing = document.querySelector('.tooltip');
    if (existing) existing.remove();
    if (itemElement.classList.contains('iconArmors')) {
      itemElement = itemElement.querySelector('.item-img');
    }
    if (!itemElement) return;
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.style.position = 'absolute';
    tooltip.style.backgroundColor = 'rgba(0,0,0,0.8)';
    tooltip.style.color = '#fff';
    tooltip.style.padding = '8px';
    tooltip.style.borderRadius = '5px';
    tooltip.style.fontSize = '12px';
    tooltip.style.zIndex = '1000';
    tooltip.style.display = 'none';
    let content = '';
    function addAttr(label, attr) {
      const val = itemElement.getAttribute(attr);
      if (val && val.trim() !== '' && val.toLowerCase() !== 'null') {
        content += `<strong>${label}:</strong> ${val}<br>`;
      }
    }
    addAttr('Nom', 'data-nom');
    addAttr('Type', 'data-type');
    addAttr('Strength', 'data-strength');
    addAttr('Durability', 'data-durability');
    addAttr('Life', 'data-life');
    addAttr('Armor', 'data-armor');
    addAttr('Prix', 'data-prix');
    addAttr('Rare', 'data-rare');
    addAttr('Money', 'data-money');

    if (!content) return;
    tooltip.innerHTML = content;
    tooltip.style.display = 'block';
    tooltip.style.left = (event.clientX + 10) + 'px';
    tooltip.style.top = (event.clientY + 10) + 'px';
    document.body.appendChild(tooltip);
    function onMouseMove(e) {
      tooltip.style.left = (e.clientX + 10) + 'px';
      tooltip.style.top = (e.clientY + 10) + 'px';
    }
    document.addEventListener('mousemove', onMouseMove);
    itemElement.addEventListener('mouseleave', function() {
      tooltip.remove();
      document.removeEventListener('mousemove', onMouseMove);
    }, { once: true });
  }

  /* ---------------------------
     Attachement des tooltips pour équipements
     --------------------------- */
  function attachTooltipEquipements() {
    document.querySelectorAll('#chestEquipmentMirror .item-img').forEach(item => {
      item.removeEventListener('mouseenter', tooltipEquipListener);
      item.addEventListener('mouseenter', tooltipEquipListener);
    });
  }
  function tooltipEquipListener(e) {
    showTooltipEquipements(e, e.currentTarget);
  }
  
  /* ---------------------------
     Rendu des objets dans l'inventaire (chestInventory)
     --------------------------- */
  function renderChestInventory(itemsArray) {
    const slots = document.querySelectorAll(".inventoryChest .slotChest");
    slots.forEach(slot => slot.innerHTML = "");
    itemsArray.forEach(item => {
      if (item.inventorychest) {
        const slotIndex = parseInt(item.inventorychest) - 1;
        const slot = slots[slotIndex];
        if (slot) {
          const img = document.createElement("img");
          img.setAttribute("data-id", item.id);
          img.setAttribute("data-nom", item.nom);
          img.setAttribute("data-type", item.type);
          if (item.strength) img.setAttribute("data-strength", item.strength);
          if (item.durability) img.setAttribute("data-durability", item.durability);
          if (item.life) img.setAttribute("data-life", item.life);
          if (item.armor) img.setAttribute("data-armor", item.armor);
          if (item.prix) img.setAttribute("data-prix", item.prix);
          if (item.rare) img.setAttribute("data-rare", item.rare);
          if (item.money) img.setAttribute("data-money", item.money);
          img.src = item.src;
          img.className = item.class;
          img.draggable = item.draggable;
          img.id = item.id;
          img.addEventListener("mouseenter", event => showTooltip(event, img));
          slot.appendChild(img);
        }
      }
    });
  }

  /* ---------------------------
     Initialisation du Drag & Drop pour l'inventaire
     --------------------------- */
  function initDragAndDrop() {
    const draggables = document.querySelectorAll('.item-img');
    const containers = document.querySelectorAll('.slotChest, .slotPlayerChest');
    draggables.forEach(draggable => {
      draggable.addEventListener('dragstart', function(e) {
        draggable.classList.add('dragging');
        draggable.dataset.source = draggable.parentElement.id;
      });
      draggable.addEventListener('dragend', function(e) {
        draggable.classList.remove('dragging');
        delete draggable.dataset.source;
      });
    });
    containers.forEach(container => {
      container.addEventListener('dragover', function(e) {
        e.preventDefault();
      });
      container.addEventListener('drop', function(e) {
        e.preventDefault();
        const draggedItem = document.querySelector('.dragging');
        if (!draggedItem) return;
        const sourceContainer = document.getElementById(draggedItem.dataset.source);
        const targetContainer = container;
        const existing = targetContainer.querySelector('.item-img');
        if (existing && existing !== draggedItem) {
          targetContainer.removeChild(existing);
          if (sourceContainer) {
            sourceContainer.appendChild(existing);
          }
        }
        targetContainer.appendChild(draggedItem);
        synchronizeInventories();
      });
    });
  }

  /* ---------------------------
     Synchronisation globale (inventaire et équipements)
     --------------------------- */
  function synchronizeInventories() {
    synchronizeEquipments();
    const chestSlots = document.querySelectorAll('.inventoryChest .slotChest');
    const savedItems = [];
    chestSlots.forEach((slot, index) => {
      const item = slot.querySelector('.item-img');
      if (item) {
        savedItems.push({
          id: item.id,
          nom: item.getAttribute('data-nom'),
          type: item.getAttribute('data-type'),
          strength: item.getAttribute('data-strength'),
          durability: item.getAttribute('data-durability'),
          life: item.getAttribute('data-life'),
          armor: item.getAttribute('data-armor'),
          prix: item.getAttribute('data-prix'),
          rare: item.getAttribute('data-rare'),
          money: item.getAttribute('data-money'),
           src: item.src,
           class: item.className,
          inventorychest: slot.dataset.slot || (index + 1)
        });
      }
    });
    localStorage.setItem("chest_inventory_" + chestId, JSON.stringify(savedItems));
  }

  /* ---------------------------
     Gestion de l'état des équipements
     --------------------------- */
  function saveEquipmentState() {
    const slots = document.querySelectorAll('#chestEquipmentMirror .iconArmors');
    const data = [];
    slots.forEach(slot => {
      const item = slot.querySelector('.item-img');
      if (item) {
        data.push({
          type: item.getAttribute('data-type'),
          src: item.src,
          id: item.getAttribute('data-id'),
          nom: item.getAttribute('data-nom'),
          strength: item.getAttribute('data-strength'),
          durability: item.getAttribute('data-durability'),
          life: item.getAttribute('data-life'),
          armor: item.getAttribute('data-armor'),
          prix: item.getAttribute('data-prix'),
          rare: item.getAttribute('data-rare'),
          money: item.getAttribute('data-money'),
        });
      } else {
        data.push(null);
      }
    });
    localStorage.setItem('specialArmorInventory', JSON.stringify(data));
  }
  
  const chestEquipContainer = document.getElementById('chestEquipmentMirror');
  if (chestEquipContainer) {
    const chestObserver = new MutationObserver(() => {
      saveEquipmentState();
      synchronizeEquipments();
    });
    chestObserver.observe(chestEquipContainer, { 
      childList: true, 
      subtree: true,
      attributes: true,
      attributeFilter: ['data-type', 'data-strength', 'data-durability'] 
    });
  }

  function createItem(type, src, id, nom, strength, durability, life, armor, prix, rare, money) {
    const img = document.createElement('img');
    img.setAttribute("data-id", id);
    img.setAttribute("data-nom", nom);
    img.setAttribute("data-type", type);
    if (strength) img.setAttribute("data-strength", strength);
    if (durability) img.setAttribute("data-durability", durability);
    if (life) img.setAttribute("data-life", life);
    if (armor) img.setAttribute("data-armor", armor);
    if (prix) img.setAttribute("data-prix", prix);
    if (rare) img.setAttribute("data-rare", rare);
    if (money) img.setAttribute("data-money", money);
    img.src = src;
    img.className = "item-img";
    img.draggable = true;
    img.addEventListener('dragstart', () => img.classList.add('dragging'));
    img.addEventListener('dragend', () => img.classList.remove('dragging'));
    img.addEventListener('mousedown', startDragging);
    return img;
  }

  function loadEquipmentState() {
    const data = JSON.parse(localStorage.getItem('specialArmorInventory'));
    if (!data) return;
    const slots = document.querySelectorAll('#chestEquipmentMirror .iconArmors');
    data.forEach((d, i) => {
      if (d && slots[i]) {
        slots[i].innerHTML = '';
        const newItem = createItem(d.type, d.src, d.id, d.nom, d.strength, d.durability, d.life, d.armor, d.prix, d.rare);
        slots[i].appendChild(newItem);
        reattachDragAndDrop();
        attachTooltipEquipements();
      }
    });
  }

  /* ---------------------------
     Drag & Drop pour équipements
     --------------------------- */
  function setupEquipmentDragAndDrop() {
    const equipmentSlots = document.querySelectorAll('.special-armors .iconArmors');
    equipmentSlots.forEach(slot => {
      slot.addEventListener('dragover', function(e) {
        e.preventDefault();
      });
      slot.addEventListener('drop', function(e) {
        e.preventDefault();
        const draggedItem = document.querySelector('.dragging');
        if (draggedItem) {
          const slotType = slot.getAttribute('data-type');
          const itemType = draggedItem.getAttribute('data-type');
          if (slotType !== itemType) {
            const source = document.getElementById(draggedItem.dataset.source);
            if (source) source.appendChild(draggedItem);
            return;
          }
          if (draggedItem.parentElement) {
            draggedItem.parentElement.removeChild(draggedItem);
          }
          slot.innerHTML = '';
          slot.appendChild(draggedItem);
          setTimeout(synchronizeEquipments, 100);
        } else {
          const decorative = slot.querySelector('.decorative-image');
          if (!slot.querySelector('.item-img') && decorative) {
            decorative.style.display = 'block';
          }
        }
      });
    });
  }

  /* ---------------------------
     Outil pour attacher les tooltips
     --------------------------- */
  function attachTooltip(selector) {
    document.querySelectorAll(selector).forEach(elem => {
      const target = elem.hasAttribute('data-type') ? elem : (elem.querySelector('img') || elem);
      target.addEventListener('mouseenter', event => showTooltip(event, target));
    });
  }

  // Initialisations principales
  loadEquipmentState();
  setupEquipmentDragAndDrop();
  initDragAndDrop();
  attachTooltip('.slotChest');
  attachTooltip('.iconArmors');

  const toggleEquipBtn = document.getElementById("toggle-equipement");
  if (toggleEquipBtn) {
    toggleEquipBtn.remove();
  }

  // Suppression d'éléments inutiles pour l'inventaire du coffre
  const chestContainer = document.querySelector(".chest");
  if (chestContainer) {
    const iconArmorsWithoutDataType = document.querySelectorAll(".iconArmors:not([data-type])");
    if (iconArmorsWithoutDataType.length > 0) {
      iconArmorsWithoutDataType[iconArmorsWithoutDataType.length - 1].remove();
    }
  }
</script>


:: Coffre2 {"position":"1225,250","size":"100,100"}
{ <style>.money{display:none;}</style>
<div class="chest">
    <!-- Bouton de switch avec icônes -->
    <button id="toggleView" class="toggle-view-btn">
        <span class="inventory-icon">📦</span>
        <span class="equipment-icon">🛡️</span>
        <div class="toggle-slider"></div>
    </button>
    
    <div class="chest-content">
        <div class="inventoryChest" id="chest1">
            <!-- 27 emplacements d'inventaire -->
        </div>

        <div class="inventoryPlayerChest" id="chestInventory">
            <!-- 27 emplacements d'inventaire -->
        </div>
    </div>
    
    <!-- Vue Inventaire -->
    <div class="chest-view active" id="inventoryView">
       
    </div>

<div class="chest-view" id="equipmentView">
  <div class="special-armorsCoffre">
    <div class="blockEquipements" id="chestEquipmentMirror"></div>
  </div>
</div>
</div>
}

[[Get what you need, than get the hell out of here !->Admin]]

<script>
  const chestId = "coffre2";

  // Liste d'objets par défaut (votre code de base)
  const itemsDefault = [
    { id: "sword3", nom: "Dague des fromans", type: "sword", strength: 9, durability: 10, class: "item-img", draggable: true, inventorychest: "1", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/RayGun.png", prix: 142, rare: "Uncommon" },
    { id: "sword4", nom: "Horn", type: "sword", strength: 8, durability: 30, class: "item-img", draggable: true, inventorychest: "2", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/Horn.png", prix: 180, rare: "Epic"  },
    { id: "soin2", nom: "Healing Potion", type: "soin", life: 15, class: "item-img", draggable: true, inventorychest: "3", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Medkit.png", prix: 35, rare: "Common"  },
    { id: "glasse1", nom: "glasse", type: "object", class: "item-img", draggable: true, inventorychest: "4", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Objets/Glasses.png", prix: 67, rare: "Common"  },
    { id: "Watch1", nom: "Watch", type: "object", class: "item-img", draggable: true, inventorychest: "5", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Objets/Watch.png", prix: 115, rare: "Common"  },
    { id: "petitPiece", nom: "Money", type: "money", class: "item-img", draggable: true, inventorychest: "6", money: 500, src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Money/SmallMoney.png", rare: "Common"  },
    { id: "armor1", nom: "Armor", type: "armor", class: "item-img", draggable: true, inventorychest: "7", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Body.png", rare: "Common"  },
    { id: "boots1", nom: "Boots", type: "boots", class: "item-img", draggable: true, inventorychest: "8", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Boots.png", rare: "Common"  },
  ];

  // Vérifie si le coffre a déjà été initialisé
  const hasOpened = localStorage.getItem("chest_opened_" + chestId);
  
  if (!hasOpened) {
    // Première arrivée : on charge les objets par défaut et on les sauvegarde
    renderChestInventory(itemsDefault);
    localStorage.setItem("chest_inventory_" + chestId, JSON.stringify(itemsDefault));
    localStorage.setItem("chest_opened_" + chestId, "true");
    console.log("✨ Coffre rempli pour la première fois");
  } else {
    // On récupère les données sauvegardées
    const savedItems = localStorage.getItem("chest_inventory_" + chestId);
    if (savedItems) {
      const itemsSaved = JSON.parse(savedItems);
      renderChestInventory(itemsSaved);
    }
    console.log("🚫 Coffre déjà ouvert, état récupéré");
  }
    
  function mirrorEquipment() {
    const headerEquip = document.querySelector('.inventaireBas .blockEquipements');
    const chestMirror = document.getElementById('chestEquipmentMirror');
    if (headerEquip && chestMirror) {
      chestMirror.innerHTML = headerEquip.innerHTML;
      reattachDragAndDrop();
      saveEquipmentState(); 
      attachTooltipEquipements();
    }
  }

  const headerEquipContainer = document.querySelector('.inventaireBas .blockEquipements');
  if (headerEquipContainer) {
    const observer = new MutationObserver(mirrorEquipment);
    observer.observe(headerEquipContainer, { childList: true, subtree: true });
  }

  function reattachDragAndDrop() {
    document.querySelectorAll('.iconArmors .item-img, .inventoryPlayerChest .item-img, .blockEquipements .item-img, .inventoryChest .item-img')
      .forEach(item => {
        item.removeEventListener('mousedown', startDragging);
        item.removeEventListener('touchstart', startDragging);
        item.addEventListener('mousedown', startDragging);
        item.addEventListener('touchstart', startDragging, { passive: false });
      });
  }

  /* ---------------------------
     Drag & Drop personnalisé pour les équipements
     --------------------------- */
  window.startDragging = function(e) {
    e.preventDefault();
    const draggable = this;
    const rect = draggable.getBoundingClientRect();
  
    let clientX, clientY;
    if (e.touches) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    const startX = clientX - rect.left;
    const startY = clientY - rect.top;
    const originalParent = draggable.parentElement; 

    const draggedCopy = draggable.cloneNode(true);
    draggedCopy.style.position = 'fixed';
    draggedCopy.style.zIndex = '1000';
    draggedCopy.style.pointerEvents = 'none';
    draggedCopy.style.width = rect.width + 'px';
    draggedCopy.style.height = rect.height + 'px';
    document.body.appendChild(draggedCopy);

    draggable.style.visibility = 'hidden';

    function moveItem(moveEvent) {
      let moveClientX, moveClientY;
      if (moveEvent.type === 'touchmove') {
        moveClientX = moveEvent.touches[0].clientX;
        moveClientY = moveEvent.touches[0].clientY;
      } else {
        moveClientX = moveEvent.clientX;
        moveClientY = moveEvent.clientY;
      }
      const x = moveClientX - startX;
      const y = moveClientY - startY;
      draggedCopy.style.left = x + 'px';
      draggedCopy.style.top = y + 'px';
    }

    function stopDragging(upEvent) {
      document.removeEventListener('mousemove', moveItem);
      document.removeEventListener('mouseup', stopDragging);
      document.removeEventListener('touchmove', moveItem);
      document.removeEventListener('touchend', stopDragging);
      
      if (draggedCopy && draggedCopy.parentElement) {
        document.body.removeChild(draggedCopy);
      }
      draggable.style.visibility = 'visible';

      const moneyValue = parseInt(draggable.getAttribute('data-money')) || 0;
      if (moneyValue > 0) {
        let currentMoney = parseInt(localStorage.getItem('playerMoney')) || 0;
        let newTotal = currentMoney + moneyValue;
        localStorage.setItem('playerMoney', newTotal);
        $money += newTotal;
        alert("The money has been added to your purse.");
        if (window.sfxEnabled) {
          let moneySound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/argent.wav");
          moneySound.volume = window.sfxVolume;
          moneySound.play();
        }
        draggable.remove();
        synchronizeInventories();
        return;
      }
      let endClientX, endClientY;
      if (upEvent.type === 'touchend' && upEvent.changedTouches && upEvent.changedTouches.length > 0) {
        endClientX = upEvent.changedTouches[0].clientX;
        endClientY = upEvent.changedTouches[0].clientY;
      } else if (upEvent.clientX && upEvent.clientY) {
        endClientX = upEvent.clientX;
        endClientY = upEvent.clientY;
      } else {
        endClientX = 0;
        endClientY = 0;
      }

      // Recherche du conteneur cible de dépôt
      const dropTarget = document.elementFromPoint(endClientX, endClientY);
      const container = dropTarget ? dropTarget.closest('.iconArmors, .slotChest, .slotPlayerChest') : null;

      if (container) {
        if (container.classList.contains('iconArmors')) {
          const slotType = container.getAttribute('data-type');
          const itemType = draggable.getAttribute('data-type');
          
          if (slotType !== itemType) {
            originalParent.appendChild(draggable);
            return synchronizeInventories();
          }

          const existingItem = container.querySelector('.item-img');
          if (existingItem) {
            originalParent.appendChild(existingItem);
          }
          container.appendChild(draggable);
        } else {
          const invExisting = container.querySelector('.item-img');
          if (invExisting && invExisting !== draggable) {
            originalParent.appendChild(invExisting);
          }
          if (window.sfxEnabled) {
            let possessionSound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/possageobjet.wav");
            possessionSound.volume = window.sfxVolume;
            possessionSound.play();
          }
          container.appendChild(draggable);
        }
      } else {
        const playerSlots = document.querySelectorAll('#chestInventory .slotPlayerChest');
        let emptySlot = null;
        for (const slot of playerSlots) {
          if (!slot.querySelector('.item-img')) {
            emptySlot = slot;
            break;
          }
        }
        if (emptySlot) {
          emptySlot.appendChild(draggable);
        } else {
          originalParent.appendChild(draggable);
        }
      }
      synchronizeInventories();
    }

    document.addEventListener('mousemove', moveItem);
    document.addEventListener('mouseup', stopDragging);
    document.addEventListener('touchmove', moveItem, { passive: false });
    document.addEventListener('touchend', stopDragging, { passive: false });
  };

  /* ---------------------------
     Gestion du Toggle entre inventaire et équipements
     --------------------------- */
  const toggleBtn = document.getElementById('toggleView');
  const inventoryView = document.getElementById('inventoryView');
  const equipmentView = document.getElementById('equipmentView');

  toggleBtn.addEventListener('click', () => {
    inventoryView.classList.toggle('active');
    equipmentView.classList.toggle('active');
    toggleBtn.classList.toggle('active');
    
    if (equipmentView.classList.contains('active')) {
      synchronizeEquipments();
    }
  });

  /* ---------------------------
     Synchronisation des équipements pour le header
     --------------------------- */
  function synchronizeEquipments() {
    const equipSlots = document.querySelectorAll('#equipmentView .iconArmors');
    equipSlots.forEach(slot => {
      const item = slot.querySelector('.item-img');
      if (item) {
        const decorative = slot.querySelector('.decorative-image');
        if (decorative) decorative.remove();
        item.removeEventListener('mousedown', startDragging);
        item.addEventListener('mousedown', startDragging);
        item.removeEventListener('touchstart', startDragging);
        item.addEventListener('touchstart', startDragging);
      } else {
        const decorative = slot.querySelector('.decorative-image');
        if (decorative) decorative.style.display = 'block';
      }
    });
    setTimeout(saveEquipmentState, 100);
  }

  /* ---------------------------
     Affichage de l'infobulle (tooltip) pour équipements
     --------------------------- */
  function showTooltipEquipements(event, itemElement) {
    const existing = document.querySelector('.tooltip');
    if (existing) existing.remove();
    if (itemElement.classList.contains('iconArmors')) {
      itemElement = itemElement.querySelector('.item-img');
    }
    if (!itemElement) return;
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.style.position = 'absolute';
    tooltip.style.backgroundColor = 'rgba(0,0,0,0.8)';
    tooltip.style.color = '#fff';
    tooltip.style.padding = '8px';
    tooltip.style.borderRadius = '5px';
    tooltip.style.fontSize = '12px';
    tooltip.style.zIndex = '1000';
    tooltip.style.display = 'none';
    let content = '';
    function addAttr(label, attr) {
      const val = itemElement.getAttribute(attr);
      if (val && val.trim() !== '' && val.toLowerCase() !== 'null') {
        content += `<strong>${label}:</strong> ${val}<br>`;
      }
    }
    addAttr('Nom', 'data-nom');
    addAttr('Type', 'data-type');
    addAttr('Strength', 'data-strength');
    addAttr('Durability', 'data-durability');
    addAttr('Life', 'data-life');
    addAttr('Armor', 'data-armor');
    addAttr('Prix', 'data-prix');
    addAttr('Rare', 'data-rare');
    addAttr('Money', 'data-money');

    if (!content) return;
    tooltip.innerHTML = content;
    tooltip.style.display = 'block';
    tooltip.style.left = (event.clientX + 10) + 'px';
    tooltip.style.top = (event.clientY + 10) + 'px';
    document.body.appendChild(tooltip);
    function onMouseMove(e) {
      tooltip.style.left = (e.clientX + 10) + 'px';
      tooltip.style.top = (e.clientY + 10) + 'px';
    }
    document.addEventListener('mousemove', onMouseMove);
    itemElement.addEventListener('mouseleave', function() {
      tooltip.remove();
      document.removeEventListener('mousemove', onMouseMove);
    }, { once: true });
  }

  /* ---------------------------
     Attachement des tooltips pour équipements
     --------------------------- */
  function attachTooltipEquipements() {
    document.querySelectorAll('#chestEquipmentMirror .item-img').forEach(item => {
      item.removeEventListener('mouseenter', tooltipEquipListener);
      item.addEventListener('mouseenter', tooltipEquipListener);
    });
  }
  function tooltipEquipListener(e) {
    showTooltipEquipements(e, e.currentTarget);
  }
  
  /* ---------------------------
     Rendu des objets dans l'inventaire (chestInventory)
     --------------------------- */
  function renderChestInventory(itemsArray) {
    const slots = document.querySelectorAll(".inventoryChest .slotChest");
    slots.forEach(slot => slot.innerHTML = "");
    itemsArray.forEach(item => {
      if (item.inventorychest) {
        const slotIndex = parseInt(item.inventorychest) - 1;
        const slot = slots[slotIndex];
        if (slot) {
          const img = document.createElement("img");
          img.setAttribute("data-id", item.id);
          img.setAttribute("data-nom", item.nom);
          img.setAttribute("data-type", item.type);
          if (item.strength) img.setAttribute("data-strength", item.strength);
          if (item.durability) img.setAttribute("data-durability", item.durability);
          if (item.life) img.setAttribute("data-life", item.life);
          if (item.armor) img.setAttribute("data-armor", item.armor);
          if (item.prix) img.setAttribute("data-prix", item.prix);
          if (item.rare) img.setAttribute("data-rare", item.rare);
          if (item.money) img.setAttribute("data-money", item.money);
          img.src = item.src;
          img.className = item.class;
          img.draggable = item.draggable;
          img.id = item.id;
          img.addEventListener("mouseenter", event => showTooltip(event, img));
          slot.appendChild(img);
        }
      }
    });
  }

  /* ---------------------------
     Initialisation du Drag & Drop pour l'inventaire
     --------------------------- */
  function initDragAndDrop() {
    const draggables = document.querySelectorAll('.item-img');
    const containers = document.querySelectorAll('.slotChest, .slotPlayerChest');
    draggables.forEach(draggable => {
      draggable.addEventListener('dragstart', function(e) {
        draggable.classList.add('dragging');
        draggable.dataset.source = draggable.parentElement.id;
      });
      draggable.addEventListener('dragend', function(e) {
        draggable.classList.remove('dragging');
        delete draggable.dataset.source;
      });
    });
    containers.forEach(container => {
      container.addEventListener('dragover', function(e) {
        e.preventDefault();
      });
      container.addEventListener('drop', function(e) {
        e.preventDefault();
        const draggedItem = document.querySelector('.dragging');
        if (!draggedItem) return;
        const sourceContainer = document.getElementById(draggedItem.dataset.source);
        const targetContainer = container;
        const existing = targetContainer.querySelector('.item-img');
        if (existing && existing !== draggedItem) {
          targetContainer.removeChild(existing);
          if (sourceContainer) {
            sourceContainer.appendChild(existing);
          }
        }
        targetContainer.appendChild(draggedItem);
        synchronizeInventories();
      });
    });
  }

  /* ---------------------------
     Synchronisation globale (inventaire et équipements)
     --------------------------- */
  function synchronizeInventories() {
    synchronizeEquipments();
    const chestSlots = document.querySelectorAll('.inventoryChest .slotChest');
    const savedItems = [];
    chestSlots.forEach((slot, index) => {
      const item = slot.querySelector('.item-img');
      if (item) {
        savedItems.push({
          id: item.id,
          nom: item.getAttribute('data-nom'),
          type: item.getAttribute('data-type'),
          strength: item.getAttribute('data-strength'),
          durability: item.getAttribute('data-durability'),
          life: item.getAttribute('data-life'),
          armor: item.getAttribute('data-armor'),
          prix: item.getAttribute('data-prix'),
          rare: item.getAttribute('data-rare'),
          money: item.getAttribute('data-money'),
           src: item.src,
           class: item.className,
          inventorychest: slot.dataset.slot || (index + 1)
        });
      }
    });
    localStorage.setItem("chest_inventory_" + chestId, JSON.stringify(savedItems));
  }

  /* ---------------------------
     Gestion de l'état des équipements
     --------------------------- */
  function saveEquipmentState() {
    const slots = document.querySelectorAll('#chestEquipmentMirror .iconArmors');
    const data = [];
    slots.forEach(slot => {
      const item = slot.querySelector('.item-img');
      if (item) {
        data.push({
          type: item.getAttribute('data-type'),
          src: item.src,
          id: item.getAttribute('data-id'),
          nom: item.getAttribute('data-nom'),
          strength: item.getAttribute('data-strength'),
          durability: item.getAttribute('data-durability'),
          life: item.getAttribute('data-life'),
          armor: item.getAttribute('data-armor'),
          prix: item.getAttribute('data-prix'),
          rare: item.getAttribute('data-rare'),
          money: item.getAttribute('data-money'),
        });
      } else {
        data.push(null);
      }
    });
    localStorage.setItem('specialArmorInventory', JSON.stringify(data));
  }
  
  const chestEquipContainer = document.getElementById('chestEquipmentMirror');
  if (chestEquipContainer) {
    const chestObserver = new MutationObserver(() => {
      saveEquipmentState();
      synchronizeEquipments();
    });
    chestObserver.observe(chestEquipContainer, { 
      childList: true, 
      subtree: true,
      attributes: true,
      attributeFilter: ['data-type', 'data-strength', 'data-durability'] 
    });
  }

  function createItem(type, src, id, nom, strength, durability, life, armor, prix, rare, money) {
    const img = document.createElement('img');
    img.setAttribute("data-id", id);
    img.setAttribute("data-nom", nom);
    img.setAttribute("data-type", type);
    if (strength) img.setAttribute("data-strength", strength);
    if (durability) img.setAttribute("data-durability", durability);
    if (life) img.setAttribute("data-life", life);
    if (armor) img.setAttribute("data-armor", armor);
    if (prix) img.setAttribute("data-prix", prix);
    if (rare) img.setAttribute("data-rare", rare);
    if (money) img.setAttribute("data-money", money);
    img.src = src;
    img.className = "item-img";
    img.draggable = true;
    img.addEventListener('dragstart', () => img.classList.add('dragging'));
    img.addEventListener('dragend', () => img.classList.remove('dragging'));
    img.addEventListener('mousedown', startDragging);
    return img;
  }

  function loadEquipmentState() {
    const data = JSON.parse(localStorage.getItem('specialArmorInventory'));
    if (!data) return;
    const slots = document.querySelectorAll('#chestEquipmentMirror .iconArmors');
    data.forEach((d, i) => {
      if (d && slots[i]) {
        slots[i].innerHTML = '';
        const newItem = createItem(d.type, d.src, d.id, d.nom, d.strength, d.durability, d.life, d.armor, d.prix, d.rare);
        slots[i].appendChild(newItem);
        reattachDragAndDrop();
        attachTooltipEquipements();
      }
    });
  }

  /* ---------------------------
     Drag & Drop pour équipements
     --------------------------- */
  function setupEquipmentDragAndDrop() {
    const equipmentSlots = document.querySelectorAll('.special-armors .iconArmors');
    equipmentSlots.forEach(slot => {
      slot.addEventListener('dragover', function(e) {
        e.preventDefault();
      });
      slot.addEventListener('drop', function(e) {
        e.preventDefault();
        const draggedItem = document.querySelector('.dragging');
        if (draggedItem) {
          const slotType = slot.getAttribute('data-type');
          const itemType = draggedItem.getAttribute('data-type');
          if (slotType !== itemType) {
            const source = document.getElementById(draggedItem.dataset.source);
            if (source) source.appendChild(draggedItem);
            return;
          }
          if (draggedItem.parentElement) {
            draggedItem.parentElement.removeChild(draggedItem);
          }
          slot.innerHTML = '';
          slot.appendChild(draggedItem);
          setTimeout(synchronizeEquipments, 100);
        } else {
          const decorative = slot.querySelector('.decorative-image');
          if (!slot.querySelector('.item-img') && decorative) {
            decorative.style.display = 'block';
          }
        }
      });
    });
  }

  /* ---------------------------
     Outil pour attacher les tooltips
     --------------------------- */
  function attachTooltip(selector) {
    document.querySelectorAll(selector).forEach(elem => {
      const target = elem.hasAttribute('data-type') ? elem : (elem.querySelector('img') || elem);
      target.addEventListener('mouseenter', event => showTooltip(event, target));
    });
  }

  // Initialisations principales
  loadEquipmentState();
  setupEquipmentDragAndDrop();
  initDragAndDrop();
  attachTooltip('.slotChest');
  attachTooltip('.iconArmors');

  const toggleEquipBtn = document.getElementById("toggle-equipement");
  if (toggleEquipBtn) {
    toggleEquipBtn.remove();
  }

  // Suppression d'éléments inutiles pour l'inventaire du coffre
  const chestContainer = document.querySelector(".chest");
  if (chestContainer) {
    const iconArmorsWithoutDataType = document.querySelectorAll(".iconArmors:not([data-type])");
    if (iconArmorsWithoutDataType.length > 0) {
      iconArmorsWithoutDataType[iconArmorsWithoutDataType.length - 1].remove();
    }
  }
</script>


:: Coffre3 {"position":"1225,375","size":"100,100"}
{ <style>.money{display:none;}</style>
<div class="chest">
    <!-- Bouton de switch avec icônes -->
    <button id="toggleView" class="toggle-view-btn">
        <span class="inventory-icon">📦</span>
        <span class="equipment-icon">🛡️</span>
        <div class="toggle-slider"></div>
    </button>
    
    <div class="chest-content">
        <div class="inventoryChest" id="chest1">
            <!-- 27 emplacements d'inventaire -->
        </div>

        <div class="inventoryPlayerChest" id="chestInventory">
            <!-- 27 emplacements d'inventaire -->
        </div>
    </div>
    
    <!-- Vue Inventaire -->
    <div class="chest-view active" id="inventoryView">
       
    </div>

<div class="chest-view" id="equipmentView">
  <div class="special-armorsCoffre">
    <div class="blockEquipements" id="chestEquipmentMirror"></div>
  </div>
</div>
</div>
}

[[Get what you need, than get the hell out of here !->Admin]]

<script>
  const chestId = "coffre3";

  // Liste d'objets par défaut (votre code de base)
  const itemsDefault = [
    { id: "soin2", nom: "Healing Potion", type: "soin", life: 15, class: "item-img", draggable: true, inventorychest: "3", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Medkit.png", prix: 35, rare: "Common"  },
  ];

  // Vérifie si le coffre a déjà été initialisé
  const hasOpened = localStorage.getItem("chest_opened_" + chestId);
  
  if (!hasOpened) {
    // Première arrivée : on charge les objets par défaut et on les sauvegarde
    renderChestInventory(itemsDefault);
    localStorage.setItem("chest_inventory_" + chestId, JSON.stringify(itemsDefault));
    localStorage.setItem("chest_opened_" + chestId, "true");
    console.log("✨ Coffre rempli pour la première fois");
  } else {
    // On récupère les données sauvegardées
    const savedItems = localStorage.getItem("chest_inventory_" + chestId);
    if (savedItems) {
      const itemsSaved = JSON.parse(savedItems);
      renderChestInventory(itemsSaved);
    }
    console.log("🚫 Coffre déjà ouvert, état récupéré");
  }
    
  function mirrorEquipment() {
    const headerEquip = document.querySelector('.inventaireBas .blockEquipements');
    const chestMirror = document.getElementById('chestEquipmentMirror');
    if (headerEquip && chestMirror) {
      chestMirror.innerHTML = headerEquip.innerHTML;
      reattachDragAndDrop();
      saveEquipmentState(); 
      attachTooltipEquipements();
    }
  }

  const headerEquipContainer = document.querySelector('.inventaireBas .blockEquipements');
  if (headerEquipContainer) {
    const observer = new MutationObserver(mirrorEquipment);
    observer.observe(headerEquipContainer, { childList: true, subtree: true });
  }

  function reattachDragAndDrop() {
    document.querySelectorAll('.iconArmors .item-img, .inventoryPlayerChest .item-img, .blockEquipements .item-img, .inventoryChest .item-img')
      .forEach(item => {
        item.removeEventListener('mousedown', startDragging);
        item.removeEventListener('touchstart', startDragging);
        item.addEventListener('mousedown', startDragging);
        item.addEventListener('touchstart', startDragging, { passive: false });
      });
  }

  /* ---------------------------
     Drag & Drop personnalisé pour les équipements
     --------------------------- */
  window.startDragging = function(e) {
    e.preventDefault();
    const draggable = this;
    const rect = draggable.getBoundingClientRect();
  
    let clientX, clientY;
    if (e.touches) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    const startX = clientX - rect.left;
    const startY = clientY - rect.top;
    const originalParent = draggable.parentElement; 

    const draggedCopy = draggable.cloneNode(true);
    draggedCopy.style.position = 'fixed';
    draggedCopy.style.zIndex = '1000';
    draggedCopy.style.pointerEvents = 'none';
    draggedCopy.style.width = rect.width + 'px';
    draggedCopy.style.height = rect.height + 'px';
    document.body.appendChild(draggedCopy);

    draggable.style.visibility = 'hidden';

    function moveItem(moveEvent) {
      let moveClientX, moveClientY;
      if (moveEvent.type === 'touchmove') {
        moveClientX = moveEvent.touches[0].clientX;
        moveClientY = moveEvent.touches[0].clientY;
      } else {
        moveClientX = moveEvent.clientX;
        moveClientY = moveEvent.clientY;
      }
      const x = moveClientX - startX;
      const y = moveClientY - startY;
      draggedCopy.style.left = x + 'px';
      draggedCopy.style.top = y + 'px';
    }

    function stopDragging(upEvent) {
      document.removeEventListener('mousemove', moveItem);
      document.removeEventListener('mouseup', stopDragging);
      document.removeEventListener('touchmove', moveItem);
      document.removeEventListener('touchend', stopDragging);
      
      if (draggedCopy && draggedCopy.parentElement) {
        document.body.removeChild(draggedCopy);
      }
      draggable.style.visibility = 'visible';

      const moneyValue = parseInt(draggable.getAttribute('data-money')) || 0;
      if (moneyValue > 0) {
        let currentMoney = parseInt(localStorage.getItem('playerMoney')) || 0;
        let newTotal = currentMoney + moneyValue;
        localStorage.setItem('playerMoney', newTotal);
        $money += newTotal;
        alert("The money has been added to your purse.");
        if (window.sfxEnabled) {
          let moneySound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/argent.wav");
          moneySound.volume = window.sfxVolume;
          moneySound.play();
        }
        draggable.remove();
        synchronizeInventories();
        return;
      }
      let endClientX, endClientY;
      if (upEvent.type === 'touchend' && upEvent.changedTouches && upEvent.changedTouches.length > 0) {
        endClientX = upEvent.changedTouches[0].clientX;
        endClientY = upEvent.changedTouches[0].clientY;
      } else if (upEvent.clientX && upEvent.clientY) {
        endClientX = upEvent.clientX;
        endClientY = upEvent.clientY;
      } else {
        endClientX = 0;
        endClientY = 0;
      }

      // Recherche du conteneur cible de dépôt
      const dropTarget = document.elementFromPoint(endClientX, endClientY);
      const container = dropTarget ? dropTarget.closest('.iconArmors, .slotChest, .slotPlayerChest') : null;

      if (container) {
        if (container.classList.contains('iconArmors')) {
          const slotType = container.getAttribute('data-type');
          const itemType = draggable.getAttribute('data-type');
          
          if (slotType !== itemType) {
            originalParent.appendChild(draggable);
            return synchronizeInventories();
          }

          const existingItem = container.querySelector('.item-img');
          if (existingItem) {
            originalParent.appendChild(existingItem);
          }
          container.appendChild(draggable);
        } else {
          const invExisting = container.querySelector('.item-img');
          if (invExisting && invExisting !== draggable) {
            originalParent.appendChild(invExisting);
          }
          if (window.sfxEnabled) {
            let possessionSound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/possageobjet.wav");
            possessionSound.volume = window.sfxVolume;
            possessionSound.play();
          }
          container.appendChild(draggable);
        }
      } else {
        const playerSlots = document.querySelectorAll('#chestInventory .slotPlayerChest');
        let emptySlot = null;
        for (const slot of playerSlots) {
          if (!slot.querySelector('.item-img')) {
            emptySlot = slot;
            break;
          }
        }
        if (emptySlot) {
          emptySlot.appendChild(draggable);
        } else {
          originalParent.appendChild(draggable);
        }
      }
      synchronizeInventories();
    }

    document.addEventListener('mousemove', moveItem);
    document.addEventListener('mouseup', stopDragging);
    document.addEventListener('touchmove', moveItem, { passive: false });
    document.addEventListener('touchend', stopDragging, { passive: false });
  };

  /* ---------------------------
     Gestion du Toggle entre inventaire et équipements
     --------------------------- */
  const toggleBtn = document.getElementById('toggleView');
  const inventoryView = document.getElementById('inventoryView');
  const equipmentView = document.getElementById('equipmentView');

  toggleBtn.addEventListener('click', () => {
    inventoryView.classList.toggle('active');
    equipmentView.classList.toggle('active');
    toggleBtn.classList.toggle('active');
    
    if (equipmentView.classList.contains('active')) {
      synchronizeEquipments();
    }
  });

  /* ---------------------------
     Synchronisation des équipements pour le header
     --------------------------- */
  function synchronizeEquipments() {
    const equipSlots = document.querySelectorAll('#equipmentView .iconArmors');
    equipSlots.forEach(slot => {
      const item = slot.querySelector('.item-img');
      if (item) {
        const decorative = slot.querySelector('.decorative-image');
        if (decorative) decorative.remove();
        item.removeEventListener('mousedown', startDragging);
        item.addEventListener('mousedown', startDragging);
        item.removeEventListener('touchstart', startDragging);
        item.addEventListener('touchstart', startDragging);
      } else {
        const decorative = slot.querySelector('.decorative-image');
        if (decorative) decorative.style.display = 'block';
      }
    });
    setTimeout(saveEquipmentState, 100);
  }

  /* ---------------------------
     Affichage de l'infobulle (tooltip) pour équipements
     --------------------------- */
  function showTooltipEquipements(event, itemElement) {
    const existing = document.querySelector('.tooltip');
    if (existing) existing.remove();
    if (itemElement.classList.contains('iconArmors')) {
      itemElement = itemElement.querySelector('.item-img');
    }
    if (!itemElement) return;
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.style.position = 'absolute';
    tooltip.style.backgroundColor = 'rgba(0,0,0,0.8)';
    tooltip.style.color = '#fff';
    tooltip.style.padding = '8px';
    tooltip.style.borderRadius = '5px';
    tooltip.style.fontSize = '12px';
    tooltip.style.zIndex = '1000';
    tooltip.style.display = 'none';
    let content = '';
    function addAttr(label, attr) {
      const val = itemElement.getAttribute(attr);
      if (val && val.trim() !== '' && val.toLowerCase() !== 'null') {
        content += `<strong>${label}:</strong> ${val}<br>`;
      }
    }
    addAttr('Nom', 'data-nom');
    addAttr('Type', 'data-type');
    addAttr('Strength', 'data-strength');
    addAttr('Durability', 'data-durability');
    addAttr('Life', 'data-life');
    addAttr('Armor', 'data-armor');
    addAttr('Prix', 'data-prix');
    addAttr('Rare', 'data-rare');
    addAttr('Money', 'data-money');

    if (!content) return;
    tooltip.innerHTML = content;
    tooltip.style.display = 'block';
    tooltip.style.left = (event.clientX + 10) + 'px';
    tooltip.style.top = (event.clientY + 10) + 'px';
    document.body.appendChild(tooltip);
    function onMouseMove(e) {
      tooltip.style.left = (e.clientX + 10) + 'px';
      tooltip.style.top = (e.clientY + 10) + 'px';
    }
    document.addEventListener('mousemove', onMouseMove);
    itemElement.addEventListener('mouseleave', function() {
      tooltip.remove();
      document.removeEventListener('mousemove', onMouseMove);
    }, { once: true });
  }

  /* ---------------------------
     Attachement des tooltips pour équipements
     --------------------------- */
  function attachTooltipEquipements() {
    document.querySelectorAll('#chestEquipmentMirror .item-img').forEach(item => {
      item.removeEventListener('mouseenter', tooltipEquipListener);
      item.addEventListener('mouseenter', tooltipEquipListener);
    });
  }
  function tooltipEquipListener(e) {
    showTooltipEquipements(e, e.currentTarget);
  }
  
  /* ---------------------------
     Rendu des objets dans l'inventaire (chestInventory)
     --------------------------- */
  function renderChestInventory(itemsArray) {
    const slots = document.querySelectorAll(".inventoryChest .slotChest");
    slots.forEach(slot => slot.innerHTML = "");
    itemsArray.forEach(item => {
      if (item.inventorychest) {
        const slotIndex = parseInt(item.inventorychest) - 1;
        const slot = slots[slotIndex];
        if (slot) {
          const img = document.createElement("img");
          img.setAttribute("data-id", item.id);
          img.setAttribute("data-nom", item.nom);
          img.setAttribute("data-type", item.type);
          if (item.strength) img.setAttribute("data-strength", item.strength);
          if (item.durability) img.setAttribute("data-durability", item.durability);
          if (item.life) img.setAttribute("data-life", item.life);
          if (item.armor) img.setAttribute("data-armor", item.armor);
          if (item.prix) img.setAttribute("data-prix", item.prix);
          if (item.rare) img.setAttribute("data-rare", item.rare);
          if (item.money) img.setAttribute("data-money", item.money);
          img.src = item.src;
          img.className = item.class;
          img.draggable = item.draggable;
          img.id = item.id;
          img.addEventListener("mouseenter", event => showTooltip(event, img));
          slot.appendChild(img);
        }
      }
    });
  }

  /* ---------------------------
     Initialisation du Drag & Drop pour l'inventaire
     --------------------------- */
  function initDragAndDrop() {
    const draggables = document.querySelectorAll('.item-img');
    const containers = document.querySelectorAll('.slotChest, .slotPlayerChest');
    draggables.forEach(draggable => {
      draggable.addEventListener('dragstart', function(e) {
        draggable.classList.add('dragging');
        draggable.dataset.source = draggable.parentElement.id;
      });
      draggable.addEventListener('dragend', function(e) {
        draggable.classList.remove('dragging');
        delete draggable.dataset.source;
      });
    });
    containers.forEach(container => {
      container.addEventListener('dragover', function(e) {
        e.preventDefault();
      });
      container.addEventListener('drop', function(e) {
        e.preventDefault();
        const draggedItem = document.querySelector('.dragging');
        if (!draggedItem) return;
        const sourceContainer = document.getElementById(draggedItem.dataset.source);
        const targetContainer = container;
        const existing = targetContainer.querySelector('.item-img');
        if (existing && existing !== draggedItem) {
          targetContainer.removeChild(existing);
          if (sourceContainer) {
            sourceContainer.appendChild(existing);
          }
        }
        targetContainer.appendChild(draggedItem);
        synchronizeInventories();
      });
    });
  }

  /* ---------------------------
     Synchronisation globale (inventaire et équipements)
     --------------------------- */
  function synchronizeInventories() {
    synchronizeEquipments();
    const chestSlots = document.querySelectorAll('.inventoryChest .slotChest');
    const savedItems = [];
    chestSlots.forEach((slot, index) => {
      const item = slot.querySelector('.item-img');
      if (item) {
        savedItems.push({
          id: item.id,
          nom: item.getAttribute('data-nom'),
          type: item.getAttribute('data-type'),
          strength: item.getAttribute('data-strength'),
          durability: item.getAttribute('data-durability'),
          life: item.getAttribute('data-life'),
          armor: item.getAttribute('data-armor'),
          prix: item.getAttribute('data-prix'),
          rare: item.getAttribute('data-rare'),
          money: item.getAttribute('data-money'),
           src: item.src,
           class: item.className,
          inventorychest: slot.dataset.slot || (index + 1)
        });
      }
    });
    localStorage.setItem("chest_inventory_" + chestId, JSON.stringify(savedItems));
  }

  /* ---------------------------
     Gestion de l'état des équipements
     --------------------------- */
  function saveEquipmentState() {
    const slots = document.querySelectorAll('#chestEquipmentMirror .iconArmors');
    const data = [];
    slots.forEach(slot => {
      const item = slot.querySelector('.item-img');
      if (item) {
        data.push({
          type: item.getAttribute('data-type'),
          src: item.src,
          id: item.getAttribute('data-id'),
          nom: item.getAttribute('data-nom'),
          strength: item.getAttribute('data-strength'),
          durability: item.getAttribute('data-durability'),
          life: item.getAttribute('data-life'),
          armor: item.getAttribute('data-armor'),
          prix: item.getAttribute('data-prix'),
          rare: item.getAttribute('data-rare'),
          money: item.getAttribute('data-money'),
        });
      } else {
        data.push(null);
      }
    });
    localStorage.setItem('specialArmorInventory', JSON.stringify(data));
  }
  
  const chestEquipContainer = document.getElementById('chestEquipmentMirror');
  if (chestEquipContainer) {
    const chestObserver = new MutationObserver(() => {
      saveEquipmentState();
      synchronizeEquipments();
    });
    chestObserver.observe(chestEquipContainer, { 
      childList: true, 
      subtree: true,
      attributes: true,
      attributeFilter: ['data-type', 'data-strength', 'data-durability'] 
    });
  }

  function createItem(type, src, id, nom, strength, durability, life, armor, prix, rare, money) {
    const img = document.createElement('img');
    img.setAttribute("data-id", id);
    img.setAttribute("data-nom", nom);
    img.setAttribute("data-type", type);
    if (strength) img.setAttribute("data-strength", strength);
    if (durability) img.setAttribute("data-durability", durability);
    if (life) img.setAttribute("data-life", life);
    if (armor) img.setAttribute("data-armor", armor);
    if (prix) img.setAttribute("data-prix", prix);
    if (rare) img.setAttribute("data-rare", rare);
    if (money) img.setAttribute("data-money", money);
    img.src = src;
    img.className = "item-img";
    img.draggable = true;
    img.addEventListener('dragstart', () => img.classList.add('dragging'));
    img.addEventListener('dragend', () => img.classList.remove('dragging'));
    img.addEventListener('mousedown', startDragging);
    return img;
  }

  function loadEquipmentState() {
    const data = JSON.parse(localStorage.getItem('specialArmorInventory'));
    if (!data) return;
    const slots = document.querySelectorAll('#chestEquipmentMirror .iconArmors');
    data.forEach((d, i) => {
      if (d && slots[i]) {
        slots[i].innerHTML = '';
        const newItem = createItem(d.type, d.src, d.id, d.nom, d.strength, d.durability, d.life, d.armor, d.prix, d.rare);
        slots[i].appendChild(newItem);
        reattachDragAndDrop();
        attachTooltipEquipements();
      }
    });
  }

  /* ---------------------------
     Drag & Drop pour équipements
     --------------------------- */
  function setupEquipmentDragAndDrop() {
    const equipmentSlots = document.querySelectorAll('.special-armors .iconArmors');
    equipmentSlots.forEach(slot => {
      slot.addEventListener('dragover', function(e) {
        e.preventDefault();
      });
      slot.addEventListener('drop', function(e) {
        e.preventDefault();
        const draggedItem = document.querySelector('.dragging');
        if (draggedItem) {
          const slotType = slot.getAttribute('data-type');
          const itemType = draggedItem.getAttribute('data-type');
          if (slotType !== itemType) {
            const source = document.getElementById(draggedItem.dataset.source);
            if (source) source.appendChild(draggedItem);
            return;
          }
          if (draggedItem.parentElement) {
            draggedItem.parentElement.removeChild(draggedItem);
          }
          slot.innerHTML = '';
          slot.appendChild(draggedItem);
          setTimeout(synchronizeEquipments, 100);
        } else {
          const decorative = slot.querySelector('.decorative-image');
          if (!slot.querySelector('.item-img') && decorative) {
            decorative.style.display = 'block';
          }
        }
      });
    });
  }

  /* ---------------------------
     Outil pour attacher les tooltips
     --------------------------- */
  function attachTooltip(selector) {
    document.querySelectorAll(selector).forEach(elem => {
      const target = elem.hasAttribute('data-type') ? elem : (elem.querySelector('img') || elem);
      target.addEventListener('mouseenter', event => showTooltip(event, target));
    });
  }

  // Initialisations principales
  loadEquipmentState();
  setupEquipmentDragAndDrop();
  initDragAndDrop();
  attachTooltip('.slotChest');
  attachTooltip('.iconArmors');

  const toggleEquipBtn = document.getElementById("toggle-equipement");
  if (toggleEquipBtn) {
    toggleEquipBtn.remove();
  }

  // Suppression d'éléments inutiles pour l'inventaire du coffre
  const chestContainer = document.querySelector(".chest");
  if (chestContainer) {
    const iconArmorsWithoutDataType = document.querySelectorAll(".iconArmors:not([data-type])");
    if (iconArmorsWithoutDataType.length > 0) {
      iconArmorsWithoutDataType[iconArmorsWithoutDataType.length - 1].remove();
    }
  }
</script>


:: CorvanDeceptionExplain {"position":"2700,1000","size":"100,100"}

**You:** “I… I needed your help. I thought claiming Corvan’s name would: ”  
**Brannon:** “: get me to shovel you free for free. A clever trick, but it’s on you now.”  
He shakes his head and stands. “Listen up: Corvan vanished ages ago after one of his dark Ritual he was known for. 
Folks say he hid himself in a secret tomb beneath the Ossuary Fields. You owe me for the digging: and for the lie.”  
(set: $CorvanQuest to true)
**Brannon:** “Go on, then! Find that old necromancer: or don’t come cryin’ back to me.”  
Before you can ask him anything else... you still have to figure out [[who you are|Classes]]?


:: CorvanDeceptionSilent {"position":"2600,1175","size":"100,100"}

Brannon narrows his eyes. “Silence won’t save you, mage. I want answers :  and I want my coin’s worth.”  
* [[Stammer an excuse|CorvanDeceptionExplain]]
* Remain silent

(cl}ick:"Remain silent")[
You face Brannon, silent. He muters some words, smiles, and then you fell weak. You fall to the ground and he puts you back [[where you belong|GameOverStarve]]
]


:: CourtCenter {"position":"8625,6825","size":"100,100"}
You step into the vast circular chamber. Moonlight filters through cracks in the obsidian dome, illuminating motes of bone dust drifting through the air. At the center stands a low crystalline dais, its facets radiating fractured light in a dozen directions. Hovering above the dais is Corvan’s fragmented essence poised for final reckoning: a swirling nebula of silver filaments, bone splinters, and ghost-lit motes that writhe like lost souls. Snatches of his final thoughts echo through the hall: whispers of grief, ambition, and regret: coalescing into a single, tremulous heartbeat that pulses beneath your feet.  

The statues in their alcoves shift slightly, their empty eyes fixed on that fractured aura, awaiting your judgment.  

* [[Raise your lantern and face the Court|FinalConfrontationSetup]]



:: CourtRecall {"position":"8575,6625","size":"100,100"}
\:: CourtRecall
You remember every trial: your struggle in the Mortuary, the Catacombs, the Ossuary, the Gallery, and beyond. Each site taught you a fragment of Corvan’s Severance Ritual. Now those fragments stand witness here.  
* [[Steady yourself and proceed|CourtCenter]]


:: CourtThreshold {"position":"8400,6625","size":"100,100"}
\:: CourtThreshold
A vaulted arch of cracked skulls frames the hall. Statues of twelve hooded figures stand in niches: each bearing the icon of a past, yours or someone elses. Their eyes glow as you pass; distant whispers speak of judgment.  
* [[Walk forward, lantern raised|CourtCenter]]  
* [[Pause and recall your trials|CourtRecall]]


:: CrackedReflectionPoolArrival [NEXUS] {"position":"1700,1800","size":"100,100"}

\:: CrackedReflectionPoolArrival
You stand before the **Cracked Reflection Pool**, its glassy surface fractured by an obsidian mirror sunken beneath the water. Ghostly sobs echo as reflections twist at the edge of your vision. 
What do you do?  
* [[Reach in barefoot to touch the shards|CRPStupidChoice]]  
* [[Gaze into the fractured mirror|CRPDefaultInteraction]]  
* (if: $job is 4)[[Use Ghost Step to slip behind the mirror’s surface|CRPWhispered]]  
* (if: $backStory is 10)[[Recognize scenes of your childhood in the reflections|CRPBS10Orphan]]  
* [[Return to the square|VelthornHollowOrientation]]













:: CryptAntechamber {"position":"3300,4175","size":"100,100"}
\:: CryptAntechamber
You step into the Inner Crypt’s vaulted chamber. Torches gutter in iron sconces, casting long shadows over an obsidian altar. Embedded in its center rests a pulsating, crimson heart: Corvan’s heart: still beating with necrotic life. The air hums with whispered power.  
What do you do?  
* [[Approach the heart and touch it|CryptHeartDiscovery]]  
* [[Circle the chamber, looking for traps|CryptSearchAround]]  
* [[Flee back to the village|VelthornHollowOrientation]]

























:: CryptCallSpirit {"position":"2450,9150","size":"100,100"}
\:: CryptCallSpirit
Your voice cracks through the iron. The moans hush for a heartbeat, then a hollow whisper: “Free me…”  
* [[Attempt to unlock the iron bars|CryptTryUnlock]]  
* [[Withdraw in fear|SilentCryptArrival]]


:: CryptChantFinalLine {"position":"2575,9275","size":"100,100"}
\:: CryptChantFinalLine
You murmur the rite’s last phrase. The runes flare then crumble, and the bars swing open. Inside, a librarian’s ghost holds a bone‑etched key.  
* [[Step through and speak to the spirit|CryptSpeakSpirit]]  
* [[Retreat to gather courage|SilentCryptArrival]]


:: CryptEntry [NEXUS] {"position":"2550,3200","size":"200,200"}
\:: CryptTunnelEntrance
The hatch closes with a hollow *clang*, and you slip into a claustrophobic tunnel. Your lantern’s form the sole circle of light. It dances over slick stone walls, betraying you sometimes, loosing its form, trying to escape? Somewhere ahead, you hear three distinct things:  
1. A soft *drip… drip… drip* echoing in the dark.  
2. A distant, ragged *breath* that doesn’t match your own.  
3. Faint carvings glowing with pale phosphorescence: runes half-eroded by time.  
Which do you follow?  
* [[Trace the dripping water to its source|TunnelFollowDrips]]  
* [[Move toward the ragged breath|TunnelFollowBreath]]  
* [[Study the glowing runes on the wall|TunnelFollowRunes]]  
* [[Step back: this place already unsettles you|VelthornHollowOrientation]]
























:: CryptHeartDiscovery {"position":"2775,4125","size":"100,100"}
\:: CryptHeartDiscovery
You lay a trembling hand on the heart. It pulses once… twice… then stills. With a crack, it lifts from the altar and hovers before you, veins of shadow trailing in the torchlight.  
The heart speaks in a rasped whisper: “Who dares command my blood?”  
* [[Demand its name|HeartDialogueName]]  
* [[Order it to speak of Corvan’s fate|HeartDialogueFate]]  
* [[Threaten to crush it|HeartDialogueThreat]]  
* [[Flee back to the village|VelthornHollowOrientation]]


:: CryptInspectTiles {"position":"2700,9025","size":"100,100"}
\:: CryptInspectTiles
The floor tiles are frosted with bone‑dust. One bears a faint footprint made for bare feet: you remember walking these stones in a past life.  
* [[Step onto the marked tile|CryptStepMarked]]  
* [[Avoid it and move on|SilentCryptArrival]]


:: CryptLightCandle {"position":"2575,9025","size":"100,100"}
\:: CryptLightCandle
You light a candle from your lantern. Its blue flame flares: and for an instant the bars glow with runic script: “Bound by final rite.”  
(set: $journal to it + (a: "I found what seeems to be a clue: final rite binds the captive "+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Study the script closely|CryptStudyScript]]  
* [[Blow out the candle|SilentCryptArrival]]


:: CryptOpenVaultDoor {"position":"3575,9225","size":"100,100"}
\:: CryptOpenVaultDoor
The key turns; the lock releases with a clang. The door swings inward to reveal a torch‑lit corridor descending into Corvan’s sealed vault.  
* [[Step forward into the vault entrance|VaultEntrance]]  
* [[Hesitate, heart pounding|CryptPrepare]]


:: CryptPeerMoans {"position":"2450,9025","size":"100,100"}
\:: CryptPeerMoans
You press your ear to the bars. Muffled sobs and rattles echo inside: a bound spirit struggling for release.  
* [[Call out to it|CryptCallSpirit]]  
* [[Step back: this feels wrong|SilentCryptArrival]]


:: CryptPrepare {"position":"3775,3900","size":"100,100"}
\:: CryptPrepare
You take a moment in the dim torchlight to steady your breathing. Moist air clings to your skin as you strap your weapon to your side and check your gear: your lantern’s flame, your journal of clues, and whatever wards or charms you’ve gathered. The heavy stone door looms before you, its surface etched with Corvan’s tri‑burial sigil.  
* [[Push the door open and confront whatever waits inside|CryptAntechamber]]  
* [[Steal a last glance at the runes and murmur the ward formula|CryptAntechamber]]



:: CryptSearchAround {"position":"2950,4150","size":"100,100"}
\:: CryptSearchAround
You circle the chamber, inspecting broken bones and faded runes. It seems clear: no traps, just the altar and the heart. The pulse of necrotic magic grows stronger the closer you get.  
* [[Approach the heart and touch it|CryptHeartDiscovery]]  
* [[Flee back to the village|VelthornHollowOrientation]]


:: CryptSearchTools {"position":"2450,9400","size":"100,100"}
\:: CryptSearchTools
You rummage through your pack: no lockpicks, only bandages and rations.  
* [[Drop to one knee and think|SilentCryptArrival]]


:: CryptSecretPassage {"position":"3175,9150","size":"100,100"}
\:: CryptSecretPassage
You wriggle through and enter a bone‑lined corridor. The air hums with ward magic. Ahead, an iron door bears Corvan’s tri‑burial sigil.  
* [[Approach the door|CryptVaultDoor]]  
* [[Pause to catch your breath|CryptPrepare]]


:: CryptSeveredTrigger {"position":"2825,9025","size":"100,100"}
\:: CryptSeveredTrigger
Your ritual‑scar aches as you touch the bars. A voice in your mind recites the Severance incantation you endured. The runes loosen: one bar slides aside, revealing a narrow gap.  
* [[Slip through the gap|CryptSecretPassage]]  
* [[Step away, shaken|SilentCryptArrival]]


:: CryptShowScar {"position":"2575,9525","size":"100,100"}
\:: CryptShowScar
Your arm’s ritual mark glows faintly in the candlelight. The ghost bows and offers the key. 
(set: $inventory to it + “Severance Key”)  
* [[Thank the spirit and step back|SilentCryptArrival]]


:: CryptSpeakSpirit {"position":"2575,9400","size":"100,100"}
\:: CryptSpeakSpirit
**Spirit:** “If you carry the scar of Severance, prove your claim.”  
* [[Show your ritual scar|CryptShowScar]]  
* [[Hesitate|SilentCryptArrival]]


:: CryptStepMarked {"position":"2700,9150","size":"100,100"}
\:: CryptStepMarked
The tile depresses and a hidden panel slides open at the south wall: revealing the back of the rune‑sealed bars. A corridor beyond glows with blue lantern light.  
* [[Crawl through the opening|CryptSecretPassage]]  
* [[Close the panel and step back|SilentCryptArrival]]


:: CryptStudyScript {"position":"2575,9150","size":"100,100"}
\:: CryptStudyScript
You kneel and trace the words: they describe the Severance Rite you endured. Chant its last line, and the bars may open.  
* [[Whisper the final line|CryptChantFinalLine]]  
* [[Stand and reconsider|SilentCryptArrival]]


:: CryptStudyVaultSigil {"position":"3175,9400","size":"100,100"}
\:: CryptStudyVaultSigil
The sigil’s loops trace your own ritual scars. It reads: “Only one reborn through death may enter.”  
* [[Insert the Severance Key|CryptOpenVaultDoor]]  
* [[Step back for one last moment|SilentCryptArrival]]


:: CryptTryUnlock {"position":"2450,9275","size":"100,100"}
\:: CryptTryUnlock
The bars are sealed by runes. You need something to break their magic: or a key.  
* [[Search your pack for tools|CryptSearchTools]]  
* [[Step back and think|SilentCryptArrival]]


:: CryptVaultDoor {"position":"3175,9275","size":"100,100"}
\:: CryptVaultDoor
You stand before the armored door etched with three loops. A keyhole glows faintly where the Severance Key fits.  
* [[Use the Severance Key|CryptOpenVaultDoor]]  
* [[Study the sigil|CryptStudyVaultSigil]]


:: Damage {"position":"2625,150","size":"100,100"}
(click:"")[
(display:"Roll2D")

 (live: 3s)[
    (stop:)
You lost (str:$diceRoll) health points
(set:$health to it - $diceRoll)

 ]
 ]
 <!-- - armor ? -->


:: DamageTestPassage {"position":"1375,2225","size":"100,100"}
{
(set:$introText to "You rap on each tomb door. Silence answers: until a loose panel slams shut behind you, making you jump.")
(set:$clickTest to "making you jump")
(set:$AttributeTest to $charisma)
(set:$SuccessText to "You stand up, picking yourself up, and whatever tried to intimidate you crawls back to where it came from.")
(set:$FailureText to "The loose panel snaps over your shoulder, slamming you forward into a narrow corridor.")
(set:$clickDamage to "narrow corridor")
(set:$damageType to 2)
(set:$DeathText to "Before you can recover, the chamber door behind you swings shut with bone-crushing force, trapping your chest between stone and wood. Your ribs fracture, lungs collapse, and the world goes black as your last breath is squeezed from you in a final, rattling gasp.")
(set:$currentEnding to 27)
(set:$LinkText to "Step back, heart still racing")
(set:$FailureLinkText to "Step back, heart racing")
(set:$Link to "ForgottenGraveyardGateArrival")

(set:$xpSuccess to 35)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:"MacroPassage")


:: Deroule {"position":"3700,5075","size":"100,100"}
START
Buried in cemetery

Dialog
Who are you ?

CHARACTER

You are not him ? (Starts to leave)

I can give you (weapon or Silver)

Choose backstory

Enter Velthorn Hollow

- Merchant 1
- Merchant 2
- Big House
- 
-


Find the heart > Put it on the heart speaks.
 
Leave the village : 
Crypt > First Guardian > Fight > Death

Descent into the Necropolis – Second Burial
Silver coffin

Find the brain > Put it on

Leave the village : 
Crypt > second Guardian > Fight > Death

Third Place : 
A bone coffin, you are inside the skeleton of a ...
It is not a coffin so much as a corpse. Flesh still attached at some places. You are in the rip cage of the beast. The air is the worst. The smell. You cough, the irritation cloating your air ways. You mange to scream, but there is no one to help you. After a while of moving, hitting desperatly, the carcasse collapses on you
DAMAGE
But the grave is shallow, so you start to see a light.
You gather what remains of your strength and start crawling toward the surface.
The sky is black, no stars, nothing to welcome you.

If you are killed my Magister Corvan, you go back to the wooden coffin

Discovery
Corvan split his soul into three vessels: body(heart), mind(brain), and name. The final choice is whether to bind his essence, replace him as the new Magister, or destroy his remnants entirely.

Depending on the final choices, the Veil is either mended, torn apart, or replaced by a new order under the player’s rule.


:: DestroyEnding [ENDING] {"position":"9350,8650","size":"100,100"}
With ritual knife in hand, you slash through each vessel: heart, brain, and name: sending a shockwave of crystalline shards across the Court of Severance. Bone splinters rain down as Corvan’s last vestiges snap free. The statues shatter one by one, and the vaulted chamber trembles before collapsing into dust.

With a single stroke, you shatter Corvan’s last remnants: bone, brain, and name: unleashing a cascade of glass and dust.

(if: $job is 1)[  
  As a Gravebinder, you break every chain you once respected: tombs collapse and spirits flee, leaving the Necropolis empty and silent.  
]  
(elseif: $job is 2)[  
  As a Bone-Singer, you silence the chorus of bones: no more melodies echo in ossuaries, only the hush of ruin.  
]  
(elseif: $job is 3)[  
  As a Spellwright, your final rune obliterates wards: magic itself fractures, leaving the world more mortal than before.  
]  
(elseif: $job is 4)[  
  As a Lantern-Tender, your flame snuffs out the lantern woods: no wisp remains to guide, only darkness.  
]  
(elseif: $job is 5)[  
  As a Courtier, you void every oath: treaties unmade, alliances severed, the Pale Court collapses into anarchy.  
]  
(else:)[  
  As a Shadowstrider, you erase every footprint: no path remains in the catacombs, only the void you create.  
]

(if: $backStory is 1)[  
  Once Plagueborn, your Red Fog Serum boils away: no cure remains for plague here; the living cling ever more desperately to life.  
]  
(elseif: $backStory is 2)[  
  Graverobber’s Bastard no longer robs: crypt doors lock forever, and every stolen secret turns to dust in your wake.  
]  
(elseif: $backStory is 3)[  
  Apprentice of Death, your necromancy ends: no soul stirs at your command, and the dead sleep on undisturbed.  
]  
(elseif: $backStory is 4)[  
  Lantern Tender no more, your flame dies: souls wander lost, and nighttime fears return to haunt the village.  
]  
(elseif: $backStory is 5)[  
  Noble Scion, your lineage crumbles: no memorial stands to honor past glories, and the Court’s history ends with you.  
]  
(elseif: $backStory is 6)[  
  Last of the Severed, your chains lie broken: no sacrifice left to bind, and the Severance Rite is forgotten.  
]  
(elseif: $backStory is 7)[  
  Worm-cultist, your parasite dies: no rot grants knowledge, and forbidden lore is lost to time.  
]  
(elseif: $backStory is 8)[  
  Grave Singer, your final dirge falls silent: no tears echo, and sorrow has no voice.  
]  
(elseif: $backStory is 9)[  
  Ashen Veteran, your war ends: no more battles cry for your steel, and peace bleeds quietly across the land.  
]  
(elseif: $backStory is 10)[  
  Orphan of Greyglass, your graffiti fades: no mark remains of your survival, and every alley lies blank.  
]  
(elseif: $backStory is 11)[  
  Pilgrim of Bones, your hymn ends: the monastery’s gates close forever, and prayers go unheard.  
]  
(else:)[  
  Returned from the Veil, you cross once more into oblivion: no bridge remains, and the worlds stay sundered.  
]

You awaken in the bone-choked tunnel beneath the cemetery gate, your hands slick with ichor and glass. The world is silent: no hiss of spirits, no echo of footsteps, only your ragged breath. Clambering free, you emerge under a pale sunrise, the old cemetery gate hanging open at your touch.

Velthorn Hollow’s Quiet Reprieve
The village feels emptier without ghosts: and yet closer to peace. The sap-drunk mugs stagnate; lanterns flicker out; statues that once wept now stand cold and dry. Mourning Oak’s patrons sip ale without visions, and for the first time, the living outnumber the dead. Villagers breathe easier, though at what cost they do not yet know.

The Necropolis Fallen Silent
Enter the Gate and the Mortuary Hall stands stripped of wards: doors lie open, corridors lie bare, ossuaries lie emptied. No ferryman rows the River of Forgotten Names, for no name remains to guide. The labyrinth becomes a ruin once more, a place for fearless archaeologists rather than mourners or necromancers.

<!-- if you are severd yourself...-->

A World Without Severance
By shattering Corvan’s final remnants, you end his unnatural grasp on life and death: but you leave a wound in the Veil. The boundary between worlds lies open, bleeding: a silent dark that creeps outward unless someone tends the fracture. You vanish from the village’s memory, becoming a ghost story told to children, while the Necropolis drifts into legend, a place of bones and broken promises.

(set:$currentEnding to 3)
(display:"RestartDonnee")

{
<script>
setTimeout(() => {
  gainXp(2000);
}, "1000");
</script>
}


:: DetecterBonObjet {"position":"725,125","size":"100,100"}
[[Admin]]
{
<!--Block ou donner le bon objet -->
<div id="donation-box" class="donation-box">
 <img style="width: 60%;" class="decorative-image" src="https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Casque.png">
  <span class="subtext">Offer the astronaut's helmet</span>
</div>

<!-- Résultat -->
<p id="donation-result" class="donation-message"></p>

<!-- Inventaire -->
<div class="chest">
  <div class="inventoryPlayerChest" id="chestInventory">
    <div class="slotPlayerChest">
      <img src="helmet.png" class="item-img" data-nom="astronaut's helmet" data-type="helmet">
    </div>
    <!-- Vous pouvez ajouter d'autres objets ici -->
  </div>
</div>

<!-- Récompense -->
<div id="recompenseDonPassage">
  [Start2]] 
</div>

<script>
const donationManager = {
  init() {
    const box = document.getElementById('donation-box');
    box.addEventListener('dragover', this.handleDragOver);
    box.addEventListener('drop', this.handleDrop.bind(this));
  },

  handleDragOver(e) {
    e.preventDefault();
    e.target.classList.add('hover');
  },

  handleDrop(e) {
    e.preventDefault();
    e.target.classList.remove('hover');

    const item = document.querySelector('.dragging');
    if (!item) return;

    if (this.isValidItem(item)) {
      item.remove();
      this.showResult("Perfect, you may proceed", "gold");
      document.getElementById('donation-box').style.display = 'none';
      document.getElementById('recompenseDonPassage').style.display = 'block';
    } else {
      this.showResult("This is not the correct item", "red");
    }
  },

  isValidItem(item) {
    return item.dataset.nom === "astronaut's helmet" && item.dataset.type === "helmet";   //(nom + type objet pour vérifier l'objet)
  },

  showResult(msg, color) {
    const result = document.getElementById('donation-result');
    result.textContent = msg;
    result.style.color = color;
    setTimeout(() => result.textContent = '', 3000);
  }
};

const dragManager = {
  currentItem: null,
  clone: null,
  originalSlot: null,

  init() {
    document.addEventListener('pointerdown', this.startDrag.bind(this));
  },

  startDrag(e) {
    const item = e.target.closest('.item-img');
    if (!item) return;

    this.currentItem = item;
    this.originalSlot = item.parentElement;

    item.classList.add('dragging');

    this.createClone(e);
    document.addEventListener('pointermove', this.moveClone);
    document.addEventListener('pointerup', this.dropItem.bind(this));
  },

  createClone(e) {
    this.clone = this.currentItem.cloneNode(true);
    this.clone.style.position = 'fixed';
    this.clone.style.width = '60px';
    this.clone.style.height = '60px';
    this.clone.style.pointerEvents = 'none';
    this.clone.style.transform = `translate(${e.clientX - 30}px, ${e.clientY - 30}px)`;
    document.body.appendChild(this.clone);
  },

  moveClone(e) {
    if (!this.clone) return;
    this.clone.style.transform = `translate(${e.clientX - 30}px, ${e.clientY - 30}px)`;
  },

  dropItem(e) {
    document.removeEventListener('pointermove', this.moveClone);
    document.removeEventListener('pointerup', this.dropItem);
    this.clone?.remove();
    this.currentItem?.classList.remove('dragging');

    const dropTarget = document.elementFromPoint(e.clientX, e.clientY);
    const validContainer = dropTarget?.closest('.slotPlayerChest');

    if (validContainer) {
      this.moveToContainer(validContainer);
    } else if (!dropTarget?.closest('#donation-box')) {
      this.returnToOriginalSlot();
    }
  },

  moveToContainer(container) {
    const existingItem = container.querySelector('.item-img');
    if (existingItem) {
      this.originalSlot.appendChild(existingItem);
    }
    container.appendChild(this.currentItem);
  },

  returnToOriginalSlot() {
    this.originalSlot.appendChild(this.currentItem);
  }
};

donationManager.init();
dragManager.init();
</script>
</body>
</html>}


:: Don {"position":"1100,125","size":"100,100"}
{
<style>.money{display:none;}</style>
<!-- Boîte de don -->
<div id="donation-box" class="donation-box">
  🎁 <strong>Offer a sacred object</strong><br>
  <span class="subtext">Drag an item here... the Xylith will judge its value</span>
</div>

<!-- Résultat -->
<p id="donation-result" class="donation-message"></p>

<!-- Coffre -->
<div class="chest">
  <div class="inventoryPlayerChest" id="chestInventory">
    <!-- Slots d'inventaire -->
    <div class="slotPlayerChest"><img src="helmet.png" class="item-img" data-nom="astronaut's helmet" data-type="helmet"></div>
    <!-- Ajouter d'autres slots selon besoin -->
  </div>
</div>

[[Admin]] 
<style>
.donation-box {
  border: 3px dashed gold;
  border-radius: 20px;
  padding: 30px;
  margin: 30px auto;
  width: 300px;
  text-align: center;
  background: linear-gradient(to bottom right, #1f1f1f, #3b3b3b);
  color: gold;
  font-family: 'Trebuchet MS', sans-serif;
  transition: all 0.3s ease;
  cursor: grab;
}
<script>
// Gestionnaire de dons
const donationManager = {
  init() {
    const box = document.getElementById('donation-box');
    box.addEventListener('dragover', this.handleDragOver);
    box.addEventListener('drop', this.handleDrop.bind(this));
  },

  handleDragOver(e) {
    e.preventDefault();
    e.target.classList.add('hover');
  },

  handleDrop(e) {
    e.preventDefault();
    e.target.classList.remove('hover');
    
    const item = document.querySelector('.dragging');
    if (!item) return;

    if (this.isValidItem(item)) {
      item.remove();
      this.updateMoney(500);
      this.showResult("Thank you for your donation. 500 coins added!", "green");
      
          document.getElementById('donation-box').style.display = 'none';
    } else {
      this.showResult("Object refused by the Xylith", "red");
    }
  },

  isValidItem(item) {
    return item.dataset.nom === "astronaut's helmet" && item.dataset.type === "helmet";
  },

updateMoney(amount) {
  // Récupérer l'argent actuel dans le localStorage ou initialiser à 0
  let money = parseInt(localStorage.getItem('playerMoney') || 0) + amount;

  // Mettre à jour la valeur dans le localStorage
  localStorage.setItem('playerMoney', money);

    $money = money;
},
  showResult(msg, color) {
    const result = document.getElementById('donation-result');
    result.textContent = msg;
    result.style.color = color;
    setTimeout(() => result.textContent = '', 3000);
  }
};

// Système de drag & drop
const dragManager = {
  currentItem: null,
  clone: null,
  originalSlot: null,

  init() {
    document.addEventListener('pointerdown', this.startDrag.bind(this));
  },

  startDrag(e) {
    const item = e.target.closest('.item-img');
    if (!item) return;

    this.currentItem = item;
    this.originalSlot = item.parentElement;
    
    item.classList.add('dragging');
    
    this.createClone(e);
    document.addEventListener('pointermove', this.moveClone);
    document.addEventListener('pointerup', this.dropItem.bind(this));
  },

  createClone(e) {
    this.clone = this.currentItem.cloneNode(true);
    this.clone.style.position = 'fixed';
    this.clone.style.width = '60px';
    this.clone.style.height = '60px';
    this.clone.style.pointerEvents = 'none';
    this.clone.style.transform = `translate(${e.clientX - 30}px, ${e.clientY - 30}px)`;
    document.body.appendChild(this.clone);
  },

  moveClone(e) {
    if (!this.clone) return;
    this.clone.style.transform = `translate(${e.clientX - 30}px, ${e.clientY - 30}px)`;
  },

  dropItem(e) {
    // Cleanup
    document.removeEventListener('pointermove', this.moveClone);
    document.removeEventListener('pointerup', this.dropItem);
    this.clone?.remove();
    this.currentItem?.classList.remove('dragging');

    // Handle drop
    const dropTarget = document.elementFromPoint(e.clientX, e.clientY);
    const validContainer = dropTarget?.closest('.slotPlayerChest, .iconArmors');

    if (validContainer) {
      this.moveToContainer(validContainer);
    } else if (!dropTarget?.closest('#donation-box')) {
      this.returnToOriginalSlot();
    }
  },

  moveToContainer(container) {
    const existingItem = container.querySelector('.item-img');
    if (existingItem) {
      this.originalSlot.appendChild(existingItem);
    }
    container.appendChild(this.currentItem);
  },

  returnToOriginalSlot() {
    this.originalSlot.appendChild(this.currentItem);
  }
};

// Initialisation
donationManager.init();
dragManager.init();
</script>
}


:: DreamAskCost {"position":"5125,6125","size":"100,100"}
\:: DreamAskCost
**You:** “What cost did your ritual demand?”  
**Corvan:** “Every birthright, reality itself, the city I grew up in and lived my entire life, the city of Light. My name was erased, my body fractured, my heart damned. Yet even this was not enough…”  
He turns, spotlighting you.  
**Corvan:** “Now witness the final sacrifice.”  

* [[Recoil as the chamber shudders|DreamBeastApproach]]  


:: DreamAskWife {"position":"4925,6125","size":"100,100"}
\:: DreamAskWife
**You (soft):** “Who was she?”  
**Corvan:** “She choose the worst profession... working with those damned machines!"
**You (intrigued):** “Machines? What are those?"
Corvan’s eyes harden.  
**Corvan (lost in his thought):** “She was my anchor. When Mara died… I severed my first link to mortality. The ritual began as love... and ended as hubris.”  

(set: $journal to it + (a: "I learned Corvan lost his wife Mara, sparking the Severance Ritual"+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Press him on the ritual’s cost|DreamAskCost]]  
* [[Step back, unsettled|DreamChamberCloser]]  


:: DreamBeastApproach {"position":"5275,6275","size":"100,100"}
\:: DreamBeastApproach
From the shadows, a colossal beast of bone and sinew emerges: its maw dripping with ectoplasm and earth. Its eyes are hollow lanterns, its breath a fetid wind. Corvan smiles, raising his hands.  
**Corvan:** “Feed, oh great Astaroth. Your time is not there yet, but soon, in another place.”  

* [[Prepare to defend|DreamDefend]]  


:: DreamChamberApproach {"position":"4725,6300","size":"100,100"}
\:: DreamChamberApproach
Corvan’s voice echoes, hollow and resonant:  
**Corvan:** “To master death, one must fracture one’s soul.”  
He traces a rune in the air; for an instant it blooms into a blossoming black flower. Behind him the coffin-vessels glow.  

* [[Step closer|DreamChamberCloser]]  


:: DreamChamberCloser {"position":"4900,6300","size":"100,100"}
\:: DreamChamberCloser
As you draw near, the heart-coffin hisses and drips molten silver. Corvan stands, robes sweeping bone-shards.
A shadowy figure materializes and he shivers. You look at him intensly, and he breaks silence.
**Corvan:** “Grief is a mistress crueler than Fate...”  
He glances to a dust-cloaked portrait on the wall: a woman’s face ringed in sorrow.  

* [[Ask about his wife|DreamAskWife]]  
* [[Remain silent|DreamSilentWitness]]  


:: DreamConsumed {"position":"5875,6275","size":"100,100"}
\:: DreamConsumed
Bone-shards pierce your flesh and you feel Corvan’s laughter echo as the creature’s maw closes. Pain blossoms across your mind: and then, oblivion.  

* [[Wake up if you dare...|RiverCourt]]



:: DreamDefend {"position":"5475,6275","size":"100,100"}
\:: DreamDefend
You grip your weapon, stance tense. The beast snarls, advancing on four spindly legs. Each footfall cracks bone-tiles beneath you. Around it, reality itself seems to warp, to get redefined. The cathedral becomes a forest. Then, trees become cities and then a desert made of sable roses. 

* [[Strike at its flank|DreamStrike]]  
* [[Dodge to the side|DreamDodge]]  


:: DreamDodge {"position":"5675,6150","size":"100,100"}
\:: DreamDodge
You roll aside; the beast’s teeth catch the floor with a thunder-crack. It whips around and closes in, jaws gaping.  

* [[Stand and face it anyway|DreamConsumed]]  


:: DreamSilentWitness {"position":"5050,6450","size":"100,100"}
\:: DreamSilentWitness
Corvan doesn’t notice you. He pours black sand from the heart-coffin into the brain-coffin with a chant that warps the air. Strange shapes flicker: metal rounded and interlocking shapes that form a contraption, much to Crovan's dismay. He waves his hand and they change shape: corpse-flowers, skeletal birds, and mirrored faces.  
* [[Watch in awe|DreamBeastApproach]]  


:: DreamStrike {"position":"5700,6425","size":"100,100"}
\:: DreamStrike
Your blade sears through decayed sinew: beast shrieks in a sound like breaking gravestones. Yet it lunges, jaws snapping shut around you.  

* [[Scream as darkness floods your vision|DreamConsumed]]  


:: DreamVision {"position":"4525,6300","size":"100,100"}
\:: DreamVision
You slip into darkness as pain fades. Moments later you stand in a cathedral-sized chamber, torchlight dancing across walls of bone and obsidian. 
But it is not the time or place you have known your entire life. No, this cathedral is of Metal, and its hartbeat is mechanical, not a choir but the steady rhythm of a machine.
"Attrocity!" A desperate voice. 
At its center, Corvan kneels before three sarcophagi: one heart-shaped, one brain-shaped, one inscribed simply with a blank nameplate.  

* [[Approach silently|DreamChamberApproach]]  






















:: EchoesApprenticeTrigger {"position":"425,6725","size":"100,100"}
\:: EchoesApprenticeTrigger
You raise your bone wand; its tip hums. The fountain’s surface parts, revealing a spiral stair descending into bone‑choked darkness.  
* [[Descend the spiral stair|EchoesDescendStair]]  
* [[Lower your wand and step back|OssuaryEchoesArrival]]


:: EchoesApproachColumn {"position":"162.5,6975","size":"100,100"}
\:: EchoesApproachColumn
You approach the column. Its base is carved with looping knots. A faint crack reveals a hidden alcove.  
* [[Prise the stone open|EchoesHiddenAlcove]]  
* [[Ignore and explore elsewhere|OssuaryEchoesArrival]]


:: EchoesBoneTunnel {"position":"575,6975","size":"100,100"}
\:: EchoesBoneTunnel
You enter a narrow tunnel; bone shards crunch underfoot and phosphorescent mold pulses along the walls.  
* [[Follow the mold’s glow|EchoesFollowMold]]  
* [[Step carefully and listen|EchoesListenDrip]]


:: EchoesDescendStair {"position":"450,6975","size":"100,100"}
\:: EchoesDescendStair
The slippery stair winds down between bone walls. Whispers chase your heels.  
* [[Press on into the gloom|EchoesBoneTunnel]]  
* [[Climb back up|OssuaryEchoesArrival]]


:: EchoesExamineBones {"position":"287.5,6725","size":"100,100"}
\:: EchoesExamineBones
You sift through the femurs. A single skull bears your master’s sigil carved in haste: your old notes warned of such a marker here.  
* [[Hold the skull aloft|EchoesSkullVision]]  
* [[Place it back gently|OssuaryEchoesArrival]]


:: EchoesFollowMold {"position":"750,6975","size":"100,100"}
\:: EchoesFollowMold
The mold leads to an iron door carved with the tri‑burial sigil. The Obsidian Ossuary Key fits perfectly.  
* [[Insert the key and turn|EchoesOpenVaultDoor]]  
* [[Hesitate at the threshold|EchoesBoneTunnel]]


:: EchoesHiddenAlcove {"position":"175,7100","size":"100,100"}
\:: EchoesHiddenAlcove
Inside the alcove you find a small obsidian key, etched with your apprentice’s mark.  
(set: $inventory to it + “Obsidian Ossuary Key”)  
* [[Pocket the key|OssuaryEchoesArrival]]


:: EchoesListen {"position":"162.5,6850","size":"100,100"}
\:: EchoesListen
Amid the cacophony, you hear: “Beneath the seventh arch, the heart first shines.” A rune on a distant column glows in response.  
(set: $journal to it + (a: "I heard what could be a clue: “Beneath the seventh arch, the heart first shines.”"+ "\n\n"))
* [[Step toward the glowing column|EchoesApproachColumn]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}


:: EchoesListenDrip {"position":"575,7100","size":"100,100"}
\:: EchoesListenDrip
A steady drip echoes ahead. Leaning in, you hear the distant pulse of the Brain Reliquary’s wards.  
* [[Move toward the sound|EchoesFollowMold]]  
* [[Return to the stair|EchoesDescendStair]]


:: EchoesOpenVaultDoor {"position":"625,6800","size":"100,100"}
\:: EchoesOpenVaultDoor
With a click, the door swings open, revealing a carved stone stair leading upward into torch‑lit vaults.  
* [[Step through into Corvan’s sealed vault|VaultEntrance]]  
* [[Pause to steel yourself|CryptPrepare]]


:: EchoesShout {"position":"175,6725","size":"100,100"}
\:: EchoesShout
Your voice booms, and thousands of ghostly replies answer back, each one uttering a fragment of Corvan’s name. The floor rumbles.  
* [[Listen for a meaningful phrase|EchoesListen]]  
* [[Fall silent, overwhelmed|OssuaryEchoesArrival]]


:: EchoesSipEctoplasm {"position":"50,6725","size":"100,100"}
\:: EchoesSipEctoplasm
You cup your hand and taste the cold ectoplasm. Insight floods your mind: visions of lost rituals and the secret path beneath the bones: but a wisp of a vengeful spirit lunges for your throat!
(click:"your throat")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $charisma >= $diceRoll)
    [
    [[You steel yourself and stand firm|EchoesStandFirm]]
    ]
(else:)
    [You manage to dodge the spirit but have to [[Pull back in alarm|OssuaryEchoesArrival]]  
    ]

 ]
 ]




:: EchoesSkullVision {"position":"287.5,6850","size":"100,100"}
\:: EchoesSkullVision
The skull’s empty eye‑sockets flame with pale light. You glimpse Corvan chanting over a crystal reliquary… then darkness returns.  
(set: $journal to it + (a: "I had a vision of Corvan chanting over a crystal reliquary"+ "\n\n"))
* [[Step away|OssuaryEchoesArrival]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}


:: EchoesStandFirm {"position":"50,6850","size":"100,100"}
\:: EchoesStandFirm
You steel your mind and banish the spirit with a thought. The fountain’s glow pulses gratefully.  
Looking at the water again, it seems now to be filled with shards of silver.
<!--(set: $buff to it + “Spirit Ward”)  -->
(click:"shards of silver")[

<!--AJOUTER OBJET-->
{
    <script>
    // Tableau contenant l'objet à créer
  const newItemData =     { id: "moneySmall", nom: "Money", type: "money", class: "item-img", draggable: true, inventorychest: "6", money: 500, src: "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Money/Money.png", rare: "Common", inventory: 20,  }

   // Création de l'élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute('data-id', newItemData.id);
  itemElement.setAttribute('draggable', 'true');

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory')) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));

  itemElement.addEventListener('mouseenter', (e) => showTooltip(e, itemElement));
  itemElement.addEventListener('touchstart', (e) => showTooltip(e, itemElement), { passive: false });
</script>
}
]
* [[You can now step back|OssuaryEchoesArrival]]


:: EffigiesCountHeads {"position":"662.5,8475","size":"100,100"}
\:: EffigiesCountHeads
You count thirteen statues. At the thirteenth, the sap ceases: then gushes all at once, flooding the floor with ebony liquid.  
* [[Retreat carefully|WeepingEffigiesArrival]]  
* [[Brace and let the sap flow over your boots|EffigiesSapFlow]]


:: EffigiesDescendStair {"position":"1025,8700","size":"100,100"}
\:: EffigiesDescendStair
Each step is carved from bone. The flame flickers, casting dancing shadows on walls etched with your family’s motto.  
* [[Press onward|EffigiesFamilyPassage]]  
* [[Climb back up|WeepingEffigiesArrival]]


:: EffigiesFamilyPassage {"position":"1550,8450","size":"100,100"}
\:: EffigiesFamilyPassage
You enter a small chamber lined with ancestral portraits. In its center, a sealed iron door bears the tri‑burial sigil: you’ve reached the vault’s outer door.  
* [[Use the Bone Chapel Key to unlock it|EffigiesUnlockVaultDoor]]  
* [[Study the portraits for clues|EffigiesStudyPortraits]]


:: EffigiesOpenSecretDoor {"position":"825,8625","size":"100,100"}
\:: EffigiesOpenSecretDoor
The wall behind the crest statue grinds inward, revealing a narrow arch lit by ghostly flame. Beyond lies a spiral stair descending into silence.  
* [[Descend the secret stair|EffigiesDescendStair]]  
* [[Pause to ready yourself|EffigiesPrepare]]


:: EffigiesPrepare {"position":"1325,8500","size":"100,100"}
\:: EffigiesPrepare
You pause, checking your equipment and steeling your nerves. The echo of dripping sap guides you downward.  
* [[Continue downward|EffigiesDescendStair]]  
* [[Retreat to the gallery|WeepingEffigiesArrival]]


:: EffigiesRevealNiche {"position":"537.5,8600","size":"100,100"}
\:: EffigiesRevealNiche
A small panel slides open, revealing a polished bone key etched with aristocratic flourishes.  
(set: $inventory to it + “Bone Chapel Key”)  
* [[Pocket the key|WeepingEffigiesArrival]]


:: EffigiesSapFlow {"position":"675,8600","size":"100,100"}
\:: EffigiesSapFlow
The cold sap soaks through your boots, chilling your feet. In the swirling black, you glimpse ghostly faces: each offering a silent plea.  
(set: $journal to it + (a: "In the sap, I glimpsed ghostly faces: each offering a silent plea "+ "\n\n"))
* [[Shake out your boots|WeepingEffigiesArrival]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}


:: EffigiesScionTrigger {"position":"800,8475","size":"100,100"}
\:: EffigiesScionTrigger
One effigy bears your family’s crest. Its sap‑streaked lips part, whispering: “Redeem your house’s debts.” A hidden ring at its base turns.  
* [[Turn the ring|EffigiesOpenSecretDoor]]  
* [[Step back in awe|WeepingEffigiesArrival]]


:: EffigiesStudyPortraits {"position":"1600,8675","size":"100,100"}
\:: EffigiesStudyPortraits
The portraits depict your forebears in mourning dress, eyes hollow with sorrow. One holds a crystal key: its shape matches the rusted iron key you carry.  

As you turn away, a pale mist coalesces before the central portrait. The ghostly shape of an armored ancestor drifts into view: Lord Ashenvale himself, hand trembling as it reaches toward Corvan’s sigil on the frame.  

**Ancestor’s Ghost (wistful):** “I... I buried him here, believing it would end the madness. But my coin poured fuel on his fire.”  
(set: $journal to it + (a: "My ancestor told me:'I... I buried him here, believing it would end the madness. But my coin poured fuel on his fire' "+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Listen to the ancestor’s confession|AshenvaleConfession]]

<!--
\:: EffigiesStudyPortraits
The portraits depict your forebears in mourning dress, eyes hollow with sorrow. One holds a crystal key: its shape matches the rusted iron key you carry.  
(set: $journal to it + “Clue: shape‑match key in portrait” )  
* [[Step to the door|EffigiesFamilyPassage]]
-->


:: EffigiesStudyRunes {"position":"537.5,8475","size":"100,100"}
\:: EffigiesStudyRunes
You kneel and trace the faded runes: “Tears of the penitent, seal the path ahead.” A hidden groove beneath the tile clicks softly.  
* [[Press the groove|EffigiesRevealNiche]]  
* [[Stand and move on|WeepingEffigiesArrival]]


:: EffigiesUnlockVaultDoor {"position":"1400,8700","size":"100,100"}
\:: EffigiesUnlockVaultDoor
You insert the bone key. The lock clicks, and the door swings open onto a torch‑lit corridor leading directly into Corvan’s sealed vault.  
* [[Step through into the vault entrance|VaultEntrance]]  
* [[Hesitate, heart pounding|EffigiesPrepare]]


:: EffigiesWipeSap {"position":"400,8475","size":"100,100"}
\:: EffigiesWipeSap
You press a finger to the sap. It feels sticky and warm: then the statue’s eyes snap open, and its stone hand lashes out!  
(set: $health to it - 2)  
* [[Dodge the strike and step back|WeepingEffigiesArrival]]


:: EmporiumArrival [NEXUS] {"position":"200,2700","size":"100,100"}

\:: EmporiumArrival
You step into the narrow lane between two shuttered stalls and find the Bone & Lantern Emporium. Racks of polished bone trinkets hang beside glowing glass lanterns filled with spectral flame. Behind the counter, a shrewd merchant arranges wares under a warm lantern glow.  

**Merchant (smiling):** “Welcome to my humble shop: everything a would‑be adventurer might need before delving into crypts. Take a look or ask a question.”  
* [[Show me what you have for sale|EmporiumShop]]  
* [[On second thought, I’ll be going|VelthornHollowOrientation]]


:: EmporiumRumorArray {"position":"250,2875","size":"100,100"}
(set: $EmporiumRumorArray to (a: 
  "They say the Ossuary of Echoes once swallowed an entire procession of mourners, never to return.",
  "A tinkling jars of ectoplasm have been smuggled out of the Necropolis: worth a fortune to alchemists.",
  "Old Dieners swear the Mortuary Hall’s walls pulse at midnight, as if remembering each body it’s held.",
  "The mirrored corridors beneath the Graveyard Gate shift nightly, trapping unwary souls for days.",
  "Rumor has it a secret vendor deals in worm‑salve near the Wheelwright’s Workshop after dusk.",
  "Some claim Widow Marrow’s tea recipes were stolen from a Necropolis grimoire, cursed if misused.",
  "A scholar once vanished in the Rotted Library, found weeks later babbling in runic tongues.",
  "They say a gilded chariot rides the frozen tracks under the cemetery: ridden by restless ghosts.",
  "A bell in the Bell Tower tolls on its own at the witching hour, calling spirits to feast.",
  "Stories tell of a hidden alcove in the Silent Crypt where Corvan’s own bones lie entombed."
))



:: EmporiumShop {"position":"100,2875","size":"100,100"}



:: ExhumedOfferAll {"position":"3175,1575","size":"100,100"}
Begrudgingly, Brannon digs you out.
  **Brannon:** “Now you are free, fullfill your promise! The silver and the body! But the silver first of course!"

  * Respect your word
  * Renage on your promise

(click:"Respect your word")[
(if: $money > 0)[
  (set: $money to 0)
  **You:** “Yes, I will help and give you my silver shards.” 
  **Brannon:** “Aha, they’re all yours. Get out before I think twice.”  
  * [[Claw your way free|MainQuest]]
]
(else:)
[
  **Brannon:** “Empty pockets? Then you’re staying six feet under.”  
  * [[Accept your fate|GameOverStarve]]
]
]
(click:"Renage on your promise")[
You face Brannon, defiant. 
**You:** “Now, what are you doing to do, old man?"
He muters some words, smiles, and then you fell weak. You fall to the ground and he puts you back [[where you belong|GameOverStarve]]
]


:: ExhumedThreaten {"position":"3050,1700","size":"100,100"}
**You:** You glare with a corpse’s hunger.  
He shudders. “All right: Your word that you will help me dig out ol'Corvan and five shards, or I run!”  
* [[Pay the five shards and agree to help|PayKnightFee]]  
* [[Leave him be: no coin and no dig|GameOverStarve]]


:: FGGBS12Returned {"position":"1775,2400","size":"100,100"}
\:: FGGBS12Returned
You feel reality thin, the Veil tugging at your senses: an echo of your return from death. A faint path of shimmering mist outlines a secret crypt entrance.  
(set: $journal to it + (a: "I found a Veil path to a secret crypt’"+ "\n\n"))
* [[Follow the misty path|ForgottenGraveyardGateArrival]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}


:: FGGDefaultInteraction {"position":"1500,2350","size":"100,100"}
\:: FGGDefaultInteraction
You kneel and peer into the keyhole. Inside, you glimpse shifting shapes: an invitation or a warning.  
* [[Try to pick the lock|FGGPickLock]]  
* [[Rise and reconsider|ForgottenGraveyardGateArrival]]


:: FGGPickLock {"position":"1500,2500","size":"100,100"}
\:: FGGPickLock
(if: $inventory contains “Rusted Lockpick Set”)[
  You insert your lockpick. With a satisfying *click*, the gate swings open, revealing moonlit graves.  
  * [[Step through the gate|VelthornHollowOrientation]]
][else:[
  Your tools are missing. The lock remains stubborn as ever.  
]]
* [[Pull back from the gate|ForgottenGraveyardGateArrival]]


:: FGGStupidChoice [ENDING] {"position":"1375,2350","size":"100,100"}
{
(set:$introText to "You rap on each tomb door. Silence answers: until a loose panel slams shut behind you, making you jump.")
(set:$clickTest to "making you jump")
(set:$AttributeTest to $charisma)
(set:$SuccessText to "You stand up, picking yourself up, and whatever tried to intimidate you crawls back to where it came from.")
(set:$FailureText to "The loose panel snaps over your shoulder, slamming you forward into a narrow corridor.")
(set:$clickDamage to "narrow corridor")
(set:$damageType to 2)
(set:$DeathText to "Before you can recover, the chamber door behind you swings shut with bone-crushing force, trapping your chest between stone and wood. Your ribs fracture, lungs collapse, and the world goes black as your last breath is squeezed from you in a final, rattling gasp.")
(set:$currentEnding to 27)
(set:$LinkText to "Step back, heart still racing")
(set:$FailureLinkText to "Step back, heart racing")
(set:$Link to "ForgottenGraveyardGateArrival")

(set:$xpSuccess to 35)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:"MacroPassage")


:: FGGWhispered {"position":"1625,2400","size":"100,100"}
\:: FGGWhispered
You blur and pass unseen through the gate’s wards, leaving no trace of your passage: ready to explore the silent graves beyond.  

* [[Proceed into the graveyard|VelthornHollowOrientation]]


:: FinalConfrontationSetup {"position":"9050,6800","size":"100,100"}
\:: FinalConfrontationSetup
You stand in the rotunda of cracked obsidian and bone, lantern-blue flame dancing across twelve alcoves, each dominated by a towering statue. Their hollow eyes follow you, and distant drip of ichor echoes in the vaulted chamber. Above, a domed ceiling fractures into black sky. Corvan’s voice thunders from every corner:

**Corvan (whispered):** “Choose the one who knows your past... or suffer each trial anew.”

* [[Approach the statues|ChooseStatue]]






















































:: FinalCrawlUp {"position":"7175,6500","size":"100,100"}
\:: FinalCrawlUp
You push through damp earth, lungs searing. At the surface, you collapse on black sands beneath a starless sky. A moon - but not yours - no stars: only the echo of rustling bones in the wind.  
<!--(set: $flags to it + “ArrivedAtRiverBank”)  -->
* [[Rise and step forward|RiverBankArrival]]


:: FinalStruggle {"position":"6925,6450","size":"100,100"}
\:: FinalStruggle
Your arms scrape bone; you bite back bile. At last the ribs crack, and the shallow grave’s soil spills in.  
(if:$health>=2)[
(set: $health to it - 1)  
 <script>
 updateHealth($health)
</script>
]
* [[Crawl toward the light|FinalCrawlUp]]


:: ForgottenGraveyardGateArrival [NEXUS] {"position":"1750,2175","size":"100,100"}
You stand before the **Forgotten Graveyard Gate**, an iron arch locked by a massive bone key. Overgrown tombstones lean in silent rows as moonlight filters through knotted branches.  
What do you do?  
* [[Knock on every tomb door as if expecting a guest|FGGStupidChoice]]  
* [[Examine the keyhole for clues|FGGDefaultInteraction]]  
* (if: $job is 4)[[Use Ghost Step to slip past the gate’s wards|FGGWhispered]]  
* (if: $backStory is 12)[[Sense the pull of the Veil on your borrowed life|FGGBS12Returned]]  
* [[Return to the square|VelthornHollowOrientation]]


:: FrozenHeartsArrival [NEXUS] {"position":"2950,8075","size":"100,100"}
\:: FrozenHeartsArrival
You step into the Reliquary of Frozen Hearts. Glass cases line the walls, each enclosing a crystal‑clear chamber where a heart beats slowly in suspended animation. The air is frigid enough to frost your breath, and the rhythmic pulse of the hearts echoes like distant drums.  
What do you do?  
* [[Reach out to touch a beating heart|HeartsTouchHeart]]  
* [[Inspect the frost‑etched runes on a case|HeartsInspectRunes]]  
* [[Listen closely to the pulse echoes|HeartsListenPulse]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 12)[  
  * [[Step barefoot onto the frozen floor and concentrate on your own heartbeat|HeartsReturnedTrigger]]  
]
(if: $inventory contains “Frozen Reliquary Key”)[  
  * [[Use the Frozen Reliquary Key on the central case|HeartsOpenVault]]  
]  


:: GalleryBottomStair {"position":"700,7825","size":"100,100"}
\:: GalleryBottomStair
At the stair’s end you find an iron door sealed with the tri‑burial sigil. A faint heartbeat echoes from beyond.  
* [[Push the door open|GalleryOpenVaultDoor]]  
* [[Pause to ready yourself|GalleryPrepare]]


:: GalleryDescendStair {"position":"675,7675","size":"100,100"}
\:: GalleryDescendStair
The stair’s steps are slick with wax. Each lantern above sways as you pass, whispering in hushed tones.  
* [[Press on toward the unseen bottom|GalleryBottomStair]]  
* [[Climb back up|LanternGalleryArrival]]


:: GalleryOpenHatch {"position":"1300,7725","size":"100,100"}
\:: GalleryOpenHatch
You unlatch a trapdoor; it creaks open to reveal a shaft glowing with lantern‑blue light.  
* [[Climb down into the hidden vault shaft|GalleryVaultShaft]]  
* [[Step back, hesitant|LanternGalleryArrival]]


:: GalleryOpenVaultDoor {"position":"725,8000","size":"100,100"}
\:: GalleryOpenVaultDoor
You press on the door. It swings inward to reveal a short corridor lit by blue lanterns: and at its end, the entrance to Corvan’s sealed vault.  
* [[Step forward into the vault entrance|VaultEntrance]]  
* [[Hesitate and breathe deeply|GalleryPrepare]]


:: GalleryPrepare {"position":"1425,7450","size":"100,100"}
\:: GalleryPrepare
You steady your breath, checking lantern fuel and tightening your grip on any wards you’ve learned. Beyond the door, the Brain Reliquary waits.  
* [[Open the door|VaultEntrance]]  
* [[Step back one moment|LanternGalleryArrival]]


:: GalleryReadGuide {"position":"1050,7825","size":"100,100"}
\:: GalleryReadGuide
Opening the tome, you read: “Only the tender of lanterns may pass: the true flame reveals the path.”  
(set: $journal to it + (a: "I read what could be a clue:“Only the tender of lanterns may pass: the true flame reveals the path.” "+ "\n\n"))
* [[Close the book|LanternGalleryArrival]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}


:: GalleryReleaseSpirit {"position":"800,7450","size":"100,100"}
\:: GalleryReleaseSpirit
You approach a lantern and gently lift its lid. A single soul‑wisp drifts free with a soft sigh: then swirls around you in gratitude, humming in your mind.  
<!--(set: $buff to it + “Guiding Wisp”)  -->
* [[Thank the spirit and step back|LanternGalleryArrival]]


:: GalleryRevealPassage {"position":"875,7875","size":"100,100"}
\:: GalleryRevealPassage
Behind the lanterns is a narrow stair winding downward, its walls lined with skeletal hands holding snuffed lanterns.  
* [[Descend the stair|GalleryDescendStair]]  
* [[Replace the lanterns and return|LanternGalleryArrival]]


:: GalleryRunePress {"position":"850,7700","size":"100,100"}
\:: GalleryRunePress
The rune glows bright, revealing a hidden panel behind a cluster of lanterns.  
* [[Pull aside the lanterns|GalleryRevealPassage]]  
* [[Step away|LanternGalleryArrival]]


:: GallerySearchAlcove {"position":"1050,7625","size":"100,100"}
\:: GallerySearchAlcove
You slip between floating lights to the far wall and discover a small alcove. Inside rests a dusty tome titled **“Guide of Lost Flames.”**  
(set: $inventory to it + “Guide of Lost Flames”)  
* [[Tuck it into your pack|LanternGalleryArrival]]  
* [[Open it now|GalleryReadGuide]]


:: GalleryStudyRunes {"position":"900,7550","size":"100,100"}
\:: GalleryStudyRunes
You trace the carved runes: they speak of “souls carried beyond the veil, guided by lantern’s flame.” A glow pulses beneath your fingertip.  
* [[Press the glowing rune|GalleryRunePress]]  
* [[Move on|LanternGalleryArrival]]


:: GalleryTenderTrigger {"position":"1275,7575","size":"100,100"}
\:: GalleryTenderTrigger
You lift your personal lantern high. Its flame grows brilliant, and dozens of gallery lanterns flare to life, illuminating a hidden doorway in the floor.  
* [[Open the hatch|GalleryOpenHatch]]  
* [[Lower your lantern|LanternGalleryArrival]]


:: GalleryVaultDoorStudy {"position":"1350,7925","size":"100,100"}
\:: GalleryVaultDoorStudy
You examine the door’s sigil: three interlocking loops bound by runic wards. Through a narrow slot you feel the faint pulse of trapped power.  
* [[Press your hand to the sigil|GalleryVaultSigilTouch]]  
* [[Return to the shaft entrance|GalleryVaultShaft]]


:: GalleryVaultFindKey {"position":"1525,8125","size":"100,100"}
\:: GalleryVaultFindKey
(if: $inventory contains “Obsidian Ossuary Key”)[  
  * [[Use the Obsidian Ossuary Key|GalleryVaultOpenDoor]]  
][  
  You search your pack but find no other key that fits this hidden keyhole.  
]  
* [[Step back|GalleryVaultLanding]]


:: GalleryVaultLanding {"position":"1475,7775","size":"100,100"}
\:: GalleryVaultLanding
Your feet hit cold marble at the shaft’s end. Before you stretches a torch‑lit corridor sealed by a heavy iron door, its surface carved with Corvan’s tri‑burial sigil and faintly glowing runes.  
* [[Approach and study the door|GalleryVaultDoorStudy]]  
* [[Step back and steel your nerves|GalleryVaultPrepare]]


:: GalleryVaultOpenDoor {"position":"1775,7925","size":"100,100"}
\:: GalleryVaultOpenDoor
You insert the Obsidian Ossuary Key into the hidden slot. With a resonant click, the wards shatter and the iron door swings inward on oily hinges. Beyond lies the final corridor leading to Corvan’s sealed vault.  
* [[Step through into the vault entrance|VaultEntrance]]  
* [[Hesitate at the threshold|GalleryVaultPrepare]]


:: GalleryVaultPrepare {"position":"1575,7925","size":"100,100"}
\:: GalleryVaultPrepare
You steady your lantern, check your inventory for keys or reagents, and breathe deeply. The final barrier to Corvan’s vault stands before you.  
* [[Open the door|GalleryVaultOpenDoor]]  
* [[Step back for one more moment|GalleryVaultLanding]]


:: GalleryVaultShaft {"position":"1700,7675","size":"100,100"}
\:: GalleryVaultShaft
You clamber down the narrow hatch into a tight stone shaft. The walls are slick with dripping ectoplasm and bone fragments crunch beneath your boots. Faint blue lantern‑light spills down from the room above, illuminating runic etchings on the shaft’s carved stones.  

What do you do?  
* [[Descend carefully to the bottom|GalleryVaultLanding]]  
* [[Climb back up to the gallery|LanternGalleryArrival]]















:: GalleryVaultSigilTouch {"position":"1450,8000","size":"100,100"}
\:: GalleryVaultSigilTouch
Your palm hums in time with the heartbeat behind the iron. The runes flare briefly, then a hidden keyhole appears in the center loop.  
* [[Search for a fitting key|GalleryVaultFindKey]]  
* [[Withdraw and reconsider|GalleryVaultLanding]]


:: GameOverStarve [ENDING] {"position":"3800,375","size":"100,100"}
The shovel clinks as Brannon pulls back.  
**Brannon (muttering):** “No name, no cloak, no coin: no resurrection for the likes of you.”  
The dirt settles over your chest, and the world goes silent.  
Your lantern’s flame flickers out. 

(set:$currentEnding to 7)
(display:"RestartDonnee")




:: GameOver_Entangled {"position":"8025,2625","size":"100,100"}
\:: GameOver_Entangled
The vines tighten. You struggle, but panic and pain overtake you. You never make it out of the roots’ grasp.  
* [[Restart from the square|VelthornHollowOrientation]]


:: GameOver_Pitfall [ENDING] {"position":"8200,2700","size":"100,100"}
\:: GameOver_Pitfall
You tumble into a coffin-deep shaft. Bone-tipped stakes await below: and you never reach the bottom alive.  

(set:$currentEnding to 4)
(display:"RestartDonnee")


:: HBBTBS11Pilgrim {"position":"1175,3225","size":"100,100"}
\:: HBBTBS11Pilgrim
You kneel and chant a prayer learned in the Bleeding Monastery. The roots retreat slightly, freeing the bell’s arc: and in gratitude, you receive a vial of **Blood of Repentance**.  
(set: $inventory to it + “Blood of Repentance”)  
* [[Rise and continue|HalfBuriedBellTowerArrival]]


:: HBBTDefaultInteraction {"position":"850,3350","size":"100,100"}
\:: HBBTDefaultInteraction
You lean your palm against the bell’s cool bronze. The humming stills, and a faint echo remains in your mind: granting you a one-time ward against fear.  
(set: $buff to it + “Bell’s Echo”)  
* [[Step away from the tower|HalfBuriedBellTowerArrival]]


:: HBBTPaleScholar {"position":"1000,3275","size":"100,100"}
\:: HBBTPaleScholar
You trace the runes around the bell’s rim, translating them: The first part of the text is a binding spell to calm restless spirits. With a whisper, you activate the rune: quieting the tower and earning a **Silent Toll** scroll.  
(set: $inventory to it + “Scroll of Silent Toll”)  

You now try to decypher the second part of the text...


(click:"decypher the second part")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
After alot of trial and error, you manage to translate the inscription: “Ring once to summon the dead… twice to open the dead’s door.” When you touch the bell, it trembles, and a root-bound hatch cracks free.
* [[Gather your courage and open the doors|CryptEntry]]  
* [[Return to the square|VelthornHollowOrientation]]
    ]
(else:)
    [
    No... the language here is too complex, impossible to crack..
* [[Tuck the scroll away|HalfBuriedBellTowerArrival]]
* [[Return to the square|VelthornHollowOrientation]]
    ]
]
 ]









:: HBBTStupidChoice {"position":"775,3200","size":"100,100"}
\:: HBBTStupidChoice
You tug the rope with all your might. The tower shudders, stones crack, and you scamper back just before a cascade of rubble falls where you stood.  

(click:"rubble falls where you stood")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $luck >= $diceRoll)
    [
(set: $health to it - 1)  
* [[Dust yourself off|HalfBuriedBellTowerArrival]]
    ]
(else:)
    [
The tower groans as you yank the rope. Stones crack overhead in warning: too late. A volley of jagged masonry crashes down, smashing your legs and pinning you in an avalanche of rubble. Pain explodes through you as the weight crushes your chest, and the world fades beneath the deafening roar of collapsing stone.
    (set:$currentEnding to 29)
(display:"RestartDonnee")
{
<script>
setTimeout(() => {
  gainXp(600);
}, "1000");
</script>
}
    ]

 ]
 ]


:: HaggleKnight {"position":"3125,725","size":"100,100"}
\:: HaggleKnight
**You:** “Surely an Ossuary Knight’s service is worth less?”  
**Brannon:** “Worth more! I’ll do it for eight, plus your help: take it or leave it.”  
* [[Pay eight silver|PayKnightFeeHigh]]  
* [[Give up and stay buried|GameOverStarve]]


:: HalfBuriedBellTowerArrival [NEXUS] {"position":"1000,3075","size":"100,100"}
You find the **Half-Buried Bell Tower** leaning among twisted roots, its bronze bell lodged deep in the earth. When the wind stirs, a low hum vibrates through both tower and bone.  
What do you do?  
* [[Yank the bell rope recklessly|HBBTStupidChoice]]  
* [[Place a hand on the bell to still its hum|HBBTDefaultInteraction]]  
* (if: $job is 5)[[Decipher the runes etched inside the bell’s rim|HBBTPaleScholar]]  
* (if: $backStory is 11)[[Recite a prayer from your monastic vows|HBBTBS11Pilgrim]]  
* [[Return to the square|VelthornHollowOrientation]]




:: HallBierHooks {"position":"125,4875","size":"100,100"}
\:: HallBierHooks
Rows of hooks hang empty. Above, runic seals stamped “Severance Trial #3” glow faintly. You recall whispered rumors of corpses trialed here by Corvan himself.  
* [[Touch a seal to feel its power|HallSealTouch]]  
* [[Move on|MortuaryHallArrival]]


:: HallBrainReliquary {"position":"525,5225","size":"100,100"}
\:: HallBrainReliquary
Behind glass, Corvan’s brain pulses in silver fluid. A runic seal binds it.  
* [[Study the seal (INT DC 15)|HallStudySeal]]  
* [[Search for a way inside the case|HallOpenReliquary]]


:: HallBreakSeal {"position":"475,5475","size":"100,100"}
\:: HallBreakSeal
Serum eats into the rune. With a hiss, the glass cracks and the case opens. The brain’s pulse quickens.  
(set: $inventory to it + “Corvan’s Brain”)  
* [[Retrieve the brain and prepare to flee|HallFleeWithBrain]]


:: HallDripPassage {"position":"325,5325","size":"100,100"}
\:: HallDripPassage
The corridor ends at a locked iron gate. A vial‑shaped keyhole beckons.  
* [[Use the Red Fog Serum vial as a key|HallUseSerumKey]]  
* [[Turn back quietly|HallSecretCorridor]]


:: HallEndureHeart {"position":"912.5,5500","size":"100,100"}
\:: HallEndureHeart
You steel yourself as the heart’s pulse hammers against the glass. Slowly, the case’s magic stabilizes, leaving behind a faint warmth in your bones.  
(set: $buff to it + “Heart’s Warmth”)  
* [[Step back|HallOrganCases]]


:: HallFleeWithBrain {"position":"750,5250","size":"100,100"}
\:: HallFleeWithBrain
Clutching the brain vial, you dash back through the secret corridor as alarms begin to echo. Ahead, the Mortuary Hall’s door gapes open: your escape beckons.  
* [[Escape to the Necropolis entrance|NecroOrientation]]


:: HallForceOpenFail {"position":"650,5475","size":"100,100"}
\:: HallForceOpenFail
Your strength falters. The case hisses steam, burning your forearm.  
(set: $hp to it - 2)  
* [[Withdraw your hand|MortuaryHallDepth]]


:: HallForceOpenSuccess {"position":"775,5475","size":"100,100"}
\:: HallForceOpenSuccess
Your tool snaps a hidden pin; the case pops open. The brain hovers in its fluid.  
(set: $inventory to it + “Corvan’s Brain”)  
* [[Pocket the reliquary vial|HallFleeWithBrain]]


:: HallHearLungs {"position":"1175,5425","size":"100,100"}
\:: HallHearLungs
You press your ear to the cold glass. Inhale… exhale… inhale… 
The rhythm echoes like distant chanting. You swear you hear a whispered phrase: “Ascend through the bones.”  
(set: $journal to it + (a: "I received a clue: it said“Ascend through the bones.” .’"+ "\n\n"))
* [[Continue listening|LungSings]]
* [[Step back|HallOrganCases]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}


:: HallLectern {"position":"250,4875","size":"100,100"}
\:: HallLectern
Scattered papers, half‑finished, lie on the lectern: Corvan’s notes on brain preservation. One page mentions a hidden door “behind the east alcove.”  
* [[Read the notes (INT check DC 15)|HallReadNotes]]  
* [[Note the clue and leave|MortuaryHallArrival]]


:: HallOpenReliquary {"position":"587.5,5350","size":"100,100"}
\:: HallOpenReliquary
You jiggle the glass lid: it resists. A hiss of steam escapes a hidden vent.  
* [[Force it with strength (STR DC 14)|HallForceOpenFail]]  
* [[Use a tool from inventory|HallForceOpenSuccess]]


:: HallOpenVault {"position":"625,4825","size":"100,100"}
\:: HallOpenVault
You uncork the vial and let the viscous red mist fill the keyhole carved in the marble slab. With a hiss of dissolving stone, a hidden panel grinds open, revealing a spiraling stair plunging into darkness.  
The symbol near the stairs leave no room for interpretation. This is what you were looking for.
* [[Descend into Corvan’s sealed vault|VaultEntrance]]


:: HallOrganCases {"position":"1100,5250","size":"100,100"}
\:: HallOrganCases
You step closer to the glass display cases. Inside rest a heart still faintly beating in viscous amber fluid, a pair of ghost‑white lungs that expand on their own, and a liver etched with arcane runes. Each organ glows under the blue lantern light, pulsing with necromantic energy.  
What do you do?  
* [[Touch the beating heart through the glass|HallTouchHeart]]  
* [[Press your ear against the case to hear the lungs|HallHearLungs]]  
* [[Study the rune‑etched liver for clues|HallStudyLiver]]  
* [[Step back to the Reliquary|MortuaryHallDepth]]



:: HallPulsingSlab {"position":"0,4750","size":"100,100"}
\:: HallPulsingSlab
A faint throb ripples through the marble. As you press your hand to it, a tremor of necrotic energy stuns you. (CON save DC 13 or be stunned 1 turn.)  
* [[Recover and step back|MortuaryHallArrival]]  
* [[Press harder to learn more|HallPulsingSlabPress]]


:: HallPulsingSlabPress {"position":"0,4925","size":"100,100"}
\:: HallPulsingSlabPress
The slab cracks, revealing a carved vial labeled “Red Fog Serum.” Its seal bears your old refugee camp mark.  
(set: $inventory to it + “Red Fog Serum”)  
* [[Pocket the vial|MortuaryHallArrival]]  
* [[Continue exploring|MortuaryHallArrival]]


:: HallReadNotes {"position":"250,5000","size":"100,100"}
\:: HallReadNotes
Your scholar’s eye deciphers the complex runes. A panel slides open in the east wall, revealing a narrow corridor.  
* [[Enter the secret corridor|HallSecretCorridor]]  
* [[Ignore and return|MortuaryHallArrival]]


:: HallRefugeeMem1 {"position":"925,4675","size":"100,100"}
\:: HallRefugeeMem1
A swirl of memory overtakes you: a child with fevered cheeks and pleading eyes. The salve was meant to ease her suffering… but you arrived too late.  
* [[Whisper her name|HallRefugeeMem2]]  
* [[Shake off the vision|HallRefugeeMem4]]


:: HallRefugeeMem2 {"position":"825,4850","size":"100,100"}
\:: HallRefugeeMem2
**You (whisper):** “Layla…”  
The lanterns flicker. A pulse in the marble beneath your feet answers: soft, like her final heartbeat.  
* [[Kneel and offer a silent prayer|HallRefugeeMem3]]  
* [[Pull yourself up|HallRefugeeMem4]]


:: HallRefugeeMem3 {"position":"850,5025","size":"100,100"}
\:: HallRefugeeMem3
You kneel, offering all the forgiveness you never could back in the camps. The scented air grows warmer, as though acknowledging your plea.  
(set: $flags to it + “LaidLaylaToRest”)  
* [[Stand and continue|HallRefugeeMem4]]


:: HallRefugeeMem4 {"position":"1100,4875","size":"100,100"}
\:: HallRefugeeMem4
Your vision clears. Among the jars you spot one marked “Red Fog Serum”: the same serum you once used in the quarantine ward. A secret vial might open hidden paths here.  
* [[Take the serum vial|HallRefugeeMem5]]  
* [[Leave it be|MortuaryHallArrival]]


:: HallRefugeeMem5 {"position":"1075,5050","size":"100,100"}
\:: HallRefugeeMem5
(set: $inventory to it + “Red Fog Serum”)  
Clutching the vial, you feel both guilt and resolve.  
* [[Press on deeper into the hall|MortuaryHallArrival]]


:: HallRefugeeReject {"position":"875,4475","size":"100,100"}
\:: HallRefugeeReject
Fear floods you. You stumble back to the center of the hall, heart pounding.  
* [[Breathe deeply and face the hall again|MortuaryHallArrival]]


:: HallRefugeeTrigger {"position":"625,4575","size":"100,100"}
\:: HallRefugeeTrigger

Your fingers close around the “Red Fog Serum” vial: its seal matches the one you used in the plague camps. The memory of those desperate days steels your resolve.  
* [[Pour the serum into the keyhole beneath the slab|HallOpenVault]]  
* [[Step back: this feels too risky|MortuaryHallArrival]]
Next to it, you also see a jar labeled “Embalming Salve”: its lavender scent shocks you back to the plague camps. You remember burying friends in makeshift graves.  
* [[Clutch the jar and steel yourself|HallRefugeeMem1]]  
* [[Step away: this is too much|HallRefugeeReject]]


:: HallSealTouch {"position":"125,5000","size":"100,100"}
\:: HallSealTouch
The seal’s magic flares, showing a ghostly replay of Corvan’s ritual: flesh stripped away, soul bound in crystal. You shudder.  
(set: $journal to it + (a: "I had a chilling vision of what might be a part of the Severance ritual.’"+ "\n\n"))
* [[Step back|MortuaryHallArrival]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}


:: HallSecretCorridor {"position":"225,5175","size":"100,100"}
\:: HallSecretCorridor
You step into a stone passage lit by phosphorescent moss. Faint dripping echoes ahead.  
* [[Press onward toward the drip sound|HallDripPassage]]  
* [[Retreat to the hall|MortuaryHallArrival]]


:: HallStudyLiver {"position":"1325,5350","size":"100,100"}
\:: HallStudyLiver
Leaning close, you trace the carved runes on the liver’s surface. In your scholar’s mind, you recognize part of the Severance Ritual’s binding formula.  
(set: $journal to it + “Discovered liver‑rune formula fragment”)  
* [[Memorize the pattern and step away|HallOrganCases]]


:: HallStudySeal {"position":"462.5,5350","size":"100,100"}
\:: HallStudySeal
You parse the binding rune: “Only one who embraced the rot may break this bond.”  
* [[Offer to spill the Red Fog Serum on the seal|HallBreakSeal]]  
* [[Step back: this feels deadly|MortuaryHallDepth]]


:: HallTouchHeart {"position":"912.5,5375","size":"100,100"}
\:: HallTouchHeart
You lay a trembling fingertip on the glass. The heart’s rhythm quickens, and ghostly tendrils of mist swirl within the case. A sudden pressure builds in your chest: (CON save DC 13 or gain 1 damaged status).  
* [[Withdraw your hand|HallOrganCases]]  
* [[Brace against the glass and hold on|HallEndureHeart]]


:: HallUseSerumKey {"position":"325,5475","size":"100,100"}
\:: HallUseSerumKey
You pour the serum into the keyhole. It fizzes, the lock clicks: and the gate swings inward. Beyond lies deeper Mortuary galleries.  
* [[Step through into the next wing|MortuaryHallDepth]]  
* [[Close it and reconsider|HallDripPassage]]


:: HeartConfrontation [TEMP] {"position":"2825,4575","size":"100,100"}
\:: HeartConfrontation
**Combat begins!**  
(set: $inCombat to true)  
*After the turn-based battle resolves, jump to either `HeartVictory` or `HeartDefeat`.*  

[[HeartVictory]]


:: HeartDefeat [ENDING] {"position":"2975,4725","size":"100,100"}
\:: 
The heart’s necrotic pulse overwhelms you. Your vision blurs as shadows coil around your heart, crushing it.  
(set:$currentEnding to 5)
(display:"RestartDonnee")


:: HeartDialogueFate {"position":"2825,4275","size":"100,100"}
\:: HeartDialogueFate
**You:** “Tell me why you live still.”  
**Heart:** “Corvan’s will binds me here: until a second burial frees me.”  
The chest before you thrums with angry life as the heart’s voice echoes off stone walls.  
* [[Prepare to battle the living heart|HeartConfrontation]]  
* [[Step back and reconsider|CryptAntechamber]]


:: HeartDialogueName {"position":"2700,4275","size":"100,100"}
\:: HeartDialogueName
**You:** “Name yourself!”  
**Heart:** “I am the beating core of Magister Corvan… the wellspring of his mortal sins.”  
The heart’s pulse quickens, veins of shadow snapping like whips: ready to defend itself.  
* [[Stand and fight|HeartConfrontation]]  
* [[Flee in terror|VelthornHollowOrientation]]


:: HeartDialogueThreat {"position":"2950,4275","size":"100,100"}
\:: HeartDialogueThreat
**You:** “Speak… or I will crush you now.”  
**Heart:** “Foolish mortal: my death would unleash horrors upon your soul.”  
It pulses violently, shards of bone jittering within its chambers.  
* [[Attack the heart|HeartConfrontation]]  
* [[Flee before it can strike|VelthornHollowOrientation]]


:: HeartFlee {"position":"3175,4700","size":"100,100"}

You turn and sprint from the crypt, retracing your steps through winding tunnels until you burst into the night air of Velthorn Hollow.  
Your heart races with both relief and regret.  
* [[Gather your wits in the village square|VelthornHollowOrientation]]


:: HeartVictory {"position":"2800,4750","size":"100,100"}
\:: 
You deal the final blow: shattering the heart in a burst of black ichor and bone shards. The chamber goes silent. A final echo: “Remember me…”  
Your strength fails you. You stagger, clutching your chest, and everything goes black.  
* [[…|NecroWake]]


:: HeartsApproachAlcove {"position":"2825,8350","size":"100,100"}
\:: HeartsApproachAlcove
You kneel before the cracked case. Inside rests a frozen key bearing Corvan’s tri‑burial sigil.  
(set: $inventory to it + “Frozen Reliquary Key”)  
* [[Retrieve the key|FrozenHeartsArrival]]  
* [[Study the key’s frost patterns|HeartsStudyKey]]


:: HeartsEndureCold {"position":"2450,8325","size":"100,100"}
\:: HeartsEndureCold
You grit your teeth as the frost’s bite eases. A faint warmth spreads through your core, as if the heart acknowledged your resolve.  
<!--(set: $buff to it + “Heart’s Resilience”)  -->
* [[Step back|FrozenHeartsArrival]]


:: HeartsInspectRunes {"position":"2575,8150","size":"100,100"}
\:: HeartsInspectRunes
You kneel to study the runes etched in the frost. They read: “Only the heart reborn may claim its key.” A hidden seam runs along the base of one case.  
* [[Trace the seam|HeartsRevealSeam]]  
* [[Rise and choose again|FrozenHeartsArrival]]


:: HeartsListenPulse {"position":"2700,8225","size":"100,100"}
\:: HeartsListenPulse
You cup your ear to the glass. The hearts’ collective pulse swells and dims like a heartbeat under duress. In the echo you hear a single phrase: “Return the lost.”  
(set: $journal to it + (a: "I learned that I need to 'return the lost'"+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Step away for clarity|FrozenHeartsArrival]]


:: HeartsOpenVault {"position":"3125,8450","size":"100,100"}
\:: HeartsOpenVault
You insert the Frozen Reliquary Key into a hidden keyhole at the base of the central case. With a crystalline click, the glass wall slides open, revealing a torch‑lit corridor beyond.  
* [[Step through into Corvan’s sealed vault|VaultEntrance]]  
* [[Pause to gather your courage|HeartsPrepare]]


:: HeartsPrepare {"position":"3175,8225","size":"100,100"}
\:: HeartsPrepare
You steady your breath, ensuring the shard and key are secure. Ahead lies the final sealed door to Corvan’s brain vault.  
* [[Push onward into the vault|VaultEntrance]]  
* [[Step back for one last check|FrozenHeartsArrival]]


:: HeartsReturnedTrigger {"position":"2975,8250","size":"100,100"}
\:: HeartsReturnedTrigger
You stand barefoot on the frozen floor, eyes closed. Your pulse aligns with the crystal hearts’ rhythm: one case cracks softly. Inside, a small alcove appears.  
* [[Approach the cracked case|HeartsApproachAlcove]]  
* [[Step away, shaken|FrozenHeartsArrival]]


:: HeartsRevealSeam {"position":"2625,8500","size":"100,100"}
\:: HeartsRevealSeam
Your fingertip cracks the frost along the seam. A small panel slides open, revealing a slender crystal shard carved with your name in drifting script.  
(set: $inventory to it + “Veil‑Shard Key”)  
* [[Pocket the shard|FrozenHeartsArrival]]


:: HeartsStudyKey {"position":"2925,8550","size":"100,100"}
\:: HeartsStudyKey
Frost crystals trace a pattern that matches the vault’s seal. Holding the key warms your hand in defiance of the cold.  
(set: $journal to it + (a: "I Learned that the frost pattern matches the vault seal"+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Stand and proceed|FrozenHeartsArrival]]


:: HeartsTouchHeart {"position":"2425,8100","size":"100,100"}
\:: HeartsTouchHeart
You press your palm to the glass. The heart’s rhythm quickens, and frost spreads across the case. A surge of cold pain stabs your chest: (CON save DC 13 or lose 1 health).  
* [[Withdraw your hand|FrozenHeartsArrival]]  
* [[Brace and hold on|HeartsEndureCold]]


:: InnerCryptEntrance {"position":"3150,3875","size":"100,100"}
\:: InnerCryptEntrance
You emerge into a vast antechamber: vaulted ceilings dripping with moisture, bone reliefs staring down, and the stale echo of your breath. 
Tread carefully: traps could be lurking around every corner!

(click:"traps could be lurking around every corner")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $luck >= $diceRoll)
    [
You manage to cross the chamber unarmed.
Flickering torchlight reveals the **Corvan’s tri-burial sigil** etched high on the far wall: a triple‐looped knot of bones and runes that seems to pulse faintly, as if alive.  
Below it stands a heavy stone door inscribed with that very sigil, its surface worn but unmistakeable. Behind this door lies the Inner Crypt: and what looks like the first of Magister Corvan’s tombs.  
* [[Push the door open and enter|CryptAntechamber]]  
* [[Pause to catch your breath and ready your weapon|CryptPrepare]]
    ]
(else:)
    [
You try to be careful, but at some point, you step on a mosaic tile depicting a skull: only it gives way beneath your foot. 
Can you catch up to something before it is too late?
(click:"catch up")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    You manage to recover before falling completly and cross the chamber unarmed.
Flickering torchlight reveals the **Corvan’s tri-burial sigil** etched high on the far wall: a triple‐looped knot of bones and runes that seems to pulse faintly, as if alive.  
Below it stands a heavy stone door inscribed with that very sigil, its surface worn but unmistakeable. Behind this door lies the Inner Crypt: and what looks like the first of Magister Corvan’s tombs.  
* [[Push the door open and enter|CryptAntechamber]]  
* [[Pause to catch your breath and ready your weapon|CryptPrepare]]
    ]
(else:)
    [
    The floor collapses into a spike-filled pit. You scream once before impaling your spine on jagged bone.
    (set:$currentEnding to 30)
(display:"RestartDonnee")
{
<script>
setTimeout(() => {
  gainXp(600);
}, "1000");
</script>
}
    ]

 ]
 ]


    ]
]
 ]







:: InnerSanctumEntry {"position":"2675,6000","size":"100,100"}
\:: InnerSanctumEntry
You cross the threshold into a circular chamber. At its center, on a crystalline dais, floats Corvan’s brain: encased in silver filaments and pulsating with inner light. The air vibrates with its whispered thoughts.  
What do you do?  
* [[Approach and speak to the brain|BrainSpeak]]  
* [[Circle the chamber and search for traps|SanctumSearch]]  
* [[Step away: this feels too uncanny|SanctumRetreat]]


:: LanternGalleryArrival [NEXUS] {"position":"1075,7425","size":"100,100"}
\:: LanternGalleryArrival
You enter the Lantern‑lit Gallery: a vaulted hall hung with hundreds of floating lanterns, each cradling a flickering soul‑wisp. The lanterns hum softly, and their light casts dancing shadows on walls carved with funerary runes. A faint aroma of burning myrrh drifts on the air.  
What do you do?  
* [[Release a spirit from its lantern|GalleryReleaseSpirit]]  
* [[Study the funeral runes on the walls|GalleryStudyRunes]]  
* [[Search for a hidden alcove behind the lanterns|GallerySearchAlcove]]  
* [[Return to Necropolis entrance|NecroOrientation]]  
(if: $backStory is 4)[  
  * [[Hold your lantern aloft and call your lost flock|GalleryTenderTrigger]]  
]



























:: LibraryDescendStair {"position":"1275,9750","size":"100,100"}
\:: LibraryDescendStair
You descend the winding stair. The smell of ink and bone grows stronger, and each step echoes on stone.  
* [[Press onward into the vault corridor|LibraryVaultCorridor]]  
* [[Climb back up|RottedLibraryArrival]]


:: LibraryInspectManuscript {"position":"400,9750","size":"100,100"}
\:: LibraryInspectManuscript
On the lectern lies a bleeding manuscript: ink seeps like blood down its pages. You can just make out fragmented notes on memory anchoring.  
* [[Read the fragment (INT check DC 15)|LibraryReadFragment]]  
* [[Step away, unsettled|RottedLibraryArrival]]


:: LibraryPrepare {"position":"625,10000","size":"100,100"}
\:: LibraryPrepare
You pause on the top step, checking your equipment and bracing for what lies below.  
* [[Continue downward|LibraryDescendStair]]  
* [[Return to the library|RottedLibraryArrival]]


:: LibraryReadFragment {"position":"400,9875","size":"100,100"}
\:: LibraryReadFragment
You decipher the fragment: “Anchor the mind to flesh, lest the soul wander.” A hidden latch clicks beneath the lectern.  
* [[Press the latch|LibraryRevealDrawer]]  
* [[Ignore it|RottedLibraryArrival]]


:: LibraryReadPage {"position":"150,9750","size":"100,100"}
\:: LibraryReadPage
You open a mold‑caked tome and read the first sentence. Arcane glyphs flare in the lantern light, and a word‑spell bursts from the pages: (random effect: WIS save DC 14 or take 1 health necrotic damage).  
* [[Close the book quickly|RottedLibraryArrival]]  
* [[Press on to see what happens|LibrarySpellEffect]]


:: LibraryRevealDrawer {"position":"400,10000","size":"100,100"}
\:: LibraryRevealDrawer
A secret drawer opens to reveal a folded charred page stamped with a familiar crest: your old Ashen Battalion emblem.  
* [[Unfold it carefully|LibraryVeteranTrigger]]  
* [[Pocket it unseen|RottedLibraryArrival]]


:: LibrarySearchShelves {"position":"275,9750","size":"100,100"}
\:: LibrarySearchShelves
You inspect row after row of ruined books. Most crumble at a touch, but one leather‑bound grimoire lies intact: **“Rituals of the Severed Mind.”**  
* [[Pull it free|LibraryTakeGrimoire]]  
* [[Leave it be|RottedLibraryArrival]]


:: LibrarySpeakMotto {"position":"500,9875","size":"100,100"}
\:: LibrarySpeakMotto
You intone “Steel and Ash Endures.” The walls tremble and a hidden door swings open behind a shelf, revealing a narrow stair lit by blue lanterns.  
* [[Step toward the secret stair|LibraryDescendStair]]  
* [[Hesitate to gather yourself|LibraryPrepare]]



:: LibrarySpellEffect {"position":"150,9875","size":"100,100"}
\:: LibrarySpellEffect
A swirl of ink shapes into a spectral quill that scribbles runes in the air: then vanishes. Your vision shudders, but no further harm comes.  
* [[Step back|RottedLibraryArrival]]


:: LibraryStudySigil {"position":"1525,9875","size":"100,100"}
\:: LibraryStudySigil
You examine the sigil: “Only the ash‑bound may pass.” Beneath it, a small keyhole glows with ember‑red light.  
* [[Use the Ashen Veteran’s Page as a key|LibraryUsePageKey]]  
* [[Step back|LibraryVaultCorridor]]


:: LibraryTakeGrimoire {"position":"275,9875","size":"100,100"}
\:: LibraryTakeGrimoire
You slide the grimoire into your pack. Its pages hum quietly, as if alive with half‑remembered spells.  
(set: $inventory to it + “Rituals of the Severed Mind”)  
* [[Close the shelf|RottedLibraryArrival]]


:: LibraryUsePageKey {"position":"1525,10000","size":"100,100"}
\:: LibraryUsePageKey
You press the charred page into the keyhole; it burns away in glowing embers. The door swings open silently.  
* [[Enter Corvan’s sealed vault|VaultEntrance]]  
* [[Pause one moment|CryptPrepare]]



:: LibraryVaultCorridor {"position":"1525,9750","size":"100,100"}
\:: LibraryVaultCorridor
The stair opens onto a short corridor sealed with Corvan’s tri‑burial sigil. Lantern‑blue light spills through its cracks.  
* [[Push through into the vault entrance|VaultEntrance]]  
* [[Study the sigil’s runes|LibraryStudySigil]]


:: LibraryVeteranTrigger {"position":"525,9750","size":"100,100"}
\:: LibraryVeteranTrigger
Your scar throbs as you recognize the emblem. The charred page bears your unit’s motto: “Steel and Ash Endures.” The words glow faintly.  
* [[Speak the motto aloud|LibrarySpeakMotto]]  
* [[Fold the page away|RottedLibraryArrival]]


:: LungSings {"position":"1175,5550","size":"100,100"}
The lung's chanting gets more intense, so intense your ears starts to bleed!
(click:"bleed")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [But you manage to pull yourself out of the transe that was beggining to take hold.
    You only suffer minor injuries.
    (click:"injuries")[
(display:"Roll1D")

 (live: 3s)[
    (stop:)
You lost (str:$diceRoll) health points
(set:$health to it - $diceRoll)
(if:$health<=0)[
(set:$currentEnding to 33)
(display:"RestartDonnee")
{
<script>
setTimeout(() => {
  gainXp(300);
}, "1000");
</script>
}
]
(else:)[
* [[Step back while you still can!|HallOrganCases]]
{
<script>
setTimeout(() => {
  gainXp(30);
}, "1000");
</script>
}
]
 ]
 ]
    ]
(else:)
    [You get yourself in a transe, your entire body surrendering to the lung's chant.
        (click:"the lung's chant")[
(display:"Roll2D")

 (live: 3s)[
    (stop:)
You lost (str:$diceRoll) health points
(set:$health to it - $diceRoll)
(if:$health<=0)[
(set:$currentEnding to 34)
(display:"RestartDonnee")
{
<script>
setTimeout(() => {
  gainXp(600);
}, "1000");
</script>
}
]
(else:)[
* [[Step back while you still can!|HallOrganCases]]
{
<script>
setTimeout(() => {
  gainXp(60);
}, "1000");
</script>
}
]
 ]
 ]
    
    ]

 ]
 ]


:: MOIBS6Severed {"position":"1200,2425","size":"100,100"}
\:: MOIBS6Severed
You bare your ritual scar. The barkeep’s eyes widen in reverence; he slides you a secret menu of **Undercity Tidbits**: dishes that restore both body and bone.  
(set: $inventory to it + “Undercity Tidbits”)  
* [[Pocket the menu and savor the moment|MourningOakInnArrival]]


:: MOICOMBAT {"position":"1175,2625","size":"100,100"}



:: MOICombatDefeat [ENDING] {"position":"1325,2900","size":"100,100"}
\:: 
The barkeep’s knife flicks free and catches you off guard. A sharp pain blooms in your side as you collapse onto the floor, dazed and defeated.  
Patrons rush back in to drag you away, murmuring that some debts can’t be paid with ale.   


{
<script>
setTimeout(() => {
  gainXp(600);
}, "1000");
</script>
}
(set:$currentEnding to 6)
(display:"RestartDonnee")


:: MOICombatFlee {"position":"1450,2900","size":"100,100"}
Your senses snap back for a moment: fear, regret, a sliver of sanity: and you turn on your heel.  
Crashing through tables and startled onlookers, you burst out of the inn into the cold night air.  

Breathing hard, you vanish into the mist, leaving the inn’s doors swinging on broken hinges.  
* [[Regroup in the village square|VelthornHollowOrientation]]


:: MOICombatVictory {"position":"1175,2900","size":"100,100"}
\:: MOIRampageVictory
The last patron scrambles from the inn as you bring your fist down with finality. The barkeep slumps to the floor, unconscious but breathing.  
Your bloodlust ebbs, and the world comes back into focus: the sap-dripping lanterns, the scattered tables, the stunned silence.  
<!--(set: $status to it - “Berserk”)  -->
You scoop up your empty mug and nod once to yourself, then stride for the door.  
* [[Leave the Mourning Oak Inn, the echoes of your rage fading behind you|VelthornHollowOrientation]]



:: MOIDefaultInteraction {"position":"825,2400","size":"100,100"}
\:: MOIDefaultInteraction
You order a somber ale. The barkeep slides a frosty mug across: its foam tinted red by sap. With each sip, you feel a fleeting calm wash over you.  
(set: $inventory to it + “Mourning Ale”)  
* [[Nod thanks and look around|MourningOakInnArrival]]


:: MOIExhumed {"position":"1075,2475","size":"100,100"}
\:: MOIExhumed
Your uncanny aura grants you a free pour: but the ale they give you - from under the bar - burns as if alive, and you must succeed on a intelligence test or enter a berserk haze.  
(click:"intelligence test")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
    You manage to steel your mind and sip carefully. You draw a deep breath, clench your teeth, and will the ale’s living flame to calm. The first sip scorches your throat: but you hold fast, locking the berserker hunger in its cage.  
(set: $health to it + 2)  
Your vision clears and your pulse steadies. The barkeep nods in wary respect.  
* [[Press him for rumor-mongering: controlled fury has its perks|MOIRumors]]
Once you are done, you can leave this [[fine establishment|VelthornHollowOrientation]].
    ]
(else:)
    [
    You tilt the mug to your lips and surrender to the savage thirst. The ale’s living fire surges through your veins: muscles bulge, eyes glow with frenzy, and you let out a feral roar.  
    (set: $charisma to it-1)
    Patrons leap to their feet and scramble away as you slam the mug down, smashing it on the table. The barkeep ducks behind the counter, hand on the hilt of his knife.  
* [[You rampage through the common room, but the barkeep tries to stop you|MOICOMBAT]]
    ]

 ]
 ]
* [[Brace yourself and drink|MourningOakInnArrival]]


:: MOIRumors {"position":"900,2625","size":"100,100"}
\:: MOIRumors
The barkeep peeks over the counter, his eyes wary but respectful. “If you’re looking for whispers in this cursed hollow,” he mutters, lowering his voice, “you might heed this:

‘They say the Bell Tower tolls at midnight: though its bell hasn’t rung in decades.  
Foolish souls who climb its broken stairs vanish without a trace.  
Some claim the tower’s roots twist into a hidden crypt, where the first burial lies sealed.  
Bring a light that won’t die, and maybe you’ll find more than bones up there.’  

He glances at your steady stance and offers a crooked smile. “Word is, the lantern flame you carry might just be the key.”  
* [[Thank the barkeep and return to the hearth|MourningOakInnArrival]]  
* [[Tell him you’ll investigate the Bell Tower at midnight|NightHalfBuriedBellTowerArrival]] 


:: MOIStupidChoice [ENDING] {"position":"700,2400","size":"100,100"}
{
(set:$introText to "You attempt to scramble up the oak’s skeletal branch. It starts to make the wrong kind of noise... ")
(set:$clickTest to "kind of noise")
(set:$AttributeTest to $luck)
(set:$SuccessText to "But you manage to jump back on the ground unarmed...")
(set:$FailureText to "The branch snaps with a hollow crack, sending you hurtling into the crowded table. ")
(set:$clickDamage to "hurtling")
(set:$damageType to 1)
(set:$DeathText to "A cascade of wooden boards and heavy tankards crushes you beneath their weight: your ribs shatter, breath leaves you in a single, bone-splintering moment, and the tavern’s startled shouts fade into silence.")
(set:$currentEnding to 25)
(set:$LinkText to "Pick yourself up.")
(set:$FailureLinkText to "Pick yourself up and apologize")
(set:$Link to "MourningOakInnArrival")

(set:$xpSuccess to 28)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:"MacroPassage")


:: MainQuest {"position":"4050,775","size":"100,200"}
{<div class="image-container">
  <img class="image-base" src="https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Illustrations/GettingOut.jpg" />
</div>
(set: $journal to it + (a: $heroName+ "\n\n"))  
(set: $journal to it + (a: "I woke up in the Velthorn Hollow's cemetery."+ "\n\n"))}
Your body feels stiff from its time in confinement. After a few seconds, you straighten yourself, glance at the surrounding tombs, and steel yourself for the task ahead.

**You:** “How hard can it be? Magister Corvan's body must be somewhere in this cemetery, right?”  
**Groundskeeper:** “Well… actually… it’s a bit more complicated.”  
**You:** “Complicated? What do you mean?”  
**Groundskeeper:** “Last I heard, he’s in shambles.”  
**You:** “In shambles?”  
**Groundskeeper:** “His body, I mean: all scattered in different places, you see?”  
*(The groundskeeper pauses, picking at the hem of his coat.)*  
**Groundskeeper:** “Yes. When I heard someone screaming and thrashing about like a devil, I was relieved it might be him: intact, mouth and feet included. But alas…”  
**You:** “It was just me... but who did this to him?”  
**Groundskeeper:** “Oh no, no! He wasn’t tortured, I swear: it was his own doing.”  
**You:** “He did this... to himself?”  
**Groundskeeper:** “Yes… I don’t know why, really, but he did it. Folks talk about a rituel of some kind, they call it 'severance'... But I don't know much more. Ask around. Anyway, the village hasn’t been the same since that went down. I reckon we need to put him back together… somehow, at least.”
 
* Ok, I’ll see what I can do!
* No way: this is too weird! Put me back in the box!

(click:" I’ll see what I can do!")[
**You:** “Very well. I’ll gather his parts and reassemble him.”  
*(The groundskeeper nods grimly and steps aside.)*  
* [[Proceed to the village|Background]]
(replace:"back in the box!")[back in the box.]
]

(click:"back in the box!")[
**You:** “Well… thank you for digging me out, but I’m no detective: or grave-digger!”  
**Groundskeeper:** “I knew you’d say that. All right, back you go!”  
*(He shoves you back under the coffin lid.)*  
* [[Fall unconscious|GameOverStarve]]
(replace:"I’ll see what I can do!")[I'll see what I can do.]
]



:: Marchand1 {"position":"975,125","size":"100,100"}
{
    <body>
    <style>.money{display:none;}</style>
        <div class="container">
            <!-- Titre du menu -->
            <div class="MarchandHaut">
                <h1>Gerard the Merchant's Shop</h1>
                <div class="gold-display">
                    <i class="fas fa-coins"></i>
                    <span id="gold-amount" data-valeur-de-base="0">0 gold coins</span>
                </div>
            </div>
    
            <!-- Contenu principal -->
            <div class="main-content">
                <!-- Interface du marchand (gauche) -->
                <div class="merchant-section">
                    <div class="merchant-card">
                        <div class="card-header">
                            <h2>Merchant</h2>
                        </div>
                        <div class="merchant-tabs">
                            <button class="tab-button active" data-tab="achats">
                                <i class="fas fa-shopping-cart"></i> Buy
                            </button>
                            <button class="tab-button" data-tab="vente">
                                <i class="fas fa-shopping-bag"></i> Sell
                            </button>
                            <button class="tab-button" data-tab="anecdotes">
                                <i class="fas fa-comment"></i> Conversation
                            </button>
                        </div>
                        <div class="tab-content">
                            <!-- Contenu de l'onglet Achats -->
                            <div class="tab-pane active" id="achats">
                                <h3>Available items :</h3>
                                <div class="merchant-items" id="merchant-items">
                                    <!-- Les articles du marchand seront générés par JavaScript -->
                                </div>
                            </div>
    
                            <!-- Contenu de l'onglet Vente -->
                            <div class="tab-pane" id="vente">
                                <div class="sell-container">
                                    <h3>Sell an item</h3>
                                    <p>Select an item from your inventory to sell to the merchant</p>
                                    <div class="sell-item-details" id="sell-item-details">
                                        <p class="no-selection">No item selected. Click on an item in your inventory</p>
                                    </div>
                                </div>
                            </div>
    
                            <!-- Contenu de l'onglet Anecdotes -->
                            <div class="tab-pane" id="anecdotes">
                                <div class="anecdote-container">
                                    <div class="anecdote-icon">
                                        <i class="fas fa-comment"></i>
                                    </div>
                                    <div class="anecdote-content">
                                        <h3>The merchant tells you :</h3>
                                        <p id="anecdote-text" class="anecdote-text">"I learned some information recently !"</p> <!-- phrase de base -->
                                        <button class="anecdote-button" id="new-anecdote">Conversation</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <!-- Détails de l'objet sélectionné (pour l'achat) -->
                    <div class="buy-item-details" id="buy-item-details">
                        <!-- Détails de l'objet à acheter -->
                    </div>
                </div>
                
                
                 <!-- Inventaire du joueur (droite) -->
                <div class="inventory-card">
                    <div class="card-header">
                        <h2>Your Inventory</h2>
                    </div>
                    <div class="card-content">
                     <!--equipements éphémére-->    
                          <div class="inventoryPlayerMarchand" id="chestInventory"></div>
                  <!--FIN equipements éphémére-->
                      
                    </div>
                </div>
            </div>
        </div>
    <button id="explore">[[Admin]]</button>
    <button id="explore2">[[Admin]]</button>
        <script>
const merchantItems = [
    { id: "sword3", nom: "Dague des fromans", type: "sword", strength: 9, durability: 10, class: "item-img", draggable: true, inventorychest: "2", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/RayGun.png", "prix": 142,"rare": "Common" },
   { id: "sword4", nom: "Horn", type: "sword", strength: 8, durability: 30, class: "item-img", draggable: true, inventorychest: "4", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/Horn.png","prix": 180,"rare": "Epic"  },
    { id: "soin2", nom: "Healing Potion", type: "soin", life: 15, class: "item-img", draggable: true, inventorychest: "6", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Medkit.png","prix": 35,"rare": "Common"  },
    { id: "glasse1", nom: "glasse", type: "object", class: "item-img", draggable: true, inventorychest: "7", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Objets/Glasses.png","prix": 67,"rare": "Common"  },
    { id: "Watch1", nom: "Watch", type: "object", class: "item-img", draggable: true, inventorychest: "8", src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Objets/Watch.png","prix": 115,"rare": "Rare"  },
];

const anecdotes = [
    "J'ai entendu dire que le roi prépare une grande fête pour célébrer la victoire contre les orcs.",
    "On raconte que des trésors sont cachés dans les montagnes du nord.",
    "Je me suis promener ce matin, c'est pas mal!",
    "Non sérieusement j'ai rien à dire donc voilà c'est pas mal.",
    "Le forgeron du village voisin aurait découvert une nouvelle technique pour renforcer les armes.",
];


// Variables globales
let money = parseInt(localStorage.getItem("$money")) || 0;
let baseGold = parseInt(document.getElementById('gold-amount').getAttribute('data-valeur-de-base')) || 0;
let gold = $money + baseGold;
document.getElementById('gold-amount').textContent = `${gold} gold coins`;
let selectedItem = null;
let currentTab = "achats";
let selectedSlot = null; 

// Variables pour le drag and drop mobile
let touchDraggedItem = null;
let touchGhost = null;
let touchStartX = 0;
let touchStartY = 0;
let initialSlot = null;
let touchStartTime = 0;
let touchMoved = false;
const CLICK_DELAY = 300; 
const MOVE_THRESHOLD = 10; 

// Initialisation
generateMerchantItems();
setupTabButtons();
setupAnecdoteButton();
setupInventoryClicks();
setupDragDropInventory();
setupExploreButton();
setupMobileDragDrop();

// Génération des articles du marchand
function generateMerchantItems() {
    const merchantItemsContainer = document.getElementById('merchant-items');
    merchantItemsContainer.innerHTML = '';

    merchantItems.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'merchant-item';
        itemElement.dataset.itemId = item.id;

        const img = document.createElement('img');
        img.src = item.src;
        img.alt = item.nom;

        const name = document.createElement('h4');
        name.textContent = item.nom;

        const price = document.createElement('div');
        price.className = 'price';
        price.innerHTML = `<i class="fas fa-coins"></i> ${item.prix}`;

        itemElement.appendChild(img);
        itemElement.appendChild(name);
        itemElement.appendChild(price);
        merchantItemsContainer.appendChild(itemElement);

        itemElement.addEventListener('click', () => selectMerchantItem(item));
    });
}

// Configuration des boutons d'onglet
function setupTabButtons() {
    const tabButtons = document.querySelectorAll('.tab-button');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

            button.classList.add('active');
            const tabId = button.dataset.tab;
            document.getElementById(tabId).classList.add('active');
            currentTab = tabId;

            // Masquer ou afficher l'inventaire selon l'onglet sélectionné
            const inventoryCard = document.querySelector('.inventory-card');
            if (tabId === 'anecdotes') {
                inventoryCard.style.display = 'none';
            } else {
                inventoryCard.style.display = 'block';
            }

            if (tabId !== 'achats') {
                const buyItemDetails = document.getElementById('buy-item-details');
                buyItemDetails.classList.remove('active');
                buyItemDetails.innerHTML = '';
            }

            if (currentTab === 'vente' && selectedItem) {
                updateSellInterface(selectedItem);
            }
        });
    });
}


// Configuration du bouton d'anecdote
function setupAnecdoteButton() {
    document.getElementById('new-anecdote').addEventListener('click', () => {
        const randomIndex = Math.floor(Math.random() * anecdotes.length);
        document.getElementById('anecdote-text').textContent = `"${anecdotes[randomIndex]}"`;
    });
}

// Gestion des clics sur l'inventaire
function setupInventoryClicks() {
    document.getElementById('chestInventory').addEventListener('click', (e) => {
        // Vérifier si c'est un clic sur une image d'objet
        const clickedItem = e.target.closest('.item-img');
        if (!clickedItem) return;
        
        // Trouver le slot parent
        const slot = clickedItem.closest('.slotChest');
        if (!slot) return;

        // Désélectionner tous les slots
        document.querySelectorAll('.slotChest').forEach(s => s.classList.remove('selected'));

        // Sélectionner le nouveau slot et ajouter un effet visuel
        slot.classList.add('selected');
        pulseEffect(clickedItem); 
        selectedSlot = slot;

        // Récupérer les données de l'objet
        selectedItem = {
            id: clickedItem.dataset.id,
            nom: clickedItem.dataset.nom,
            type: clickedItem.dataset.type,
            strength: clickedItem.dataset.strength !== undefined ? clickedItem.dataset.strength : 'N/A',
            armor: clickedItem.dataset.armor !== undefined ? clickedItem.dataset.armor : 'N/A',
            life: clickedItem.dataset.life !== undefined ? clickedItem.dataset.life : 'N/A',
            prix: parseInt(clickedItem.dataset.prix) || 0,
            src: clickedItem.src
        };

        // Basculer automatiquement vers l'onglet de vente
        document.querySelector('[data-tab="vente"]').click();
        
        // Mettre à jour l'interface de vente avec l'objet sélectionné
        updateSellInterface(selectedItem);
        
        // Faire défiler jusqu'à l'interface de vente si nécessaire (pour mobile)
        const sellDetails = document.getElementById('sell-item-details');
        if (sellDetails) {
            sellDetails.scrollIntoView({ behavior: 'smooth' });
        }
    });
}

// Effet de pulsation pour indiquer la sélection
function pulseEffect(element) {
    // Créer un style pour l'animation si nécessaire
    if (!document.getElementById('pulse-animation-style')) {
        const style = document.createElement('style');
        style.id = 'pulse-animation-style';
        style.textContent = `
            @keyframes pulse-animation {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); box-shadow: 0 0 10px gold; }
                100% { transform: scale(1); }
            }
            .pulse {
                animation: pulse-animation 0.5s ease-in-out;
            }
        `;
        document.head.appendChild(style);
    }
    
    // Appliquer l'animation
    element.classList.add('pulse');
    
    // Supprimer la classe après l'animation
    setTimeout(() => {
        element.classList.remove('pulse');
    }, 500);
}

// Mise à jour de l'interface de vente 
function updateSellInterface(item) {
    const sellDetails = document.getElementById('sell-item-details');
    if (!sellDetails) return;
    sellDetails.classList.add('active');

    if (!item || !item.prix || isNaN(item.prix)) {
        sellDetails.innerHTML = `<p class="no-selection">Item not for sale</p>`;
        return;
    }

    sellDetails.innerHTML = `
        <div class="sell-item-content">
            <h3>${item.nom}</h3>
            <img src="${item.src}" alt="${item.nom}" class="sell-item-img">
            <div class="sell-item-stats">
                ${item.type ? `<p>Type : ${item.type}</p>` : ''}
                ${item.strength && item.strength !== 'N/A' ? `<p>Force : ${item.strength}</p>` : ''}
                ${item.armor && item.armor !== 'N/A' ? `<p>Armure : ${item.armor}</p>` : ''}
                ${item.life && item.life !== 'N/A' ? `<p>Soin : ${item.life}</p>` : ''}
                <p class="sell-price">Valeur : ${item.prix} <i class="fas fa-coins"></i></p>
                <button class="btn btn-primary" id="sell-button">Sell this item</button>
            </div>
        </div>
    `;

    document.getElementById('sell-button').addEventListener('click', sellItem);
}

// Vente d'un objet
function sellItem() {
    if (!selectedItem?.prix) {
        console.error("Prix non défini", selectedItem);
        return;
    }
    const selectedSlot = document.querySelector('.slotChest.selected');
    if (!selectedSlot) return;

    const prixVente = parseInt(selectedItem.prix) || 0;
    gold += prixVente;
    window.money = gold;
    updateLocalStorage();
    document.getElementById('gold-amount').textContent = `${gold} gold coins`;
    selectedSlot.remove();

    const sellDetails = document.getElementById('sell-item-details');
    if (window.sfxEnabled) {
    let vendSound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/vendre.wav");
    vendSound.volume = window.sfxVolume;
    vendSound.play();
  }
    sellDetails.innerHTML = `<p class="no-selection">Sold for ${prixVente} coins!</p>`;
    selectedItem = null;
}

// Achat d'un objet
function selectMerchantItem(item) {
    if (gold < item.prix) {
        alert("You don't have enough gold to purchase this item.");
        return;
    }
    gold -= item.prix;
    window.money = gold;
    updateLocalStorage();
    document.getElementById('gold-amount').textContent = `${gold} gold coins`;

    if (window.sfxEnabled) {
        let moneySound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/argent.wav");
        moneySound.volume = window.sfxVolume;
        moneySound.play();
    }

    const inventory = document.getElementById('chestInventory');

    // Trouver une case vide
    const emptySlot = [...inventory.querySelectorAll('.slotChest')].find(slot => slot.children.length === 0);
    if (!emptySlot) {
        alert("Inventory full! No empty slots available.");
        return;
    }

    // Ajouter l’objet dans la case vide
    emptySlot.innerHTML = `
        <img src="${item.src}" id="${item.id}" alt="${item.nom}" class="${item.class} item-img" draggable="true"
             data-id="${item.id}" data-nom="${item.nom}" data-type="${item.type}"
             data-strength="${item.strength || ''}" data-durability="${item.durability || ''}"
             data-life="${item.life || ''}" data-prix="${item.prix}" data-rare="${item.rare}">
    `;

    const img = emptySlot.querySelector('.item-img');
    img.addEventListener('dragstart', dragStart);
    img.addEventListener('dragend', dragEnd);
    setupTouchEventsForItem(img);
}


// Gestion du drag & drop sur l'image (desktop)
function dragStart(event) {
    event.dataTransfer.setData("text/plain", event.target.outerHTML);
    event.target.classList.add("dragging");
    event.target.style.opacity = "0.5";
    event.target.style.zIndex = "1000";
}

function dragEnd(event) {
    event.target.classList.remove("dragging");
    event.target.style.opacity = "1";
    event.target.style.zIndex = "";
}

// Configuration de la zone d'inventaire pour recevoir le drop
function setupDragDropInventory() {
    const chestInventory = document.getElementById('chestInventory');

    // Ajouter les événements tactiles aux éléments existants
    const existingItems = chestInventory.querySelectorAll('.item-img[draggable="true"]');
    existingItems.forEach(item => {
        setupTouchEventsForItem(item);
    });

    chestInventory.addEventListener('dragover', function(e) {
        e.preventDefault();
        
        // Trouver le slot sous le curseur
        const slot = e.target.closest('.slotChest');
        if (slot) {
            // Ajouter un indicateur visuel
            document.querySelectorAll('.slotChest').forEach(s => {
                s.classList.remove('drop-target');
            });
            slot.classList.add('drop-target');
        }
    });

    chestInventory.addEventListener('dragleave', function(e) {
        const slot = e.target.closest('.slotChest');
        if (slot) {
            slot.classList.remove('drop-target');
        }
    });

    chestInventory.addEventListener('drop', function(e) {
        e.preventDefault();
        
        // Réinitialiser les indicateurs visuels
        document.querySelectorAll('.slotChest').forEach(slot => {
            slot.classList.remove('drop-target');
        });
        
        // Récupérer l'élément en cours de déplacement
        const draggingElement = document.querySelector(".dragging");
        if (!draggingElement) return;
        
        // Récupérer le slot d'origine
        const originSlot = draggingElement.closest('.slotChest');
        
        // Trouver le slot sous le curseur
        const dropTarget = e.target.closest('.slotChest');
        if (!dropTarget) return;
        
        // Si on dépose sur un slot différent
        if (dropTarget !== originSlot) {
            // Si le slot cible contient déjà un élément
            const targetImg = dropTarget.querySelector('.item-img');
            
            if (targetImg) {
                // Échange des éléments
                originSlot.appendChild(targetImg);
                dropTarget.appendChild(draggingElement);
            } else {
                // Le slot cible est vide
                dropTarget.appendChild(draggingElement);
            }
        }
           if (window.sfxEnabled) {
      let possessionSound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/possageobjet.wav");
      possessionSound.volume = window.sfxVolume;
      possessionSound.play();
    }
        // Réinitialiser l'élément déplacé
        draggingElement.classList.remove("dragging");
        draggingElement.style.opacity = "1";
        draggingElement.style.zIndex = "";
    });
}

// Implémentation du drag and drop pour mobile
function setupMobileDragDrop() {
    // Ajouter un style pour les indicateurs visuels
    if (!document.getElementById('mobile-drag-drop-style')) {
        const style = document.createElement('style');
        style.id = 'mobile-drag-drop-style';
        style.textContent = `
            .drop-target {
                background-color: rgba(0, 255, 0, 0.2);
                border: 2px dashed green !important;
            }
            #drag-ghost {
                position: fixed;
                pointer-events: none;
                z-index: 1000;
                opacity: 0.7;
                max-width: 50px;
                max-height: 50px;
                object-fit: contain;
            }
            @keyframes pulse-animation {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); box-shadow: 0 0 10px gold; }
                100% { transform: scale(1); }
            }
            .pulse {
                animation: pulse-animation 0.5s ease-in-out;
            }
        `;
        document.head.appendChild(style);
    }
}

// Configurer les événements tactiles pour un élément
function setupTouchEventsForItem(item) {
    item.addEventListener('touchstart', handleTouchStart, { passive: false });
    item.addEventListener('touchmove', handleTouchMove, { passive: false });
    item.addEventListener('touchend', handleTouchEnd);
    item.addEventListener('touchcancel', handleTouchEnd);
}

// Gérer le début du toucher
function handleTouchStart(e) {
    // Enregistrer le temps de début du toucher
    touchStartTime = new Date().getTime();
    touchMoved = false;
    
    // Enregistrer la position initiale
    const touch = e.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    
    // Ne pas empêcher le comportement par défaut immédiatement
    // pour permettre les clics simples
    
    touchDraggedItem = this;
    initialSlot = touchDraggedItem.closest('.slotChest');
}

// Gérer le déplacement du toucher
function handleTouchMove(e) {
    const touch = e.touches[0];
    
    // Calculer la distance parcourue
    const distX = Math.abs(touch.clientX - touchStartX);
    const distY = Math.abs(touch.clientY - touchStartY);
    
    // Si le mouvement dépasse le seuil, c'est un drag
    if (distX > MOVE_THRESHOLD || distY > MOVE_THRESHOLD) {
        touchMoved = true;
        
        // Maintenant on peut empêcher le comportement par défaut
        e.preventDefault();
        
        // Si c'est le premier mouvement significatif, créer le ghost
        if (!touchGhost && touchDraggedItem) {
            // Créer l'élément fantôme
            touchGhost = document.createElement('img');
            touchGhost.src = touchDraggedItem.src;
            touchGhost.id = 'drag-ghost';
            touchGhost.style.position = 'fixed';
            touchGhost.style.width = '50px'; // Taille fixe
            touchGhost.style.height = '50px'; // Taille fixe
            touchGhost.style.left = (touch.clientX - 25) + 'px';
            touchGhost.style.top = (touch.clientY - 25) + 'px';
            touchGhost.style.opacity = '0.7';
            touchGhost.style.pointerEvents = 'none';
            touchGhost.style.zIndex = '1000';
            document.body.appendChild(touchGhost);
            
            touchDraggedItem.classList.add('dragging');
            touchDraggedItem.style.opacity = '0.3';
        }
        
        // Déplacer l'élément fantôme
        if (touchGhost) {
            touchGhost.style.left = (touch.clientX - 25) + 'px';
            touchGhost.style.top = (touch.clientY - 25) + 'px';
        }
        
        // Trouver le slot sous le doigt
        const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        const slotBelow = elemBelow ? elemBelow.closest('.slotChest') : null;
        
        // Réinitialiser les indicateurs visuels
        document.querySelectorAll('.slotChest').forEach(slot => {
            slot.classList.remove('drop-target');
        });
        
        // Ajouter un indicateur visuel au slot cible
        if (slotBelow && slotBelow !== initialSlot) {
            slotBelow.classList.add('drop-target');
        }
    }
}

// Gérer la fin du toucher
function handleTouchEnd(e) {
    const currentTime = new Date().getTime();
    const touchDuration = currentTime - touchStartTime;
    
    // Si c'était un toucher court sans mouvement, c'est un clic
    if (!touchMoved && touchDuration < CLICK_DELAY) {
        // Simuler un clic sur l'élément
        simulateClick(touchDraggedItem);
    } 
    // Sinon, c'est un drag qui se termine
    else if (touchGhost) {
        const touch = e.changedTouches[0];
        
        // Trouver le slot sous le doigt
        const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        const slotBelow = elemBelow ? elemBelow.closest('.slotChest') : null;
        
        // Réinitialiser tous les indicateurs visuels
        document.querySelectorAll('.slotChest').forEach(slot => {
            slot.classList.remove('drop-target');
        });
        
        // Si on a trouvé un slot valide et différent du slot d'origine
        if (slotBelow && slotBelow !== initialSlot && touchDraggedItem) {
            // Si le slot cible contient déjà un élément
            const targetImg = slotBelow.querySelector('.item-img');
            
            if (targetImg) {
                // Échange des éléments
                initialSlot.appendChild(targetImg);
                slotBelow.appendChild(touchDraggedItem);
            } else {
                // Le slot cible est vide
                slotBelow.appendChild(touchDraggedItem);
            }
        }
        
        // Supprimer l'élément fantôme
        touchGhost.remove();
        touchGhost = null;
    }
    
    // Réinitialiser l'élément déplacé
    if (touchDraggedItem) {
        touchDraggedItem.classList.remove('dragging');
        touchDraggedItem.style.opacity = '1';
    }
    
    // Réinitialiser les variables
    touchDraggedItem = null;
    initialSlot = null;
    touchMoved = false;
}

// Fonction pour simuler un clic
function simulateClick(element) {
    if (!element) return;
    
    // Trouver le slot parent
    const slot = element.closest('.slotChest');
    if (!slot) return;

    // Désélectionner tous les slots
    document.querySelectorAll('.slotChest').forEach(s => s.classList.remove('selected'));

    // Sélectionner le nouveau slot
    slot.classList.add('selected');
    selectedSlot = slot;

    // Ajouter un effet visuel
    pulseEffect(element);

    // Récupérer les données de l'objet
    selectedItem = {
        id: element.dataset.id,
        nom: element.dataset.nom,
        type: element.dataset.type,
        strength: element.dataset.strength !== undefined ? element.dataset.strength : 'N/A',
        armor: element.dataset.armor !== undefined ? element.dataset.armor : 'N/A',
        life: element.dataset.life !== undefined ? element.dataset.life : 'N/A',
        prix: parseInt(element.dataset.prix) || 0,
        src: element.src
    };

    // Basculer automatiquement vers l'onglet de vente
    document.querySelector('[data-tab="vente"]').click();
    
    // Mettre à jour l'interface de vente avec l'objet sélectionné
    updateSellInterface(selectedItem);
    
    // Faire défiler jusqu'à l'interface de vente
    const sellDetails = document.getElementById('sell-item-details');
    if (sellDetails) {
        sellDetails.scrollIntoView({ behavior: 'smooth' });
    }
}

// Sauvegarde la valeur de gold dans le localStorage
function updateLocalStorage() {
    localStorage.setItem("$money", gold);
}

// Configuration du bouton "Explore the galaxy" pour sauvegarder et (éventuellement) naviguer
function setupExploreButton() {
    document.getElementById('explore').addEventListener('click', () => {
        const goldText = document.getElementById('gold-amount').textContent;
        const goldValue = parseInt(goldText.replace(/\D/g, '')) || 0;
        $money = goldValue;
        localStorage.setItem("$money", goldValue);
    });
}

// Fonction de fermeture des détails (si besoin)
function closeItemDetails() {
    const detailsContainer = document.getElementById('chestInventory');
    detailsContainer.innerHTML = '';
    selectedItem = null;
}



//musique de marchand
   if (window.musiqueDeFond) {
      window.musiqueDeFond.pause();
      window.musiqueDeFond.currentTime = 0;
    }

    // Lancer la musique des crédits
    const musiqueMarchand = new Audio("https://pickyouruniverse.com/DataProjects/General/SonEvenements/marchand.mp3");
    musiqueMarchand.loop = true;
    musiqueMarchand.volume = 0.7;
    musiqueMarchand.play().catch(err => console.log("Lecture bloquée par le navigateur", err));

    // Rendre la musique accessible globalement si besoin
    window.musiqueMarchand = musiqueMarchand;

  document.getElementById('explore')?.addEventListener('click', function () {
    if (window.musiqueMarchand) {
      window.musiqueMarchand.pause();
      window.musiqueMarchand.currentTime = 0;
       window.musiqueDeFond.play();
    }
  });

  document.getElementById('explore2')?.addEventListener('click', function () {
    if (window.musiqueMarchand) {
      window.musiqueMarchand.pause();
      window.musiqueMarchand.currentTime = 0;
       window.musiqueDeFond.play();
    }
  });
      </script>
    </body>
    </html>}


:: MirrorVaultArrival [NEXUS] {"position":"3325,11300","size":"100,100"}
\:: MirrorVaultArrival
You step into the Mirror‑Vault: a circular chamber lined with eight full‑length obsidian mirrors. Each reflects not your likeness but a different possible death: some peaceful, others horrific. Resin drips from the gilded frames, filling the air with faint jasmine and decay.  
What do you do?  
* [[Touch one of the mirror frames|MirrorVaultTouchFrame]]  
* [[Gaze into a mirror to confront your fate|MirrorVaultGazeMirror]]  
* [[Knock on the nearest mirror surface|MirrorVaultKnockMirror]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 8)[  
  * [[Hum a mournful tune from your bone flute|MirrorVaultSingerTrigger]]  
]



:: MirrorVaultDescendHall {"position":"2975,11850","size":"100,100"}
\:: MirrorVaultDescendHall
You step into the mirrored hall, its walls and floor strewn with jagged fragments of obsidian glass that glow with an inner blue light. Your footsteps echo twice as you pass; each shard reflects a dozen versions of yourself in silent judgment. Faint runes pulse along the floor seams, guiding you toward a distant iron door streaked with moonlit cracks.  

What do you do?  
* [[Move carefully along the rune-lit path|MirrorVaultPath]]  
* [[Kneel to inspect a particularly bright shard|MirrorVaultInspectShard]]  
* [[Gather a handful of glowing fragments|MirrorVaultGatherShards]]  
* [[Return through the mirror portal|MirrorVaultArrival]]











:: MirrorVaultDoor {"position":"2800,12150","size":"100,100"}
\:: MirrorVaultDoor
You stand before the iron door carved with the tri-burial sigil. Through its cracks you hear the distant pulse of Corvan’s wards: and the slow beat of a captured heart.  
* [[Push the door open|VaultPushDoor]]  
* [[Study the sigil’s runes|VaultStudySigil]]


:: MirrorVaultEnterMirror {"position":"2825,11700","size":"100,100"}
\:: MirrorVaultEnterMirror
You step forward and pass through the mirror’s surface. You emerge in a narrow hall lit by shards of broken glass, leading downward.  
* [[Press on into the glass‑lit hall|MirrorVaultDescendHall]]  
* [[Retreat through the mirror|MirrorVaultArrival]]


:: MirrorVaultFluteKey {"position":"3450,11675","size":"100,100"}
\:: MirrorVaultFluteKey
You press your flute into the keyhole. It fits perfectly, and when you blow a single note, the lock clicks open.  
* [[Open the door to the vault|MirrorVaultOpenVaultDoor]]  
* [[Pause to steady your nerves|MirrorVaultPrepare]]


:: MirrorVaultFollowCrack {"position":"2275,11850","size":"100,100"}
\:: MirrorVaultFollowCrack
You trace the crack; it widens into a seam. Behind the mirror you spy a narrow arch bathed in blue lantern light.  
* [[Step through the hidden arch|MirrorVaultHiddenPassage]]  
* [[Let the mirror settle|MirrorVaultArrival]]


:: MirrorVaultGatherShards {"position":"3250,12050","size":"100,100"}
\:: MirrorVaultGatherShards
You scoop up several shards. Their glow intensifies in your hand, illuminating hidden runes on the nearby walls.  
(set: $inventory to it + “Mirror Shard”)  
* [[Tuck them safely away|MirrorVaultDescendHall]]


:: MirrorVaultGazeMirror {"position":"2450,11425","size":"100,100"}
\:: MirrorVaultGazeMirror
You stare into a mirror. Your reflection grins before turning to face the room: your heart pounds. (CHA save DC 13 or gain 1 health damage from fear.)  
* [[Step back, shaken|MirrorVaultArrival]]  
* [[Touch the mirror’s surface|MirrorVaultShatterName]]


:: MirrorVaultHiddenPassage {"position":"3075,11425","size":"100,100"}
\:: MirrorVaultHiddenPassage
You step into a slender passage lined with mirrored panels. Your footsteps echo twice as you walk.  
* [[Follow the mirrored hall|MirrorVaultMirrorCorridor]]  
* [[Return to the vault room|MirrorVaultArrival]]


:: MirrorVaultInspectShard {"position":"2975,12025","size":"100,100"}
\:: MirrorVaultInspectShard
You crouch to examine a glowing shard. Its edge feels unnaturally warm, and when you peer into its reflection you see a flash of a grand court: your final destination.  
(set: $journal to it + (a: "I saw a vision of the Severance Court in a mirror shard"+ "\n\n"))
* [[Pocket the shard|MirrorVaultDescendHall]]  
* [[Stand and continue on|MirrorVaultPath]]


:: MirrorVaultKnockMirror {"position":"2575,11425","size":"100,100"}
\:: MirrorVaultKnockMirror
Three taps echo unnaturally. One mirror responds with a hollow tone that reveals an inscription on its frame: “Truth lies beyond reflection.”  
* [[Trace the inscription|MirrorVaultTraceInscription]]  
* [[Step away|MirrorVaultArrival]]


:: MirrorVaultMirrorCorridor {"position":"3450,11425","size":"100,100"}
\:: MirrorVaultMirrorCorridor
The corridor ends before a heavy iron door stamped with the tri‑burial sigil. Shattered mirror shards litter the floor.  
* [[Prepare to open the door|MirrorVaultPrepare]]  
* [[Study the sigil’s runes|MirrorVaultStudySigil]]


:: MirrorVaultOpenVaultDoor {"position":"3675,11275","size":"100,100"}
\:: MirrorVaultOpenVaultDoor
The iron door swings inward with a resonant groan, revealing a torch‑lit corridor that leads straight to Corvan’s sealed vault entrance.  
* [[Step forward into the vault entrance|VaultEntrance]]  
* [[Hesitate, heart racing|MirrorVaultPrepare]]


:: MirrorVaultPath {"position":"3225,12275","size":"100,100"}
\:: MirrorVaultPath
You follow the runes inlaid in the floor. They lead straight to the iron door, its surface carved with the tri-burial sigil. A soft hum vibrates through the glass underfoot.  
* [[Approach the door|MirrorVaultDoor]]  
* [[Pause to steady your nerves|MirrorVaultPrepare]]


:: MirrorVaultPeerThrough {"position":"2475,11875","size":"100,100"}
\:: MirrorVaultPeerThrough
Through the gap you see a corridor lined with runic mirrors. A faint pulse echoes from beyond.  
* [[Squeeze through into the corridor|MirrorVaultMirrorCorridor]]  
* [[Patch the crack and return|MirrorVaultArrival]]


:: MirrorVaultPrepare {"position":"3800,11550","size":"100,100"}
\:: MirrorVaultPrepare
You take a steadying breath, grip your flute and any wards you’ve learned. Beyond this door lies the brain reliquary you’ve sought.  
* [[Push open the vault door|MirrorVaultOpenVaultDoor]]  
* [[Step back a moment|MirrorVaultMirrorCorridor]]


:: MirrorVaultPressAgain {"position":"2225,11625","size":"100,100"}
\:: MirrorVaultPressAgain
You press firmly. The glass ripples like water, and a spectral hand reaches out before vanishing. A soft crack forms along one frame edge.  
* [[Follow the crack|MirrorVaultFollowCrack]]  
* [[Step away quickly|MirrorVaultArrival]]


:: MirrorVaultShatterName {"position":"2425,11650","size":"100,100"}
\:: MirrorVaultShatterName
You press your palm and the glass shatters inward in slow motion. Behind the rubble lies a carved keyhole in the wall.  
* [[Peer through the opening|MirrorVaultPeerThrough]]  
* [[Abruptly retreat|MirrorVaultArrival]]


:: MirrorVaultSingerTrigger {"position":"2700,11425","size":"100,100"}
\:: MirrorVaultSingerTrigger
You lift your bone flute and play a mournful melody. The mirrors’ reflections sway in time, and the “Truth” mirror’s glass parts like curtains, revealing a hidden doorway.  
* [[Enter the doorway revealed by your song|MirrorVaultHiddenPassage]]  
* [[Lower your flute|MirrorVaultArrival]]


:: MirrorVaultStudySigil {"position":"3450,11550","size":"100,100"}
\:: MirrorVaultStudySigil
The loops of the sigil shimmer like fractured glass. Beneath them, a bone‑shaped keyhole glows faintly.  
* [[Use the Bone Flute to unlock the seal|MirrorVaultFluteKey]]  
* [[Step back|MirrorVaultMirrorCorridor]]


:: MirrorVaultTouchFrame {"position":"2325,11425","size":"100,100"}
\:: MirrorVaultTouchFrame
Your fingers press the cold obsidian. The mirror shudders beneath your touch, and your reflection steps sideways: then snaps back.  
* [[Withdraw and step back|MirrorVaultArrival]]  
* [[Press again to test it|MirrorVaultPressAgain]]


:: MirrorVaultTraceInscription {"position":"2675,11650","size":"100,100"}
\:: MirrorVaultTraceInscription
Your touch reveals hidden runes: “Step through the truth, shatter the lie.” One mirror’s glass grows translucent.  
* [[Enter the translucent mirror|MirrorVaultEnterMirror]]  
* [[Step back|MirrorVaultArrival]]


:: MorgueCatacombsArrival [NEXUS] {"position":"975,5775","size":"100,100"}
\:: MorgueCatacombsArrival
You step into the Morgue Catacombs: a series of low, frost‑chilled vaults lined with stone shelves. Corpse tags sealed in blood‑red ink hang from each slab, and a thin mist coils along the floor. The air tastes of antiseptic and decay.  
What do you do?  
* [[Examine a sealed tag at random|CatacombsOpenTag]]  
* [[Listen for movement among the corpses|CatacombsListen]]  
* [[Inspect the runes carved into the wall|CatacombsInspectRunes]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 2)[  
  * [[Run your fingers along the shelf edges|CatacombsBastardTrigger]]  
]




























:: MortuaryHallArrival [NEXUS] {"position":"300,4650","size":"100,100"}
\:: MortuaryHallArrival
You step into the vast Mortuary Hall. Polished marble tables stretch in rows beneath cold blue lanterns. Brass embalming tools gleam, and jars of scented oils line the walls. The air is heavy with lavender and decay.  
What do you do?  
* [[Examine the pulsing slab in the center|HallPulsingSlab]]  
* [[Inspect the row of empty bier‑hooks|HallBierHooks]]  
* [[Approach the far lectern with scattered papers|HallLectern]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 1)[  
  * [[You spot a vial that bears your old camp mark. Take it?|HallRefugeeTrigger]]  
]  



:: MortuaryHallDepth {"position":"550,4975","size":"100,100"}
\:: MortuaryHallDepth
You emerge into a narrower hall lined with glass display cases holding preserved organs. A single case glows around a brain‑shaped reliquary.  
* [[Approach the brain reliquary|HallBrainReliquary]]  
* [[Study the other organs|HallOrganCases]]  
* [[Fallback to Lectern area|MortuaryHallArrival]]


:: MourningOakInnArrival [NEXUS] {"position":"975,2250","size":"100,100"}

\:: MourningOakInnArrival
You step beneath the hollowed branches of the **Mourning Oak Inn**, its common room lit by lanterns dripping luminous sap. Patrons sit in hushed circles, nursing somber ale as the dead wood creaks overhead.  
What do you do?  
* [[Try to climb the oak’s branch for a better view|MOIStupidChoice]]  
* [[Order a drink at the bar|MOIDefaultInteraction]]  
* (if: $job is 6)[[Let your Exhumed presence earn you a free ale: at a cost|MOIExhumed]]  
* (if: $backStory is 6)[[Show your Severed Ritual scar to gain the barkeep’s respect|MOIBS6Severed]]  
* [[Return to the square|VelthornHollowOrientation]]


:: NecroAskCorvan {"position":"250,3875","size":"100,100"}
\:: NecroAskCorvan
**You:** “Do you know anything of Magister Corvan?”  
**Diener:** He glances away, voice hushed. “Corvan? The old necromancer: his brain was sealed in a vault beneath the Mortuary Hall. No door leads straight there; he prepared it so only those who piece together his clues can enter.”  
* [[Thank him and ask more|NecroDienerQuestion]]  
* [[Climb out of the coffin|NecroExitCoffin]]


:: NecroAskDiener {"position":"525,3775","size":"100,100"}
\:: NecroAskDiener
**You:** “And what is your name: and why help me?”  
**Diener:** He brushes dust from his robe. “Call me Malveris. I’ve seen too many corpses wander in here blind. Help me unravel Corvan’s secrets, and I’ll keep your body intact.”  
* [[Agree to his terms|NecroExitCoffin]]  
* [[Climb out of the coffin|NecroExitCoffin]]


:: NecroAskNecropolis {"position":"375,3875","size":"100,100"}
\:: NecroAskNecropolis
**You:** “What is this place: truly?”  
**Diener:** “A city of the dead’s caretakers. We embalm, we entomb, we study. Beyond these halls lie the Catacombs, the Ossuary, the Rotted Library… all twelve domains, each more perilous than the last.”  
* [[Ask which domain to explore first|NecroDienerRecommend]]  
* [[Climb out of the coffin|NecroExitCoffin]]



:: NecroAskVault {"position":"1225,4100","size":"100,100"}
\:: NecroAskVault
**You:** “How will I find it?”  
**Diener:** “There’s no direct path: he arranged it so. You’ll have to piece together clues in the mortuary halls, the catacombs, and the ossuary. Best start by getting your legs under you.”  
* [[Climb out of the coffin|NecroExitCoffin]]


:: NecroCallOut {"position":"1600,3600","size":"100,100"}
\:: NecroCallOut
Your voice comes as a rasp: “Hello? Anyone: ”  
Silence answers. Only the drip, drip, drip of unseen water.  
* [[Struggle for air and calm yourself|NecroCalm]]  
* [[Call again, louder|NecroCallOutEcho]]


:: NecroCallOutEcho {"position":"1550,3775","size":"100,100"}
\:: NecroCallOutEcho
Your echo rings hollow. Far above, you hear the scuff of boots and the scrape of metal.  
* [[Wait quietly|NecroDienerArrival]]  
* [[Shout again with all your might|NecroCallOut]]


:: NecroCalm {"position":"1525,3425","size":"100,100"}
\:: NecroCalm
You force your racing heart to slow. Lantern‑blue light seeps through a narrow crack. Above, you hear slow footsteps.  
* [[Prepare to speak|NecroDienerArrival]]  


:: NecroDienerArrival {"position":"1250,3550","size":"100,100"}
\:: NecroDienerArrival
A voice rasps through the crack:  
**Diener:** “By the bones… you’re not supposed to wake yet.”  
A grate of metal follows as a slim boot presses against the lid, then a hand fits into the seam and lifts.  

* [[Let him lift the lid|NecroDienerSpeak]]  


:: NecroDienerNegotiate {"position":"1025,4000","size":"100,100"}
\:: NecroDienerNegotiate
**You:** “Please, just get me out.”  
**Diener (shrugging):** “Fine, but first: consider a favor. I need your cooperation, corpse or not.”  
He leans close, voice low:  
**Diener:** “Corvan’s brain rests in the Reliquary beneath this place. You can’t just march straight there: he had himself interred behind wards and sealed doors. You’ll need help getting past them.”  
* [[Climb out of the coffin|NecroExitCoffin]]  


:: NecroDienerQuestion {"position":"350,3675","size":"100,100"}
\:: NecroDienerQuestion
**You:** “Where am I? Who are you?”  
**Diener:** “This is the Mortuary of the Necropolis, and I’m one of its Dieners: an embalmer by trade. Most here prefer to stay dead.”  

What do you want to ask?  
* [[Ask about Magister Corvan|NecroAskCorvan]]  
* [[Ask about this place|NecroAskNecropolis]]  
* [[Ask the Diener’s name and purpose|NecroAskDiener]]  
* [[Climb out of the coffin|NecroExitCoffin]]










:: NecroDienerRecommend {"position":"475,4000","size":"100,100"}
\:: NecroDienerRecommend
**You:** “Which domain would you suggest I tackle first?”  
**Diener:** “Begin in the Mortuary Hall: learn the rites of preservation there, then descend into the Catacombs. Seek me later if you need supplies.”  
* [[Climb out of the coffin|NecroExitCoffin]]


:: NecroDienerSpeak {"position":"1075,3600","size":"100,100"}
\:: NecroDienerSpeak
The coffin lid swings open. A lean figure in black‑lined robes stands over you, tools at his belt. He peers in, unimpressed.  
**Diener:** “Wait a minute… you’re not actually dead?”  

What do you say?  
* [[“Please help me out of here.”|NecroDienerNegotiate]]  
* [[“Where am I? Who are you?”|NecroDienerQuestion]]  


:: NecroExitCoffin {"position":"1600,4000","size":"100,100"}
\:: NecroExitCoffin
You haul yourself free of the silver coffin. The floor is cold marble, etched with runes that pulse softly. The Diener steps back, tucking his tools away.  
**Diener:** “Suit yourself. If you want guidance: or supplies: seek me in the Mortuary Hall. I keep a small shop of embalming wares.”  
He vanishes through an arch of carved bones.  

* [[Step forward into the Necropolis|NecroOrientation]]


:: NecroOrientation {"position":"1575,4175","size":"200,200"}
: NecroOrientation
You stand at the threshold of the Necropolis proper. Moon‑blue lanterns reveal twelve paths, each descending into a different funeral domain:  
* [[Mortuary Hall|MortuaryHallArrival]] &mdash; White marble tables and embalming tools await.  
* [[Morgue Catacombs|MorgueCatacombsArrival]] &mdash; Frost‑lined vaults of rune‑sealed corpses.  
* [[Ossuary of Echoes|OssuaryEchoesArrival]] &mdash; A domed chamber of bones and ectoplasm.  
* [[Lantern‑lit Gallery|LanternGalleryArrival]] &mdash; Floating lanterns cradling dying souls.  
* [[Gallery of Weeping Effigies|WeepingEffigiesArrival]] &mdash; Statues weeping black sap.  
* [[Silent Crypt|SilentCryptArrival]] &mdash; Windowless vault with muffled moans.  
* [[Ossuary Chapel|OssuaryChapelArrival]] &mdash; Bone‑wrought chapel stained with sacrificial blood.  
* [[Mirror‑Vault|MirrorVaultArrival]] &mdash; Obsidian mirrors reflecting impossible fates.  
* [[Rotted Library|RottedLibraryArrival]] &mdash; Moldy tomes and spilled ink.  
* [[Forgotten Cartway|CartwayArrival]] &mdash; Overgrown tracks leading beneath tombs.  
* [[Pilgrim’s Rest|PilgrimRestArrival]] &mdash; A ruined oratory of blood‑stained pews.  
* [[Reliquary of Frozen Hearts|FrozenHeartsArrival]] &mdash; Glass cases of crystal‑preserved hearts.  

A small wooden sign beside you reads:  
> “Mortuary supplies to the left: ask the Diener. May your steps be cautious.”  

* [[Begin your exploration…|MortuaryHallArrival]]



:: NecroStruggle {"position":"1850,3550","size":"100,100"}
\:: NecroStruggle
Your arms strain, but the coffin holds fast. A distant drip echoes around you. You feel the silver walls grow colder as panic rises.  
* [[Stop and catch your breath|NecroCalm]]  
* [[Keep forcing the lid|NecroStruggleFail]]


:: NecroStruggleFail {"position":"1725,3350","size":"100,100"}
\:: NecroStruggleFail
Your muscles burn and you slump back, breath coming in sharp gasps. The coffin’s chill seeps into your bones.  
* [[Steady yourself and pause|NecroCalm]]


:: NecroWake {"position":"1950,3925","size":"100,100"}
\:: NecroWake
You blink awake to silver darkness. Your chest is encased in polished metal: the lid of a coffin of burnished silver. Earth presses everywhere; the faintest shaft of lantern‑blue light glints along the coffin’s rim.   
Somewhere beyond, a distant echoing drip reminds you: your quest is not over.  

What do you do?  
* [[Struggle against the lid|NecroStruggle]]  
* [[Call out for help|NecroCallOut]] 


:: NecropolisEntrance {"position":"3500,4975","size":"100,100"}
\:: NecropolisEntrance
The coffin lid slides open. You push it aside and step into the silent vaults of the Necropolis, heart still aching: but alive.  
(set: $inCrypt to false)  
The second burial awaits in these depths...  
* [[Press onward into the tombs|NecropolisTunnelEntry]]


Wait a minute... You are not actually dead?
What a pitty. Would you mind pretend while i work on you
Work on me ?
You see... I am a Diener so... I need to embaume you
No, thank you but no. I prefer to stay alive.
But... it is my duty. You wouldn't want your corpse to rot, would you?
Just get me out of here and we will talk it out


:: NecropolisTunnelEntry {"position":"3500,5150","size":"100,100"}



:: NightArchiveBrowse {"position":"4375,1600","size":"100,100"}
\:: NightArchiveBrowse
Shelves of leather‑bound volumes line the walls. Titles include **“Severance Codex”**, **“Echoes of the Dead”**, and **“Rituals of the Veil”**.  
* [[Pull “Severance Codex” off the shelf|NightSeveranceCodex]]  
* [[Pull “Echoes of the Dead” off the shelf|NightEchoesDead]]  
* [[Return to the librarian|NightArchiveLobby]]

While browsing through the shelves, you feel something strange...

(click:"something strange...")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
    :: NightHiddenStair
Behind a rolling shelf you discover stone steps spiraling down.  
* [[Descend the hidden stair|NightArchiveLowerLevel]]  
* [[Leave it be|NightArchiveBrowse]]
    ]
(else:)
    [No, that's nothing, just the general vibes of this old books... 
    ]
]
 ]



:: NightArchiveCornerAlcove {"position":"4525,1725","size":"100,100"}
\:: NightArchiveCornerAlcove
A narrow alcove holds a pedestal with a single glowing orb.  
* [[Touch the orb|NightOrbTouch]]  
* [[Ignore it and browse elsewhere|NightArchiveBrowse]]


:: NightArchiveEntrance {"position":"4325,1200","size":"100,100"}
\:: NightArchiveEntrance
You squeeze through the gap and descend a narrow shaft of stacked crates. At the bottom, you find a room filled with... paperwork.
The entire village history is laid here, but surely no secrets at all, just reports on bad crops, disputes between neighboors, the taxes that always rise and the complain that follow the same path.
You feel silly having followed that stupid aimal that lead you to his ... wait a minute, is that...

<!--A CHEST-->

(click:"is that...")[

(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
    a hidden door swings open onto a vaulted library: shelves of dusty tomes, flickering sconces, and a moonbeam‑lit globe at its center.  
* [[Step into the Moonlit Archive|NightArchiveLobby]]
    ]
(else:)
    [
    No. There is nothing ther, for sure. You stay a while more, but it is time to go [[back to reality|NightVelthornHollowOrientation]]
    ]

 ]
 ]



:: NightArchiveLobby {"position":"4100,1450","size":"100,100"}
\:: NightArchiveLobby
Rows of ancient books stretch endlessly. A spectral librarian hovers at a lectern, ink‑stained robes trailing in the dust.  
**Librarian:** “Welcome, seeker. All knowledge has its price.”  
* [[Ask what price knowledge demands|NightLibrarianPrice]]  
* [[Browse the nearest shelf silently|NightArchiveBrowse]]  
* [[Retreat to the shafts|NightRMSFollowRat]]


:: NightArchiveLowerLevel {"position":"4950,1500","size":"100,100"}
\:: NightArchiveLowerLevel
You emerge in a circular chamber. At its center, a marble sarcophagus glows faintly.  
* [[Approach the sarcophagus|NightSarcophagusApproach]]  
* [[Climb back up|NightArchiveLobby]]


:: NightBSSAshWarVeteranEcho {"position":"7700,1150","size":"100,100"}
\:: NightBSSAshWarVeteranEcho
You study the soldier’s scrawl: it matches the handwriting of your own war‑torn letters, written long ago under a different name. A wave of memories crashes over you.  
(set: $journal to it + (a: "I realized I witnessed Corvan’s ritual, long ago"+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Gather yourself and step back|NightBoneStackedShrineArrival]]


:: NightBSSReadLetter {"position":"8000,1125","size":"100,100"}
\:: NightBSSReadLetter
You unfold the ash‑smudged parchment and read:  
> “I watched him there: Magister Corvan: split soul and flesh beneath these stones. I trembled, knowing I could not stop him.”  
(set: $journal to it + (a: "I found a soldier’s confession of Corvan’s ritual"+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Fold the letter and step back|NightBoneStackedShrineArrival]]



:: NightBSSTinkerBones {"position":"7475,1125","size":"100,100"}
\:: NightBSSTinkerBones
You lift a femur and replace it with a rib. The chimes rattle out three slow notes: then one. A hidden cavity opens in the altar’s base, revealing a **Bone key**.  
(set: $inventory to it + “Bonekey”)  
* [[Pocket the Bonekey|NightBoneStackedShrineArrival]]



:: NightBoneStackedShrineArrival [NEXUS] {"position":"7525,825","size":"100,100"}
\:: NightBoneStackedShrineArrival
Under a canopy of stars, the Bone‑Stacked Shrine creaks as if alive. Every so often, a single skull or femur slides off the pile, as though beckoning you to add: or remove: a piece. Beneath one femur you spot a scrap of parchment: a soldier’s letter home, its ink smeared but readable.  
What do you do?  
* [[Read the soldier’s letter|NightBSSReadLetter]]  
* [[Add or remove a bone from the altar|NightBSSTinkerBones]]  
* (if: $job is 9)[[Inspect the handwriting: does it match your own scarred script?|NightBSSAshWarVeteranEcho]]  
* [[Return to the square|NightVelthornHollowOrientation]]







:: NightCRPListenGiggle {"position":"7800,1925","size":"100,100"}
\:: NightCRPListenGiggle
A child’s soft giggle echoes from the water’s edge. You crouch and sift through the mud, finding a small iron key half‑buried beneath silt.  
(set: $inventory to it + “Rusty Iron Key”)  
* [[Pocket the key|NightCrackedReflectionPoolArrival]]


:: NightCRPTossPebble {"position":"7550,1925","size":"100,100"}
\:: NightCRPTossPebble
You fling a pebble; the water’s surface holds the ripple mid‑air. In that frozen moment, you glimpse Corvan’s silhouette descending an impossibly long stone stair beneath the pool. Then time snaps back and the water settles.  
(set: $journal to it + “Vision: Corvan’s hidden stair”+ "\n\n" )  
* [[Step back and ponder|NightCrackedReflectionPoolArrival]]


:: NightCRPWatchReflection {"position":"7675,1925","size":"100,100"}
\:: NightCRPWatchReflection
You stand motionless. Your mirrored image shifts: your features blur and reform, and you see yourself draped in Corvan’s robes. The vision fades, leaving you breathless and unsettled.  
(set: $journal to it + “Reflection: past life in Corvan’s robes” )  
* [[Step away from the pool|NightCrackedReflectionPoolArrival]]


:: NightCrackedReflectionPoolArrival [NEXUS] {"position":"7625,1650","size":"100,100"}
\:: NightCrackedReflectionPoolArrival
The moonlight casts fractured patterns across the Cracked Reflection Pool. Its obsidian mirror lies just beneath the water’s surface, rippling with every breath of wind. You notice smooth pebbles at the edge and faint muddy handprints half‑submerged.  
What do you do?  
* [[Toss a pebble into the pool|NightCRPTossPebble]]  
* [[Stand perfectly still and watch your reflection|NightCRPWatchReflection]]  
* [[Listen for hidden giggles in the dark|NightCRPListenGiggle]]  
* [[Return to the square|NightVelthornHollowOrientation]]




:: NightEchoesDead {"position":"4375,2000","size":"100,100"}
\:: NightEchoesDead
Scanning “Echoes of the Dead,” you find a hechizo that lets you hear the murmurs of nearby ghosts for a minute.  
(set: $inventory to it + “Echo Spell” )  
* [[Tuck it away|NightArchiveBrowse]]


:: NightFGGPressStone {"position":"5512.5,2675","size":"100,100"}
\:: NightFGGPressStone
You press your palm to the cool stone. A whisper drifts: “I never left.” The ground trembles faintly, and you feel the veil between life and death grow thin.  
(set: $journal to it + (a: "I heard Corvan’s whisper: ‘I never left.’"+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Release the stone|NightForgottenGraveyardGateArrival]]


:: NightFGGRetrieveKey {"position":"5650,2675","size":"100,100"}
\:: NightFGGRetrieveKey
You reach up and unhook the rusted root from the gnarled wood. In your hand rests a heavy iron key.  
(set: $inventory to it + “Cemetery Cart Key”)  
* [[Use the key on the cart track gate|NightFGGUnlockTrack]]  
* [[Pocket the key and step back|NightForgottenGraveyardGateArrival]]


:: NightFGGTombstoneExamine {"position":"5387.5,2675","size":"100,100"}
\:: NightFGGTombstoneExamine
You brush moss from the tombstone. The dates inscribed: centuries ago: imply Corvan was buried here long before his legend began. A shiver runs up your spine.  
(set: $journal to it + “Discovered Corvan’s forgotten burial” )  
* [[Step back|NightForgottenGraveyardGateArrival]]


:: NightFGGUnlockTrack {"position":"5650,2800","size":"100,100"}
\:: NightFGGUnlockTrack
You find the barred cart track gate nearby. The Cemetery Cart Key fits with a click. The bars swing open, revealing rails that slope into darkness beneath the graves.  
* [[Descend the cart track|NightTunnelEntrance]]  
* [[Leave it closed for now|NightForgottenGraveyardGateArrival]]


:: NightForgottenGraveyardGateArrival [NEXUS] {"position":"5600,2375","size":"100,100"}
\:: NightForgottenGraveyardGateArrival
The iron arch of the Forgotten Graveyard Gate looms under moonlight, its bars entwined with gnarled roots. Nearby, an overturned tombstone bears the name “Corvan” with dates long before his famed Severance. A single key dangles from a root above, glinting with dew.  
What do you do?  
* [[Examine the overturned tombstone|NightFGGTombstoneExamine]]  
* [[Press the stone and listen|NightFGGPressStone]]  
* [[Retrieve the key from the root|NightFGGRetrieveKey]]  
* [[Return to the square|NightVelthornHollowOrientation]]



:: NightHBBTAfterKnock {"position":"8025,2375","size":"100,100"}
\:: NightHBBTAfterKnock
The roots groan and snap: one arches up to strike you!  
(DEX save DC 12 or take 2 health damage)  
* [[Dodge aside|NightHalfBuriedBellTowerArrival]]  
* [[Stand your ground|NightHBBTRootStrike]]


:: NightHBBTChant {"position":"8325,2450","size":"100,100"}
\:: NightHBBTChant
You speak the monk’s words softly. The roots pause their creaking, then retract to reveal a stone slab inset with a carved heart-sigil.  
* [[Prise up the slab|NightHBBTRevealTunnel]]  
* [[Hesitate and step back|NightHalfBuriedBellTowerArrival]]


:: NightHBBTCollapsePit {"position":"8175,2575","size":"100,100"}
\:: NightHBBTCollapsePit
The ground opens into a hidden pit. You plummet into darkness, limbs flailing as bone-spikes loom…  
* [[Scream as you fall|GameOver_Pitfall]]


:: NightHBBTDefaultInteraction {"position":"8775,2250","size":"100,100"}
\:: NightHBBTDefaultInteraction
You press gently on the door. The roots groan, and a hidden seam parts slightly: just enough to slip a finger through.  
* [[Wriggle the door open|NightTunnelEntrance]]  
* [[Close it carefully|NightHalfBuriedBellTowerArrival]]


:: NightHBBTLastOfSeveredEcho {"position":"9000,2100","size":"100,100"}
Your scar thrums in time with the bronze chime. A fragmented memory surfaces: Corvan’s plea: “Help me bind the restless”: echoing beneath these stones.  
(set: $journal to it + (a: "A fragmented memory surfaced: Corvan’s plea: “Help me bind the restless”” "+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Clutch your scar and step back]()]()*


:: NightHBBTPushDoor {"position":"8175,2450","size":"100,100"}
\:: NightHBBTPushDoor
You lean and shove. The roots resist, then suddenly give way with a roar: soil collapses beneath you!  
* [[Jump back (DEX save DC 13)|NightHalfBuriedBellTowerArrival]]  
* [[Stumble forward|NightHBBTCollapsePit]]


:: NightHBBTRapThrice {"position":"8150,2250","size":"100,100"}
\:: NightHBBTRapThrice
You rap three solemn knocks on the root‑strewn door. From beneath your feet comes a faint, harmonious chime: not the bell above, but hidden bronze plates vibrating in concert.  
(set: $journal to it + (a: "I heard hidden bronze chime beneath tower” "+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
You rap three solemn knocks, once again. This time, beneath your feet, you hear a faint chime of hidden bronze plates… then a sharp crack. The earth trembles.  
* [[Step back quickly|NightHalfBuriedBellTowerArrival]]  
* [[Press on despite the tremor|NightHBBTAfterKnock]]


:: NightHBBTRevealTunnel {"position":"8325,2575","size":"100,100"}
\:: NightHBBTRevealTunnel
Beneath the slab lies a narrow stair descending into damp darkness. A faint blue glow pulses below.  
* [[Descend into the tunnel|NightTunnelEntrance]]  
* [[Close the slab and reconsider|NightHalfBuriedBellTowerArrival]]


:: NightHBBTRootStrike {"position":"8025,2500","size":"100,100"}
\:: NightHBBTRootStrike
The root lashes your thigh, vines tearing at your leg as you fall. The world spins: and you black out.  
* [[…|GameOver_Entangled]]  


:: NightHBBTWatchMonk {"position":"8525,2325","size":"100,100"}
\:: NightHBBTWatchMonk
The monk pauses his offering, eyes closed.  
**Monk:** “This tower weeps for its sins. Only sweetness soothes its sorrow.”  
He offers you the unspent honey and beckons you to join his ritual.  
(set: $inventory to it + “Blessed Honey”)  
* [[Accept the honey and bow|NightHalfBuriedBellTowerArrival]]  
* [[Decline and step back|NightHalfBuriedBellTowerArrival]]


:: NightHalfBuriedBellTowerArrival [NEXUS] {"position":"8575,1975","size":"100,100"}
\:: NightHalfBuriedBellTowerArrival
Moonlight glints on the half‑buried door of the Bell Tower, its roots twisting like veins. You notice an old monk kneeling at the base, drizzling honey over the roots and murmuring prayers.  
What do you do?  
* [[Rap thrice on the door|NightHBBTRapThrice]]  
* [[Watch the monk and listen to his prayers|NightHBBTWatchMonk]]  
* [[Gently push on the door to test for weakness|NightHBBTDefaultInteraction]]  
* [[Return to the square|NightVelthornHollowOrientation]]
* (if: $backStory is 6)[[Your severance scar starts to react|NightHBBTLastOfSeveredEcho]]

* [[Try to push the door open with force|NightHBBTPushDoor]]  
* [[Speak the chant the monk was whispering|NightHBBTChant]]  



:: NightHeartExitSearch {"position":"5025,2025","size":"100,100"}
\:: NightHeartExitSearch
Your lantern’s beam finds a tunnel carved through marble.  
* [[Follow the marble tunnel|NightTunnelEntrance]]  
* [[Clutch the heart and return to the archive|NightArchiveLobby]]


:: NightHeartRelease {"position":"4950,1775","size":"100,100"}
\:: NightHeartRelease
You lift the heart from its bed. The chamber trembles, and the sarcophagus seals behind you.  
(set: $inventory to it + “Crystal Heart” )  
* [[Search for an exit|NightHeartExitSearch]]


:: NightLibrarianPrice {"position":"4200,1700","size":"100,100"}
\:: NightLibrarianPrice
The librarian’s eyes glow. “A single truth in exchange for a single lie.”  
* [[Offer a truth about yourself|NightOfferTruth]]  
* [[Offer a lie instead|NightOfferLie]]


:: NightMOIClimbParchment {"position":"6925,3725","size":"100,100"}
\:: NightMOIClimbParchment
You clamber up the rafters, steadying yourself on the oak’s gnarled limbs. You retrieve the parchment: its blood‑smeared ink warns, “Beware the second vein: a path of no return.”  
(set: $journal to it + “Found warning: second vein”+ "\n\n" )  
* [[Descend carefully|NightMourningOakInnArrival]]


:: NightMOIDefaultInteraction {"position":"7125,3725","size":"100,100"}
\:: NightMOIDefaultInteraction
You ask the barkeep for the sap‑laced ale. He pours a thick mug, its sap glowing softly. You lift it to your lips and see, in the swirling amber, visions of a soldier’s last farewell and a whisper: “Choice defines the living.”  
(set: $journal to it + “Vision: soldier’s farewell” + "\n\n")  
* [[Thank him and set the mug down|NightMourningOakInnArrival]]


:: NightMOINobleScionEcho {"position":"7375,3700","size":"100,100"}
\:: NightMOINobleScionEcho
You examine the parchment’s seal: it bears your family’s crest alongside Corvan’s sigil. A cold dread settles as you realize your lineage might have taken part in these rituals.  
(set: $journal to it + “Discovered familial ties to Corvan” )  
* [[Fold the parchment and step back|NightMourningOakInnArrival]]




:: NightMourningOakInnArrival [NEXUS] {"position":"7075,3425","size":"100,100"}
\:: NightMourningOakInnArrival
The Mourning Oak Inn’s great dead tree looms overhead, its sap‑dripped branches casting dancing shadows in the lantern light. Patrons sit in hushed clusters, mugs catching the amber sap which grants fleeting visions of the departed. High above, rafters creak as the oak’s sap drips into a half‑empty mug, and you spot a blood‑soaked scrap of parchment tucked into a crook in the wood.  
What do you do?  
* [[Climb up to retrieve the parchment|NightMOIClimbParchment]]  
* [[Order a sap‑laced ale from the barkeep|NightMOIDefaultInteraction]]  
* (if: $job is 5)[[Examine the parchment’s seal: does it bear your family crest?|NightMOINobleScionEcho]]  
* [[Step back into the square|NightVelthornHollowOrientation]]



:: NightOfferLie {"position":"4275,1900","size":"100,100"}
\:: NightOfferLie
**You:** “I have never feared death.”  
The librarian smiles thinly. “Then you shall fear ignorance.” A volume titled **“Veilbound Grimoire”** hovers free.  
(set: $inventory to it + “Veilbound Grimoire”)  
* [[Pocket the grimoire|NightArchiveBrowse]]  
* [[Step back in unease|NightArchiveLobby]]


:: NightOfferTruth {"position":"4075,1750","size":"100,100"}
\:: NightOfferTruth
**You:** “I once betrayed a friend for power.”  
The librarian nods gravely. “Fair trade.” A tome floats off a shelf: its spine reads **“Corvan’s Diary”**.  
(set: $inventory to it + “Corvan’s Diary”)  
* [[Open the diary|NightOpenCorvanDiary]]  
* [[Thank the librarian and browse more|NightArchiveBrowse]]


:: NightOpenCorvanDiary {"position":"4125,1950","size":"100,100"}
\:: NightOpenCorvanDiary
You flip to a random page: a crude sketch shows three burial urns and a note: “Heart’s bond broken here.”  
(set: $journal to it + (a: "I found a crude sketch shows three burial urns and a note: “Heart’s bond broken here.”"+ "\n\n"))
* [[Close the diary|NightArchiveBrowse]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}


:: NightOrbTouch {"position":"4575,1975","size":"100,100"}
\:: NightOrbTouch
Your vision shifts: you see Corvan’s hand placing the orb in his chest, binding his heart’s magic. Then the vision fades.  
(set: $journal to it + (a: "I had a vision of Corvan's heart binding"+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Withdraw your hand|NightArchiveCornerAlcove]]



:: NightRMSFollowRat {"position":"4700,1225","size":"100,100"}
\:: NightRMSFollowRat
The rat darts beneath a broken stall and pauses at a loose floorboard. It chitters, urging you forward.  
* [[Prise up the board and follow|NightArchiveEntrance]]  
* [[Step back: this feels too odd|NightRottedMarketStallsArrival]]



\:: NightOfferTruth2
   (Alternative truth exchange for more lore)

\:: NightOfferLie2
   (Alternative lie exchange)





\:: NightLibrarianFarewell
(If you return to the librarian with knowledge)
**Librarian:** “You’ve learned much. Now go, lest the Archive devour your mind.”  
* [[Bow and depart|NightTunnelEntrance]]



:: NightRMSLanternBearerEcho {"position":"5025,975","size":"100,100"}
\:: NightRMSLanternBearerEcho
Your lantern’s flame flares, and ghostly words glow on the tarpaulin: “Light the way, and I will follow.” A chill wind stirs, as if someone: or something: wants you to lead onward.  
(set: $flags to it + “RMSGuidedByGhost”)  
* [[Lower your lantern and consider your next move|NightRottedMarketStallsArrival]]


:: NightRMSOpenBox {"position":"4525,1050","size":"100,100"}
\:: NightRMSOpenBox
You slide aside the wax seal and lift the lid. Inside rests a single quill and a smudge of red wax on folded parchment: evidence of a noble’s secret correspondence with Corvan.  
(set: $inventory to it + “Corvan Dispatch”)  
* [[Stow the dispatch|NightRottedMarketStallsArrival]]


:: NightRottedMarketStallsArrival [NEXUS] {"position":"4725,850","size":"100,100"}
\:: NightRottedMarketStallsArrival
Lanterns glow sickly at the half‑collapsed stalls under the midnight sky. Tattered tarps flap in the breeze, and the scent of damp herbs mingles with old magic. A sealed wooden box stamped with the Pale Court’s crest lies forgotten beneath a tarp, and a lone rat with a bone earring scuttles near your boots.  
What do you do?  
* [[Open the Pale Court box|NightRMSOpenBox]]  
* [[Follow the bone‑eared rat|NightRMSFollowRat]]  
* (if: $job is 2)[[Hold your lantern high to reveal ghostly runes on the tarpaulin|NightRMSLanternBearerEcho]]  
* [[Return to square|NightVelthornHollowOrientation]]









:: NightSarcophagusApproach {"position":"4825,1650","size":"100,100"}
\:: NightSarcophagusApproach
The lid bears the tri‑burial sigil inlaid in obsidian.  
* [[Push the lid aside|NightSarcophagusOpen]]  
* [[Step back, heart pounding|NightArchiveLowerLevel]]


:: NightSarcophagusClose {"position":"5225,1800","size":"100,100"}
\:: NightSarcophagusClose
You close the lid; the glow fades.  
* [[Retreat to the lower level|NightArchiveLowerLevel]]


:: NightSarcophagusOpen {"position":"5100,1625","size":"100,100"}
\:: NightSarcophagusOpen
Inside lies not a body but a crystal heart pulsing with moonlight. It speaks in a whisper: “Release me.”  
* [[Heed its plea|NightHeartRelease]]  
* [[Seal it again|NightSarcophagusClose]]


:: NightSeveranceCodex {"position":"4475,1875","size":"100,100"}
\:: NightSeveranceCodex
You open the Severance Codex. Inside is Marginalia in a familiar hand: your own? It details how to sever a soul without killing the body.  
(set: $journal to it + (a: "I saw my own hand in the Codex.What a frightening vision!"+ "\n\n"))
* [[Close it and return|NightArchiveBrowse]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}



:: NightShroudedWellArrival [NEXUS] {"position":"8650,700","size":"100,100"}
\:: NightShroudedWellArrival
Under the pale moon, the Shrouuded Well exhales silvery mist. Moss‑clad stones glimmer, and tiny runes catch the lantern light.  
What do you do?  
* [[Peer over the edge|NightWellStupidChoice]]  
* [[Call out into the depths|NightWellDefaultInteraction]]  
* (if: $job is 2)[[Hold your lantern aloft to reveal hidden shapes in the fog|NightWellLanternBearer]]  
* (if: $job is 3)[[Strike the rim with your hammer to test its resonance|NightWellOssuaryKnight]]  
* (if: $job is 4)[[Blend into shadows and circle the well silently|NightWellWhispered]]  
* (if: $job is 5)[[Study the runes with scholarly precision|NightWellPaleScholar]]  
* (if: $job is 6)[[Lean close and feel its necrotic pulse|NightWellExhumed]]  
* (if: $backStory is 7)[[Listen for the Worm’s whisper in the damp air|NightWellBS7Cultist]]  
* (if: $backStory is 8)[[Hum a burial hymn and see if the well responds|NightWellBS8Singer]]  
* [[Return to the square|NightVelthornHollowOrientation]]





:: NightTunnelEntrance [NEXUS] {"position":"4925,2475","size":"200,200"}
You descend the hidden stair from the well into a narrow, damp tunnel. The lantern light shudders over slick stone walls, and you hear distant drips and distant echoes. Somewhere ahead, three paths beckon in the dark: each promising secrets or peril.  
* [[Follow the dripping water sound|TunnelFollowDrips]]  
* [[Track the faint ragged breathing|TunnelFollowBreath]]  
* [[Trace the glowing rune fragments on the walls|TunnelFollowRunes]]  
* [[Climb back up to the well|NightShroudedWellArrival]]



:: NightVelthornHollowOrientation [NEXUS] {"position":"4200,2375","size":"200,200"}
\:: NightVelthornHollowOrientation
Night drapes Velthorn Hollow in obsidian velvet. Lanterns bleed golden pools of light; every shadow trembles with unseen movement. The worn mural’s loops glow faintly in the moonlight, a silent invitation to those who remember.  

* [[NightShroudedWellArrival|NightShroudedWellArrival]]  
* [[NightRottedMarketStallsArrival|NightRottedMarketStallsArrival]]  
* [[NightWidowMarrowTeaHouseArrival|NightWidowMarrowTeaHouseArrival]]  
* [[NightWeepingLanternArchArrival|NightWeepingLanternArchArrival]]  
* [[NightBoneStackedShrineArrival|NightBoneStackedShrineArrival]]  
* [[NightCrackedReflectionPoolArrival|NightCrackedReflectionPoolArrival]]  
* [[NightHalfBuriedBellTowerArrival|NightHalfBuriedBellTowerArrival]]  
* [[NightWheelwrightWorkshopArrival|NightWheelwrightWorkshopArrival]]  
* [[NightMourningOakInnArrival|NightMourningOakInnArrival]]  
* [[NightForgottenGraveyardGateArrival|NightForgottenGraveyardGateArrival]]  

Choose your path: and remember, by night you may see things you cannot unsee.




:: NightWLAGratePassage {"position":"7725,425","size":"100,100"}
\:: NightWLAGratePassage
Under the shifted grate is a narrow stair descending into darkness. A damp draft drips down the steps.  
* [[Descend the stair|NightTunnelEntrance]]  
* [[Replace the grate and step back|NightWeepingLanternArchArrival]]


:: NightWLAPaleScholarEcho {"position":"8025,275","size":"100,100"}
\:: NightWLAPaleScholarEcho
You study the phrasing as a Pale Scholar. In the interlocking letters you discern half of a quenching–ward formula: “Blood bind flame, heart hush tears.” Memorizing it, you realize this spell could calm a guardian’s rage.  
(set: $inventory to it + “Half‑Formula Scroll”)  
* [[Tuck the formula away|NightWeepingLanternArchArrival]]


:: NightWLATalkWatcher {"position":"7550,300","size":"100,100"}
\:: NightWLATalkWatcher
You cross the street and kneel beside the hooded figure. In a voice like rustling silk, he murmurs, “When the tears cease, the shrine awakens.” He bows, then fades into the mist, leaving the silver bowl to clatter quietly on the stones.  
(set: $journal to it + (a: "A hooded figure told me: “When the tears cease, the shrine awakens.” "+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Return to the arch|NightWeepingLanternArchArrival]]


:: NightWLATraceInscription {"position":"7850,300","size":"100,100"}
\:: NightWLATraceInscription
You kneel beneath the weeping lantern and trace the words “Only the heart can still the tears.” The carving shudders under your fingertip: and for a heartbeat the lantern’s tears stop falling, then resume in a heavy, measured rhythm. A hidden grate at the arch’s foot shifts as though inviting you in.  
* [[Prise up the grate|NightWLAGratePassage]]  
* [[Step back|NightWeepingLanternArchArrival]]


:: NightWMTHBS4ExiledLantern {"position":"6825,1000","size":"100,100"}
\:: NightWMTHBS4ExiledLantern
Flashing your Lantern Tender’s badge, you slip behind the counter. You discover a hidden ledger of smuggled scriptures: each entry signed in Corvan’s own hand.  
(set: $inventory to it + “Corvan’s Smuggled Grimoire Page”)  
* [[Pocket the page and exit|NightWidowMarrowTeaHouseArrival]]


:: NightWMTHHourglassFlash {"position":"6100,1150","size":"100,100"}
\:: NightWMTHHourglassFlash
You let a grain of black sand slip through your fingers. In that moment, your vision blurs and you witness Corvan’s final moments in his library: candlelight flickering across leather‑bound tomes, his fingers stained with ink as he scrawls a final mad incantation. Then the memory shatters, leaving only silence.  
(set: $journal to it + (a: "I had a vision of Corvan’s last library moments"+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Gasp and step back|NightWidowMarrowTeaHouseArrival]]



:: NightWMTHLanternTenderEcho {"position":"6550,1250","size":"100,100"}
\:: NightWMTHLanternTenderEcho
You raise your lantern; its warm glow reveals faint scratch marks on the floorboards behind the counter: exactly where forbidden texts were once smuggled out. A loose plank creaks underfoot.  
(set: $journal to it + “Discovered secret tunnel route”)  
* [[Pry up the plank and reveal a trapdoor|NightWMTHRevealTrapdoor]]  
* [[Lower your lantern and step back|NightWidowMarrowTeaHouseArrival]]


:: NightWMTHListenClock {"position":"6425,1250","size":"100,100"}
\:: NightWMTHListenClock
You focus on the cuckoo clock. At the next chime it cries out “Eloin”: a name you recognize from whispered lore as Corvan’s first apprentice. The clock’s hands spin once backward in eerie unison.  
(set: $journal to it + (a: "The name of Corvan's first apprentice was Eloin"+ "\n\n"))
* [[Step away, unsettled|NightWidowMarrowTeaHouseArrival]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}


:: NightWMTHOrderTea {"position":"6350,1100","size":"100,100"}
\:: NightWMTHOrderTea
You request Widow Marrow’s midnight blend. She pours steaming dark liquid into a cracked porcelain cup. The first sip brings a whisper of “Below the hearth,” as steam shapes the words in the air.  
(set: $journal to it + “Heard clue: below the hearth”)  
* [[Thank her and ponder the hint|NightWidowMarrowTeaHouseArrival]]


:: NightWMTHRevealTrapdoor {"position":"6800,1325","size":"100,100"}
\:: NightWMTHRevealTrapdoor
Beneath the loosened plank lies a trapdoor fitted with iron rings. Through its crack you see a stair spiraling into darkness.  
* [[Descend the trapdoor stair|NightTunnelEntrance]]  
* [[Close it and return|NightWidowMarrowTeaHouseArrival]]


:: NightWWWCultistEcho {"position":"9475,3350","size":"100,100"}
\:: NightWWWCultistEcho
As a Cultist of the Worm, you press your fingers into those carved veins. The statuette’s runes glow faintly, and you taste a whisper of forbidden knowledge in your mind.  
(set: $journal to it + (a: "I received Worm visions from statuette"+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Step back, unsettled|NightWheelwrightWorkshopArrival]]


:: NightWWWExamineStatuette {"position":"9025,3350","size":"100,100"}
\:: NightWWWExamineStatuette
You lift the statuette from its rack. The child’s form is exquisitely detailed; Corvan’s likeness in the face is eerie. Worm‑shaped veins curl along its limbs.  
In the back, some writing in a language you don't understand:"Le temps d'avant. L'innocence."
(set: $journal to it + (a: "I saw a Corvan‑child statuette with Worm‑shaped veins. It had some weird writings on it."+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Place it back gently|NightWheelwrightWorkshopArrival]]


:: NightWWWInquireSoulChariot {"position":"9225,3350","size":"100,100"}
\:: NightWWWInquireSoulChariot
**You:** “You mentioned a soul chariot for Corvan: what became of it?”  
**Craftsman:** “He commissioned it to carry souls through the Veil. I hid it when his ambitions turned… darker.”  
* [[Ask him to show you where it’s hidden|NightWWWRevealSoulChariot]]  
* [[Thank him and step away|NightWheelwrightWorkshopArrival]]


:: NightWWWRevealSoulChariot {"position":"9175,3550","size":"100,100"}
\:: NightWWWRevealSoulChariot
You try to convince the craftsman to show you the chariot... Let's see how that goes...
(click:"convince")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
    The craftsman lifts a loose floorboard. Beneath it lies a small, ornate bone‑and‑silver chariot, its wheels carved with runes that still pulse faintly.  
(set: $inventory to it + “Soul Chariot”)  
* [[Take the Soul Chariot|NightWheelwrightWorkshopArrival]]
    ]
(else:)
    [
    There is nothing you can say, it seems, to change his mind.
   * [[continue|NightWheelwrightWorkshopArrival]]
    ]

 ]
 ]



:: NightWWWSearchWorkshop {"position":"9350,3350","size":"100,100"}
\:: NightWWWSearchWorkshop
You scour every shelf and box. Behind a stack of bone wheels you find a hidden drawer containing a scroll titled **“Corvan’s Workshop Designs.”**  
(set: $inventory to it + “Corvan’s Designs Scroll”)  
* [[Tuck the scroll away|NightWheelwrightWorkshopArrival]]


:: NightWeepingLanternArchArrival [NEXUS] {"position":"7775,50","size":"100,100"}
\:: NightWeepingLanternArchArrival
Moonlight silver‑washes the Weeping Lantern Arch. Two rusted lanterns drip slow, crimson tears onto the cobblestones. Across the street, a hooded watcher counts each drop into a silver bowl with a solemn care. On the base of one lantern, you notice a faint carving: “Only the heart can still the tears.”  
What do you do?  
* [[Speak softly to the hooded watcher|NightWLATalkWatcher]]  
* [[Trace the faint carving on the lantern base|NightWLATraceInscription]]  
* (if: $job is 5)[[Decipher the ward formula hidden in the motto|NightWLAPaleScholarEcho]]  
* [[Return to the square|NightVelthornHollowOrientation]]











:: NightWellBS7Cultist {"position":"9325,1175","size":"100,100"}
\:: NightWellBS7Cultist
You whisper the Worm’s invocation. In the damp hush you hear: “Blood of the fallen grants passage.”  
(set: $journal to it + (a: "The Blood of the fallen grants passage.” "+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Draw your own blood on the rim|NightWellDrawBlood]]  
* [[Ignore the voice|NightShroudedWellArrival]]




:: NightWellBS8Singer {"position":"9425,1050","size":"100,100"}
\:: NightWellBS8Singer
You hum your burial hymn. The mist vibrates in harmony, and a submerged step surfaces at the well’s base.  
* [[Descend the step|NightTunnelEntrance]]  
* [[Stop humming|NightShroudedWellArrival]]


:: NightWellDefaultInteraction {"position":"9200,600","size":"100,100"}
\:: NightWellDefaultInteraction
You call into the well. Your voice echoes, then is swallowed. Moments later, a faint splash returns: too rhythmic to be random.  
* [[Drop a stone to gauge depth|NightWellWellDepth]]  
* [[Whisper a name and wait for an answer|NightWellWellNameCall]]


:: NightWellDrawBlood {"position":"9450,1350","size":"100,100"}
\:: NightWellDrawBlood
A drop of your blood falls onto the runes. The mist parts to reveal a narrow arch at the base.  
* [[Step into the arch|NightTunnelEntrance]]  
* [[Bandage your finger|NightShroudedWellArrival]]


:: NightWellExhumed {"position":"9200,1275","size":"100,100"}
\:: NightWellExhumed
The well’s necrotic pulse matches your own. You feel a surge of **Grave Hunger** stirring within.  
<!--(set: $status to it + “GraveHunger”)  -->
(click:"Grave Hunger")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
    * [[Rein in the hunger|NightShroudedWellArrival]]  
    ]
(else:)
    [
    * [[Succumb and reach in|NightWellExhumedReach]]
    ]

 ]
 ]




:: NightWellExhumedReach {"position":"9300,1425","size":"100,100"}
\:: NightWellExhumedReach
Driven by ravenous need, you plunge your hand into the mist. You grasp something cold and pulsing: then recoil as it snaps back.  
(set: $health to it - 2)  
* [[Stagger back|NightShroudedWellArrival]]


:: NightWellHiddenLatch {"position":"8975,1475","size":"100,100"}
\:: NightWellHiddenLatch
A secret panel swings open, revealing a coiled rope descending into darkness.  
* [[Climb down the rope|NightTunnelEntrance]]  
* [[Close it again|NightShroudedWellArrival]]


:: NightWellJournalHintFollow {"position":"8675,1150","size":"100,100"}
\:: NightWellJournalHintFollow
You notice a sunken flagstone at water level: a hidden stair leads down.  
* [[Prise up the stone and descend|NightTunnelEntrance]]  
* [[Step back|NightShroudedWellArrival]]


:: NightWellLanternBearer {"position":"8550,1000","size":"100,100"}
\:: NightWellLanternBearer
Your lantern’s flame pushes back the mist, revealing ghostly shapes swirling at the rim. One solidifies into a pale fisherman pointing downward: then vanishes.  
(set: $journal to it + (a: "A Fisherman’s spirit pointed down.” "+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Follow the silent hint|NightWellJournalHintFollow]]  
* [[Lower your lantern|NightShroudedWellArrival]]


:: NightWellOssuaryKnight {"position":"8825,1075","size":"100,100"}
\:: NightWellOssuaryKnight
You strike the rim with your sanctified hammer. The impact vibrates through the runes and dislodges a small **Bone Shard** from the stone.  
(set: $inventory to it + “Bone Shard”)  
* [[Pocket the shard|NightShroudedWellArrival]]


:: NightWellPaleScholar {"position":"9050,1325","size":"100,100"}
\:: NightWellPaleScholar
You trace the runes: “He who seeks the heart must look below.” Beneath the inscription, a hidden latch waits.  
* [[Pull the latch|NightWellHiddenLatch]]  
* [[Note the phrase and step back|NightShroudedWellArrival]]


:: NightWellStupidChoice {"position":"8950,575","size":"100,100"}
\:: NightWellStupidChoice
You lean too far: arms flailing: and nearly topple in! You catch yourself on a slick stone, heart pounding.  

(click:"heart pounding")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $luck >= $diceRoll)
    [
(set: $health to it - 1)  
* [[Regain balance and step back|NightShroudedWellArrival]]
    ]
(else:)
    [
The slick stone shifts beneath your grip and your fingers lose purchase. You plummet into the well’s depths, tumbling through frigid darkness. Each impact jars your bones until at last the cold water claims you: and the world goes silent.
    (set:$currentEnding to 30)
(display:"RestartDonnee")
{
<script>
setTimeout(() => {
  gainXp(600);
}, "1000");
</script>
}
    ]

 ]
 ]


:: NightWellWellDepth {"position":"9250,800","size":"100,100"}
\:: NightWellWellDepth
You drop a pebble: drip… drip… then a second splash, higher up. Something moves below.  
* [[Try again|NightWellDefaultInteraction]]  
* [[Step back: the well feels alive|NightShroudedWellArrival]]


:: NightWellWellNameCall {"position":"9375,650","size":"100,100"}
\:: NightWellWellNameCall
You whisper a name. A hollow voice returns it: one no living soul should know.  
* [[Demand “Who are you?”|NightWellWellWhoAreYou]]  
* [[Retreat in alarm|NightShroudedWellArrival]]


:: NightWellWellWhoAreYou {"position":"9425,825","size":"100,100"}
\:: NightWellWellWhoAreYou
“…Vale…” the well breathes your name. The runes flare faintly, as if inviting you closer.  
* [[Press your ear to the stone|NightWellDefaultInteraction]]  
* [[Step back to safety|NightShroudedWellArrival]]


:: NightWellWhispered {"position":"9025,1075","size":"100,100"}
\:: NightWellWhispered
You melt into the fog, circling the well’s edge. Soft footsteps lead you to a loose flagstone.  
* [[Prise up the slab|NightTunnelEntrance]]  
* [[Return to view|NightShroudedWellArrival]]


:: NightWheelwrightWorkshopArrival [NEXUS] {"position":"9225,3100","size":"100,100"}
\:: NightWheelwrightWorkshopArrival
The Wheelwright’s Workshop stands silent under the moonlight, its walls lined with bone‑rimmed wheels and half‑finished carvings. Among them, a half‑carved statuette catches your eye: its face unmistakably Corvan’s, but its body that of a child. The aged craftsman leans on his workbench, watching you with tired eyes.  
What do you do?  
* [[Examine the half‑carved statuette|NightWWWExamineStatuette]]  
* [[Ask about the “soul chariot” he once built|NightWWWInquireSoulChariot]]  
* [[Search the workshop for hidden compartments|NightWWWSearchWorkshop]]  
* (if: $job is 7)[[Touch the statuette’s worm‑etched veins|NightWWWCultistEcho]]  
* [[Return to the square|NightVelthornHollowOrientation]]













:: NightWidowMarrowTeaHouseArrival [NEXUS] {"position":"6450,825","size":"100,100"}
\:: NightWidowMarrowTeaHouseArrival
Moonlight filters through warped rafters as you slip into Widow Marrow’s Tea House at midnight. Steam curls in ghostly tendrils around low tables, and the cuckoo clock on the wall chirps at odd intervals: each time calling out a name, some familiar, some utterly foreign. Behind the counter, a broken hourglass drips black sand upward: each grain a memory slipping back into the world.  
What do you do?  
* [[Touch the black sand in the hourglass|NightWMTHHourglassFlash]]  
* [[Order a cup of her spectral brew|NightWMTHOrderTea]]  
* [[Listen to the cuckoo clock’s next name|NightWMTHListenClock]]  
* (if: $job is 2)[[Raise your lantern’s glow to reveal scratch marks on the floor|NightWMTHLanternTenderEcho]]  
* (if: $backStory is 4)[[Slip behind the counter to search for hidden texts|NightWMTHBS4ExiledLantern]]  
* [[Step back into the square|NightVelthornHollowOrientation]]















:: Notes {"position":"3675,4875","size":"100,100"}

If you want to know more about the Magister, you should talk to the old ... he knew Corvan...
Village Orientation to add


Another way to enter the place through a fight ?

LastPlace

Orientation visited

Citadel of Tales

Tired of getting your bony ass kicked by just about anybody ?
Our ... is top of the line. Only ... silver.

Do evil stuff

Exhumed
You recognize thise eyes : one of the guards, one of your torturer. 


Hello, stranger. Let me guess, you just arrived here ?

You are at the Velthorn Hollow's cemetery. 

Just don't apprach the ...big circle and you will be fine !

I am here for the first burial of ... But... You are not ..., are you ?

He turned himself into the most terrifying thing ever.
What ?
I know not... i don't have enough imagination

(a living child?)


:: OssuaryChapelArrival [NEXUS] {"position":"3450,9900","size":"100,100"}
\:: OssuaryChapelArrival
You step into the Ossuary Chapel, its walls built of interlocking thigh bones and vertebrae. Dried blood stains the stone altar, and the floor is scattered with bone‑shards glinting in torchlight. A hush of reverence hangs in the air.  
What do you do?  
* [[Kneel and pray at the altar|ChapelPray]]  
* [[Examine the bone caretaker statue|ChapelExamineStatue]]  
* [[Search for hidden levers among the bones|ChapelSearchBones]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 7)[  
  * [[Place your cult fetish upon the altar|ChapelCultistTrigger]]  
]

































:: OssuaryEchoesArrival [NEXUS] {"position":"325,6525","size":"100,100"}
\:: OssuaryEchoesArrival
You step into the domed Ossuary of Echoes. Mountains of bleached bones rise on every side, and at the center a fountain drips glowing ectoplasm into a shallow basin. Whispered voices swirl in the dripping mist.  
What do you do?  
* [[Sip from the ectoplasm fountain|EchoesSipEctoplasm]]  
* [[Shout to hear the echoes|EchoesShout]]  
* [[Examine the piled bones|EchoesExamineBones]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 3)[  
  * [[Hold your bone wand to the fountain’s edge|EchoesApprenticeTrigger]]  
]































:: ParamFight {"position":"1825,400","size":"100,100"}
  ##You fight for your life !
{    
<div id="combat-container">

        <div id="turn-indicator">YOUR TURN !</div>
        <div id="combat-log">Combat Started!</div>
        
          <div id="actions">
            <button class="action-button" data-action="attack">Attack</button>
            <button class="action-button" data-action="flee">Flee</button>
        </div>
        
       <div class="blockCombats">
        <div id="player" class="Combatscharacter">
            <div class="hp-text" id="player-hp-text">HP: $health/$maxHealth</div>
            <div class="hp-bar"><div class="hp-fill" id="player-hp" style="width:100%"></div></div>
            <img class="tailleImgCombats" src="https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Combats/PersoCombat.png" alt="Player">
        </div>

        <div id="enemy" class="Combatscharacter">
            <div class="hp-text" id="enemy-hp-text">HP: $ehp/$ehp</div>
            <div class="hp-bar"><div class="hp-fill" id="enemy-hp" style="width:100%"></div></div>
            <img class="tailleImgCombats" src="https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Combats/ParasiteCombat.png" alt="Enemy">
        </div>
    </div>
    
       <div class="dice-overlay">
            <div class="dice-container">
                <div class="die"><img class='cssde' id="die1" src="https://pickyouruniverse.com/DataProjects/2024/05/1.png"></div>
                <div class="die"><img class='cssde' id="die2" src="https://pickyouruniverse.com/DataProjects/2024/05/1.png"></div>
                <div class="die"><img class='cssde' id="die3" src="https://pickyouruniverse.com/DataProjects/2024/05/1.png"></div>
            </div>
        </div>
</div>}


  <script>
        const soundEffects = {
            attackHit: new Audio('https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/degats.wav'),
            attackMiss: new Audio('https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/AttackManque.wav'),
            enemyHit: new Audio('https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/degatsEnnemie.wav'),
            enemyMiss: new Audio('https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/EnemieAManque.wav'),
            victory: new Audio('https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/victoire.wav'),
            defeat: new Audio('https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/defaite.wav'),
             flee: new Audio('https://pickyouruniverse.com/DataProjects/General/BruitagesCombats/fuite.wav')
        };

function playSound(soundKey) {
    if (window.sfxEnabled && soundEffects[soundKey]) {
        soundEffects[soundKey].volume = window.sfxVolume || 0.5;
        soundEffects[soundKey].play().catch(err => console.log("Erreur lecture son:", err));
    }
}

        const state = {
			player: { hp: $health, maxHp: $maxHealth, attack: $strength,  armor: $totalArmor },
            enemy: { hp: $ehp, maxHp: $ehp, attack: $eStrength, defense: 3 },
            isPlayerTurn: true,
            diceOverlay: document.querySelector('.dice-overlay'),
            fled: false,
        };
console.log("💬 ARMURE DU JOUEUR :", $totalArmor);

        function updateTurnIndicator() {
            const indicator = document.getElementById('turn-indicator');
            indicator.textContent = state.isPlayerTurn ? "YOUR TURN !" : "ENEMY TURN !";
        }

        function initGame() {
            updateTurnIndicator();
            updateHpBars();
            document.querySelectorAll('.action-button').forEach(button => {
                button.addEventListener('click', () => {
                    if (state.isPlayerTurn) handleAction(button.dataset.action);
                });
            });
        }

        async function rollDice() {
            return new Promise(async resolve => {
                state.diceOverlay.style.display = 'flex';
                const diceElements = [document.getElementById('die1'), 
                                    document.getElementById('die2'), 
                                    document.getElementById('die3')];

                for (let i = 0; i < 10; i++) {
                    diceElements.forEach(die => {
                        die.src = `https://pickyouruniverse.com/DataProjects/General/Dé/${Math.floor(Math.random() * 6) + 1}.png`;
                    });
                    await new Promise(r => setTimeout(r, 50));
                }

                const finalRoll = [];
                for (let i = 0; i < 5; i++) {
                    finalRoll.length = 0;
                    diceElements.forEach(die => {
                        finalRoll.push(Math.floor(Math.random() * 6) + 1);
                        die.src = `https://pickyouruniverse.com/DataProjects/General/Dé/${finalRoll[finalRoll.length-1]}.png`;
                    });
                    await new Promise(r => setTimeout(r, 100 + i*50));
                }

                setTimeout(() => {
                    state.diceOverlay.style.display = 'none';
                    resolve(finalRoll.reduce((a, b) => a + b, 0));
                }, 1000);
            });
        }
function mettreAJourSante() {
    console.log("Mise à jour de la santé...");

    const playerHpBar = document.getElementById('player-hp');
    const enemyHpBar = document.getElementById('enemy-hp');
    const playerHpText = document.getElementById('player-hp-text');
    const enemyHpText = document.getElementById('enemy-hp-text');

    if (!playerHpBar || !enemyHpBar || !playerHpText || !enemyHpText) {
        console.error("❌ Erreur : Un élément HP est introuvable !");
        return;
    }

    // Mise à jour des barres de vie
    const playerHpPercentage = (state.player.hp / state.player.maxHp) * 100;
    const enemyHpPercentage = (state.enemy.hp / state.enemy.maxHp) * 100;
    playerHpBar.style.width = `${playerHpPercentage}%`;
    enemyHpBar.style.width = `${enemyHpPercentage}%`;

    // Mise à jour du texte HP
    playerHpText.textContent = `HP: ${state.player.hp}/${state.player.maxHp}`;
    enemyHpText.textContent = `HP: ${state.enemy.hp}/${state.enemy.maxHp}`;

    // Vérification et mise à jour de $health si c'est bien une variable globale Twine
    if (typeof $health !== 'undefined') {
        $health = state.player.hp;
        console.log(`Nouvelle valeur de $health : ${$health}`);
    } else {
        console.warn("⚠️ $health n'est pas défini dans Twine.");
    }
}

async function handleAction(action) {
            if (!state.isPlayerTurn) return;

            let message = '';
            
            
    if (action === 'attack') {
        let diceResult;
        if (window.$skillCheckEnableFight) {
            // Animation du dé avec rollDice()
            diceResult = await rollDice();
        } else {
            // Pas d'animation, résultat direct (par ex. un lancé aléatoire)
            diceResult = Math.floor(Math.random() * 6) + 1
                       + Math.floor(Math.random() * 6) + 1
                       + Math.floor(Math.random() * 6) + 1;
        }

        const hitScore = diceResult - state.enemy.defense;
        if ($strength >= hitScore) {
            const rawDamage = Math.floor(Math.sqrt(state.player.attack) + (diceResult / 3));
            const damage = Math.max(rawDamage - state.enemy.defense, 0);
            state.enemy.hp = Math.max(state.enemy.hp - damage, 0);
            message = `Attack successful! Roll: ${diceResult}, Damage dealt: ${damage}`;
            animateAttack(document.getElementById('player'), document.getElementById('enemy'), damage);
            playSound("attackHit");
        } else {
            message = `Your attack missed! Roll: ${diceResult}`;
            playSound("attackMiss");
        }
    } else if (action === 'flee') {
        let diceResult;
        if (window.$skillCheckEnableFight) {
            diceResult = await rollDice();
        } else {
            diceResult = Math.floor(Math.random() * 6) + 1
                       + Math.floor(Math.random() * 6) + 1
                       + Math.floor(Math.random() * 6) + 1;
        }
        
        if (diceResult >= $intelligence) {
            message = `Successful escape! (${diceResult}) !`;
            state.fled = true;
        } else {
            message = `Failed escape (${diceResult}) !`;
            playSound("attackMiss");
        }
    }

            updateCombatLog(message);
            updateHpBars();
            mettreAJourSante();
            if (checkGameOver()) return;
            
            if (state.enemy.hp > 0) {
                state.isPlayerTurn = false;
                updateTurnIndicator();
                setTimeout(enemyTurn, 1500);
            }
        }

async function enemyTurn() {
    let diceResult;
    if (window.$skillCheckEnableFight) {
        diceResult = await rollDice();
    } else {
        diceResult = Math.floor(Math.random() * 6) + 1
                   + Math.floor(Math.random() * 6) + 1
                   + Math.floor(Math.random() * 6) + 1;
    }

    let message = '';

    if ($eStrength >= diceResult) {
        const rawDamage = Math.floor(Math.sqrt(state.enemy.attack) + (diceResult / 3));
        const damage = Math.max(rawDamage - state.player.armor, 0);
        state.player.hp = Math.max(state.player.hp - damage, 0);
        message = `Enemy attacks (${diceResult}) for ${damage} damage!`;
        animateAttack(document.getElementById('enemy'), document.getElementById('player'), damage);
        playSound("enemyHit");
    } else {
        message = `Enemy attack (${diceResult}) misses!`;
        playSound("enemyMiss");
    }

    updateCombatLog(message);
    updateHpBars();
    mettreAJourSante();
    checkGameOver();
    state.isPlayerTurn = true;
    updateTurnIndicator();
}

          function animateAttack(attacker, target, amount) {
              attacker.classList.add(attacker.id === 'player' ? 'attack-move' : 'enemy-attack-move');
              target.classList.add('hit-flash');

              // Déterminer la couleur et la position
              const color = attacker.id === 'player' ? 'gold' : '#ff0000';
              const targetRect = target.getBoundingClientRect();
              const containerRect = document.getElementById('combat-container').getBoundingClientRect();

              showDamage(
                  targetRect.left - containerRect.left + target.offsetWidth/2,
                  targetRect.top - containerRect.top,
                  amount, 
                  color
              );
              
              function showDamage(x, y, amount, color) {
                    const damageElement = document.createElement('div');
                    damageElement.className = 'damage-popup';
                    damageElement.textContent = amount;
                    damageElement.style.color = color;
                    damageElement.style.position = 'absolute';
                    damageElement.style.left = `${x}px`;
                    damageElement.style.top = `${y}px`;
                    damageElement.style.fontSize = '24px';
                    damageElement.style.fontWeight = 'bold';
                    damageElement.style.textShadow = '2px 2px 2px rgba(0, 0, 0, 0.8)';
                    damageElement.style.animation = 'damageFloat 1s ease-out forwards';

                    document.getElementById('combat-container').appendChild(damageElement);

                    setTimeout(() => {
                        damageElement.remove();
                    }, 1000);
                }

              setTimeout(() => {
                  attacker.classList.remove('attack-move', 'enemy-attack-move');
                  target.classList.remove('hit-flash');
              }, 300);
          }
          
        function animateHeal(target, amount) {
            target.classList.add('hit-flash');
            showDamage(target, `+${amount}`, 'green');
            setTimeout(() => target.classList.remove('hit-flash'), 300);
        }

        function showDamage(target, amount, color) {
            const damageElement = document.createElement('div');
            damageElement.className = 'damage-number';
            damageElement.textContent = amount;
            damageElement.style.color = color;
            damageElement.style.left = `${target.offsetLeft + 75}px`;
            damageElement.style.top = `${target.offsetTop}px`;
            
            document.getElementById('combat-container').appendChild(damageElement);
            setTimeout(() => damageElement.remove(), 800);
        }

     function updateHpBars() {
    const playerHpPercentage = (state.player.hp / state.player.maxHp) * 100;
    const enemyHpPercentage = (state.enemy.hp / state.enemy.maxHp) * 100;

    document.getElementById('player-hp').style.width = `${playerHpPercentage}%`;
    document.getElementById('enemy-hp').style.width = `${enemyHpPercentage}%`;

    document.getElementById('player-hp-text').textContent = `HP: ${state.player.hp}/${state.player.maxHp}`;
    document.getElementById('enemy-hp-text').textContent = `HP: ${state.enemy.hp}/${state.enemy.maxHp}`;
    
    updateHealth(state.player.hp);
}

        function updateCombatLog(message) {
            document.getElementById('combat-log').textContent = message;
        }

function checkGameOver() {
    if (state.fled) {
        if (window.musiqueCombats) {
            window.musiqueCombats.pause();
            window.musiqueCombats.currentTime = 0;
        }
        playSound("flee");
        document.getElementById('fuite').style.display = 'flex';
        document.querySelectorAll('.action-button').forEach(button => {
            button.style.display = 'none';
        });
        return true;
    }

    if (state.enemy.hp <= 0) {
        updateCombatLog('Victoire !');
        if (window.musiqueCombats) {
            window.musiqueCombats.pause();
            window.musiqueCombats.currentTime = 0;
        }
        	playSound("victory");
        document.getElementById('victoryLink').style.display = 'flex';
        document.querySelectorAll('.action-button').forEach(button => {
                button.style.display = 'none';
            });
        return true;
    }
    if (state.player.hp <= 0) {
        updateCombatLog('Défaite...');
                if (window.musiqueCombats) {
            window.musiqueCombats.pause();
            window.musiqueCombats.currentTime = 0;
        }
        playSound("defeat");
        document.getElementById('defeatLink').style.display = 'flex';
         document.querySelectorAll('.action-button').forEach(button => {
                button.style.display = 'none';
            });
        return true;
    }
    return false;
}
        initGame();
        
(function observeHealthFromHUD() {
    const barText = document.getElementById("bar-text");
    if (!barText) return;

    let lockObserver = false;

    const observer = new MutationObserver(() => {
        if (lockObserver) return; 

        const [current, max] = barText.textContent.split('/').map(v => parseInt(v));
        if (!isNaN(current) && state.player) {
            state.player.hp = current;
            state.player.maxHp = max;

            lockObserver = true; 
            updateHpBars();     
            mettreAJourSante();  
            setTimeout(() => { lockObserver = false }, 50);
        }
    });

    observer.observe(barText, {
        childList: true,
        characterData: true,
        subtree: true
    });
})();

    </script>    
    
    
    <script>
    if (window.musiqueDeFond) {
      window.musiqueDeFond.pause();
      window.musiqueDeFond.currentTime = 0;
    }

    // Lancer la musique des crédits
    const musiqueCombats = new Audio("https://pickyouruniverse.com/DataProjects/General/SonEvenements/combats.mp3");
    musiqueCombats.loop = true;
    musiqueCombats.volume = 0.7;
    musiqueCombats.play().catch(err => console.log("Lecture bloquée par le navigateur", err));

    // Rendre la musique accessible globalement si besoin
    window.musiqueCombats = musiqueCombats;

document.querySelectorAll('.suite').forEach(btn => {
  btn.addEventListener('click', function () {
    if (window.musiqueCombats) {
      window.musiqueCombats.pause();
      window.musiqueCombats.currentTime = 0;
             window.musiqueDeFond.play();
    }
  });
});
  </script>


:: Passage sans titre {"position":"1950,2675","size":"100,100"}


7. Half‑Buried Bell Tower (HalfBuriedBellTowerArrival)
Where: In the description of the bronze plates.
What to add:

“Bell‑plate harmonies here match the mortar‑tuned chimes of the Reliquary of Frozen Hearts: an uncanny resonance suggesting a shared arcane source.”
Why:
Musical motif ties village bell tower to the Necropolis’s crystal hearts, hinting at common enchantments.

8. Wheelwright’s Workshop (WheelwrightWorkshopArrival)
Where: After revealing the half‑carved statuette.
What to add:

“Late at night, wheel rims creak like the rolling bones of the Ossuary Chapel below: some say the Worm’s faithful bring offerings through hidden tunnels.”
Why:
Creates a rumor that the Workshop’s bone wheels share subterranean tunnels with the Ossuary Chapel.

9. Mourning Oak Inn (MourningOakInnArrival)
Where: Where sap drips into mugs.
What to add:

“Patrons who sleep under the oak wake dreaming of marble corridors and glass‑cased hearts: visions unmistakably drawn from that frozen Reliquary beyond the Graveyard Gate.”
Why:
Connects the Inn’s sap‑drunk visions to the Reliquary of Frozen Hearts, so its magic carries over.

10. Forgotten Graveyard Gate (ForgottenGraveyardGateArrival)
Where: After “Corvan” carved on the fallen stone.
What to add:

“Beyond these bars lie the mortuary halls: the true Necropolis, where the Dieners groom the dead and the Brain Reliquary awaits in secret vaults.”
Why:
Explicitly names the Necropolis as the destination beyond the Gate, pulling village lore into focus.




:: Passage sans titre 1 {"position":"2500,150","size":"100,100"}
Ajouter images inventaire
$inventory
Ajouter illustrations

TheThreeBurials/imagejeux/Icons/Hat01.png
TheThreeBurials/imagejeux/Icons/Hat02.png
TheThreeBurials/imagejeux/Icons/Hat03.png
TheThreeBurials/imagejeux/Icons/boneEtchedDagger.png

    <div class="character-portrait"><img class="ImgCharacter" src= "https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Backstories/Mask.png"></div>

Donner de l'argent
(click:"argent")[
(set:$money to it +50)
 <script>
 updateHealth($health)
</script>
]

Faire baisser des points de vie
(click:"vie")[
(set:$health to it -2)
 <script>
 updateHealth($health)
</script>
]

Remettre à zéro
(click:"zéro")[
<script>
  localStorage.clear();
  sessionStorage.clear();
</script>
]


:: Passage sans titre 2 {"position":"3200,3575","size":"100,100"}
\:: CryptPitfallTrap
(Insert in any long corridor where you offer a “step forward” choice.)  
You step on a mosaic tile depicting a skull: only it gives way beneath your foot. The floor collapses into a spike-filled pit. You scream once before impaling your spine on jagged bone.

\:: CryptGasTrap
(Insert after “inspect sarcophagi” or similar lore-reading passage.)  
As you crouch to read the rune-carved sarcophagus, a hidden vent hisses, flooding the chamber with pale green gas. Your lungs seize in seconds; your vision blacks out in mid-breath.

\:: CryptCeilingSlab
(Insert when the player examines a loose flagstone.)  
You pry at a loose flagstone: and the entire ceiling groans. A slab the size of a tombstone crashes down, shattering your ribs like pottery.

\:: CryptAcidPool
(Insert when the player wades into a shallow pool of bone dust.)  
You slip into a concealed pool of bubbling ichor that sizzles your flesh. Your skin peels away in burning ribbons as your body collapses into the bubbling acid.

\:: CryptSpectralGrasp
(Insert when the player reaches out to touch a ghostly imprint or handprint.)  
You reach out to touch a phantom handprint: and ghostly arms erupt from the stone, lashing your throat until your vision fades into cold gray oblivion.

\:: CryptCoffinRackCollapse
(Insert if the player climbs onto a shelf of coffins.)  
You clamber onto a shelf of stone coffins: the weight shifts and the rack topples. You’re buried alive beneath a mountain of stone lids.

\:: CryptMirrorCurse
(Insert when the player picks up a shard of mirror.)  
You lift a gleaming glass shard: its edge cuts your palm and a red rune flares on your wrist. Within heartbeats, your veins blacken as cursed blood binds you to a deadly stillness.

\:: CryptRibGuillotine
(Insert under a low arch obstacle, when player “duck to pass”).  
You duck under a low bone arch: suddenly a hidden bone blade swings down, slicing you in two before you can scream.

\:: CryptSkullChalicePoison
(Insert when player drinks from a skull chalice).  
You lift the half-buried skull to drink its liquid: then agony strikes as venom floods your arteries. Your tongue swells, your throat constricts, and you choke in the poison’s grip.

\:: CryptDustQuicksand
(Insert when player steps into a patch of ash-like dust).  
You mistake fine ash for solid ground: your foot sinks, then you sink deeper until the dust clogs your nostrils and mouth. You suffocate in a granular tomb.

\:: CryptBoneSpear
(Insert when player tries to pry a decorative bone spear from the wall).  
You yank the spear: suddenly it twists to life and impales you through the shoulder. You stagger back, only to be skewered through the heart by its twin.

\:: CryptFlameBackdraft
(Insert when player lights a torch under a censer).  
You ignite the censer’s fumes: a backdraft roars through the chamber, engulfing you in a pillar of flame that sears you from head to toe.



:: PayForLight {"position":"3100,575","size":"100,100"}
(if: $money >= 1)[
  (set: $money to it - 1)
  **You:** “Anything you want, the silver, the body... just get me out of here!”
  **Brannon:** “Much obliged. Now hold still.”  
  He digs swiftly, lantern glowing, and you emerge.  
  * [[Step out, lantern-lit|MainQuest]]
]
(else:)
[
  **Brannon:** “No coin, ... no gigging for you, friend. I'll find somebody else to help me...” 
  * [[GameOverStarve]]
]


:: PayKnightFee {"position":"3275,625","size":"100,100"}
(if: $money >= 5)[
  (set: $money to it - 5)
  **Brannon:** “Ye’ve got coin. Let’s get on with it.”  
  He grunts and frees you.  
  * [[Rise amongst the dead|MainQuest]]
]
(else:)
[
  **Brannon:** “Not enough coin, pal. Back to your grave then. I will find somebody else to help me dig out ol'Corvan's body.”  
  * [[End: no rescue|GameOverStarve]]
]


:: PayKnightFeeHigh {"position":"3300,775","size":"100,100"}
(if: $money >= 8)[
  (set: $money to it - 8)
  **Brannon:** “Here’s your freedom. Next time, be nicer to folk.”  
  * [[Stand and salute|MainQuest]]
][
  **Brannon:** “You really don’t have eight? Then I’m done.”  
  * [[Left to your fate|GameOverStarve]]
]



:: PilgrimRestArrival [NEXUS] {"position":"2875,7150","size":"100,100"}
\:: PilgrimRestArrival
You step into Pilgrim’s Rest, a ruined oratory whose pews are stained with dried incense and blood‑red wax. The vaulted ceiling is cracked, and faded frescoes depict monks in endless prayer. A single beam of moonlight illuminates a cracked altar at the far end.  
What do you do?  
* [[Chant a prayer at the altar|PrayingPilgrimChant]]  
* [[Inspect the blood‑stained pews|PrayingPilgrimInspectPews]]  
* [[Examine the cracked altar stone|PrayingPilgrimInspectAltar]]  
* [[Search the floor for dropped prayer beads|PrayingPilgrimSearchBeads]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 11)[  
  * [[Sing the Hymn of Bleeding Bones|PrayingPilgrimHymnTrigger]]  
]






























:: Play a god {"position":"2850,1775","size":"100,100"}
(set: $job to 0)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**Brannon:** He recoils. "Oh, sir. I didn't recognize you. Let me help you out. "

As you leave your coffin, You try to move your perfectly preverved body to [[continue your conversation|MainQuest]].
]


:: Play as a Gravebinder {"position":"2975,325","size":"100,100"}
(set: $job to 1)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**You:** “I’m a Gravebinder.”  
**Brannon:** “A Gravebinder, eh? Keepers of the dead and all that. Respectable trade.”  
He cracks a smile. “And I suppose you want me to dig you out, right?
**You:** “That would be lovely.”
**Brannon:** “Diggin’s on the house for one of you... if you help me find his body of course....”  
**You:** “Anything you want, just get me out of here!”
**You:** “No way!"

(click:"get me out of here!")[
You emerge from the coffin [[with difficulty|MainQuest]]
(replace:"No way!")[no way.]
]
(click:"No way!")[The man walk away, [[desapointed|GameOverStarve]].]
]




:: Play as a Lantern Bearer {"position":"2950,575","size":"100,100"}
(set: $job to 2)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**You:** “I’m a Lantern Bearer.”  
**Brannon:** He scratches his chin. “Lantern Bearers… light folkin’ in the dark. I’ll get you out: just toss me a silver shard for the candles, and I will need your help to find his body of course....”  
* [[If you pay 1 silver shard and accept to find the body foor him|PayForLight]]  
* [[If you refuse to pay or to help him|RefuseToPay2]]
]


:: Play as a Pale Scholar {"position":"2800,1350","size":"100,100"}
(set: $job to 5)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**You:** “I’m a Pale Scholar.”  
**Brannon:** “Pale Scholar, eh? big words, empty purses.” He chuckles. “I’ll get you out: for a service and a lesson. 
**You:** “A service? I don't know how I can help you from down there?”  
**Brannon:** “Of course, I will dig you out and you will help me out to find the Magister's body."
**You:** “That seems reasonable, but what about the lesson then?".
**Brannon:** “Ye! The lesson... I have been wondering, you see... I’ve heard all kinds of tales about Magister Corvan: but no one agrees on the truth.”  
He leans on his shovel and clears his throat. “Open those big ears of yours, then tell me what you make of it.”

* [[Hear Brannon’s account|ScholarLore1]]
]



















:: Play as a Whispered {"position":"2950,875","size":"100,100"}
(set: $job to 4)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**You:** “I’m a Whispered.”  
**Brannon (from above):** “A Whispered, eh? Well I may need help of someone your kind to dig out the real Magister Corvan...
**You:** “Anything you want!”  
**Brannon (from above):** “Yes, yes, of course. You say that now that I got you buried here. But I don't trust your kind. Silent killers with secrets in every breath. Speak up: convince me you’re worth digging out.”  
He taps his shovel impatiently.  

What do you say?  
* [[Reveal a critical secret about Brannon’s past|WhisperedRevealSecret]]  
* [[Offer to clear his name of a rumor|WhisperedClearRumor]]  
* [[Ask a question that only a Whispered could know|WhisperedAskMystery]]  
* [[Offer coin instead|WhisperedPay]]  
]











:: Play as an Exhumed {"position":"2750,1575","size":"100,100"}
(set: $job to 6)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**You:** “I’m an Exhumed.”  
**Brannon:** He recoils. “Half-dead folk give me the creeps. I’ll help: for the **highest** bid... but you need first to agree to help me find Magister Corvan's body of course...Although I don't know if your help means much at all....”  
* [[Offer all your money and your help|ExhumedOfferAll]]  
* [[Threaten him until he digs anyway|ExhumedThreaten]]
]







:: Play as an Ossuary Knight {"position":"2950,725","size":"100,100"}
(set: $job to 3)
(if: $CorvanQuest is true)[
While you were piecing things together, the groundskeeper started to dig out the next grave, with no luck. You try to move your stiffened body to [[continue your conversation|MainQuest]].
]
(else:)[
**You:** “I’m an Ossuary Knight.”  
**Brannon:** “An Ossuary Knight, are ye? Heavy bones and all that. I don’t trust yer kind much…”  
He narrows his eyes. “That’ll be five silver shards: no exceptions... and I will need your help to find his body of course....”  
* [[Pay the five shards and agree to help him|PayKnightFee]]  
* [[Try to haggle|HaggleKnight]]
]


:: PlusieursObjets {"position":"850,250","size":"100,100"}
Plusieurs objets : 

<script>
  const newItems = [
    {
      id: "soin1",
      nom: "Healing Potion",
      type: "soin",
      life: 25,
      inventory: 24,
      src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Medkit.png",
      prix: 25,
      rare: "Common"
    },
    {
      id: "soin2",
      nom: "Healing Potion",
      type: "soin",
      life: 25,
      inventory: 23,
      src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Medkit.png",
      prix: 25,
      rare: "Common"
    }
  ];

  newItems.forEach((itemData) => {
    const itemElement = createItem(
      itemData.type,
      itemData.src,
      itemData.id,
      itemData.nom,
      itemData.strength,
      itemData.durability,
      itemData.life,
      itemData.armor,
      itemData.prix,
      itemData.rare,
      itemData.money
    );

    itemElement.setAttribute('data-id', itemData.id);
    itemElement.setAttribute('draggable', 'true');

    const targetSlot = document.getElementById(`slot-${itemData.inventory}`);
    if (targetSlot && targetSlot.childNodes.length === 0) {
      targetSlot.appendChild(itemElement);

      let inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory')) || Array(24).fill(null);
      inventoryGridData[itemData.inventory - 1] = {
        id: itemData.id,
        type: itemData.type,
        src: itemData.src,
        nom: itemData.nom,
        strength: itemData.strength,
        durability: itemData.durability,
        life: itemData.life,
        armor: itemData.armor,
        prix: itemData.prix,
        rare: itemData.rare,
        money: itemData.money,
      };
      localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));

      itemElement.addEventListener('mouseenter', (e) => showTooltip(e, itemElement));
      itemElement.addEventListener('touchstart', (e) => showTooltip(e, itemElement), { passive: false });
    }
  });
</script>


[[Admin]]


:: PrayingPilgrimAltarLift {"position":"2325,7400","size":"100,100"}
\:: PrayingPilgrimAltarLift
You lift the heavy slab. Beneath lies a spiral keyhole and a hidden lever carved with a bleeding hand.  
* [[Pull the lever|PrayingPilgrimRevealStairs]]  
* [[Close the slab|PilgrimRestArrival]]


:: PrayingPilgrimBoneTunnel {"position":"3075,7400","size":"100,100"}
\:: PrayingPilgrimBoneTunnel
You enter a narrow tunnel carved through bone‑laced stone. Faint blood‑red runes glow along the walls.  
* [[Follow the runes forward|PrayingPilgrimFollowRunes]]  
* [[Step carefully and listen|PrayingPilgrimListenDrips]]


:: PrayingPilgrimChant {"position":"2075,7275","size":"100,100"}
\:: PrayingPilgrimChant
You kneel and offer a broken prayer. The air shivers, and distant chanting answers yours in ghostly chorus: then falls silent, leaving only your echo.  
* [[Stand and reflect|PilgrimRestArrival]]


:: PrayingPilgrimDescendStairs {"position":"3075,7275","size":"100,100"}
\:: PrayingPilgrimDescendStairs
The spiral stairs wind down beneath the chapel. Each step is slick, and the walls pulse with lingering chants.  
* [[Press on into the darkness|PrayingPilgrimBoneTunnel]]  
* [[Climb back up for now|PilgrimRestArrival]]


:: PrayingPilgrimFollowRunes {"position":"3325,7275","size":"100,100"}
\:: PrayingPilgrimFollowRunes
The runes lead to a heavy iron door stamped with Corvan’s tri‑burial sigil and your monastery’s chalice emblem. A monastic keyhole awaits.  
* [[Use the Monastic Key|PrayingPilgrimUnlockVault]]  
* [[Hesitate before the door|PrayingPilgrimPrepare]]


:: PrayingPilgrimHymnTrigger {"position":"2575,7275","size":"100,100"}
\:: PrayingPilgrimHymnTrigger
You begin the Hymn of Bleeding Bones in your softest voice. The incense smoke swirls into shapes of kneeling monks, and the altar’s runes flare. The top of the altar lifts itself.  
* [[Approach the opened altar|PrayingPilgrimRevealStairs]]  
* [[Lower your voice|PilgrimRestArrival]]


:: PrayingPilgrimInspectAltar {"position":"2325,7275","size":"100,100"}
\:: PrayingPilgrimInspectAltar
The cracked altar bears chipped runes: “In blood we bind, in blood we break.” A hairline fissure suggests the top can be lifted.  
* [[Lift the altar slab|PrayingPilgrimAltarLift]]  
* [[Step away|PilgrimRestArrival]]


:: PrayingPilgrimInspectPews {"position":"2200,7275","size":"100,100"}
\:: PrayingPilgrimInspectPews
You run your hand along a pew’s surface. Beneath the wax you find a carved monastic emblem: a bleeding chalice: echoing the monastery’s lost ritual.  
* [[Trace the emblem|PrayingPilgrimTraceEmblem]]  
* [[Step back|PilgrimRestArrival]]


:: PrayingPilgrimListenDrips {"position":"3075,7525","size":"100,100"}
\:: PrayingPilgrimListenDrips
Drips of incense oil echo like distant chanting. Through the gloom you hear a steady pulse: ward magic humming behind the iron door.  
* [[Move toward the sound|PrayingPilgrimFollowRunes]]  
* [[Retreat to the stair|PrayingPilgrimDescendStairs]]



:: PrayingPilgrimPrepare {"position":"3387.5,7400","size":"100,100"}
\:: PrayingPilgrimPrepare
You steady your breathing and check your talismans. Beyond this door lies the Brain Reliquary’s hidden chamber.  
* [[Open the door|VaultEntrance]]  
* [[Step back for one last prayer|PilgrimRestArrival]]


:: PrayingPilgrimRevealStairs {"position":"2950,7275","size":"100,100"}
\:: PrayingPilgrimRevealStairs
The lever grinds stone aside, unveiling a narrow stair spiraling down, slick with dripping incense oil.  
* [[Descend the stair|PrayingPilgrimDescendStairs]]  
* [[Step back, wary|PilgrimRestArrival]]


:: PrayingPilgrimSearchBeads {"position":"2450,7275","size":"100,100"}
\:: PrayingPilgrimSearchBeads
You kneel and gather scattered prayer beads. One string glows with residual aura: and a final bead snaps off, revealing a hidden key carved with monastery runes.  
(set: $inventory to it + "Monastic Key")  
* [[Tuck it away|PilgrimRestArrival]]


:: PrayingPilgrimTraceEmblem {"position":"2200,7400","size":"100,100"}
\:: PrayingPilgrimTraceEmblem
As you trace the chalice, the pew trembles. A hidden panel in its side clicks open, revealing a small vial of **Monastery’s Tears**.  
(set: $inventory to it + "Monastery’s Tears")  
* [[Pocket the vial|PilgrimRestArrival]]


:: PrayingPilgrimUnlockVault {"position":"3262.5,7400","size":"100,100"}
\:: PrayingPilgrimUnlockVault
You insert the Monastic Key. The lock clicks, and the iron door swings open onto a torch‑lit corridor leading into Corvan’s sealed vault.  
* [[Step through into the vault entrance|VaultEntrance]]  
* [[Pause to ready yourself|CryptPrepare]]


:: RMSBS2Graverobber {"position":"1550,1475","size":"100,100"}
\:: RMSBS2Graverobber
You slip into the Bonepickers’ ranks, your reputation as a fellow graverobber granting you safe passage. A fence offers you a deal: trade a spare relic for an obscure map of the Silent Orders’ catacombs.  
(set: $inventory to it + “Crypt Map”)  
* [[Blend back into the crowd|RottedMarketStallsArrival]]


:: RMSBuyGoblet {"position":"925,1450","size":"100,100"}
\:: RMSBuyGoblet
(if: $gold >= 3)[
  (set: $gold to it - 3)
  You hand over three silver shards. The vendor’s voice hisses approval as the goblet joins your pack.
  (set: $inventory to it + “Spirit-Catcher Goblet”)
][else:[
  You don’t have enough shards. The goblet’s eye seems to mock your empty purse.
]]
* [[Step back from the stall|RottedMarketStallsArrival]]


:: RMSDefaultInteraction {"position":"1325,1625","size":"100,100"}
\:: RMSDefaultInteraction
You inspect the tables: a spider-eyed goblet here, a knucklebone dice set there. A faint voice whispers prices in your ear, though no one stands nearby. Browsing wares, you also notice something strange... 
* [[Examine the goblet more closely|RMSExamineGoblet]]  
* [[Pick up the bone dice|RMSPickUpDice]]  
* [[Move on: this place gives you the creeps|VelthornHollowOrientation]]

(click:"something strange...")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
    A rotting floorboard under a tarp: pried aside, it uncovers a rusted ring of iron that lifts to reveal a ladder down.
* [[Gather your courage and climb down|CryptEntry]]  
{
    <script>{
	setTimeout(() => {
 	 gainXp(50);
	}, "1000");
	</script>
	}
    ]
(else:)
    [
    Nope. There is nothing here so see... Probably just your imagination.
    ]

 ]



]


:: RMSExamineGoblet {"position":"1050,1650","size":"100,100"}
\:: RMSExamineGoblet
The goblet’s eye stares back at you, cold and unblinking. Etched runes swirl on its surface: rumor says it can catch a spirit’s last breath.  
* [[Buy the goblet for 3 shards|RMSBuyGoblet]]  
* [[Put it down and step away|RottedMarketStallsArrival]]


:: RMSLanternBearer {"position":"1450,1500","size":"100,100"}
\:: RMSLanternBearer
Holding your lantern high, its glow pushes back shadow. Hidden shelves creak free, revealing a vial of “bottled sighs” and flickering ghost-light candles.  
(set: $inventory to it + “Bottled Sigh”)  
* [[Thank the silent vendor and lower your lantern|RottedMarketStallsArrival]]


:: RMSPickUpDice {"position":"1200,1475","size":"100,100"}
\:: RMSPickUpDice
You pocket the knucklebone dice. They feel unnaturally warm… as if someone: or something: just rolled them.  
(set: $inventory to it + “Knucklebone Dice”)  
* [[Return to the stalls|RottedMarketStallsArrival]]


:: RMSStupidChoice [ENDING] {"position":"900,1250","size":"100,100"}
{
(set:$introText to "You bite into the dried meat. It wriggles unexpectedly: then stops.")
(set:$clickTest to "unexpectedly")
(set:$AttributeTest to $luck)
(set:$SuccessText to "You take a moment to compose yourself...")
(set:$FailureText to "  Your stomach churns and you stagger, nauseated. ")
(set:$clickDamage to "nauseated")
(set:$damageType to 1)
(set:$DeathText to "The moment the twisted fibers of the meat touch your tongue, a rancid heat blossoms in your gut. Your vision blurs as bile rises; a cold sweat coats your skin and your legs give out beneath you. Agony flares in every breath, and with a final heave, your world dissolves into darkness.")
(set:$currentEnding to 23)
(set:$LinkText to "Steady yourself and return to the stalls")
(set:$FailureLinkText to "Steady yourself and return to the stalls")
(set:$Link to "RottedMarketStallsArrival")

(set:$xpSuccess to 30)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:"MacroPassage")


:: RefuseToPay2 {"position":"3200,450","size":"100,100"}
\:: RefuseToPay2
**Brannon:** “Fine, fine… that’ll be two shards then. Can’t work for free.”  
* [[Pay begrudgingly (2 silver)|PayForLight]]  


:: ReplaceEnding [ENDING] {"position":"9075,8650","size":"100,100"}
You step onto the dais and draw the crown of bone and silver overhead. Power crackles through your veins: Corvan’s fragmented will merging with your own. The statues bow and the Court’s obelisk pulses once, then settles into silence.

When you awaken, you stand in the Mortuary Hall’s antechamber, now draped in bone-filigreed tapestries bearing your sigil. Your eyes glow faintly in the lantern light; a ghostly choir murmurs your name. You are no longer merely mortal but risen: the New Magister of Severance.


You claim Corvan’s crown of bone and shadow; power surges through every chamber and you rise as the New Magister.

(if: $job is 1)[  
  As a Gravebinder, your chains now command the dead: tombs tremble at your word, yet you bind them with compassion learned from the hearts you once healed.  
]  
(elseif: $job is 2)[  
  As a Bone-Singer, your song now shapes fleshless bones into guardians for your rule: each echo a testament to your artistry and authority.  
]  
(elseif: $job is 3)[  
  As a Spellwright, your mastery of runes now governs life and death: your new edicts etched in arcane script over every vault door.  
]  
(elseif: $job is 4)[  
  As a Lantern-Tender, your flame now lights the way for spirits you command: withered passages burn bright at your summon.  
]  
(elseif: $job is 5)[  
  As a Courtier, your diplomacy now rules the dead: you broker pacts between mourning families and restless shades.  
]  
(else:)[  
  As a Shadowstrider, you move unseen through halls of bone: no secret remains hidden from your new eyes.  
]

(if: $backStory is 1)[  
  Plagueborn no more, you wield the Red Fog Serum as your signature decree: any who fall ill under your reign find swift and thorough reprieve… or discipline.  
]  
(elseif: $backStory is 2)[  
  Graverobber’s Bastard now commands the crypts: your stolen keys unlock vaults at your whim, and even Corvan’s private chambers lie open.  
]  
(elseif: $backStory is 3)[  
  Apprentice turned Master of Death, your necromantic tomes rewrite themselves in your handwriting, proclaiming your doctrine to bones and spirits alike.  
]  
(elseif: $backStory is 4)[  
  Exile ends as your lantern now hangs in every chapel: each glow a reminder that your flame guides both living and dead.  
]  
(elseif: $backStory is 5)[  
  Scion reborn, your family crest now adorns every tombstone: your house reshaped by your grim stewardship.  
]  
(elseif: $backStory is 6)[  
  Severed last no more, your chains now bind oathbreakers: and your Severance Key demands tribute from every soul.  
]  
(elseif: $backStory is 7)[  
  Worm-cultist exalted, you spread the Worm’s blessing through the Necropolis, and even carrion blooms under your hand.  
]  
(elseif: $backStory is 8)[  
  Singer-turned-sovereign, your final dirge resounds at ceremonies: every funeral your court presides over echoes your reign.  
]  
(elseif: $backStory is 9)[  
  Veteran-general of bone and ash, your banners fly over every crypt: your orders cemented in the marrow of your followers.  
]  
(elseif: $backStory is 10)[  
  Orphan-ruler, your graffiti sigil now marks every gate: your rise from nameless urchin to Magister ignites hope in the downtrodden.  
]  
(elseif: $backStory is 11)[  
  Pilgrim-high priest, your bleeding hymn becomes the state liturgy: your tears sanctify every sacrifice.  
]  
(else:)[  
  Veil-returned, you bridge life and death: your rule extends beyond the Grave, uniting two realms under your sovereign hand.  
]

The village awakes to decree: all deaths here shall pass through your Mortuary Hall. Some hail you as savior: ferryman to the afterlife: while others murmur of a new tyranny born in bone. The Rotted Market thrives anew, trading in grave-goods and ritual wares. The Mourning Oak Inn trades tears for visions of the future, commanded by your word.

The Necropolis as Your Domain
You walk the Ossuary of Echoes free of wards and fear, commanding living statues to rebuild fractured corridors. The Ossuary Chapel becomes your shrine, where you teach the Severance Rite to worthy acolytes. The River of Forgotten Names flows no more; instead, your gate stands open for any who swear fealty, escaping death or forging new unlife.

A Kingdom of Bone and Blood
By replacing Corvan, you reshape the balance: death is harnessed, memories are currency, and your rule ensures the Necropolis’s dark majesty. Those who love you call the age the “Bone Dawn”: a time of power for those who walk its halls: while those who mourn freedom speak quietly of overthrow. Your legacy is not final peace, but a new order born from shattered souls.

(set:$currentEnding to 2)
(display:"RestartDonnee")

{
<script>
setTimeout(() => {
  gainXp(2000);
}, "1000");
</script>
}


:: RestartDonnee {"position":"2300,575","size":"100,100"}
<!--
The End...
of this adventure. Go back to the beginning
and choose again.

-->

This is the end of this journey, but the beginning of another one
(click:"another one")[(goto:"Start2")]
<b><center>You have reached ending $currentEnding/$endingNumbers</center></b>

<div class="character-info">
  <h2 class="character-title">''Enjoyed Your Adventure? Help Us Create More!''</h2>
  <div class="character-rangement">
   
    <div class="character-description">

Thank you for embarking on this journey with us. Crafting immersive, interactive stories like A Spaceship Accident and The Three Burials of Magister Corvan is a labor of love that involves countless hours of writing, designing, and coding.<br>

''Your support enables us to:''<br>
- Develop New Stories: Bring more diverse and engaging narratives to life.
- Enhance Game Features: Improve gameplay mechanics and user experience.
- Maintain Independence: Operate without relying on intrusive ads or external sponsorships.
- Reward Our Supporters: More of the lore (text, images and audio) I produce around the games. Exclusif Poll to choose the pitch of our next game, High resolution and Layered art files.<br>

By contributing via Patreon or Buy Me a Coffee, you become a vital part of our creative process. Every contribution, big or small, propels us forward.<br>

Join us in shaping the future of interactive storytelling.

(Click:"Patreon")[(gotoURL:"https://www.patreon.com/c/PickYourUniverse")]
(Click:"Buy Me a Coffee")[(gotoURL:"https://buymeacoffee.com/pickyouruniverse")]
</div>

{
<!-- EndingReset -->
<script>
  localStorage.clear();
  sessionStorage.clear();
</script>
}

<!--

(set:$currentEnding to 1)
(display:"RestartDonnee")
{
<script>
setTimeout(() => {
  gainXp(600);
}, "1000");
</script>
}
-->


:: RiverBankArrival {"position":"7375,6625","size":"100,100"}
{
<div class="image-container">
  <img class="image-base" src="https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Illustrations/RiverBankArrival.jpg" />
</div>
}
You stand beside a sluggish river of ink‑black water. Moss‑covered ruin stones mark a cobbled landing. A lone skiff made of bone drifts, tended by a silent ferryman in embalmer’s robes. Lantern‑blue light flickers along the prow.  
* [[Call out to the ferryman|RiverCall]]  
* [[Board the skiff in silence|RiverBoard]]


:: RiverBoard {"position":"7875,6450","size":"100,100"}
\:: RiverBoard
You step into the skiff. The ferryman pushes off. Lanterns along the shore wink out as you drift into the black current.  
* [[Sit and hold steady|RiverCrossing]]


:: RiverCall {"position":"7650,6600","size":"100,100"}
\:: RiverCall
**You:** “I need passage.”  
The ferryman’s hooded face does not shift. His rasped voice drifts:  
**Ferryman:** “Speak your true name, that I may guide you across.”  
* [[Speak your true name|RiverSpeakName]]  
* [[Hesitate|RiverHesitate]]


:: RiverCourt {"position":"6650,6375","size":"100,100"}
\:: FinalWake
Once again, you emerge from your slumber in another place, another time, maybe.
You cough against fetid air and realize you lie within the rib‑cage of some colossal beast: flesh still clings between rib bones like rotten curtains. Your lungs burn as you hack away at decomposing sinew.  
(set: $health to it - 1)  
The carcass groans, collapsing inward and pinning you. Darkness presses in.  
* [[Struggle free|FinalStruggle]]





























:: RiverCrossing {"position":"8075,6475","size":"100,100"}
\:: RiverCrossing
The boat glides between pillars carved with severed hearts and broken wills. Each lantern echoes a name you once lost: drifting souls that nod in blessing or lament.  
(set: $buff to it + “NamesBlessing”)  
* [[Disembark at the far shore|RiverDisembark]]


:: RiverDisembark {"position":"8200,6600","size":"100,100"}
\:: RiverDisembark
Mossy steps rise from the water’s edge. Ahead looms a grand hall carved from obsidian bone. Stained‑glass windows depict three vessels: a heart, a brain, and a shattered sigil. This is the Court of Severance.  
* [[Enter the Court’s threshold|CourtThreshold]]


:: RiverHesitate {"position":"7875,6800","size":"100,100"}
\:: RiverHesitate
Your throat tightens. The ferryman’s form fades into shadow.  
* [[Step forward and speak your name|RiverSpeakName]]  
* [[Retreat to the shore|RiverBankArrival]]


:: RiverSpeakName {"position":"8000,6625","size":"100,100"}
(if: $backStory is 1)[  
  **You (hoarse):** “I am the Plagueborn Refugee, once nameless in the Red Fog’s shadow.”  
](else-if: $backStory is 2)[  
  **You:** “I am the Graverobber’s Bastard: marked by moonlight and bone.”  
](else-if: $backStory is 3)[  
  **You:** “I am the Apprentice Necromancer, bound to the whispers of the dead.”  
](else-if: $backStory is 4)[  
  **You:** “I am the Exiled Lantern Tender, whose flame guides lost souls.”  
](else-if: $backStory is 5)[  
  **You:** “I am the Noble Scion of the Pale Court, heir to faded honors.”  
](else-if: $backStory is 6)[  
  **You:** “I am the Last of the Severed, returned from sacrificial chains.”  
](else-if: $backStory is 7)[  
  **You:** “I am the Cultist of the Worm, marrow‑marked and hungry for truth.”  
](else-if: $backStory is 8)[  
  **You:** “I am the Grave Singer, whose dirge unbinds the lost.”  
](else-if: $backStory is 9)[  
  **You:** “I am the Ashen War Veteran, tempered by fire and blood.”  
](else-if: $backStory is 10)[  
  **You:** “I am the Street Orphan of Greyglass, nameless yet unbroken.”  
](else-if: $backStory is 11)[  
  **You:** “I am the Pilgrim of the Bleeding Monastery, cloaked in prayer and sacrifice.”  
](else-if: $backStory is 12)[  
  **You:** “I am the Returned from the Veil, bearer of the ghostly pulse.”  
]  
The ferryman inclines. Lanterns flare, and the skiff drifts from the landing with a soft creak.  
* [[Climb aboard|RiverBoard]]


:: Roll1D {"position":"1700,525","size":"100,100"}
{
(set: $counter to 10)
(live: 0.2s)[

(set: $diceRoll1 to (random: 1,6))
(set: $diceRoll1Link to "<img class='cssde' src='https://pickyouruniverse.com/DataProjects/General/Dé/" + (str: $diceRoll1) + ".png'>")

 <table style="    display: flex;width: 100%; justify-content: center;">
 	<tr>
      <td>$diceRoll1Link</td>
    </tr>
   </table>



	(set: $counter to it - 1)
	(if: $counter is 0)
    [(stop:) (set:$diceRoll to (str:$diceRoll1))The result is $diceRoll
    (set:$diceRoll to (num:$diceRoll))
    ]
]
}


:: Roll2D {"position":"1700,650","size":"100,100"}
{
(set: $counter to 10)
(live: 0.2s)[

(set: $diceRoll1 to (random: 1,6))
(set: $diceRoll1Link to "<img class='cssde' src='https://pickyouruniverse.com/DataProjects/General/Dé/" + (str: $diceRoll1) + ".png'>")

(set: $diceRoll2 to (random: 1,6))
(set: $diceRoll2Link to "<img class='cssde' src='https://pickyouruniverse.com/DataProjects/General/Dé/" + (str: $diceRoll2) + ".png'>")

 <table style="    display: flex;width: 100%; justify-content: center;">
 	<tr>
      <td>$diceRoll1Link</td>
      <td>$diceRoll2Link</td>
    </tr>
   </table>



	(set: $counter to it - 1)
	(if: $counter is 0)
    [(stop:) (set:$diceRoll to (str:$diceRoll1+$diceRoll2))The result is $diceRoll
    (set:$diceRoll to (num:$diceRoll))
    ]
]
}


:: RottedLibraryArrival [NEXUS] {"position":"950,9625","size":"100,100"}
\:: RottedLibraryArrival
You step into the Rotted Library, where mold‑eaten shelves sag under the weight of charred tomes. The floor is slick with spilled ink and ashes, and the air smells of burnt parchment and damp paper. Flickering lanterns cast trembling shadows on cracked spines.  
What do you do?  
* [[Read aloud a random page|LibraryReadPage]]  
* [[Search the shelves for intact volumes|LibrarySearchShelves]]  
* [[Inspect the lectern’s bleeding manuscript|LibraryInspectManuscript]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 9)[  
  * [[Examine the charred page stamped with your unit’s emblem|LibraryVeteranTrigger]]  
]



:: RottedMarketStallsArrival [NEXUS] {"position":"1300,1250","size":"100,100"}
\:: RottedMarketStallsArrival
You slip into the once-bustling bazaar, now half-collapsed stalls draped in tattered tarps. Dried herbs hang limp, cracked pottery lies overturned, and bleached bone trinkets clatter in the breeze. Somewhere among the shadows, ghostly vendors haggle in hushed tones.
An anxious vendor whispers of ‘the blue lanterns down below’: how their glow has been seen pulsing through the cracks in the old crypt gate, as if beckoning new arrivals to the Necropolis.
What do you do?  
* [[Taste the suspicious jerky|RMSStupidChoice]]  
* [[Browse the wares|RMSDefaultInteraction]]  
* (if: $job is 2)[[Hold your lantern aloft to reveal hidden wares|RMSLanternBearer]]  
* (if: $backStory is 2)[[Blend in with the Bonepickers and seek a fence|RMSBS2Graverobber]]
Return to the [[village's entry|VelthornHollowOrientation]].



:: SanctumRetreat {"position":"2875,6375","size":"100,100"}
\:: VaultRetreat
You step back from the barrier, breathing hard. The corridor behind you feels safer: at least until you steel yourself for what lies beyond.  
* [[Approach the door again|VaultEntrance]]  
* [[Return to the Necropolis orientation|NecroOrientation]]


:: SanctumRevealMechanism {"position":"2675,6850","size":"100,100"}
\:: SanctumRevealMechanism
Your fingers follow the groove to a nearly invisible lever beneath the dais. Pulling it, the crystalline floor panels shift, revealing Corvan’s ritual knife embedded in bone.  
(set: $inventory to it + “Ritual Knife”)  
* [[Draw the knife and return|SanctumSearch]]  


:: SanctumSearch {"position":"2950,6000","size":"100,100"}
\:: SanctumSearch
You circle the inner sanctum, eyes peeled for hidden panels or ritual implements. Flickering sconces reveal scorch marks on the floor and a shallow groove etched into the dais: a clue to a secret mechanism.  
* [[Trace the groove on the dais|SanctumRevealMechanism]]  
* [[Step back to the center|InnerSanctumEntry]]



:: ScholarAnswerKnowledge {"position":"3875,1225","size":"100,100"}
\:: ScholarAnswerKnowledge
**You:** “His aim was to understand the soul, to advance mortal science.”  
**Brannon:** He scratches his chin. “A noble goal: but dangerous when pride fills the gap.”  
<!--(set: $quest to it + “Consider Corvan’s pride and the cost of knowledge.”)  -->
(set: $journal to it + (a: "Consider Corvan’s pride and the cost of knowledge."+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Brannon digs you out, thoughtful|MainQuest]]
**Brannon:** "Smart as they come. Out you go."


:: ScholarAnswerLove {"position":"3600,1425","size":"100,100"}
\:: ScholarAnswerLove
**You:** “He loved someone too much: bent death itself to bring them back.”  
**Brannon:** His eyes soften. “A tragic motive… but loss makes liars of us all. Keep your heart guarded.”  
<!--(set: $quest to it + “Remember love’s price.”)  -->
(set: $journal to it + (a: "Remember love’s price."+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Brannon lifts you free gently|MainQuest]]


:: ScholarAnswerOther {"position":"3625,1575","size":"100,100"}
\:: ScholarAnswerOther
**You:** “I honestly cannot say, not knowing more about him. Maybe he did it to unite life and death: end the cycle of sorrow for all. Maybe for love or power, or knowledge... or a bit of all of that... yes, probably.”  
**Brannon:** He frowns thoughtfully. “Uncertainty. I wasn't excepecting that from your kind. You seem more humble than I though. Good for you. A grand dream Magister Corvan had… or a fool’s salvation. Mind you don’t drown in your own hopes.”  
<!--(set: $quest to it + “Contemplate death’s cycle.”) --> 
(set: $journal to it + (a: "Contemplate death’s cycle."+ "\n\n"))
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
* [[Brannon finishes the grave and you emerge|MainQuest]]


:: ScholarAnswerPower {"position":"3600,1300","size":"100,100"}
\:: ScholarAnswerPower
**You:** “It was vanity: he wanted to shape his own fate as a god.”  
**Brannon:** He laughs bitterly. “That ambition doom’d him all the same. Watch your own hubris, scholar.”  
(set: $quest to it + “Beware the lure of power.”)  
* [[Brannon frees you solemnly|MainQuest]]


:: ScholarLore1 {"position":"2975,1375","size":"100,100"}
\:: ScholarLore1
**Brannon:** “First: Corvan himself claimed he sought to separate soul from flesh: to remove the rot of mortality. Said he would study the pure soul.”  
* [[Ask for the other version|ScholarLore2]]  
* [[Offer your opinion now|ScholarOpinion1]]


:: ScholarLore2 {"position":"3125,1375","size":"100,100"}
\:: ScholarLore2
**Brannon:** “Others whispered he wanted to cheat death: build himself a god’s body. They said the Severance was vanity, not science.”  
* [[Ask for more nuance|ScholarLore3]]  
* [[Offer your opinion now|ScholarOpinion1]]


:: ScholarLore3 {"position":"3300,1400","size":"100,100"}
\:: ScholarLore3
**Brannon:** “And some say he did it out of love: wanted to save his wife from the grave, so he split his soul to tether her spirit back.”  
* [[Offer your opinion now|ScholarOpinion1]]


:: ScholarOpinion1 {"position":"3450,1400","size":"100,100"}
\:: ScholarOpinion1
Brannon folds his arms. “So, scholar, you’ve heard Corvan’s own words, the whispers of ambition, and the tales of a broken heart. Tell me: why did he truly perform the Severance Ritual?”  
* [[“He sought pure knowledge, no more.”|ScholarAnswerKnowledge]]  
* [[“He craved godlike power for himself.”|ScholarAnswerPower]]  
* [[“He did it for love, to bring one back.”|ScholarAnswerLove]]  
* [[“Some other reason.”|ScholarAnswerOther]]


:: ShrineAttemptOpen {"position":"475,1100","size":"100,100"}
\:: ShrineAttemptOpen
You lift the lid. Inside, a tarnished silver trinket glints: then the box shudders.  
* [[Grab the trinket and hold tight|ShrineToxicBlast]]  
* [[Drop it and leap away|ShrineEvade]]


:: ShrineEvade {"position":"625,950","size":"100,100"}
\:: ShrineEvade
You hurl the trinket aside and dive clear just as the box erupts. The toxic cloud billows past your cloak. You cough once, but your lungs burn instead of seize.  
* [[Catch your breath and step back|BoneStackedShrineArrival]]


:: ShrineToxicBlast {"position":"625,1100","size":"100,100"}
{
(set:$shrineTreasure to false)
(set:$introText to "The box snaps shut with a pop, unleashing a cloud of sickly green gas. Whispers crackle in your ears: laughter and curses woven together. You choke as the fumes fill your lungs. ")
(set:$clickTest to "your lungs")
(set:$AttributeTest to $strength)
(set:$SuccessText to "You grit your teeth and force deep breaths. The poison’s grip loosens; your cough fades to a rasp. Though weakened, you rise on shaking legs, determined to press onward. ")
(set:$FailureText to "Your vision swims. Your throat tightens, and your head pounds in time with distant mocking laughter.  ")
(set:$clickDamage to "mocking laughter")
(set:$damageType to 2)
(set:$DeathText to "Your knees buckle. The laughter echoes as your sight darkens. You gasp once: then the world slips away.")
(set:$currentEnding to 25)
(set:$LinkText to "Steady yourself and return.")
(set:$FailureLinkText to "Gasp for breath and Press on despite the terrible cough")
(set:$Link to "BoneStackedShrineArrival")
|BoneStackedShrineArrival
(set:$xpSuccess to 24)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:"MacroPassage")


:: ShroudedWellArrival [NEXUS] {"position":"300,1525","size":"100,100"}

You step into the village square and find yourself before the **Shrouded Well**: a moss-clad stone rim wreathed in pale mist that seeps from its depths. Cold air drifts upward, carrying distant whispers you can’t quite make out.  
At the very rim, you spot a chipped bone fragment wedged in a crack: its surface etched with miniature tomb‑house silhouettes. This same design appears in the mortuary halls beyond the Graveyard Gate.
What do you do?  
* [[Peer over the edge|WellStupidChoice]]  
* [[Call out into the well|WellDefaultInteraction]]  
* (if: $job is 1)[[Listen for names in the mist|WellJobGravebinder]]  
* (if: $backStory is 1)[[Breathe through your plague mask and wade closer|WellBS1Plagueborn]]  
Return to the [[village's entry|VelthornHollowOrientation]].


:: SilentCryptArrival [NEXUS] {"position":"3050,8875","size":"100,100"}
\:: SilentCryptArrival
You step into the Silent Crypt, a windowless chamber where icy air clings to the stone. Muffles moans hum behind rusted iron bars set into the south wall. Candles in cracked sconces sputter with cold blue flames.  
What do you do?  
* [[Peer through the bars at the source of the moans|CryptPeerMoans]]  
* [[Light a candle from your own lantern|CryptLightCandle]]  
* [[Inspect the frosted floor tiles|CryptInspectTiles]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 6)[  
  * [[Trace your scar over the rune‑sealed bars|CryptSeveredTrigger]]  
]



































:: Start1 {"position":"2200,1000","size":"200,200"}
{(display:"stats")


<div id="soundPrompt" style="position: fixed; top: 20px; right: 20px; background: #fcd34d; padding: 10px; border-radius: 5px; z-index: 1000;">
  <button id="activateSound" style="background: transparent; border: none; color: black; font-size: 16px; cursor: pointer;">Activate music</button>
</div>

<center><h2>The Three Burials of Magister Corvan</h2></center>

<div class="image-container">
  <img class="image-base" src="https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Illustrations/Cover.jpg" />
</div>

}

<center>[[Click here to start playing|Start2]]</center>


<script>
//Bouton Activer musique de partie
document.getElementById('activateSound').addEventListener('click', function() {
    // Vérifier si la musique de fond existe déjà
    if (!window.musiqueDeFond) {
        window.musiqueDeFond = new Audio("https://pickyouruniverse.com/DataProjects/TheThreeBurials/music/ThreeBurialsIntro.mp3");
        window.musiqueDeFond.loop = true;
        window.musiqueDeFond.volume = 0.5;
    }
    // Tente de jouer la musique
    window.musiqueDeFond.play().then(() => {
        console.log("Musique activée !");
        // Masquer le prompt une fois la musique lancée
        document.getElementById('soundPrompt').style.display = 'none';
    }).catch((error) => {
        console.log("Erreur lors de l'activation du son :", error);
    });
});

(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem("characterUnlocked") === "true";
        const characterButton = document.querySelector('.nav-btn[data-panel="skills"]');
        const elementsToHide = document.querySelectorAll('.top-nav, .xp-container, .inventory-sidebar');

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove("disabled-btn");
                characterButton.disabled = false;
            } else {
                characterButton.classList.add("disabled-btn");
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el => {
            el.style.display = characterUnlocked ? "" : "none";
        });
    }

    // Met à jour l'état de l'UI à chaque changement de passage
    $(document).on(':passagerender', function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();

</script>
<script>
(function() {
  // ensure this only runs once
  if (window._postHeadersDone) return;
  window._postHeadersDone = true;

  // queue your “run last” logic
  setTimeout(function() {
  
    localStorage.clear();
  sessionStorage.clear();
 
  }, 0);
})();
</script>


:: Start2 {"position":"2500,1000","size":"100,100"}
(text-style:"blur")[On the darkest night...] your imagination sees the moon, a tree, the long rock you used to climb as a child...
<div class="image-container">
  <img class="image-base" src="https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Illustrations/001.jpg" />
</div>


<!--if visited once...-->
<!-- So you are back ! -->

 <script>
  const newItems = [
    {
        id: "ShockStick",
        nom: "ShockStickX98",
        type: "sword",
        strength: 5,
        durability: 35,
        class: "item-img",
        draggable: true,
        inventory: "1",
        src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/BatonElectrique.png",
        "prix": 120,
        "rare": "Common"
    },
    {
        id: "soin1",
        nom: "Health Pills",
        type: "soin",
        life: 10,
        class: "item-img",
        draggable: true,
        inventory: "2",
        src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Pills.png",
        "prix": 45,
        "rare": "Common"
    },
    {
        id: "soin1",
        nom: "Health Pills",
        type: "soin",
        life: -5,
        class: "item-img",
        draggable: true,
        inventory: "7",
        src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Pills.png",
        "prix": 25,
        "rare": "Common"
    },
    {
        id: "casque1",
        nom: "astronaut's helmet",
        type: "helmet",
        armor: 3,
        class: "item-img",
        draggable: true,
        inventory: "3",
        src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Casque.png",
        "prix": 90,
        "rare": "Common"
    },
    {
        id: "gloves1",
        nom: "Gloves",
        type: "gloves",
        armor: 1,
        class: "item-img",
        draggable: true,
        inventory: "4",
        src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Gloves.png",
        "prix": 60,
        "rare": "Common"
    }
  ];

  newItems.forEach((itemData) => {
    const itemElement = createItem(
      itemData.type,
      itemData.src,
      itemData.id,
      itemData.nom,
      itemData.strength,
      itemData.durability,
      itemData.life,
      itemData.armor,
      itemData.prix,
      itemData.rare,
      itemData.money
    );

    itemElement.setAttribute('data-id', itemData.id);
    itemElement.setAttribute('draggable', 'true');

    const targetSlot = document.getElementById(`slot-${itemData.inventory}`);
    if (targetSlot && targetSlot.childNodes.length === 0) {
      targetSlot.appendChild(itemElement);

      let inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory')) || Array(24).fill(null);
      inventoryGridData[itemData.inventory - 1] = {
        id: itemData.id,
        type: itemData.type,
        src: itemData.src,
        nom: itemData.nom,
        strength: itemData.strength,
        durability: itemData.durability,
        life: itemData.life,
        armor: itemData.armor,
        prix: itemData.prix,
        rare: itemData.rare,
        money: itemData.money,
      };
      localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));

      itemElement.addEventListener('mouseenter', (e) => showTooltip(e, itemElement));
      itemElement.addEventListener('touchstart', (e) => showTooltip(e, itemElement), { passive: false });
    }
  });
</script>

...But your blurry eyes see (text-style:"blur")[NOTHING].
You awaken from what seems to be a very long nap. Everything is still pitch black and you realise that you are not in your bed. You are lying on a wooden floor.
When you try to get up, you bump your head against an other plank of wood. 
Your hands move quickly, and you realize the attrocity of your situation.
You are.. buried. A bad way to start a new adventure, right ?
You scream, you hit the coffin that may become your world for the rest of eternity. The horrific scene lasts maybe a few seconds, maybe a minute or and hour, but then, when you hear something.

The earth above you shifts, and a gruff voice calls down through the lid’s cracks:  
**Groundskeeper:**"Oi, you in there! Groundskeeper Brannon ‘ere. I am here for your first unburial. So glad I finally found you! Hav' been looking for your bones for a century now! Everywhere I looked! With all those stupid dead people rising, never though I would find you! The guys at the stupid Necropolis will finally shut up! Hang in there, Magister Corvan, I'm coming to get you out! You are Corvan, right?"
<p>
- Wait a minute... I am not Magister Corvan! (say the truth)
- Of course I am! You took your sweet old time, you better hurry before I loose my patience! (Lie)

(click:"say the truth")[
What? But who [[the hell|Classes]] are you, then?
(replace:"Lie")[never mind]
]
(click:"Lie")[

(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
His grunt echoes. “Corvan, you say? Well… Right… I’ll get you out, m’lord.”  
He hums in satisfaction and begins prying the lid free: **for free of course, for you, Magister...**  
With a grunt, he heaves at the coffin lid.  
*The wood splinters… and he recoils with a yelp.*  
**Brannon:** “But… you’re bloody not him!”  

* [[Stammer an excuse|CorvanDeceptionExplain]]  
* [[Stay silent and hope he forgets|CorvanDeceptionSilent]]
(set:$fakeCorvan to true)
    ]
(else:)
    [
**Brannon (from above):** “Corvan? Don’t make me laugh. I can’t even see your face: just a pair of boots poking out of the dirt!”  
He pauses, shovel in hand, and the earth rumbles as he shifts his weight.  
**Brannon:** “If you’re truly the great Magister, speak plain: where’s your bone-white cloak? I’d know his gait from a mile off.”  
* [[Apologize and tell who you really are|Classes]]  
* [[Remain silent and face his wrath|GameOverStarve]]
    ]
]


]



:: StatueBastard {"position":"7900,7450","size":"100,100"}
\:: StatueBastard
The hook loosens in the statue’s hand, revealing the Rusted Crypt Key wrapped in bone-dust.  
(set: $inventory to it + “Rusted Crypt Key”)  
* [[Take it and step forward|TrueStatueSuccess]]


:: StatueCultist {"position":"9125,7425","size":"100,100"}
\:: StatueCultist
The worm coiling in the statue’s palm dissolves into a Fetish Worm you carry on your wrist.  
<!-- STRONGER -->
(set: $inventory to it + “Fetish Worm”)  
* [[Press on to the altar|TrueStatueSuccess]]


:: StatueLanternTender {"position":"8350,7425","size":"100,100"}
\:: StatueLanternTender
The lantern lights in your hand, its flame steady and bright. A secret alcove glows open.  
(set: $flags to it + “LanternPathOpen”)  
* [[Step inside|TrueStatueSuccess]]


:: StatueNecromancer {"position":"8100,7450","size":"100,100"}
\:: StatueNecromancer
The skull drifts down into your hand, whispering the layout of the hidden ossuary tunnels. A hidden door opens.  
(set: $flags to it + “UnlockedOssuaryPath”)  
* [[Proceed through the door|TrueStatueSuccess]]


:: StatueOrphan {"position":"9875,7425","size":"100,100"}
\:: StatueOrphan
The tiny shackles clatter to the ground, revealing the Greyglass Graffiti Fragment tucked in the floor tile.  
(set: $inventory to it + “Graffiti Fragment”)  
* [[Pick it up|TrueStatueSuccess]]


:: StatuePilgrim {"position":"10125,7425","size":"100,100"}
\:: StatuePilgrim
The chalice lifts itself and pours a drop of Monastery’s Tears into your hand.  
(set: $inventory to it + “Monastery’s Tears”)  
* [[Drink and press on|TrueStatueSuccess]]


:: StatueRefugee {"position":"7625,7450","size":"100,100"}
\:: StatueRefugee
The mask lifts itself from the statue’s face and offers you a small vial of scarlet mist: the Red Fog Serum.  
(set: $inventory to it + “Red Fog Serum”)  
* [[Accept and step forward|TrueStatueSuccess]]


:: StatueReturned {"position":"10375,7425","size":"100,100"}
\:: StatueReturned
The statue’s star-glimmering form whispers in your mind and leaves behind the Veil-Shard Key.  
(set: $inventory to it + “Veil-Shard Key”)  
* [[Take it and step forward|TrueStatueSuccess]]


:: StatueScion {"position":"8600,7425","size":"100,100"}
\:: StatueScion
The ice crown melts, revealing a frozen rune at your feet. You crack it with your heel.  
(set: $flags to it + “ScionRuneCracked”)  
* [[Proceed to the rune-lit stair|TrueStatueSuccess]]


:: StatueSevered {"position":"8850,7425","size":"100,100"}
\:: StatueSevered
The chains disappear, leaving behind the Severance Key glinting in the dais light.  
<!-- TRANSFORMING ???-->
(set: $inventory to it + “Severance Key”)  
* [[Pocket it and advance|TrueStatueSuccess]]


:: StatueSinger {"position":"9350,7425","size":"100,100"}
\:: StatueSinger
The bone flute drifts into your grasp, humming with power. A hidden panel slides open underfoot.  
<!-- STRONGER ? -->
(set: $inventory to it + “Bone Flute”)  
* [[Enter the panel|TrueStatueSuccess]]


:: StatueVeteran {"position":"9625,7425","size":"100,100"}
\:: StatueVeteran
The charred standard burns away, leaving a banner fragment you can bear.  
(set: $inventory to it + “Battalion Banner”)  
* [[Carry it and move forward|TrueStatueSuccess]]


:: StatueWrong1 [ENDING] {"position":"7725,7975","size":"100,100"}
\:: StatueWrong1
The blood-soaked mask glows red at your touch. A searing apparition of your past guilt floods your mind, burning you with regret.  
(click:"regret")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    (set: $health to it - 2)  
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:

A surge of necrotic energy erupts from the blood-soaked mask, and your lungs seize as pestilent vapors choke the life from you, collapsing you into an endless fevered dream.
(set:$currentEnding to 8)
(display:"RestartDonnee")
    ]

 ]
 ]



:: StatueWrong10 [ENDING] {"position":"10000,7825","size":"100,100"}
\:: StatueWrong10
The tiny shackled feet twitch and kick at your shins, sending shockwaves through your body.  

(click:"vision blurred by frost")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
Tiny shackles clamp your ankles and you stagger, blood pooling at your feet. The iron clasps tighten with each heartbeat until your legs give way and the darkness swallows you.
(set:$currentEnding to 17)
(display:"RestartDonnee")
    ]
    ]
    ]


:: StatueWrong11 [ENDING] {"position":"10250,7825","size":"100,100"}
\:: StatueWrong11
Blood wells from the chalice, splashing your face with holy ichor that burns like acid.  

(click:"vision blurred by frost")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
A droplet of holy ichor splashes into your eye, burning like acid. You stumble blind and disoriented, your screams swallowed by the monastic gloom.
(set:$currentEnding to 18)
(display:"RestartDonnee")
    ]
    ]
    ]


:: StatueWrong12 [ENDING] {"position":"10475,7825","size":"100,100"}
\:: StatueWrong12
A chill gasp of the Veil stuns you; your soul quivers on the brink of oblivion.  

(click:"vision blurred by frost")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
A cold gust from the star-glimmering statue freezes your soul. You shiver into nothingness as the Veil’s chill claim you, your final breath lost in the void.
(set:$currentEnding to 19)
(display:"RestartDonnee")
    ]
    ]
    ]


:: StatueWrong2 [ENDING] {"position":"7975,7975","size":"100,100"}
\:: StatueWrong2
The rusted hook clamps shut around your wrist: spectral chains lash at your soul. Pain sears through your bones.  

(click:"your bones")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    (set: $health to it - 1)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
The rusted hook snaps closed on your wrist and drags you screaming into a yawning pit, your bones crushed beneath the earth like shards of shattered hope.
(set:$currentEnding to 9)
(display:"RestartDonnee")
    ]

 ]
 ]



:: StatueWrong3 [ENDING] {"position":"8250,7950","size":"100,100"}
\:: StatueWrong3
The skull in the statue’s arms whispers your darkest secret and you reel in horror, a phantom hand clawing at your heart.  

(click:"your heart")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    (set: $health to it - 1)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
A spectral skull materializes, its hollow eyes burning with ancient malice, and its whisper fractures your mind: shreds of your sanity torn away as you slump into madness.
(set:$currentEnding to 10)
(display:"RestartDonnee")
    ]

 ]
 ]


:: StatueWrong4 [ENDING] {"position":"8500,7925","size":"100,100"}
\:: StatueWrong4
The lantern’s flame flares, scorching your face with cold fire. Ice shards pierce your flesh.  
(click:"your flesh")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
The lantern’s flame flares with unnatural cold, encasing your heart in ice. You clutch your chest, breath stolen, and the world goes silent under a frozen sky.
(set:$currentEnding to 11)
(display:"RestartDonnee")
    ]
    ]
    ]


:: StatueWrong5 [ENDING] {"position":"8725,7900","size":"100,100"}
\:: StatueWrong5
The crown of ice freezes your thoughts; you stagger, vision blurred by frost.  
 
(click:"vision blurred by frost")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
Shards of ice leap from the crown and pierce your temples. Your vision blurs in frost-stained darkness as you stagger and fall, your last gasp lost in the shards.
(set:$currentEnding to 12)
(display:"RestartDonnee")
    ]
    ]
    ]


:: StatueWrong6 [ENDING] {"position":"8975,7900","size":"100,100"}
\:: StatueWrong6
Chains erupt from the floor, wrapping your legs. You struggle, breath failing.  

(click:"vision blurred by frost")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
Ethereal chains erupt from the floor, wrapping tight around your limbs. You struggle futilely as cold steel squeezes the breath from your lungs, and the chamber echoes your final cry.
(set:$currentEnding to 13)
(display:"RestartDonnee")
    ]
    ]
    ]


:: StatueWrong7 [ENDING] {"position":"9250,7875","size":"100,100"}
\:: StatueWrong7
A writhing worm of shadow slithers across your arm, injecting venomous doubt into your veins.  

(click:"vision blurred by frost")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
A shadow-worm bursts from the statue’s palm and burrows under your skin. You collapse as its venom floods your veins, your last thoughts writhing in agony.
(set:$currentEnding to 14)
(display:"RestartDonnee")
    ]
    ]
    ]


:: StatueWrong8 [ENDING] {"position":"9500,7850","size":"100,100"}
\:: StatueWrong8
Your flute song turns to screams as phantom notes shatter your ears.  

(click:"vision blurred by frost")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
A dirge of shattering bone rings in your ears as the flute’s notes slice through your flesh. You crumple under the weight of broken melodies, every breath a crack in your resolve.
(set:$currentEnding to 15)
(display:"RestartDonnee")
    ]
    ]
    ]


:: StatueWrong9 [ENDING] {"position":"9750,7825","size":"100,100"}
\:: StatueWrong9
The standard burns your flesh with phantom embers. You cry out in pain.  

(click:"vision blurred by frost")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
    (set: $health to it - 2)
**Corvan’s Voice:** “Wrong path. Try another.”  
* [[Choose again|ChooseStatue]]
    ]
(else:)
    [
    Your misstep proves fatal:
Embers flare across the standard’s charred banner, igniting your flesh in ghost-fire. You writhe as the flames consume your hope, leaving only ash and silence.
(set:$currentEnding to 16)
(display:"RestartDonnee")
    ]
    ]
    ]


:: SuppressionObjet {"position":"850,375","size":"100,100"}
<script>
function removeItemFromInventory(itemId) {
    let inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory')) || Array(24).fill(null);
    let itemRemoved = false;

    inventoryGridData.forEach((item, index) => {
        if (item && item.id === itemId) {
            const slot = document.getElementById(`slot-${index + 1}`);
            if (slot) {
                const itemElement = slot.querySelector(`[data-id="${itemId}"]`);
                if (itemElement) {
                    itemElement.remove();
                }
            }
            inventoryGridData[index] = null;
            itemRemoved = true;
        }
    });

    localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));

}

removeItemFromInventory('casque1');
</script>

[[Admin]]


:: Test [test] {"position":"2500,25","size":"200,100"}



:: TheGroundsKeeper {"position":"1600,125","size":"100,100"}
groundskeeper, gravedigger, caretaker, and sexton. These individuals are responsible for tasks such as grave preparation, grounds maintenance, and providing support during burials and memorial services.

A sexton is an officer responsible for the maintenance of a church, congregation, or synagogue and its associated graveyard. In the context of cemeteries, a sexton manages the care and upkeep of the grounds, including the cutting and watering of grass, pruning trees and shrubs, and removing debris.
 They are also responsible for ensuring that burials are conducted smoothly and efficiently, managing burial records, and overseeing the legal and public record aspects of burials.


:: TrueStatueSuccess {"position":"9075,8325","size":"100,100"}
\:: TrueStatueSuccess
As you step forward, the statues’ eyes dim and the dais grooves fill with crackling light. Corvan’s final form materializes above the basin: a swirling mass of bone shards, bound by silver filaments.

**Corvan (echoing):** “Now choose your destiny…”  
* [[Bind his essence and mend the Veil|BindEnding]]  
* [[Claim his power as the new Magister|ReplaceEnding]]  
* [[Shatter the fragments and end his line|DestroyEnding]]


:: TunnelFollowBreath {"position":"2625,3675","size":"100,100"}
\:: TunnelFollowBreath
Your heart hammers as you track the ragged exhale. The corridor rises, and pale mist swirls at the end. There, a collapsed sarcophagus vents cold air: and a cavern beyond.  
* [[Climb onto the lid and peer inside|TunnelPeerSarcophagus]]  
* [[Creep around the sarcophagus toward the cavern|TunnelQuietCreep]]


:: TunnelFollowDrips {"position":"2350,3575","size":"100,100"}
\:: TunnelFollowDrips
You edge along the damp wall, counting each *drip* as it falls. The sound grows louder, and you round a bend into a vaulted alcove where a thin waterfall trickles from a crack above. Behind the waterfall, you glimpse a mossy stairway spiraling down.  
* [[Step through the water curtain and descend|InnerCryptEntrance]]  
* [[Test the ledge’s grip before you go further|TunnelTestLedge]]


:: TunnelFollowRunes {"position":"2875,3525","size":"100,100"}
\:: TunnelFollowRunes
You trace the glowing runes along the wall. Under your fingertip, they pulse in sequence: three interlocking loops that tingle with recognition.  
Somewhere in your memory flickers the same pattern: a triple-looped knot of bones and runes are identical to the ones you glimpsed at in the faded mural in the village square: the mark of Magister Corvan’s three burials.  
At the end of the rune-lit corridor, a panel slides open to reveal a narrow passage lit by a single, still-glowing torch.  
* [[Step into the torchlit passage|InnerCryptEntrance]]  
* [[Hesitate: magic this old can be dangerous|CryptEntry]]



:: TunnelPeerSarcophagus {"position":"2575,3900","size":"100,100"}
\:: TunnelPeerSarcophagus
You climb up and pry the heavy lid. Inside lies a skeletal form wearing Corvan’s ritual garb: and a sealed trapdoor under its ribcage.  
* [[Open the trapdoor and climb down|InnerCryptEntrance]]  
* [[Jump back in horror|CryptEntry]]


:: TunnelQuietCreep {"position":"2775,3900","size":"100,100"}
\:: TunnelQuietCreep
Silently, you skirt the sarcophagus. Ahead, the cavern’s stone floor is dotted with fresh footprints: and at its far end, a stone door carved with three burial urns beckons.  
* [[Approach the stone door|InnerCryptEntrance]]  
* [[Retreat: those footprints look too fresh|CryptEntry]]


:: TunnelTestLedge {"position":"2375,3875","size":"100,100"}
\:: TunnelTestLedge
You press your palm to the slick stone beside the falls: moss gives under your weight, and the rock shifts. A hidden sinkhole yawns at your feet!

<!--test: (DEX check, DC 12)-->

(click:"A hidden sinkhole yawns at your feet")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $strength >= $diceRoll)
    [
You plant your feet firmly, slow your breath, and the stone holds your weight. The ledge steadies, letting you inch forward along the slick wall.  
* [[Brace yourself and try to steady the ledge|TunnelFollowBreath]]
    ]
(else:)
    [
Your foot slips as you brace; the ledge crumbles. You tumble into darkness, forgotten by light and life. 
    (set:$currentEnding to 30)
(display:"RestartDonnee")
{
<script>
setTimeout(() => {
  gainXp(600);
}, "1000");
</script>
}
    ]

 ]
 ]




:: VELTHORN HOLLOW PLACES {"position":"4150,475","size":"100,100"}
1. The Shrouded Well
A moss-clad stone well at the village’s center. A perpetual gray mist seeps from its depths.

Atmosphere: Whispering echoes, damp stones, rolling fog that chills to the bone.

Key Interaction:

Gravebinder hears the names of lost souls drifting up: can bind one spirit to gain a temporary “Shade Chain.”

Plagueborn Refugee backstory: your mask filters noxious vapors and you can wade deeper safely, uncovering a hidden silver talisman.

Stupid choice: peer over the edge without a rope and risk tumbling in (−1 CON, but maybe find a glow-worm guide).

2. The Rotted Market Stalls
Once a bustling bazaar; now half-collapsed stalls draped in ragged tarps.

Atmosphere: Cracked pottery, dried herbs, the faint clink of bones traded like coins.

Key Interaction:

Lantern Bearer: your lantern’s glow coaxers out an invisible vendor: an inhuman figure who trades “bottled sighs” for gossip.

Graverobber’s Bastard: recognized on sight by the local Bonepickers; can bribe a fence for stolen relics (if you pass a DEX check).

Stupid choice: taste a suspicious dried meat jerky (“It’s… moving?”).

3. Widow Marrow’s Tea House
A crooked hut where an ageless crone brews teas that soothe: or provoke: spirits.

Atmosphere: Sweet steam, tinkling bells, low humming as tea infusions swirl with spectral shapes.

Key Interaction:

Pale Scholar: can trade arcane runes to Widow Marrow for a “Memory Draught” that reveals a buried clue.

Returned from the Veil: the tea resonates with your near-death state, granting a vision of Corvan’s first burial.

Stupid choice: add a pinch of “Ghost Pepper” spice and hallucinate for a passage or two.

4. The Weeping Lantern Arch
A pair of rusted lanterns frame the main road’s entrance; one weeps bloody tears.

Atmosphere: Flickering iron, trickles of sanguine liquid pooling on the cobbles.

Key Interaction:

Lantern Bearer: your own lantern speaks to the weeper, offering a bargain: exchange flame for phial of ectoplasm.

Exiled Lantern Tender backstory: you recognize the weeping pattern as your old order’s warning signal: decipher it to avoid a patrol.

Stupid choice: lick the lantern’s tears (“Spicy, but… enlightening?”).

5. The Bone-Stacked Shrine
A small stone altar piled high with skulls and femurs, half-sunken into reeds.

Atmosphere: Dry wind rattling bones, distant chanting that may: or may not: exist.

Key Interaction:

Ossuary Knight: can offer a prayer and gain a “Boneguard Blessing” (+1 to DEF vs. undead).

Ashen War Veteran: you recall fighting on this very ground and find a rusted helmet bearing your old unit’s insignia.

Stupid choice: attempt to balance a skull on your head for “intimidation practice” (CHA check or the skull falls off).

6. The Cracked Reflection Pool
A stagnant pool with a fractured obsidian mirror sunk beneath the surface.

Atmosphere: Glassy water, shards glinting below, half-heard sobs of trapped ghosts.

Key Interaction:

Whispered: use Ghost Step to slip behind the mirror and uncover a hidden alcove.

Street Orphan of Greyglass: the shard’s reflection shows your childhood home’s last moments: gain +1 to local lore checks.

Stupid choice: reach in barefoot and risk spectral frostbite.

7. The Half-Buried Bell Tower
A leaning stone spire whose bell lies submerged in root-tangled earth.

Atmosphere: Deep bronze hum when wind blows, birds nesting in broken windows.

Key Interaction:

Pale Scholar: decipher runes on the bell to silence it: calming a nearby wraith for an ally.

Pilgrim of the Bleeding Monastery: recite a prayer you learned in the Monastery; gain the Bell’s Echo (a 1-time ward).

Stupid choice: tug on the rope recklessly and risk the entire tower shaking loose.

8. Wheelwright’s Workshop
An old wheel shop now run by a one-armed craftsman who carves bone spokes.

Atmosphere: Sawdust, the metallic scent of smithing, half-finished wagon wheels resting on racks.

Key Interaction:

Gravebinder: trade your Chained Relic for a custom “Soulwheel” that grants one free re-bind in combat.

Cultist of the Worm: you spot worm-etched motifs: if you confess your past, he’ll reciprocate with a healing salve.

Stupid choice: spin a half-carved wheel and chase it down the street.

9. Mourning Oak Inn
A creaky tavern built around a massive dead oak; patrons drink under its skeletal branches.

Atmosphere: Low lantern light, mournful lute music, the oak’s branches dripping sap that glows faintly.

Key Interaction:

Exhumed: your uncanny presence earns free ale: but every sip inches you closer to frenzy (WIS save to avoid berserk).

Noble Scion: show your ring of authority to get a private room and overhear conspiratorial nobles.

Stupid choice: try to climb the oak’s branch to “get a better view”: fall risk.

10. The Forgotten Graveyard Gate
An iron arch marking an overgrown cemetery, its gate sealed by a massive bone key.

Atmosphere: Crumbling tombstones, moonlight filtering through knotted branches, crypt doors ajar.

Key Interaction:

Exhumed: your Grave Hunger flares: if you consume a fallen ghoul’s remains, you gain regeneration (but lose 1 CHA).

Grave Singer: sing the Grave Lullaby here to lull restless spirits, revealing hidden crypt entrances.

Stupid choice: knock on every tomb door as if expecting a guest.


:: VaultEntrance [NEXUS] {"position":"3025,5475","size":"200,200"}
\:: VaultEntrance
You stand before the massive stone door bearing Corvan’s tri‑burial sigil. Lantern‑blue light seeps through its edges, and behind it you feel the thrum of powerful ward magic: and the slow, steady heartbeat of a trapped intelligence.  
What do you do?  
* [[Push on the door|VaultPushDoor]]  
* [[Study the sigil’s runes|VaultStudySigil]]  
* [[Step back to gather yourself|VaultPrepare]]  
* [[Retreat to the Necropolis orientation|NecroOrientation]]



:: VaultFindKey {"position":"2550,6625","size":"100,100"}
\:: VaultFindKey
(if: $inventory contains “Rusted Crypt Key”)[  
  * [[Use the Rusted Crypt Key|VaultUseKey]]  
][else if: $inventory contains “Obsidian Ossuary Key”)[  
  * [[Use the Obsidian Ossuary Key|VaultUseKey]]  
][else if: $inventory contains “Bone Chapel Key”)[  
  * [[Use the Bone Chapel Key|VaultUseKey]]  
][else if: $inventory contains “Veil‑Shard Key”)[  
  * [[Use the Veil‑Shard Key|VaultUseKey]]  
][else:  
  * [[You have no key that fits|VaultNoKey]]  
]  
* [[Step back|VaultEntrance]]


:: VaultNoKey {"position":"2550,6750","size":"100,100"}
\:: VaultNoKey
None of your keys fit the hidden keyhole. The sigil’s glow dims.  
* [[Return to the door|VaultEntrance]]


:: VaultPrepare {"position":"2925,6225","size":"100,100"}
\:: VaultPrepare
You steady your lantern, check your gear, and adjust your stance. The final challenge awaits.  
* [[Open the door|VaultUseKey]]  
* [[Step back for one last breath|VaultEntrance]]
* Take some time to sit down and meditate
(click:"meditate")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
    You center yourself. Focus on your breathing. Calm.
    (set:$health to it +2)
 <script>
 updateHealth($health)
</script>
    ]
(else:)
    [
    You try to focus, but there is too much noise and threats around you and inside your own mind. Your imagination is too strong for that.
    ]

 ]
]


:: VaultPushDoor {"position":"2675,6225","size":"100,100"}
\:: VaultPushDoor
You throw your shoulder into the iron door. It groans but holds fast: ward magic flares at your touch, sending a shock through your arm.  
(health: DAMAGE 1)  
* [[Study the sigil’s runes more closely|VaultStudySigil]]  
* [[Retreat to gather yourself|VaultPrepare]]



:: VaultSigilTouch {"position":"2550,6500","size":"100,100"}
\:: VaultSigilTouch
Your touch hums in time with the heart’s pulse. A single loop glows: and a hidden keyhole appears.  
* [[Search your inventory for a fitting key|VaultFindKey]]  
* [[Withdraw and rethink|VaultEntrance]]


:: VaultStudySigil {"position":"2525,6350","size":"100,100"}
\:: VaultStudySigil
You trace the three interlocking loops. Each pulse matches a warded heartbeat within.  
* [[Press your palm to the sigil|VaultSigilTouch]]  
* [[Return to the door|VaultEntrance]]


:: VaultUseKey {"position":"2450,6000","size":"100,100"}
\:: VaultUseKey
You insert the key. The ward unbinds with a resonant click, and the door swings inward. A low moan echoes within.  
* [[Step through into the inner sanctum|InnerSanctumEntry]]  
* [[Pause to ready yourself|VaultPrepare]]


:: VelthornHollowEntry {"position":"3725,2075","size":"100,100"}
{<div class="image-container">
  <img class="image-base" src="https://pickyouruniverse.com/DataProjects/TheThreeBurials/imagejeux/Illustrations/VelthornHollowEntry.png" />
</div>}
You stand in front of Velthorn Hollow.
The place seems empty.
The village main entrance is... well, it exists, at least. The kind of village you can imagine had a golden age, but very long ago, and forgotten, and that will never happen ago, not in anybody's life time. Or their children.

On a crumbling wall beside the entrance, you spot a **faded mural**: three interlocking loops of bones and runes, half-worn away by time: but still unmistakable in its pattern.
Must be a real tourist trap!

After some reflection on how you got here - all the mistakes and regrets that form your shell of a personality - you finally step inside for some [[sight seeing...|VelthornHollowOrientation]]




:: VelthornHollowOrientation [NEXUS] {"position":"3200,2725","size":"200,200"}
Here we are ! And here are a list of all the wonderful things to discover in this wonderful village of Velthorn Hollow :

* [[The Shrouded Well|ShroudedWellArrival]]  
  A moss-covered stone rim stands at the center of the square, from which pale fog drifts like cold breath. Somewhere deep below, unseen whispers stir: dare you draw near its edge and listen?  

* [[The Rotted Market Stalls|RottedMarketStallsArrival]]  
  Half-collapsed wooden stalls sag beneath tattered tarps. Dried herbs, cracked pottery, and bleached bone trinkets lie scattered across rotting tables, while ghostly vendors haggle in hushed tones.  

* [[Widow Marrow’s Tea House|WidowMarrowTeaHouseArrival]]  
  A crooked hut with smoke-wreathed rafters and tinkling wind bells. Warm steam curls through the door, carrying the scent of strange herbs: and something faintly spectral hidden within each cup.  

* [[The Weeping Lantern Arch|WeepingLanternArchArrival]]  
  Two rusted lanterns frame the main road’s gate, their ironwork stained by slow, crimson tears. Under their glow, the cobblestones gleam wet, and the lanterns themselves seem to watch you pass.  

* [[The Bone-Stacked Shrine|BoneStackedShrineArrival]]  
  A small stone altar piled high with skulls, femurs, and knucklebones. Dry wind rattles the bones like chimes, and distant chanting seems to pulse from the very earth beneath your feet.  

* [[The Bone & Lantern Emporium|EmporiumArrival]]  
  A narrow shop hung with polished bone charms and glowing spectral lanterns, where a silver‑tongued merchant hawks curiosities both practical and arcane.

* [[The Cracked Reflection Pool|CrackedReflectionPoolArrival]]  
  A stagnant pool of black water mirrors a fractured obsidian slab beneath the surface. Ghostly sobs echo across the glassy mirror, where torn reflections shift at the edge of your vision.  

* [[The Half-Buried Bell Tower|HalfBuriedBellTowerArrival]]  
  An ancient spire leans precariously, its bell lodged deep in a tangle of roots. When the wind stirs, a low bronze hum vibrates through the tower: and through your bones.  

* [[Wheelwright’s Workshop|WheelwrightWorkshopArrival]]  
  Sawdust drifts in lantern light, and half-finished wagon wheels carved from bone rest on crooked racks. The one-armed craftsman inside hammers bone spokes with rhythmic precision.  

* [[Mourning Oak Inn|MourningOakInnArrival]]  
  Built around a great dead oak whose skeletal branches pierce the ceiling, the inn’s common room is lit by lanterns dripping luminous sap. Patrons drink somber ale beneath the oak’s hollow gaze.  

* [[The Forgotten Graveyard Gate|ForgottenGraveyardGateArrival]]  
  An iron archway entombs a rusted gate locked by a massive bone key. Overgrown tombstones lean in silent rows, and moonlight filters through gnarled branches to guide: or warn: every traveler.  
  
Or… [[Wait until night falls and see another side of Velthorn Hollow|NightVelthornHollowOrientation]]
<p>
Where will you venture first?  





:: WLABS4ExiledLantern {"position":"400,1400","size":"100,100"}
\:: WLABS4ExiledLantern
The pattern of tears matches the old warning signal of your forgotten order. You decipher it: “Beware the Bonepickers at dusk.” Armed with this knowledge, you avoid a hidden patrol.  
(set: $journal to it + (a: "Decoded weeping pattern: Beware Bonepickers"+ "\n\n"))  
* [[Proceed safely onward|WeepingLanternArchArrival]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}


:: WLADefaultInteraction {"position":"150,1400","size":"100,100"}
\:: WLADefaultInteraction
You slip under the arch without fanfare. The lanterns weep in mourning as you pass, and you sense they have marked your passage: something in the mist shifts to let you through.  
* [[Move on down the road|VelthornHollowOrientation]]


:: WLALanternBearer {"position":"275,1400","size":"100,100"}
\:: WLALanternBearer
Raising your lantern beside the arch, you merge its flame with the weeper’s glow. The dripping stops, and a vial materializes at the lantern’s base: a **Phial of Ectoplasm**.  
(set: $inventory to it + “Phial of Ectoplasm”)  

Offering your flame (WLALanternBearer), your lantern’s glow not only stops the tears but seems to reveal something else...

(click:"something else...")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
    There! It is faint but, the more you look at it... You get closer and.... there they are! Your sharp eyes didn't betray you : there are runes on the arch that point down a side-alley drain grate.
* [[Gather your courage and follow the path going down|CryptEntry]]  
* [[Return to the square|VelthornHollowOrientation]]
    ]
(else:)
    [
    No... that must have been a dream.
* [[Pocket the vial and step back|WeepingLanternArchArrival]]
* [[Return to the square|VelthornHollowOrientation]]
    ]
]
 ]






:: WLAStupidChoice [ENDING] {"position":"25,1400","size":"100,100"}
{
(set:$introText to "You lean forward and let a drop slide onto your tongue. It tastes like rust and grief.")
(set:$clickTest to "rust and grief")
(set:$AttributeTest to $luck)
(set:$SuccessText to "You manage to escape unarmed...")
(set:$FailureText to "You cough, blood-tinged, as the lantern’s lament echoes in your chest")
(set:$clickDamage to "chest")
(set:$damageType to 1)
(set:$DeathText to "A burning numbness sears through your veins, spreading from your tongue to your gut in a wave of agony. Your vision blurs; your knees buckle as a poisonous toxin courses through your body. The world tilts and darkens, and the lantern’s final lament fades on your lips as life seeps away.")
(set:$currentEnding to 21)
(set:$LinkText to "Step back and wipe your mouth")
(set:$FailureLinkText to "Pick yourself up, step back and wipe your mouth")
(set:$Link to "WeepingLanternArchArrival")

(set:$xpSuccess to 30)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:"MacroPassage")



:: WMTHBS8GraveSinger {"position":"450,2200","size":"100,100"}
\:: WMTHBS8GraveSinger
You lift your broken bone flute and play a single, mournful note. The teapot’s steam coalesces into a shimmering apparition: a grateful spirit who hums back a fragment of an old burial hymn.  
(set: $inventory to it + “Fragment of Burial Hymn”)  

But can you play well enough to amaze her ?

(click:"well enough")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
    When you play your bone flute, Widow Marrow leans close and whispers, “The notes awakеn more than ghosts: listen for the crypt’s heartbeat beneath your feet.” Tremors shift a loose floor tile.
    * [[Gather your courage and enter|CryptEntry]] 
    ]
(else:)
    [
    The ghost slowly dissapears. You understand that it is time to go.
    ]

 ]

]

* [[Finish your melody and restoke the hearth|WidowMarrowTeaHouseArrival]]


:: WMTHDefaultInteraction {"position":"100,2225","size":"100,100"}
\:: WMTHDefaultInteraction
You request the Widow’s special tea. She nods, sliding you a steaming cup etched with faint sigils. You give her a few silver shards. The first sip brings a soothing warmth: and faint whispers telling of hidden graves nearby.  
(set:$money to it -2)
* [[Sip more and listen to the whispers|WMTHListenWhispers]]  
* [[Thank her and set the cup down|WidowMarrowTeaHouseArrival]]




:: WMTHLanternBearer {"position":"275,2250","size":"100,100"}
\:: WMTHLanternBearer
You raise your lantern near the bubbling cauldron. Its glow reveals arcane runes carved into the kettle’s base. Widow Marrow hushes. “Ah, you see the true recipe,” she murmurs, and gifts you a vial of **Spirit Infusion**.  
(set: $inventory to it + “Spirit Infusion”)  
* [[Thank her and lower your lantern|WidowMarrowTeaHouseArrival]]


:: WMTHListenWhispers {"position":"125,2400","size":"100,100"}
The whispers evolve, they dance around your ears, wanting to say something...
(click:"something")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $charisma >= $diceRoll)
    [
    The whispers grow clearer: “Near the Shrine…A treasure…” The steam swirls letters in the air before fading.  
(set: $journal to it + (a: "Heard clue from Widow’s tea: ‘Beneath the Shrine…A treasure’"+ "\n\n"))
(set:$shrineTreasure to true)
* [[Lower your cup and ponder what you learned...|WidowMarrowTeaHouseArrival]]
{
<script>
setTimeout(() => {
  gainXp(100);
}, "1000");
</script>
}
    ]
(else:)
    [
    You try to ear but the murmur dissipates...
    * [[Lower your cup and ponder what went wrong...|WidowMarrowTeaHouseArrival]]
    
    ]

 ]
 ]



:: WMTHStupidChoice [ENDING] {"position":"0,2225","size":"100,100"}
{
(set:$introText to "You sprinkle an extra shard of “Ghost Pepper” into the brew.")
(set:$clickTest to "the brew")
(set:$AttributeTest to $strength)
(set:$SuccessText to "... but you don't feel much disconfort... must be the kid's version...")
(set:$FailureText to "Seconds later, you’re sweating profusely and seeing dancing lights: quite literal, as tiny will-o’-wisps swirl in the steam. ")
(set:$clickDamage to "in the steam")
(set:$damageType to 2)
(set:$DeathText to "Suddenly, your throat constricts, and a searing pain radiates through your chest. You gasp for air, but each breath feels like fire. The world spins, and darkness creeps in at the edges of your vision. Your knees buckle, and you collapse, the last thing you see is the flickering of the will-o’-wisps dancing above you.")
(set:$currentEnding to 25)
(set:$LinkText to "Time to stand up and go.")
(set:$FailureLinkText to "Gasp for breath and steady yourself")
(set:$Link to "WidowMarrowTeaHouseArrival")

(set:$xpSuccess to 24)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:"MacroPassage")


:: WWBS7Cultist {"position":"1225,2025","size":"100,100"}
\:: WWBS7Cultist
You reveal the Worm Priest fetish, and the craftsman recoils: then smiles. He offers a pungent **Worm Salve** that heals wounds but tastes faintly of decay.  
You both share a smile.
(set: $inventory to it + “Worm Salve”)  
* [[Tuck it away|WheelwrightWorkshopArrival]]


:: WWDefaultInteraction {"position":"975,2025","size":"100,100"}
\:: WWDefaultInteraction
You study the craftsmanship: each bone spoke is etched with warding glyphs. The craftsman nods and offers you a small **Bone Spoke Charm** for safe passage.  
(set: $inventory to it + “Bone Spoke Charm”)  
* [[Thank him and step back|WheelwrightWorkshopArrival]]


:: WWGravebinder {"position":"1100,2025","size":"100,100"}
\:: WWGravebinder
You present your Chained Relic. The craftsman’s eye gleams as he forges it into a **Soulwheel**: a device that grants one free rebinding of an undead in combat.  
(set: $inventory to it + “Soulwheel”)  
* [[Inspect the new contraption|WheelwrightWorkshopArrival]]


:: WWStupidChoice [ENDING] {"position":"850,2025","size":"100,100"}
{
(set:$introText to "You grab a wheel and shove off. It careens wildly, knocking over barrels and nearly flattening a cat.")
(set:$clickTest to "knocking over barrels")
(set:$AttributeTest to $luck)
(set:$SuccessText to "You take a moment to compose yourself...")
(set:$FailureText to "  You skitter after it, breathless, broozed and embarrassed.")
(set:$clickDamage to "broozed")
(set:$damageType to 1)
(set:$DeathText to "The wheel barrels forward, gathering speed as it slams into a stacked pile of crates. Splinters fly: and before you can shout, the wheel veers back down the aisle and crushes you beneath its iron rim. Your vision tunnels to black as the sharp crack of your spine echoes in the empty workshop.")
(set:$currentEnding to 25)
(set:$LinkText to "Retrieve the wheel and apologize")
(set:$FailureLinkText to "Retrieve the wheel and apologize")
(set:$Link to "WheelwrightWorkshopArrival")

(set:$xpSuccess to 30)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:"MacroPassage")


:: WakeInNecropolis {"position":"3500,4850","size":"100,100"}
\:: WakeInNecropolis
You awaken in silver-darkness, confined within a coffin of burnished silver. Damp earth presses at the lid. Faint torchlight flickers from a narrow slit above.  
Somewhere beyond, a distant echoing drip reminds you: your quest is not over.  
* [[Struggle free and emerge into the necropolis|NecropolisEntrance]]


:: WeepingEffigiesArrival [NEXUS] {"position":"1100,8325","size":"100,100"}
\:: WeepingEffigiesArrival
You enter the Gallery of Weeping Effigies. Marble statues line the corridor, each carved in the likeness of a sorrowing noble, their faces streaked with black sap that pools at their feet. The air is thick with the scent of damp stone and old regret.  
What do you do?  
* [[Wipe sap from a statue’s cheek|EffigiesWipeSap]]  
* [[Study the runes carved at the statues’ bases|EffigiesStudyRunes]]  
* [[Walk the length of the gallery, counting the weeping heads|EffigiesCountHeads]]  
* [[Return to the Necropolis entrance|NecroOrientation]]  
(if: $backStory is 5)[  
  * [[Examine the statue bearing your family crest|EffigiesScionTrigger]]  
]



:: WeepingEffigiesReturn {"position":"1675,9225","size":"100,100"}
\:: WeepingEffigiesReturn
You stand before the chapel’s heart-shrine again. Four flat stones lead south. The moonlight seems to point the way.  
* (if: $flags contains “KnowAshenvaleVaultInstructions”)[  
  * [[Knock thrice and speak your name|AshenvaleVaultEntrance]]  
]  
* [[Return to the hall|WeepingEffigiesArrival]]


:: WeepingLanternArchArrival [NEXUS] {"position":"225,1225","size":"100,100"}
\:: WeepingLanternArchArrival
You approach the **Weeping Lantern Arch**, where two rusted lanterns frame the gate and drip slow, crimson tears onto the cobblestones below. Through that grate, some say, you can follow the dripping tears all the way to the Mortuary Hall: if you dare tread the silent mortuary corridors beneath the village. The air is thick with the scent of iron and damp stone, and the lanterns’ glow seems to pulse like a heartbeat.  
What do you do?  
* [[Lick a tear to taste its bitterness|WLAStupidChoice]]  
* [[Pass beneath quietly|WLADefaultInteraction]]  
* (if: $job is 2)[[Offer your own lantern’s flame to the weeper|WLALanternBearer]]  
* (if: $backStory is 4)[[Recall your exile as a Lantern Tender and study the pattern of tears|WLABS4ExiledLantern]]  
* [[Return to the square|VelthornHollowOrientation]]










:: WellBS1Plagueborn {"position":"425,1725","size":"100,100"}
\:: BS1Plagueborn
Your cracked plague mask filters away the worst of the vile mist. You wade in ankle-deep, spotting a silver talisman half-buried in mud.  
(set: $inventory to it + “Silver Talisman”)  
* [[Retrieve the talisman and ascend|ShroudedWellArrival]]  


:: WellDefaultInteraction {"position":"175,1725","size":"100,100"}
(if: visits is 1)[
You call into the well. Your voice echoes, then is swallowed by a faint sigh. Moments later, a single droplet falls: *plink*: onto the rim. You sense that something down there is listening.  

* [[Drop a stone to see how deep it is|WellDepth]]  
* [[Shout a name to see if it responds|WellNameCall]]  
]
(else:)[
Once again, you call into the well. Your voice echoes as before, then is swallowed by a faint sigh. Moments later, a single droplet falls: *plink*: onto the rim. You still can't shake the feeling that something down there is listening.  

* [[Drop another stone to see how deep it is|WellDepth]]  
* [[Shout a name to see if it responds|WellNameCall]]  
]





:: WellDepth {"position":"100,1850","size":"100,100"}
(if: visits is 1)[
You drop a pebble; it falls for several seconds before *plunk*: and yet, you swear you hear a second splash, higher up.  
* [[Try again|WellDepth]]  
* [[Step back: this is unsettling|ShroudedWellArrival]]  
]
(else:)[
You drop another pebble; Once more, it falls for several seconds before *plunk*: but this time, the echo comes back as a hollow click, and a small panel at water level slides open: revealing a damp stair descending into darkness.
* [[Gather your courage and enter|CryptEntry]]  
* [[Step back: this is unsettling|ShroudedWellArrival]]  
]




:: WellJobGravebinder {"position":"300,1725","size":"100,100"}
\:: JobGravebinder
As a **Gravebinder**, you feel the tug of forgotten souls. The mist whispers half-formed names. You bind one shade: its form solidifies just long enough to slip you a **Shade Chain**.  
(set: $inventory to it + “Shade Chain”)  
* [[Thank the spirit and step back|ShroudedWellArrival]]  

But the spirit seems to have something else to say...
(click:"something else to say")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [
    While binding a mist-shade, the spirit murmurs of a sealed doorway “beneath the stones,” and the fog parts to show a carved bone handle set into the well wall.
* [[Gather your courage and enter|CryptEntry]]  
    ]
(else:)
    [
    Nope... the words don't seem to mean anything...
    ]

 ]

]


:: WellNameCall {"position":"225,1850","size":"100,100"}
\:: WellNameCall
You murmur a random name. A hollow voice returns your own name: no one else knows it.  
* [[Ask “Who are you?”|WellWhoAreYou]]  
* [[Step back nervously|ShroudedWellArrival]]  


:: WellStupidChoice [ENDING] {"position":"175,1600","size":"100,100"}
{
(set:$introText to "You lean too far: arms flailing: and nearly topple into the well! You catch yourself, heart pounding, as a gout of chilly mist splashes your face. ")
(set:$clickTest to "splashes your face")
(set:$AttributeTest to $luck)
(set:$SuccessText to "You take a moment to compose yourself...")
(set:$FailureText to "  You hurt your hand while catching yourself...")
(set:$clickDamage to "catching yourself")
(set:$damageType to 1)
(set:$DeathText to "The mist smells faintly of damp earth: and something bitter beneath it. Almost at once your throat constricts, burning as the cold fumes lace your lungs with toxin. You choke and stagger back, vision narrowing to a pinpoint as the poison steals your breath. In a final rasp, the world goes black around you.")
(set:$currentEnding to 22)
(set:$LinkText to "Steady yourself and step back")
(set:$FailureLinkText to "You bandage your hand, steady yourself and step back...")
(set:$Link to "ShroudedWellArrival")

(set:$xpSuccess to 30)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
You turn around the old well, looking for a good place to lean.
(click:"lean")[
(display:"diceRollMacro")

 (live: 3s)[
    (stop:)
(if: $intelligence >= $diceRoll)
    [On the ground, you find 50 shards of silver! After pocketing the money, you find the right spot.
    (set:$money to it + 50)
    (display:"MacroPassage")
    ]
(else:)
    [After some time, you find the right spot.
        (display:"MacroPassage")
    ]

 ]
 ]



:: WellWhoAreYou {"position":"375,1850","size":"100,100"}
{(set:$string to $heroName)
(set:$len to $string's length)
(set:$nameExtract1 to (substring: $heroName, 1, 3))
(set:$nameExtract2 to (substring: $heroName, 6, 10))}
"$nameExtract1...$nameExtract2"a whisper drifts up. The mist thickens, and you realize it’s speaking *your* name.  
* [[Demand to know how it knows you|WellDefaultInteraction]]  
* [[Retreat in alarm|ShroudedWellArrival]]  


:: WheelwrightWorkshopArrival [NEXUS] {"position":"1050,1900","size":"100,100"}

\:: WheelwrightWorkshopArrival
You push open the door to the **Wheelwright’s Workshop**, where bone-carved spokes hang from racks and sawdust drifts in lantern light. A one-armed craftsman hammers bone wheels with rhythmic precision.  
What do you do?  
* [[Spin a half-carved wheel and chase it down the street|WWStupidChoice]]  
* [[Inspect the bone spokes closely|WWDefaultInteraction]]  
* (if: $job is 1)[[Offer your Chained Relic for a custom Soulwheel|WWGravebinder]]  
* (if: $backStory is 7)[[Show your Worm Priest fetish to trade for a healing salve|WWBS7Cultist]]  
* [[Return to the square|VelthornHollowOrientation]]




:: WhisperedAskMystery {"position":"3375,950","size":"100,100"}
\:: WhisperedAskMystery
**You:** “What’s the codeword the Wharf Watch uses at midnight?”  
Brannon’s jaw drops. “How: ? That’s not for common ears.”  
* (if: $cha >= 12)[
    **You:** “Whispered tongues hear all.”  
    **Brannon:** “You’re no charlatan. Dig’s on me.”  
    * [[Brannon frees you|VelthornHollowOrientation]]
  ][
    **Brannon:** “Nice try, but I think you’re just fishing. Coin, or silence.”  
    * [[Offer coin|WhisperedPay]]
  ]


:: WhisperedClearRumor {"position":"3250,950","size":"100,100"}
\:: WhisperedClearRumor
**You:** “I can silence those who accuse you of theft: the furnace pieces that disappeared last month.”  
Brannon’s grip tightens on the handle. “You’d help me clear my name?”  
* [[Demonstrate your skill: describe the hidden location of the furnace pieces|WhisperedShowProof]]  
* [[Hesitate and try a different approach|WhisperedAskMystery]]


:: WhisperedPay {"position":"3525,1000","size":"100,100"}
\:: WhisperedPay
**Brannon:** “Fine. Two silver shards, and I’ll shove you out.”  
(if: $money >= 2)[
  (set: $money to it - 2)
  **Brannon:** “Pleasure doing business.”  
  * [[He digs you free|VelthornHollowOrientation]]
][
  **Brannon:** “No coin, no talk, no dig.”  
  * [[The earth silences you again|GameOverStarve]]
]


:: WhisperedRevealSecret {"position":"3100,950","size":"100,100"}
\:: WhisperedRevealSecret
**You:** “You once saved the mayor’s daughter from a spirit attack: word is, you did it without raising a cry.”  
Brannon freezes. “Where’d you hear that?”  
* (if: $wis >= 12)[
    **You:** “From the shadows themselves.”  
    **Brannon:** He exhales. “No one knows that but me: and the dead. All right, you’ve earned a free dig.”  
    * [[He frees you quietly|VelthornHollowOrientation]]
  ][
    **You:** “Just… from rumor.”  
    **Brannon:** “Rumor’s cheap. If you won’t prove it, I’ll take coin.”  
    * [[Offer coin|WhisperedPay]]
  ]


:: WhisperedShowProof {"position":"3250,1075","size":"100,100"}
\:: WhisperedShowProof
**You:** “Under the granary floor, behind the loose brick. The pieces were stashed there.”  
Brannon’s eyes narrow: then soften. “By the gods… you’re for real.”  
* [[He shovels you out in gratitude|VelthornHollowOrientation]]


:: WidowMarrowTeaHouseArrival [NEXUS] {"position":"250,2050","size":"100,100"}
\:: WidowMarrowTeaHouseArrival
You push open the crooked door of **Widow Marrow’s Tea House** and step into a haze of warm steam and spectral whispers. One curl of steam forms the outline of a vaulted archway draped in phosphorescent moss: the unmistakable gateway to the Ossuary of Echoes. Faint tinkling bells echo around low tables draped in moth-eaten cloths, and the scent of strange herbs mingles with something… otherworldly.  
What do you do?  
* [[Add a pinch of “Ghost Pepper” spice|WMTHStupidChoice]]  
* [[Order a cup of Widow Marrow’s special brew|WMTHDefaultInteraction]]  
* (if: $job is 2)[[Hold your lantern beside the cauldron to read its hidden runes|WMTHLanternBearer]]  
* (if: $backStory is 8)[[Play a note on your bone flute for Widow Marrow|WMTHBS8GraveSinger]]  
* [[Return to the square|VelthornHollowOrientation]]











:: Zone Notes [ZoneNotes] {"position":"1675,0","size":"200,100"}



:: casino {"position":"1575,400","size":"100,100"}
<script>
if (typeof $money !== "number") {
  $money = 1000;
}

window.casinoGameHTML = `
  <style>
    .casino-console {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(145deg, #0a0f30, #1a1f40);
      color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      width: 320px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
      border: 1px solid #00ffff33;
      text-align: center;
    }
    .casino-console h2 {
      margin-bottom: 1rem;
      color: #00ffff;
      font-size: 1.4rem;
      text-shadow: 0 0 5px #00ffffaa;
    }
    .casino-console button {
      background-color: #00aaff;
      color: #fff;
      border: none;
      padding: 0.6rem 1.2rem;
      margin: 0.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      transition: background 0.2s ease;
      cursor: pointer;
    }
    .casino-console button:hover {
      background-color: #0088cc;
    }
    .casino-console #message {
      min-height: 1.5em;
      margin: 1rem 0;
      font-style: italic;
    }
    .casino-console input[type="number"] {
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      width: 140px;
      margin-bottom: 1rem;
      text-align: center;
    }
    .centrerBouton {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  </style>
  <div class="casino-console">
    <h2>🛸 Galactic Casino</h2>
    <div id="credits">Credits: <strong>${$money}</strong></div>
    <input id="wagerInput" type="number" min="1" placeholder="Enter your bet">
    <div id="message"></div>
    <div class="centrerBouton">
      <button id="betBtn">Place Bet</button>
      <button id="cashBtn">Cash Out</button>
    </div>
  </div>
`;

// Modal creation (if not already done)
if (!window._casinoModalInit) {
  window._casinoModalInit = true;

  const overlay = document.createElement('div');
  Object.assign(overlay.style, {
    position: 'fixed',
    top: '0',
    left: '0',
    width: '100vw',
    height: '100vh',
    background: 'rgba(0,0,20,0.8)',
    display: 'none',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: 9999
  });
  document.body.appendChild(overlay);

  const container = document.createElement('div');
  overlay.appendChild(container);

  window.twShowModal = function (html) {
    container.innerHTML = html;
    overlay.style.display = 'flex';
  };
  window.twHideModal = function () {
    overlay.style.display = 'none';
    container.innerHTML = '';
  };
}

// Game logic
window.setupCasino = function () {
  let credits = $money;

  const creditsEl = document.getElementById('credits');
  const messageEl = document.getElementById('message');
  const betBtn = document.getElementById('betBtn');
  const cashBtn = document.getElementById('cashBtn');
  const wagerInput = document.getElementById('wagerInput');

  function render() {
    creditsEl.innerHTML = 'Credits: <strong>' + credits + '</strong>';
    if (credits <= 0) {
      messageEl.textContent = "💥 You're out of credits!";
      betBtn.disabled = true;
      wagerInput.disabled = true;
    }
  }

  function flipQuantum() {
    return Math.random() < 0.5;
  }

  betBtn.addEventListener('click', function () {
    const wager = parseInt(wagerInput.value, 10);
    if (!wager || wager < 1 || wager > credits) {
      messageEl.textContent = `⛔ Invalid bet. Enter 1–${credits}.`;
      return;
    }

    const win = flipQuantum();
    credits += win ? wager : -wager;
    $money = credits;

    messageEl.textContent = win
      ? `🎉 You won ${wager} credits!`
      : `😢 You lost ${wager} credits.`;

    render();
    wagerInput.value = '';
  });

  cashBtn.addEventListener('click', function () {
    messageEl.textContent = `💰 You cashed out with ${credits} credits.`;
    $money = credits;
    setTimeout(() => window.twHideModal(), 1500);
  });

  render();
};

// Open the casino
window.openCasino = function () {
  twShowModal(window.casinoGameHTML);
  setupCasino();
};
</script>



:: credits {"position":"2300,700","size":"100,100"}
{<style>
.game-interface {
     height: 0px; 
}
  </style>

<body>

<a class="back-button">[[Back->Start2]]</a>
<div class="credits-container">
  <div class="credits">
    <h1>A Spaceship Accident</h1>
    <p>Developed by Olivier Mavré (Artist & Writer) and Quentin BOISSET (Developer & Sound Designer)</p>
    <br />
    <h2>Story & Illustrations</h2>
    <p>All illustrations and the story were conceived and drawn by Olivier Mavré.</p>
    <br />
    <h2>Game System & Animations</h2>
    <p>Menus, animations, and the complete game system were developed by Quentin BOISSET.</p>
    <br />
    <h2>Music</h2>
    <p>The music was composed by Quentin BOISSET. Only the two main ambient tracks were created using Suno due to our limited experience in full music production; we plan to hire a composer once we have the budget.</p>
    <br />
    <h2>Sound Effects</h2>
    <p>All sound effects were created by Quentin BOISSET.</p>
    <br />
    <h2>Special Thanks</h2>
    <p>A huge thank you to all our players! This is our very first game on this site, built with Twine. More enhancements are coming in future adventures!</p>
    <br />
    <h2>Stay Connected</h2>
<p>
  Visit our website to follow our upcoming games:
  <a style="color: gold;" href="https://pickyouruniverse.com/index.php" target="_blank" rel="noopener noreferrer">
    PickYourUniverse.com
  </a>
</p>
  </div>
</div>

<script>

    if (window.musiqueDeFond) {
      window.musiqueDeFond.pause();
      window.musiqueDeFond.currentTime = 0;
    }

    // Lancer la musique des crédits
    const musiqueCredits = new Audio("https://pickyouruniverse.com/DataProjects/General/SonEvenements/credit.mp3");
    musiqueCredits.loop = true;
    musiqueCredits.volume = 0.5;
    musiqueCredits.play().catch(err => console.log("Lecture bloquée par le navigateur", err));

    // Rendre la musique accessible globalement si besoin
    window.musiqueCredits = musiqueCredits;

  document.querySelector('.back-button')?.addEventListener('click', function () {
    if (window.musiqueCredits) {
      window.musiqueCredits.pause();
      window.musiqueCredits.currentTime = 0;
      window.musiqueDeFond.play();
    }
  });
  
(function () {
    function updateUI() {
        const characterUnlocked = sessionStorage.getItem("characterUnlocked") === "true";
        const characterButton = document.querySelector('.nav-btn[data-panel="skills"]');
        const elementsToHide = document.querySelectorAll('.top-nav, .xp-container, .inventory-sidebar');

        if (characterButton) {
            if (characterUnlocked) {
                characterButton.classList.remove("disabled-btn");
                characterButton.disabled = false;
            } else {
                characterButton.classList.add("disabled-btn");
                characterButton.disabled = true;
            }
        }

        elementsToHide.forEach(el => {
            el.style.display = characterUnlocked ? "" : "none";
        });
    }

    // Met à jour l'état de l'UI à chaque changement de passage
    $(document).on(':passagerender', function () {
        updateUI();
    });

    // Exécuter immédiatement au chargement
    updateUI();
})();
</script>}



:: diceRollMacro {"position":"1700,400","size":"100,100"}
{
(if: $skillCheckEnable is true)
[
    (set: $counter to 10)
    (live: 0.2s)[
        (set: $diceRoll1 to (random: 1,6))
        (set: $diceRoll2 to (random: 1,6))
        (set: $diceRoll3 to (random: 1,6))

        (set: $diceRoll1Link to "<img class='cssde' src='https://pickyouruniverse.com/DataProjects/General/Dé/" + (str: $diceRoll1) + ".png'>")
        (set: $diceRoll2Link to "<img class='cssde' src='https://pickyouruniverse.com/DataProjects/General/Dé/" + (str: $diceRoll2) + ".png'>")
        (set: $diceRoll3Link to "<img class='cssde' src='https://pickyouruniverse.com/DataProjects/General/Dé/" + (str: $diceRoll3) + ".png'>")

        <table style="display: flex; width: 100%; justify-content: center;">
            <tr>
                <td>$diceRoll1Link</td>
                <td>$diceRoll2Link</td>
                <td>$diceRoll3Link</td>
            </tr>
        </table>

        (set: $counter to it - 1)
        (if: $counter is 0)[
            (stop:)
            (set: $diceRoll to $diceRoll1 + $diceRoll2 + $diceRoll3)
            The result is $diceRoll
        ]
    ]
]
(else:)[
(set:$diceRoll to (random: 3,18))
]
}


:: footer [footer] {"position":"1950,525","size":"100,100"}
{
<div class="xp-container">
  <span class="lvl-xp" id="lvl-text">Lvl 1</span>
  <div class="xp-bar">
    <span class="bar-text-xp" id="bar-text-xp">0 XP / 10</span>
    <div class="xp-fill" id="xp-fill"></div>
  </div>
</div>

<aside class="inventory-sidebar">
  <div class="classinventory">
    <div class="paramBlock">
      <div class="zonesoin" data-type="soin" title="Put your potion">💊</div>
      <div class="zonesuppression" data-type="suppression" title="Drag here to delete item">🗑️</div>
    </div>
    <div class="RangementdivFooter">
      <div class="inventory-slot"></div>
      <div class="inventory-slot"></div>
      <div class="inventory-slot"></div>
      <div class="inventory-slot"></div>
      <div class="inventory-slot"></div>
      <div class="inventory-slot"></div>
      <div class="inventory-slot"></div>
      <div class="inventory-slot"></div>
      <div class="inventory-slot"></div>
    </div>
  </div>
  <button class="option-btn" data-panel="options">Settings</button>
</aside>

<script>
(function () {
  // Initialisation robuste des variables
  if (typeof $xp !== "number" || isNaN($xp)) $xp = 0;
  if (typeof $pointExp !== "number" || isNaN($pointExp)) $pointExp = 0;
  if (typeof $LvlXp !== "number" || isNaN($LvlXp)) $LvlXp = 1;
  if (typeof $xpLevelIndex !== "number" || isNaN($xpLevelIndex)) $xpLevelIndex = 0;
  if (typeof $levelThreshold !== "number" || isNaN($levelThreshold)) $levelThreshold = 10;
  if (typeof $baseLevelsEarned !== "number" || isNaN($baseLevelsEarned)) $baseLevelsEarned = 0;

  class ExperienceSystem {
    constructor() {
      this.levelThresholds = [10, 50, 100, 200, 300, 500, 1000];
      this.maxBaseLevel = this.levelThresholds.length; // Niveau 7 (index 6)

      // Conversion numérique garantie
      this.xp = Number($xp);
      this.level = Number($LvlXp);
      this.levelIndex = Number($xpLevelIndex);
      this.currentThreshold = Number($levelThreshold);
      this.baseLevelsEarned = Number($baseLevelsEarned);
      this.skillPoints = Number($pointExp);

      this.updateUI();
    }

    getTotalXp() {
      let total = 0;
      
      // Calcul de l'XP pour les niveaux de base
      for (let i = 0; i < Math.min(this.levelIndex, this.maxBaseLevel); i++) {
        total += this.levelThresholds[i];
      }
      
      // Ajout de l'XP pour les niveaux supplémentaires
      if (this.levelIndex > this.maxBaseLevel) {
        const extraLevels = this.levelIndex - this.maxBaseLevel;
        total += extraLevels * this.levelThresholds[this.maxBaseLevel - 1];
      }
      
      return total + this.xp;
    }

    recalculateLevel(totalXp) {
      // Validation du total XP
      totalXp = Number(totalXp);
      if (isNaN(totalXp)) totalXp = 0;
      
      const thresholds = this.levelThresholds;
      const lastThreshold = thresholds[thresholds.length - 1]; // 1000 XP
      let xpLeft = totalXp;
      let newLevel = 1;
      let newLevelIndex = 0;
      let newBaseLevels = 0;

      // Parcourir les 7 premiers niveaux
      while (newLevelIndex < this.maxBaseLevel && xpLeft >= thresholds[newLevelIndex]) {
        xpLeft -= thresholds[newLevelIndex];
        newLevel++;
        newLevelIndex++;
        newBaseLevels++;
      }

      // Gestion des niveaux infinis au-delà du niveau 7
      if (newLevelIndex >= this.maxBaseLevel) {
        // Calcul des niveaux supplémentaires
        const extraLevels = Math.floor(xpLeft / lastThreshold);
        newLevel += extraLevels;
        newLevelIndex += extraLevels;
        xpLeft = xpLeft % lastThreshold;
        newBaseLevels += extraLevels; 
      }

      // Calcul des points de compétence uniquement pour les niveaux de base
      const gainedPoints = Math.max(0, newBaseLevels - this.baseLevelsEarned);
      
      // Mise à jour des variables d'état
      this.level = newLevel;
      this.levelIndex = newLevelIndex;
      this.xp = xpLeft;
      this.currentThreshold = (newLevelIndex < this.maxBaseLevel) 
        ? thresholds[newLevelIndex] 
        : lastThreshold;
      
      // Mise à jour des points de base gagnés
      if (gainedPoints > 0) {
        this.skillPoints += gainedPoints;
      }

      // Sauvegarde dans les variables Twine
      $xp = this.xp;
      $LvlXp = this.level;
      $xpLevelIndex = this.levelIndex;
      $levelThreshold = this.currentThreshold;
      $baseLevelsEarned = this.baseLevelsEarned;
      $pointExp = this.skillPoints;

      // Attribution des points de compétence
      if (gainedPoints > 0 && 
          typeof window.getPointsRemaining === "function" &&
          typeof window.setPointsRemaining === "function") {
        const current = window.getPointsRemaining();
        window.setPointsRemaining(current + gainedPoints);
      }
    }

    addXp(amount) {
      // Validation de l'amount
      amount = Number(amount);
      if (isNaN(amount) || amount <= 0) return;

      const newTotalXp = this.getTotalXp() + amount;
      this.recalculateLevel(newTotalXp);
      this.updateUI();

      // Animation
      const characterBtn = document.querySelector('button.nav-btn[data-panel="skills"]');
      if (characterBtn) {
        characterBtn.classList.add('character-animation');
        characterBtn.addEventListener('animationend', () => {
          characterBtn.classList.remove('character-animation');
        }, { once: true });
      }

      // Son
      if (window.sfxEnabled) {
        const xpSound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/xp.mp3");
        xpSound.play().catch(e => console.error("XP sound error:", e));
      }
    }

    updateUI() {
      const xpFill = document.getElementById("xp-fill");
      const lvlText = document.getElementById("lvl-text");
      const barText = document.getElementById("bar-text-xp");

      const percentage = (this.xp / this.currentThreshold) * 100;
      xpFill.style.width = percentage + "%";
      
      lvlText.innerText = `Lvl ${this.level}`;
      
      // Affichage spécial pour les niveaux supérieurs à 7
      if (this.level > this.maxBaseLevel) {
        barText.innerText = `${this.xp} XP / ${this.currentThreshold}`;
      } else {
        barText.innerText = `${this.xp} XP / ${this.currentThreshold}`;
      }
    }
  }

  window.gainXp = function (amount) {
    if (window.player) {
      window.player.addXp(amount);
    }
  };

  // Initialisation
  window.player = new ExperienceSystem();
})();
</script>

}


:: headerMACRO [header] {"position":"1575,525","size":"100,100"}
{
<head>
<link rel="icon" type="image/x-icon" href="https://pickyouruniverse.com/img/favicon.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans&display=swap" rel="stylesheet">
<meta charset="UTF-8">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<div class="game-interface">
  <nav class="top-nav">
    <div class="nav-buttons">
          <!--<button class="nav-btn" data-panel="maps">Maps</button>-->
           <button class="nav-btn" data-panel="journal">Journal</button>
           <button class="nav-btn" data-panel="inventory">Inventory</button>
           <button class="nav-btn" data-panel="skills">Character</button>
    </div>
  <div class="progress-bar">
  <div class="health-bar">
    <div class="bar-fill" id="bar-fill"></div>
    <span class="bar-text" id="bar-text" data-max="$maxHealth">$health/$maxHealth</span>
  </div>
  <span class="money">$money  <i class="fas fa-coins"></i></span>
</div>}
  </nav>



{<div id="maps-panel" class="content-panel">
  <button class="close-btn">×</button>
  <h2 style="color: #FFD700;  width: 50%;">Maps</h2>
  <!-- Contenu de la carte -->
          <div class="blockinfoPerso">
        <div class="portrait"> <img class="CharacterImg" id="character-image" src="" alt="Character Image"></div>
        <div class="portrait-description">$journal</div>
        </div>
    </div>
</div>}

{<div id="journal-panel" class="content-panel">
  <button class="close-btn">×</button>
  <h2 style="color: #FFD700;  width: 50%;">Journal</h2>
  $journal
  <!-- Contenu de la carte -->
</div>}




 {<div id="inventory-panel" class="content-panel">
    <button class="close-btn">×</button>
    <h2 style="color: #FFD700;  width: 50%;">Inventory</h2>
    <!-- Contenu Inentaire -->
    
    <div class="inventaireHaut">
        <div class="inventaireIngame" data-type="any"></div>
        <div class="inventaireIngame" data-type="any"></div>
        <div class="inventaireIngame" data-type="any"></div>
        <div class="inventaireIngame" data-type="any"></div>
        <div class="inventaireIngame" data-type="any"></div>
        <div class="inventaireIngame" data-type="any"></div>
        <div class="inventaireIngame" data-type="any"></div>
        <div class="inventaireIngame" data-type="any"></div>
        <div class="inventaireIngame" data-type="any"></div>
        </div>
            <div class="paramBlock">
                <div class="zonesoin" data-type="soin" title="Put your potion">💊</div>
                <div class="zonesuppression" data-type="suppression" title="Drag here to delete item">🗑️</div>
    </div>

  <div class="inventaireBas">
        <div class="special-armors">
    	<div class="details-armors">
          <div class="blockStatsArmures">
            <div class="statDegats">
              <span class="statDegatsInfo"></span><!--infos dammage-->
            </div>
            <div class="statArmures">
              <span class="statArmuresInfo"></span><!--info armors-->
            </div>
          </div>
        </div>
       <div class="blockEquipements" id="equipements-section">
        <div class="igauche">
          <div class="iconArmors" data-type="gloves">
            <img style="width: 60%;" class="decorative-image" src="https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/maininventaire.svg">
          </div>
          <div class="iconArmors" data-type="sword">
            <img style="width: 60%;" class="decorative-image" src="https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/epeeinventaire.svg">
          </div>
          <button id="toggle-equipement">></button>
        </div>
        <div class="icentre">
          <div class="iconArmors" data-type="helmet">
            <img style="width: 60%;" class="decorative-image" src="https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/helmetinventaire.svg">
          </div>
          <div class="iconArmors" data-type="armor">
            <img style="width: 60%;" class="decorative-image" src="https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/armorinventaire.svg">
          </div>
          <div class="iconArmors" data-type="boots">
            <img style="width: 60%;" class="decorative-image" src="https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/bootsinventaire.svg">
          </div>
        </div>
        <div class="idroite">
          <div class="iconArmors" data-type="object">
            <img style="width: 60%;" class="decorative-image" src="https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/objetinventaire.svg">
          </div>
          <div class="iconArmors" data-type="object">
            <img style="width: 60%;" class="decorative-image" src="https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/ImageBase/objetinventaire.svg">
          </div>
          <div class="iconArmors">
            <i class="fas fa-coins argentequipements" data-raw="">$money</i>
          </div>
        </div>
      </div>

      <!-- Section alternative avec l'image d’armure complète -->
      <div id="equipement-image" style="display: none; text-align: center;">
        <img style="width: 60%;" class="decorative-image" src="https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Combats/PersoCombat.png">
                  <button id="retour-equipement">></button>
      </div>
    </div>
		
        <div class="rangementcotedroit">
          <div class="inventory-grid">
              <!-- 24 emplacements d'inventaire -->
              <div class="slot" data-type="any" id="slot-1"></div>
              <div class="slot" data-type="any" id="slot-2"></div>
              <div class="slot" data-type="any" id="slot-3"></div>
              <div class="slot" data-type="any" id="slot-4"></div>
              <div class="slot" data-type="any" id="slot-5"></div>
              <div class="slot" data-type="any" id="slot-6"></div>
              <div class="slot" data-type="any" id="slot-7"></div>
              <div class="slot" data-type="any" id="slot-8"></div>
              <div class="slot" data-type="any" id="slot-9"></div>
              <div class="slot" data-type="any" id="slot-10"></div>
              <div class="slot" data-type="any" id="slot-11"></div>
              <div class="slot" data-type="any" id="slot-12"></div>
              <div class="slot" data-type="any" id="slot-13"></div>
              <div class="slot" data-type="any" id="slot-14"></div>
              <div class="slot" data-type="any" id="slot-15"></div>
              <div class="slot" data-type="any" id="slot-16"></div>
              <div class="slot" data-type="any" id="slot-17"></div>
              <div class="slot" data-type="any" id="slot-18"></div>
              <div class="slot" data-type="any" id="slot-19"></div>
              <div class="slot" data-type="any" id="slot-20"></div>
              <div class="slot" data-type="any" id="slot-21"></div>
              <div class="slot" data-type="any" id="slot-22"></div>
              <div class="slot" data-type="any" id="slot-23"></div>
              <div class="slot" data-type="any" id="slot-24"></div>

		</div>

		<div class="RAInventaire">
              <label class="toggle">
              <input type="checkbox">
              <span class="slider"></span>
              </label>
              <span class="label-text">Automatic storage</span>
              </div>
          </div>
    </div>}
</div>
 
 
 
 

{<div id="skills-panel" class="content-panel">
    <button class="close-btn">×</button>
    <h2 style="color: #FFD700">Character</h2>
    <!-- Contenu Character -->
    <div class="blockcarapter">
        <div class="character-details">
        <table class="tableinfoscaracter">
            <tr>
            <td class="bold-yellow">$heroName</td>
            <td class="bold-white"  id="verificationjob">$jobname</td>
            </tr>
            <tr>
            <td class="bold-white">Male</td>
            <td class="bold-white">32 Year Old</td>
            </tr>
        </table>
        </div>
        <div class="blockinfoPerso">
        <div class="portrait"> <img class="CharacterImg" id="character-image" src="" alt="Character Image"></div>
        <div class="portrait-description">$description</div>
        </div>
    </div>

    <div class="stats-container">
        <div class="stat-group">
        <div class="stat-controls">
            <button class="stat-btn" onclick="adjustStat('strength', -1)">-</button>
            <div class="stat-value" id="strength-value">$basestrength</div>
            <button class="stat-btn" onclick="adjustStat('strength', 1)">+</button>
        </div>
        <span class="stat-name">Strength</span>
        </div>

        <div class="stat-group">
        <div class="stat-controls">
            <button class="stat-btn" onclick="adjustStat('luck', -1)">-</button>
            <div class="stat-value" id="luck-value">$baseluck</div>
            <button class="stat-btn" onclick="adjustStat('luck', 1)">+</button>
        </div>
        <span class="stat-name">luck</span>
        </div>

        <div class="stat-group">
        <div class="stat-controls">
            <button class="stat-btn" onclick="adjustStat('intelligence', -1)">-</button>
            <div class="stat-value" id="intelligence-value">$baseintelligence</div>
            <button class="stat-btn" onclick="adjustStat('intelligence', 1)">+</button>
        </div>
        <span class="stat-name">Intelligence</span>
        </div>

        <div class="stat-group">
        <div class="stat-controls">
            <button class="stat-btn" onclick="adjustStat('charisma', -1)">-</button>
            <div class="stat-value" id="charisma-value">$basecharisma</div>
            <button class="stat-btn" onclick="adjustStat('charisma', 1)">+</button>
        </div>
        <span class="stat-name">Charisma</span>
        </div>
    </div>

    <div class="points-remaining">
        
Remaining points : <span class="points-value" id="points-remaining">$pointExp</span>
    </div>
</div>}

{<div id="options-panel" class="content-panel">
    <button class="close-btn">×</button>
    <h2 style="color: #FFD700;  width: 50%;">Settings</h2>
    <!-- Contenu des options -->
<div class="conteneur-options">
    <!-- Section Gauche : Audio -->
    <section class="options-audio">
      <div class="option-item">
        <label for="activer-musique">Music</label>
        <input type="checkbox" id="activer-musique" checked>
      </div>

      <div class="option-item-son">
        <label for="volume-son">Sound volume</label>
        <input type="range" id="volume-son" min="0" max="100" value="50">
      </div>
      
<div class="option-item">
  <label for="dr-toggle">Dice Role</label>
  <input type="checkbox" id="activateDice" checked>
</div>

    </section>

        <!-- Séparateur -->
        <div class="separateur"></div>

        <!-- Section Droite : Langue et Sauvegarde -->
<section class="options-jeu">
      <div class="option-item">
        <label for="sfx-toggle">SFX</label>
        <input type="checkbox" id="sfx-toggle" checked>
      </div>

      <div class="option-item-son">
        <label for="volume-sfx">SFX volume</label>
        <input type="range" id="volume-sfx" min="0" max="100" value="50">
      </div>
      
      <div class="option-item">
      <label for="rf-toggle">Dice Role Fight</label>
      <input type="checkbox" id="activateDiceFight" checked>
    </div>
      <!-- Interface utilisateur -->
    </section>
  </div>
      
    <div class="panel-footer">       
          <div class="option-item">
          <button id="reset-progress" onclick="resetLocalStorage()" class="boutonResetLocalSt">
            Reset All Progress
          </button>
      </div>

          <div class="autreParametre">
          
                         <div class="blockParametre" style="gap: 70px;">    
                   (link: "Save game")[
                      (if: (save-game: "Slot A"))[
                        Game saved!
                        ](else: )[
                        Sorry, I couldn't save your game.
                        ]
                      ]
                      (if: (saved-games:) contains "Slot A")[
                      (link: "Load game")[
                        (load-game: "Slot A")
                        ]
                      ]                     
                      </div>
                      <div class="blockParametre">   
                         <a class="lienSite" href="https://pickyouruniverse.com/index.php" class="btn">Website</a>
                      <div class="blockParametre">[[credits]]</div>
                      </div>
                </div>
      </div>
</div>}

</div>
<script>
//!Barre de vie
(function () {
  const barText = document.getElementById("bar-text");

  const observer = new MutationObserver(() => {
    observer.disconnect(); 
    refreshHealth();      
    observer.observe(barText, config); 
  });

  const config = {
    childList: true,
    characterData: true,
    subtree: true
  };

  observer.observe(barText, config);

  function refreshHealth() {
    updateHealthBar();
  }

  function updateHealthBar() {
    const barFill = document.getElementById("bar-fill");

    const [currentHealth, maxHealth] = barText.textContent.split('/').map(Number);
    if (isNaN(currentHealth) || isNaN(maxHealth)) return;

    const percentage = (currentHealth / maxHealth) * 100;
    barFill.style.width = percentage + "%";
    barText.textContent = `${currentHealth}/${maxHealth}`; // <- ici, sans ça on évite la boucle

    // Mise à jour du style différée
    setTimeout(() => {
      if (percentage >= 80) {
        barFill.style.background = "linear-gradient(90deg, #44ff44 0%, #44ff8f 100%)";
      } else if (percentage >= 40) {
        barFill.style.background = "linear-gradient(90deg, #ffaa44 0%, #ffdd44 100%)";
      } else {
        barFill.style.background = "linear-gradient(90deg, #ff4444 0%, #ff8f44 100%)";
      }
    }, 10);
  }

  // Fonction publique si besoin de mise à jour manuelle
  window.updateHealth = function(newHealth, newMax) {
    if (newMax !== undefined) {
      barText.textContent = `${newHealth}/${newMax}`;
    } else {
      const [, max] = barText.textContent.split('/').map(Number);
      barText.textContent = `${newHealth}/${max}`;
    }
  };
})();


//!FIN Barre de vie
//!--------------------------------------------------------------------------------------------
//!!Menu Option 
window.$skillCheckEnable = true;
window.$skillCheckEnableFight = true;

document.getElementById("activateDice").addEventListener("change", function() {
    window.$skillCheckEnable = this.checked; 
});

// Lors du changement de la checkbox "activateDiceFight"
document.getElementById("activateDiceFight").addEventListener("change", function() {
    window.$skillCheckEnableFight = this.checked;  
});

//!! Save localStorage & restaurer options
function setupOptionPersistence() {
    // ✅ Gérer toutes les checkboxes (on/off)
    document.querySelectorAll('input[type="checkbox"]').forEach(input => {
        const id = input.id;
        if (!id) return;

        // Charger l’état sauvegardé
        const saved = localStorage.getItem(`option-${id}`);
        if (saved !== null) {
            input.checked = saved === 'true';
        }

        // Sauvegarder lors du changement
        input.addEventListener('change', () => {
            localStorage.setItem(`option-${id}`, input.checked);
            console.log(`💾 [Option] ${id} = ${input.checked}`);

            // Appliquer effets immédiats
            if (id === 'activer-musique') {
                if (input.checked) {
                    window.musiqueDeFond?.play().catch(err => console.log("Lecture auto bloquée", err));
                } else {
                    window.musiqueDeFond?.pause();
                }
            }

            if (id === 'sfx-toggle') {
                window.sfxEnabled = input.checked;
            }

            if (id === 'activateDice') {
                $skillCheckEnable = input.checked;
            }

            if (id === 'activateDiceFight') {
                $skillCheckEnableFight = input.checked;
            }
        });
    });

    // ✅ Gérer tous les sliders (input[type=range])
    document.querySelectorAll('input[type="range"]').forEach(input => {
        const id = input.id;
        if (!id) return;

        // Charger l’état sauvegardé
        const saved = localStorage.getItem(`option-${id}`);
        if (saved !== null) {
            input.value = saved;
            input.dispatchEvent(new Event('input'));
        }

        // Sauvegarder lors du changement
        input.addEventListener('input', () => {
            localStorage.setItem(`option-${id}`, input.value);
            console.log(`💾 [Slider] ${id} = ${input.value}`);

            // ✅ Appliquer les effets immédiats
            if (id === 'volume-son' && window.musiqueDeFond) {
                window.musiqueDeFond.volume = input.value / 100;
            }

            if (id === 'volume-sfx') {
                window.sfxVolume = input.value / 100;
            }
        });
    });

    // ✅ Appliquer l’état initial de la musique après chargement
    const musiqueToggle = document.getElementById('activer-musique');
    if (musiqueToggle && !musiqueToggle.checked) {
        window.musiqueDeFond?.pause();
    }
}
//fin save localstorage

// Fonction de réinitialisation
window.resetLocalStorage = function() {
    const confirmation = confirm("WARNING: This will permanently reset ALL your progress!\n\n- All items will be deleted\n- Experience points will reset to 0\n- Current health will be reset\n\nAre you absolutely sure?");
    
    if (confirmation) {
        localStorage.clear();
        location.reload(); 
        alert("All data has been reset. The game will now reload.");
    }
};
    //!?Menu InGames
  (function() {
  
  window.sfxEnabled = true;
 window.sfxVolume = 0.5;

	// Gestion du toggle SFX
  document.querySelector('#sfx-toggle').addEventListener('change', function(e) {
    window.sfxEnabled = e.target.checked;
  });
  
  document.getElementById("volume-sfx").addEventListener("input", function() {
    window.sfxVolume = this.value / 100;
    console.log("Volume des SFX : " + this.value);
});
    var draggables;
    var containers;
    var autoStorageCheckbox;

    // Fonction d'initialisation à appeler après le chargement du passage
    window.initializeGameInterface = function() {
        setupSkillButtons();
        setupInGameMenu();
        setupInventory();
        synchronizeInventories(); 
        setupOptionPersistence();
    };
    
    function setupSkillButtons() {
        document.querySelectorAll('.circle-btn').forEach(function(btn) {
            var skillName = btn.getAttribute('data-skill');
            var initialText = btn.textContent;

            btn.addEventListener('mouseover', function() {
                btn.textContent = skillName;
            });

            btn.addEventListener('mouseout', function() {
                btn.textContent = initialText;
            });
        });
    }

    function setupInGameMenu() {
        var navButtons = document.querySelectorAll('.nav-btn, .option-btn');
        var panels = document.querySelectorAll('.content-panel');
        var closeButtons = document.querySelectorAll('.close-btn');

        function closeAllPanels() {
            panels.forEach(function(panel) {
                panel.classList.remove('active');
            });
            navButtons.forEach(function(btn) {
                btn.classList.remove('active');
            });
        }

        navButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                var panelName = btn.getAttribute('data-panel');
                var panel = document.getElementById(panelName + '-panel');
                
                if (panel.classList.contains('active')) {
                    closeAllPanels();
                } else {
                    closeAllPanels();
                    panel.classList.add('active');
                    btn.classList.add('active');
                }
            });
        });

        closeButtons.forEach(function(btn) {
            btn.addEventListener('click', closeAllPanels);
        });
    }
    //!?FIN Menu InGames
    
   // Vérifier si l'audio existe déjà pour éviter de le recréer
     const musiques = [
    "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/musique/SpaceshipAccident.mp3",
    "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/musique/SpaceshipAccident(1).mp3"
  ];
  
function choisirMusiqueSuivante(actuelle) {
  let suivante;
  do {
    suivante = musiques[Math.floor(Math.random() * musiques.length)];
  } while (suivante === actuelle);
  return suivante;
}
    
if (!window.musiqueDeFond) {
  let musiqueActuelle = musiques[Math.floor(Math.random() * musiques.length)];
  window.musiqueDeFond = new Audio(musiqueActuelle);
  window.musiqueDeFond.volume = 0.5;

  // Quand la musique se termine, on en joue une autre aléatoire
  window.musiqueDeFond.addEventListener("ended", function () {
    musiqueActuelle = choisirMusiqueSuivante(musiqueActuelle);
    window.musiqueDeFond.src = musiqueActuelle;
    window.musiqueDeFond.play().catch(err => console.log("Lecture auto bloquée", err));
  });

  window.musiqueDeFond.play().catch(err => console.log("Lecture auto bloquée", err));
}

// Gérer l'activation de la musique
document.getElementById("activer-musique").addEventListener("change", function() {
    if (this.checked) {
        window.musiqueDeFond.play().catch(error => console.log("Lecture auto bloquée, interaction requise"));
        console.log("Musique activée 🎵");
    } else {
        window.musiqueDeFond.pause();
        console.log("Musique désactivée 🔇");
    }
});

// Gérer le changement de volume
document.getElementById("volume-son").addEventListener("input", function() {
    window.musiqueDeFond.volume = this.value / 100; // Le volume doit être compris entre 0 et 1
    console.log("Volume des sons : " + this.value);
});

// Ajout d'une fonction pour changer la musique si besoin
window.changerMusique = function(nouvelleMusique) {
    if (window.musiqueDeFond.src !== nouvelleMusique) {
        window.musiqueDeFond.pause();
        window.musiqueDeFond.src = nouvelleMusique;
        window.musiqueDeFond.play().catch(error => console.log("Lecture auto bloquée, interaction requise"));
    }
};

//!!Fin Menu Option 
//!--------------------------------------------------------------------------------------------
//!Journal

//!Fin Journal
//!--------------------------------------------------------------------------------------------
//!!Menu Caractère
    // Récupération du texte affiché dans le <td id="verificationjob">
    let jobname = document.getElementById("verificationjob").textContent.trim();

    // Associe les métiers à leurs images
    let jobImages = {
        "Engineer": "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Personnages/Intelligence.jpg",
        "soldier": "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Personnages/Strength.jpg",
        "Wild Card": "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Personnages/Luck.jpg",
        "God": "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Personnages/Maximus.jpg"
    };

    // Vérifie si le métier correspond à une image et met à jour
    if (jobImages[jobname]) {
        document.getElementById("character-image").src = jobImages[jobname];
    }


(function () {
    // Initialisation sécurisée des variables Harlowe dans JS
    if (typeof $strength !== "number") $strength = 10;
    if (typeof $intelligence !== "number") $intelligence = 10;
    if (typeof $luck !== "number") $luck = 10;
    if (typeof $charisma !== "number") $charisma = 10;
    if (typeof $pointExp !== "number") $pointExp = 5;

    let baseStats = {
        strength: typeof $basestrength === "number" ? $basestrength : $strength,
        intelligence: typeof $baseintelligence === "number" ? $baseintelligence : $intelligence,
        luck: typeof $baseluck === "number" ? $baseluck : $luck,
        charisma: typeof $basecharisma === "number" ? $basecharisma : $charisma
    };

    let stats = {
        strength: $strength,
        intelligence: $intelligence,
        luck: $luck,
        charisma: $charisma
    };

    let pointsRemaining = $pointExp;
    const maxStatValue = 30;

    function updateStatDisplay(stat) {
        const el = document.getElementById(`${stat}-value`);
        if (el) el.textContent = stats[stat];
    }

    function updateAllStatDisplays() {
        Object.keys(stats).forEach(updateStatDisplay);
    }

    function updatePointsRemainingDisplay() {
        const el = document.getElementById('points-remaining');
        if (el) el.textContent = pointsRemaining;
    }

    function updateButtons() {
        Object.keys(stats).forEach(stat => {
            const btnDecrease = document.querySelector(`button[onclick="adjustStat('${stat}', -1)"]`);
            const btnIncrease = document.querySelector(`button[onclick="adjustStat('${stat}', 1)"]`);

            if (btnDecrease) btnDecrease.disabled = stats[stat] <= baseStats[stat];
            if (btnIncrease) btnIncrease.disabled = stats[stat] >= maxStatValue || pointsRemaining <= 0;
        });
    }

    window.adjustStat = function (stat, change) {
        let newValue = stats[stat] + change;

        if (change > 0 && pointsRemaining > 0 && newValue <= maxStatValue) {
            stats[stat] = newValue;
            pointsRemaining -= change;
        } else if (change < 0 && newValue >= baseStats[stat]) {
            stats[stat] = newValue;
            pointsRemaining -= change;
        } else {
            return; // invalide : ne rien faire
        }

        updateStatDisplay(stat);
        updatePointsRemainingDisplay();
        updateButtons();

        // Mise à jour DES variables Harlowe directement (clé de la synchro)
        $strength = stats.strength;
        $intelligence = stats.intelligence;
        $luck = stats.luck;
        $charisma = stats.charisma;
        $pointExp = pointsRemaining;

        // Ta fonction custom si elle existe
        if (typeof mettreAJourStatsDepuisObjetsEquipes === "function") {
            mettreAJourStatsDepuisObjetsEquipes();
        }
    };

    // Fonction pour charger les variables Harlowe dans JS (à appeler après load-game)
    window.loadCharacterStateFromHarlowe = function() {
        stats.strength = $strength;
        stats.intelligence = $intelligence;
        stats.luck = $luck;
        stats.charisma = $charisma;
        pointsRemaining = $pointExp;

        updateAllStatDisplays();
        updatePointsRemainingDisplay();
        updateButtons();
    };

    // Initialisation à la création (chargement des valeurs depuis Harlowe)
    window.loadCharacterStateFromHarlowe();

    // Fonctions publiques utiles
    window.getPointsRemaining = () => pointsRemaining;
    window.setPointsRemaining = function (points) {
        pointsRemaining = points;
        $pointExp = pointsRemaining;
        updatePointsRemainingDisplay();
        updateButtons();
    };
})();

//!!Fin Menu Carapter
//!--------------------------------------------------------------------------------------------
//!!Menu Inventaire 

//!Affichage Armure complet / equipements 
  document.getElementById("toggle-equipement").addEventListener("click", function () {
    document.getElementById("equipements-section").style.display = "none";
    document.getElementById("equipement-image").style.display = "block";
  });

  document.getElementById("retour-equipement").addEventListener("click", function () {
    document.getElementById("equipements-section").style.display = "flex"; 
    document.getElementById("equipement-image").style.display = "none";
  });
 //!FIN Affichage Armure complet / equipements 
//! Initialisation de l'inventaire 
function setupInventory() {
    draggables = document.querySelectorAll('.item-img');
    containers = document.querySelectorAll('.slot, .inventaireIngame, .iconArmors');
    autoStorageCheckbox = document.querySelector('.toggle input[type="checkbox"]');

    if (autoStorageCheckbox) {
        autoStorageCheckbox.addEventListener('change', autoArrangeItems);
    }
setupDragAndDrop();
loadInventories();
}
//! Fin Initialisation de l'inventaire 

//!génération des inventaires
  function generateSlots() {
    const chest1 = document.getElementById('chest1');
    const chestInventory = document.getElementById('chestInventory');
 
    if (chest1) {
        for (let i = 1; i <= 24; i++) {
            const slot = document.createElement('div');
            slot.className = 'slotChest';
            slot.dataset.slot = i.toString();
            chest1.appendChild(slot);
        }
    }
    
          if (chestInventory) {
        for (let i = 1; i <= 24; i++) {
            const slot = document.createElement('div');
            slot.className = 'slotChest';
            slot.dataset.slot = i.toString();
            chestInventory.appendChild(slot);
        }
    }
    
    }
    generateSlots();
//!Fin génération des inventaires

//! FIN Masquer l'image décorative quand objet équipé


//Affichage total bonus Equipements
function updateStatsFromEquipment() {
    let totalStrength = 0;
    let totalArmor = 0;

    // Parcourt tous les équipements pour accumuler les stats
    document.querySelectorAll('.special-armors .iconArmors').forEach(slot => {
        const item = slot.querySelector('.item-img');
        if (item) {
            totalStrength += parseInt(item.getAttribute('data-strength')) || 0;
            totalArmor += parseInt(item.getAttribute('data-armor')) || 0;
        }
    });

    // Appliquer la force aux dégâts (exemple : 1 Strength = +2 Dégâts)
    let totalDegats = totalStrength; 

    // Mise à jour de l'affichage des stats
    document.querySelector('.statDegatsInfo').textContent = `Strength : ${totalStrength}`;
    document.querySelector('.statArmuresInfo').textContent = `Armor : ${totalArmor}`;
}

// Observer les changements dans les équipements
document.querySelectorAll('.special-armors .iconArmors').forEach(slot => {
    const observer = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
            if (mutation.type === "childList") {
                const hasItem = slot.querySelector('.item-img');
                const decorativeImage = slot.querySelector('.decorative-image');
                
                if (!hasItem && decorativeImage) {
                    decorativeImage.style.display = 'block'; // Réafficher l'image déco
                }
            }
        });
        mettreAJourStatsDepuisObjetsEquipes()
        updateStatsFromEquipment();
    });
    observer.observe(slot, { childList: true });
});
// Met à jour les stats au chargement
mettreAJourStatsDepuisObjetsEquipes()
updateStatsFromEquipment();
//FIN Affichage total bonus Equipements


//! Chargement des sauvegarde local des inventaires 
    function loadInventories() {
        var sidebarData = JSON.parse(localStorage.getItem('sidebarInventory'));
        var ingameData = JSON.parse(localStorage.getItem('ingameInventory'));
        var specialArmorData = JSON.parse(localStorage.getItem('specialArmorInventory'));
        var inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory'));

        if (sidebarData && ingameData && specialArmorData && inventoryGridData) {
            var sidebarSlots = document.querySelectorAll('.inventory-slot');
            var ingameSlots = document.querySelectorAll('.inventaireIngame');
            var specialArmorSlots = document.querySelectorAll('.special-armors .iconArmors');
            var inventoryGridSlots = document.querySelectorAll('.inventory-grid .slot');

            sidebarData.forEach(function(item, index) {
                if (item && sidebarSlots[index]) {
                    sidebarSlots[index].appendChild(createItem(
                        item.type,
                        item.src,
                        item.id,
                        item.nom,
                        item.strength,
                        item.durability,
                        item.life,
                        item.armor,
                        item.prix,
                        item.rare,
                        item.money,
                    ));
                }
            });

            ingameData.forEach(function(item, index) {
                if (item && ingameSlots[index]) {
                    ingameSlots[index].appendChild(createItem(
                        item.type,
                        item.src,
                        item.id,
                        item.nom,
                        item.strength,
                        item.durability,
                        item.life,
                        item.armor,
                        item.prix,
                        item.rare,
                        item.money,
                    ));
                }
            });

            if (specialArmorData) {
                specialArmorSlots.forEach((slot, index) => {
                    if (specialArmorData[index]) {
                        slot.appendChild(createItem(
                            specialArmorData[index].type,
                            specialArmorData[index].src,
                            specialArmorData[index].id,
                            specialArmorData[index].nom,
                            specialArmorData[index].strength,
                            specialArmorData[index].durability,
                            specialArmorData[index].life,
                            specialArmorData[index].armor,
                            specialArmorData[index].prix,
                            specialArmorData[index].rare,
                            specialArmorData[index].money,
                        ));
                    }
                });
            }

            if (inventoryGridData) {
                inventoryGridSlots.forEach((slot, index) => {
                    if (inventoryGridData[index]) {
                        slot.appendChild(createItem(
                            inventoryGridData[index].type,
                            inventoryGridData[index].src,
                            inventoryGridData[index].id,
                            inventoryGridData[index].nom,
                            inventoryGridData[index].strength,
                            inventoryGridData[index].durability,
                            inventoryGridData[index].life,
                            inventoryGridData[index].armor,
                            inventoryGridData[index].prix,
                            inventoryGridData[index].rare,
                            inventoryGridData[index].money,
                        ));
                    }
                });
            }
            
        }
    }
//! Fin Chargement des sauvegarde local de inventaires 

//! Rangement automatique 
    function autoArrangeItems() {
        if (!autoStorageCheckbox || !autoStorageCheckbox.checked) return;

        var items = document.querySelectorAll('.slot .item-img');
        var slots = document.querySelectorAll('.slot');
        var itemsByType = {};

        items.forEach(function(item) {
            var type = item.getAttribute('data-type');
            if (!itemsByType[type]) {
                itemsByType[type] = [];
            }
            itemsByType[type].push(item);
        });

        slots.forEach(function(slot) {
            if (slot.children.length > 0) {
                slot.innerHTML = '';
            }
            synchronizeInventories();
        });

        var currentSlotIndex = 0;
        Object.keys(itemsByType).forEach(function(type) {
            itemsByType[type].forEach(function(item) {
                while (currentSlotIndex < slots.length) {
                    var slot = slots[currentSlotIndex];
                    if (slot.children.length === 0) {
                        slot.appendChild(item);
                        currentSlotIndex++;
                        break;
                    }
                    currentSlotIndex++;
                }
            });
        });
         if (window.sfxEnabled) {
    let sfxAudio = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/rangement.wav");
    sfxAudio.volume = window.sfxVolume;
    sfxAudio.play();
}
        synchronizeInventories();
    }
//! Fin Rangement automatique 
  
//! Gestion du glisser-déposer 
    function setupDragAndDrop() {
        draggables.forEach(function(draggable) {
            draggable.addEventListener('mousedown', startDragging);
            draggable.addEventListener('touchstart', startDragging, {passive: false});
        });
    }
//! Fin Gestion du glisser-déposer 
  
//! Début du glissement d'un objet 
function startDragging(e) {
  e.preventDefault();

  // Détermine les coordonnées selon le type d'événement (souris ou tactile)
  let clientX, clientY;
  if (e.type.startsWith('touch')) {
    clientX = e.touches[0].clientX;
    clientY = e.touches[0].clientY;
  } else {
    clientX = e.clientX;
    clientY = e.clientY;
  }

  var draggable = this;
  var rect = draggable.getBoundingClientRect();
  var startX = clientX - rect.left;
  var startY = clientY - rect.top;
  var originalParent = draggable.parentElement || null;

  // Créer une copie de l'élément pour le déplacement
  var draggedCopy = draggable.cloneNode(true);
  draggedCopy.style.position = 'fixed';
  draggedCopy.style.zIndex = '999999';
  draggedCopy.style.pointerEvents = 'none';
  draggedCopy.style.width = rect.width + 'px';
  draggedCopy.style.height = rect.height + 'px';
  document.body.appendChild(draggedCopy);

  // Cacher l'élément original pendant le glissement
  draggable.style.visibility = 'hidden';

  function moveItem(moveEvent) {
    let moveClientX, moveClientY;
    if (moveEvent.type.startsWith('touch')) {
      moveClientX = moveEvent.touches[0].clientX;
      moveClientY = moveEvent.touches[0].clientY;
    } else {
      moveClientX = moveEvent.clientX;
      moveClientY = moveEvent.clientY;
    }
    var x = moveClientX - startX;
    var y = moveClientY - startY;
    draggedCopy.style.left = x + 'px';
    draggedCopy.style.top = y + 'px';
  }

  function stopDragging(endEvent) {
    // Supprimer les écouteurs d'événements
    document.removeEventListener('mousemove', moveItem);
    document.removeEventListener('mouseup', stopDragging);
    document.removeEventListener('touchmove', moveItem);
    document.removeEventListener('touchend', stopDragging);

    // Déplacer l'objet au lieu de le copier
    if (container && container !== originalParent) {
        // Supprimer l'élément original de son parent
        if (originalParent && originalParent.contains(draggable)) {
            originalParent.removeChild(draggable);
        }

        // Vérifier si le conteneur cible est vide avant d'ajouter
        if (container.children.length === 0 || container.classList.contains('zonesuppression')) {
            container.appendChild(draggable);
        } else {
            // Échanger les items si le slot cible est occupé
            const existingItem = container.querySelector(':scope > .item-img');
            if (existingItem) {
                originalParent.appendChild(existingItem);
            }
            container.appendChild(draggable);
        }

        // Forcer une synchronisation immédiate
        mettreAJourStatsDepuisObjetsEquipes();
        synchronizeInventories();
    }
    
      if (originalParent && originalParent.classList.contains('inventory-slot')) {
        const index = Array.from(originalParent.parentNode.children).indexOf(originalParent);
        const ingameSlot = document.querySelectorAll('.inventaireIngame')[index];
        if (ingameSlot) ingameSlot.innerHTML = '';
    }
    
    // Supprimer la copie de l'élément
    if (draggedCopy && draggedCopy.parentElement) {
      document.body.removeChild(draggedCopy);
    }

    // Rendre l'élément original à nouveau visible
    draggable.style.visibility = 'visible';

    let endClientX, endClientY;
    if (endEvent.type.startsWith('touch')) {
      endClientX = endEvent.changedTouches[0].clientX;
      endClientY = endEvent.changedTouches[0].clientY;
    } else {
      endClientX = endEvent.clientX;
      endClientY = endEvent.clientY;
    }

    // Trouver la cible de dépôt
    var dropTarget = document.elementFromPoint(endClientX, endClientY);
     var container = dropTarget ? dropTarget.closest('.slot, .inventaireIngame, .iconArmors, .zonesoin, .zonesuppression, .inventory-slot') : null;

  if (!container) {
    if (originalParent) {
      originalParent.appendChild(draggable);
    }
    return;
  }
  
//Affichage texte a la souris
var zonesoinElements = document.querySelectorAll('.zonesoin');
// Pour chaque élément, ajoute un écouteur d'événement "mouseenter"
zonesoinElements.forEach(function(zone) {
  zone.addEventListener('mouseenter', function() {
    zone.setAttribute('title', 'Put your potion');
  });
});

document.querySelectorAll('.zonesuppression').forEach(zone => {
    zone.addEventListener('mouseenter', function() {
        this.setAttribute('title', 'Drag here to delete item');
    });
});



 // ✅ Gestion spécifique pour la zone de suppression
    if (container.classList.contains('zonesuppression')) {
    if (confirm("Delete this item permanently?")) {
        draggable.remove();
        
      if (originalParent.classList.contains('inventory-slot')) {
        const sidebarSlots = Array.from(document.querySelectorAll('.inventory-slot'));
        const idx = sidebarSlots.indexOf(originalParent);
        const ingameSlots = document.querySelectorAll('.inventaireIngame');
        if (ingameSlots[idx]) ingameSlots[idx].innerHTML = '';
      }
       if (window.sfxEnabled) {
            let sfxAudio = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/suppression.mp3");
            sfxAudio.volume = window.sfxVolume; 
            sfxAudio.play();
        }
         synchronizeInventories();
    } else if (originalParent) {
        originalParent.appendChild(draggable);
    }
    return;
}

// ❌ Si l'objet est lâché en dehors d'un conteneur valide
if (!container || container === originalParent) {
if (window.sfxEnabled) {
    let refusalSound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/refus.mp3");
    refusalSound.volume = window.sfxVolume;
    refusalSound.play();
}
  if (originalParent) {
    originalParent.appendChild(draggable);
  }
  return;
}


if (container && container !== originalParent) {
    var allowedType = container.getAttribute('data-type');
    var itemType = draggable.getAttribute('data-type');

    // Vérifier si le conteneur a déjà un objet
    var existingItem = container.querySelector('.item-img:not(.decorative-image)');

    // ❌ Type non autorisé
    if (allowedType !== 'any' && allowedType !== itemType) {
      if (window.sfxEnabled) {
            let refusalSound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/refus.mp3");
            refusalSound.volume = window.sfxVolume;
            refusalSound.play();
        }
        originalParent.appendChild(draggable);
        return;
    }
    
      if (existingItem) {
        // Déplacer l'objet existant vers l'emplacement d'origine
        originalParent.appendChild(existingItem);
    }

    // Déplacer le nouvel objet dans le conteneur
    container.appendChild(draggable);
    if (window.sfxEnabled) {
      let possessionSound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/possageobjet.wav");
      possessionSound.volume = window.sfxVolume;
      possessionSound.play();
    }
    // Gestion du rangement automatique
    if (autoStorageCheckbox?.checked && container.classList.contains('slot')) {
        setTimeout(autoArrangeItems, 100);
    }
    
if (container.classList.contains('iconArmors')) {
  // Vérification du type et potentielle gestion de l’équipement existant...
  container.appendChild(draggable);
  let decorative = container.querySelector('.decorative-image');
  if (decorative) {
    decorative.style.display = 'none';
    console.log("Masquage forcé de l'image déco lors du premier drop.");
  }
}


   if (allowedType === 'any' || allowedType === itemType) {
    // Vérifier que l'élément est encore enfant de son parent original avant de le supprimer
    if (originalParent && typeof originalParent.contains === 'function' && draggable) {
    
      if (originalParent.contains(draggable)) {
        try {
          originalParent.removeChild(draggable);
        } catch (error) {
          console.error("Erreur lors de la suppression de l'élément :", error);
        }
      } else {
        console.log("L'élément n'est plus un enfant du parent original.");
      }
    } else {
      console.warn("originalParent est null ou ne contient pas l'élément.");
    }

    // ✅ Gestion spécifique pour la zone de soin (potions)
    if (container.classList.contains('zonesoin')) {
      let lifeValue = parseInt(draggable.getAttribute('data-life')) || 0;
      let updatedHealth = applyHealing(lifeValue);
      if (updatedHealth === false) {
    	if (window.sfxEnabled) {
              let refusalSound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/refus.mp3");
              refusalSound.volume = window.sfxVolume;
              refusalSound.play();
          }

        // Redonne la potion à l'inventaire si la guérison échoue
        if (originalParent) {
          originalParent.appendChild(draggable);
        }
      } else {
        // Supprime l'élément après utilisation
        draggable.remove();
          if (originalParent.classList.contains('inventory-slot')) {
        const sidebarSlots = Array.from(document.querySelectorAll('.inventory-slot'));
        const idx = sidebarSlots.indexOf(originalParent);
        const ingameSlots = document.querySelectorAll('.inventaireIngame');
        if (ingameSlots[idx]) ingameSlots[idx].innerHTML = '';
      }
      }
    } 


// ✅ Gestion des équipements (iconArmors) AVEC ÉCHANGE AUTOMATIQUE
else if (container.classList.contains('iconArmors')) {
  var armorType = container.getAttribute('data-type');

  if (armorType !== itemType) {
    // ❌ L'objet n'est pas du bon type → Refus + retour à l'inventaire
  if (window.sfxEnabled) {
    let refusalSound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/refus.mp3");
    refusalSound.volume = window.sfxVolume;
    refusalSound.play();
}

    if (originalParent) {
      originalParent.appendChild(draggable);
    }
    return;
  }

  // ✅ Vérifie si un objet est déjà équipé dans le slot
  let existingItem = container.querySelector('.item-img:not(.decorative-image)');
  if (existingItem) {
    if (originalParent) {
      originalParent.appendChild(existingItem); // Remet l'ancien objet dans l'inventaire
    }
  }

  // ✅ Équipe le nouvel objet
  container.appendChild(draggable);
  
if (window.sfxEnabled) {
    let equipSound = new Audio("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/bruitages/equiper.wav");
    equipSound.volume = window.sfxVolume;
    equipSound.play();
}


  // 🔥 Met à jour l'affichage des images décoratives
  observeEquipmentChanges();
}

// ✅ Autres conteneurs normaux (inventaire, équipements…)
else {
  container.appendChild(draggable);
}

function observeEquipmentChanges() {
    document.querySelectorAll('.iconArmors').forEach(slot => {
        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                if (mutation.type === "childList") {
                    const hasItem = slot.querySelector('.item-img:not(.decorative-image)');
                    const decorativeImage = slot.querySelector('.decorative-image');

                    if (decorativeImage) {
                        decorativeImage.style.display = hasItem ? 'none' : 'block';
                    }
                }
            });
        });
        observer.observe(slot, { childList: true });
    });
}

// Appelle l'observateur au chargement et après chaque mise à jour
observeEquipmentChanges();


        // Gestion du rangement automatique
        if (typeof autoStorageCheckbox !== 'undefined' && autoStorageCheckbox.checked && container.classList.contains('slot')) {
          setTimeout(autoArrangeItems, 100);
        }
      }
    }

    // Synchroniser les inventaires et mettre à jour les statistiques
    synchronizeInventories();
    updateStatsFromEquipment();
  }

  // Ajouter les écouteurs d'événements pour souris et tactile
  document.addEventListener('mousemove', moveItem);
  document.addEventListener('mouseup', stopDragging);
  document.addEventListener('touchmove', moveItem, { passive: false });
  document.addEventListener('touchend', stopDragging);
}

//! FIN Début du glissement d'un objet 
//! Applique la guérison et retourne la nouvelle santé 
function applyHealing(amount) {
    console.log(`Healing for ${amount} points`);

    const barFill = document.getElementById("bar-fill");
    const barText = document.getElementById("bar-text");

    let currentHealth = parseInt(localStorage.getItem('playerHealth')) || parseInt(barText.textContent) || 0;
    let maxHealth = parseInt(localStorage.getItem('playerMaxHealth')) || $maxHealth || 100; // Utilisation de $maxHealth

    let newHealth = Math.min(currentHealth + amount, maxHealth);

    // Mise à jour de la santé et sauvegarde dans localStorage
    localStorage.setItem('playerHealth', newHealth);
    barFill.style.width = (newHealth / maxHealth) * 100 + "%"; // Adaptation à maxHealth
    barText.textContent = `${newHealth} / ${maxHealth}`;

    // Mise à jour de la barre de vie avec des couleurs spécifiques
    barFill.style.background = "";
    setTimeout(() => {
        if (newHealth >= maxHealth * 0.8) {
            barFill.style.background = "linear-gradient(90deg, #44ff44 0%, #44ff8f 100%)";
        } else if (newHealth >= maxHealth * 0.4) {
            barFill.style.background = "linear-gradient(90deg, #ffaa44 0%, #ffdd44 100%)";
        } else {
            barFill.style.background = "linear-gradient(90deg, #ff4444 0%, #ff8f44 100%)";
        }
    }, 10);

    return newHealth; 
}
//! FIN Applique la guérison et retourne la nouvelle santé 




//! Création d'un nouvel objet 
window.createItem = function(type, imgSrc, id, nom, strength, durability, life, armor, prix, rare, money) {
    var img = document.createElement('img');
    img.src = imgSrc;
    img.className = 'item-img';
        img.setAttribute('data-id', id);
    img.setAttribute('draggable', 'true');
    img.setAttribute('data-type', type);
    img.setAttribute('data-nom', nom);

    // Attributs optionnels
    if (strength !== undefined) {img.setAttribute('data-strength', strength);}
    if (durability !== undefined) {img.setAttribute('data-durability', durability);}
    if (life !== undefined) {img.setAttribute('data-life', life);}
    if (armor !== undefined) {img.setAttribute('data-armor', armor);}
    if (prix !== undefined) {img.setAttribute('data-prix', prix);}
    if (rare !== undefined) {img.setAttribute('data-rare', rare);}
    if (money !== undefined) {img.setAttribute('data-money', money);}
    

    // Ajouter l'événement mouseenter pour afficher l'infobulle
    img.addEventListener('mouseenter', function(event) {
        showTooltip(event, img);
    });

      img.addEventListener('mousedown', startDragging);
      img.addEventListener('touchstart', startDragging, { passive: false });

    
    return img;
};
//! Fin Création d'un nouvel objet 

//! Affichage infobulle 
window.showTooltip = function(event, itemElement) {
  // Vérifie si l'élément ciblé est bien une image
  if (!itemElement.classList.contains('item-img')) return;

  // Empêche le comportement par défaut
  if (event.cancelable) event.preventDefault();

  // Supprime toute tooltip existante
  document.querySelectorAll('.tooltip').forEach(el => el.remove());

  // Crée et configure l'élément tooltip
  const tooltip = document.createElement('div');
  tooltip.className = 'tooltip';
  tooltip.style.position = 'absolute';
  tooltip.style.color = '#fff';
  tooltip.style.padding = '8px';
  tooltip.style.borderRadius = '5px';
  tooltip.style.fontSize = '12px';
  tooltip.style.zIndex = '999991';
  tooltip.style.border = '1px solid rgba(255, 255, 255, 0.5)';
  tooltip.style.boxShadow = '0px 4px 6px rgba(0, 0, 0, 0.1)';
  tooltip.style.display = 'block';

  // Construit le contenu de la tooltip à partir des attributs de l'image
  let content = '';
  function addAttribute(label, attribute) {
    const value = itemElement.getAttribute(attribute);
    if (value && value.trim() !== '' && value.toLowerCase() !== 'null') {
      content += `<strong>${label}:</strong> ${value}<br>`;
    }
  }
  addAttribute('Nom', 'data-nom');
  addAttribute('Type', 'data-type');
  addAttribute('Strength', 'data-strength');
  addAttribute('Durability', 'data-durability');
  addAttribute('Life', 'data-life');
  addAttribute('Armor', 'data-armor');
  addAttribute('Prix', 'data-prix');
  addAttribute('Rare', 'data-rare');
  addAttribute('Money', 'data-money');

  if (!content) return;
  tooltip.innerHTML = content;

  // Récupère les coordonnées de l'événement
  let clientX, clientY;
  if (event.touches && event.touches.length > 0) {
    clientX = event.touches[0].clientX;
    clientY = event.touches[0].clientY;
  } else {
    clientX = event.clientX;
    clientY = event.clientY;
  }
  tooltip.style.left = (clientX + 10) + 'px';
  tooltip.style.top = (clientY + 10) + 'px';

  // Définit la couleur de fond selon la rareté
  const rarityMap = {
    'Common': 'rgb(137 134 134)',
    'Uncommon': '#00bfff',
    'Rare': '#008000',
    'Epic': '#ffa500',
    'Legendary': '#ff0000',
    'Mythic': '#9400d3'
  };
  const rareValue = itemElement.getAttribute('data-rare') || 'Common';
  tooltip.style.backgroundColor = rarityMap[rareValue] || '#ccc';

  // Ajoute la tooltip au document
  document.body.appendChild(tooltip);

  // Si c'est un appareil desktop (pas tactile)
  if (!("ontouchstart" in window || navigator.maxTouchPoints > 0)) {
    // Met à jour la position de la tooltip au déplacement de la souris
    function onMove(e) {
      tooltip.style.left = (e.clientX + 10) + 'px';
      tooltip.style.top = (e.clientY + 10) + 'px';
    }
    document.addEventListener('mousemove', onMove);
    itemElement.addEventListener('mouseleave', function removeTooltip() {
      tooltip.remove();
      document.removeEventListener('mousemove', onMove);
    }, { once: true });
  }

  if ("ontouchstart" in window || navigator.maxTouchPoints > 0) {
    setTimeout(function() {
      if (tooltip.parentNode) {
        tooltip.remove();
      }
    });
  }
};

// Appliquer l'événement sur les images uniquement
document.addEventListener('mouseover', function(event) {
  if (event.target.classList.contains('item-img')) {
    showTooltip(event, event.target);
  }
});

document.addEventListener('touchstart', function(event) {
  if (event.target.classList.contains('item-img')) {
    showTooltip(event, event.target);
  }
}, { passive: false });

//! Fin Affichage infobulle

//!Actualisation des deux barre inventaire  
function synchronizeInventories() {
    const sidebarSlots = document.querySelectorAll('.inventory-slot');
    const ingameSlots = document.querySelectorAll('.inventaireIngame');
    const specialArmorSlots = document.querySelectorAll('.special-armors .iconArmors');
    const inventoryGridSlots = document.querySelectorAll('.inventory-grid .slot');

    const sidebarData = [];
    const ingameData = [];
    const specialArmorData = [];
    const inventoryGridData = [];

    // Nettoyer d'abord tous les emplacements du sidebar
    sidebarSlots.forEach(slot => {
        while (slot.firstChild) {
            slot.removeChild(slot.firstChild);
        }
    });
//!Fin Actualisation des deux barre inventaire 

//! Synchronisation inventaire jeu → sidebar 
ingameSlots.forEach((ingameSlot, index) => {
    const sidebarSlot = sidebarSlots[index];
    const ingameItem = ingameSlot.querySelector('.item-img');

  if (ingameItem) {
            // Copier de l'inventaire en jeu vers le sidebar
            const newItem = createItem(
                ingameItem.getAttribute('data-type'),
                ingameItem.src,
                ingameItem.getAttribute('data-id'),
                ingameItem.getAttribute('data-nom'),
                ingameItem.getAttribute('data-strength'),
                ingameItem.getAttribute('data-durability'),
                ingameItem.getAttribute('data-life'),
                ingameItem.getAttribute('data-armor'),
                ingameItem.getAttribute('data-prix'),
                ingameItem.getAttribute('data-rare'),
                ingameItem.getAttribute('data-money'),
            );
            sidebarSlot.appendChild(newItem);

        // Collecter les données pour LocalStorage
        const itemData = {
                type: ingameItem.getAttribute('data-type'),
                src: ingameItem.src,
                id: ingameItem.getAttribute('data-id'),
                nom: ingameItem.getAttribute('data-nom'),
                strength: ingameItem.getAttribute('data-strength'),
                durability: ingameItem.getAttribute('data-durability'),
                life: ingameItem.getAttribute('data-life'),
                armor: ingameItem.getAttribute('data-armor'),
                prix:ingameItem.getAttribute('data-prix'),
                rare:ingameItem.getAttribute('data-rare'),
                money:ingameItem.getAttribute('data-money'),
            };
        ingameData[index] = itemData;
        sidebarData[index] = itemData;
    } else {
        // Aucun objet dans cet emplacement
        ingameData[index] = null;
        sidebarData[index] = null;
    }
});
//! Fin Synchronisation inventaire jeu → sidebar 
    
     //! Collecte des données pour special-armors 
    specialArmorSlots.forEach((slot, index) => {
            const item = slot.querySelector('.item-img');
            if (item) {
                specialArmorData[index] = {
                    type: item.getAttribute('data-type'),
                    src: item.src,
                    id: item.getAttribute('data-id'),
                    nom: item.getAttribute('data-nom'),
                    strength: item.getAttribute('data-strength'),
                    durability: item.getAttribute('data-durability'),
                    life: item.getAttribute('data-life'),
                    armor: item.getAttribute('data-armor'),
                    prix: item.getAttribute('data-prix'),
                    rare: item.getAttribute('data-rare'),
                    money: item.getAttribute('data-money'),
                };
            } else {
                specialArmorData[index] = null;
            }
        });
    //! Fin collecte special-armors 

  //! Collecte des données pour inventory-grid 
    inventoryGridSlots.forEach((slot, index) => {
            const item = slot.querySelector('.item-img');
            if (item) {
                inventoryGridData[index] = {
                    type: item.getAttribute('data-type'),
                    src: item.src,
                    id: item.getAttribute('data-id'),
                    nom: item.getAttribute('data-nom'),
                    strength: item.getAttribute('data-strength'),
                    durability: item.getAttribute('data-durability'),
                    life: item.getAttribute('data-life'),
                    armor: item.getAttribute('data-armor'),
                    prix: item.getAttribute('data-prix'),
                    rare: item.getAttribute('data-rare'),
                    money: item.getAttribute('data-money'),
                };
            } else {
                inventoryGridData[index] = null;
            }
        });
    //! Fin collecte inventory-grid 
    
    //! Sauvegarde des données dans LocalStorage 
        localStorage.setItem('sidebarInventory', JSON.stringify(sidebarData));
        localStorage.setItem('ingameInventory', JSON.stringify(ingameData));
        localStorage.setItem('specialArmorInventory', JSON.stringify(specialArmorData));
        localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));
    //! Fin Sauvegarde 
    setupDragAndDrop();
}
//!FIN Actualisation des deux barre inventaire 


   window.initializeGameInterface();
      //!!FIN Menu Inventaire 

//!Fonction pour synchroniser les deux inventaires (coffre / inventaire)
let inventoryObserver = null;
let chestObserver = null;
let isSyncing = false;

//? Fonction pour synchroniser l'Inventaire → Coffre
function SynchroInventaireCoffre() {
    if (isSyncing) return;
    isSyncing = true;

    const inventoryGrid = document.querySelector('.inventory-grid');
    const inventoryPlayerChest = document.getElementById('chestInventory');

    if (!inventoryGrid || !inventoryPlayerChest) return;

    if (chestObserver) chestObserver.disconnect();

    inventoryPlayerChest.innerHTML = '';

    inventoryGrid.querySelectorAll('.slot').forEach(slot => {
        const item = slot.querySelector('.item-img');

        const newSlot = document.createElement('div');
        newSlot.className = 'slotChest';
        newSlot.dataset.slot = slot.dataset.slot;

        if (item) {
            const newItem = item.cloneNode(true);
            newItem.classList.remove('dragging'); // Empêcher l'effet visuel restant
            newSlot.appendChild(newItem);
        }

        inventoryPlayerChest.appendChild(newSlot);
    });

    setupDragAndDropForChest();

    setTimeout(() => {
        if (chestObserver) chestObserver.observe(inventoryPlayerChest, { childList: true, subtree: true });
        isSyncing = false;
    }, 100);
}
//? FIN Fonction pour synchroniser l'Inventaire → Coffre

//? Fonction pour synchroniser le Coffre → Inventaire
function SynchroCoffreInventaire() {
    if (isSyncing) return;
    isSyncing = true;

    const inventoryGrid = document.querySelector('.inventory-grid');
    const inventoryPlayerChest = document.getElementById('chestInventory');

    if (!inventoryGrid || !inventoryPlayerChest) return;

    if (inventoryObserver) inventoryObserver.disconnect();

    inventoryGrid.innerHTML = '';

    inventoryPlayerChest.querySelectorAll('.slotChest').forEach(slot => {
        const item = slot.querySelector('.item-img');

        const newSlot = document.createElement('div');
        newSlot.className = 'slot';
        newSlot.dataset.slot = slot.dataset.slot;

        if (item) {
            const newItem = item.cloneNode(true);
            newItem.classList.remove('dragging');
            newSlot.appendChild(newItem);
        }

        inventoryGrid.appendChild(newSlot);
    });

    setupDragAndDropForInventory();

    setTimeout(() => {
        if (inventoryObserver) inventoryObserver.observe(inventoryGrid, { childList: true, subtree: true });
        isSyncing = false;
        synchronizeInventories();
    }, 100);
}
//? FIN Fonction pour synchroniser le Coffre → Inventaire

//? Initialisation de la synchronisation de l'inventaire du joueur
function initializeInventorySync() {
    const inventoryGrid = document.querySelector('.inventory-grid');
    if (!inventoryGrid) return;

    inventoryObserver = new MutationObserver(SynchroInventaireCoffre);
    inventoryObserver.observe(inventoryGrid, { childList: true, subtree: true });

    SynchroInventaireCoffre();
}
//? FIN Initialisation de la synchronisation de l'inventaire du joueur

//? Initialisation de la synchronisation du coffre
function initializeChestSync() {
    const inventoryPlayerChest = document.getElementById('chestInventory');
    if (!inventoryPlayerChest) return;

    chestObserver = new MutationObserver(SynchroCoffreInventaire);
    chestObserver.observe(inventoryPlayerChest, { childList: true, subtree: true });
synchronizeInventories();
    SynchroCoffreInventaire();
}
//?FIN Initialisation de la synchronisation du coffre

//? Fonction pour configurer le glisser-déposer pour l'inventaire du coffre
function setupDragAndDropForChest() {
    const inventoryPlayerChest = document.getElementById('chestInventory');
    if (!inventoryPlayerChest) return;

    const draggables = inventoryPlayerChest.querySelectorAll('.item-img');
    const slots = inventoryPlayerChest.querySelectorAll('.slotChest');

    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', e => {
            draggable.classList.add('dragging');
            e.dataTransfer.setData("text/plain", draggable.dataset.itemId || ""); 
        });

        draggable.addEventListener('dragend', () => {
            draggable.classList.remove('dragging');
            setTimeout(SynchroInventaireCoffre, 100); 
        });
    });

    slots.forEach(slot => {
        slot.addEventListener('dragover', e => {
            e.preventDefault();
            const draggable = document.querySelector('.dragging');
            if (draggable && !slot.querySelector('.item-img')) {
                slot.appendChild(draggable);
            }
        });
    });
}
//?FIN Fonction pour configurer le glisser-déposer pour l'inventaire du coffre

//? Fonction pour configurer le glisser-déposer pour l'inventaire principal
function setupDragAndDropForInventory() {
    const inventoryGrid = document.querySelector('.inventory-grid');
    if (!inventoryGrid) return;

    const draggables = inventoryGrid.querySelectorAll('.item-img');
    const slots = inventoryGrid.querySelectorAll('.slot');

    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', e => {
            draggable.classList.add('dragging');
            e.dataTransfer.setData("text/plain", draggable.dataset.itemId || ""); 
        });

        draggable.addEventListener('dragend', () => {
            draggable.classList.remove('dragging');
            setTimeout(SynchroCoffreInventaire, 100);
        });
    });

    slots.forEach(slot => {
        slot.addEventListener('dragover', e => {
            e.preventDefault();
            const draggable = document.querySelector('.dragging');
            if (draggable && !slot.querySelector('.item-img')) {
                slot.appendChild(draggable);
            }
        });
    });
}
//?FIN Fonction pour configurer le glisser-déposer pour l'inventaire principal
initializeInventorySync();
initializeChestSync();
//!Fin  Fonction pour synchroniser les deux inventaires (coffre / inventaire)

//! Fonction Equipements pour statistiques du personnage
function mettreAJourStatsDepuisObjetsEquipes() {
    console.log("🔄 Mise à jour des statistiques depuis les objets équipés...");

    // Initialiser les bonus d'équipement
    let bonusEquipements = {
        strength: 0,
        intelligence: 0,
        luck: 0,
        charisma: 0,
        armor: 0
    };

    // Lire les objets équipés
    document.querySelectorAll('.special-armors .iconArmors').forEach(emplacement => {
        const objet = emplacement.querySelector('.item-img');
        if (objet) {
            bonusEquipements.strength     += parseInt(objet.getAttribute('data-strength'))     || 0;
            bonusEquipements.intelligence += parseInt(objet.getAttribute('data-intelligence')) || 0;
            bonusEquipements.luck         += parseInt(objet.getAttribute('data-luck'))         || 0;
            bonusEquipements.charisma     += parseInt(objet.getAttribute('data-charisma'))     || 0;
            bonusEquipements.armor        += parseInt(objet.getAttribute('data-armor'))        || 0;
        }
    });

    // Ne PAS modifier le contenu texte visible : on le lit !
    document.querySelectorAll('.stat-value').forEach(elementStat => {
        const nomStat = elementStat.id.replace('-value', '');

        // Lire la valeur visible (stat du joueur)
        const statBase = parseInt(elementStat.textContent) || 0;
        const bonus = bonusEquipements[nomStat] || 0;
        const total = statBase + bonus;

        window[`$${nomStat}`] = total;


    });

       window.$totalArmor = bonusEquipements.armor;

    // Met à jour une éventuelle zone dédiée à l'affichage de l’armure (visuel uniquement)
    const armorEl = document.querySelector('.statArmuresInfo');
    if (armorEl) {
        armorEl.textContent = `Armor : ${window.$totalArmor}`;
    }

    console.log("✅ Stats totales avec équipements :", {
        strength:     window.$strength,
        intelligence: window.$intelligence,
        luck:         window.$luck,
        charisma:     window.$charisma,
        armor:        window.$totalArmor
    });
}
// Fonctions pour équiper/déséquiper
function gererEquipementObjet(event) {
    if (event.target.classList.contains('item-img')) {
        console.log(`Objet équipé : ${event.target.getAttribute('data-nom')}`);
        mettreAJourStatsDepuisObjetsEquipes();
    }
}
function gererDesequipementObjet(event) {
    if (event.target.classList.contains('item-img')) {
        console.log(`Objet déséquipé : ${event.target.getAttribute('data-nom')}`);
        mettreAJourStatsDepuisObjetsEquipes();
    }
}

document.querySelectorAll('.special-armors .iconArmors').forEach(emplacement => {
    emplacement.addEventListener('MutationEvent', gererEquipementObjet);
    emplacement.addEventListener('MutationEvent', gererDesequipementObjet);
});

// Initialiser les statistiques de base et variables globales
document.querySelectorAll('.stat-value').forEach(elementStat => {
    const valeurDeBase = parseInt(elementStat.textContent) || 0;
    elementStat.setAttribute('data-valeur-de-base', valeurDeBase);
    const nomStat = elementStat.id.replace('-value', '');
    if (nomStat === 'armor') {
        window.$totalArmor     = window.$totalArmor     || valeurDeBase;
    } else {
        window[`$${nomStat}`] = window[`$${nomStat}`] || valeurDeBase;
    }
    console.log(`Statistique de base initialisée pour ${elementStat.id} : ${valeurDeBase}`);
});

// Premier appel
mettreAJourStatsDepuisObjetsEquipes();

console.log("Statistiques initiales globales :", {
    strength:     window.$strength,
    intelligence: window.$intelligence,
    luck:         window.$luck,
    charisma:     window.$charisma,
    totalArmor:   window.$totalArmor
});

//! FIN Fonction Equipements pour statistiques du personnage


//! Masquer l'image décorative quand objet équipé
(function hideDecorativeImagesOnLoad() {
  document.querySelectorAll('.iconArmors').forEach(slot => {
    // Vérifier s'il y a un objet non décoratif dans le slot
    const item = slot.querySelector('.item-img:not(.decorative-image)');
    if (item) {
      const decorative = slot.querySelector('.decorative-image');
      if (decorative) {
        decorative.style.display = 'none';
      }
    }
  });
})();



  })();
  
  
//Ajoute Money a partir de window
window.updateMoney = function(addAmount) {
    const moneyEl = document.querySelector('.money');
    if (!moneyEl) return;

    // Extraire le texte actuel et convertir en nombre
    const currentText = moneyEl.textContent.trim().replace(/[^\d]/g, '');
    const currentMoney = parseInt(currentText, 10) || 0;
    const newMoney = currentMoney + addAmount;

    // Mettre à jour l'affichage
    const coinIcon = moneyEl.querySelector('i');
    moneyEl.textContent = newMoney + " ";
    if (coinIcon) {
        moneyEl.appendChild(coinIcon);
    }

    // Sauvegarder la nouvelle valeur
    localStorage.setItem('playerMoney', newMoney);
     if (window.State && window.State.variables) {
        window.State.variables.money = newMoney;
    }
};
//FIN Ajoute Money a partir de window
function initHarloweVariables() {
    if (window.State && window.State.variables) {
        // Synchronise l'argent
        const moneyEl = document.querySelector('.money');
        if (moneyEl) {
            const currentText = moneyEl.textContent.trim().replace(/[^\d]/g, '');
            window.State.variables.money = parseInt(currentText) || 0;
        }
        
        // Synchronise les points d'expérience
        const pointsEl = document.getElementById('points-remaining');
        if (pointsEl) {
            window.State.variables.pointExp = parseInt(pointsEl.textContent) || 0;
        }
    }
}
initHarloweVariables();
</script>


:: initMacroPassage {"position":"2300,450","size":"100,100"}
{
(set:$introText to "You lean too far: arms flailing: and nearly topple into the well! You catch yourself, heart pounding, as a gout of chilly mist splashes your face. ")
(set:$clickTest to "splashes your face")
(set:$AttributeTest to $luck)
(set:$SuccessText to "You take a moment to compose yourself...")
(set:$FailureText to "  You hurt your hand while catching yourself...")
(set:$clickDamage to "catching yourself")
(set:$damageType to 1)
(set:$DeathText to "The mist smells faintly of damp earth: and something bitter beneath it. Almost at once your throat constricts, burning as the cold fumes lace your lungs with toxin. You choke and stagger back, vision narrowing to a pinpoint as the poison steals your breath. In a final rasp, the world goes black around you.")
(set:$currentEnding to 22)
(set:$LinkText to "Steady yourself and step back")
(set:$FailureLinkText to "You bandage your hand, steady yourself and step back...")
(set:$Link to "ShroudedWellArrival")

(set:$xpSuccess to 30)
(set:$xpFailure to 60)
(set:$xpDeath to 300)
}
(display:"MacroPassage")


:: objets [startup] {"position":"2500,275","size":"100,100"}
<script>
const items = [
    {
        id: "ShockStick",
        nom: "ShockStickX98",
        type: "sword",
        strength: 5,
        durability: 35,
        class: "item-img",
        draggable: true,
        inventory: "1",
        src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Arms/BatonElectrique.png",
        "prix": 120,
        "rare": "Common"
    },
    {
        id: "soin1",
        nom: "Health Pills",
        type: "soin",
        life: 10,
        class: "item-img",
        draggable: true,
        inventory: "2",
        src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Pills.png",
        "prix": 45,
        "rare": "Common"
    },
    {
        id: "soin1",
        nom: "Health Pills",
        type: "soin",
        life: -5,
        class: "item-img",
        draggable: true,
        inventory: "7",
        src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Pills.png",
        "prix": 25,
        "rare": "Common"
    },
    {
        id: "casque1",
        nom: "astronaut's helmet",
        type: "helmet",
        armor: 3,
        class: "item-img",
        draggable: true,
        inventory: "3",
        src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Casque.png",
        "prix": 90,
        "rare": "Common"
    },
    {
        id: "gloves1",
        nom: "Gloves",
        type: "gloves",
        armor: 1,
        class: "item-img",
        draggable: true,
        inventory: "4",
        src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Equipements/Gloves.png",
        "prix": 60,
        "rare": "Common"
    }
];
/* Fonction pour afficher une infobulle avec les infos de l'item */
function showTooltip(event, img) {
    // Créer ou récupérer l'infobulle existante
    let tooltip = document.querySelector('.tooltip');
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        document.body.appendChild(tooltip);
    }
    
    // Préparer le texte à afficher en fonction des attributs disponibles
    let info = '';
    const nom = img.dataset.nom;
    const strength = img.dataset.strength;
    const durability = img.dataset.durability;
    const life = img.dataset.life;
    const armor = img.dataset.armor;
    const prix = img.dataset.prix;
    const rare = img.dataset.rare;
    const money = img.dataset.money;
    
    if (nom !== undefined) info += "Name: " + nom + "<br>";
    if (strength !== undefined) info += "Strength: " + strength + "<br>";
    if (durability !== undefined) info += "Durability: " + durability + "<br>";
    if (life !== undefined) info += "Life: " + life + "<br>";
    if (armor !== undefined) info += "Armor: " + armor + "<br>";
    if (prix !== undefined) info += "Price: " + prix + "<br>";
    if (rare !== undefined) info += "Rare: " + rare + "<br>";
    if (money !== undefined) info += "Credits: " + money + "<br>";
    
    
    tooltip.innerHTML = info;
    tooltip.style.position = 'absolute';
    tooltip.style.top = (event.pageY + 10) + 'px';
    tooltip.style.left = (event.pageX + 10) + 'px';
    tooltip.style.backgroundColor = '#fff';
    tooltip.style.border = '1px solid #000';
    tooltip.style.padding = '5px';
}

/* Fonction pour supprimer l'infobulle */
function hideTooltip() {
    const tooltip = document.querySelector('.tooltip');
    if (tooltip) {
        tooltip.remove();
    }
}

/* Fonction pour afficher l'inventaire */
function renderInventory(items) {
    const slots = document.querySelectorAll(".slot");

    // Réinitialisation des slots
    slots.forEach(slot => {
        slot.innerHTML = "";
    });

    items.forEach(item => {
        if (item.inventory) {
            const slotIndex = parseInt(item.inventory) - 1;
            const slot = slots[slotIndex];

            if (slot) {
                const img = document.createElement("img");
                img.setAttribute("data-type", item.type);
                img.setAttribute("data-nom", item.nom); 
               
                if (item.strength !== undefined) {
                    img.setAttribute("data-strength", item.strength);
                }
                if (item.durability !== undefined) {
                    img.setAttribute("data-durability", item.durability);
                }
                if (item.life !== undefined) {
                    img.setAttribute("data-life", item.life);
                }
                 if (item.armor !== undefined) {
                    img.setAttribute("data-armor", item.armor);
                }
                  if (item.prix !== undefined) {
                    img.setAttribute("data-prix", item.prix);
                }
                  if (item.rare !== undefined) {
                    img.setAttribute("data-rare", item.rare);
                }
                   if (item.money !== undefined) {
                    img.setAttribute("data-money", item.money);
                }
                img.src = item.src;
                img.className = item.class;
                img.draggable = item.draggable;

                // Ajout des écouteurs d'événements pour afficher/masquer l'infobulle
                img.addEventListener('mouseover', (event) => showTooltip(event, img));
                img.addEventListener('mouseout', hideTooltip);

                slot.appendChild(img);
            }
        }
    });
}

/* Appel de la fonction pour afficher l'inventaire */

</script>


:: stats [startup] {"position":"1825,525","size":"100,100"}
{
(set: $currentEnding to 0)
(set:$endingNumbers to 35)
(set: $heroName to "Frederick Anderson")
(set: $heroNameGravebinder to "Master Lorcan Vale")
(set: $heroNameLanternBearer to "Sister Ailith Mara")
(set: $heroNameOssuaryKnight to "Rourke Belgrave")
(set: $heroNameWhispered to "Marek Slayne")
(set: $heroNamePaleScholar to "Lady Thyrenia Arkwright")
(set: $heroNameExhumed to "Garron Fletch")
(set:$fakeCorvan to false)
(set: $MagisterHeart to false)
(set: $journal to (a: "Diary of"))
<!--(set: $journal to it + (a: $heroName+ "\n\n"))  -->
<!--
(set: $journal to it + (a: "Decoded weeping pattern: Beware Bonepickers"+ "\n\n"))  
-->
<!--(set: $journal to it "Diary of:"+$heroName)-->

(set: $job to 0)
(set: $backStory to 0)
(set: $health to 100)
(set: $maxHealth to 100)

(set: $strength to 10)
(set: $intelligence to 10)
(set: $luck to 10)
(set: $charisma to 10)

(set: $CorvanQuest to false)

(set: $basestrength to 10)
(set: $baseintelligence to 10)
(set: $baseluck to 10)
(set: $basecharisma to 10)
(set: $hasBroom to false)
(set: $broom to 0)
(set: $medKit to 0)

(set: $atkBonus to 5) <!--change depending on class-->

(set: $xp to 0)
(set: $pointExp to 5)
(set: $money to 25)

(set: $hasClaws to false)
(set: $hasAmulet to false)
(set: $galaxyMap to false)
(set:$comFixed to false)
(set:$findANearbyPlanet to false)
(set:$creatureQuest to false)

(set: $alienSarah to false)
(set: $forestBeast to false)
(set: $spiderFight to false)
(set: $caveCreature to false)

(set:$hasBeenPlanet1 to false)



(set:$pointExp to 0)



<script>

<!--   window.initializeGameInterface();-->

</script>


<!--
$money
$maxHealth
$description
$basestrength
$baseluck
$baseintelligence
$basecharisma

-->

}



:: unObjet {"position":"850,125","size":"100,100"}
Un objet
  <script>
  const newItemData = {
        id: "soin1",
        nom: "Healing Potion",
        type: "soin",
        life: 7,
        class: "item-img",
        draggable: true,
        inventory: "23",
        src: "https://pickyouruniverse.com/DataProjects/SpaceshipAccident/imagejeux/Soins/Pills.png",
        "prix": 25,
        "rare": "Common"
  };

    // Création de l'élément via le système du header.html
const itemElement = createItem(
  newItemData.type,
  newItemData.src,
  newItemData.id,
  newItemData.nom,
  newItemData.strength,
  newItemData.durability,
  newItemData.life,
  newItemData.armor,
  newItemData.prix,
  newItemData.rare,
  newItemData.money
);

  itemElement.setAttribute('data-id', newItemData.id);
  itemElement.setAttribute('draggable', 'true');

  const targetSlot = document.getElementById(`slot-${newItemData.inventory}`);

    targetSlot.appendChild(itemElement);

    let inventoryGridData = JSON.parse(localStorage.getItem('inventoryGridInventory')) || Array(24).fill(null);
    inventoryGridData[newItemData.inventory] = {
      id: newItemData.id,
      type: newItemData.type,
      src: newItemData.src,
      nom: newItemData.nom,
      strength: newItemData.strength,
      durability: newItemData.durability,
      life: newItemData.life,
      armor: newItemData.armor,
      prix: newItemData.prix,
      rare: newItemData.rare,
      money: newItemData.money,
    };
    localStorage.setItem('inventoryGridInventory', JSON.stringify(inventoryGridData));

  itemElement.addEventListener('mouseenter', (e) => showTooltip(e, itemElement));
  itemElement.addEventListener('touchstart', (e) => showTooltip(e, itemElement), { passive: false });
</script>
[[Admin]]


:: StoryScript [script]

// Prevent scrolling to the top on passage transition
$(document).on('shown.sm.passage', function (event, passage) {
  window.scrollTo(0, 0);
});

// Keep the scroll position
$(document).on('sm.passage.hidden', function (event, passage) {
  const scrollPos = window.scrollY;
  sessionStorage.setItem('scrollPos', scrollPos);
});

$(document).on('shown.sm.passage', function (event, passage) {
  const scrollPos = sessionStorage.getItem('scrollPos');
  if (scrollPos !== null) {
    window.scrollTo(0, scrollPos);
  }
});



:: StoryStylesheet [stylesheet]
/* Style Global */

.image-container {
  position: relative !important;
  display: flex;
  width: 100%; 
  justify-content: center;
  border-radius: 10px;
  overflow: hidden;
  cursor: pointer;
}

.image-container img {
  top: 0;
  left: 0;
  width: 75%;
  object-fit: cover;
  border-radius: 10px;
  border: 1px solid #ffd700;
  transition: opacity 1.5s ease-in-out;
}

@media (max-width: 768px) {
  .image-container img {
    width: 85%;
  }
}

body {
  margin: 0;
  padding: 0;
  color: #FFF5EE;
}
button{
	background-color: rgba(58, 56, 38, 0.9);
    border: 1px solid #FFD700;
    color: #FFD700;
    border-radius: 8px;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.3s ease;
    width: 100%;
  	height:35px;
}

.cssde{filter: invert(50%) sepia(100%) saturate(300%) hue-rotate(357deg) brightness(110%) contrast(95%);
width:100%;
}

@media (max-width: 768px) {
 .cssde{width:50px;height:50px;}     
}

/*Affiche info objet au mouseover souris*/
.tooltip {
    position: absolute !important;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px;
    border-radius: 5px;
    font-size: 12px;
    z-index: 999;
    pointer-events: none; 
  	font-family: 'DM Sans', sans-serif;
}

tw-link, .enchantment-link { 
  color: #ffd700 !important;

}
/*FIN Affiche info objet au mouseover souris*/
h1{font-size:25px;}
/* Fin Style Global*/

tw-sidebar {height: 0px; display:none;}
tw-story tw-consecutive-br {height: 0px;}
br{height: 0px !important;}

tw-story {
  background-image: url("https://pickyouruniverse.com/DataProjects/SpaceshipAccident/background/ASpaceIncidentBackground.jpg");
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  display: flex;
  flex-direction: column;
}

tw-passage {
  padding: 10px;
  font-family: 'DM Sans', sans-serif;
  font-size: 1.2rem;
  margin-bottom: 2rem;
  background: rgba(0, 0, 0, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 15px;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
  color: #FFF;
  margin: 1rem auto;
  width: calc(100% - 2rem);
}

@media (max-width: 768px) {
  tw-passage {
  font-size: 0.8rem;
  width: calc(100%);  
  margin-bottom: 200px;

}

  tw-story{
    font-size:1rem;
  }
}

/*!Header */

	/*?Bouton map/invent/character*/
    .game-interface {
          height: 100px;
    }
    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-buttons {
      width: 30%;
      display: flex;
      gap: 0.1rem;
    }

    .nav-btn {
      height:25px;
      background-color: rgba(58, 56, 38, 0.9);
      border: 1px solid #FFD700;
      color: #FFD700;
    font-size: 10px;
      border-radius: 20px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.3s ease;
      font-size: 0.6rem;
    }

    .disabled-btn {
        background-color: #950000 !important; 
        border-color: darkred !important;
      	color: #ffffff;
        cursor: not-allowed;
        opacity: 0.7;
    }



/* Animation gain de points d'expérience */
@keyframes pulse {
  0% {
    transform: scale(1);
    background-color: #8b2727;
  }
  50% {
    transform: scale(1.2);
    background-color: #FFD700;
  }
  100% {
    transform: scale(1);
    background-color: #8b2727;
  }
}

.nav-btn.character-animation {
  animation: pulse 0.5s ease-in-out infinite;
}

/* Fin Animation gain de points d'expérience */

    .nav-btn.active {
      background-color: #FFD700;
      color: #000;
    }

    @media (max-width: 768px) {
      .game-interface {
        grid-template-rows: auto auto 1fr;
        gap: 1rem;
      }

      .top-nav{
        flex-direction: column;
      }


      .nav-buttons {
        width: 100%;
        justify-content: space-between;
      }

      .nav-btn {
        width: auto;
        flex: 1;
      }
    }
	  /*?FIN Bouton map/invent/character*/
    /*?Barre points de vie*/
   .progress-bar {
    display: flex;
    align-items: center;
    width: 100%;
    background-color: rgba(58, 56, 38, 0.9);
    padding: 10px;
    border-radius: 20px;
  }
  .health-bar { 
    flex-grow: 1;
    height: 20px;
    background-color: #2a2a2a;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
  }
  .bar-fill {
    width: 100%; 
    height: 100%; 
    background: linear-gradient(90deg, #44ff44 0%, #44ff8f 100%);
    transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
  }
  .bar-text {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    text-align: center;
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
    line-height: 20px;
  }
    .money {
      color: #FFD700;
      font-weight: bold;
      min-width: 50px;
      text-align: right;
    }

  @media (max-width: 768px) {
      .progress-bar {
      width: 100%;
    }
	} 
  /*?Fin Barre points de vie*/
  /*?Block Contenue Menu*/
.content-panel {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 800px;
  max-height: calc(100vh - 20px);
  
  background-color: #2F2F2F;
  border: 2px solid #FFD700;
  border-radius: 8px;
  padding: 8px;
  
  display: none;
  z-index: 99999;

  /* ajout scroll*/
  overflow-y: auto;
}

  .content-panel.active {
    display: block;
  }
  @media (max-width: 768px) {
  .content-panel{
    width: 100%;
  }
}

  .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    border: 2px solid #FFD700;
    border-radius: 4px;
    background-color: transparent;
    color: #FFD700;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .close-btn:hover {
    background-color: #FFD700;
    color: #000;
  }    
}
  /*?Fin Block Contenue Menu*/
/*! Fin Header */

/*!---MenuInventaire---*/
.close-btn {
  float: right;
  background: none;
  border: none;
  color: #FFD700;
  font-size: 24px;
  cursor: pointer;
}

.inventaireHaut {
  display: flex;
  width: 100%;
  gap: 1rem;
  justify-content: center;
  margin-bottom: 20px;
}


.inventaireIngame, .slot, .iconArmors, .zonesoin, .zonesuppression{
  width: 65px;
  height: 65px;
  border: 1px solid rgb(202 138 4 / 0.5);
  border-radius: 8px;
  background-color: rgb(0 0 0 / 72%);
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

.paramBlock{
  display: flex;
  align-content: center;
  justify-content: center;
  gap:15px;
}

.zonesoin{
  background-color: rgb(127 74 29 / 80%);;    
  font-weight: 700;
}
.zonesuppression{
  background-color: rgb(127 29 29 / 0.8);    
  font-weight: 700;
}


.inventaireIngame:hover, .slot:hover, .iconArmors:hover,.zonesoin:hover, .zonesuppression:hover{
  transform: scale(1.2); 
  transition: transform 0.3s ease; 
}

.iconArmors{
  width:70px;
  height:70px;
}

.iconArmors::after {
  content: attr(data-default-icon);
  position: absolute;
  opacity: 0.5;
}

.argentequipements{
  font-size: 0.8rem;
  gap:0.1px;
}
.inventaireBas {
  width: 100%;
  display: flex;
  flex-direction: row;
}

.details-armors{
  display:flex;
  width:100%;
  flex-direction: row;
}

.blockStatsArmures{
    width: 100%;
    height: 40px;
  	padding:1rem;
    border: 1px solid #FFD700;
    border-radius: 8px;
    background-color: rgba(58, 56, 38, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

.statDegats, .statArmures{
  width:50%;
  text-align: center;
  font-size: 0.75rem;
  color: #ffd700;
  font-weight: bold;
}

.blockEquipements{
  display:flex;
  width:100%;
  gap: 5px;
  justify-content: center;
  flex-direction: row;
}

  .special-armors {
    margin-top: 50px;
    width: 30%;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    gap: 0.2rem;
  }

  .igauche, .icentre, .idroite {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
  }

.rangementcotedroit{ 
    display: flex;
    width: 70%;
    flex-direction: column;
  	align-items: center;
}
.inventory-grid {
  margin-top: 20px;
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 1rem;
}

.item-img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  cursor: move;
  border-radius: 8px;
  transition: transform 0.3s ease;
}

/* Animation au survol */
.item-img:hover {
  transform: rotate(5deg);
}

.dragging {
  opacity: 0.5;
}

.RAInventaire{
  display: flex;
  justify-content: center;
  align-items: center;
  gap:15px;
}  

/*Affichage Automatic Storage*/
.RAInventaire {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  margin-top: 15px;
  background-color: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 10px;
  width: fit-content;
  color: #fff;
  font-family: 'DM Sans', sans-serif;
}

.label-text-modern {
  font-size: 16px;
  font-weight: 500;
}

.toggle-modern {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 28px;
}

.toggle-modern input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider-modern {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #999;
  transition: 0.4s;
  border-radius: 34px;
}

.slider-modern::before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 4px;
  bottom: 3px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

.toggle-modern input:checked + .slider-modern {
  background-color: #4caf50;
}

.toggle-modern input:checked + .slider-modern::before {
  transform: translateX(22px);
}


/*FIN Affichage Automatic Storage*/


  @media (max-width: 768px) {
    .inventaireHaut{
      gap:0.3rem;
      margin-bottom:0px;
    }

      .special-armors {
          margin-top: 20px;
      }
    .statDegats, .statArmures{
        font-size: 0.40rem;
      }
    
    .inventory-grid{
      gap:0.4rem; 
    }
        .iconArmors{
          width:60px;
        height:60px;
      }

      .inventaireIngame, .slot, .iconArmors, .zonesoin, .zonesuppression{
          width: 35px;
          height: 35px;
      }
    .argentequipements{
      font-size: 0.4rem;
    }
  }
/*!---Fin MenuInventaire---*/
/*!Menu carapter*/
  #skills-panel {
      background-color: #16332f;
      border: 2px solid #FFD700;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 800px;
      margin: auto;
      color: white;
  }

  .character-title {
      color: #FFD700;
      font-weight: bold;
      text-align: center;
      font-size: 1.5rem;
  }

  .blockcarapter {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
  }

  .character-details {
      width: 100%;
      text-align: center;
  }

  .tableinfoscaracter {
      width: 100%;
      border-collapse: collapse;
      background-color: #1f3a3a;
      padding: 10px;
  }

  .bold-yellow {
      font-weight: bold;
      color: #FFD700;
  }

  .bold-white {
      font-weight: bold;
  }

  .blockinfoPerso {
      display: flex;
      align-items: center;
      gap: 20px;
      width: 100%;
      justify-content: center;
  }

  .portrait {
      width: 200px;
      height:auto;
  }

  .CharacterImg{
    width:100%; 
      border: 2px solid #FFD700;
      background-color: #1f3a3a;
      border-radius: 10px;
  }

  .portrait-description {
      border: 2px solid #FFD700;
      background-color: rgba(26, 46, 42, 0.9);
      padding: 10px;
      color: white;
      width: 80%;
  }

  .stats-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
  }

  .stat-group {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      gap: 1rem;
  }

  .stat-controls {
      display: flex;
      align-items: center;
      gap: 10px;
  }

  .stat-btn {
      width: 30px;
      height: 30px;
      border: 2px solid #FFD700;
      background: transparent;
      color: #FFD700;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .stat-btn:hover {
      background: #FFD700;
      color: #1f3a3a;
  }

  .stat-value {
      width: 40px;
      height: 40px;
      border: 2px solid #FFD700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.2);
      color: white;
  }

  .stat-name {
      color: #FFD700;
      font-size: 1rem;
      font-weight: bold;
      text-transform: uppercase;
  }

  .points-remaining {
      text-align: center;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      border: 2px solid #FFD700;
      font-weight: bold;
      margin-top: 10px;
  }

  .points-value {
      color: #FFD700;
      font-size: 1.5rem;
      font-weight: bold;
  }

.character-stats {
  margin-top: 1em;
}
.character-stats ul {
  list-style: none;
  padding: 0;
}
.character-stats li {
  margin: 0.3em 0;
}

.presCompetences{
  display: flex;
  gap: 50px;
  justify-content: center;
  flex-wrap: wrap;
}

  @media (max-width: 700px) {
      #skills-panel {
          width: 95%;
          padding: 15px;
      }
      .blockcarapter{
        gap:0px;
       }
      .blockinfoPerso {
          gap: 2px;
      }
      .portrait {
          width: 150px;
          height: auto;
      }
      .portrait-description{
        line-height: 1.4;
        font-size: 0.7rem;
       }
      .stat-group {
          flex-direction: column;
          gap: 5px;
      }
      .stat-controls {
          width: 100%;
          justify-content: space-around;
      }
      .character-title {
          font-size: 1.3rem;
      }
      .tableinfoscaracter td {
          padding: 8px;
          font-size: 0.9rem;
      }
  }
/*!Fin menu carapter*/
/*!--- Option ---*/
.conteneur-options{
      display: flex;
    justify-content: center;
}
.options-audio, .options-jeu {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  width: 100%;
}

.option-item {
    display: flex;
  	justify-content: center;
    width: 100%;
    gap: 20px;
    margin-bottom: 15px;
    align-items: center;
}

.option-item-son{
   width: 100%;
  margin-bottom: 15px;
  display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}
.separateur {
  width: 2px;
  background-color: #FFD700;
  height: 150px;
  margin: 0 10px;
  opacity: 0.7;
}
.boutonResetLocalSt{
  background: #ff4444;
  color: white; 
  padding: 8px; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer;
}
label {
  display: block;
  color: #FFD700;
  font-weight: bold;
}

input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: #FFD700;
  margin-bottom: 5px;
}

/* Curseurs de volume */
input[type="range"] {
  width: 100%;
  max-width: 200px;
  height: 6px;
  -webkit-appearance: none;
  background: linear-gradient(to right, #FFD700, #FF4500);
  border-radius: 10px;
  margin-bottom: 5px;
  cursor: pointer;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  background: #3498db;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid white;
}

input[type="range"]::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: #3498db;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid white;
}

.lienSite {
	width:50%;
      font-weight: bold;
    color: #ffd700 !important;
      text-decoration: none;
}

/* Bouton de réinitialisation */

.panel-footer {
    margin-top: 20px;
    width: 100%;
    display: flex;
    border-top: 1px solid rgba(255, 215, 0, 0.3);
    flex-wrap: wrap;
    justify-content: center;
    flex-direction: column;
}


.icon-symbol {
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #333;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-bottom: 5px;
  font-size: 18px;
}

.icon-label {
  font-size: 12px;
}

.autreParametre{
    display: flex;
	flex-wrap: wrap;
  	text-align:center;
    justify-content: center;
     align-content: center;
}

.blockParametre{
	width: 50%;
    display: flex;
    justify-content: center;
}

/*! --- FIN Option --- */
/*!---Choix Perso---*/
  .character-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    max-width: 800px;
    margin: auto;
    padding: 1rem;
  }

  .character-info {
    border: 1px solid #FFD700;
    background-color: rgba(26, 46, 42, 0.9);
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    padding: 1rem;
  }

  .character-title {
    text-align: center;
    font-size: 1.5rem;
    color: #FFD700;
    margin-bottom: 0.5rem;
  }

  .character-rangement {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
  }

  .character-portrait {
    flex: 1;
    max-width: 200px;
    border-radius: 10px;
    overflow: hidden;
  }

  .ImgCharacter {
    width: 100%;
    display: block;
    border-radius: 10px;
  }

  .character-description {
    flex: 2;
    padding: 0.8rem;
    border-radius: 10px;
    font-size: 1rem;
    color: white;
    line-height: 1.5;
  }

  .twine-link {
    display: inline-block;
    margin-top: 0.5rem;
    color: #FFD700;
    font-weight: bold;
    cursor: pointer;
  }

  @media (max-width: 600px) {
    .character-rangement {
      flex-direction: column;
      text-align: center;
    }

    .character-description {
      width: 100%;
    }
  }

/*!---FIN Choix Perso---*/

  .value-change {
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.8rem;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }

  .value-change.visible {
    opacity: 1;
  }

  .value-change.increase {
    color: #00ff00;
  }

  .value-change.decrease {
    color: #ff0000;
  }
/*!Zone Footer*/
  .xp-container {
    position: fixed;
    right: 1rem;
    top: 25%;
    transform: translateY(-60%);
    background-color: rgba(58, 56, 38, 0.9);
    border-radius: 15px;
    padding: 1rem;
    width: 200px;
    transition: transform 0.3s ease-in-out;
  }
  .lvl-xp {
    display: block;
    text-align: center;
    color: white;
    font-size: 1rem; 
    margin-bottom: 0.5rem;
  }

  .xp-bar {
    width: 100%;
    height: 20px;
    background-color: #2a2a2a;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
  }

  .xp-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0; 
    background: linear-gradient(90deg, #98a496 0%, #bdb2c1 100%);
    transition: width 0.3s ease-in-out;
    z-index: 1;
  }

  .bar-text-xp {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.8rem;
    pointer-events: none; 
  }

  .inventory-sidebar {
    position: fixed;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(58, 56, 38, 0.9);
    border-radius: 15px;
    padding: 1rem;
    width: 200px;
    transition: transform 0.3s ease-in-out;
  }

  .classinventory {
	display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    flex-direction: column;
    align-content: center;
  }

    .RangementdivFooter{
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    justify-content: space-evenly
    }

  .inventory-slot {
    width: 40px;
    height:40px;
    border: 1px solid #FFD700;
    border-radius: 8px;
    background-color: rgba(0, 0, 0, 0.3);
  }

  .option-btn {
    background-color: rgba(58, 56, 38, 0.9);
    border: 1px solid #FFD700;
    color: #FFD700;
    padding: 0.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 0.5rem;
  }

  .option-btn:hover {
    background-color: rgba(78, 76, 58, 0.9);
  } 

	.option-btn.active {
      background-color: #FFD700;
      color: #000;
    }

@media (max-width: 768px) {
  .xp-container {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px; 
    padding: 1rem;
    z-index: 1000;
    top: auto; 
    right: auto; 
    margin-bottom: 100px;

  }


    .bar-text-xp {
      margin-bottom:0px;
    }
    
      .inventory-sidebar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      top: auto;
      transform: none;
      width: 100%;
      border-radius: 15px 15px 0 0;
      padding: 1rem;
      z-index: 1000;
      max-height: 40vh;
      overflow-y: auto;
      padding:0px;
    }
    
      .classinventory {
      justify-content: center;
    }
    
  }

  @media (max-width: 425px) {
    .inventory-slot{
      width:25px;
      height:25px;
    }
  }
/*!Fin Zone Footer*/

/*!CSS CHEST*/
        .chest {
            width: 95%;
            position: relative;
            margin: 30px 10px;
        }

        .toggle-view-btn {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom, #2d2d2d, #1a1a1a);
            border: none;
            border-radius: 20px;
            width: 80px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

          .toggle-view-btn.active .toggle-slider {
              background: linear-gradient(to bottom, #ffd700, #e6c200); 
              transform: translateX(35px); 
          }
      .toggle-slider {
          transition: transform 0.3s ease, background 0.3s ease; 
      }

        .inventory-icon, .equipment-icon {
            font-size: 14px;
            z-index: 2;
        }

        .toggle-slider {
            position: absolute;
            left: 5px;
            width: 35px;
            height: 20px;
            background: linear-gradient(to bottom, #ffb142, #e69500);
            border-radius: 15px;
            transition: transform 0.3s ease;
        }

        .chest-content {
            display: flex;
          	flex-wrap: wrap;
            gap: 20px;
            margin-top: 10px;
        }

        .chest-view {
            display: none;
            flex-direction: column;
            gap: 20px;
        }

        .chest-view.active {
          display: flex;
          flex-direction: row;
          justify-content: center;
        }

        /* Style pour le coffre (gauche) */
        .inventoryChest {
            flex: 1;
            background: linear-gradient(135deg, rgba(87, 55, 10, 0.7), 			   rgba(51, 31, 5, 0.7));
            border: 4px solid #8B4513;
            border-radius: 8px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .inventoryChest::before {
            content: "CHEST";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom, #8B4513, #6B3100);
            color: #FFD700;
            padding: 3px 15px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            border: 2px solid #704214;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        /* Style pour l'inventaire du joueur (droite) */
        .inventoryPlayerChest {
            flex: 1;
            background: linear-gradient(135deg, rgba(23, 43, 77, 0.7), rgba(13, 25, 45, 0.7));
            border: 4px solid #2c4a7c;
            border-radius: 8px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .inventoryPlayerChest::before {
            content: "INVENTORY";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom, #2c4a7c, #1a2c4c);
            color: #90c7ff;
            padding: 3px 15px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            border: 2px solid #3a5d96;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .slotChest {
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 5px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        /* Différenciation des slots par conteneur */
        .inventoryChest .slotChest {
            border: 2px solid #b36b00;
            box-shadow: 0 0 5px rgba(179, 107, 0, 0.3);
        }

        .inventoryChest .slotChest:hover {
            border-color: #ffa94d;
            box-shadow: 0 0 8px rgba(255, 169, 77, 0.5);
            transform: scale(1.05);
        }

        .inventoryPlayerChest .slotChest {
            border: 2px solid #3a5d96;
            box-shadow: 0 0 5px rgba(58, 93, 150, 0.3);
        }

        .inventoryPlayerChest .slotChest:hover {
            border-color: #6d9eeb;
            box-shadow: 0 0 8px rgba(109, 158, 235, 0.5);
            transform: scale(1.05);
        }

        /* Style pour la vue équipement */
        .special-armorsCoffre {
            background: linear-gradient(135deg, rgba(42, 21, 58, 0.7), rgba(25, 12, 35, 0.7));
            border: 4px solid #5d3d7d;
            border-radius: 8px;
            padding: 20px;
          	margin:10px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* Animation d'item */
        .slotChest img {
            max-width: 90%;
            max-height: 90%;
            transition: all 0.3s ease;
        }

        .slotChest:hover img {
            transform: scale(1.1) rotate(5deg);
		}

        /* Effet de glow pour indiquer les emplacements actifs */
        .slotChest.active {
            animation: glow 1.5s infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 5px -5px #ffcc00;
            }
            to {
                box-shadow: 0 0 15px 4px #ffcc00;
            }
		}
        /* Tablettes en mode portrait et grands téléphones */
        @media (max-width: 768px) {
            .chest-content {
                flex-direction: column;
                gap: 40px;
            }
            
            .chest-view.active {
                flex-direction: column;
                gap: 40px;
            }
            .toggle-view-btn.active .toggle-slider {
                transform: translateX(25px); 
            }
            .inventoryChest::before, .inventoryPlayerChest::before {
                top: -12px;
                font-size: 12px;
                padding: 2px 12px;
            }
            
            .toggle-view-btn {
                width: 70px;
                height: 26px;
            }
            
            .toggle-slider {
                width: 30px;
                height: 18px;
            }
            
            .inventory-icon, .equipment-icon {
                font-size: 12px;
            }
        }
        
        /* Téléphones mobiles */
        @media (max-width: 576px) {
            .chest {
                padding: 10px;
                margin: 20px 5px;
            }
            
            .inventoryChest, .inventoryPlayerChest {
                padding: 10px;
                gap: 6px;
            }
            
            .slotChest {
                width: 35px;
                height: 35px;
                border-width: 1px;
            }
            
            .inventoryChest::before, .inventoryPlayerChest::before {
                font-size: 10px;
                padding: 2px 8px;
                top: -10px;
            }
            
            .toggle-view-btn {
                width: 60px;
                height: 24px;
            }
            
            .toggle-slider {
                width: 25px;
                height: 16px;
            }
            
            .inventory-icon, .equipment-icon {
                font-size: 10px;
            }
            
            .item-count {
                font-size: 8px;
                padding: 0px 2px;
            }
           
        }
        
     	   /* Très petits téléphones */
        @media (max-width: 375px) {
            .chest {
                padding: 8px;
            }
            
            .inventoryChest, .inventoryPlayerChest {
                padding: 8px;
                gap: 5px;
            }
            
            .slotChest {
                width: 32px;
                height: 32px;
            }
        }
        
/*!Fin Zone Chest*/

/*!Style Combats*/
   #turn-indicator, #combat-log {
    text-align: center;
    padding: 10px;
    border-radius: 22px;
    border: 1px solid gold;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 10px;
    }

    .blockCombats {
        display: flex;
        width: 100%;
        height: 69%;
        align-items: center;
     }

    .Combatscharacter {
        position: absolute;
        width: 20%;
        text-align: center;
        transition: transform 0.3s;
    }

        .damage-popup {
            pointer-events: none;
            user-select: none;
            z-index: 1000;
        }

        @keyframes damageFloat {
            0% { 
                opacity: 1;
                transform: translateY(0);
            }
            100% { 
                opacity: 0;
                transform: translateY(-50px);
            }
        }


    #player { left: 5%; }
    #enemy { right: 5%; }

    .tailleImgCombats{
        width: 100%;
    }

    .character img {
        width: 100%;
        height: auto;
    }

    .hp-bar {
        width: 100%;
        height: 15px;
        background: #444;
        border-radius: 10px;
        margin: 5px 0;
    }

    .hp-fill {
        height: 100%;
        background: #4CAF50;
        border-radius: 10px;
        transition: width 0.3s;
    }

    #actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .action-button {
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        width: 20%;
    }

    .dice-container{
        display: flex;
        flex-direction: row;
        justify-content: center;
        gap: 5px;
    }

    .dice-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

  .affichagePremierPlan{
      position: absolute; 	
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
      align-items: center; 
      z-index: 2000;
  }

    @media (max-width: 768px) {
       .dice-container{
          display: flex;
          justify-content: flex-start;
          width: 90%;
          flex-direction: column;
          align-items: center;
          flex-wrap: nowrap;
      }
        .character {
            width: 25%;
        }
      #combat-container {
    	height: 450px !important;
		}
      
        .action-button {
            font-size: 14px;
            padding: 8px 12px;
            width: 100%;
        }
      
      .blockCombats {
        margin-top: 0px;
      }
    }

    @media (max-width: 480px) {
        #turn-indicator, #combat-log {
            font-size: 18px;
            padding: 8px;
        }
      .hp-text{
        font-size: 0.6rem;
      }
      
      	 .Combatscharacter {
          padding-bottom: 40px;
    	}
        .character {
            width: 30%;
            bottom: 5%;
        }
        .action-button {
            font-size: 12px;
            padding: 6px 10px;
        }
    }

    /* Animations d'attaque */
    .attack-move {
        animation: attackAnimation 0.3s forwards;
    }
    @keyframes attackAnimation {
        0% { transform: translateX(0); }
        50% { transform: translateX(20px); }
        100% { transform: translateX(0); }
    }

    .enemy-attack-move {
        animation: enemyAttackAnimation 0.3s forwards;
    }
    @keyframes enemyAttackAnimation {
        0% { transform: translateX(0); }
        50% { transform: translateX(-20px); }
        100% { transform: translateX(0); }
    }
/*!FIN Style combats*/

/*!Zone Marchand*/
  .MarchandHaut {
      text-align: center;
      margin-bottom: 20px;
  }

  .MarchandHaut h1 {
      font-size: 28px;
      color: #fcd34d;
      margin-bottom: 10px;
      letter-spacing: 1px;
  }

  .gold-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 18px;
      font-weight: 600;
      color: #fbbf24;
  }

  i {
      color: #fcd34d;
  }

  /* Contenu principal */
  .main-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
  }

  @media (min-width: 768px) {
      .main-content {
          flex-direction: row;
      }
  }

  /* Cartes */
  .inventory-card, .merchant-card, .buy-item-details {
      background-color: #2a2a15;
      border: 2px solid #b45309;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      flex: 1;
  }

  .card-header {
      background-color: #b45309;
      padding: 12px;
      text-align: center;
  }

  .card-header h2 {
      font-size: 20px;
      font-weight: bold;
  }

  .card-content {
      padding: 16px;
  }

  /* Inventaire */
  .inventoryPlayerMarchand {
      display: flex;
      position: relative;
      flex-wrap: wrap;
      border-radius: 6px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      gap:10px;
  }

  /* Section marchand */
  .merchant-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex: 1;
  }

  /* Onglets */
  .merchant-tabs {
      display: flex;
      justify-content: center;
      border-bottom: 2px solid #b45309;
      background-color: #2a2a15;
      padding: 20px 16px 0px 20px;
  }

  .tab-button {
      flex: 1;
      gap:10px;
      background-color: #3a3a20;
      color: #fff8e1;
      border: 1px solid #92400e;
      border-bottom: none;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 4px;
      border-radius: 6px 6px 0 0;
  }

  .tab-button:hover {
      background-color: #78350f;
  }

  .tab-button.active {
      background-color: #b45309;
      color: #fff8e1;
      border-color: #b45309;
  }

  .tab-button i {
      font-size: 14px;
  }

  /* Contenu des onglets */
  .tab-content {
      padding: 16px;
  }

  .tab-pane {
      display: none;
  }

  .tab-pane.active {
      display: block;
  }

  .tab-pane h3 {
      font-size: 18px;
      color: #fcd34d;
      margin-bottom: 12px;
  }

  /* Articles du marchand */
  .merchant-items {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
  }

  @media (min-width: 768px) {
      .merchant-items {
          grid-template-columns: repeat(4, 1fr);
      }
  }

  .merchant-item {
      width: 45%;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-wrap: wrap;
      background-color: #3a3a20;
      border: 2px solid #92400e;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.2s;
  }

  .merchant-item:hover {
      border-color: #d97706;
  }

  .merchant-item img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      margin-bottom: 8px;
  }

  .merchant-item h4 {
      font-size: 14px;
      text-align: center;
      color: #fde68a;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
  }

  .merchant-item .price {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
      color: #fcd34d;
      font-size: 12px;
  }

  .merchant-item .price i {
      font-size: 10px;
  }

  /* --- Détails des objets --- */
@media (pointer: coarse) {
  .item-img {
    touch-action: none; 
    user-select: none; 
  }
}
  .item-details, .buy-item-details, .sell-item-details {
      padding: 16px;
      border-top: 2px solid #b45309;
      display: none;
  }

  .item-details.active, .buy-item-details.active, .sell-item-details.active {
      display: block;
  }

  .item-content {
      display: flex;
      align-items: flex-start;
      gap: 16px;
  }

  .item-image {
      background-color: #3a3a20;
      border: 2px solid #92400e;
      border-radius: 6px;
      padding: 4px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .item-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
  }

  .item-info {
      flex: 1;
  }

  .item-info h3 {
      font-size: 18px;
      color: #fcd34d;
      margin-bottom: 4px;
  }

  .item-info p {
      font-size: 14px;
      color: rgba(253, 230, 138, 0.8);
      margin-bottom: 8px;
  }

  .item-price {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #fcd34d;
      font-size: 16px;
      margin-bottom: 12px;
  }

  .item-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
  }

  .btn {
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
  }

  .btn-primary {
      background-color: #b45309;
      color: #fff8e1;
  }

  .btn-primary:hover {
      background-color: #d97706;
  }

  .btn-primary:disabled {
      background-color: #92400e;
      opacity: 0.7;
      cursor: not-allowed;
  }

  .btn-outline {
      background-color: #3a3a20;
      color: #fff8e1;
      border-color: #92400e;
  }

  .btn-outline:hover {
      background-color: #78350f;
  }

  .btn-green {
      background-color: #166534;
      color: #dcfce7;
  }

  .btn-green:hover {
      background-color: #15803d;
  }

  .btn-red {
      background-color: #7f1d1d;
      color: #fee2e2;
  }

  .btn-red:hover {
      background-color: #991b1b;
  }

  /* --- Vente --- */
  .sell-container {
      background-color: #3a3a20;
      border: 2px solid #92400e;
      border-radius: 8px;
      padding: 16px;
  }

  .sell-container p {
      color: #fde68a;
      margin-bottom: 16px;
  }

  .sell-item-content {
    display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-direction: column;
      justify-content: center;
  }

  .sell-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-top: 1px solid rgba(180, 83, 9, 0.5);
      padding-top: 12px;
  }

  .no-selection {
      font-style: italic;
      color: rgba(253, 230, 138, 0.7);
  }

  /* --- Anecdotes --- */
  .anecdote-container {
      background-color: #3a3a20;
      border: 2px solid #92400e;
      border-radius: 8px;
      padding: 24px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
  }

  .anecdote-icon {
      width: 64px;
      height: 64px;
      background-color: #b45309;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .anecdote-icon i {
      font-size: 32px;
      color: #fde68a;
  }

  .anecdote-content {
      flex: 1;
  }

  .anecdote-text {
      font-style: italic;
      color: #fde68a;
      margin-bottom: 16px;
      min-height: 60px;
  }

  .anecdote-button {
      background-color: #b45309;
      color: #fff8e1;
      border: none;
      border-radius: 4px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
  }

  .anecdote-button:hover {
      background-color: #d97706;
  }

  /* --- Détails d'achat --- */
  .buy-item-details {
      margin-top: 16px;
  }

  .buy-item-content {
      display: flex;
      align-items: flex-start;
      gap: 16px;
  }

  .buy-image {
      background-color: #3a3a20;
      border: 2px solid #92400e;
      border-radius: 6px;
      padding: 8px;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .buy-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
  }

  .buy-info {
      flex: 1;
  }

  .buy-info h3 {
      font-size: 20px;
      color: #fcd34d;
      margin-bottom: 8px;
  }

  .buy-info p {
      font-size: 14px;
      color: rgba(253, 230, 138, 0.8);
      margin-bottom: 12px;
  }

  .buy-price {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #fcd34d;
      font-size: 18px;
      margin-bottom: 16px;
  }

  .buy-actions {
      display: flex;
      gap: 8px;
  }


  .slotChest.selected {
      border-color: #ffd700 !important;
      background-color: rgba(255, 215, 0, 0.1);
  }

  .sell-item-img {
      max-width: 100px;
      max-height: 100px;
      object-fit: contain;
      margin: 10px 0;
  }

  .sell-item-stats {
      width:100%;
      background: #3a3a20;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #b45309;
  }

  .sell-price {
      color: #fcd34d;
      font-weight: bold;
      margin: 10px 0;
  }
/*!FIN Zone Marchand*/
/*Particularité dans le jeux*/
.boutonXp{
    background: #222;
    color: #FFD700;
    font-weight: bold;
    border: 2px solid #FFD700;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease-in-out;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 4px 10px rgba(255, 215, 0, 0.2);
    text-shadow: 2px 2px 4px rgba(255, 215, 0, 0.3);
    position: relative;
    overflow: hidden;
}
/*FIN Particularité dans le jeux*/

/*Crédit*/
  
    /* Conteneur pour le défilement */
    .credits-container {
      position: relative;
      height: 800px;
      overflow: hidden;
    }
    
    /* Le bloc des crédits qui va défiler */
    .credits {
      position: absolute;
      width: 100%;
      bottom: -100%;
      text-align: center;
      animation: scrollCredits 25s linear infinite;
    }
    
    /* Animation du défilement (ajuste la durée pour modifier la vitesse) */
    @keyframes scrollCredits {
      0% {
        bottom: -100%;
      }
      100% {
        bottom: 100%;
      }
    }

    /* Style des titres et paragraphes */
/* Style par défaut (desktop) */
.credits h1 {
  font-size: 2.5em;
  margin: 0.5em 0;
}

.credits h2 {
  font-size: 1.8em;
  margin: 0.3em 0;
}

.credits p {
  font-size: 1.2em;
  margin: 0.2em 0;
}


@media (max-width: 768px) {
  .credits h1 {
    font-size: 2em;
  }

  .credits h2 {
    font-size: 1.5em;
  }

  .credits p {
    font-size: 1em;
  }
}


@media (max-width: 480px) {
  .credits h1 {
    font-size: 1.6em;
  }

  .credits h2 {
    font-size: 1.3em;
  }

  .credits p {
    font-size: 0.95em;
  }
}

    
    /*Affichage bouton retour*/
          .back-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #444;
      color: #fff;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 5px;
      z-index: 1000;
      transition: background-color 0.3s;
    }

    .back-button:hover {
      background-color: #666;
    }
/*FIN Crédit*/

/*Page DON Pour passer*/

    .donation-box {
      border-radius: 20px;
      padding: 30px;
      margin: 30px auto;
      width: 300px;
      text-align: center;
      background: linear-gradient(to bottom right, #111, #333);
      color: #ffd700;
      font-family: 'Trebuchet MS', sans-serif;
      transition: all 0.3s ease;
      cursor: grab;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
    }

    .donation-box.hover {
      background: #222;
      transform: scale(1.03);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
    }

    .subtext {
      font-size: 0.9em;
      color: #ccc;
      margin-top: 5px;
      display: block;
    }

    .donation-message {
      text-align: center;
      font-weight: bold;
      margin-top: 15px;
    }

    #recompenseDonPassage {
      display: none;
      text-align: center;
      margin-top: 20px;
      padding: 20px;
      background: #262626;
      border: 2px solid #888;
      border-radius: 10px;
    }

    #recompenseDonPassage a {
      color: #00ffcc;
      font-size: 1.2em;
      text-decoration: none;
    }

    #recompenseDonPassage a:hover {
      text-decoration: underline;
    }
/*FIN PAGE DON Pour passer*/